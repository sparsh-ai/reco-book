
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Collaborative Filtering on ML-latest-small &#8212; Reco Book</title>
    
  <link href="../_static/css/theme.css" rel="stylesheet" />
  <link href="../_static/css/index.c5995385ac14fb8791e8eb36b4908be2.css" rel="stylesheet" />

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/sphinx-book-theme.css?digest=c3fdc42140077d1ad13ad2f1588a4309" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../_static/js/index.1c5a1a01449ed65a7b51.js">

    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/togglebutton.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/sphinx-book-theme.12a9622fbb08dcb3a2a40b2c02b83a57.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["\\(", "\\)"]], "displayMath": [["\\[", "\\]"]], "processRefs": false, "processEnvironments": false}})</script>
    <script async="async" src="https://unpkg.com/thebe@0.5.1/lib/index.js"></script>
    <script >
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Building and deploying ASOS fashion recommender" href="T539160_Building_and_Deploying_ASOS_Fashion_Recommender.html" />
    <link rel="prev" title="Amazon Personalize Workshop" href="T022961_Amazon_Personalize_Workshop.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
      
      
      <h1 class="site-logo" id="site-title">Reco Book</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../index.html">
   Tutorials in Jupyter notebook format
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  User Stories
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="US780867_Transformer_based_Recommenders.html">
   Transformer-based Recommenders
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="T034923_BERT4Rec_on_ML1M_in_PyTorch.html">
     BERT4Rec on ML-1M in PyTorch
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="T595874_BERT4Rec_on_ML25M_in_PyTorch_Lightning.html">
     BERT4Rec on ML-25M
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="T088416_BST_Implementation_in_MXNet.html">
     BST Implementation in MXNet
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="T602245_BST_implementation_in_PyTorch.html">
     BST implementation in PyTorch
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="T007665_BST_on_ML1M_in_Keras.html">
     A Transformer-based recommendation system
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="T881207_BST_PTLightning_ML1M.html">
     Rating prediction using the Behavior Sequence Transformer (BST) model on ML-1M dataset in PyTorch Lightning
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="T025247_BST_using_Deepctr_library.html">
     BST using Deepctr library
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="T757997_SASRec_PyTorch.html">
     SASRec implementation with PyTorch Library
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="T225287_SASRec_PaddlePaddle.html">
     SASRec implementation with Paddle Library
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="T701627_SR_SAN_Session_based_Model.html">
     SR-SAN Session-based Recommender
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="T975104_SSEPT_ML1M_Tensorflow1x.html">
     SSE-PT Personalized Transformer Recommender on ML-1M in Tensorflow 1.x
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="T472955_GCSAN_Session_based_Model.html">
     GCSAN Session-based Recommender
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="T970274_Transformers4Rec_Session_based_Recommender_on_Yoochoose.html">
     End-to-end session-based recommendation with Transformers4Rec
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="T382183_Transformers4Rec_XLNet_on_Synthetic_data.html">
     Transformers4Rec XLNet on Synthetic data
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="T793395_Session_based_recommendation_on_REES46_Dataset.html">
     End-to-end Session-based recommendation on REES46 Dataset
    </a>
   </li>
  </ul>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Prototypes
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="T382881_DeepWalk_Karateclub.html">
   DeepWalk from scratch referencing Karateclub library
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T384270_DeepWalk_pure_python.html">
   DeepWalk in pure python
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T677598_Jaccard_Cosine_SVD_DeepWalk_ML100K.html">
   Recommender System with DeepWalk Graph Embeddings
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T815556_Node2vec_Karateclub.html">
   Node2vec from scratch referencing Karateclub library
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T894941_Node2vec_MovieLens_Keras.html">
   Graph representation learning with node2vec
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T611050_Node2vec_PyG.html">
   Node2vec from scratch in PyTorch Geometric
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T186367_Node2vec_library.html">
   Node2vec from scratch referencing node2vec library
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T331379_bayesian_personalized_ranking.html">
   BPR from scratch
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T081831_Data_Poisoning_Attacks_on_Factorization_Based_Collaborative_Filtering.html">
   Data Poisoning Attacks on Factorization-Based Collaborative Filtering
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T102448_Adversarial_Learning_for_Recommendation.html">
   Adversarial Training (Regularization) on a Recommender System
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T865035_Simulating_Data_Poisoning_Attacks_against_Twitter_Recommender.html">
   Load and process dataset
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T711285_Data_Poisoning_Attack_using_LFM_and_ItemAE_on_Synthetic_Dataset.html">
   Injection attack using LFM and ItemAE model trained on Toy dataset
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T355514_Black_box_Attack_on_Sequential_Recs.html">
   Black-box Attack on Sequential Recs
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T873451_Statistics_fundamentals.html">
   Statictics Fundamentals
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T890478_Batch_Learning_from_Bandit_Feedback_%28BLBF%29.html">
   Imports
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T257798_Off_Policy_Learning_in_Two_stage_Recommender_Systems.html">
   Off-Policy Learning in Two-stage Recommender Systems
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T471827_Adaptive_Estimator_Selection_for_Off_Policy_Evaluation.html">
   Adaptive Estimator Selection for Off-Policy Evaluation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T902666_Evaluating_the_Robustness_of_Off_Policy_Evaluation.html">
   Evaluating the Robustness of Off-Policy Evaluation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T705904_Evaluation_of_Multiple_Off_Policy_Estimators_on_Synthetic_Dataset.html">
   Evaluation of Multiple Off-Policy Estimators on Synthetic Dataset
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T874693_Evaluating_Standard_Off_Policy_Estimators_with_Small_Sample_Open_Bandit_Dataset.html">
   Evaluating Standard Off-Policy Estimators with Small Sample Open-Bandit Dataset
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T792262_Optimal_Off_Policy_Evaluation_from_Multiple_Logging_Policies.html">
   Optimal Off-Policy Evaluation from Multiple Logging Policies
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T167249_Offline_Policy_Evaluation_with_VW_Command_Line.html">
   Offline Policy Evaluation with VW Command Line
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T966055_OBP_Library_Workshop_Tutorials.html">
   OBP Library Workshop Tutorials
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T632722_PyTorch_Fundamentals_Part_1.html">
   PyTorch Fundamentals Part 1
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T472467_PyTorch_Fundamentals_Part_2.html">
   PyTorch Fundamentals Part 2
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T206654_PyTorch_Fundamentals_Part_3.html">
   PyTorch Fundamentals Part 3
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T536348_Attention_Mechanisms.html">
   Imports
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T500796_Agricultural_Satellite_Image_Segmentation.html">
   Agricultural Satellite Image Segmentation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T611432_Image_Analysis_with_Tensorflow.html">
   Image Analysis with Tensorflow
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T925716_MongoDB_to_CSV_Conversion.html">
   MongoDB to CSV conversion
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T396469_PDF_to_Word_Cloud_via_Email.html">
   PDF to WordCloud via Email
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T030890_Job_Scraping_and_Clustering.html">
   Job scraping and clustering
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T897054_Scene_Text_Recognition.html">
   Scene Text Recognition
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T034809_Large_scale_Document_Retrieval_with_Elastic_Search.html">
   Large-scale Document Retrieval with ElasticSearch
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T467251_vowpal_wabbit_contextual_recommender.html">
   Simulating a news personalization scenario using Contextual Bandits
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T686684_similar_product_recommender.html">
   Similar Product Recommender system using Deep Learning for an online e-commerce store
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T132203_Retail_Product_Recommendations_using_Word2vec.html">
   Retail Product Recommendations using word2vec
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T501828_Recommender_Implicit_Negative_Feedback.html">
   Retail Product Recommendation with Negative Implicit Feedback
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T315965_Sequence_Aware_Recommenders_Music.html">
   Sequence Aware Recommender Systems
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T051777_image_similarity_recommendations.html">
   Similar Product Recommendations
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990172_recobook_diversity_aware_book_recommender.html">
   Diversity Aware Book Recommender
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T488549_Goodreads_Diversity_Aware_Book_Recommender.html">
   Diversity Aware Book Recommender
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T023535_Kafka_MongoDB_Real_time_Streaming.html">
   Kafka MongoDB Real-time Streaming
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T622304_Session_based_Recommender_Using_Word2vec.html">
   Session-based recommendation using word2vec
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T416854_bandit_based_recommender_using_thompson_sampling_app.html">
   Bandit-based Online Learning using Thompson Sampling
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T198578_Booking_dot_com_Trip_Recommendation.html">
   Booking.com Trip Recommendation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T519734_Vowpal_Wabbit_Contextual_Bandit.html">
   Vowpal Wabbit Contextual Bandit
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T871537_Recommendation_Systems_using_Olist_Dataset.html">
   Recommendation systems using Olist dataset
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T057885_Offline_Replayer_Evaluation.html">
   Offline Replayer Evaluation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T915054_method_for_effective_online_testing.html">
   Methods for effective online testing
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T513987_Recsys_2020_Feature_Engineering_Tutorial.html">
   Recsys’20 Feature Engineering Tutorial
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T227901_amazon_personalize_batch_job.html">
   Amazon Personalize Batch Job
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T022961_Amazon_Personalize_Workshop.html">
   Amazon Personalize Workshop
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Collaborative Filtering on ML-latest-small
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T539160_Building_and_Deploying_ASOS_Fashion_Recommender.html">
   Building and deploying ASOS fashion recommender
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T757697_Simple_Similarity_based_Recommender.html">
   Simple Similarity based Recommmendations
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T051594_Analytics_Zoo.html">
   Analytics Zoo
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T313645_A_B_Testing.html">
   A/B Testing
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T475711_PinSage_Graph_based_Recommender.html">
   PinSage Graph-based Recommender
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T516490_Graph_Embeddings.html">
   Learn Embeddings using Graph Networks
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T822164_movielens_milvus_redis_efficient_retrieval.html">
   Recommender with Redis and Milvus
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T845186_Anime_Recommender.html">
   RekoNet Anime Recommender
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T855843_kafka_spark_streaming_colab.html">
   Kafka and Spark Streaming in Colab
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T460437_Building_Models_From_Scratch.html">
   Building Models from scratch
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T855971_Conet_Model_for_Movie_Recommender.html">
   CoNet model
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T996996_content_based_and_collaborative_movielens.html">
   Movie Recommendation with Content-Based and Collaborative Filtering
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T239418_Simple_Movie_Recommenders.html">
   Simple Movie Recommenders
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T138337_Simple_Movie_Recommender.html">
   Simple movie recommender in implicit, explicit, and cold-start settings
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T935440_The_importance_of_Rating_Normalization.html">
   The importance of Rating Normalization
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T612622_cornac_examples.html">
   Cornac Examples
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T561435_Flower_Classification.html">
   Flower classification
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T680910_Trivago_Session_based_Recommender.html">
   Trivago Session-based Recommender
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990000_ads_selection_using_bandits.html">
   Best Ads detection using bandit methods
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990000_book_crossing_surprise_svd_nmf.html">
   Book-Crossing Recommendation System
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990000_book_recommender_kubeflow.html">
   Books recommendations with Kubeflow Pipelines on Scaleway Kapsule
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990000_build_a_kubeflow_pipeline.html">
   Build a Kubeflow Pipeline
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990000_causal_inference.html">
   Causal Inference
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990000_concept_embedding_nlp.html">
   Exploring Word Embeddings
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990000_concept_neural_net.html">
   Neural Network
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990000_concept_nlp_basics.html">
   Natural Language Processing 101
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990000_concept_transformer_lm.html">
   TransformerLM Quick Start and Guide
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990000_content_based_music_recommender_lyricsfreak.html">
   Content-based method for song recommendation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990000_evaluation_metrics_basics.html">
   Recommender System Evaluations
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990000_implicit_synthetic.html">
   Comparing Implicit Models on Synthetic Data
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990000_movie_recommender_tensorflow.html">
   Recommendation Systems with TensorFlow
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990000_movie_recommender_tensorflow_sagemaker.html">
   Movie recommender using Tensorflow in Sagemaker
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990000_movielens_eda_modeling.html">
   Movielens EDA and Modeling
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990000_read_data_from_cassandra_into_pandas.html">
   Read Cassandra Data Snapshot as DataFrame
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990000_rl_in_action.html">
   Reinforcement Learning fundamentals in action
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990000_rnn_cnn_basics.html">
   Processing sequences using RNNs and CNNs
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990000_tf_serving_in_action.html">
   TF Serving in action
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990000_training_indexing_movie_recommender.html">
   Training and indexing movie recommender
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T207114_EduRec_MOOCCube_Course_Recommender.html">
   EduRec MOOCCube Course Recommender
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T273184_Multi_Task_Learning.html">
   Multi-task Learning
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T661108_Book_Recommender_API.html">
   Book Recommender API
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T912764_Simple_Movie_Recommender_App.html">
   Simple Movie Recommender App
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T964554_Career_Village_Questions_Recommendation.html">
   CareerVillage Questions Recommendation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990001_amazon_women_apparel_tfidf_word2vec.html">
   Amazon Product Recommender
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990001_anime_recommender_graph_network.html">
   Anime Recommender with Bi-partite Graph Network
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990001_concept_self_attention.html">
   Self-Attention
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990001_course_recommender_svd_flask.html">
   Course Recommender with SVD based similarity
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990001_data_mining_similarity_measures.html">
   Concept - Data Mining Similarity Measures
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990001_jaccard_recommender.html">
   Jaccard Similarity based Recommender
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990001_live_streamer_recommender.html">
   Live Streamer Recommender with Implicit feedback
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990001_songs_embedding_skipgram_recommender.html">
   Song Embeddings - Skipgram Recommender
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990001_toy_example_car_recommender_knn.html">
   Toy example - Car Recommender using KNN method
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990001_wikirecs_recommender.html">
   WikiRecs
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../_sources/nbs/T424437_Collaborative_Filtering_on_ML_latest_small.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/sparsh-ai/reco-book/main?urlpath=tree/nbs/T424437_Collaborative_Filtering_on_ML_latest_small.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="../_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav" aria-label="Page">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#part-1-data-loading-and-eda">
   Part 1 - Data loading and EDA
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#part-2-user-based-method">
   Part 2 - User-based method
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#download-tools">
     Download tools
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#import-requirements">
     Import requirements
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#load-movielen-ratings">
     Load MovieLen ratings
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#userids-and-itemids-encoding">
     userids and itemids encoding
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#transform-rating-dataframe-to-matrix">
     Transform rating dataframe to matrix
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#idea">
     Idea
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#algorithm-user-to-user-collaborative-filtering">
     Algorithm : user-to-user collaborative filtering
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#step-1-identify-g-u-the-set-of-k-users-similar-to-an-active-user-u">
       Step 1. Identify
       <span class="math notranslate nohighlight">
        \(G_u\)
       </span>
       , the set of
       <span class="math notranslate nohighlight">
        \(k\)
       </span>
       users similar to an active user
       <span class="math notranslate nohighlight">
        \(u\)
       </span>
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#step-2-find-candidate-items">
       Step 2. Find candidate items
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#step-3-rating-prediction">
       Step 3. Rating prediction
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#step-4-top-n-recommendation">
       Step 4. Top-N recommendation
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#evaluation-with-mean-absolute-error-mae">
     Evaluation with Mean Absolute Error (MAE)
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#summary">
     Summary
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#evaluation-on-the-ml-1m-dataset-this-may-take-some-time">
     Evaluation on the ML-1M dataset (this may take some time)
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#limitations-of-user-based-cf">
     Limitations of user-based CF
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#part-3-item-based-method">
   Part 3 - Item-based method
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id1">
     Idea
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#advantages-over-user-based-cf">
     Advantages over user-based CF
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#algorithm-item-to-item-collaborative-filtering">
     Algorithm : item-to-item collaborative filtering
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#import-useful-requirements">
       Import useful requirements
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id2">
       Import requirements
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#load-ratings">
       Load ratings
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id3">
       userids and itemids encoding
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#step-1-find-similarities-for-each-of-the-items">
       Step 1. Find similarities for each of the items
      </a>
      <ul class="nav section-nav flex-column">
       <li class="toc-h5 nav-item toc-entry">
        <a class="reference internal nav-link" href="#similarities-computation">
         Similarities computation
        </a>
       </li>
       <li class="toc-h5 nav-item toc-entry">
        <a class="reference internal nav-link" href="#ajusted-cosine-similarity">
         Ajusted Cosine Similarity
        </a>
       </li>
      </ul>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#step-2-top-n-recommendation-for-a-given-user">
       Step 2. Top N recommendation for a given user
      </a>
      <ul class="nav section-nav flex-column">
       <li class="toc-h5 nav-item toc-entry">
        <a class="reference internal nav-link" href="#a-finding-candidate-items">
         2.a- Finding candidate items
        </a>
       </li>
       <li class="toc-h5 nav-item toc-entry">
        <a class="reference internal nav-link" href="#b-find-similarity-between-each-candidate-item-and-the-set-i-u">
         2.b- Find similarity between each candidate item and the set
         <span class="math notranslate nohighlight">
          \(I_u\)
         </span>
        </a>
       </li>
       <li class="toc-h5 nav-item toc-entry">
        <a class="reference internal nav-link" href="#c-rank-candidate-items-according-to-their-similarities-to-i-u">
         2.c- Rank candidate items according to their similarities to
         <span class="math notranslate nohighlight">
          \(I_u\)
         </span>
        </a>
       </li>
      </ul>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#putting-all-together">
     Putting all together
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#top-n-recommendation-with-predictions">
     Top N recommendation with predictions
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#rating-prediction">
       Rating prediction
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#evaluation-with-mean-absolute-error">
     Evaluation with Mean Absolute Error
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id4">
     Summary
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#itemtoitem-usage">
       ItemToItem : usage
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#instanciate-the-itemtoitem-cf">
       Instanciate the ItemToItem CF
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#evaluate-the-item-based-cf-on-the-ml-1m-dataset">
       Evaluate the Item-based CF on the ML-1M dataset
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#model-based-cf">
     Model based CF
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#part-4-svd-method">
   Part 4 - SVD method
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#how-do-svd-works">
     How do SVD works ?
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#svd-algorithm">
     SVD algorithm
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#implementation-details">
     Implementation details
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#download-useful-tools">
     Download useful tools
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id5">
     Import requirements
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#loading-movielen-ratings">
     Loading movielen ratings
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#ids-encoding">
     Ids encoding
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id6">
     SVD Algorithm
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id7">
     Rating prediction
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#make-recommendations">
     Make recommendations
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#improving-memory-based-collaborative-filtering">
     Improving memory based collaborative filtering
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#matrix-factorization">
     Matrix Factorization
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#part-5-matrix-factorization-method">
   Part 5 - Matrix factorization method
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#learning-algorithms">
     Learning Algorithms
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#how-to-compute-frac-partial-partial-q-i-j-u-i">
       How to compute
       <span class="math notranslate nohighlight">
        \(\frac{\partial}{\partial q_i}J_{u,i}\)
       </span>
       ?
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#matrix-factorization-algorithm">
     Matrix Factorization : algorithm
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#download-useful-files">
       Download useful files
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id8">
       Import requirements
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#model-definition">
     Model definition
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#movielens-100k">
     MovieLens 100k
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#evaluation-on-raw-ratings">
       Evaluation on raw ratings
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#evaluation-on-normalized-ratings">
       Evaluation on normalized ratings
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#movielens-1m">
     MovieLens 1M
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#evaluation-on-raw-data">
       Evaluation on raw data
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id9">
       Evaluation on normalized ratings
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#predictions">
     Predictions
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id10">
     Summary
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#non-negative-matrix-factorization">
     Non-negative Matrix Factorization
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#part-6-non-negative-matrix-factorization-method">
   Part 6 - Non-negative Matrix factorization method
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#one-limitation-of-matrix-factorization">
     One limitation of Matrix Factorization
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#particulariy-of-non-negative-matrix-factorization">
     Particulariy of Non-negative Matrix Factorization
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#objective-function">
     Objective function
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#multiplicative-update-rule">
     Multiplicative update rule
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#install-and-import-useful-packages">
     Install and import useful packages
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#requirements">
     requirements
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#load-and-preprocess-rating">
     Load and preprocess rating
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#non-negative-matrix-factorization-model">
     Non-negative Matrix Factorization Model
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#train-the-nmf-model-with-ml-100k-dataset">
     Train the NMF model with ML-100K dataset
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#evaluation-of-nmf-with-scikit-suprise">
     Evaluation of NMF with Scikit-suprise
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#explainable-matrix-factorization">
     Explainable Matrix Factorization
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#part-7-explainable-matrix-factorization-method">
   Part 7 - Explainable Matrix factorization method
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#how-to-quantify-explainability">
     How to quantify explainability ?
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id11">
     requirements
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#compute-explainable-scores">
     Compute Explainable Scores
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#explainable-matrix-factorization-model">
     Explainable Matrix Factorization Model
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#model-evaluation">
     Model Evaluation
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id12">
       MovieLens 100K
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id13">
       MovieLens 1M
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#ratings-prediction">
     Ratings prediction
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id14">
     Putting all together
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#part-8-evaluation">
   Part 8 - Evaluation
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id15">
     requirements
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#results-on-movielens-100k">
     Results on MovieLens 100k
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#user-based-cf">
       User-based CF
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#item-based-cf">
       Item-based CF
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id16">
       Matrix Factorization
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id17">
       Non-negative Matrix Factorization
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id18">
       Explainable Matrix Factorization
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#results-on-movielens-1m-ml-1m">
     Results on MovieLens 1M (ML-1M)
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id19">
       User-based CF
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id20">
       Item-based CF
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id21">
       Matrix Factorization
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id22">
       Non-negative Matrix Factorization
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id23">
       Explainable Matrix Factorization
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id24">
     Summary
    </a>
   </li>
  </ul>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="section" id="collaborative-filtering-on-ml-latest-small">
<h1>Collaborative Filtering on ML-latest-small<a class="headerlink" href="#collaborative-filtering-on-ml-latest-small" title="Permalink to this headline">¶</a></h1>
<div class="section" id="part-1-data-loading-and-eda">
<h2>Part 1 - Data loading and EDA<a class="headerlink" href="#part-1-data-loading-and-eda" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><p>Collaborative Filtering on MovieLens Latest-small Part 1 - Downloading movielens latest small dataset and exploratory data analysis</p>
</div></blockquote>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="kn">from</span> <span class="nn">scipy.sparse</span> <span class="kn">import</span> <span class="n">csr_matrix</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">LabelEncoder</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>!wget http://files.grouplens.org/datasets/movielens/ml-latest-small.zip
!unzip ml-latest-small.zip
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">DOWNLOAD_DESTINATION_DIR</span> <span class="o">=</span> <span class="s2">&quot;/content/ml-latest-small&quot;</span>

<span class="n">ratings_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DOWNLOAD_DESTINATION_DIR</span><span class="p">,</span> <span class="s1">&#39;ratings.csv&#39;</span><span class="p">)</span>
<span class="n">ratings</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
    <span class="n">ratings_path</span><span class="p">,</span>
    <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">,</span>
    <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;userid&quot;</span><span class="p">,</span> <span class="s2">&quot;itemid&quot;</span><span class="p">,</span> <span class="s2">&quot;rating&quot;</span><span class="p">,</span> <span class="s2">&quot;timestamp&quot;</span><span class="p">],</span>
    <span class="n">skiprows</span><span class="o">=</span><span class="mi">1</span>
<span class="p">)</span>

<span class="n">movies_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DOWNLOAD_DESTINATION_DIR</span><span class="p">,</span> <span class="s1">&#39;movies.csv&#39;</span><span class="p">)</span>
<span class="n">movies</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
    <span class="n">movies_path</span><span class="p">,</span>
    <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">,</span>
    <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;itemid&quot;</span><span class="p">,</span> <span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="s2">&quot;genres&quot;</span><span class="p">],</span>
    <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;latin-1&#39;</span><span class="p">,</span>
    <span class="n">skiprows</span><span class="o">=</span><span class="mi">1</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ratings</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>userid</th>
      <th>itemid</th>
      <th>rating</th>
      <th>timestamp</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>1</td>
      <td>4.0</td>
      <td>964982703</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>3</td>
      <td>4.0</td>
      <td>964981247</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1</td>
      <td>6</td>
      <td>4.0</td>
      <td>964982224</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1</td>
      <td>47</td>
      <td>5.0</td>
      <td>964983815</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1</td>
      <td>50</td>
      <td>5.0</td>
      <td>964982931</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">movies</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>itemid</th>
      <th>title</th>
      <th>genres</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>Toy Story (1995)</td>
      <td>Adventure|Animation|Children|Comedy|Fantasy</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2</td>
      <td>Jumanji (1995)</td>
      <td>Adventure|Children|Fantasy</td>
    </tr>
    <tr>
      <th>2</th>
      <td>3</td>
      <td>Grumpier Old Men (1995)</td>
      <td>Comedy|Romance</td>
    </tr>
    <tr>
      <th>3</th>
      <td>4</td>
      <td>Waiting to Exhale (1995)</td>
      <td>Comedy|Drama|Romance</td>
    </tr>
    <tr>
      <th>4</th>
      <td>5</td>
      <td>Father of the Bride Part II (1995)</td>
      <td>Comedy</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;There are </span><span class="si">{}</span><span class="s2"> users and </span><span class="si">{}</span><span class="s2"> movies in this dataset.&quot;</span>\
      <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ratings</span><span class="o">.</span><span class="n">userid</span><span class="o">.</span><span class="n">nunique</span><span class="p">(),</span>
              <span class="n">ratings</span><span class="o">.</span><span class="n">itemid</span><span class="o">.</span><span class="n">nunique</span><span class="p">()))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>There are 610 users and 9724 movies in this dataset.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># histogram of ratings</span>
<span class="n">ratings</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;rating&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">size</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/T424437_Collaborative_Filtering_on_ML_latest_small_8_0.png" src="../_images/T424437_Collaborative_Filtering_on_ML_latest_small_8_0.png" />
</div>
</div>
<p>Ratings range from <span class="math notranslate nohighlight">\(0.5\)</span> to <span class="math notranslate nohighlight">\(5.0\)</span>, with a step of <span class="math notranslate nohighlight">\(0.5\)</span>. The above histogram presents the repartition of ratings in the dataset. the two most commun ratings are <span class="math notranslate nohighlight">\(4.0\)</span> and <span class="math notranslate nohighlight">\(3.0\)</span> and the less common ratings are <span class="math notranslate nohighlight">\(0.5\)</span> and <span class="math notranslate nohighlight">\(1.5\)</span></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># average rating of movies</span>
<span class="n">movie_means</span> <span class="o">=</span> <span class="n">ratings</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">movies</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">],</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;itemid&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">rating</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">movie_means</span><span class="p">[:</span><span class="mi">50</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span><span class="mi">6</span><span class="p">),</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;mean ratings of 50 movies&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/T424437_Collaborative_Filtering_on_ML_latest_small_10_0.png" src="../_images/T424437_Collaborative_Filtering_on_ML_latest_small_10_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># 30 most rated movies vs. 30 less rated movies</span>
<span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">movie_means</span><span class="o">.</span><span class="n">nlargest</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax1</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Top 30 movies in data set&quot;</span><span class="p">);</span>
<span class="n">movie_means</span><span class="o">.</span><span class="n">nsmallest</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax2</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Bottom 30 movies in data set&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/T424437_Collaborative_Filtering_on_ML_latest_small_11_0.png" src="../_images/T424437_Collaborative_Filtering_on_ML_latest_small_11_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">ids_encoder</span><span class="p">(</span><span class="n">ratings</span><span class="p">):</span>
    <span class="n">users</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">ratings</span><span class="p">[</span><span class="s1">&#39;userid&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
    <span class="n">items</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">ratings</span><span class="p">[</span><span class="s1">&#39;itemid&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>

    <span class="c1"># create users and items encoders</span>
    <span class="n">uencoder</span> <span class="o">=</span> <span class="n">LabelEncoder</span><span class="p">()</span>
    <span class="n">iencoder</span> <span class="o">=</span> <span class="n">LabelEncoder</span><span class="p">()</span>

    <span class="c1"># fit users and items ids to the corresponding encoder</span>
    <span class="n">uencoder</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">users</span><span class="p">)</span>
    <span class="n">iencoder</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">items</span><span class="p">)</span>

    <span class="c1"># encode userids and itemids</span>
    <span class="n">ratings</span><span class="o">.</span><span class="n">userid</span> <span class="o">=</span> <span class="n">uencoder</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">ratings</span><span class="o">.</span><span class="n">userid</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
    <span class="n">ratings</span><span class="o">.</span><span class="n">itemid</span> <span class="o">=</span> <span class="n">iencoder</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">ratings</span><span class="o">.</span><span class="n">itemid</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>

    <span class="k">return</span> <span class="n">ratings</span><span class="p">,</span> <span class="n">uencoder</span><span class="p">,</span> <span class="n">iencoder</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># userids and itemids encoding</span>
<span class="n">ratings</span><span class="p">,</span> <span class="n">uencoder</span><span class="p">,</span> <span class="n">iencoder</span> <span class="o">=</span> <span class="n">ids_encoder</span><span class="p">(</span><span class="n">ratings</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># transform rating dataframe to matrix</span>
<span class="k">def</span> <span class="nf">ratings_matrix</span><span class="p">(</span><span class="n">ratings</span><span class="p">):</span>    
    <span class="k">return</span> <span class="n">csr_matrix</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">crosstab</span><span class="p">(</span><span class="n">ratings</span><span class="o">.</span><span class="n">userid</span><span class="p">,</span> <span class="n">ratings</span><span class="o">.</span><span class="n">itemid</span><span class="p">,</span> <span class="n">ratings</span><span class="o">.</span><span class="n">rating</span><span class="p">,</span> <span class="n">aggfunc</span><span class="o">=</span><span class="nb">sum</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>    

<span class="n">R</span> <span class="o">=</span> <span class="n">ratings_matrix</span><span class="p">(</span><span class="n">ratings</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">R</span><span class="p">[:</span><span class="mi">10</span><span class="p">,:</span><span class="mi">10</span><span class="p">]</span><span class="o">.</span><span class="n">todense</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>matrix([[4. , 0. , 4. , 0. , 0. , 4. , 0. , 0. , 0. , 0. ],
        [0. , 0. , 0. , 0. , 0. , 0. , 0. , 0. , 0. , 0. ],
        [0. , 0. , 0. , 0. , 0. , 0. , 0. , 0. , 0. , 0. ],
        [0. , 0. , 0. , 0. , 0. , 0. , 0. , 0. , 0. , 0. ],
        [4. , 0. , 0. , 0. , 0. , 0. , 0. , 0. , 0. , 0. ],
        [0. , 4. , 5. , 3. , 5. , 4. , 4. , 3. , 0. , 3. ],
        [4.5, 0. , 0. , 0. , 0. , 0. , 0. , 0. , 0. , 0. ],
        [0. , 4. , 0. , 0. , 0. , 0. , 0. , 0. , 0. , 2. ],
        [0. , 0. , 0. , 0. , 0. , 0. , 0. , 0. , 0. , 0. ],
        [0. , 0. , 0. , 0. , 0. , 0. , 0. , 0. , 0. , 0. ]])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">csr_matrix</span><span class="p">(</span><span class="n">R</span><span class="p">)</span><span class="o">.</span><span class="n">todense</span><span class="p">(),</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;hot&#39;</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/T424437_Collaborative_Filtering_on_ML_latest_small_16_0.png" src="../_images/T424437_Collaborative_Filtering_on_ML_latest_small_16_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">csr_matrix</span><span class="p">(</span><span class="n">R</span><span class="p">[:</span><span class="mi">100</span><span class="p">,:</span><span class="mi">100</span><span class="p">])</span><span class="o">.</span><span class="n">todense</span><span class="p">(),</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;hot&#39;</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/T424437_Collaborative_Filtering_on_ML_latest_small_17_0.png" src="../_images/T424437_Collaborative_Filtering_on_ML_latest_small_17_0.png" />
</div>
</div>
</div>
<div class="section" id="part-2-user-based-method">
<h2>Part 2 - User-based method<a class="headerlink" href="#part-2-user-based-method" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><p>Collaborative Filtering on MovieLens Latest-small Part 2 - Finding recommendations using memory based user-user similarity method</p>
</div></blockquote>
<div class="section" id="download-tools">
<h3>Download tools<a class="headerlink" href="#download-tools" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>import os

if not (os.path.exists(&quot;recsys.zip&quot;) or os.path.exists(&quot;recsys&quot;)):
    !wget https://github.com/nzhinusoftcm/review-on-collaborative-filtering/raw/master/recsys.zip    
    !unzip recsys.zip
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="import-requirements">
<h3>Import requirements<a class="headerlink" href="#import-requirements" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">matplotlib</span><span class="o">==</span><span class="mf">3.2</span><span class="o">.</span><span class="mi">2</span>
<span class="n">numpy</span><span class="o">==</span><span class="mf">1.19</span><span class="o">.</span><span class="mi">2</span>
<span class="n">pandas</span><span class="o">==</span><span class="mf">1.0</span><span class="o">.</span><span class="mi">5</span>
<span class="n">python</span><span class="o">==</span><span class="mf">3.7</span>
<span class="n">scikit</span><span class="o">-</span><span class="n">learn</span><span class="o">==</span><span class="mf">0.24</span><span class="o">.</span><span class="mi">1</span>
<span class="n">scikit</span><span class="o">-</span><span class="n">surprise</span><span class="o">==</span><span class="mf">1.1</span><span class="o">.</span><span class="mi">1</span>
<span class="n">scipy</span><span class="o">==</span><span class="mf">1.6</span><span class="o">.</span><span class="mi">2</span>
</pre></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.neighbors</span> <span class="kn">import</span> <span class="n">NearestNeighbors</span>
<span class="kn">from</span> <span class="nn">scipy.sparse</span> <span class="kn">import</span> <span class="n">csr_matrix</span>

<span class="kn">from</span> <span class="nn">recsys.datasets</span> <span class="kn">import</span> <span class="n">ml100k</span>
<span class="kn">from</span> <span class="nn">recsys.preprocessing</span> <span class="kn">import</span> <span class="n">ids_encoder</span>

<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">zipfile</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="load-movielen-ratings">
<h3>Load MovieLen ratings<a class="headerlink" href="#load-movielen-ratings" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ratings</span><span class="p">,</span> <span class="n">movies</span> <span class="o">=</span> <span class="n">ml100k</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="userids-and-itemids-encoding">
<h3>userids and itemids encoding<a class="headerlink" href="#userids-and-itemids-encoding" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># create the encoder</span>
<span class="n">ratings</span><span class="p">,</span> <span class="n">uencoder</span><span class="p">,</span> <span class="n">iencoder</span> <span class="o">=</span> <span class="n">ids_encoder</span><span class="p">(</span><span class="n">ratings</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="transform-rating-dataframe-to-matrix">
<h3>Transform rating dataframe to matrix<a class="headerlink" href="#transform-rating-dataframe-to-matrix" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">ratings_matrix</span><span class="p">(</span><span class="n">ratings</span><span class="p">):</span>    
    <span class="k">return</span> <span class="n">csr_matrix</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">crosstab</span><span class="p">(</span><span class="n">ratings</span><span class="o">.</span><span class="n">userid</span><span class="p">,</span> <span class="n">ratings</span><span class="o">.</span><span class="n">itemid</span><span class="p">,</span> <span class="n">ratings</span><span class="o">.</span><span class="n">rating</span><span class="p">,</span> <span class="n">aggfunc</span><span class="o">=</span><span class="nb">sum</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>    

<span class="n">R</span> <span class="o">=</span> <span class="n">ratings_matrix</span><span class="p">(</span><span class="n">ratings</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Memory based collaborative filtering (CF) also known as nearest neighbors based CF makes recommendation based on similar behavious of users and items. There are two types of memory based CF : <b>user-based</b> and <b>item-based</b> CF. Both of these algorithm usually proceed in three stages :</p>
<ol class="simple">
<li><p>Similarity computation (between users or items)</p></li>
<li><p>Rating prediction (using ratings of similar users or items)</p></li>
<li><p>Top-N recommendation</p></li>
</ol>
</div>
<div class="section" id="idea">
<h3>Idea<a class="headerlink" href="#idea" title="Permalink to this headline">¶</a></h3>
<p>Let <span class="math notranslate nohighlight">\(u\)</span> be the user for which we plan to make recommendations.</p>
<ol class="simple">
<li><p>Find other users whose past rating behavior is similar to that of <span class="math notranslate nohighlight">\(u\)</span></p></li>
<li><p>Use their ratings on other items to predict what the current user will like</p></li>
</ol>
</div>
<div class="section" id="algorithm-user-to-user-collaborative-filtering">
<h3>Algorithm : user-to-user collaborative filtering<a class="headerlink" href="#algorithm-user-to-user-collaborative-filtering" title="Permalink to this headline">¶</a></h3>
<p>The entire process of user-to-user CF algorithm is described as follow <a href="https://romisatriawahono.net/lecture/rm/survey/information%20retrieval/Bobadilla%20-%20Recommender%20Systems%20-%202013.pdf">(J. Bobadilla et al. 2013)</a>: For an active user <span class="math notranslate nohighlight">\(u\)</span>,</p>
<ol>
    <li> First identify the set $G_u$ of $k$ most similar users. $G_u$ is the group users similar to the active user $u$. The similarity between two users $u$ and $v$ can be measured by the cosine similarity measure as follows :
<p>\begin{equation}
w_{u,v}=\frac{\vec{r}<em>u \cdot \vec{r}<em>v}{|\vec{r}<em>u|<em>2 \ast |\vec{r}<em>v|<em>2} = \frac{\sum</em>{i\in I}r</em>{u,i}r</em>{v,i}}{\sqrt{\sum</em>{i\in I} (r</em>{u,i})^2}\sqrt{\sum</em>{i\in I} (r_{v,i})^2}}
\end{equation}</p>
<p><span class="math notranslate nohighlight">\(w_{u,v}\)</span> is the degree of similarity between users <span class="math notranslate nohighlight">\(u\)</span> and <span class="math notranslate nohighlight">\(v\)</span>. This term is computed for all <span class="math notranslate nohighlight">\(v\in U\)</span>, where <span class="math notranslate nohighlight">\(U\)</span> is the set of all users. There remains the question of how many neighbors to select. As experimented by <a href="https://dl.acm.org/doi/10.1145/3130348.3130372">(Herlocker et al. 1999)</a>, <span class="math notranslate nohighlight">\(k\in [20,50]\)</span> is a reasonable starting point in many domains.
</li>
<li> Find the set <span class="math notranslate nohighlight">\(C\)</span> of candidate items, purchased by the group and not purchased by the active user <span class="math notranslate nohighlight">\(u\)</span>. Candidate items have to be the most frequent items purchased by the group.
</li>
<li>Aggregate ratings of users in <span class="math notranslate nohighlight">\(G_u\)</span> to make predictions for user <span class="math notranslate nohighlight">\(u\)</span> on items he has not already purchased. Several aggregation approaches are often used such as <b>average, weighted sum, ajusted weighted sum</b>. By using weighted sum, the predicted rating of user <span class="math notranslate nohighlight">\(u\)</span> on item <span class="math notranslate nohighlight">\(i\)</span> denoted by <span class="math notranslate nohighlight">\(\hat{r}_{u,i}\)</span> is computed as follow :</p>
<p>\begin{equation}
\hat{r}<em>{u,i}=\bar{r}<em>u + \frac{\sum</em>{v\in G_u}(r</em>{v,i}-\bar{r}<em>v)\cdot w</em>{u,v}}{\sum_{v\in G_u}|w_{u,v}|}.
\end{equation}</p>
<p>Ratings of similar users are weighted by the corresponding similarity with the active user. Summation are made over all the users who have rated item <span class="math notranslate nohighlight">\(i\)</span>. Subtracting the user’s mean rating <span class="math notranslate nohighlight">\(\bar{r}_v\)</span> compensates for differences in users’ use of the rating scale as some users will tend to give higher ratings than others <a href="https://dl.acm.org/doi/10.1561/1100000009">(Michael D. Ekstrand, <i>et al.</i> 2011)</a>. This prediction is made for all items <span class="math notranslate nohighlight">\(i \in C\)</span> not purchased by user <span class="math notranslate nohighlight">\(u\)</span>.
</li>
<li>The Top-<span class="math notranslate nohighlight">\(N\)</span> recommendations are obtained by choosing the <span class="math notranslate nohighlight">\(N\)</span> items which provide most satisfaction to the user according to prediction.
</li></p>
</ol><div class="section" id="step-1-identify-g-u-the-set-of-k-users-similar-to-an-active-user-u">
<h4>Step 1. Identify <span class="math notranslate nohighlight">\(G_u\)</span>, the set of <span class="math notranslate nohighlight">\(k\)</span> users similar to an active user <span class="math notranslate nohighlight">\(u\)</span><a class="headerlink" href="#step-1-identify-g-u-the-set-of-k-users-similar-to-an-active-user-u" title="Permalink to this headline">¶</a></h4>
<p>To find the <span class="math notranslate nohighlight">\(k\)</span> most similar users to <span class="math notranslate nohighlight">\(u\)</span>, we use the cosine similarity and compute <span class="math notranslate nohighlight">\(w_{u,v}\)</span> for all <span class="math notranslate nohighlight">\(v\in U\)</span>. Fortunately, libraries such as <i>scikit-learn (sklearn)</i> are very useful for such tasks :</p>
<ol class="simple">
<li><p>First of all, we create a nearest neighbors model with sklearn through the function <code class="docutils literal notranslate"><span class="pre">create_model()</span></code>. This function creates and fit a nearest neighbors model with user’s ratings. We can choose <code class="docutils literal notranslate"><span class="pre">cosine</span></code> or <code class="docutils literal notranslate"><span class="pre">euclidian</span></code> based similarity metric. <code class="docutils literal notranslate"><span class="pre">n_neighbors=21</span></code> define the number of neighbors to return. With <span class="math notranslate nohighlight">\(k=20\)</span> neighbors, <span class="math notranslate nohighlight">\(|G_u|=21\)</span> as <span class="math notranslate nohighlight">\(G_u\)</span> contains <span class="math notranslate nohighlight">\(20\)</span> similar users added to the active user <span class="math notranslate nohighlight">\(u\)</span>. That is why <code class="docutils literal notranslate"><span class="pre">n_neighbors=21</span></code>. Each row <span class="math notranslate nohighlight">\(r_u\)</span> of the rating matrix <span class="math notranslate nohighlight">\(R\)</span> represents ratings of user <span class="math notranslate nohighlight">\(u\)</span> on all items of the database. Missing ratings are replaced with <span class="math notranslate nohighlight">\(0.0\)</span>.</p></li>
</ol>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">R</span><span class="p">[</span><span class="n">u</span><span class="p">,:]</span> <span class="c1"># uth row of the rating matrix R. Ratings of user u on all items in the database</span>
</pre></div>
</div>
<ol class="simple">
<li><p>Function <code class="docutils literal notranslate"><span class="pre">nearest_neighbors()</span></code> returns the knn users for each user.</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">create_model</span><span class="p">(</span><span class="n">rating_matrix</span><span class="p">,</span> <span class="n">metric</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    - create the nearest neighbors model with the corresponding similarity metric</span>
<span class="sd">    - fit the model</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">NearestNeighbors</span><span class="p">(</span><span class="n">metric</span><span class="o">=</span><span class="n">metric</span><span class="p">,</span> <span class="n">n_neighbors</span><span class="o">=</span><span class="mi">21</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="s1">&#39;brute&#39;</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">rating_matrix</span><span class="p">)</span>    
    <span class="k">return</span> <span class="n">model</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">nearest_neighbors</span><span class="p">(</span><span class="n">rating_matrix</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;    </span>
<span class="sd">    :param rating_matrix : rating matrix of shape (nb_users, nb_items)</span>
<span class="sd">    :param model : nearest neighbors model    </span>
<span class="sd">    :return</span>
<span class="sd">        - similarities : distances of the neighbors from the referenced user</span>
<span class="sd">        - neighbors : neighbors of the referenced user in decreasing order of similarities</span>
<span class="sd">    &quot;&quot;&quot;</span>    
    <span class="n">similarities</span><span class="p">,</span> <span class="n">neighbors</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">kneighbors</span><span class="p">(</span><span class="n">rating_matrix</span><span class="p">)</span>        
    <span class="k">return</span> <span class="n">similarities</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:],</span> <span class="n">neighbors</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s call functions <code class="docutils literal notranslate"><span class="pre">create_model()</span></code> and <code class="docutils literal notranslate"><span class="pre">nearest_neighbors()</span></code> to respectively create the <span class="math notranslate nohighlight">\(k\)</span>-NN model and compute the nearest neighbors for a given user</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">create_model</span><span class="p">(</span><span class="n">rating_matrix</span><span class="o">=</span><span class="n">R</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="s1">&#39;cosine&#39;</span><span class="p">)</span> <span class="c1"># we can also use the &#39;euclidian&#39; distance</span>
<span class="n">similarities</span><span class="p">,</span> <span class="n">neighbors</span> <span class="o">=</span> <span class="n">nearest_neighbors</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="step-2-find-candidate-items">
<h4>Step 2. Find candidate items<a class="headerlink" href="#step-2-find-candidate-items" title="Permalink to this headline">¶</a></h4>
<p>The set <span class="math notranslate nohighlight">\(C\)</span> of candidate items are the most frequent ones purchased by users in <span class="math notranslate nohighlight">\(G_u\)</span> for an active user <span class="math notranslate nohighlight">\(u\)</span> and not purchased by <span class="math notranslate nohighlight">\(u\)</span>.</p>
<p>Function <code class="docutils literal notranslate"><span class="pre">find_candidate_items()</span></code> : find items purchased by these similar users as well as their frequency. Note that the frequency of the items in the set <span class="math notranslate nohighlight">\(C\)</span> can be computed by just counting the actual occurrence frequency of that items.</p>
<ol class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">Gu_items</span></code> : frequent items of <span class="math notranslate nohighlight">\(G_u\)</span> in decreasing order of frequency.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">active_items</span></code> : items already purchased by the active user</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">candidates</span></code> : frequent items of <span class="math notranslate nohighlight">\(G_u\)</span> not purchased by the active user <span class="math notranslate nohighlight">\(u\)</span></p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">find_candidate_items</span><span class="p">(</span><span class="n">userid</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Find candidate items for an active user</span>
<span class="sd">    </span>
<span class="sd">    :param userid : active user</span>
<span class="sd">    :param neighbors : users similar to the active user        </span>
<span class="sd">    :return candidates : top 30 of candidate items</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">user_neighbors</span> <span class="o">=</span> <span class="n">neighbors</span><span class="p">[</span><span class="n">userid</span><span class="p">]</span>
    <span class="n">activities</span> <span class="o">=</span> <span class="n">ratings</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ratings</span><span class="o">.</span><span class="n">userid</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">user_neighbors</span><span class="p">)]</span>
    
    <span class="c1"># sort items in decreasing order of frequency</span>
    <span class="n">frequency</span> <span class="o">=</span> <span class="n">activities</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;itemid&#39;</span><span class="p">)[</span><span class="s1">&#39;rating&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;count&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s1">&#39;count&#39;</span><span class="p">],</span><span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">Gu_items</span> <span class="o">=</span> <span class="n">frequency</span><span class="o">.</span><span class="n">itemid</span>
    <span class="n">active_items</span> <span class="o">=</span> <span class="n">ratings</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ratings</span><span class="o">.</span><span class="n">userid</span> <span class="o">==</span> <span class="n">userid</span><span class="p">]</span><span class="o">.</span><span class="n">itemid</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
    <span class="n">candidates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">setdiff1d</span><span class="p">(</span><span class="n">Gu_items</span><span class="p">,</span> <span class="n">active_items</span><span class="p">,</span> <span class="n">assume_unique</span><span class="o">=</span><span class="kc">True</span><span class="p">)[:</span><span class="mi">30</span><span class="p">]</span>
        
    <span class="k">return</span> <span class="n">candidates</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="step-3-rating-prediction">
<h4>Step 3. Rating prediction<a class="headerlink" href="#step-3-rating-prediction" title="Permalink to this headline">¶</a></h4>
<p>Now it’s time to predict what score the active user <span class="math notranslate nohighlight">\(u\)</span> would have given to each of the top-30 candidate items.</p>
<p>To predict the score of <span class="math notranslate nohighlight">\(u\)</span> on a candidate item <span class="math notranslate nohighlight">\(i\)</span> ,we need :</p>
<ol class="simple">
<li><p>Similarities between <span class="math notranslate nohighlight">\(u\)</span> and all his neighbors <span class="math notranslate nohighlight">\(v \in G_u\)</span> who rated item <span class="math notranslate nohighlight">\(i\)</span> : function <code class="docutils literal notranslate"><span class="pre">nearest_neighbors()</span></code> returns similar users of a user as well as their corresponding similarities.</p></li>
<li><p>Normalized ratings of all <span class="math notranslate nohighlight">\(v \in G_u\)</span> on item <span class="math notranslate nohighlight">\(i\)</span>. The normalized rating of user <span class="math notranslate nohighlight">\(v\)</span> on item <span class="math notranslate nohighlight">\(i\)</span> is defined by <span class="math notranslate nohighlight">\(r_{v,i}-\bar{r}_v\)</span>.</p></li>
</ol>
<p>Next, let’s compute the mean rating of each user and the normalized ratings for each item. The DataFrame <code class="docutils literal notranslate"><span class="pre">mean</span></code> contains mean rating for each user. With the mean rating of each user, we can add an extra column <code class="docutils literal notranslate"><span class="pre">norm_rating</span></code> to the <code class="docutils literal notranslate"><span class="pre">ratings</span></code>’s DataFrame which can be accessed to make predictions.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># mean ratings for each user</span>
<span class="n">mean</span> <span class="o">=</span> <span class="n">ratings</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;userid&#39;</span><span class="p">,</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="s1">&#39;rating&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">mean_ratings</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">ratings</span><span class="p">,</span> <span class="n">mean</span><span class="p">,</span> <span class="n">suffixes</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;_mean&#39;</span><span class="p">),</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;userid&#39;</span><span class="p">)</span>

<span class="c1"># normalized ratings for each items</span>
<span class="n">mean_ratings</span><span class="p">[</span><span class="s1">&#39;norm_rating&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mean_ratings</span><span class="p">[</span><span class="s1">&#39;rating&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">mean_ratings</span><span class="p">[</span><span class="s1">&#39;rating_mean&#39;</span><span class="p">]</span>

<span class="n">mean</span> <span class="o">=</span> <span class="n">mean</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()[:,</span> <span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">np_ratings</span> <span class="o">=</span> <span class="n">mean_ratings</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>Let us define function <code class="docutils literal notranslate"><span class="pre">predict</span></code> that predict rating between user <span class="math notranslate nohighlight">\(u\)</span> and item <span class="math notranslate nohighlight">\(i\)</span>. Recall that the prediction formula is defined as follow :</p>
<p>\begin{equation}
\hat{r}<em>{u,i}=\bar{r}<em>u + \frac{\sum</em>{v\in G_u}(r</em>{v,i}-\bar{r}<em>v)\cdot w</em>{u,v}}{\sum_{v\in G_u}|w_{u,v}|}.
\end{equation}</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="n">userid</span><span class="p">,</span> <span class="n">itemid</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    predict what score userid would have given to itemid.</span>
<span class="sd">    </span>
<span class="sd">    :param</span>
<span class="sd">        - userid : user id for which we want to make prediction</span>
<span class="sd">        - itemid : item id on which we want to make prediction</span>
<span class="sd">        </span>
<span class="sd">    :return</span>
<span class="sd">        - r_hat : predicted rating of user userid on item itemid</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">user_similarities</span> <span class="o">=</span> <span class="n">similarities</span><span class="p">[</span><span class="n">userid</span><span class="p">]</span>
    <span class="n">user_neighbors</span> <span class="o">=</span> <span class="n">neighbors</span><span class="p">[</span><span class="n">userid</span><span class="p">]</span>
    <span class="c1"># get mean rating of user userid</span>
    <span class="n">user_mean</span> <span class="o">=</span> <span class="n">mean</span><span class="p">[</span><span class="n">userid</span><span class="p">]</span>
    
    <span class="c1"># find users who rated item &#39;itemid&#39;</span>
    <span class="n">iratings</span> <span class="o">=</span> <span class="n">np_ratings</span><span class="p">[</span><span class="n">np_ratings</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="n">itemid</span><span class="p">]</span>
    
    <span class="c1"># find similar users to &#39;userid&#39; who rated item &#39;itemid&#39;</span>
    <span class="n">suri</span> <span class="o">=</span> <span class="n">iratings</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">iratings</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">user_neighbors</span><span class="p">)]</span>
    
    <span class="c1"># similar users who rated current item (surci)</span>
    <span class="n">normalized_ratings</span> <span class="o">=</span> <span class="n">suri</span><span class="p">[:,</span><span class="mi">4</span><span class="p">]</span>
    <span class="n">indexes</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">user_neighbors</span> <span class="o">==</span> <span class="n">uid</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">uid</span> <span class="ow">in</span> <span class="n">suri</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int&#39;</span><span class="p">)]</span>
    <span class="n">sims</span> <span class="o">=</span> <span class="n">user_similarities</span><span class="p">[</span><span class="n">indexes</span><span class="p">]</span>
    
    <span class="n">num</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">normalized_ratings</span><span class="p">,</span> <span class="n">sims</span><span class="p">)</span>
    <span class="n">den</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">sims</span><span class="p">))</span>
    
    <span class="k">if</span> <span class="n">num</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">den</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">user_mean</span>
    
    <span class="n">r_hat</span> <span class="o">=</span> <span class="n">user_mean</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">normalized_ratings</span><span class="p">,</span> <span class="n">sims</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">sims</span><span class="p">))</span>
    
    <span class="k">return</span> <span class="n">r_hat</span>
</pre></div>
</div>
</div>
</div>
<p>Now, we can make rating prediction for a given user on each item in his set of candidate items.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">user2userPredictions</span><span class="p">(</span><span class="n">userid</span><span class="p">,</span> <span class="n">pred_path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Make rating prediction for the active user on each candidate item and save in file prediction.csv</span>
<span class="sd">    </span>
<span class="sd">    :param</span>
<span class="sd">        - userid : id of the active user</span>
<span class="sd">        - pred_path : where to save predictions</span>
<span class="sd">    &quot;&quot;&quot;</span>    
    <span class="c1"># find candidate items for the active user</span>
    <span class="n">candidates</span> <span class="o">=</span> <span class="n">find_candidate_items</span><span class="p">(</span><span class="n">userid</span><span class="p">)</span>
    
    <span class="c1"># loop over candidates items to make predictions</span>
    <span class="k">for</span> <span class="n">itemid</span> <span class="ow">in</span> <span class="n">candidates</span><span class="p">:</span>
        
        <span class="c1"># prediction for userid on itemid</span>
        <span class="n">r_hat</span> <span class="o">=</span> <span class="n">predict</span><span class="p">(</span><span class="n">userid</span><span class="p">,</span> <span class="n">itemid</span><span class="p">)</span>
        
        <span class="c1"># save predictions</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">pred_path</span><span class="p">,</span> <span class="s1">&#39;a+&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">,</span><span class="si">{}</span><span class="s1">,</span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">userid</span><span class="p">,</span> <span class="n">itemid</span><span class="p">,</span> <span class="n">r_hat</span><span class="p">)</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sys</span>

<span class="k">def</span> <span class="nf">user2userCF</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Make predictions for each user in the database.    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># get list of users in the database</span>
    <span class="n">users</span> <span class="o">=</span> <span class="n">ratings</span><span class="o">.</span><span class="n">userid</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">_progress</span><span class="p">(</span><span class="n">count</span><span class="p">):</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\r</span><span class="s1">Rating predictions. Progress status : </span><span class="si">%.1f%%</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">count</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">users</span><span class="p">))</span><span class="o">*</span><span class="mf">100.0</span><span class="p">))</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
    
    <span class="n">saved_predictions</span> <span class="o">=</span> <span class="s1">&#39;predictions.csv&#39;</span>    
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">saved_predictions</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">saved_predictions</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">count</span><span class="p">,</span> <span class="n">userid</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">users</span><span class="p">):</span>        
        <span class="c1"># make rating predictions for the current user</span>
        <span class="n">user2userPredictions</span><span class="p">(</span><span class="n">userid</span><span class="p">,</span> <span class="n">saved_predictions</span><span class="p">)</span>
        <span class="n">_progress</span><span class="p">(</span><span class="n">count</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">user2userCF</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Rating predictions. Progress status : 99.9%
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="step-4-top-n-recommendation">
<h4>Step 4. Top-N recommendation<a class="headerlink" href="#step-4-top-n-recommendation" title="Permalink to this headline">¶</a></h4>
<p>Function <code class="docutils literal notranslate"><span class="pre">user2userRecommendation()</span></code> reads predictions for a given user and return the list of items in decreasing order of predicted rating.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">user2userRecommendation</span><span class="p">(</span><span class="n">userid</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># encode the userid</span>
    <span class="n">uid</span> <span class="o">=</span> <span class="n">uencoder</span><span class="o">.</span><span class="n">transform</span><span class="p">([</span><span class="n">userid</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">saved_predictions</span> <span class="o">=</span> <span class="s1">&#39;predictions.csv&#39;</span>
    
    <span class="n">predictions</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">saved_predictions</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;userid&#39;</span><span class="p">,</span> <span class="s1">&#39;itemid&#39;</span><span class="p">,</span> <span class="s1">&#39;predicted_rating&#39;</span><span class="p">])</span>
    <span class="n">predictions</span> <span class="o">=</span> <span class="n">predictions</span><span class="p">[</span><span class="n">predictions</span><span class="o">.</span><span class="n">userid</span><span class="o">==</span><span class="n">uid</span><span class="p">]</span>
    <span class="n">List</span> <span class="o">=</span> <span class="n">predictions</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;predicted_rating&#39;</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    
    <span class="n">List</span><span class="o">.</span><span class="n">userid</span> <span class="o">=</span> <span class="n">uencoder</span><span class="o">.</span><span class="n">inverse_transform</span><span class="p">(</span><span class="n">List</span><span class="o">.</span><span class="n">userid</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
    <span class="n">List</span><span class="o">.</span><span class="n">itemid</span> <span class="o">=</span> <span class="n">iencoder</span><span class="o">.</span><span class="n">inverse_transform</span><span class="p">(</span><span class="n">List</span><span class="o">.</span><span class="n">itemid</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
    
    <span class="n">List</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">List</span><span class="p">,</span> <span class="n">movies</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;itemid&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">List</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">user2userRecommendation</span><span class="p">(</span><span class="mi">212</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>userid</th>
      <th>itemid</th>
      <th>predicted_rating</th>
      <th>title</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>212</td>
      <td>483</td>
      <td>4.871495</td>
      <td>Casablanca (1942)</td>
    </tr>
    <tr>
      <th>1</th>
      <td>212</td>
      <td>357</td>
      <td>4.764547</td>
      <td>One Flew Over the Cuckoo's Nest (1975)</td>
    </tr>
    <tr>
      <th>2</th>
      <td>212</td>
      <td>50</td>
      <td>4.660002</td>
      <td>Star Wars (1977)</td>
    </tr>
    <tr>
      <th>3</th>
      <td>212</td>
      <td>98</td>
      <td>4.613636</td>
      <td>Silence of the Lambs, The (1991)</td>
    </tr>
    <tr>
      <th>4</th>
      <td>212</td>
      <td>64</td>
      <td>4.550733</td>
      <td>Shawshank Redemption, The (1994)</td>
    </tr>
    <tr>
      <th>5</th>
      <td>212</td>
      <td>194</td>
      <td>4.522336</td>
      <td>Sting, The (1973)</td>
    </tr>
    <tr>
      <th>6</th>
      <td>212</td>
      <td>174</td>
      <td>4.521300</td>
      <td>Raiders of the Lost Ark (1981)</td>
    </tr>
    <tr>
      <th>7</th>
      <td>212</td>
      <td>134</td>
      <td>4.414819</td>
      <td>Citizen Kane (1941)</td>
    </tr>
    <tr>
      <th>8</th>
      <td>212</td>
      <td>187</td>
      <td>4.344531</td>
      <td>Godfather: Part II, The (1974)</td>
    </tr>
    <tr>
      <th>9</th>
      <td>212</td>
      <td>196</td>
      <td>4.303696</td>
      <td>Dead Poets Society (1989)</td>
    </tr>
    <tr>
      <th>10</th>
      <td>212</td>
      <td>523</td>
      <td>4.281802</td>
      <td>Cool Hand Luke (1967)</td>
    </tr>
    <tr>
      <th>11</th>
      <td>212</td>
      <td>216</td>
      <td>4.278246</td>
      <td>When Harry Met Sally... (1989)</td>
    </tr>
    <tr>
      <th>12</th>
      <td>212</td>
      <td>100</td>
      <td>4.260087</td>
      <td>Fargo (1996)</td>
    </tr>
    <tr>
      <th>13</th>
      <td>212</td>
      <td>168</td>
      <td>4.206139</td>
      <td>Monty Python and the Holy Grail (1974)</td>
    </tr>
    <tr>
      <th>14</th>
      <td>212</td>
      <td>435</td>
      <td>4.122984</td>
      <td>Butch Cassidy and the Sundance Kid (1969)</td>
    </tr>
    <tr>
      <th>15</th>
      <td>212</td>
      <td>135</td>
      <td>4.115228</td>
      <td>2001: A Space Odyssey (1968)</td>
    </tr>
    <tr>
      <th>16</th>
      <td>212</td>
      <td>83</td>
      <td>4.106995</td>
      <td>Much Ado About Nothing (1993)</td>
    </tr>
    <tr>
      <th>17</th>
      <td>212</td>
      <td>69</td>
      <td>4.086366</td>
      <td>Forrest Gump (1994)</td>
    </tr>
    <tr>
      <th>18</th>
      <td>212</td>
      <td>70</td>
      <td>4.086328</td>
      <td>Four Weddings and a Funeral (1994)</td>
    </tr>
    <tr>
      <th>19</th>
      <td>212</td>
      <td>275</td>
      <td>3.985037</td>
      <td>Sense and Sensibility (1995)</td>
    </tr>
    <tr>
      <th>20</th>
      <td>212</td>
      <td>153</td>
      <td>3.981619</td>
      <td>Fish Called Wanda, A (1988)</td>
    </tr>
    <tr>
      <th>21</th>
      <td>212</td>
      <td>514</td>
      <td>3.956640</td>
      <td>Annie Hall (1977)</td>
    </tr>
    <tr>
      <th>22</th>
      <td>212</td>
      <td>521</td>
      <td>3.937792</td>
      <td>Deer Hunter, The (1978)</td>
    </tr>
    <tr>
      <th>23</th>
      <td>212</td>
      <td>97</td>
      <td>3.906106</td>
      <td>Dances with Wolves (1990)</td>
    </tr>
    <tr>
      <th>24</th>
      <td>212</td>
      <td>173</td>
      <td>3.879325</td>
      <td>Princess Bride, The (1987)</td>
    </tr>
    <tr>
      <th>25</th>
      <td>212</td>
      <td>660</td>
      <td>3.847897</td>
      <td>Fried Green Tomatoes (1991)</td>
    </tr>
    <tr>
      <th>26</th>
      <td>212</td>
      <td>215</td>
      <td>3.709920</td>
      <td>Field of Dreams (1989)</td>
    </tr>
    <tr>
      <th>27</th>
      <td>212</td>
      <td>258</td>
      <td>3.583718</td>
      <td>Contact (1997)</td>
    </tr>
    <tr>
      <th>28</th>
      <td>212</td>
      <td>202</td>
      <td>3.508617</td>
      <td>Groundhog Day (1993)</td>
    </tr>
    <tr>
      <th>29</th>
      <td>212</td>
      <td>237</td>
      <td>3.039041</td>
      <td>Jerry Maguire (1996)</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Let us make top n recommendation for a given user.</p>
</div>
</div>
<div class="section" id="evaluation-with-mean-absolute-error-mae">
<h3>Evaluation with Mean Absolute Error (MAE)<a class="headerlink" href="#evaluation-with-mean-absolute-error-mae" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">recsys.preprocessing</span> <span class="kn">import</span> <span class="n">train_test_split</span><span class="p">,</span> <span class="n">get_examples</span>

<span class="c1"># get examples as tuples of userids and itemids and labels from normalize ratings</span>
<span class="n">raw_examples</span><span class="p">,</span> <span class="n">raw_labels</span> <span class="o">=</span> <span class="n">get_examples</span><span class="p">(</span><span class="n">ratings</span><span class="p">,</span> <span class="n">labels_column</span><span class="o">=</span><span class="s1">&#39;rating&#39;</span><span class="p">)</span>

<span class="c1"># train test split</span>
<span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">x_test</span><span class="p">),</span> <span class="p">(</span><span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">examples</span><span class="o">=</span><span class="n">raw_examples</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">raw_labels</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span><span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Evaluate the model on </span><span class="si">{}</span><span class="s1"> test data ...&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x_test</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">preds</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">predict</span><span class="p">(</span><span class="n">u</span><span class="p">,</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">u</span><span class="p">,</span><span class="n">i</span><span class="p">)</span> <span class="ow">in</span> <span class="n">x_test</span><span class="p">)</span>
    <span class="n">mae</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">y_test</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">preds</span><span class="p">)))</span> <span class="o">/</span> <span class="n">x_test</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">MAE :&#39;</span><span class="p">,</span> <span class="n">mae</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">mae</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">evaluate</span><span class="p">(</span><span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evaluate the model on 10000 test data ...

MAE : 0.7505910931068639
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.7505910931068639
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="summary">
<h3>Summary<a class="headerlink" href="#summary" title="Permalink to this headline">¶</a></h3>
<p>We have summarised all the steps of building the user-based collaborative filtering into a python class for further user. Click <a class="reference external" href="https://github.com/nzhinusoftcm/review-on-collaborative-filtering/blob/master/recsys/memories/UserToUser.py">UserToUser.py</a> for more details on the <strong>UserToUser</strong> class definition.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">recsys.memories.UserToUser</span> <span class="kn">import</span> <span class="n">UserToUser</span>

<span class="c1"># load ml100k ratings</span>
<span class="n">ratings</span><span class="p">,</span> <span class="n">movies</span> <span class="o">=</span> <span class="n">ml100k</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>

<span class="c1"># prepare data</span>
<span class="n">ratings</span><span class="p">,</span> <span class="n">uencoder</span><span class="p">,</span> <span class="n">iencoder</span> <span class="o">=</span> <span class="n">ids_encoder</span><span class="p">(</span><span class="n">ratings</span><span class="p">)</span>

<span class="c1"># get examples as tuples of userids and itemids and labels from normalize ratings</span>
<span class="n">raw_examples</span><span class="p">,</span> <span class="n">raw_labels</span> <span class="o">=</span> <span class="n">get_examples</span><span class="p">(</span><span class="n">ratings</span><span class="p">,</span> <span class="n">labels_column</span><span class="o">=</span><span class="s1">&#39;rating&#39;</span><span class="p">)</span>

<span class="c1"># train test split</span>
<span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">x_test</span><span class="p">),</span> <span class="p">(</span><span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">examples</span><span class="o">=</span><span class="n">raw_examples</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">raw_labels</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># create the user-based CF</span>
<span class="n">usertouser</span> <span class="o">=</span> <span class="n">UserToUser</span><span class="p">(</span><span class="n">ratings</span><span class="p">,</span> <span class="n">movies</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="s1">&#39;cosine&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Normalize users ratings ...
Initialize the similarity model ...
Compute nearest neighbors ...
User to user recommendation model created with success ...
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># evaluate the user-based CF on the ml100k test data</span>
<span class="n">usertouser</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evaluate the model on 10000 test data ...

MAE : 0.7505910931068639
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.7505910931068639
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="evaluation-on-the-ml-1m-dataset-this-may-take-some-time">
<h3>Evaluation on the ML-1M dataset (this may take some time)<a class="headerlink" href="#evaluation-on-the-ml-1m-dataset-this-may-take-some-time" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">recsys.datasets</span> <span class="kn">import</span> <span class="n">ml1m</span>
<span class="kn">from</span> <span class="nn">recsys.preprocessing</span> <span class="kn">import</span> <span class="n">ids_encoder</span><span class="p">,</span> <span class="n">get_examples</span><span class="p">,</span> <span class="n">train_test_split</span>
<span class="kn">from</span> <span class="nn">recsys.memories.UserToUser</span> <span class="kn">import</span> <span class="n">UserToUser</span>

<span class="c1"># load ml100k ratings</span>
<span class="n">ratings</span><span class="p">,</span> <span class="n">movies</span> <span class="o">=</span> <span class="n">ml1m</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>

<span class="c1"># prepare data</span>
<span class="n">ratings</span><span class="p">,</span> <span class="n">uencoder</span><span class="p">,</span> <span class="n">iencoder</span> <span class="o">=</span> <span class="n">ids_encoder</span><span class="p">(</span><span class="n">ratings</span><span class="p">)</span>

<span class="c1"># get examples as tuples of userids and itemids and labels from normalize ratings</span>
<span class="n">raw_examples</span><span class="p">,</span> <span class="n">raw_labels</span> <span class="o">=</span> <span class="n">get_examples</span><span class="p">(</span><span class="n">ratings</span><span class="p">,</span> <span class="n">labels_column</span><span class="o">=</span><span class="s1">&#39;rating&#39;</span><span class="p">)</span>

<span class="c1"># train test split</span>
<span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">x_test</span><span class="p">),</span> <span class="p">(</span><span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">examples</span><span class="o">=</span><span class="n">raw_examples</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">raw_labels</span><span class="p">)</span>

<span class="c1"># create the user-based CF</span>
<span class="n">usertouser</span> <span class="o">=</span> <span class="n">UserToUser</span><span class="p">(</span><span class="n">ratings</span><span class="p">,</span> <span class="n">movies</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="s1">&#39;cosine&#39;</span><span class="p">)</span>

<span class="c1"># evaluate the user-based CF on the ml1m test data</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;==========================&quot;</span><span class="p">)</span>
<span class="n">usertouser</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Normalize users ratings ...
Initialize the similarity model ...
Compute nearest neighbors ...
User to user recommendation model created with success ...
==========================
Evaluate the model on 100021 test data ...

MAE : 0.732267005840993
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.732267005840993
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="limitations-of-user-based-cf">
<h3>Limitations of user-based CF<a class="headerlink" href="#limitations-of-user-based-cf" title="Permalink to this headline">¶</a></h3>
<ol class="simple">
<li><p><b> Sparsity </b> : In general, users interact with less than 20% of items. This leads the rating matrix to be highly sparse. For example, the movielen-100k contains 100k ratings from 943 users on 1682 items. The pourcentage of sparsity in this case is around <span class="math notranslate nohighlight">\(94\%\)</span>. A recommender system based on nearest neighbor algorithms may be unable to make any item recommendations for a particular user. As a result the accuracy of recommendations may be poor <a href="https://dl.acm.org/doi/10.1145/371920.372071">(Sarwar <i>et al.</i> 2001)</a>.</p></li>
<li><p><b> Stability of user’s ratings </b> : As a user rates and re-rates items, their rating vector will change along with their similarity to other users. A user’s neighborhood is determined not only by their ratings but also by the ratings of other users, so their neighborhood can change as a result of new ratings supplied by any user in the system <a href="https://dl.acm.org/doi/10.1561/1100000009">(Michael D. Ekstrand, <i>et al.</i> 2011)</a>.</p></li>
<li><p><b> Scalability </b> : Due to the non-stability of users ratings, finding similar users in advance is complicated. For this reason, most user-based CF systems find neighborhoods each time predictions or recommendations are needed. However, these are huge computations that grows with both the number of users and the number of items. With millions of users and items, a typical web-based recommender system running existing algorithms will suffer serious scalability concerns <a href="https://dl.acm.org/doi/10.1145/371920.372071">(Sarwar <i>et al.</i> 2001)</a>, <a href="https://dl.acm.org/doi/10.1561/1100000009">(Michael D. Ekstrand, <i>et al.</i> 2011)</a>.</p></li>
</ol>
</div>
</div>
<div class="section" id="part-3-item-based-method">
<h2>Part 3 - Item-based method<a class="headerlink" href="#part-3-item-based-method" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><p>Collaborative Filtering on MovieLens Latest-small Part 3 - Finding recommendations using memory based item-item similarity method</p>
</div></blockquote>
<div class="section" id="id1">
<h3>Idea<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<p>Let <span class="math notranslate nohighlight">\(u\)</span> be the active user and <span class="math notranslate nohighlight">\(i\)</span> the referenced item</p>
<ol class="simple">
<li><p>If <span class="math notranslate nohighlight">\(u\)</span> liked items similar to <span class="math notranslate nohighlight">\(i\)</span>, he will probably like item <span class="math notranslate nohighlight">\(i\)</span>.</p></li>
<li><p>If he hated or disliked items similar to <span class="math notranslate nohighlight">\(i\)</span>, he will also hate item <span class="math notranslate nohighlight">\(i\)</span>.</p></li>
</ol>
<p>The idea is therefore to look at how an active user <span class="math notranslate nohighlight">\(u\)</span> rated items similar to <span class="math notranslate nohighlight">\(i\)</span> to know how he would have rated item <span class="math notranslate nohighlight">\(i\)</span></p>
</div>
<div class="section" id="advantages-over-user-based-cf">
<h3>Advantages over user-based CF<a class="headerlink" href="#advantages-over-user-based-cf" title="Permalink to this headline">¶</a></h3>
<ol class="simple">
<li><p><b> Stability </b> : Items ratings are more stable than users ratings. New ratings on items are unlikely to significantly change the similarity between two items, particularly when the items have many ratings <a href="https://dl.acm.org/doi/10.1561/1100000009">(Michael D. Ekstrand, <i>et al.</i> 2011)</a>.</p></li>
<li><p><b> Scalability </b> : with stable item’s ratings, it is reasonable to pre-compute similarities between items in an item-item similarity matrix (similarity between items can be computed offline). This will reduce the scalability concern of the algorithm. <a href="https://dl.acm.org/doi/10.1145/371920.372071">(Sarwar <i>et al.</i> 2001)</a>, <a href="https://dl.acm.org/doi/10.1561/1100000009">(Michael D. Ekstrand, <i>et al.</i> 2011)</a>.</p></li>
</ol>
</div>
<div class="section" id="algorithm-item-to-item-collaborative-filtering">
<h3>Algorithm : item-to-item collaborative filtering<a class="headerlink" href="#algorithm-item-to-item-collaborative-filtering" title="Permalink to this headline">¶</a></h3>
<p>The algorithm that defines item-based CF is described as follow <a href="http://citeseerx.ist.psu.edu/viewdoc/download?doi=10.1.1.449.1171&rep=rep1&type=pdf">(B. Sarwar et al. 2001)</a><a href="https://citeseerx.ist.psu.edu/viewdoc/download?doi=10.1.1.554.1671&rep=rep1&type=pdf">(George Karypis 2001)</a> :</p>
<ol>
    <li>
        First identify the $k$ most similar items for each item in the catalogue and record the corresponding similarities. To compute similarity between two items we can user the <i>Adjusted Cosine Similarity</i> that has proven to be more efficient than the basic <i>Cosine similarity measure</i> used for user-based collaborative as described in <a href="http://citeseerx.ist.psu.edu/viewdoc/download?doi=10.1.1.449.1171&rep=rep1&type=pdf">(B. Sarwar et al. 2001)</a>. The Adjusted Cosine distance between two items $i$ and $j$ is computed as follow
<p>\begin{equation}
w_{i,j}= \frac{\sum_{u\in U}(r_{u,i}-\bar{r}<em>u)(r</em>{u,j}-\bar{r}<em>u)}{\sqrt{\sum</em>{u\in U} (r_{u,i}-\bar{r}<em>u)^2}\sqrt{\sum</em>{u\in U} (r_{u,j}-\bar{r}_u)^2}}
\end{equation}</p>
<p><span class="math notranslate nohighlight">\(w_{i,j}\)</span> is the degree of similarity between items <span class="math notranslate nohighlight">\(i\)</span> and <span class="math notranslate nohighlight">\(j\)</span>. This term is computed for all users <span class="math notranslate nohighlight">\(u\in U\)</span>, where <span class="math notranslate nohighlight">\(U\)</span> is the set of users that rated both items <span class="math notranslate nohighlight">\(i\)</span> and <span class="math notranslate nohighlight">\(j\)</span>. Let’s denote by <span class="math notranslate nohighlight">\(S^{(i)}\)</span> the set of the <span class="math notranslate nohighlight">\(k\)</span> most similar items to item <span class="math notranslate nohighlight">\(i\)</span>.
</li><br />
<li> To produce top-N recommendations for a given user <span class="math notranslate nohighlight">\(u\)</span> that has already purchased a set <span class="math notranslate nohighlight">\(I_u\)</span> of items, do the following :</p>
<ul>
    <li> Find the set $C$ of candidate items by taking the union of all $S^{(i)}, \forall i\in I_u$ and removing each of the items in the set $I_u$.
\begin{equation}
 C = \bigcup_{i\in I_u}\{S^{(i)}\}\smallsetminus I_u
\end{equation}
    </li>
    <li>
        $\forall c\in C$, compute similarity between c and the set $I_u$ as follows:
\begin{equation}
 w_{c,I_u} = \sum_{i\in I_u} w_{c,i}, \forall c \in C
\end{equation}
    </li>
    <li>
        Sort items in $C$ in decreasing order of $w_{c,I_u}, \forall c \in C$, and return the first $N$ items as the Top-N recommendation list.
    </li>
</ul>    
    </li>
</ol><p>Before returning the first <span class="math notranslate nohighlight">\(N\)</span> items as top-N recommendation list, we can make predictions about what user <span class="math notranslate nohighlight">\(u\)</span> would have given to each items in the top-N recommendation list, rearrange the list in descending order of predicted ratings and return the rearranged list as the final recommendation list. Rating prediction for item-based CF is given by the following formular <a href="http://citeseerx.ist.psu.edu/viewdoc/download?doi=10.1.1.449.1171&rep=rep1&type=pdf">(B. Sarwar et al. 2001)</a>:</p>
<p>\begin{equation}
\hat{r}<em>{u,i}=\frac{\sum</em>{i\in S^{(i)}}r_{u,j}\cdot w_{i,j}}{\sum_{j\in S^{(i)}}|w_{i,j}|}
\end{equation}</p>
<div class="section" id="import-useful-requirements">
<h4>Import useful requirements<a class="headerlink" href="#import-useful-requirements" title="Permalink to this headline">¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>import os

if not (os.path.exists(&quot;recsys.zip&quot;) or os.path.exists(&quot;recsys&quot;)):
    !wget https://github.com/nzhinusoftcm/review-on-collaborative-filtering/raw/master/recsys.zip    
    !unzip recsys.zip
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="id2">
<h4>Import requirements<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h4>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">matplotlib</span><span class="o">==</span><span class="mf">3.2</span><span class="o">.</span><span class="mi">2</span>
<span class="n">numpy</span><span class="o">==</span><span class="mf">1.19</span><span class="o">.</span><span class="mi">2</span>
<span class="n">pandas</span><span class="o">==</span><span class="mf">1.0</span><span class="o">.</span><span class="mi">5</span>
<span class="n">python</span><span class="o">==</span><span class="mf">3.7</span>
<span class="n">scikit</span><span class="o">-</span><span class="n">learn</span><span class="o">==</span><span class="mf">0.24</span><span class="o">.</span><span class="mi">1</span>
<span class="n">scikit</span><span class="o">-</span><span class="n">surprise</span><span class="o">==</span><span class="mf">1.1</span><span class="o">.</span><span class="mi">1</span>
<span class="n">scipy</span><span class="o">==</span><span class="mf">1.6</span><span class="o">.</span><span class="mi">2</span>
</pre></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.neighbors</span> <span class="kn">import</span> <span class="n">NearestNeighbors</span>
<span class="kn">from</span> <span class="nn">scipy.sparse</span> <span class="kn">import</span> <span class="n">csr_matrix</span>

<span class="kn">from</span> <span class="nn">recsys.datasets</span> <span class="kn">import</span> <span class="n">ml1m</span><span class="p">,</span> <span class="n">ml100k</span>
<span class="kn">from</span> <span class="nn">recsys.preprocessing</span> <span class="kn">import</span> <span class="n">ids_encoder</span>

<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="load-ratings">
<h4>Load ratings<a class="headerlink" href="#load-ratings" title="Permalink to this headline">¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ratings</span><span class="p">,</span> <span class="n">movies</span> <span class="o">=</span> <span class="n">ml100k</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="id3">
<h4>userids and itemids encoding<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># create the encoder</span>
<span class="n">ratings</span><span class="p">,</span> <span class="n">uencoder</span><span class="p">,</span> <span class="n">iencoder</span> <span class="o">=</span> <span class="n">ids_encoder</span><span class="p">(</span><span class="n">ratings</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s implements the item-based collaborative filtering algorithm described above</p>
</div>
<div class="section" id="step-1-find-similarities-for-each-of-the-items">
<h4>Step 1. Find similarities for each of the items<a class="headerlink" href="#step-1-find-similarities-for-each-of-the-items" title="Permalink to this headline">¶</a></h4>
<p>To compute similarity between two items <span class="math notranslate nohighlight">\(i\)</span> and <span class="math notranslate nohighlight">\(j\)</span>, we need to :</p>
<ol class="simple">
<li><p>find all users who rated both of them,</p></li>
<li><p>Normalize their ratings on items <span class="math notranslate nohighlight">\(i\)</span> and <span class="math notranslate nohighlight">\(j\)</span></p></li>
<li><p>Apply the cosine metric to the normalized ratings to compute similarity between <span class="math notranslate nohighlight">\(i\)</span> and <span class="math notranslate nohighlight">\(j\)</span></p></li>
</ol>
<p>Function <code class="docutils literal notranslate"><span class="pre">normalize()</span></code> process the rating dataframe to normalize ratings of all users</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">normalize</span><span class="p">():</span>
    <span class="c1"># compute mean rating for each user</span>
    <span class="n">mean</span> <span class="o">=</span> <span class="n">ratings</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;userid&#39;</span><span class="p">,</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="s1">&#39;rating&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">norm_ratings</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">ratings</span><span class="p">,</span> <span class="n">mean</span><span class="p">,</span> <span class="n">suffixes</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;_mean&#39;</span><span class="p">),</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;userid&#39;</span><span class="p">)</span>
    
    <span class="c1"># normalize each rating by substracting the mean rating of the corresponding user</span>
    <span class="n">norm_ratings</span><span class="p">[</span><span class="s1">&#39;norm_rating&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">norm_ratings</span><span class="p">[</span><span class="s1">&#39;rating&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">norm_ratings</span><span class="p">[</span><span class="s1">&#39;rating_mean&#39;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">mean</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">norm_ratings</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mean</span><span class="p">,</span> <span class="n">norm_ratings</span> <span class="o">=</span> <span class="n">normalize</span><span class="p">()</span>
<span class="n">np_ratings</span> <span class="o">=</span> <span class="n">norm_ratings</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
<span class="n">norm_ratings</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>userid</th>
      <th>itemid</th>
      <th>rating</th>
      <th>rating_mean</th>
      <th>norm_rating</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0</td>
      <td>0</td>
      <td>5</td>
      <td>3.610294</td>
      <td>1.389706</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0</td>
      <td>1</td>
      <td>3</td>
      <td>3.610294</td>
      <td>-0.610294</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0</td>
      <td>2</td>
      <td>4</td>
      <td>3.610294</td>
      <td>0.389706</td>
    </tr>
    <tr>
      <th>3</th>
      <td>0</td>
      <td>3</td>
      <td>3</td>
      <td>3.610294</td>
      <td>-0.610294</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0</td>
      <td>4</td>
      <td>3</td>
      <td>3.610294</td>
      <td>-0.610294</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>now that each rating has been normalized, we can represent each item by a vector of its normalized ratings</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">item_representation</span><span class="p">(</span><span class="n">ratings</span><span class="p">):</span>    
    <span class="k">return</span> <span class="n">csr_matrix</span><span class="p">(</span>
        <span class="n">pd</span><span class="o">.</span><span class="n">crosstab</span><span class="p">(</span><span class="n">ratings</span><span class="o">.</span><span class="n">itemid</span><span class="p">,</span> <span class="n">ratings</span><span class="o">.</span><span class="n">userid</span><span class="p">,</span> <span class="n">ratings</span><span class="o">.</span><span class="n">norm_rating</span><span class="p">,</span> <span class="n">aggfunc</span><span class="o">=</span><span class="nb">sum</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">R</span> <span class="o">=</span> <span class="n">item_representation</span><span class="p">(</span><span class="n">norm_ratings</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s build and fit our <span class="math notranslate nohighlight">\(k\)</span>-NN model using sklearn</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">create_model</span><span class="p">(</span><span class="n">rating_matrix</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="s2">&quot;cosine&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :param R : numpy array of item representations</span>
<span class="sd">    :param k : number of nearest neighbors to return    </span>
<span class="sd">    :return model : our knn model</span>
<span class="sd">    &quot;&quot;&quot;</span>    
    <span class="n">model</span> <span class="o">=</span> <span class="n">NearestNeighbors</span><span class="p">(</span><span class="n">metric</span><span class="o">=</span><span class="n">metric</span><span class="p">,</span> <span class="n">n_neighbors</span><span class="o">=</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="s1">&#39;brute&#39;</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">rating_matrix</span><span class="p">)</span>    
    <span class="k">return</span> <span class="n">model</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="similarities-computation">
<h5>Similarities computation<a class="headerlink" href="#similarities-computation" title="Permalink to this headline">¶</a></h5>
<p>Similarities between items can be measured with the <em>Cosine</em> or <em>Eucliedian</em> distance. The <em><strong>NearestNeighbors</strong></em> class from the sklearn library simplifies the computation of neighbors. We just need to specify the metric (e.g. cosine or euclidian) that will be used to compute similarities.</p>
<p>The above method, <code class="docutils literal notranslate"><span class="pre">create_model</span></code>, creates the kNN model and the following <code class="docutils literal notranslate"><span class="pre">nearest_neighbors</span></code> method uses the created model to kNN items. It returns nearest neighbors as well as similarities measures for each items.</p>
<p><code class="docutils literal notranslate"><span class="pre">nearest_neighbors</span></code> returns :</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">similarities</span></code> : numpy array of shape <span class="math notranslate nohighlight">\((n,k)\)</span></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">neighbors</span></code> : numpy array of shape <span class="math notranslate nohighlight">\((n,k)\)</span></p></li>
</ul>
<p>where <span class="math notranslate nohighlight">\(n\)</span> is the total number of items and <span class="math notranslate nohighlight">\(k\)</span> is the number of neighbors to return, specified when creating the kNN model.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">nearest_neighbors</span><span class="p">(</span><span class="n">rating_matrix</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    compute the top n similar items for each item.    </span>
<span class="sd">    :param rating_matrix : items representations</span>
<span class="sd">    :param model : nearest neighbors model    </span>
<span class="sd">    :return similarities, neighbors</span>
<span class="sd">    &quot;&quot;&quot;</span>    
    <span class="n">similarities</span><span class="p">,</span> <span class="n">neighbors</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">kneighbors</span><span class="p">(</span><span class="n">rating_matrix</span><span class="p">)</span>    
    <span class="k">return</span> <span class="n">similarities</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:],</span> <span class="n">neighbors</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:]</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="ajusted-cosine-similarity">
<h5>Ajusted Cosine Similarity<a class="headerlink" href="#ajusted-cosine-similarity" title="Permalink to this headline">¶</a></h5>
<p>In the context of item-based collaborative filtering, the adjusted cosine similarity has shown to be more efficient that the cosine or the euclidian distance. Here is the formular to compute the adjusted cosine weight between two items <span class="math notranslate nohighlight">\(i\)</span> and <span class="math notranslate nohighlight">\(j\)</span> :</p>
<p>\begin{equation}
w_{i,j}= \frac{\sum_{u\in U}(r_{u,i}-\bar{r}<em>u)(r</em>{u,j}-\bar{r}<em>u)}{\sqrt{\sum</em>{u\in U} (r_{u,i}-\bar{r}<em>u)^2}\sqrt{\sum</em>{u\in U} (r_{u,j}-\bar{r}_u)^2}}.
\end{equation}</p>
<p>This term is computed for all users <span class="math notranslate nohighlight">\(u\in U\)</span>, where <span class="math notranslate nohighlight">\(U\)</span> is the set of users that rated both items <span class="math notranslate nohighlight">\(i\)</span> and <span class="math notranslate nohighlight">\(j\)</span>. Since the <em>sklearn</em> library do not directly implement the adjusted cosine similarity metric, we will implement it with the method <code class="docutils literal notranslate"><span class="pre">adjusted_cosine</span></code>, with some helper function :</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">save_similarities</span></code> : since the computation of the adjusted cosine similarity is time consuming, around 5 mins for the ml100k dataset, we use this method to save the computed similarities for lated usage.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">load_similarities</span></code> : load the saved similarities</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">cosine</span></code> : cosine distance between two vectors.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">save_similarities</span><span class="p">(</span><span class="n">similarities</span><span class="p">,</span> <span class="n">neighbors</span><span class="p">,</span> <span class="n">dataset_name</span><span class="p">):</span>    
    <span class="n">base_dir</span> <span class="o">=</span> <span class="s1">&#39;recsys/weights/item2item&#39;</span>
    <span class="n">save_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">dataset_name</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">save_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>    
    <span class="n">similarities_file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_dir</span><span class="p">,</span> <span class="s1">&#39;similarities.npy&#39;</span><span class="p">)</span>
    <span class="n">neighbors_file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_dir</span><span class="p">,</span> <span class="s1">&#39;neighbors.npy&#39;</span><span class="p">)</span>    
    <span class="k">try</span><span class="p">:</span>
        <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">similarities_file_name</span><span class="p">,</span> <span class="n">similarities</span><span class="p">)</span>
        <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">neighbors_file_name</span><span class="p">,</span> <span class="n">neighbors</span><span class="p">)</span>        
    <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;An error occured when saving similarities, due to : </span><span class="se">\n</span><span class="s2"> ValueError : </span><span class="si">{</span><span class="n">error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        
<span class="k">def</span> <span class="nf">load_similarities</span><span class="p">(</span><span class="n">dataset_name</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">20</span><span class="p">):</span>
    <span class="n">base_dir</span> <span class="o">=</span> <span class="s1">&#39;recsys/weights/item2item&#39;</span>
    <span class="n">save_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">dataset_name</span><span class="p">)</span>    
    <span class="n">similiraties_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_dir</span><span class="p">,</span> <span class="s1">&#39;similarities.npy&#39;</span><span class="p">)</span>
    <span class="n">neighbors_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_dir</span><span class="p">,</span> <span class="s1">&#39;neighbors.npy&#39;</span><span class="p">)</span>    
    <span class="n">similarities</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">similiraties_file</span><span class="p">)</span>
    <span class="n">neighbors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">neighbors_file</span><span class="p">)</span>    
    <span class="k">return</span> <span class="n">similarities</span><span class="p">[:,:</span><span class="n">k</span><span class="p">],</span> <span class="n">neighbors</span><span class="p">[:,:</span><span class="n">k</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">cosine</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">adjusted_cosine</span><span class="p">(</span><span class="n">np_ratings</span><span class="p">,</span> <span class="n">nb_items</span><span class="p">,</span> <span class="n">dataset_name</span><span class="p">):</span>
    <span class="n">similarities</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">nb_items</span><span class="p">,</span> <span class="n">nb_items</span><span class="p">))</span>
    <span class="n">similarities</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">_progress</span><span class="p">(</span><span class="n">count</span><span class="p">):</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\r</span><span class="s1">Computing similarities. Progress status : </span><span class="si">%.1f%%</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">count</span> <span class="o">/</span> <span class="n">nb_items</span><span class="p">)</span><span class="o">*</span><span class="mf">100.0</span><span class="p">))</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        
    <span class="n">items</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">ratings</span><span class="o">.</span><span class="n">itemid</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>    
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">items</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">items</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">:]:</span>            
            <span class="n">scores</span> <span class="o">=</span> <span class="n">np_ratings</span><span class="p">[(</span><span class="n">np_ratings</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">i</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">np_ratings</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">j</span><span class="p">),</span> <span class="p">:]</span>
            <span class="n">vals</span><span class="p">,</span> <span class="n">count</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">scores</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">return_counts</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
            <span class="n">scores</span> <span class="o">=</span> <span class="n">scores</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">scores</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">vals</span><span class="p">[</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">]),:]</span>

            <span class="k">if</span> <span class="n">scores</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">scores</span><span class="p">[</span><span class="n">scores</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="n">i</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span>
                <span class="n">y</span> <span class="o">=</span> <span class="n">scores</span><span class="p">[</span><span class="n">scores</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="n">j</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span>
                <span class="n">w</span> <span class="o">=</span> <span class="n">cosine</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

                <span class="n">similarities</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">w</span>
                <span class="n">similarities</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">w</span>
        <span class="n">_progress</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="n">_progress</span><span class="p">(</span><span class="n">nb_items</span><span class="p">)</span>
    
    <span class="c1"># get neighbors by their neighbors in decreasing order of similarities</span>
    <span class="n">neighbors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">similarities</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="c1"># sort similarities in decreasing order</span>
    <span class="n">similarities</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">similarities</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="c1"># save similarities to disk</span>
    <span class="n">save_similarities</span><span class="p">(</span><span class="n">similarities</span><span class="p">,</span> <span class="n">neighbors</span><span class="p">,</span> <span class="n">dataset_name</span><span class="o">=</span><span class="n">dataset_name</span><span class="p">)</span> 
    
    <span class="k">return</span> <span class="n">similarities</span><span class="p">,</span> <span class="n">neighbors</span>
</pre></div>
</div>
</div>
</div>
<p>now, we can call the <code class="docutils literal notranslate"><span class="pre">adjusted_cosine</span></code> function to compute and save items similarities and neighbors based on the adjusted cosine metric.</p>
<p>uncomment the two lines of the following cell to compute the adjusted cosine between all items. As we have already run the next cell before, we will just load the precomputed similarities for further use.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># nb_items = ratings.itemid.nunique()</span>
<span class="c1"># similarities, neighbors = adjusted_cosine(np_ratings, nb_items=nb_items, dataset_name=&#39;ml100k&#39;)</span>
</pre></div>
</div>
</div>
</div>
<p>Among the following similarity metrics, choose the one you wish to use for the item-based collaborative filtering :</p>
<ul class="simple">
<li><p><strong>euclidian</strong> or <strong>cosine</strong> : choose <em>euclidian</em> or <em>cosine</em> to initialise the similarity model through the sklearn library.</p></li>
<li><p><strong>adjusted_cosine</strong> : choose the <em>adjusted_cosine</em> metric to load similarities computed and saved through the <code class="docutils literal notranslate"><span class="pre">adjusted_cosine</span></code> function.</p></li>
</ul>
<p>In this case, we will use the <em>adjusted_cosine</em> metric.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># metric : choose among [cosine, euclidean, adjusted_cosine]</span>

<span class="n">metric</span> <span class="o">=</span> <span class="s1">&#39;adjusted_cosine&#39;</span>

<span class="k">if</span> <span class="n">metric</span> <span class="o">==</span> <span class="s1">&#39;adjusted_cosine&#39;</span><span class="p">:</span>
    <span class="n">similarities</span><span class="p">,</span> <span class="n">neighbors</span> <span class="o">=</span> <span class="n">load_similarities</span><span class="p">(</span><span class="s1">&#39;ml100k&#39;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">create_model</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">21</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="n">metric</span><span class="p">)</span>
    <span class="n">similarities</span><span class="p">,</span> <span class="n">neighbors</span> <span class="o">=</span> <span class="n">nearest_neighbors</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;neighbors shape : &#39;</span><span class="p">,</span> <span class="n">neighbors</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;similarities shape : &#39;</span><span class="p">,</span> <span class="n">similarities</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>neighbors shape :  (1682, 20)
similarities shape :  (1682, 20)
</pre></div>
</div>
</div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">neighbors</span></code> and <code class="docutils literal notranslate"><span class="pre">similarities</span></code> are numpy array, were each entries are list of 20 neighbors with their corresponding similarities</p>
</div>
</div>
<div class="section" id="step-2-top-n-recommendation-for-a-given-user">
<h4>Step 2. Top N recommendation for a given user<a class="headerlink" href="#step-2-top-n-recommendation-for-a-given-user" title="Permalink to this headline">¶</a></h4>
<p>Top-N recommendations are made for example for a user <span class="math notranslate nohighlight">\(u\)</span> who has already rated a set of items <span class="math notranslate nohighlight">\(I_u\)</span></p>
<div class="section" id="a-finding-candidate-items">
<h5>2.a- Finding candidate items<a class="headerlink" href="#a-finding-candidate-items" title="Permalink to this headline">¶</a></h5>
<p>To find candidate items for user <span class="math notranslate nohighlight">\(u\)</span>, we need to :</p>
<ol class="simple">
<li><p>Find the set <span class="math notranslate nohighlight">\(I_u\)</span> of items already rated by user <span class="math notranslate nohighlight">\(u\)</span>,</p></li>
<li><p>Take the union of similar items as <span class="math notranslate nohighlight">\(C\)</span> for all items in <span class="math notranslate nohighlight">\(I_u\)</span></p></li>
<li><p>exclude from the set <span class="math notranslate nohighlight">\(C\)</span> all items in <span class="math notranslate nohighlight">\(I_u\)</span>, to avoid recommend to a user items he has already purchased.</p></li>
</ol>
<p>These are done in function <code class="docutils literal notranslate"><span class="pre">candidate_items()</span></code></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">candidate_items</span><span class="p">(</span><span class="n">userid</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :param userid : user id for which we wish to find candidate items    </span>
<span class="sd">    :return : I_u, candidates</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c1"># 1. Finding the set I_u of items already rated by user userid</span>
    <span class="n">I_u</span> <span class="o">=</span> <span class="n">np_ratings</span><span class="p">[</span><span class="n">np_ratings</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">userid</span><span class="p">]</span>
    <span class="n">I_u</span> <span class="o">=</span> <span class="n">I_u</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int&#39;</span><span class="p">)</span>
    
    <span class="c1"># 2. Taking the union of similar items for all items in I_u to form the set of candidate items</span>
    <span class="n">c</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        
    <span class="k">for</span> <span class="n">iid</span> <span class="ow">in</span> <span class="n">I_u</span><span class="p">:</span>    
        <span class="c1"># add the neighbors of item iid in the set of candidate items</span>
        <span class="n">c</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">neighbors</span><span class="p">[</span><span class="n">iid</span><span class="p">])</span>
        
    <span class="n">c</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
    <span class="c1"># 3. exclude from the set C all items in I_u.</span>
    <span class="n">candidates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">setdiff1d</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">I_u</span><span class="p">,</span> <span class="n">assume_unique</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">I_u</span><span class="p">,</span> <span class="n">candidates</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">test_user</span> <span class="o">=</span> <span class="n">uencoder</span><span class="o">.</span><span class="n">transform</span><span class="p">([</span><span class="mi">1</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">i_u</span><span class="p">,</span> <span class="n">u_candidates</span> <span class="o">=</span> <span class="n">candidate_items</span><span class="p">(</span><span class="n">test_user</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;number of items purchased by user 1 : &#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">i_u</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;number of candidate items for user 1 : &#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">u_candidates</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>number of items purchased by user 1 :  272
number of candidate items for user 1 :  893
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="b-find-similarity-between-each-candidate-item-and-the-set-i-u">
<h5>2.b- Find similarity between each candidate item and the set <span class="math notranslate nohighlight">\(I_u\)</span><a class="headerlink" href="#b-find-similarity-between-each-candidate-item-and-the-set-i-u" title="Permalink to this headline">¶</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">similarity_with_Iu</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">I_u</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    compute similarity between an item c and a set of items I_u. For each item i in I_u, get similarity between </span>
<span class="sd">    i and c, if c exists in the set of items similar to itemid.    </span>
<span class="sd">    :param c : itemid of a candidate item</span>
<span class="sd">    :param I_u : set of items already purchased by a given user    </span>
<span class="sd">    :return w : similarity between c and I_u</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">w</span> <span class="o">=</span> <span class="mi">0</span>    
    <span class="k">for</span> <span class="n">iid</span> <span class="ow">in</span> <span class="n">I_u</span> <span class="p">:</span>        
        <span class="c1"># get similarity between itemid and c, if c is one of the k nearest neighbors of itemid</span>
        <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">neighbors</span><span class="p">[</span><span class="n">iid</span><span class="p">]</span> <span class="p">:</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">w</span> <span class="o">+</span> <span class="n">similarities</span><span class="p">[</span><span class="n">iid</span><span class="p">,</span> <span class="n">neighbors</span><span class="p">[</span><span class="n">iid</span><span class="p">]</span> <span class="o">==</span> <span class="n">c</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>    
    <span class="k">return</span> <span class="n">w</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="c-rank-candidate-items-according-to-their-similarities-to-i-u">
<h5>2.c- Rank candidate items according to their similarities to <span class="math notranslate nohighlight">\(I_u\)</span><a class="headerlink" href="#c-rank-candidate-items-according-to-their-similarities-to-i-u" title="Permalink to this headline">¶</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">rank_candidates</span><span class="p">(</span><span class="n">candidates</span><span class="p">,</span> <span class="n">I_u</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    rank candidate items according to their similarities with i_u    </span>
<span class="sd">    :param candidates : list of candidate items</span>
<span class="sd">    :param I_u : list of items purchased by the user    </span>
<span class="sd">    :return ranked_candidates : dataframe of candidate items, ranked in descending order of similarities with I_u</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c1"># list of candidate items mapped to their corresponding similarities to I_u</span>
    <span class="n">sims</span> <span class="o">=</span> <span class="p">[</span><span class="n">similarity_with_Iu</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">I_u</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">candidates</span><span class="p">]</span>
    <span class="n">candidates</span> <span class="o">=</span> <span class="n">iencoder</span><span class="o">.</span><span class="n">inverse_transform</span><span class="p">(</span><span class="n">candidates</span><span class="p">)</span>    
    <span class="n">mapping</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">candidates</span><span class="p">,</span> <span class="n">sims</span><span class="p">))</span>
    
    <span class="n">ranked_candidates</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">mapping</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">couple</span><span class="p">:</span><span class="n">couple</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>    
    <span class="k">return</span> <span class="n">ranked_candidates</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="putting-all-together">
<h3>Putting all together<a class="headerlink" href="#putting-all-together" title="Permalink to this headline">¶</a></h3>
<p>Now that we defined all functions necessary to build our item to item top-N recommendation, let’s define function <code class="docutils literal notranslate"><span class="pre">item2item_topN()</span></code> that makes top-<span class="math notranslate nohighlight">\(N\)</span> recommendations for a given user</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">topn_recommendation</span><span class="p">(</span><span class="n">userid</span><span class="p">,</span> <span class="n">N</span><span class="o">=</span><span class="mi">30</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Produce top-N recommendation for a given user    </span>
<span class="sd">    :param userid : user for which we produce top-N recommendation</span>
<span class="sd">    :param n : length of the top-N recommendation list    </span>
<span class="sd">    :return topn</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># find candidate items</span>
    <span class="n">I_u</span><span class="p">,</span> <span class="n">candidates</span> <span class="o">=</span> <span class="n">candidate_items</span><span class="p">(</span><span class="n">userid</span><span class="p">)</span>
    
    <span class="c1"># rank candidate items according to their similarities with I_u</span>
    <span class="n">ranked_candidates</span> <span class="o">=</span> <span class="n">rank_candidates</span><span class="p">(</span><span class="n">candidates</span><span class="p">,</span> <span class="n">I_u</span><span class="p">)</span>
    
    <span class="c1"># get the first N row of ranked_candidates to build the top N recommendation list</span>
    <span class="n">topn</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">ranked_candidates</span><span class="p">[:</span><span class="n">N</span><span class="p">],</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;itemid&#39;</span><span class="p">,</span><span class="s1">&#39;similarity_with_Iu&#39;</span><span class="p">])</span>    
    <span class="n">topn</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">topn</span><span class="p">,</span> <span class="n">movies</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;itemid&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">)</span>    
    <span class="k">return</span> <span class="n">topn</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">topn_recommendation</span><span class="p">(</span><span class="n">test_user</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>itemid</th>
      <th>similarity_with_Iu</th>
      <th>title</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1356</td>
      <td>52.867173</td>
      <td>Ed's Next Move (1996)</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1189</td>
      <td>50.362199</td>
      <td>Prefontaine (1997)</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1516</td>
      <td>31.133267</td>
      <td>Wedding Gift, The (1994)</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1550</td>
      <td>31.031738</td>
      <td>Destiny Turns on the Radio (1995)</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1554</td>
      <td>27.364494</td>
      <td>Safe Passage (1994)</td>
    </tr>
    <tr>
      <th>5</th>
      <td>1600</td>
      <td>27.287712</td>
      <td>Guantanamera (1994)</td>
    </tr>
    <tr>
      <th>6</th>
      <td>1223</td>
      <td>26.631850</td>
      <td>King of the Hill (1993)</td>
    </tr>
    <tr>
      <th>7</th>
      <td>1388</td>
      <td>26.624397</td>
      <td>Gabbeh (1996)</td>
    </tr>
    <tr>
      <th>8</th>
      <td>766</td>
      <td>26.590175</td>
      <td>Man of the Year (1995)</td>
    </tr>
    <tr>
      <th>9</th>
      <td>691</td>
      <td>26.461802</td>
      <td>Dark City (1998)</td>
    </tr>
    <tr>
      <th>10</th>
      <td>1378</td>
      <td>25.787842</td>
      <td>Rhyme &amp; Reason (1997)</td>
    </tr>
    <tr>
      <th>11</th>
      <td>1664</td>
      <td>25.327445</td>
      <td>8 Heads in a Duffel Bag (1997)</td>
    </tr>
    <tr>
      <th>12</th>
      <td>1261</td>
      <td>24.785660</td>
      <td>Run of the Country, The (1995)</td>
    </tr>
    <tr>
      <th>13</th>
      <td>1123</td>
      <td>24.524028</td>
      <td>Last Time I Saw Paris, The (1954)</td>
    </tr>
    <tr>
      <th>14</th>
      <td>1538</td>
      <td>24.492453</td>
      <td>All Over Me (1997)</td>
    </tr>
    <tr>
      <th>15</th>
      <td>1485</td>
      <td>24.345312</td>
      <td>Colonel Chabert, Le (1994)</td>
    </tr>
    <tr>
      <th>16</th>
      <td>1450</td>
      <td>24.262120</td>
      <td>Golden Earrings (1947)</td>
    </tr>
    <tr>
      <th>17</th>
      <td>909</td>
      <td>23.357301</td>
      <td>Dangerous Beauty (1998)</td>
    </tr>
    <tr>
      <th>18</th>
      <td>359</td>
      <td>22.973658</td>
      <td>Assignment, The (1997)</td>
    </tr>
    <tr>
      <th>19</th>
      <td>1369</td>
      <td>22.710078</td>
      <td>Forbidden Christ, The (Cristo proibito, Il) (1...</td>
    </tr>
    <tr>
      <th>20</th>
      <td>1506</td>
      <td>22.325504</td>
      <td>Nelly &amp; Monsieur Arnaud (1995)</td>
    </tr>
    <tr>
      <th>21</th>
      <td>1537</td>
      <td>22.061914</td>
      <td>Cosi (1996)</td>
    </tr>
    <tr>
      <th>22</th>
      <td>1474</td>
      <td>21.877034</td>
      <td>Nina Takes a Lover (1994)</td>
    </tr>
    <tr>
      <th>23</th>
      <td>1467</td>
      <td>21.861203</td>
      <td>Saint of Fort Washington, The (1993)</td>
    </tr>
    <tr>
      <th>24</th>
      <td>1255</td>
      <td>21.750924</td>
      <td>Broken English (1996)</td>
    </tr>
    <tr>
      <th>25</th>
      <td>1499</td>
      <td>21.529748</td>
      <td>Grosse Fatigue (1994)</td>
    </tr>
    <tr>
      <th>26</th>
      <td>1466</td>
      <td>21.063269</td>
      <td>Margaret's Museum (1995)</td>
    </tr>
    <tr>
      <th>27</th>
      <td>1448</td>
      <td>20.846909</td>
      <td>My Favorite Season (1993)</td>
    </tr>
    <tr>
      <th>28</th>
      <td>927</td>
      <td>20.730153</td>
      <td>Flower of My Secret, The (Flor de mi secreto, ...</td>
    </tr>
    <tr>
      <th>29</th>
      <td>1375</td>
      <td>20.627152</td>
      <td>Cement Garden, The (1993)</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>This dataframe represents the top N recommendation list a user. These items are sorted in decreasing order of similarities with <span class="math notranslate nohighlight">\(I_u\)</span>.</p>
<p><strong>Observation</strong> : The recommended items are the most similar to the set <span class="math notranslate nohighlight">\(I_u\)</span> of items already purchased by the user.</p>
</div>
<div class="section" id="top-n-recommendation-with-predictions">
<h3>Top N recommendation with predictions<a class="headerlink" href="#top-n-recommendation-with-predictions" title="Permalink to this headline">¶</a></h3>
<p>Before recommending the previous list to the user, we can go further and predict the ratings the user would have given to each of these items, sort them in descending order of prediction and return the reordered list as the new top N recommendation list.</p>
<div class="section" id="rating-prediction">
<h4>Rating prediction<a class="headerlink" href="#rating-prediction" title="Permalink to this headline">¶</a></h4>
<p>As stated earlier, the predicted rating <span class="math notranslate nohighlight">\(\hat{r}_{u,i}\)</span> for a given user <span class="math notranslate nohighlight">\(u\)</span> on an item <span class="math notranslate nohighlight">\(i\)</span> is obtained by aggregating ratings given by <span class="math notranslate nohighlight">\(u\)</span> on items similar to <span class="math notranslate nohighlight">\(i\)</span> as follows:</p>
<p>\begin{equation}
\hat{r}<em>{u,i}=\frac{\sum</em>{j\in S^{(i)}}r_{u,j}\cdot w_{i,j}}{\sum_{j\in S^{(i)}}|w_{i,j}|}
\end{equation}</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="n">userid</span><span class="p">,</span> <span class="n">itemid</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Make rating prediction for user userid on item itemid    </span>
<span class="sd">    :param userid : id of the active user</span>
<span class="sd">    :param itemid : id of the item for which we are making prediction        </span>
<span class="sd">    :return r_hat : predicted rating</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c1"># Get items similar to item itemid with their corresponding similarities</span>
    <span class="n">item_neighbors</span> <span class="o">=</span> <span class="n">neighbors</span><span class="p">[</span><span class="n">itemid</span><span class="p">]</span>
    <span class="n">item_similarities</span> <span class="o">=</span> <span class="n">similarities</span><span class="p">[</span><span class="n">itemid</span><span class="p">]</span>
    
    <span class="c1"># get ratings of user with id userid</span>
    <span class="n">uratings</span> <span class="o">=</span> <span class="n">np_ratings</span><span class="p">[</span><span class="n">np_ratings</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="n">userid</span><span class="p">]</span>
    
    <span class="c1"># similar items rated by item the user of i</span>
    <span class="n">siru</span> <span class="o">=</span> <span class="n">uratings</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">uratings</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">item_neighbors</span><span class="p">)]</span>
    <span class="n">scores</span> <span class="o">=</span> <span class="n">siru</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span>
    <span class="n">indexes</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">item_neighbors</span> <span class="o">==</span> <span class="n">iid</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">iid</span> <span class="ow">in</span> <span class="n">siru</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int&#39;</span><span class="p">)]</span>    
    <span class="n">sims</span> <span class="o">=</span> <span class="n">item_similarities</span><span class="p">[</span><span class="n">indexes</span><span class="p">]</span>
    
    <span class="n">dot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">scores</span><span class="p">,</span> <span class="n">sims</span><span class="p">)</span>
    <span class="n">som</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">sims</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">dot</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">som</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">mean</span><span class="p">[</span><span class="n">userid</span><span class="p">]</span>
    
    <span class="k">return</span> <span class="n">dot</span> <span class="o">/</span> <span class="n">som</span>
</pre></div>
</div>
</div>
</div>
<p>Now let’s use our <code class="docutils literal notranslate"><span class="pre">predict()</span></code> function to predict what ratings the user would have given to the previous top-<span class="math notranslate nohighlight">\(N\)</span> list and return the reorganised list (in decreasing order of predictions) as the new top-<span class="math notranslate nohighlight">\(N\)</span> list</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">topn_prediction</span><span class="p">(</span><span class="n">userid</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :param userid : id of the active user    </span>
<span class="sd">    :return topn : initial topN recommendations returned by the function item2item_topN</span>
<span class="sd">    :return topn_predict : topN recommendations reordered according to rating predictions</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># make top N recommendation for the active user</span>
    <span class="n">topn</span> <span class="o">=</span> <span class="n">topn_recommendation</span><span class="p">(</span><span class="n">userid</span><span class="p">)</span>
    
    <span class="c1"># get list of items of the top N list</span>
    <span class="n">itemids</span> <span class="o">=</span> <span class="n">topn</span><span class="o">.</span><span class="n">itemid</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
    
    <span class="n">predictions</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="c1"># make prediction for each item in the top N list</span>
    <span class="k">for</span> <span class="n">itemid</span> <span class="ow">in</span> <span class="n">itemids</span><span class="p">:</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">predict</span><span class="p">(</span><span class="n">userid</span><span class="p">,</span> <span class="n">itemid</span><span class="p">)</span>
        
        <span class="n">predictions</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">itemid</span><span class="p">,</span><span class="n">r</span><span class="p">))</span>
    
    <span class="n">predictions</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">predictions</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;itemid&#39;</span><span class="p">,</span><span class="s1">&#39;prediction&#39;</span><span class="p">])</span>
    
    <span class="c1"># merge the predictions to topN_list and rearrange the list according to predictions</span>
    <span class="n">topn_predict</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">topn</span><span class="p">,</span> <span class="n">predictions</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;itemid&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">)</span>
    <span class="n">topn_predict</span> <span class="o">=</span> <span class="n">topn_predict</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;prediction&#39;</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">topn</span><span class="p">,</span> <span class="n">topn_predict</span>
</pre></div>
</div>
</div>
</div>
<p>Now, let’s make recommendation for user 1 and compare the two list</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">topn</span><span class="p">,</span> <span class="n">topn_predict</span> <span class="o">=</span> <span class="n">topn_prediction</span><span class="p">(</span><span class="n">userid</span><span class="o">=</span><span class="n">test_user</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">topn_predict</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>itemid</th>
      <th>similarity_with_Iu</th>
      <th>title</th>
      <th>prediction</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>7</th>
      <td>1388</td>
      <td>26.624397</td>
      <td>Gabbeh (1996)</td>
      <td>4.666667</td>
    </tr>
    <tr>
      <th>18</th>
      <td>359</td>
      <td>22.973658</td>
      <td>Assignment, The (1997)</td>
      <td>4.600000</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1554</td>
      <td>27.364494</td>
      <td>Safe Passage (1994)</td>
      <td>4.500000</td>
    </tr>
    <tr>
      <th>14</th>
      <td>1538</td>
      <td>24.492453</td>
      <td>All Over Me (1997)</td>
      <td>4.500000</td>
    </tr>
    <tr>
      <th>27</th>
      <td>1448</td>
      <td>20.846909</td>
      <td>My Favorite Season (1993)</td>
      <td>4.490052</td>
    </tr>
    <tr>
      <th>29</th>
      <td>1375</td>
      <td>20.627152</td>
      <td>Cement Garden, The (1993)</td>
      <td>4.333333</td>
    </tr>
    <tr>
      <th>26</th>
      <td>1466</td>
      <td>21.063269</td>
      <td>Margaret's Museum (1995)</td>
      <td>4.271915</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1516</td>
      <td>31.133267</td>
      <td>Wedding Gift, The (1994)</td>
      <td>4.000000</td>
    </tr>
    <tr>
      <th>23</th>
      <td>1467</td>
      <td>21.861203</td>
      <td>Saint of Fort Washington, The (1993)</td>
      <td>4.000000</td>
    </tr>
    <tr>
      <th>21</th>
      <td>1537</td>
      <td>22.061914</td>
      <td>Cosi (1996)</td>
      <td>4.000000</td>
    </tr>
    <tr>
      <th>10</th>
      <td>1378</td>
      <td>25.787842</td>
      <td>Rhyme &amp; Reason (1997)</td>
      <td>4.000000</td>
    </tr>
    <tr>
      <th>19</th>
      <td>1369</td>
      <td>22.710078</td>
      <td>Forbidden Christ, The (Cristo proibito, Il) (1...</td>
      <td>4.000000</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1550</td>
      <td>31.031738</td>
      <td>Destiny Turns on the Radio (1995)</td>
      <td>3.777778</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1189</td>
      <td>50.362199</td>
      <td>Prefontaine (1997)</td>
      <td>3.666528</td>
    </tr>
    <tr>
      <th>20</th>
      <td>1506</td>
      <td>22.325504</td>
      <td>Nelly &amp; Monsieur Arnaud (1995)</td>
      <td>3.610294</td>
    </tr>
    <tr>
      <th>15</th>
      <td>1485</td>
      <td>24.345312</td>
      <td>Colonel Chabert, Le (1994)</td>
      <td>3.610294</td>
    </tr>
    <tr>
      <th>11</th>
      <td>1664</td>
      <td>25.327445</td>
      <td>8 Heads in a Duffel Bag (1997)</td>
      <td>3.610294</td>
    </tr>
    <tr>
      <th>9</th>
      <td>691</td>
      <td>26.461802</td>
      <td>Dark City (1998)</td>
      <td>3.610294</td>
    </tr>
    <tr>
      <th>6</th>
      <td>1223</td>
      <td>26.631850</td>
      <td>King of the Hill (1993)</td>
      <td>3.610294</td>
    </tr>
    <tr>
      <th>5</th>
      <td>1600</td>
      <td>27.287712</td>
      <td>Guantanamera (1994)</td>
      <td>3.610294</td>
    </tr>
    <tr>
      <th>17</th>
      <td>909</td>
      <td>23.357301</td>
      <td>Dangerous Beauty (1998)</td>
      <td>3.500000</td>
    </tr>
    <tr>
      <th>12</th>
      <td>1261</td>
      <td>24.785660</td>
      <td>Run of the Country, The (1995)</td>
      <td>3.333333</td>
    </tr>
    <tr>
      <th>24</th>
      <td>1255</td>
      <td>21.750924</td>
      <td>Broken English (1996)</td>
      <td>3.265749</td>
    </tr>
    <tr>
      <th>13</th>
      <td>1123</td>
      <td>24.524028</td>
      <td>Last Time I Saw Paris, The (1954)</td>
      <td>3.200000</td>
    </tr>
    <tr>
      <th>16</th>
      <td>1450</td>
      <td>24.262120</td>
      <td>Golden Earrings (1947)</td>
      <td>3.142978</td>
    </tr>
    <tr>
      <th>22</th>
      <td>1474</td>
      <td>21.877034</td>
      <td>Nina Takes a Lover (1994)</td>
      <td>3.000000</td>
    </tr>
    <tr>
      <th>8</th>
      <td>766</td>
      <td>26.590175</td>
      <td>Man of the Year (1995)</td>
      <td>3.000000</td>
    </tr>
    <tr>
      <th>0</th>
      <td>1356</td>
      <td>52.867173</td>
      <td>Ed's Next Move (1996)</td>
      <td>2.280926</td>
    </tr>
    <tr>
      <th>28</th>
      <td>927</td>
      <td>20.730153</td>
      <td>Flower of My Secret, The (Flor de mi secreto, ...</td>
      <td>1.665010</td>
    </tr>
    <tr>
      <th>25</th>
      <td>1499</td>
      <td>21.529748</td>
      <td>Grosse Fatigue (1994)</td>
      <td>1.122032</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>As you will have noticed, the two lists are sorted in different ways. The second list is organized according to the predictions made for the user.</p>
<p><b>Note</b>: When making predictions for user <span class="math notranslate nohighlight">\(u\)</span> on item <span class="math notranslate nohighlight">\(i\)</span>, user <span class="math notranslate nohighlight">\(u\)</span> may not have rated any of the <span class="math notranslate nohighlight">\(k\)</span> most similar items to i. In this case, we consider the mean rating of <span class="math notranslate nohighlight">\(u\)</span> as the predicted value.</p>
</div>
</div>
<div class="section" id="evaluation-with-mean-absolute-error">
<h3>Evaluation with Mean Absolute Error<a class="headerlink" href="#evaluation-with-mean-absolute-error" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">recsys.preprocessing</span> <span class="kn">import</span> <span class="n">train_test_split</span><span class="p">,</span> <span class="n">get_examples</span>

<span class="c1"># get examples as tuples of userids and itemids and labels from normalize ratings</span>
<span class="n">raw_examples</span><span class="p">,</span> <span class="n">raw_labels</span> <span class="o">=</span> <span class="n">get_examples</span><span class="p">(</span><span class="n">ratings</span><span class="p">,</span> <span class="n">labels_column</span><span class="o">=</span><span class="s1">&#39;rating&#39;</span><span class="p">)</span>

<span class="c1"># train test split</span>
<span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">x_test</span><span class="p">),</span> <span class="p">(</span><span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">examples</span><span class="o">=</span><span class="n">raw_examples</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">raw_labels</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span><span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Evaluate the model on </span><span class="si">{}</span><span class="s1"> test data ...&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x_test</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">preds</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">predict</span><span class="p">(</span><span class="n">u</span><span class="p">,</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">u</span><span class="p">,</span><span class="n">i</span><span class="p">)</span> <span class="ow">in</span> <span class="n">x_test</span><span class="p">)</span>
    <span class="n">mae</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">y_test</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">preds</span><span class="p">)))</span> <span class="o">/</span> <span class="n">x_test</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">MAE :&#39;</span><span class="p">,</span> <span class="n">mae</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">mae</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">evaluate</span><span class="p">(</span><span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evaluate the model on 10000 test data ...

MAE : 0.672389703640273
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.672389703640273
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="id4">
<h3>Summary<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h3>
<p>As with the User-based CF, we have also summarised the Item-based CF into the python class <a class="reference external" href="https://github.com/nzhinusoftcm/review-on-collaborative-filtering/blob/master/recsys/memories/ItemToItem.py">ItemToItem</a>.</p>
<div class="section" id="itemtoitem-usage">
<h4>ItemToItem : usage<a class="headerlink" href="#itemtoitem-usage" title="Permalink to this headline">¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">recsys.memories.ItemToItem</span> <span class="kn">import</span> <span class="n">ItemToItem</span>
<span class="kn">from</span> <span class="nn">recsys.preprocessing</span> <span class="kn">import</span> <span class="n">ids_encoder</span><span class="p">,</span> <span class="n">train_test_split</span><span class="p">,</span> <span class="n">get_examples</span>
<span class="kn">from</span> <span class="nn">recsys.datasets</span> <span class="kn">import</span> <span class="n">ml100k</span>

<span class="c1"># load data</span>
<span class="n">ratings</span><span class="p">,</span> <span class="n">movies</span> <span class="o">=</span> <span class="n">ml100k</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>

<span class="c1"># prepare data</span>
<span class="n">ratings</span><span class="p">,</span> <span class="n">uencoder</span><span class="p">,</span> <span class="n">iencoder</span> <span class="o">=</span> <span class="n">ids_encoder</span><span class="p">(</span><span class="n">ratings</span><span class="p">)</span>

<span class="c1"># get examples as tuples of userids and itemids and labels from normalize ratings</span>
<span class="n">raw_examples</span><span class="p">,</span> <span class="n">raw_labels</span> <span class="o">=</span> <span class="n">get_examples</span><span class="p">(</span><span class="n">ratings</span><span class="p">,</span> <span class="n">labels_column</span><span class="o">=</span><span class="s1">&#39;rating&#39;</span><span class="p">)</span>

<span class="c1"># train test split</span>
<span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">x_test</span><span class="p">),</span> <span class="p">(</span><span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">examples</span><span class="o">=</span><span class="n">raw_examples</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">raw_labels</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="instanciate-the-itemtoitem-cf">
<h4>Instanciate the ItemToItem CF<a class="headerlink" href="#instanciate-the-itemtoitem-cf" title="Permalink to this headline">¶</a></h4>
<p>Parameters :</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">k</span></code> : number of neighbors to consider for each item</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">metric</span></code> : metric to use when computing similarities : let’s use <strong>cosine</strong></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">dataset_name</span></code> : in this example, we use the ml100k dataset</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># create the Item-based CF</span>
<span class="n">item2item</span> <span class="o">=</span> <span class="n">ItemToItem</span><span class="p">(</span><span class="n">ratings</span><span class="p">,</span> <span class="n">movies</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="s1">&#39;cosine&#39;</span><span class="p">,</span> <span class="n">dataset_name</span><span class="o">=</span><span class="s1">&#39;ml100k&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Normalize ratings ...
Create the similarity model ...
Compute nearest neighbors ...
Item to item recommendation model created with success ...
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># evaluate the algorithm on test dataset</span>
<span class="n">item2item</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evaluate the model on 10000 test data ...

MAE : 0.507794195659005
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.507794195659005
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="evaluate-the-item-based-cf-on-the-ml-1m-dataset">
<h4>Evaluate the Item-based CF on the ML-1M dataset<a class="headerlink" href="#evaluate-the-item-based-cf-on-the-ml-1m-dataset" title="Permalink to this headline">¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">recsys.memories.ItemToItem</span> <span class="kn">import</span> <span class="n">ItemToItem</span>
<span class="kn">from</span> <span class="nn">recsys.preprocessing</span> <span class="kn">import</span> <span class="n">ids_encoder</span><span class="p">,</span> <span class="n">train_test_split</span><span class="p">,</span> <span class="n">get_examples</span>
<span class="kn">from</span> <span class="nn">recsys.datasets</span> <span class="kn">import</span> <span class="n">ml1m</span>

<span class="c1"># load data</span>
<span class="n">ratings</span><span class="p">,</span> <span class="n">movies</span> <span class="o">=</span> <span class="n">ml1m</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>

<span class="c1"># prepare data</span>
<span class="n">ratings</span><span class="p">,</span> <span class="n">uencoder</span><span class="p">,</span> <span class="n">iencoder</span> <span class="o">=</span> <span class="n">ids_encoder</span><span class="p">(</span><span class="n">ratings</span><span class="p">)</span>

<span class="c1"># get examples as tuples of userids and itemids and labels from normalize ratings</span>
<span class="n">raw_examples</span><span class="p">,</span> <span class="n">raw_labels</span> <span class="o">=</span> <span class="n">get_examples</span><span class="p">(</span><span class="n">ratings</span><span class="p">,</span> <span class="n">labels_column</span><span class="o">=</span><span class="s1">&#39;rating&#39;</span><span class="p">)</span>

<span class="c1"># train test split</span>
<span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">x_test</span><span class="p">),</span> <span class="p">(</span><span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">examples</span><span class="o">=</span><span class="n">raw_examples</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">raw_labels</span><span class="p">)</span>

<span class="c1"># create the Item-based CF</span>
<span class="n">item2item</span> <span class="o">=</span> <span class="n">ItemToItem</span><span class="p">(</span><span class="n">ratings</span><span class="p">,</span> <span class="n">movies</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="s1">&#39;cosine&#39;</span><span class="p">,</span> <span class="n">dataset_name</span><span class="o">=</span><span class="s1">&#39;ml1m&#39;</span><span class="p">)</span>

<span class="c1"># evaluate the algorithm on test dataset</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=========================&quot;</span><span class="p">)</span>
<span class="n">item2item</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Normalize ratings ...
Create the similarity model ...
Compute nearest neighbors ...
Item to item recommendation model created with success ...
=========================
Evaluate the model on 100021 test data ...

MAE : 0.42514728655396045
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.42514728655396045
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="model-based-cf">
<h3>Model based CF<a class="headerlink" href="#model-based-cf" title="Permalink to this headline">¶</a></h3>
<p><strong>User-based</strong> and <strong>Item-based CF</strong> are memory based algorithms. They directly act on the user-item interactions to compute recommendation. To the contrary, model-based algorithms are mathematical models trained on the user-item interactions and used to predict recommendation.</p>
<p>We will start with the SVD (Singular Value Decomposition) algorithm.</p>
</div>
</div>
<div class="section" id="part-4-svd-method">
<h2>Part 4 - SVD method<a class="headerlink" href="#part-4-svd-method" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><p>Collaborative Filtering on MovieLens Latest-small Part 4 - Finding recommendations using model based singular value decomposition (SVD) method.</p>
</div></blockquote>
<p>Due to the high level sparsity of the rating matrix <span class="math notranslate nohighlight">\(R\)</span>, <strong>user-based</strong> and <strong>item-based</strong> collaborative filtering suffer from <strong>data sparsity</strong> and <strong>scalability</strong>. These cause user and item-based collaborative filtering to be less effective and highly affect their performences.</p>
<p>To address the high level sparsity problem, <a class="reference external" href="http://files.grouplens.org/papers/webKDD00.pdf">Sarwar et al. (2000)</a> proposed to reduce the dimensionality of the rating <span class="math notranslate nohighlight">\(R\)</span> using the <em>Singular Value Decomposition (SVD)</em> algorithm.</p>
<hr class="docutils" />
<div class="section" id="how-do-svd-works">
<h3>How do SVD works ?<a class="headerlink" href="#how-do-svd-works" title="Permalink to this headline">¶</a></h3>
<p>As described is Figure 1, SVD factors the rating matrix <span class="math notranslate nohighlight">\(R\)</span> of size <span class="math notranslate nohighlight">\(m\times n\)</span> into three matrices <span class="math notranslate nohighlight">\(P\)</span>, <span class="math notranslate nohighlight">\(\Sigma\)</span> and <span class="math notranslate nohighlight">\(Q\)</span> as follows :</p>
<p>\begin{equation}
R = P\Sigma Q^{\top}.
\end{equation}</p>
<p>Here, <span class="math notranslate nohighlight">\(P\)</span> and <span class="math notranslate nohighlight">\(Q\)</span> are two orthogonal matrices of size <span class="math notranslate nohighlight">\(m\times \hat{k}\)</span> and <span class="math notranslate nohighlight">\(n\times \hat{k}\)</span> respectively and <span class="math notranslate nohighlight">\(\Sigma\)</span> is a diagonal matrix of size <span class="math notranslate nohighlight">\( \hat{k}\times \hat{k}\)</span> (with <span class="math notranslate nohighlight">\( \hat{k}\)</span> the rank of matrix <span class="math notranslate nohighlight">\(R\)</span>) having all singular values of the rating matrix R as its diagonal entries (<a class="reference external" href="https://www.ics.uci.edu/~pazzani/Publications/MLC98.pdf">Billsus and Pazzani, 1998</a>, <a class="reference external" href="http://files.grouplens.org/papers/webKDD00.pdf">Sarwar et al. (2000)</a>).</p>
<p><img alt="" src="https://github.com/nzhinusoftcm/review-on-collaborative-filtering/blob/master/recsys/img/svd.png?raw=1" /></p>
<center> <b>Figure 1</b> : Singular value decomposition of rating matrix $R$ </center>
<p>After having choosen <span class="math notranslate nohighlight">\(k\)</span>, the dimension of factors that will represent users and items, we can truncate matrix <span class="math notranslate nohighlight">\(\Sigma\)</span> by only retaining its <span class="math notranslate nohighlight">\(k\)</span> largest singular values to yield <span class="math notranslate nohighlight">\(\Sigma_k\)</span> and reduce matrices <span class="math notranslate nohighlight">\(P\)</span> and <span class="math notranslate nohighlight">\(Q\)</span> accordingly to obtain <span class="math notranslate nohighlight">\(P_k\)</span> and <span class="math notranslate nohighlight">\(Q_k\)</span>. The rating matrix will then be estimated as</p>
<p>\begin{equation}
R_k = P_k\Sigma_k Q_k^{\top}.
\end{equation}</p>
<p>Once these matrices are known, they can be used for rating predictions ant top-N recommendations. <span class="math notranslate nohighlight">\(P_k\Sigma_k^{\frac{1}{2}}\)</span> represents the latent space of users and <span class="math notranslate nohighlight">\(\Sigma_k^{\frac{1}{2}}Q_k^{\top}\)</span> the latent space of items. Rating prediction for user <span class="math notranslate nohighlight">\(u\)</span> on <span class="math notranslate nohighlight">\(i\)</span> is done by the following formular</p>
<p>\begin{equation}
\hat{R}_{u,i} = \begin{bmatrix}P_k\Sigma_k^{\frac{1}{2}}\end{bmatrix}_u \begin{bmatrix}\Sigma_k^{\frac{1}{2}}Q_k^{\top}\end{bmatrix}_i.
\end{equation}</p>
<p>Before applying SVD, its important to fill in missing values of the rating matrix <span class="math notranslate nohighlight">\(R\)</span>. <a class="reference external" href="http://files.grouplens.org/papers/webKDD00.pdf">Sarwar et al. (2000)</a> found the item’s mean rating to be useful default values. The user’s average rating can also be used but the former shown better performances. Adding ratings normalization by subtracting the user mean rating or other baseline predictor can improve accuracy.</p>
</div>
<hr class="docutils" />
<div class="section" id="svd-algorithm">
<h3>SVD algorithm<a class="headerlink" href="#svd-algorithm" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><ol class="simple">
<li><p>Factor the normalize rating matrix <span class="math notranslate nohighlight">\(R_{norm}\)</span> to obtain matrices <span class="math notranslate nohighlight">\(P\)</span>, <span class="math notranslate nohighlight">\(\Sigma\)</span> and <span class="math notranslate nohighlight">\(Q\)</span></p></li>
<li><p>Reduce <span class="math notranslate nohighlight">\(\Sigma\)</span> to dimension <span class="math notranslate nohighlight">\(k\)</span> to obtain <span class="math notranslate nohighlight">\(\Sigma_k\)</span></p></li>
<li><p>Compute the square-root of <span class="math notranslate nohighlight">\(\Sigma_k\)</span> to obtain <span class="math notranslate nohighlight">\(\Sigma_k^{\frac{1}{2}}\)</span></p></li>
<li><p>Compute the resultant matrices <span class="math notranslate nohighlight">\(P_k\Sigma_k^{\frac{1}{2}}\)</span> and <span class="math notranslate nohighlight">\(\Sigma_k^{\frac{1}{2}}Q_k^{\top}\)</span> that will be used to compute recommendation scores for any user and items.</p></li>
</ol>
</div></blockquote>
</div>
<hr class="docutils" />
<div class="section" id="implementation-details">
<h3>Implementation details<a class="headerlink" href="#implementation-details" title="Permalink to this headline">¶</a></h3>
<p>SVD can easily be implemented using python library such as <code class="docutils literal notranslate"><span class="pre">numpy</span></code>, <code class="docutils literal notranslate"><span class="pre">scipy</span></code> or <code class="docutils literal notranslate"><span class="pre">sklearn</span></code>. As described by Andrew Ng in his <a class="reference external" href="https://www.coursera.org/learn/machine-learning/lecture/CEXN0/vectorization-low-rank-matrix-factorization">Machine Learning course</a>, it’s not recommended to implement the standard SVD by ourselves. Instead, we can take advantage of matrix libraries (such as those listed before) that are optimized for matrix computations and vectorization.</p>
<p>Now let’s implement the SVD collaborative filtering</p>
</div>
<div class="section" id="download-useful-tools">
<h3>Download useful tools<a class="headerlink" href="#download-useful-tools" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>import os

if not (os.path.exists(&quot;recsys.zip&quot;) or os.path.exists(&quot;recsys&quot;)):
    !wget https://github.com/nzhinusoftcm/review-on-collaborative-filtering/raw/master/recsys.zip    
    !unzip recsys.zip
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="id5">
<h3>Import requirements<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">matplotlib</span><span class="o">==</span><span class="mf">3.2</span><span class="o">.</span><span class="mi">2</span>
<span class="n">numpy</span><span class="o">==</span><span class="mf">1.19</span><span class="o">.</span><span class="mi">2</span>
<span class="n">pandas</span><span class="o">==</span><span class="mf">1.0</span><span class="o">.</span><span class="mi">5</span>
<span class="n">python</span><span class="o">==</span><span class="mf">3.7</span>
<span class="n">scikit</span><span class="o">-</span><span class="n">learn</span><span class="o">==</span><span class="mf">0.24</span><span class="o">.</span><span class="mi">1</span>
<span class="n">scikit</span><span class="o">-</span><span class="n">surprise</span><span class="o">==</span><span class="mf">1.1</span><span class="o">.</span><span class="mi">1</span>
<span class="n">scipy</span><span class="o">==</span><span class="mf">1.6</span><span class="o">.</span><span class="mi">2</span>
</pre></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">recsys.datasets</span> <span class="kn">import</span> <span class="n">mlLastedSmall</span><span class="p">,</span> <span class="n">ml100k</span><span class="p">,</span> <span class="n">ml1m</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">LabelEncoder</span>
<span class="kn">from</span> <span class="nn">scipy.sparse</span> <span class="kn">import</span> <span class="n">csr_matrix</span>

<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">os</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="loading-movielen-ratings">
<h3>Loading movielen ratings<a class="headerlink" href="#loading-movielen-ratings" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ratings</span><span class="p">,</span> <span class="n">movies</span> <span class="o">=</span> <span class="n">mlLastedSmall</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s see how our rating matrix looks like</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pd</span><span class="o">.</span><span class="n">crosstab</span><span class="p">(</span><span class="n">ratings</span><span class="o">.</span><span class="n">userid</span><span class="p">,</span> <span class="n">ratings</span><span class="o">.</span><span class="n">itemid</span><span class="p">,</span> <span class="n">ratings</span><span class="o">.</span><span class="n">rating</span><span class="p">,</span> <span class="n">aggfunc</span><span class="o">=</span><span class="nb">sum</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>itemid</th>
      <th>1</th>
      <th>2</th>
      <th>3</th>
      <th>4</th>
      <th>5</th>
      <th>6</th>
      <th>7</th>
      <th>8</th>
      <th>9</th>
      <th>10</th>
      <th>...</th>
      <th>193565</th>
      <th>193567</th>
      <th>193571</th>
      <th>193573</th>
      <th>193579</th>
      <th>193581</th>
      <th>193583</th>
      <th>193585</th>
      <th>193587</th>
      <th>193609</th>
    </tr>
    <tr>
      <th>userid</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <td>4.0</td>
      <td>NaN</td>
      <td>4.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>4.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>3</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>4</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>5</th>
      <td>4.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>606</th>
      <td>2.5</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>2.5</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>607</th>
      <td>4.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>608</th>
      <td>2.5</td>
      <td>2.0</td>
      <td>2.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>4.0</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>609</th>
      <td>3.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>4.0</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>610</th>
      <td>5.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>5.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
<p>610 rows × 9724 columns</p>
</div></div></div>
</div>
<p>We can observe that our rating matrix has many of unobserved value. However, as we described earlier, the SVD algorithm requires that all inputs in the matrix must be defined. Let’s initialize the unobserved ratings with item’s average that led to better performances compared to the user’s average or even a null initialization (<a class="reference external" href="http://files.grouplens.org/papers/webKDD00.pdf">Sarwar et al. (2000)</a>).</p>
<p>We can go further and subtrat from each rating the corresponding user mean to normalize the data. This helps to improve the accuracy of the model.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># get user&#39;s mean rating</span>
<span class="n">umean</span> <span class="o">=</span> <span class="n">ratings</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;userid&#39;</span><span class="p">)[</span><span class="s1">&#39;rating&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">rating_matrix</span><span class="p">(</span><span class="n">ratings</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    1. Fill NaN values with item&#39;s average ratings</span>
<span class="sd">    2. Normalize ratings by subtracting user&#39;s mean ratings</span>
<span class="sd">    </span>
<span class="sd">    :param ratings : DataFrame of ratings data</span>
<span class="sd">    :return</span>
<span class="sd">        - R : Numpy array of normalized ratings</span>
<span class="sd">        - df : DataFrame of normalized ratings</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c1"># fill missing values with item&#39;s average ratings</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">crosstab</span><span class="p">(</span><span class="n">ratings</span><span class="o">.</span><span class="n">userid</span><span class="p">,</span> <span class="n">ratings</span><span class="o">.</span><span class="n">itemid</span><span class="p">,</span> <span class="n">ratings</span><span class="o">.</span><span class="n">rating</span><span class="p">,</span> <span class="n">aggfunc</span><span class="o">=</span><span class="nb">sum</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
    
    <span class="c1"># subtract user&#39;s mean ratings to normalize data</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">umean</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    
    <span class="c1"># convert our dataframe to numpy array</span>
    <span class="n">R</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
    
    <span class="k">return</span> <span class="n">R</span><span class="p">,</span> <span class="n">df</span>

<span class="c1"># generate rating matrix by calling function rating_matrix</span>
<span class="n">R</span><span class="p">,</span> <span class="n">df</span> <span class="o">=</span> <span class="n">rating_matrix</span><span class="p">(</span><span class="n">ratings</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><span class="math notranslate nohighlight">\(R\)</span> is our final rating matrix. This is how the final rating matrix looks like</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>itemid</th>
      <th>1</th>
      <th>2</th>
      <th>3</th>
      <th>4</th>
      <th>5</th>
      <th>6</th>
      <th>7</th>
      <th>8</th>
      <th>9</th>
      <th>10</th>
      <th>...</th>
      <th>193565</th>
      <th>193567</th>
      <th>193571</th>
      <th>193573</th>
      <th>193579</th>
      <th>193581</th>
      <th>193583</th>
      <th>193585</th>
      <th>193587</th>
      <th>193609</th>
    </tr>
    <tr>
      <th>userid</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <td>-0.366379</td>
      <td>-0.934561</td>
      <td>-0.366379</td>
      <td>-2.009236</td>
      <td>-1.294951</td>
      <td>-0.366379</td>
      <td>-1.181194</td>
      <td>-1.491379</td>
      <td>-1.241379</td>
      <td>-0.870167</td>
      <td>...</td>
      <td>-0.866379</td>
      <td>-1.366379</td>
      <td>-0.366379</td>
      <td>-0.366379</td>
      <td>-0.866379</td>
      <td>-0.366379</td>
      <td>-0.866379</td>
      <td>-0.866379</td>
      <td>-0.866379</td>
      <td>-0.366379</td>
    </tr>
    <tr>
      <th>2</th>
      <td>-0.027346</td>
      <td>-0.516458</td>
      <td>-0.688660</td>
      <td>-1.591133</td>
      <td>-0.876847</td>
      <td>-0.002197</td>
      <td>-0.763091</td>
      <td>-1.073276</td>
      <td>-0.823276</td>
      <td>-0.452064</td>
      <td>...</td>
      <td>-0.448276</td>
      <td>-0.948276</td>
      <td>0.051724</td>
      <td>0.051724</td>
      <td>-0.448276</td>
      <td>0.051724</td>
      <td>-0.448276</td>
      <td>-0.448276</td>
      <td>-0.448276</td>
      <td>0.051724</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1.485033</td>
      <td>0.995921</td>
      <td>0.823718</td>
      <td>-0.078755</td>
      <td>0.635531</td>
      <td>1.510181</td>
      <td>0.749288</td>
      <td>0.439103</td>
      <td>0.689103</td>
      <td>1.060315</td>
      <td>...</td>
      <td>1.064103</td>
      <td>0.564103</td>
      <td>1.564103</td>
      <td>1.564103</td>
      <td>1.064103</td>
      <td>1.564103</td>
      <td>1.064103</td>
      <td>1.064103</td>
      <td>1.064103</td>
      <td>1.564103</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0.365375</td>
      <td>-0.123737</td>
      <td>-0.295940</td>
      <td>-1.198413</td>
      <td>-0.484127</td>
      <td>0.390523</td>
      <td>-0.370370</td>
      <td>-0.680556</td>
      <td>-0.430556</td>
      <td>-0.059343</td>
      <td>...</td>
      <td>-0.055556</td>
      <td>-0.555556</td>
      <td>0.444444</td>
      <td>0.444444</td>
      <td>-0.055556</td>
      <td>0.444444</td>
      <td>-0.055556</td>
      <td>-0.055556</td>
      <td>-0.055556</td>
      <td>0.444444</td>
    </tr>
    <tr>
      <th>5</th>
      <td>0.363636</td>
      <td>-0.204545</td>
      <td>-0.376748</td>
      <td>-1.279221</td>
      <td>-0.564935</td>
      <td>0.309715</td>
      <td>-0.451178</td>
      <td>-0.761364</td>
      <td>-0.511364</td>
      <td>-0.140152</td>
      <td>...</td>
      <td>-0.136364</td>
      <td>-0.636364</td>
      <td>0.363636</td>
      <td>0.363636</td>
      <td>-0.136364</td>
      <td>0.363636</td>
      <td>-0.136364</td>
      <td>-0.136364</td>
      <td>-0.136364</td>
      <td>0.363636</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>606</th>
      <td>-1.157399</td>
      <td>-0.225581</td>
      <td>-0.397784</td>
      <td>-1.300256</td>
      <td>-0.585971</td>
      <td>0.288679</td>
      <td>-1.157399</td>
      <td>-0.782399</td>
      <td>-0.532399</td>
      <td>-0.161187</td>
      <td>...</td>
      <td>-0.157399</td>
      <td>-0.657399</td>
      <td>0.342601</td>
      <td>0.342601</td>
      <td>-0.157399</td>
      <td>0.342601</td>
      <td>-0.157399</td>
      <td>-0.157399</td>
      <td>-0.157399</td>
      <td>0.342601</td>
    </tr>
    <tr>
      <th>607</th>
      <td>0.213904</td>
      <td>-0.354278</td>
      <td>-0.526481</td>
      <td>-1.428953</td>
      <td>-0.714668</td>
      <td>0.159982</td>
      <td>-0.600911</td>
      <td>-0.911096</td>
      <td>-0.661096</td>
      <td>-0.289884</td>
      <td>...</td>
      <td>-0.286096</td>
      <td>-0.786096</td>
      <td>0.213904</td>
      <td>0.213904</td>
      <td>-0.286096</td>
      <td>0.213904</td>
      <td>-0.286096</td>
      <td>-0.286096</td>
      <td>-0.286096</td>
      <td>0.213904</td>
    </tr>
    <tr>
      <th>608</th>
      <td>-0.634176</td>
      <td>-1.134176</td>
      <td>-1.134176</td>
      <td>-0.777033</td>
      <td>-0.062747</td>
      <td>0.811903</td>
      <td>0.051009</td>
      <td>-0.259176</td>
      <td>-0.009176</td>
      <td>0.865824</td>
      <td>...</td>
      <td>0.365824</td>
      <td>-0.134176</td>
      <td>0.865824</td>
      <td>0.865824</td>
      <td>0.365824</td>
      <td>0.865824</td>
      <td>0.365824</td>
      <td>0.365824</td>
      <td>0.365824</td>
      <td>0.865824</td>
    </tr>
    <tr>
      <th>609</th>
      <td>-0.270270</td>
      <td>0.161548</td>
      <td>-0.010655</td>
      <td>-0.913127</td>
      <td>-0.198842</td>
      <td>0.675808</td>
      <td>-0.085085</td>
      <td>-0.395270</td>
      <td>-0.145270</td>
      <td>0.729730</td>
      <td>...</td>
      <td>0.229730</td>
      <td>-0.270270</td>
      <td>0.729730</td>
      <td>0.729730</td>
      <td>0.229730</td>
      <td>0.729730</td>
      <td>0.229730</td>
      <td>0.229730</td>
      <td>0.229730</td>
      <td>0.729730</td>
    </tr>
    <tr>
      <th>610</th>
      <td>1.311444</td>
      <td>-0.256738</td>
      <td>-0.428941</td>
      <td>-1.331413</td>
      <td>-0.617127</td>
      <td>1.311444</td>
      <td>-0.503371</td>
      <td>-0.813556</td>
      <td>-0.563556</td>
      <td>-0.192344</td>
      <td>...</td>
      <td>-0.188556</td>
      <td>-0.688556</td>
      <td>0.311444</td>
      <td>0.311444</td>
      <td>-0.188556</td>
      <td>0.311444</td>
      <td>-0.188556</td>
      <td>-0.188556</td>
      <td>-0.188556</td>
      <td>0.311444</td>
    </tr>
  </tbody>
</table>
<p>610 rows × 9724 columns</p>
</div></div></div>
</div>
</div>
<div class="section" id="ids-encoding">
<h3>Ids encoding<a class="headerlink" href="#ids-encoding" title="Permalink to this headline">¶</a></h3>
<p>Let’s encode users and items ids such that their values range from 0 to 909 (for users) and from 0 to 9723 (for items)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">users</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">ratings</span><span class="p">[</span><span class="s1">&#39;userid&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
<span class="n">items</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">ratings</span><span class="p">[</span><span class="s1">&#39;itemid&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>

<span class="c1"># create our id encoders</span>
<span class="n">uencoder</span> <span class="o">=</span> <span class="n">LabelEncoder</span><span class="p">()</span>
<span class="n">iencoder</span> <span class="o">=</span> <span class="n">LabelEncoder</span><span class="p">()</span>

<span class="c1"># fit our label encoder</span>
<span class="n">uencoder</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">users</span><span class="p">)</span>
<span class="n">iencoder</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">items</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>LabelEncoder()
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="id6">
<h3>SVD Algorithm<a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h3>
<p>Now that our rating data has been normalize and that missing values has been filled, we can apply the SVD algorithm. Several libraries may be useful such as <code class="docutils literal notranslate"><span class="pre">numpy</span></code>, <code class="docutils literal notranslate"><span class="pre">scipy</span></code>, <code class="docutils literal notranslate"><span class="pre">sklearn</span></code>, … Let’s try it with <code class="docutils literal notranslate"><span class="pre">numpy</span></code>.</p>
<p>In our SVD class we provide the following function :</p>
<ol class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">fit()</span></code> : compute the svd of the rating matrix and save the resultant matrices P, S and Qh (Q transpose) as attributs of the SVD class.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">predict()</span></code>: use matrices P, S and Qh to make ratin prediction for a given <span class="math notranslate nohighlight">\(u\)</span> user on an item <span class="math notranslate nohighlight">\(i\)</span>. Computations are made over encoded values of userid and itemid. The predicted value is the dot product between <span class="math notranslate nohighlight">\(u^{th}\)</span> row of <span class="math notranslate nohighlight">\(P.\sqrt{S}\)</span> and the <span class="math notranslate nohighlight">\(i^{th}\)</span> column of <span class="math notranslate nohighlight">\(\sqrt{S}.Qh\)</span>. <strong>Note</strong> that since we normalized rating before applying SVD, the predicted value will also be normalize. So, to get the final predicted rating, we have to add to the predicted value the mean rating of user <span class="math notranslate nohighlight">\(u\)</span>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">recommend()</span></code>: use matrices P, S and Qh to make recommendations to a given user. The recommended items are those that where not rated by the user and received a high score according to the svd model.</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SVD</span><span class="p">:</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">umeam</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param</span>
<span class="sd">            - umean : mean ratings of users</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">umean</span> <span class="o">=</span> <span class="n">umean</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        
        <span class="c1"># init svd resultant matrices</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">P</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">S</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Qh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        
        <span class="c1"># init users and items latent factors</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">u_factors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">i_factors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
    
    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">R</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fit the SVD model with rating matrix R</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">P</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">Qh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">full_matrices</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">P</span> <span class="o">=</span> <span class="n">P</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">S</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Qh</span> <span class="o">=</span> <span class="n">Qh</span>
        
        <span class="c1"># latent factors of users (u_factors) and items (i_factors)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">u_factors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">P</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">S</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">i_factors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">S</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">Qh</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">userid</span><span class="p">,</span> <span class="n">itemid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Make rating prediction for a given user on an item</span>
<span class="sd">        </span>
<span class="sd">        :param</span>
<span class="sd">            - userid : user&#39;s id</span>
<span class="sd">            - itemid : item&#39;s id</span>
<span class="sd">            </span>
<span class="sd">        :return</span>
<span class="sd">            - r_hat : predicted rating</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># encode user and item ids</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">uencoder</span><span class="o">.</span><span class="n">transform</span><span class="p">([</span><span class="n">userid</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">iencoder</span><span class="o">.</span><span class="n">transform</span><span class="p">([</span><span class="n">itemid</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
        
        <span class="c1"># the predicted rating is the dot product between the uth row </span>
        <span class="c1"># of u_factors and the ith column of i_factors</span>
        <span class="n">r_hat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">u_factors</span><span class="p">[</span><span class="n">u</span><span class="p">,:],</span> <span class="bp">self</span><span class="o">.</span><span class="n">i_factors</span><span class="p">[:,</span><span class="n">i</span><span class="p">])</span>
        
        <span class="c1"># add the mean rating of user u to the predicted value</span>
        <span class="n">r_hat</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">umean</span><span class="p">[</span><span class="n">u</span><span class="p">]</span>
        
        <span class="k">return</span> <span class="n">r_hat</span>
        
    
    <span class="k">def</span> <span class="nf">recommend</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">userid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param</span>
<span class="sd">            - userid : user&#39;s id</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># encode user</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">uencoder</span><span class="o">.</span><span class="n">transform</span><span class="p">([</span><span class="n">userid</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
        
        <span class="c1"># the dot product between the uth row of u_factors and i_factors returns</span>
        <span class="c1"># the predicted value for user u on all items        </span>
        <span class="n">predictions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">u_factors</span><span class="p">[</span><span class="n">u</span><span class="p">,:],</span> <span class="bp">self</span><span class="o">.</span><span class="n">i_factors</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">umean</span><span class="p">[</span><span class="n">u</span><span class="p">]</span>
        
        <span class="c1"># sort item ids in decreasing order of predictions</span>
        <span class="n">top_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">predictions</span><span class="p">))</span>

        <span class="c1"># decode indices to get their corresponding itemids</span>
        <span class="n">top_items</span> <span class="o">=</span> <span class="n">iencoder</span><span class="o">.</span><span class="n">inverse_transform</span><span class="p">(</span><span class="n">top_idx</span><span class="p">)</span>
        
        <span class="c1"># sorted predictions</span>
        <span class="n">preds</span> <span class="o">=</span> <span class="n">predictions</span><span class="p">[</span><span class="n">top_idx</span><span class="p">]</span>
        
        <span class="k">return</span> <span class="n">top_items</span><span class="p">,</span> <span class="n">preds</span>
        
</pre></div>
</div>
</div>
</div>
<p>Now let’s create our SVD model and provide to it user’s mean rating; Fit the model with the normalized rating matrix <span class="math notranslate nohighlight">\(R\)</span>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># create our svd model</span>
<span class="n">svd</span> <span class="o">=</span> <span class="n">SVD</span><span class="p">(</span><span class="n">umean</span><span class="p">)</span>

<span class="c1"># fit our model with normalized ratings</span>
<span class="n">svd</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">R</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="id7">
<h3>Rating prediction<a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h3>
<p>Our model has been fitted.
OK …</p>
<p>Let’s make some predictions for users using function <code class="docutils literal notranslate"><span class="pre">predict</span></code> of our SVD class. Here are some truth ratings</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ratings</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>userid</th>
      <th>itemid</th>
      <th>rating</th>
      <th>timestamp</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>1</td>
      <td>4.0</td>
      <td>964982703</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>3</td>
      <td>4.0</td>
      <td>964981247</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1</td>
      <td>6</td>
      <td>4.0</td>
      <td>964982224</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1</td>
      <td>47</td>
      <td>5.0</td>
      <td>964983815</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1</td>
      <td>50</td>
      <td>5.0</td>
      <td>964982931</td>
    </tr>
    <tr>
      <th>5</th>
      <td>1</td>
      <td>70</td>
      <td>3.0</td>
      <td>964982400</td>
    </tr>
    <tr>
      <th>6</th>
      <td>1</td>
      <td>101</td>
      <td>5.0</td>
      <td>964980868</td>
    </tr>
    <tr>
      <th>7</th>
      <td>1</td>
      <td>110</td>
      <td>4.0</td>
      <td>964982176</td>
    </tr>
    <tr>
      <th>8</th>
      <td>1</td>
      <td>151</td>
      <td>5.0</td>
      <td>964984041</td>
    </tr>
    <tr>
      <th>9</th>
      <td>1</td>
      <td>157</td>
      <td>5.0</td>
      <td>964984100</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Let’s apply our model to make see if our predictions make sens. We will make predictions for user 1 on the 10 items listed above.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># user for which we make predictions</span>
<span class="n">userid</span> <span class="o">=</span> <span class="mi">1</span>

<span class="c1"># list of items for which we are making predictions for user 1</span>
<span class="n">items</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">47</span><span class="p">,</span><span class="mi">50</span><span class="p">,</span><span class="mi">70</span><span class="p">,</span><span class="mi">101</span><span class="p">,</span><span class="mi">110</span><span class="p">,</span><span class="mi">151</span><span class="p">,</span><span class="mi">157</span><span class="p">]</span>

<span class="c1"># predictions</span>
<span class="k">for</span> <span class="n">itemid</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">svd</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">userid</span><span class="o">=</span><span class="n">userid</span><span class="p">,</span> <span class="n">itemid</span><span class="o">=</span><span class="n">itemid</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;prediction for userid=</span><span class="si">{}</span><span class="s1"> and itemid=</span><span class="si">{}</span><span class="s1"> : </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">userid</span><span class="p">,</span> <span class="n">itemid</span><span class="p">,</span> <span class="n">r</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>prediction for userid=1 and itemid=1 : 4.000000000000007
prediction for userid=1 and itemid=3 : 4.0000000000000036
prediction for userid=1 and itemid=6 : 3.9999999999999885
prediction for userid=1 and itemid=47 : 5.000000000000003
prediction for userid=1 and itemid=50 : 4.9999999999999964
prediction for userid=1 and itemid=70 : 2.9999999999999893
prediction for userid=1 and itemid=101 : 5.000000000000002
prediction for userid=1 and itemid=110 : 3.999999999999993
prediction for userid=1 and itemid=151 : 5.000000000000007
prediction for userid=1 and itemid=157 : 5.000000000000019
</pre></div>
</div>
</div>
</div>
<p>Our prediction error is less than 0.00001</p>
</div>
<div class="section" id="make-recommendations">
<h3>Make recommendations<a class="headerlink" href="#make-recommendations" title="Permalink to this headline">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">recommend</span></code> function makes recommendations for a given user.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">userid</span> <span class="o">=</span> <span class="mi">1</span>

<span class="c1"># items sorted in decreasing order of predictions for user 1</span>
<span class="n">sorted_items</span><span class="p">,</span> <span class="n">preds</span> <span class="o">=</span> <span class="n">svd</span><span class="o">.</span><span class="n">recommend</span><span class="p">(</span><span class="n">userid</span><span class="o">=</span><span class="n">userid</span><span class="p">)</span>

<span class="c1">##</span>
<span class="c1"># Now let&#39;s exclud from that sorted list items already purchased by the user</span>
<span class="c1">##</span>

<span class="c1"># list of items rated by the user</span>
<span class="n">uitems</span> <span class="o">=</span> <span class="n">ratings</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ratings</span><span class="o">.</span><span class="n">userid</span> <span class="o">==</span> <span class="n">userid</span><span class="p">]</span><span class="o">.</span><span class="n">itemid</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>

<span class="c1"># remove from sorted_items items already in uitems and pick the top 30 ones</span>
<span class="c1"># as recommendation list</span>
<span class="n">top30</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">setdiff1d</span><span class="p">(</span><span class="n">sorted_items</span><span class="p">,</span> <span class="n">uitems</span><span class="p">,</span> <span class="n">assume_unique</span><span class="o">=</span><span class="kc">True</span><span class="p">)[:</span><span class="mi">30</span><span class="p">]</span>

<span class="c1"># get corresponding predictions from the top30 items</span>
<span class="n">top30_idx</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">sorted_items</span> <span class="o">==</span> <span class="n">idx</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">top30</span><span class="p">)</span>
<span class="n">top30_predictions</span> <span class="o">=</span> <span class="n">preds</span><span class="p">[</span><span class="n">top30_idx</span><span class="p">]</span>

<span class="c1"># find corresponding movie titles</span>
<span class="n">zipped_top30</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">top30</span><span class="p">,</span><span class="n">top30_predictions</span><span class="p">))</span>
<span class="n">top30</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">zipped_top30</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;itemid&#39;</span><span class="p">,</span><span class="s1">&#39;predictions&#39;</span><span class="p">])</span>
<span class="n">List</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">top30</span><span class="p">,</span> <span class="n">movies</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;itemid&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">)</span>

<span class="c1"># show the list</span>
<span class="n">List</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>itemid</th>
      <th>predictions</th>
      <th>title</th>
      <th>genres</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>140627</td>
      <td>5.0</td>
      <td>Battle For Sevastopol (2015)</td>
      <td>Drama|Romance|War</td>
    </tr>
    <tr>
      <th>1</th>
      <td>27373</td>
      <td>5.0</td>
      <td>61* (2001)</td>
      <td>Drama</td>
    </tr>
    <tr>
      <th>2</th>
      <td>115727</td>
      <td>5.0</td>
      <td>Crippled Avengers (Can que) (Return of the 5 D...</td>
      <td>Action|Adventure</td>
    </tr>
    <tr>
      <th>3</th>
      <td>151769</td>
      <td>5.0</td>
      <td>Three from Prostokvashino (1978)</td>
      <td>Animation</td>
    </tr>
    <tr>
      <th>4</th>
      <td>4402</td>
      <td>5.0</td>
      <td>Dr. Goldfoot and the Bikini Machine (1965)</td>
      <td>Comedy</td>
    </tr>
    <tr>
      <th>5</th>
      <td>166183</td>
      <td>5.0</td>
      <td>Junior and Karlson (1968)</td>
      <td>Adventure|Animation|Children</td>
    </tr>
    <tr>
      <th>6</th>
      <td>165959</td>
      <td>5.0</td>
      <td>Alesha Popovich and Tugarin the Dragon (2004)</td>
      <td>Animation|Comedy|Drama</td>
    </tr>
    <tr>
      <th>7</th>
      <td>147328</td>
      <td>5.0</td>
      <td>The Adventures of Sherlock Holmes and Dr. Wats...</td>
      <td>Crime</td>
    </tr>
    <tr>
      <th>8</th>
      <td>128087</td>
      <td>5.0</td>
      <td>Trinity and Sartana Are Coming (1972)</td>
      <td>Comedy|Western</td>
    </tr>
    <tr>
      <th>9</th>
      <td>69860</td>
      <td>5.0</td>
      <td>Eichmann (2007)</td>
      <td>Drama|War</td>
    </tr>
    <tr>
      <th>10</th>
      <td>131610</td>
      <td>5.0</td>
      <td>Willy/Milly (1986)</td>
      <td>Comedy|Fantasy</td>
    </tr>
    <tr>
      <th>11</th>
      <td>69211</td>
      <td>5.0</td>
      <td>Boy Eats Girl (2005)</td>
      <td>Comedy|Horror</td>
    </tr>
    <tr>
      <th>12</th>
      <td>3531</td>
      <td>5.0</td>
      <td>All the Vermeers in New York (1990)</td>
      <td>Comedy|Drama|Romance</td>
    </tr>
    <tr>
      <th>13</th>
      <td>113829</td>
      <td>5.0</td>
      <td>One I Love, The (2014)</td>
      <td>Comedy|Drama|Romance</td>
    </tr>
    <tr>
      <th>14</th>
      <td>69469</td>
      <td>5.0</td>
      <td>Garfield's Pet Force (2009)</td>
      <td>Animation</td>
    </tr>
    <tr>
      <th>15</th>
      <td>26928</td>
      <td>5.0</td>
      <td>Summer's Tale, A (Conte d'Ã©tÃ©) (1996)</td>
      <td>Comedy|Drama|Romance</td>
    </tr>
    <tr>
      <th>16</th>
      <td>131724</td>
      <td>5.0</td>
      <td>The Jinx: The Life and Deaths of Robert Durst ...</td>
      <td>Documentary</td>
    </tr>
    <tr>
      <th>17</th>
      <td>26849</td>
      <td>5.0</td>
      <td>Stand, The (1994)</td>
      <td>Adventure|Drama|Fantasy|Horror|Sci-Fi</td>
    </tr>
    <tr>
      <th>18</th>
      <td>114265</td>
      <td>5.0</td>
      <td>Laggies (2014)</td>
      <td>Comedy|Romance</td>
    </tr>
    <tr>
      <th>19</th>
      <td>3096</td>
      <td>5.0</td>
      <td>My Man Godfrey (1957)</td>
      <td>Comedy</td>
    </tr>
    <tr>
      <th>20</th>
      <td>70451</td>
      <td>5.0</td>
      <td>Max Manus (2008)</td>
      <td>Action|Drama|War</td>
    </tr>
    <tr>
      <th>21</th>
      <td>26840</td>
      <td>5.0</td>
      <td>Sonatine (Sonachine) (1993)</td>
      <td>Action|Comedy|Crime|Drama</td>
    </tr>
    <tr>
      <th>22</th>
      <td>4788</td>
      <td>5.0</td>
      <td>Moscow Does Not Believe in Tears (Moskva sleza...</td>
      <td>Drama|Romance</td>
    </tr>
    <tr>
      <th>23</th>
      <td>71268</td>
      <td>5.0</td>
      <td>Tyler Perry's I Can Do Bad All by Myself (2009)</td>
      <td>Comedy|Drama</td>
    </tr>
    <tr>
      <th>24</th>
      <td>7122</td>
      <td>5.0</td>
      <td>King of Hearts (1966)</td>
      <td>Comedy|Drama|War</td>
    </tr>
    <tr>
      <th>25</th>
      <td>4813</td>
      <td>5.0</td>
      <td>When Worlds Collide (1951)</td>
      <td>Sci-Fi</td>
    </tr>
    <tr>
      <th>26</th>
      <td>67618</td>
      <td>5.0</td>
      <td>Strictly Sexual (2008)</td>
      <td>Comedy|Drama|Romance</td>
    </tr>
    <tr>
      <th>27</th>
      <td>3567</td>
      <td>5.0</td>
      <td>Bossa Nova (2000)</td>
      <td>Comedy|Drama|Romance</td>
    </tr>
    <tr>
      <th>28</th>
      <td>131098</td>
      <td>5.0</td>
      <td>Saving Santa (2013)</td>
      <td>Animation|Children|Comedy</td>
    </tr>
    <tr>
      <th>29</th>
      <td>131130</td>
      <td>5.0</td>
      <td>Tom and Jerry: A Nutcracker Tale (2007)</td>
      <td>Animation|Comedy</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>The first 30 items have an equivalent rating prediction for the user 1</p>
</div>
<div class="section" id="improving-memory-based-collaborative-filtering">
<h3>Improving memory based collaborative filtering<a class="headerlink" href="#improving-memory-based-collaborative-filtering" title="Permalink to this headline">¶</a></h3>
<p>SVD can be applied to improve user and item-based collaborative filtering. Instead of computing similarities between user’s or item’s ratings, we can represent users and items by their corresponding latent factors extracted from the SVD algorithm.</p>
</div>
<div class="section" id="matrix-factorization">
<h3>Matrix Factorization<a class="headerlink" href="#matrix-factorization" title="Permalink to this headline">¶</a></h3>
<p>The <strong>Matrix Factorization</strong> algorithm is a variant of SVD. Also known as Regularized SVD, it uses the <em>Gradient Descent</em> optimizer to optimize the cost function while training the model.</p>
</div>
</div>
<div class="section" id="part-5-matrix-factorization-method">
<h2>Part 5 - Matrix factorization method<a class="headerlink" href="#part-5-matrix-factorization-method" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><p>Collaborative Filtering on MovieLens Latest-small Part 5 - Finding recommendations using model based  matrix factorization method.</p>
</div></blockquote>
<p><b>User-based</b> and <b>Item-based</b> collaborative Filtering recommender systems suffer from <i>data sparsity</i> and <i>scalability</i> for online recommendations. <b>Matrix Factorization</b> helps to address these drawbacks of memory-based collaborative filtering by reducing the dimension of the rating matrix <span class="math notranslate nohighlight">\(R\)</span>.</p>
<p>The movielen lasted small dataset has 100k ratings of <span class="math notranslate nohighlight">\(m=610\)</span> users on <span class="math notranslate nohighlight">\(n=9724\)</span> items. The rating matrix in then a <span class="math notranslate nohighlight">\(m\times n\)</span> matrix (i.e <span class="math notranslate nohighlight">\(R\in \mathbb{R}^{m\times n}\)</span>). The fact that users usually interact with less than <span class="math notranslate nohighlight">\(1\%\)</span> of items leads the rating matrix <span class="math notranslate nohighlight">\(R\)</span> to be highly sparse. For example, the degree of sparsity of the movielen lasted small dataset is</p>
<p>\begin{equation}
sparsity = 100 - \frac{\text{total # ratings}}{m \times n} = 100 - \frac{100000}{610\times 9724} = 98,3%
\end{equation}</p>
<p>This means that in this dataset, a user has interacted with less than <span class="math notranslate nohighlight">\(2\%\)</span> of items. To reduce the dimension of the rating matrix <span class="math notranslate nohighlight">\(R\)</span>, Matrix Factorization (MF) mappes both users and items to a joint latent factor space of dimensionality <span class="math notranslate nohighlight">\(k\)</span> such that user-item interactions are modeled as inner products in that space <a href='https://ieeexplore.ieee.org/document/5197422'>(Yehuda Koren et al., 2009)</a>. MF then decomposes <span class="math notranslate nohighlight">\(R\)</span> in two matrices as follows :</p>
<p>\begin{equation}
R = Q^\top P
\end{equation}</p>
<p>Where <span class="math notranslate nohighlight">\(P \in \mathbb{R}^{m\times k}\)</span> represents latent factors of users and <span class="math notranslate nohighlight">\(Q \in \mathbb{R}^{n\times k}\)</span> is the latent factors of items. Each line of <span class="math notranslate nohighlight">\(P\)</span>, say <span class="math notranslate nohighlight">\(p_u \in \mathbb{R}^k\)</span> denotes the taste of user <span class="math notranslate nohighlight">\(u\)</span> and each <span class="math notranslate nohighlight">\(q_i \in \mathbb{R}^k\)</span> the features of item <span class="math notranslate nohighlight">\(i\)</span>. The dot product between <span class="math notranslate nohighlight">\(p_u\)</span> and <span class="math notranslate nohighlight">\(q_i\)</span> will be the rating prediction of user <span class="math notranslate nohighlight">\(u\)</span> on item <span class="math notranslate nohighlight">\(i\)</span> :</p>
<p>\begin{equation}
\hat{r}<em>{u,i} = q</em>{i}^{\top} p_u.
\end{equation}</p>
<p>Figure 1 presents an example of decomposition of <span class="math notranslate nohighlight">\(R\)</span> into two matrices <span class="math notranslate nohighlight">\(P\)</span> and <span class="math notranslate nohighlight">\(Q\)</span>.</p>
<p><img alt="MF" src="https://raw.githubusercontent.com/nzhinusoftcm/review-on-collaborative-filtering/master/recsys/img/MF.png" /></p>
<p>To learn the latent factors <span class="math notranslate nohighlight">\(p_u\)</span> and <span class="math notranslate nohighlight">\(q_i\)</span>, the system minimizes the regularized squared error on the set of known ratings. The cost function <span class="math notranslate nohighlight">\(J\)</span> is defined as follows :</p>
<p>\begin{equation}
J = \frac{1}{2}\sum_{(u,i)\in \kappa} (r_{ui} - q_{i}^{\top} p_u)^2 + \lambda(||p_u||^2 + ||q_i||^2)
\end{equation}</p>
<p>where <span class="math notranslate nohighlight">\(\kappa\)</span> is the set of <span class="math notranslate nohighlight">\((u,i)\)</span> pairs for which <span class="math notranslate nohighlight">\(r_{u,i}\)</span> is known (the training set), and <span class="math notranslate nohighlight">\(\lambda\)</span> is the regularizer parameter.</p>
<div class="section" id="learning-algorithms">
<h3>Learning Algorithms<a class="headerlink" href="#learning-algorithms" title="Permalink to this headline">¶</a></h3>
<p>As described in <a href='https://ieeexplore.ieee.org/document/5197422'>(Yehuda Koren et al., 2009)</a>, to minimize the cost function <span class="math notranslate nohighlight">\(J\)</span>, the matrix factorization algorithm predicts <span class="math notranslate nohighlight">\(\hat{r}_{u,i}\)</span> for each given training case (existing <span class="math notranslate nohighlight">\(r_{u,i}\)</span>), and computes the associated error defined by the Mean Absolute Error (MAE) as :</p>
<p>\begin{equation}
e_{u,i} = |r_{ui} - q_{i}^{\top} p_u|.
\end{equation}</p>
<p><b>Note</b> : The overall error <span class="math notranslate nohighlight">\(E\)</span> is defined as :</p>
<p>\begin{equation}
E = \frac{1}{M}\sum_{(u,i)\in\kappa} e_{u,i}
\end{equation}</p>
<p>Where <span class="math notranslate nohighlight">\(M\)</span> is the number of example. The update rules for parameters <span class="math notranslate nohighlight">\(p_u\)</span> and <span class="math notranslate nohighlight">\(q_i\)</span> are defined as follows :</p>
<p>\begin{equation}
q_i \leftarrow q_i - \alpha\frac{\partial}{\partial q_i}J_{u,i},
\end{equation}</p>
<p>\begin{equation}
p_u \leftarrow p_u - \alpha\frac{\partial}{\partial p_u}J_{u,i}
\end{equation}</p>
<p>where <span class="math notranslate nohighlight">\(\alpha\)</span> is the learning rate and <span class="math notranslate nohighlight">\(\frac{\partial}{\partial p_u}J_{u,i}\)</span> is the partial derivative of the cost function <span class="math notranslate nohighlight">\(J\)</span> according to <span class="math notranslate nohighlight">\(p_u\)</span>. It computes the extent to which <span class="math notranslate nohighlight">\(p_u\)</span> contributes to the total error.</p>
<div class="section" id="how-to-compute-frac-partial-partial-q-i-j-u-i">
<h4>How to compute <span class="math notranslate nohighlight">\(\frac{\partial}{\partial q_i}J_{u,i}\)</span> ?<a class="headerlink" href="#how-to-compute-frac-partial-partial-q-i-j-u-i" title="Permalink to this headline">¶</a></h4>
<p>\begin{align}
\frac{\partial}{\partial q_i}J_{u,i} &amp; = &amp; \frac{1}{2}\frac{\partial}{\partial q_i} \begin{bmatrix}(r_{ui} - q_{i}^{\top} p_u)^2 + \lambda(||p_u||^2 + ||q_i||^2)\end{bmatrix} \
&amp; = &amp; -(r_{u,i}-q_{i}^{\top} p_u)\cdot p_u + \lambda \cdot q_i  \
&amp; = &amp; -e_{u,i}\cdot p_u+\lambda \cdot q_i
\end{align}</p>
<p>The update rules are then given by :</p>
<p>\begin{equation}
q_i \leftarrow q_i + \alpha\cdot (e_{u,i}\cdot p_u-\lambda \cdot q_i),
\end{equation}</p>
<p>\begin{equation}
p_u \leftarrow p_u + \alpha\cdot (e_{u,i}\cdot q_i-\lambda \cdot p_u)
\end{equation}</p>
</div>
</div>
<div class="section" id="matrix-factorization-algorithm">
<h3>Matrix Factorization : algorithm<a class="headerlink" href="#matrix-factorization-algorithm" title="Permalink to this headline">¶</a></h3>
<ol>
    <li>Initialize $P$ and $Q$ with random values
    <li>For each training example $(u,i)\in\kappa$ with the corresponding rating $r_{u,i}$ :
        <ul>
            <li>compute $\hat{r}_{u,i}$ as $\hat{r}_{u,i} = q_{i}^{\top} p_u$
            <li>compute the error : $e_{u,i} = |r_{ui} - \hat{r}_{u,i}|$
            <li>update $p_u$ and $q_i$:
                <ul>
                    <li>$p_u \leftarrow p_u + \alpha\cdot (e_{u,i}\cdot q_i-\lambda \cdot p_u)$
                    <li>$q_i \leftarrow q_i + \alpha\cdot (e_{u,i}\cdot p_u-\lambda \cdot q_i)$
                </ul>
        </ul>
    <li> Repeat step 2 until the optimal parameters are reached.
</ol>
<div class="section" id="download-useful-files">
<h4>Download useful files<a class="headerlink" href="#download-useful-files" title="Permalink to this headline">¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>import os
if not (os.path.exists(&quot;recsys.zip&quot;) or os.path.exists(&quot;recsys&quot;)):
    !wget https://github.com/nzhinusoftcm/review-on-collaborative-filtering/raw/master/recsys.zip    
    !unzip recsys.zip
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="id8">
<h4>Import requirements<a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h4>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">matplotlib</span><span class="o">==</span><span class="mf">3.2</span><span class="o">.</span><span class="mi">2</span>
<span class="n">numpy</span><span class="o">==</span><span class="mf">1.19</span><span class="o">.</span><span class="mi">2</span>
<span class="n">pandas</span><span class="o">==</span><span class="mf">1.0</span><span class="o">.</span><span class="mi">5</span>
<span class="n">python</span><span class="o">==</span><span class="mf">3.7</span>
<span class="n">scikit</span><span class="o">-</span><span class="n">learn</span><span class="o">==</span><span class="mf">0.24</span><span class="o">.</span><span class="mi">1</span>
<span class="n">scikit</span><span class="o">-</span><span class="n">surprise</span><span class="o">==</span><span class="mf">1.1</span><span class="o">.</span><span class="mi">1</span>
<span class="n">scipy</span><span class="o">==</span><span class="mf">1.6</span><span class="o">.</span><span class="mi">2</span>
</pre></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">recsys.preprocessing</span> <span class="kn">import</span> <span class="n">mean_ratings</span>
<span class="kn">from</span> <span class="nn">recsys.preprocessing</span> <span class="kn">import</span> <span class="n">normalized_ratings</span>
<span class="kn">from</span> <span class="nn">recsys.preprocessing</span> <span class="kn">import</span> <span class="n">ids_encoder</span>
<span class="kn">from</span> <span class="nn">recsys.preprocessing</span> <span class="kn">import</span> <span class="n">train_test_split</span>
<span class="kn">from</span> <span class="nn">recsys.preprocessing</span> <span class="kn">import</span> <span class="n">rating_matrix</span>
<span class="kn">from</span> <span class="nn">recsys.preprocessing</span> <span class="kn">import</span> <span class="n">get_examples</span>
<span class="kn">from</span> <span class="nn">recsys.preprocessing</span> <span class="kn">import</span> <span class="n">scale_ratings</span>

<span class="kn">from</span> <span class="nn">recsys.datasets</span> <span class="kn">import</span> <span class="n">ml100k</span>
<span class="kn">from</span> <span class="nn">recsys.datasets</span> <span class="kn">import</span> <span class="n">ml1m</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">import</span> <span class="nn">os</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="model-definition">
<h3>Model definition<a class="headerlink" href="#model-definition" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MatrixFactorization</span><span class="p">:</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">lamb</span><span class="o">=</span><span class="mf">0.01</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialization of the model        </span>
<span class="sd">        : param</span>
<span class="sd">            - m : number of users</span>
<span class="sd">            - n : number of items</span>
<span class="sd">            - k : length of latent factor, both for users and items. 50 by default</span>
<span class="sd">            - alpha : learning rate. 0.001 by default</span>
<span class="sd">            - lamb : regularizer parameter. 0.02 by default</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>
        
        <span class="c1"># initialize the latent factor matrices P and Q (of shapes (m,k) and (n,k) respectively) that will be learnt</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k</span> <span class="o">=</span> <span class="n">k</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">P</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">k</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">k</span><span class="p">))</span>
        
        <span class="c1"># hyperparameter initialization</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="n">alpha</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lamb</span> <span class="o">=</span> <span class="n">lamb</span>
        
        <span class="c1"># training history</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">history</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;epochs&quot;</span><span class="p">:[],</span>
            <span class="s2">&quot;loss&quot;</span><span class="p">:[],</span>
            <span class="s2">&quot;val_loss&quot;</span><span class="p">:[],</span>
            <span class="s2">&quot;lr&quot;</span><span class="p">:[]</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">print_training_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Training Matrix Factorization Model ...&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;k=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="si">}</span><span class="s1"> </span><span class="se">\t</span><span class="s1"> alpha=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="si">}</span><span class="s1"> </span><span class="se">\t</span><span class="s1"> lambda=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">lamb</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">update_rule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">error</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">P</span><span class="p">[</span><span class="n">u</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">P</span><span class="p">[</span><span class="n">u</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">*</span> <span class="p">(</span><span class="n">error</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">lamb</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">P</span><span class="p">[</span><span class="n">u</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">*</span> <span class="p">(</span><span class="n">error</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">P</span><span class="p">[</span><span class="n">u</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">lamb</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        
    <span class="k">def</span> <span class="nf">mae</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        returns the Mean Absolute Error</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># number of training exemples</span>
        <span class="n">M</span> <span class="o">=</span> <span class="n">x_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">error</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">pair</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">):</span>
            <span class="n">u</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="n">pair</span>
            <span class="n">error</span> <span class="o">+=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">r</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">P</span><span class="p">[</span><span class="n">u</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
        <span class="k">return</span> <span class="n">error</span><span class="o">/</span><span class="n">M</span>
    
    <span class="k">def</span> <span class="nf">print_training_progress</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">epochs</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">val_error</span><span class="p">,</span> <span class="n">steps</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">epoch</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">epoch</span> <span class="o">%</span> <span class="n">steps</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;epoch </span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2"> - loss : </span><span class="si">{}</span><span class="s2"> - val_loss : </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">epoch</span><span class="p">,</span> <span class="n">epochs</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">error</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="nb">round</span><span class="p">(</span><span class="n">val_error</span><span class="p">,</span><span class="mi">3</span><span class="p">)))</span>
                
    <span class="k">def</span> <span class="nf">learning_rate_schedule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">target_epochs</span> <span class="o">=</span> <span class="mi">20</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">epoch</span> <span class="o">&gt;=</span> <span class="n">target_epochs</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">epoch</span> <span class="o">%</span> <span class="n">target_epochs</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                <span class="n">factor</span> <span class="o">=</span> <span class="n">epoch</span> <span class="o">//</span> <span class="n">target_epochs</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">factor</span> <span class="o">*</span> <span class="mi">20</span><span class="p">))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Learning Rate : </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">))</span>
    
    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">validation_data</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Train latent factors P and Q according to the training set</span>
<span class="sd">        </span>
<span class="sd">        :param</span>
<span class="sd">            - x_train : training pairs (u,i) for which rating r_ui is known</span>
<span class="sd">            - y_train : set of ratings r_ui for all training pairs (u,i)</span>
<span class="sd">            - validation_data : tuple (x_test, y_test)</span>
<span class="sd">            - epochs : number of time to loop over the entire training set. </span>
<span class="sd">            1000 epochs by default</span>
<span class="sd">            </span>
<span class="sd">        Note that u and i are encoded values of userid and itemid</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">print_training_parameters</span><span class="p">()</span>
        
        <span class="c1"># validation data</span>
        <span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">validation_data</span>
        
        <span class="c1"># loop over the number of epochs</span>
        <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">epochs</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            
            <span class="c1"># for each pair (u,i) and the corresponding rating r</span>
            <span class="k">for</span> <span class="n">pair</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">):</span>
                
                <span class="c1"># get encoded values of userid and itemid from pair</span>
                <span class="n">u</span><span class="p">,</span><span class="n">i</span> <span class="o">=</span> <span class="n">pair</span>
                
                <span class="c1"># compute the predicted rating r_hat</span>
                <span class="n">r_hat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">P</span><span class="p">[</span><span class="n">u</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                
                <span class="c1"># compute the prediction error</span>
                <span class="n">e</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">r</span> <span class="o">-</span> <span class="n">r_hat</span><span class="p">)</span>
                
                <span class="c1"># update rules</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">update_rule</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
                
            <span class="c1"># training and validation error  after this epochs</span>
            <span class="n">error</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mae</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
            <span class="n">val_error</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mae</span><span class="p">(</span><span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>
            
            <span class="c1"># update history</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;epochs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">epoch</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;val_loss&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val_error</span><span class="p">)</span>
            
            <span class="c1"># update history</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_history</span><span class="p">(</span><span class="n">epoch</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">val_error</span><span class="p">)</span>
            
            <span class="c1"># print training progress after each steps epochs</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">print_training_progress</span><span class="p">(</span><span class="n">epoch</span><span class="p">,</span> <span class="n">epochs</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">val_error</span><span class="p">,</span> <span class="n">steps</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
              
            <span class="c1"># leaning rate scheduler : redure the learning rate as we go deeper in the number of epochs</span>
            <span class="c1"># self.learning_rate_schedule(epoch)</span>
        
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span>
    
    <span class="k">def</span> <span class="nf">update_history</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">val_error</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;epochs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">epoch</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;val_loss&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val_error</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;lr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        compute the global error on the test set        </span>
<span class="sd">        :param x_test : test pairs (u,i) for which rating r_ui is known</span>
<span class="sd">        :param y_test : set of ratings r_ui for all test pairs (u,i)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">error</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mae</span><span class="p">(</span><span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;validation error : </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">error</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">error</span>
      
    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">userid</span><span class="p">,</span> <span class="n">itemid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Make rating prediction for a user on an item</span>
<span class="sd">        :param userid</span>
<span class="sd">        :param itemid</span>
<span class="sd">        :return r : predicted rating</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># encode user and item ids to be able to access their latent factors in</span>
        <span class="c1"># matrices P and Q</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">uencoder</span><span class="o">.</span><span class="n">transform</span><span class="p">([</span><span class="n">userid</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">iencoder</span><span class="o">.</span><span class="n">transform</span><span class="p">([</span><span class="n">itemid</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># rating prediction using encoded ids. Dot product between P_u and Q_i</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">P</span><span class="p">[</span><span class="n">u</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">r</span>

    <span class="k">def</span> <span class="nf">recommend</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">userid</span><span class="p">,</span> <span class="n">N</span><span class="o">=</span><span class="mi">30</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        make to N recommendations for a given user</span>

<span class="sd">        :return(top_items,preds) : top N items with the highest predictions </span>
<span class="sd">        with their corresponding predictions</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># encode the userid</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">uencoder</span><span class="o">.</span><span class="n">transform</span><span class="p">([</span><span class="n">userid</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># predictions for users userid on all product</span>
        <span class="n">predictions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">P</span><span class="p">[</span><span class="n">u</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

        <span class="c1"># get the indices of the top N predictions</span>
        <span class="n">top_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">predictions</span><span class="p">))[:</span><span class="n">N</span><span class="p">]</span>

        <span class="c1"># decode indices to get their corresponding itemids</span>
        <span class="n">top_items</span> <span class="o">=</span> <span class="n">iencoder</span><span class="o">.</span><span class="n">inverse_transform</span><span class="p">(</span><span class="n">top_idx</span><span class="p">)</span>

        <span class="c1"># take corresponding predictions for top N indices</span>
        <span class="n">preds</span> <span class="o">=</span> <span class="n">predictions</span><span class="p">[</span><span class="n">top_idx</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">top_items</span><span class="p">,</span> <span class="n">preds</span>        
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">epochs</span> <span class="o">=</span> <span class="mi">10</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="movielens-100k">
<h3>MovieLens 100k<a class="headerlink" href="#movielens-100k" title="Permalink to this headline">¶</a></h3>
<div class="section" id="evaluation-on-raw-ratings">
<h4>Evaluation on raw ratings<a class="headerlink" href="#evaluation-on-raw-ratings" title="Permalink to this headline">¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># load the ml100k dataset</span>
<span class="n">ratings</span><span class="p">,</span> <span class="n">movies</span> <span class="o">=</span> <span class="n">ml100k</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>

<span class="n">ratings</span><span class="p">,</span> <span class="n">uencoder</span><span class="p">,</span> <span class="n">iencoder</span> <span class="o">=</span> <span class="n">ids_encoder</span><span class="p">(</span><span class="n">ratings</span><span class="p">)</span>

<span class="n">m</span> <span class="o">=</span> <span class="n">ratings</span><span class="o">.</span><span class="n">userid</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span>   <span class="c1"># total number of users</span>
<span class="n">n</span> <span class="o">=</span> <span class="n">ratings</span><span class="o">.</span><span class="n">itemid</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span>   <span class="c1"># total number of items</span>

<span class="c1"># get examples as tuples of userids and itemids and labels from normalize ratings</span>
<span class="n">raw_examples</span><span class="p">,</span> <span class="n">raw_labels</span> <span class="o">=</span> <span class="n">get_examples</span><span class="p">(</span><span class="n">ratings</span><span class="p">)</span>

<span class="c1"># train test split</span>
<span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">x_test</span><span class="p">),</span> <span class="p">(</span><span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">examples</span><span class="o">=</span><span class="n">raw_examples</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">raw_labels</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># create the model</span>
<span class="n">MF</span> <span class="o">=</span> <span class="n">MatrixFactorization</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">lamb</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>

<span class="c1"># fit the model on the training set</span>
<span class="n">history</span> <span class="o">=</span> <span class="n">MF</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="n">epochs</span><span class="p">,</span> <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Training Matrix Factorization Model ...
k=10 	 alpha=0.01 	 lambda=1.5
epoch 1/10 - loss : 2.734 - val_loss : 2.779
epoch 2/10 - loss : 1.764 - val_loss : 1.794
epoch 3/10 - loss : 1.592 - val_loss : 1.614
epoch 4/10 - loss : 1.538 - val_loss : 1.556
epoch 5/10 - loss : 1.515 - val_loss : 1.531
epoch 6/10 - loss : 1.503 - val_loss : 1.517
epoch 7/10 - loss : 1.496 - val_loss : 1.509
epoch 8/10 - loss : 1.491 - val_loss : 1.504
epoch 9/10 - loss : 1.488 - val_loss : 1.5
epoch 10/10 - loss : 1.486 - val_loss : 1.497
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">MF</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>validation error : 1.497
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.4973507972141993
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="evaluation-on-normalized-ratings">
<h4>Evaluation on normalized ratings<a class="headerlink" href="#evaluation-on-normalized-ratings" title="Permalink to this headline">¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># load data</span>
<span class="n">ratings</span><span class="p">,</span> <span class="n">movies</span> <span class="o">=</span> <span class="n">ml100k</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>

<span class="n">ratings</span><span class="p">,</span> <span class="n">uencoder</span><span class="p">,</span> <span class="n">iencoder</span> <span class="o">=</span> <span class="n">ids_encoder</span><span class="p">(</span><span class="n">ratings</span><span class="p">)</span>

<span class="n">m</span> <span class="o">=</span> <span class="n">ratings</span><span class="p">[</span><span class="s1">&#39;userid&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span>   <span class="c1"># total number of users</span>
<span class="n">n</span> <span class="o">=</span> <span class="n">ratings</span><span class="p">[</span><span class="s1">&#39;itemid&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span>   <span class="c1"># total number of items</span>

<span class="c1"># normalize ratings by substracting means</span>
<span class="n">normalized_column_name</span> <span class="o">=</span> <span class="s2">&quot;norm_rating&quot;</span>
<span class="n">ratings</span> <span class="o">=</span> <span class="n">normalized_ratings</span><span class="p">(</span><span class="n">ratings</span><span class="p">,</span> <span class="n">norm_column</span><span class="o">=</span><span class="n">normalized_column_name</span><span class="p">)</span>

<span class="c1"># get examples as tuples of userids and itemids and labels from normalize ratings</span>
<span class="n">raw_examples</span><span class="p">,</span> <span class="n">raw_labels</span> <span class="o">=</span> <span class="n">get_examples</span><span class="p">(</span><span class="n">ratings</span><span class="p">,</span> <span class="n">labels_column</span><span class="o">=</span><span class="n">normalized_column_name</span><span class="p">)</span>

<span class="c1"># train test split</span>
<span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">x_test</span><span class="p">),</span> <span class="p">(</span><span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">examples</span><span class="o">=</span><span class="n">raw_examples</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">raw_labels</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># create the model</span>
<span class="n">MF</span> <span class="o">=</span> <span class="n">MatrixFactorization</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">lamb</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>

<span class="c1"># fit the model on the training set</span>
<span class="n">history</span> <span class="o">=</span> <span class="n">MF</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="n">epochs</span><span class="p">,</span> <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Training Matrix Factorization Model ...
k=10 	 alpha=0.01 	 lambda=1.5
epoch 1/10 - loss : 0.851 - val_loss : 0.847
epoch 2/10 - loss : 0.831 - val_loss : 0.831
epoch 3/10 - loss : 0.828 - val_loss : 0.829
epoch 4/10 - loss : 0.827 - val_loss : 0.828
epoch 5/10 - loss : 0.827 - val_loss : 0.828
epoch 6/10 - loss : 0.826 - val_loss : 0.828
epoch 7/10 - loss : 0.826 - val_loss : 0.828
epoch 8/10 - loss : 0.826 - val_loss : 0.828
epoch 9/10 - loss : 0.826 - val_loss : 0.828
epoch 10/10 - loss : 0.826 - val_loss : 0.828
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">MF</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>validation error : 0.828
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.8276982643684648
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="movielens-1m">
<h3>MovieLens 1M<a class="headerlink" href="#movielens-1m" title="Permalink to this headline">¶</a></h3>
<div class="section" id="evaluation-on-raw-data">
<h4>Evaluation on raw data<a class="headerlink" href="#evaluation-on-raw-data" title="Permalink to this headline">¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># load the ml1m dataset</span>
<span class="n">ratings</span><span class="p">,</span> <span class="n">movies</span> <span class="o">=</span> <span class="n">ml1m</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>

<span class="n">ratings</span><span class="p">,</span> <span class="n">uencoder</span><span class="p">,</span> <span class="n">iencoder</span> <span class="o">=</span> <span class="n">ids_encoder</span><span class="p">(</span><span class="n">ratings</span><span class="p">)</span>

<span class="n">m</span> <span class="o">=</span> <span class="n">ratings</span><span class="o">.</span><span class="n">userid</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span>   <span class="c1"># total number of users</span>
<span class="n">n</span> <span class="o">=</span> <span class="n">ratings</span><span class="o">.</span><span class="n">itemid</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span>   <span class="c1"># total number of items</span>

<span class="c1"># get examples as tuples of userids and itemids and labels from normalize ratings</span>
<span class="n">raw_examples</span><span class="p">,</span> <span class="n">raw_labels</span> <span class="o">=</span> <span class="n">get_examples</span><span class="p">(</span><span class="n">ratings</span><span class="p">)</span>

<span class="c1"># train test split</span>
<span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">x_test</span><span class="p">),</span> <span class="p">(</span><span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">examples</span><span class="o">=</span><span class="n">raw_examples</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">raw_labels</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># create the model</span>
<span class="n">MF</span> <span class="o">=</span> <span class="n">MatrixFactorization</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">lamb</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>

<span class="c1"># fit the model on the training set</span>
<span class="n">history</span> <span class="o">=</span> <span class="n">MF</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="n">epochs</span><span class="p">,</span> <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Training Matrix Factorization Model ...
k=10 	 alpha=0.01 	 lambda=1.5
epoch 1/10 - loss : 1.713 - val_loss : 1.718
epoch 2/10 - loss : 1.523 - val_loss : 1.526
epoch 3/10 - loss : 1.496 - val_loss : 1.498
epoch 4/10 - loss : 1.489 - val_loss : 1.489
epoch 5/10 - loss : 1.485 - val_loss : 1.486
epoch 6/10 - loss : 1.484 - val_loss : 1.484
epoch 7/10 - loss : 1.483 - val_loss : 1.483
epoch 8/10 - loss : 1.483 - val_loss : 1.483
epoch 9/10 - loss : 1.482 - val_loss : 1.482
epoch 10/10 - loss : 1.482 - val_loss : 1.482
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">MF</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>validation error : 1.482
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.4820034560467208
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="id9">
<h4>Evaluation on normalized ratings<a class="headerlink" href="#id9" title="Permalink to this headline">¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># load data</span>
<span class="n">ratings</span><span class="p">,</span> <span class="n">movies</span> <span class="o">=</span> <span class="n">ml1m</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>

<span class="n">ratings</span><span class="p">,</span> <span class="n">uencoder</span><span class="p">,</span> <span class="n">iencoder</span> <span class="o">=</span> <span class="n">ids_encoder</span><span class="p">(</span><span class="n">ratings</span><span class="p">)</span>

<span class="n">m</span> <span class="o">=</span> <span class="n">ratings</span><span class="p">[</span><span class="s1">&#39;userid&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span>   <span class="c1"># total number of users</span>
<span class="n">n</span> <span class="o">=</span> <span class="n">ratings</span><span class="p">[</span><span class="s1">&#39;itemid&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span>   <span class="c1"># total number of items</span>

<span class="c1"># normalize ratings by substracting means</span>
<span class="n">normalized_column_name</span> <span class="o">=</span> <span class="s2">&quot;norm_rating&quot;</span>
<span class="n">ratings</span> <span class="o">=</span> <span class="n">normalized_ratings</span><span class="p">(</span><span class="n">ratings</span><span class="p">,</span> <span class="n">norm_column</span><span class="o">=</span><span class="n">normalized_column_name</span><span class="p">)</span>

<span class="c1"># get examples as tuples of userids and itemids and labels from normalize ratings</span>
<span class="n">raw_examples</span><span class="p">,</span> <span class="n">raw_labels</span> <span class="o">=</span> <span class="n">get_examples</span><span class="p">(</span><span class="n">ratings</span><span class="p">,</span> <span class="n">labels_column</span><span class="o">=</span><span class="n">normalized_column_name</span><span class="p">)</span>

<span class="c1"># train test split</span>
<span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">x_test</span><span class="p">),</span> <span class="p">(</span><span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">examples</span><span class="o">=</span><span class="n">raw_examples</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">raw_labels</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># create the model</span>
<span class="n">MF</span> <span class="o">=</span> <span class="n">MatrixFactorization</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">lamb</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>

<span class="c1"># fit the model on the training set</span>
<span class="n">history</span> <span class="o">=</span> <span class="n">MF</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="n">epochs</span><span class="p">,</span> <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Training Matrix Factorization Model ...
k=10 	 alpha=0.01 	 lambda=1.5
epoch 1/10 - loss : 0.826 - val_loss : 0.827
epoch 2/10 - loss : 0.824 - val_loss : 0.825
epoch 3/10 - loss : 0.823 - val_loss : 0.825
epoch 4/10 - loss : 0.823 - val_loss : 0.825
epoch 5/10 - loss : 0.823 - val_loss : 0.825
epoch 6/10 - loss : 0.823 - val_loss : 0.825
epoch 7/10 - loss : 0.823 - val_loss : 0.825
epoch 8/10 - loss : 0.823 - val_loss : 0.825
epoch 9/10 - loss : 0.823 - val_loss : 0.825
epoch 10/10 - loss : 0.823 - val_loss : 0.825
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">MF</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>validation error : 0.825
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.8250208634455388
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="predictions">
<h3>Predictions<a class="headerlink" href="#predictions" title="Permalink to this headline">¶</a></h3>
<p>Now that the latent factors <span class="math notranslate nohighlight">\(P\)</span> and <span class="math notranslate nohighlight">\(Q\)</span>, we can use them to make predictions and recommendations. Let’s call the <code class="docutils literal notranslate"><span class="pre">predict</span></code> function of the <code class="docutils literal notranslate"><span class="pre">Matrix</span> <span class="pre">Factorization</span></code> class to make prediction for a given.</p>
<p>rating prediction for user 1 on item 1 for which the truth rating <span class="math notranslate nohighlight">\(r=5.0\)</span></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ratings</span><span class="o">.</span><span class="n">userid</span> <span class="o">=</span> <span class="n">uencoder</span><span class="o">.</span><span class="n">inverse_transform</span><span class="p">(</span><span class="n">ratings</span><span class="o">.</span><span class="n">userid</span><span class="o">.</span><span class="n">to_list</span><span class="p">())</span>
<span class="n">ratings</span><span class="o">.</span><span class="n">itemid</span> <span class="o">=</span> <span class="n">uencoder</span><span class="o">.</span><span class="n">inverse_transform</span><span class="p">(</span><span class="n">ratings</span><span class="o">.</span><span class="n">itemid</span><span class="o">.</span><span class="n">to_list</span><span class="p">())</span>
<span class="n">ratings</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>userid</th>
      <th>itemid</th>
      <th>rating</th>
      <th>rating_mean</th>
      <th>norm_rating</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>1</td>
      <td>5</td>
      <td>4.188679</td>
      <td>0.811321</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>48</td>
      <td>5</td>
      <td>4.188679</td>
      <td>0.811321</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1</td>
      <td>145</td>
      <td>5</td>
      <td>4.188679</td>
      <td>0.811321</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1</td>
      <td>254</td>
      <td>4</td>
      <td>4.188679</td>
      <td>-0.188679</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1</td>
      <td>514</td>
      <td>5</td>
      <td>4.188679</td>
      <td>0.811321</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mf">4.188679</span> <span class="o">+</span> <span class="n">MF</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">userid</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">itemid</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># add the mean because we have used the normalised ratings for training</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>4.188679163563357
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="id10">
<h3>Summary<a class="headerlink" href="#id10" title="Permalink to this headline">¶</a></h3>
<p>This is the link to the MatrixFactorization class : <a class="reference external" href="https://github.com/nzhinusoftcm/review-on-collaborative-filtering/blob/master/recsys/models/MatrixFactorization.py">MatrixFactorization.py</a></p>
</div>
<div class="section" id="non-negative-matrix-factorization">
<h3>Non-negative Matrix Factorization<a class="headerlink" href="#non-negative-matrix-factorization" title="Permalink to this headline">¶</a></h3>
<p>With the Matrix Factorization model, <span class="math notranslate nohighlight">\(P\)</span> and <span class="math notranslate nohighlight">\(Q\)</span> latent factors are non interpretable since they contain arbitrary negative or positive values. This make the Matrix Factorization model to be non explainable.</p>
<p>The <strong>Non-negative Matrix Factorization (NMF)</strong> algorithm is a variant of Matrix Factorization which generate explainable latent factors for <span class="math notranslate nohighlight">\(P\)</span> and <span class="math notranslate nohighlight">\(Q\)</span> by constraining their values in the range [0,1]. This allow a probability interpretation of these latent factors, hense the explainability.</p>
</div>
</div>
<div class="section" id="part-6-non-negative-matrix-factorization-method">
<h2>Part 6 - Non-negative Matrix factorization method<a class="headerlink" href="#part-6-non-negative-matrix-factorization-method" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><p>Collaborative Filtering on MovieLens Latest-small Part 6 - Finding recommendations using model based non-negative matrix factorization method.</p>
</div></blockquote>
<p>Jusl like Matrix Factorization (MF) <a class="reference external" href="https://ieeexplore.ieee.org/document/5197422">(Yehuda Koren et al., 2009)</a>, Non-negative Matrix Factorization (NMF in short) factors the rating matrix <span class="math notranslate nohighlight">\(R\)</span> in two matrices in such a way that <span class="math notranslate nohighlight">\(R = PQ^{\top}\)</span>.</p>
<div class="section" id="one-limitation-of-matrix-factorization">
<h3>One limitation of Matrix Factorization<a class="headerlink" href="#one-limitation-of-matrix-factorization" title="Permalink to this headline">¶</a></h3>
<p><span class="math notranslate nohighlight">\(P\)</span> and <span class="math notranslate nohighlight">\(Q\)</span> values in MF are non interpretable since their components can take arbitrary (positive and negative) values.</p>
</div>
<div class="section" id="particulariy-of-non-negative-matrix-factorization">
<h3>Particulariy of Non-negative Matrix Factorization<a class="headerlink" href="#particulariy-of-non-negative-matrix-factorization" title="Permalink to this headline">¶</a></h3>
<p>NMF <a class="reference external" href="http://www.dm.unibo.it/~simoncin/nmfconverge.pdf">(Lee and Seung, 1999)</a> allows the reconstruction of <span class="math notranslate nohighlight">\(P\)</span> and <span class="math notranslate nohighlight">\(Q\)</span> in such a way that <span class="math notranslate nohighlight">\(P,Q \ge 0\)</span>. Constraining <span class="math notranslate nohighlight">\(P\)</span> and <span class="math notranslate nohighlight">\(Q\)</span> values to be taken from <span class="math notranslate nohighlight">\([0,1]\)</span> allows  a probabilistic interpretation</p>
<ul class="simple">
<li><p>Latent factors represent groups of users who share the same tastes,</p></li>
<li><p>The value  <span class="math notranslate nohighlight">\(P_{u,l}\)</span>  represents the probability that user <span class="math notranslate nohighlight">\(u\)</span> belongs to the group <span class="math notranslate nohighlight">\(l\)</span> of users and</p></li>
<li><p>The value <span class="math notranslate nohighlight">\(Q_{l,i}\)</span> represents the probability that users in the group <span class="math notranslate nohighlight">\(l\)</span>  likes item <span class="math notranslate nohighlight">\(i\)</span>.</p></li>
</ul>
</div>
<div class="section" id="objective-function">
<h3>Objective function<a class="headerlink" href="#objective-function" title="Permalink to this headline">¶</a></h3>
<p>With the Euclidian distance, the NMF objective function is defined by</p>
<p>\begin{equation}
J = \frac{1}{2}\sum_{(u,i) \in \kappa}||R_{u,i} - P_uQ_i^{\top}||^2 + \lambda_P||P_u||^2 + \lambda_Q||Q_i||^2
\end{equation}</p>
<p>The goal is to minimize the cost function <span class="math notranslate nohighlight">\(J\)</span> by optimizing parameters <span class="math notranslate nohighlight">\(P\)</span> and <span class="math notranslate nohighlight">\(Q\)</span>, with <span class="math notranslate nohighlight">\(\lambda_P\)</span> and <span class="math notranslate nohighlight">\(\lambda_Q\)</span> the regularizer parameters.</p>
</div>
<div class="section" id="multiplicative-update-rule">
<h3>Multiplicative update rule<a class="headerlink" href="#multiplicative-update-rule" title="Permalink to this headline">¶</a></h3>
<p>According <a class="reference external" href="https://www.nature.com/articles/44565.pdf">(Lee and Seung, 1999)</a>, to the multiplicative update rule for <span class="math notranslate nohighlight">\(P\)</span> and <span class="math notranslate nohighlight">\(Q\)</span> are as follows :</p>
<p>\begin{equation}
P \leftarrow P \cdot \frac{RQ}{PQ^{\top}Q}
\end{equation}</p>
<p>\begin{equation}
Q \leftarrow Q \cdot \frac{R^{\top}P}{QP^{\top}P}
\end{equation}</p>
<p>However, since <span class="math notranslate nohighlight">\(R\)</span> is a sparse matrix, we need to update each <span class="math notranslate nohighlight">\(P_u\)</span> according to existing ratings of user <span class="math notranslate nohighlight">\(u\)</span>. Similarily, we need to update <span class="math notranslate nohighlight">\(Q_i\)</span> according to existing ratings on item <span class="math notranslate nohighlight">\(i\)</span>. Hence :</p>
<p>\begin{equation}
P_{u,k} \leftarrow P_{u,k} \cdot \frac{\sum_{i \in I_u}Q_{i,k}\cdot r_{u,i}}{\sum_{i \in I_u}Q_{i,k}\cdot \hat{r}<em>{u,i} + \lambda_P|I_u|P</em>{u,k}}
\end{equation}</p>
<p>\begin{equation}
Q_{i,k} \leftarrow Q_{i,k} \cdot \frac{\sum_{u \in U_i}P_{u,k}\cdot r_{u,i}}{\sum_{u \in U_i}P_{u,k}\cdot \hat{r}<em>{u,i} + \lambda_Q|U_i|Q</em>{i,k}}
\end{equation}</p>
<p>Where</p>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(P_{u,k}\)</span> is the <span class="math notranslate nohighlight">\(k^{th}\)</span> latent factor of <span class="math notranslate nohighlight">\(P_u\)</span></p></li>
<li><p><span class="math notranslate nohighlight">\(Q_{i,k}\)</span> is the <span class="math notranslate nohighlight">\(k^{th}\)</span> latent factor of <span class="math notranslate nohighlight">\(Q_i\)</span></p></li>
<li><p><span class="math notranslate nohighlight">\(I_u\)</span> the of items rated by user <span class="math notranslate nohighlight">\(u\)</span></p></li>
<li><p><span class="math notranslate nohighlight">\(U_i\)</span> the set of users who rated item <span class="math notranslate nohighlight">\(i\)</span></p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>import os

if not (os.path.exists(&quot;recsys.zip&quot;) or os.path.exists(&quot;recsys&quot;)):
    !wget https://github.com/nzhinusoftcm/review-on-collaborative-filtering/raw/master/recsys.zip    
    !unzip recsys.zip
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="install-and-import-useful-packages">
<h3>Install and import useful packages<a class="headerlink" href="#install-and-import-useful-packages" title="Permalink to this headline">¶</a></h3>
</div>
<div class="section" id="requirements">
<h3>requirements<a class="headerlink" href="#requirements" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">matplotlib</span><span class="o">==</span><span class="mf">3.2</span><span class="o">.</span><span class="mi">2</span>
<span class="n">numpy</span><span class="o">==</span><span class="mf">1.19</span><span class="o">.</span><span class="mi">2</span>
<span class="n">pandas</span><span class="o">==</span><span class="mf">1.0</span><span class="o">.</span><span class="mi">5</span>
<span class="n">python</span><span class="o">==</span><span class="mf">3.7</span>
<span class="n">scikit</span><span class="o">-</span><span class="n">learn</span><span class="o">==</span><span class="mf">0.24</span><span class="o">.</span><span class="mi">1</span>
<span class="n">scikit</span><span class="o">-</span><span class="n">surprise</span><span class="o">==</span><span class="mf">1.1</span><span class="o">.</span><span class="mi">1</span>
<span class="n">scipy</span><span class="o">==</span><span class="mf">1.6</span><span class="o">.</span><span class="mi">2</span>
</pre></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">recsys.preprocessing</span> <span class="kn">import</span> <span class="n">mean_ratings</span>
<span class="kn">from</span> <span class="nn">recsys.preprocessing</span> <span class="kn">import</span> <span class="n">normalized_ratings</span>
<span class="kn">from</span> <span class="nn">recsys.preprocessing</span> <span class="kn">import</span> <span class="n">ids_encoder</span>
<span class="kn">from</span> <span class="nn">recsys.preprocessing</span> <span class="kn">import</span> <span class="n">train_test_split</span>
<span class="kn">from</span> <span class="nn">recsys.preprocessing</span> <span class="kn">import</span> <span class="n">rating_matrix</span>
<span class="kn">from</span> <span class="nn">recsys.preprocessing</span> <span class="kn">import</span> <span class="n">get_examples</span>
<span class="kn">from</span> <span class="nn">recsys.preprocessing</span> <span class="kn">import</span> <span class="n">scale_ratings</span>

<span class="kn">from</span> <span class="nn">recsys.datasets</span> <span class="kn">import</span> <span class="n">ml1m</span>
<span class="kn">from</span> <span class="nn">recsys.datasets</span> <span class="kn">import</span> <span class="n">ml100k</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">import</span> <span class="nn">os</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="load-and-preprocess-rating">
<h3>Load and preprocess rating<a class="headerlink" href="#load-and-preprocess-rating" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># load data</span>
<span class="n">ratings</span><span class="p">,</span> <span class="n">movies</span> <span class="o">=</span> <span class="n">ml100k</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>

<span class="c1"># prepare data</span>
<span class="n">ratings</span><span class="p">,</span> <span class="n">uencoder</span><span class="p">,</span> <span class="n">iencoder</span> <span class="o">=</span> <span class="n">ids_encoder</span><span class="p">(</span><span class="n">ratings</span><span class="p">)</span>

<span class="c1"># convert ratings from dataframe to numpy array</span>
<span class="n">np_ratings</span> <span class="o">=</span> <span class="n">ratings</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>

<span class="c1"># get examples as tuples of userids and itemids and labels from normalize ratings</span>
<span class="n">raw_examples</span><span class="p">,</span> <span class="n">raw_labels</span> <span class="o">=</span> <span class="n">get_examples</span><span class="p">(</span><span class="n">ratings</span><span class="p">,</span> <span class="n">labels_column</span><span class="o">=</span><span class="s2">&quot;rating&quot;</span><span class="p">)</span>

<span class="c1"># train test split</span>
<span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">x_test</span><span class="p">),</span> <span class="p">(</span><span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">examples</span><span class="o">=</span><span class="n">raw_examples</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">raw_labels</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="non-negative-matrix-factorization-model">
<h3>Non-negative Matrix Factorization Model<a class="headerlink" href="#non-negative-matrix-factorization-model" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">NMF</span><span class="p">:</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ratings</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">uencoder</span><span class="p">,</span> <span class="n">iencoder</span><span class="p">,</span> <span class="n">K</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">lambda_P</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">lambda_Q</span><span class="o">=</span><span class="mf">0.01</span><span class="p">):</span>
        
        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>
        
        <span class="c1"># initialize the latent factor matrices P and Q (of shapes (m,k) and (n,k) respectively) that will be learnt</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ratings</span> <span class="o">=</span> <span class="n">ratings</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">np_ratings</span> <span class="o">=</span> <span class="n">ratings</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">K</span> <span class="o">=</span> <span class="n">K</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">P</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">K</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">K</span><span class="p">)</span>
        
        <span class="c1"># hyper parameter initialization</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lambda_P</span> <span class="o">=</span> <span class="n">lambda_P</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lambda_Q</span> <span class="o">=</span> <span class="n">lambda_Q</span>

        <span class="c1"># initialize encoders</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uencoder</span> <span class="o">=</span> <span class="n">uencoder</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iencoder</span> <span class="o">=</span> <span class="n">iencoder</span>
        
        <span class="c1"># training history</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">history</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;epochs&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s2">&quot;loss&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s2">&quot;val_loss&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">print_training_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Training NMF ...&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;k=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">K</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">mae</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        returns the Mean Absolute Error</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># number of training examples</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">x_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">error</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">pair</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">):</span>
            <span class="n">u</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="n">pair</span>
            <span class="n">error</span> <span class="o">+=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">r</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">P</span><span class="p">[</span><span class="n">u</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
        <span class="k">return</span> <span class="n">error</span> <span class="o">/</span> <span class="n">m</span>
    
    <span class="k">def</span> <span class="nf">update_rule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">error</span><span class="p">):</span>
        <span class="n">I</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">np_ratings</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">np_ratings</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">u</span><span class="p">][:,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]]</span>
        <span class="n">U</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">np_ratings</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">np_ratings</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">i</span><span class="p">][:,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]]</span>    
                    
        <span class="n">num</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">P</span><span class="p">[</span><span class="n">u</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">[</span><span class="n">I</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">I</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">dem</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">[</span><span class="n">I</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">P</span><span class="p">[</span><span class="n">u</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">[</span><span class="n">I</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">T</span><span class="p">))</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">lambda_P</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">I</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">P</span><span class="p">[</span><span class="n">u</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">P</span><span class="p">[</span><span class="n">u</span><span class="p">]</span> <span class="o">=</span> <span class="n">num</span> <span class="o">/</span> <span class="n">dem</span>

        <span class="n">num</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">P</span><span class="p">[</span><span class="n">U</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">U</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">dem</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">P</span><span class="p">[</span><span class="n">U</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">P</span><span class="p">[</span><span class="n">U</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]],</span> <span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">))</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">lambda_Q</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">U</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">num</span> <span class="o">/</span> <span class="n">dem</span>
    
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">print_training_progress</span><span class="p">(</span><span class="n">epoch</span><span class="p">,</span> <span class="n">epochs</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">val_error</span><span class="p">,</span> <span class="n">steps</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">epoch</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">epoch</span> <span class="o">%</span> <span class="n">steps</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;epoch </span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">epochs</span><span class="si">}</span><span class="s2"> - loss : </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s2"> - val_loss : </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">val_error</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                
    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">validation_data</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">print_training_parameters</span><span class="p">()</span>
        <span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">validation_data</span>
        <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">epochs</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">pair</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">):</span>
                <span class="n">u</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="n">pair</span>
                <span class="n">r_hat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">P</span><span class="p">[</span><span class="n">u</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">e</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">r</span> <span class="o">-</span> <span class="n">r_hat</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">update_rule</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>                
            <span class="c1"># training and validation error  after this epochs</span>
            <span class="n">error</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mae</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
            <span class="n">val_error</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mae</span><span class="p">(</span><span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_history</span><span class="p">(</span><span class="n">epoch</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">val_error</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">print_training_progress</span><span class="p">(</span><span class="n">epoch</span><span class="p">,</span> <span class="n">epochs</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">val_error</span><span class="p">,</span> <span class="n">steps</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span>
    
    <span class="k">def</span> <span class="nf">update_history</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">val_error</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;epochs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">epoch</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;val_loss&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val_error</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">):</span>        
        <span class="n">error</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mae</span><span class="p">(</span><span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;validation error : </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">error</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;MAE : &#39;</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span>        
        <span class="k">return</span> <span class="n">error</span>
      
    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">userid</span><span class="p">,</span> <span class="n">itemid</span><span class="p">):</span>
        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">uencoder</span><span class="o">.</span><span class="n">transform</span><span class="p">([</span><span class="n">userid</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">iencoder</span><span class="o">.</span><span class="n">transform</span><span class="p">([</span><span class="n">itemid</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">P</span><span class="p">[</span><span class="n">u</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">r</span>

    <span class="k">def</span> <span class="nf">recommend</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">userid</span><span class="p">,</span> <span class="n">N</span><span class="o">=</span><span class="mi">30</span><span class="p">):</span>
        <span class="c1"># encode the userid</span>
        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">uencoder</span><span class="o">.</span><span class="n">transform</span><span class="p">([</span><span class="n">userid</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># predictions for users userid on all product</span>
        <span class="n">predictions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">P</span><span class="p">[</span><span class="n">u</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

        <span class="c1"># get the indices of the top N predictions</span>
        <span class="n">top_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">predictions</span><span class="p">))[:</span><span class="n">N</span><span class="p">]</span>

        <span class="c1"># decode indices to get their corresponding itemids</span>
        <span class="n">top_items</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">iencoder</span><span class="o">.</span><span class="n">inverse_transform</span><span class="p">(</span><span class="n">top_idx</span><span class="p">)</span>

        <span class="c1"># take corresponding predictions for top N indices</span>
        <span class="n">preds</span> <span class="o">=</span> <span class="n">predictions</span><span class="p">[</span><span class="n">top_idx</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">top_items</span><span class="p">,</span> <span class="n">preds</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="train-the-nmf-model-with-ml-100k-dataset">
<h3>Train the NMF model with ML-100K dataset<a class="headerlink" href="#train-the-nmf-model-with-ml-100k-dataset" title="Permalink to this headline">¶</a></h3>
<p>model parameters :</p>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(k = 10\)</span> : (number of factors)</p></li>
<li><p><span class="math notranslate nohighlight">\(\lambda_P = 0.6\)</span></p></li>
<li><p><span class="math notranslate nohighlight">\(\lambda_Q = 0.6\)</span></p></li>
<li><p>epochs = 10</p></li>
</ul>
<p>Note that it may take some time to complete the training on 10 epochs (around 7 minutes).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">m</span> <span class="o">=</span> <span class="n">ratings</span><span class="p">[</span><span class="s1">&#39;userid&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span>   <span class="c1"># total number of users</span>
<span class="n">n</span> <span class="o">=</span> <span class="n">ratings</span><span class="p">[</span><span class="s1">&#39;itemid&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span>   <span class="c1"># total number of items</span>

<span class="c1"># create and train the model</span>
<span class="n">nmf</span> <span class="o">=</span> <span class="n">NMF</span><span class="p">(</span><span class="n">ratings</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">uencoder</span><span class="p">,</span> <span class="n">iencoder</span><span class="p">,</span> <span class="n">K</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">lambda_P</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">lambda_Q</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>
<span class="n">history</span> <span class="o">=</span> <span class="n">nmf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Training NMF ...
k=10
epoch 1/10 - loss : 0.916 - val_loss : 0.917
epoch 2/10 - loss : 0.915 - val_loss : 0.917
epoch 3/10 - loss : 0.915 - val_loss : 0.917
epoch 4/10 - loss : 0.915 - val_loss : 0.917
epoch 5/10 - loss : 0.915 - val_loss : 0.917
epoch 6/10 - loss : 0.915 - val_loss : 0.917
epoch 7/10 - loss : 0.915 - val_loss : 0.917
epoch 8/10 - loss : 0.915 - val_loss : 0.917
epoch 9/10 - loss : 0.915 - val_loss : 0.917
epoch 10/10 - loss : 0.915 - val_loss : 0.917
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">nmf</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>validation error : 0.917
MAE :  0.916504134301954
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.916504134301954
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="evaluation-of-nmf-with-scikit-suprise">
<h3>Evaluation of NMF with Scikit-suprise<a class="headerlink" href="#evaluation-of-nmf-with-scikit-suprise" title="Permalink to this headline">¶</a></h3>
<p>We can use the <a class="reference external" href="https://surprise.readthedocs.io/en/stable/">scikt-suprise</a> package to train the NMF model. It  is an easy-to-use Python scikit for recommender systems.</p>
<ol class="simple">
<li><p>Import the NMF class from the suprise scikit.</p></li>
<li><p>Load the data with the built-in function</p></li>
<li><p>Instanciate NMF with <code class="docutils literal notranslate"><span class="pre">k=10</span></code> (<code class="docutils literal notranslate"><span class="pre">n_factors</span></code>) and we use 10 epochs (<code class="docutils literal notranslate"><span class="pre">n_epochs</span></code>)</p></li>
<li><p>Evaluate the model using cross-validation with 5 folds.</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">surprise</span> <span class="kn">import</span> <span class="n">NMF</span>
<span class="kn">from</span> <span class="nn">surprise</span> <span class="kn">import</span> <span class="n">Dataset</span>
<span class="kn">from</span> <span class="nn">surprise.model_selection</span> <span class="kn">import</span> <span class="n">cross_validate</span>

<span class="c1"># Load the movielens-100k dataset (download it if needed).</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">Dataset</span><span class="o">.</span><span class="n">load_builtin</span><span class="p">(</span><span class="s1">&#39;ml-100k&#39;</span><span class="p">)</span>

<span class="c1"># Use the NMF algorithm.</span>
<span class="n">nmf</span> <span class="o">=</span> <span class="n">NMF</span><span class="p">(</span><span class="n">n_factors</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">n_epochs</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="c1"># Run 5-fold cross-validation and print results.</span>
<span class="n">history</span> <span class="o">=</span> <span class="n">cross_validate</span><span class="p">(</span><span class="n">nmf</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">measures</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;MAE&#39;</span><span class="p">],</span> <span class="n">cv</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evaluating MAE of algorithm NMF on 5 split(s).

                  Fold 1  Fold 2  Fold 3  Fold 4  Fold 5  Mean    Std     
MAE (testset)     0.9626  0.9435  0.9777  0.9607  0.9510  0.9591  0.0116  
Fit time          0.63    0.69    0.74    0.65    0.71    0.68    0.04    
Test time         0.15    0.11    0.14    0.10    0.15    0.13    0.02    
</pre></div>
</div>
</div>
</div>
<p>As result, the mean MAE on the test set is <strong>mae = 0.9510</strong> which is equivalent to the result we have obtained on <em>ml-100k</em> with our own implementation <strong>mae = 0.9165</strong></p>
<p>The mean MAE on a 5-fold cross-validation is <strong>mae = 0.9567</strong></p>
<p>This may take arount 2 minutes</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="n">Dataset</span><span class="o">.</span><span class="n">load_builtin</span><span class="p">(</span><span class="s1">&#39;ml-1m&#39;</span><span class="p">)</span>
<span class="n">nmf</span> <span class="o">=</span> <span class="n">NMF</span><span class="p">(</span><span class="n">n_factors</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">n_epochs</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">history</span> <span class="o">=</span> <span class="n">cross_validate</span><span class="p">(</span><span class="n">nmf</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">measures</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;MAE&#39;</span><span class="p">],</span> <span class="n">cv</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evaluating MAE of algorithm NMF on 5 split(s).

                  Fold 1  Fold 2  Fold 3  Fold 4  Fold 5  Mean    Std     
MAE (testset)     0.9559  0.9580  0.9566  0.9639  0.9490  0.9567  0.0047  
Fit time          6.37    6.55    6.49    6.45    6.51    6.47    0.06    
Test time         1.68    1.31    1.64    1.46    1.75    1.57    0.16    
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="explainable-matrix-factorization">
<h3>Explainable Matrix Factorization<a class="headerlink" href="#explainable-matrix-factorization" title="Permalink to this headline">¶</a></h3>
<p>NMF introduced explainability to MF by constraining <span class="math notranslate nohighlight">\(P\)</span> and <span class="math notranslate nohighlight">\(Q\)</span> values in <span class="math notranslate nohighlight">\([0,1]\)</span>. It can be considered is an inner explainable model. It’s possible to inject external informations into the model in order to bring explainability. This is what the <strong>Explainable Matrix Factorization (EMF)</strong> algorithm does. It computes explainable scores from user or item similarities taken from the user-based or item-based CF.</p>
</div>
</div>
<div class="section" id="part-7-explainable-matrix-factorization-method">
<h2>Part 7 - Explainable Matrix factorization method<a class="headerlink" href="#part-7-explainable-matrix-factorization-method" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><p>Collaborative Filtering on MovieLens Latest-small Part 7 - Finding recommendations using model based explainable matrix factorization method.</p>
</div></blockquote>
<div class="section" id="how-to-quantify-explainability">
<h3>How to quantify explainability ?<a class="headerlink" href="#how-to-quantify-explainability" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>Use the rating distribution within the active user’s neighborhood.</p></li>
<li><p>If many neighbors have rated the recommended item, then this can provide a basis upon which to explain the recommendations, using neighborhood style explanation mechanisms</p></li>
</ul>
<p>According to <a class="reference external" href="https://www.researchgate.net/publication/301616080_Explainable_Matrix_Factorization_for_Collaborative_Filtering">(Abdollahi and Nasraoui, 2016)</a>, an item <span class="math notranslate nohighlight">\(i\)</span> is consider to be explainable for user <span class="math notranslate nohighlight">\(u\)</span> if a considerable number of its neighbors rated item <span class="math notranslate nohighlight">\(i\)</span>. The explainability score <span class="math notranslate nohighlight">\(E_{ui}\)</span> is the percentage of user <span class="math notranslate nohighlight">\(u\)</span>’s neighbors who have rated item <span class="math notranslate nohighlight">\(i\)</span>.</p>
<p>\begin{equation}
E_{ui} = \frac{|N_k^{(i)}(u)|}{|N_k(u)|},
\end{equation}</p>
<p>where <span class="math notranslate nohighlight">\(N_k(u)\)</span> is the set of <span class="math notranslate nohighlight">\(k\)</span> nearest neighbors of user <span class="math notranslate nohighlight">\(u\)</span> and <span class="math notranslate nohighlight">\(N_k^{(i)}(u)\)</span> is the set of user <span class="math notranslate nohighlight">\(u\)</span>’s neighbors who have rated item <span class="math notranslate nohighlight">\(i\)</span>. However, only explainable scores above an optimal threshold <span class="math notranslate nohighlight">\(\theta\)</span> are accepted.</p>
<p>\begin{equation}
W_{ui} = \begin{cases} E_{ui} \text{  } if \text{  } E_{ui} &gt; \theta \ 0 \text{ } otherwise \end{cases},
\end{equation}</p>
<p>By including explainability weight in the training algorithm, the new objective function, to be minimized over the set of known ratings, has been formulated by <a class="reference external" href="https://www.researchgate.net/publication/301616080_Explainable_Matrix_Factorization_for_Collaborative_Filtering">(Abdollahi and Nasraoui, 2016)</a> as:</p>
<p>\begin{equation}
J = \sum_{(u,i)\in \kappa} (R_{ui} - \hat{R}<em>{ui})^2 +\frac{\beta}{2}(||P_u||^2 + ||Q_i||^2) + \frac{\lambda}{2}(P_u-Q_i)^2W</em>{ui},
\end{equation}</p>
<p>here, <span class="math notranslate nohighlight">\(\frac{\beta}{2}(||P_u||^2 + ||Q_i||^2)\)</span> is the <span class="math notranslate nohighlight">\(L_2\)</span> regularization term weighted by the coefficient <span class="math notranslate nohighlight">\(\beta\)</span>, and <span class="math notranslate nohighlight">\(\lambda\)</span> is an explainability regularization coefficient that controls the smoothness of the new representation and tradeoff between explainability and accuracy. The idea here is that if item <span class="math notranslate nohighlight">\(i\)</span> is explainable for user <span class="math notranslate nohighlight">\(u\)</span>, then their representations in the latent space, <span class="math notranslate nohighlight">\(Q_i\)</span> and <span class="math notranslate nohighlight">\(P_u\)</span>, should be close to each other. Stochastic Gradient descent can be used to optimize the objectve function.</p>
<p>\begin{equation}
P_u \leftarrow P_u + \alpha\left(2(R_{u,i}-P_uQ_i^{\top})Q_i - \beta P_u - \lambda(P_u-Q_i)W_{ui}\right)
\end{equation}
\begin{equation}
Q_i \leftarrow Q_i + \alpha\left(2(R_{u,i}-P_uQ_i^{\top})P_u - \beta Q_i + \lambda(P_u-Q_i)W_{ui}\right)
\end{equation}</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>import os

if not (os.path.exists(&quot;recsys.zip&quot;) or os.path.exists(&quot;recsys&quot;)):
    !wget https://github.com/nzhinusoftcm/review-on-collaborative-filtering/raw/master/recsys.zip    
    !unzip recsys.zip
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="id11">
<h3>requirements<a class="headerlink" href="#id11" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">matplotlib</span><span class="o">==</span><span class="mf">3.2</span><span class="o">.</span><span class="mi">2</span>
<span class="n">numpy</span><span class="o">==</span><span class="mf">1.18</span><span class="o">.</span><span class="mi">1</span>
<span class="n">pandas</span><span class="o">==</span><span class="mf">1.0</span><span class="o">.</span><span class="mi">5</span>
<span class="n">python</span><span class="o">==</span><span class="mf">3.6</span><span class="o">.</span><span class="mi">10</span>
<span class="n">scikit</span><span class="o">-</span><span class="n">learn</span><span class="o">==</span><span class="mf">0.23</span><span class="o">.</span><span class="mi">1</span>
<span class="n">scipy</span><span class="o">==</span><span class="mf">1.5</span><span class="o">.</span><span class="mi">0</span>
</pre></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">recsys.memories.UserToUser</span> <span class="kn">import</span> <span class="n">UserToUser</span>

<span class="kn">from</span> <span class="nn">recsys.preprocessing</span> <span class="kn">import</span> <span class="n">mean_ratings</span>
<span class="kn">from</span> <span class="nn">recsys.preprocessing</span> <span class="kn">import</span> <span class="n">normalized_ratings</span>
<span class="kn">from</span> <span class="nn">recsys.preprocessing</span> <span class="kn">import</span> <span class="n">ids_encoder</span>
<span class="kn">from</span> <span class="nn">recsys.preprocessing</span> <span class="kn">import</span> <span class="n">train_test_split</span>
<span class="kn">from</span> <span class="nn">recsys.preprocessing</span> <span class="kn">import</span> <span class="n">rating_matrix</span>
<span class="kn">from</span> <span class="nn">recsys.preprocessing</span> <span class="kn">import</span> <span class="n">get_examples</span>

<span class="kn">from</span> <span class="nn">recsys.datasets</span> <span class="kn">import</span> <span class="n">ml100k</span><span class="p">,</span> <span class="n">ml1m</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="compute-explainable-scores">
<h3>Compute Explainable Scores<a class="headerlink" href="#compute-explainable-scores" title="Permalink to this headline">¶</a></h3>
<p>Explainable score are computed using neighborhood based similarities. Here, we are using the user based algorithme to compute similarities</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">explainable_score</span><span class="p">(</span><span class="n">user2user</span><span class="p">,</span> <span class="n">users</span><span class="p">,</span> <span class="n">items</span><span class="p">,</span> <span class="n">theta</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    
    <span class="k">def</span> <span class="nf">_progress</span><span class="p">(</span><span class="n">count</span><span class="p">):</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\r</span><span class="s1">Compute Explainable score. Progress status : </span><span class="si">%.1f%%</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">count</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">users</span><span class="p">))</span><span class="o">*</span><span class="mf">100.0</span><span class="p">))</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
    <span class="c1"># initialize explainable score to zeros</span>
    <span class="n">W</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">users</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">)))</span>

    <span class="k">for</span> <span class="n">count</span><span class="p">,</span> <span class="n">u</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">users</span><span class="p">):</span>            
        <span class="n">candidate_items</span> <span class="o">=</span> <span class="n">user2user</span><span class="o">.</span><span class="n">find_user_candidate_items</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>        
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">candidate_items</span><span class="p">:</span>                
            <span class="n">user_who_rated_i</span><span class="p">,</span> <span class="n">similar_user_who_rated_i</span> <span class="o">=</span> \
                <span class="n">user2user</span><span class="o">.</span><span class="n">similar_users_who_rated_this_item</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">user_who_rated_i</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">w</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">w</span> <span class="o">=</span> <span class="n">similar_user_who_rated_i</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">user_who_rated_i</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">W</span><span class="p">[</span><span class="n">u</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>  <span class="n">w</span>  <span class="k">if</span> <span class="n">w</span> <span class="o">&gt;</span> <span class="n">theta</span> <span class="k">else</span> <span class="mf">0.0</span>
        <span class="n">_progress</span><span class="p">(</span><span class="n">count</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">W</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="explainable-matrix-factorization-model">
<h3>Explainable Matrix Factorization Model<a class="headerlink" href="#explainable-matrix-factorization-model" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">ExplainableMatrixFactorization</span><span class="p">:</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">W</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">lamb</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            - R : Rating matrix of shape (m,n) </span>
<span class="sd">            - W : Explainability Weights of shape (m,n)</span>
<span class="sd">            - k : number of latent factors</span>
<span class="sd">            - beta : L2 regularization parameter</span>
<span class="sd">            - lamb : explainability regularization coefficient</span>
<span class="sd">            - theta : threshold above which an item is explainable for a user</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">W</span> <span class="o">=</span> <span class="n">W</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">=</span> <span class="n">m</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="n">n</span>
        
        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">64</span><span class="p">)</span>
        
        <span class="c1"># initialize the latent factor matrices P and Q (of shapes (m,k) and (n,k) respectively) that will be learnt</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k</span> <span class="o">=</span> <span class="n">k</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">P</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
        
        <span class="c1"># hyperparameter initialization</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="n">alpha</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">beta</span> <span class="o">=</span> <span class="n">beta</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lamb</span> <span class="o">=</span> <span class="n">lamb</span>
        
        <span class="c1"># training history</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">history</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;epochs&quot;</span><span class="p">:[],</span>
            <span class="s2">&quot;loss&quot;</span><span class="p">:[],</span>
            <span class="s2">&quot;val_loss&quot;</span><span class="p">:[],</span>
        <span class="p">}</span>
        
    <span class="k">def</span> <span class="nf">print_training_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Training EMF&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;k=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="si">}</span><span class="s1"> </span><span class="se">\t</span><span class="s1"> alpha=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="si">}</span><span class="s1"> </span><span class="se">\t</span><span class="s1"> beta=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">beta</span><span class="si">}</span><span class="s1"> </span><span class="se">\t</span><span class="s1"> lambda=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">lamb</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">update_rule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">error</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">P</span><span class="p">[</span><span class="n">u</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">P</span><span class="p">[</span><span class="n">u</span><span class="p">]</span> <span class="o">+</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="o">*</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">error</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">P</span><span class="p">[</span><span class="n">u</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">lamb</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">P</span><span class="p">[</span><span class="n">u</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">W</span><span class="p">[</span><span class="n">u</span><span class="p">,</span><span class="n">i</span><span class="p">])</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="o">*</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">error</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">P</span><span class="p">[</span><span class="n">u</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">lamb</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">P</span><span class="p">[</span><span class="n">u</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">W</span><span class="p">[</span><span class="n">u</span><span class="p">,</span><span class="n">i</span><span class="p">])</span>
        
    <span class="k">def</span> <span class="nf">mae</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        returns the Mean Absolute Error</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># number of training exemples</span>
        <span class="n">M</span> <span class="o">=</span> <span class="n">x_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">error</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">pair</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">):</span>
            <span class="n">u</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="n">pair</span>
            <span class="n">error</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">r</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">P</span><span class="p">[</span><span class="n">u</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
        <span class="k">return</span> <span class="n">error</span><span class="o">/</span><span class="n">M</span>
    
    <span class="k">def</span> <span class="nf">print_training_progress</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">epochs</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">val_error</span><span class="p">,</span> <span class="n">steps</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">epoch</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">epoch</span> <span class="o">%</span> <span class="n">steps</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;epoch </span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">epochs</span><span class="si">}</span><span class="s2"> - loss : </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">error</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s2"> - val_loss : </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">val_error</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                
    <span class="k">def</span> <span class="nf">learning_rate_schedule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">target_epochs</span> <span class="o">=</span> <span class="mi">20</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">epoch</span> <span class="o">&gt;=</span> <span class="n">target_epochs</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">epoch</span> <span class="o">%</span> <span class="n">target_epochs</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                <span class="n">factor</span> <span class="o">=</span> <span class="n">epoch</span> <span class="o">//</span> <span class="n">target_epochs</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">factor</span> <span class="o">*</span> <span class="mi">20</span><span class="p">))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Learning Rate : </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">))</span>
        
    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">validation_data</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Train latent factors P and Q according to the training set</span>
<span class="sd">        </span>
<span class="sd">        :param</span>
<span class="sd">            - x_train : training pairs (u,i) for which rating r_ui is known</span>
<span class="sd">            - y_train : set of ratings r_ui for all training pairs (u,i)</span>
<span class="sd">            - validation_data : tuple (x_test, y_test)</span>
<span class="sd">            - epochs : number of time to loop over the entire training set. </span>
<span class="sd">            10 epochs by default</span>
<span class="sd">            </span>
<span class="sd">        Note that u and i are encoded values of userid and itemid</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">print_training_parameters</span><span class="p">()</span>
        
        <span class="c1"># get validation data</span>
        <span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">validation_data</span>
        
        <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">epochs</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">pair</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">):</span>                
                <span class="n">u</span><span class="p">,</span><span class="n">i</span> <span class="o">=</span> <span class="n">pair</span>                
                <span class="n">r_hat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">P</span><span class="p">[</span><span class="n">u</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>                
                <span class="n">e</span> <span class="o">=</span> <span class="n">r</span> <span class="o">-</span> <span class="n">r_hat</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">update_rule</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="n">e</span><span class="p">)</span>
                
            <span class="c1"># training and validation error  after this epochs</span>
            <span class="n">error</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mae</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
            <span class="n">val_error</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mae</span><span class="p">(</span><span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_history</span><span class="p">(</span><span class="n">epoch</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">val_error</span><span class="p">)</span>            
            <span class="bp">self</span><span class="o">.</span><span class="n">print_training_progress</span><span class="p">(</span><span class="n">epoch</span><span class="p">,</span> <span class="n">epochs</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">val_error</span><span class="p">,</span> <span class="n">steps</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span>
    
    <span class="k">def</span> <span class="nf">update_history</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">val_error</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;epochs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">epoch</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;val_loss&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val_error</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        compute the global error on the test set</span>
<span class="sd">        </span>
<span class="sd">        :param</span>
<span class="sd">            - x_test : test pairs (u,i) for which rating r_ui is known</span>
<span class="sd">            - y_test : set of ratings r_ui for all test pairs (u,i)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">error</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mae</span><span class="p">(</span><span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;validation error : </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">error</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
      
    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">userid</span><span class="p">,</span> <span class="n">itemid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Make rating prediction for a user on an item</span>

<span class="sd">        :param</span>
<span class="sd">        - userid</span>
<span class="sd">        - itemid</span>

<span class="sd">        :return</span>
<span class="sd">        - r : predicted rating</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># encode user and item ids to be able to access their latent factors in</span>
        <span class="c1"># matrices P and Q</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">uencoder</span><span class="o">.</span><span class="n">transform</span><span class="p">([</span><span class="n">userid</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">iencoder</span><span class="o">.</span><span class="n">transform</span><span class="p">([</span><span class="n">itemid</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># rating prediction using encoded ids. Dot product between P_u and Q_i</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">P</span><span class="p">[</span><span class="n">u</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">r</span>

    <span class="k">def</span> <span class="nf">recommend</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">userid</span><span class="p">,</span> <span class="n">N</span><span class="o">=</span><span class="mi">30</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        make to N recommendations for a given user</span>

<span class="sd">        :return </span>
<span class="sd">        - (top_items,preds) : top N items with the highest predictions </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># encode the userid</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">uencoder</span><span class="o">.</span><span class="n">transform</span><span class="p">([</span><span class="n">userid</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># predictions for this user on all product</span>
        <span class="n">predictions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">P</span><span class="p">[</span><span class="n">u</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

        <span class="c1"># get the indices of the top N predictions</span>
        <span class="n">top_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">predictions</span><span class="p">))[:</span><span class="n">N</span><span class="p">]</span>

        <span class="c1"># decode indices to get their corresponding itemids</span>
        <span class="n">top_items</span> <span class="o">=</span> <span class="n">iencoder</span><span class="o">.</span><span class="n">inverse_transform</span><span class="p">(</span><span class="n">top_idx</span><span class="p">)</span>

        <span class="c1"># take corresponding predictions for top N indices</span>
        <span class="n">preds</span> <span class="o">=</span> <span class="n">predictions</span><span class="p">[</span><span class="n">top_idx</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">top_items</span><span class="p">,</span> <span class="n">preds</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">epochs</span> <span class="o">=</span> <span class="mi">10</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="model-evaluation">
<h3>Model Evaluation<a class="headerlink" href="#model-evaluation" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id12">
<h4>MovieLens 100K<a class="headerlink" href="#id12" title="Permalink to this headline">¶</a></h4>
<p><strong>Evaluation on raw data</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># load data</span>
<span class="n">ratings</span><span class="p">,</span> <span class="n">movies</span> <span class="o">=</span> <span class="n">ml100k</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>

<span class="c1"># encode users and items ids</span>
<span class="n">ratings</span><span class="p">,</span> <span class="n">uencoder</span><span class="p">,</span> <span class="n">iencoder</span> <span class="o">=</span> <span class="n">ids_encoder</span><span class="p">(</span><span class="n">ratings</span><span class="p">)</span>

<span class="n">users</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">ratings</span><span class="o">.</span><span class="n">userid</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
<span class="n">items</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">ratings</span><span class="o">.</span><span class="n">itemid</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>

<span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">users</span><span class="p">)</span>
<span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">)</span>

<span class="c1"># get examples as tuples of userids and itemids and labels from normalize ratings</span>
<span class="n">raw_examples</span><span class="p">,</span> <span class="n">raw_labels</span> <span class="o">=</span> <span class="n">get_examples</span><span class="p">(</span><span class="n">ratings</span><span class="p">)</span>

<span class="c1"># train test split</span>
<span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">x_test</span><span class="p">),</span> <span class="p">(</span><span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">examples</span><span class="o">=</span><span class="n">raw_examples</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">raw_labels</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># create the user to user model for similarity measure</span>
<span class="n">usertouser</span> <span class="o">=</span> <span class="n">UserToUser</span><span class="p">(</span><span class="n">ratings</span><span class="p">,</span> <span class="n">movies</span><span class="p">)</span>

<span class="c1"># compute explainable score</span>
<span class="n">W</span> <span class="o">=</span> <span class="n">explainable_score</span><span class="p">(</span><span class="n">usertouser</span><span class="p">,</span> <span class="n">users</span><span class="p">,</span> <span class="n">items</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Normalize users ratings ...
Initialize the similarity model ...
Compute nearest neighbors ...
User to user recommendation model created with success ...
Compute Explainable score. Progress status : 99.9%
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># initialize the model</span>
<span class="n">EMF</span> <span class="o">=</span> <span class="n">ExplainableMatrixFactorization</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">W</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">lamb</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="n">history</span> <span class="o">=</span> <span class="n">EMF</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="n">epochs</span><span class="p">,</span> <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Training EMF
k=10 	 alpha=0.01 	 beta=0.4 	 lambda=0.01
epoch 1/10 - loss : 0.922 - val_loss : 1.036
epoch 2/10 - loss : 0.79 - val_loss : 0.873
epoch 3/10 - loss : 0.766 - val_loss : 0.837
epoch 4/10 - loss : 0.757 - val_loss : 0.822
epoch 5/10 - loss : 0.753 - val_loss : 0.814
epoch 6/10 - loss : 0.751 - val_loss : 0.808
epoch 7/10 - loss : 0.749 - val_loss : 0.805
epoch 8/10 - loss : 0.748 - val_loss : 0.802
epoch 9/10 - loss : 0.746 - val_loss : 0.799
epoch 10/10 - loss : 0.745 - val_loss : 0.797
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">EMF</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>validation error : 0.797
</pre></div>
</div>
</div>
</div>
<p><strong>Evaluation on normalized data</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># load data</span>
<span class="n">ratings</span><span class="p">,</span> <span class="n">movies</span> <span class="o">=</span> <span class="n">ml100k</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>

<span class="c1"># encode users and items ids</span>
<span class="n">ratings</span><span class="p">,</span> <span class="n">uencoder</span><span class="p">,</span> <span class="n">iencoder</span> <span class="o">=</span> <span class="n">ids_encoder</span><span class="p">(</span><span class="n">ratings</span><span class="p">)</span>

<span class="n">users</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">ratings</span><span class="o">.</span><span class="n">userid</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
<span class="n">items</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">ratings</span><span class="o">.</span><span class="n">itemid</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>

<span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">users</span><span class="p">)</span>
<span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">)</span>

<span class="c1"># normalize ratings by substracting means</span>
<span class="n">normalized_column_name</span> <span class="o">=</span> <span class="s2">&quot;norm_rating&quot;</span>
<span class="n">ratings</span> <span class="o">=</span> <span class="n">normalized_ratings</span><span class="p">(</span><span class="n">ratings</span><span class="p">,</span> <span class="n">norm_column</span><span class="o">=</span><span class="n">normalized_column_name</span><span class="p">)</span>

<span class="c1"># get examples as tuples of userids and itemids and labels from normalize ratings</span>
<span class="n">raw_examples</span><span class="p">,</span> <span class="n">raw_labels</span> <span class="o">=</span> <span class="n">get_examples</span><span class="p">(</span><span class="n">ratings</span><span class="p">,</span> <span class="n">labels_column</span><span class="o">=</span><span class="n">normalized_column_name</span><span class="p">)</span>

<span class="c1"># train test split</span>
<span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">x_test</span><span class="p">),</span> <span class="p">(</span><span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">examples</span><span class="o">=</span><span class="n">raw_examples</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">raw_labels</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># initialize the model</span>
<span class="n">EMF</span> <span class="o">=</span> <span class="n">ExplainableMatrixFactorization</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">W</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.022</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="mf">0.65</span><span class="p">,</span> <span class="n">lamb</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="n">history</span> <span class="o">=</span> <span class="n">EMF</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="n">epochs</span><span class="p">,</span> <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Training EMF
k=10 	 alpha=0.022 	 beta=0.65 	 lambda=0.01
epoch 1/10 - loss : 0.809 - val_loss : 0.842
epoch 2/10 - loss : 0.809 - val_loss : 0.829
epoch 3/10 - loss : 0.807 - val_loss : 0.821
epoch 4/10 - loss : 0.799 - val_loss : 0.811
epoch 5/10 - loss : 0.789 - val_loss : 0.8
epoch 6/10 - loss : 0.782 - val_loss : 0.793
epoch 7/10 - loss : 0.778 - val_loss : 0.789
epoch 8/10 - loss : 0.776 - val_loss : 0.786
epoch 9/10 - loss : 0.774 - val_loss : 0.784
epoch 10/10 - loss : 0.773 - val_loss : 0.783
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="id13">
<h4>MovieLens 1M<a class="headerlink" href="#id13" title="Permalink to this headline">¶</a></h4>
<p><strong>Evaluation on raw data</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># load data</span>
<span class="n">ratings</span><span class="p">,</span> <span class="n">movies</span> <span class="o">=</span> <span class="n">ml1m</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>

<span class="c1"># encode users and items ids</span>
<span class="n">ratings</span><span class="p">,</span> <span class="n">uencoder</span><span class="p">,</span> <span class="n">iencoder</span> <span class="o">=</span> <span class="n">ids_encoder</span><span class="p">(</span><span class="n">ratings</span><span class="p">)</span>

<span class="n">users</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">ratings</span><span class="o">.</span><span class="n">userid</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
<span class="n">items</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">ratings</span><span class="o">.</span><span class="n">itemid</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>

<span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">users</span><span class="p">)</span>
<span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">)</span>

<span class="c1"># get examples as tuples of userids and itemids and labels from normalize ratings</span>
<span class="n">raw_examples</span><span class="p">,</span> <span class="n">raw_labels</span> <span class="o">=</span> <span class="n">get_examples</span><span class="p">(</span><span class="n">ratings</span><span class="p">)</span>

<span class="c1"># train test split</span>
<span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">x_test</span><span class="p">),</span> <span class="p">(</span><span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">examples</span><span class="o">=</span><span class="n">raw_examples</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">raw_labels</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># create the user to user model for similarity measure</span>
<span class="n">usertouser</span> <span class="o">=</span> <span class="n">UserToUser</span><span class="p">(</span><span class="n">ratings</span><span class="p">,</span> <span class="n">movies</span><span class="p">)</span>

<span class="c1"># compute explainable score</span>
<span class="n">W</span> <span class="o">=</span> <span class="n">explainable_score</span><span class="p">(</span><span class="n">usertouser</span><span class="p">,</span> <span class="n">users</span><span class="p">,</span> <span class="n">items</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Normalize users ratings ...
Initialize the similarity model ...
Compute nearest neighbors ...
User to user recommendation model created with success ...
Compute Explainable score. Progress status : 100.0%
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># initialize the model</span>
<span class="n">EMF</span> <span class="o">=</span> <span class="n">ExplainableMatrixFactorization</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">W</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">lamb</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="n">history</span> <span class="o">=</span> <span class="n">EMF</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="n">epochs</span><span class="p">,</span> <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Training EMF
k=10 	 alpha=0.01 	 beta=0.4 	 lambda=0.01
epoch 1/10 - loss : 0.782 - val_loss : 0.807
epoch 2/10 - loss : 0.762 - val_loss : 0.781
epoch 3/10 - loss : 0.76 - val_loss : 0.775
epoch 4/10 - loss : 0.758 - val_loss : 0.771
epoch 5/10 - loss : 0.757 - val_loss : 0.769
epoch 6/10 - loss : 0.756 - val_loss : 0.767
epoch 7/10 - loss : 0.754 - val_loss : 0.764
epoch 8/10 - loss : 0.752 - val_loss : 0.762
epoch 9/10 - loss : 0.751 - val_loss : 0.761
epoch 10/10 - loss : 0.75 - val_loss : 0.76
</pre></div>
</div>
</div>
</div>
<p><strong>Evaluation on normalized data</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># load data</span>
<span class="n">ratings</span><span class="p">,</span> <span class="n">movies</span> <span class="o">=</span> <span class="n">ml1m</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>

<span class="c1"># encode users and items ids</span>
<span class="n">ratings</span><span class="p">,</span> <span class="n">uencoder</span><span class="p">,</span> <span class="n">iencoder</span> <span class="o">=</span> <span class="n">ids_encoder</span><span class="p">(</span><span class="n">ratings</span><span class="p">)</span>

<span class="c1"># normalize ratings by substracting means</span>
<span class="n">normalized_column_name</span> <span class="o">=</span> <span class="s2">&quot;norm_rating&quot;</span>
<span class="n">ratings</span> <span class="o">=</span> <span class="n">normalized_ratings</span><span class="p">(</span><span class="n">ratings</span><span class="p">,</span> <span class="n">norm_column</span><span class="o">=</span><span class="n">normalized_column_name</span><span class="p">)</span>

<span class="c1"># get examples as tuples of userids and itemids and labels from normalize ratings</span>
<span class="n">raw_examples</span><span class="p">,</span> <span class="n">raw_labels</span> <span class="o">=</span> <span class="n">get_examples</span><span class="p">(</span><span class="n">ratings</span><span class="p">,</span> <span class="n">labels_column</span><span class="o">=</span><span class="n">normalized_column_name</span><span class="p">)</span>

<span class="c1"># train test split</span>
<span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">x_test</span><span class="p">),</span> <span class="p">(</span><span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">examples</span><span class="o">=</span><span class="n">raw_examples</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">raw_labels</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># initialize the model</span>
<span class="n">EMF</span> <span class="o">=</span> <span class="n">ExplainableMatrixFactorization</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">W</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.023</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="mf">0.59</span><span class="p">,</span> <span class="n">lamb</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="n">history</span> <span class="o">=</span> <span class="n">EMF</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="n">epochs</span><span class="p">,</span> <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Training EMF
k=10 	 alpha=0.023 	 beta=0.59 	 lambda=0.01
epoch 1/10 - loss : 0.805 - val_loss : 0.814
epoch 2/10 - loss : 0.764 - val_loss : 0.77
epoch 3/10 - loss : 0.756 - val_loss : 0.762
epoch 4/10 - loss : 0.755 - val_loss : 0.759
epoch 5/10 - loss : 0.754 - val_loss : 0.759
epoch 6/10 - loss : 0.754 - val_loss : 0.758
epoch 7/10 - loss : 0.754 - val_loss : 0.758
epoch 8/10 - loss : 0.753 - val_loss : 0.758
epoch 9/10 - loss : 0.753 - val_loss : 0.758
epoch 10/10 - loss : 0.753 - val_loss : 0.758
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="ratings-prediction">
<h3>Ratings prediction<a class="headerlink" href="#ratings-prediction" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># get list of top N items with their corresponding predicted ratings</span>
<span class="n">userid</span> <span class="o">=</span> <span class="mi">42</span>
<span class="n">recommended_items</span><span class="p">,</span> <span class="n">predictions</span> <span class="o">=</span> <span class="n">EMF</span><span class="o">.</span><span class="n">recommend</span><span class="p">(</span><span class="n">userid</span><span class="o">=</span><span class="n">userid</span><span class="p">)</span>

<span class="c1"># find corresponding movie titles</span>
<span class="n">top_N</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">recommended_items</span><span class="p">,</span><span class="n">predictions</span><span class="p">))</span>
<span class="n">top_N</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">top_N</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;itemid&#39;</span><span class="p">,</span><span class="s1">&#39;predictions&#39;</span><span class="p">])</span>
<span class="n">top_N</span><span class="o">.</span><span class="n">predictions</span> <span class="o">=</span> <span class="n">top_N</span><span class="o">.</span><span class="n">predictions</span> <span class="o">+</span> <span class="n">ratings</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ratings</span><span class="o">.</span><span class="n">userid</span><span class="o">==</span><span class="n">userid</span><span class="p">]</span><span class="o">.</span><span class="n">rating_mean</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">List</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">top_N</span><span class="p">,</span> <span class="n">movies</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;itemid&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">)</span>

<span class="c1"># show the list</span>
<span class="n">List</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>itemid</th>
      <th>predictions</th>
      <th>title</th>
      <th>genres</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>3460</td>
      <td>4.364036</td>
      <td>Hillbillys in a Haunted House (1967)</td>
      <td>Comedy</td>
    </tr>
    <tr>
      <th>1</th>
      <td>701</td>
      <td>4.324177</td>
      <td>Daens (1992)</td>
      <td>Drama</td>
    </tr>
    <tr>
      <th>2</th>
      <td>3057</td>
      <td>4.307404</td>
      <td>Where's Marlowe? (1999)</td>
      <td>Comedy</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2214</td>
      <td>4.304979</td>
      <td>Number Seventeen (1932)</td>
      <td>Thriller</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1145</td>
      <td>4.299559</td>
      <td>Snowriders (1996)</td>
      <td>Documentary</td>
    </tr>
    <tr>
      <th>5</th>
      <td>2258</td>
      <td>4.292125</td>
      <td>Master Ninja I (1984)</td>
      <td>Action</td>
    </tr>
    <tr>
      <th>6</th>
      <td>3353</td>
      <td>4.281912</td>
      <td>Closer You Get, The (2000)</td>
      <td>Comedy|Romance</td>
    </tr>
    <tr>
      <th>7</th>
      <td>868</td>
      <td>4.278937</td>
      <td>Death in Brunswick (1991)</td>
      <td>Comedy</td>
    </tr>
    <tr>
      <th>8</th>
      <td>826</td>
      <td>4.269901</td>
      <td>Diebinnen (1995)</td>
      <td>Drama</td>
    </tr>
    <tr>
      <th>9</th>
      <td>3305</td>
      <td>4.266769</td>
      <td>Bluebeard (1944)</td>
      <td>Film-Noir|Horror</td>
    </tr>
    <tr>
      <th>10</th>
      <td>2619</td>
      <td>4.265997</td>
      <td>Mascara (1999)</td>
      <td>Drama</td>
    </tr>
    <tr>
      <th>11</th>
      <td>763</td>
      <td>4.264092</td>
      <td>Last of the High Kings, The (a.k.a. Summer Fli...</td>
      <td>Drama</td>
    </tr>
    <tr>
      <th>12</th>
      <td>1852</td>
      <td>4.262517</td>
      <td>Love Walked In (1998)</td>
      <td>Drama|Thriller</td>
    </tr>
    <tr>
      <th>13</th>
      <td>642</td>
      <td>4.260353</td>
      <td>Roula (1995)</td>
      <td>Drama</td>
    </tr>
    <tr>
      <th>14</th>
      <td>682</td>
      <td>4.258829</td>
      <td>Tigrero: A Film That Was Never Made (1994)</td>
      <td>Documentary|Drama</td>
    </tr>
    <tr>
      <th>15</th>
      <td>792</td>
      <td>4.253339</td>
      <td>Hungarian Fairy Tale, A (1987)</td>
      <td>Fantasy</td>
    </tr>
    <tr>
      <th>16</th>
      <td>1316</td>
      <td>4.252915</td>
      <td>Anna (1996)</td>
      <td>Drama</td>
    </tr>
    <tr>
      <th>17</th>
      <td>3228</td>
      <td>4.245526</td>
      <td>Wirey Spindell (1999)</td>
      <td>Comedy</td>
    </tr>
    <tr>
      <th>18</th>
      <td>853</td>
      <td>4.240745</td>
      <td>Dingo (1992)</td>
      <td>Drama</td>
    </tr>
    <tr>
      <th>19</th>
      <td>3172</td>
      <td>4.238188</td>
      <td>Ulysses (Ulisse) (1954)</td>
      <td>Adventure</td>
    </tr>
    <tr>
      <th>20</th>
      <td>2254</td>
      <td>4.238008</td>
      <td>Choices (1981)</td>
      <td>Drama</td>
    </tr>
    <tr>
      <th>21</th>
      <td>2503</td>
      <td>4.234547</td>
      <td>Apple, The (Sib) (1998)</td>
      <td>Drama</td>
    </tr>
    <tr>
      <th>22</th>
      <td>2905</td>
      <td>4.224974</td>
      <td>Sanjuro (1962)</td>
      <td>Action|Adventure</td>
    </tr>
    <tr>
      <th>23</th>
      <td>744</td>
      <td>4.224278</td>
      <td>Brothers in Trouble (1995)</td>
      <td>Drama</td>
    </tr>
    <tr>
      <th>24</th>
      <td>757</td>
      <td>4.224226</td>
      <td>Ashes of Time (1994)</td>
      <td>Drama</td>
    </tr>
    <tr>
      <th>25</th>
      <td>858</td>
      <td>4.223665</td>
      <td>Godfather, The (1972)</td>
      <td>Action|Crime|Drama</td>
    </tr>
    <tr>
      <th>26</th>
      <td>789</td>
      <td>4.220788</td>
      <td>I, Worst of All (Yo, la peor de todas) (1990)</td>
      <td>Drama</td>
    </tr>
    <tr>
      <th>27</th>
      <td>3748</td>
      <td>4.216508</td>
      <td>Match, The (1999)</td>
      <td>Comedy|Romance</td>
    </tr>
    <tr>
      <th>28</th>
      <td>790</td>
      <td>4.216455</td>
      <td>An Unforgettable Summer (1994)</td>
      <td>Drama</td>
    </tr>
    <tr>
      <th>29</th>
      <td>745</td>
      <td>4.215986</td>
      <td>Close Shave, A (1995)</td>
      <td>Animation|Comedy|Thriller</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p><strong>Note</strong>: The recommendation list may content items already purchased by the user. This is just an illustration of how to implement matrix factorization recommender system. You can optimize the recommended list and return the top rated items that the user has not already purchased.</p>
</div>
<div class="section" id="id14">
<h3>Putting all together<a class="headerlink" href="#id14" title="Permalink to this headline">¶</a></h3>
<p>This repository covers the following algorithms for collaborative filtering</p>
<ol class="simple">
<li><p>User-based CF</p></li>
<li><p>Item-based CF</p></li>
<li><p>Singular Value Decomposition (SVD)</p></li>
<li><p>Matrix Factorization (MF)</p></li>
<li><p>Non-negative Matrix Factorization (NMF)</p></li>
<li><p>Explainable Matrix Factorization (EMF)</p></li>
</ol>
</div>
</div>
<div class="section" id="part-8-evaluation">
<h2>Part 8 - Evaluation<a class="headerlink" href="#part-8-evaluation" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><p>Collaborative Filtering on MovieLens Latest-small Part 8 - Evaluation of various methods.</p>
</div></blockquote>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>import os

if not (os.path.exists(&quot;recsys.zip&quot;) or os.path.exists(&quot;recsys&quot;)):
    !wget https://github.com/nzhinusoftcm/review-on-collaborative-filtering/raw/master/recsys.zip    
    !unzip recsys.zip
</pre></div>
</div>
</div>
</div>
<div class="section" id="id15">
<h3>requirements<a class="headerlink" href="#id15" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">matplotlib</span><span class="o">==</span><span class="mf">3.2</span><span class="o">.</span><span class="mi">2</span>
<span class="n">numpy</span><span class="o">==</span><span class="mf">1.19</span><span class="o">.</span><span class="mi">2</span>
<span class="n">pandas</span><span class="o">==</span><span class="mf">1.0</span><span class="o">.</span><span class="mi">5</span>
<span class="n">python</span><span class="o">==</span><span class="mf">3.7</span>
<span class="n">scikit</span><span class="o">-</span><span class="n">learn</span><span class="o">==</span><span class="mf">0.24</span><span class="o">.</span><span class="mi">1</span>
<span class="n">scikit</span><span class="o">-</span><span class="n">surprise</span><span class="o">==</span><span class="mf">1.1</span><span class="o">.</span><span class="mi">1</span>
<span class="n">scipy</span><span class="o">==</span><span class="mf">1.6</span><span class="o">.</span><span class="mi">2</span>
</pre></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">recsys.memories.UserToUser</span> <span class="kn">import</span> <span class="n">UserToUser</span>
<span class="kn">from</span> <span class="nn">recsys.memories.ItemToItem</span> <span class="kn">import</span> <span class="n">ItemToItem</span>

<span class="kn">from</span> <span class="nn">recsys.models.MatrixFactorization</span> <span class="kn">import</span> <span class="n">MF</span>
<span class="kn">from</span> <span class="nn">recsys.models.ExplainableMF</span> <span class="kn">import</span> <span class="n">EMF</span><span class="p">,</span> <span class="n">explainable_score</span>

<span class="kn">from</span> <span class="nn">recsys.preprocessing</span> <span class="kn">import</span> <span class="n">normalized_ratings</span>
<span class="kn">from</span> <span class="nn">recsys.preprocessing</span> <span class="kn">import</span> <span class="n">train_test_split</span>
<span class="kn">from</span> <span class="nn">recsys.preprocessing</span> <span class="kn">import</span> <span class="n">rating_matrix</span>
<span class="kn">from</span> <span class="nn">recsys.preprocessing</span> <span class="kn">import</span> <span class="n">scale_ratings</span>
<span class="kn">from</span> <span class="nn">recsys.preprocessing</span> <span class="kn">import</span> <span class="n">mean_ratings</span>
<span class="kn">from</span> <span class="nn">recsys.preprocessing</span> <span class="kn">import</span> <span class="n">get_examples</span>
<span class="kn">from</span> <span class="nn">recsys.preprocessing</span> <span class="kn">import</span> <span class="n">ids_encoder</span>

<span class="kn">from</span> <span class="nn">recsys.datasets</span> <span class="kn">import</span> <span class="n">ml100k</span>
<span class="kn">from</span> <span class="nn">recsys.datasets</span> <span class="kn">import</span> <span class="n">ml1m</span>

<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">LabelEncoder</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">import</span> <span class="nn">os</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="results-on-movielens-100k">
<h3>Results on MovieLens 100k<a class="headerlink" href="#results-on-movielens-100k" title="Permalink to this headline">¶</a></h3>
<div class="section" id="user-based-cf">
<h4>User-based CF<a class="headerlink" href="#user-based-cf" title="Permalink to this headline">¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">## load data</span>
<span class="n">ratings</span><span class="p">,</span> <span class="n">movies</span> <span class="o">=</span> <span class="n">ml100k</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>

<span class="c1">## prepare data</span>
<span class="n">ratings</span><span class="p">,</span> <span class="n">uencoder</span><span class="p">,</span> <span class="n">iencoder</span> <span class="o">=</span> <span class="n">ids_encoder</span><span class="p">(</span><span class="n">ratings</span><span class="p">)</span>

<span class="c1">## get examples as tuples of userids and itemids and labels from normalize ratings</span>
<span class="n">raw_examples</span><span class="p">,</span> <span class="n">raw_labels</span> <span class="o">=</span> <span class="n">get_examples</span><span class="p">(</span><span class="n">ratings</span><span class="p">,</span> <span class="n">labels_column</span><span class="o">=</span><span class="s1">&#39;rating&#39;</span><span class="p">)</span>

<span class="c1">## train test split</span>
<span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">x_test</span><span class="p">),</span> <span class="p">(</span><span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">examples</span><span class="o">=</span><span class="n">raw_examples</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">raw_labels</span><span class="p">)</span>

<span class="c1">## evaluate with Euclidean distance</span>
<span class="n">usertouser</span> <span class="o">=</span> <span class="n">UserToUser</span><span class="p">(</span><span class="n">ratings</span><span class="p">,</span> <span class="n">movies</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="s1">&#39;euclidean&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;==========================&quot;</span><span class="p">)</span>
<span class="n">usertouser</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Normalize users ratings ...
Initialize the similarity model ...
Compute nearest neighbors ...
User to user recommendation model created with success ...
==========================
Evaluate the model on 10000 test data ...

MAE : 0.8125945111976461
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.8125945111976461
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">## evaluate with cosine similarity</span>
<span class="n">usertouser</span> <span class="o">=</span> <span class="n">UserToUser</span><span class="p">(</span><span class="n">ratings</span><span class="p">,</span> <span class="n">movies</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="s1">&#39;cosine&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=========================&quot;</span><span class="p">)</span>
<span class="n">usertouser</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Normalize users ratings ...
Initialize the similarity model ...
Compute nearest neighbors ...
User to user recommendation model created with success ...
=========================
Evaluate the model on 10000 test data ...

MAE : 0.7505910931068639
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.7505910931068639
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="item-based-cf">
<h4>Item-based CF<a class="headerlink" href="#item-based-cf" title="Permalink to this headline">¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">## load data</span>
<span class="n">ratings</span><span class="p">,</span> <span class="n">movies</span> <span class="o">=</span> <span class="n">ml100k</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>

<span class="c1">## prepare data</span>
<span class="n">ratings</span><span class="p">,</span> <span class="n">uencoder</span><span class="p">,</span> <span class="n">iencoder</span> <span class="o">=</span> <span class="n">ids_encoder</span><span class="p">(</span><span class="n">ratings</span><span class="p">)</span>

<span class="c1">## get examples as tuples of userids and itemids and labels from normalize ratings</span>
<span class="n">raw_examples</span><span class="p">,</span> <span class="n">raw_labels</span> <span class="o">=</span> <span class="n">get_examples</span><span class="p">(</span><span class="n">ratings</span><span class="p">,</span> <span class="n">labels_column</span><span class="o">=</span><span class="s1">&#39;rating&#39;</span><span class="p">)</span>

<span class="c1">## train test split</span>
<span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">x_test</span><span class="p">),</span> <span class="p">(</span><span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">examples</span><span class="o">=</span><span class="n">raw_examples</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">raw_labels</span><span class="p">)</span>

<span class="c1">## evaluation with cosine similarity</span>
<span class="n">itemtoitem</span> <span class="o">=</span> <span class="n">ItemToItem</span><span class="p">(</span><span class="n">ratings</span><span class="p">,</span> <span class="n">movies</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="s1">&#39;cosine&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;==================&quot;</span><span class="p">)</span>
<span class="n">itemtoitem</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Normalize ratings ...
Create the similarity model ...
Compute nearest neighbors ...
Item to item recommendation model created with success ...
==================
Evaluate the model on 10000 test data ...

MAE : 0.507794195659005
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.507794195659005
</pre></div>
</div>
</div>
</div>
<p><strong>Evaluation with Euclidean distance</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">## evaluation with Euclidean distance</span>
<span class="n">itemtoitem</span> <span class="o">=</span> <span class="n">ItemToItem</span><span class="p">(</span><span class="n">ratings</span><span class="p">,</span> <span class="n">movies</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="s1">&#39;euclidean&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;==================&quot;</span><span class="p">)</span>
<span class="n">itemtoitem</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Normalize ratings ...
Create the similarity model ...
Compute nearest neighbors ...
Item to item recommendation model created with success ...
==================
Evaluate the model on 10000 test data ...

MAE : 0.8277111416143341
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.8277111416143341
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="id16">
<h4>Matrix Factorization<a class="headerlink" href="#id16" title="Permalink to this headline">¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">epochs</span> <span class="o">=</span> <span class="mi">10</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">## load the ml100k dataset</span>
<span class="n">ratings</span><span class="p">,</span> <span class="n">movies</span> <span class="o">=</span> <span class="n">ml100k</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>

<span class="n">ratings</span><span class="p">,</span> <span class="n">uencoder</span><span class="p">,</span> <span class="n">iencoder</span> <span class="o">=</span> <span class="n">ids_encoder</span><span class="p">(</span><span class="n">ratings</span><span class="p">)</span>

<span class="n">m</span> <span class="o">=</span> <span class="n">ratings</span><span class="o">.</span><span class="n">userid</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span>   <span class="c1">## total number of users</span>
<span class="n">n</span> <span class="o">=</span> <span class="n">ratings</span><span class="o">.</span><span class="n">itemid</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span>   <span class="c1">## total number of items</span>

<span class="c1">## get examples as tuples of userids and itemids and labels from normalize ratings</span>
<span class="n">raw_examples</span><span class="p">,</span> <span class="n">raw_labels</span> <span class="o">=</span> <span class="n">get_examples</span><span class="p">(</span><span class="n">ratings</span><span class="p">)</span>

<span class="c1">## train test split</span>
<span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">x_test</span><span class="p">),</span> <span class="p">(</span><span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">examples</span><span class="o">=</span><span class="n">raw_examples</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">raw_labels</span><span class="p">)</span>

<span class="c1">## create and train the model</span>
<span class="n">mf</span> <span class="o">=</span> <span class="n">MF</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">lamb</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>

<span class="c1">## fit the model on the training set</span>
<span class="n">history</span> <span class="o">=</span> <span class="n">mf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="n">epochs</span><span class="p">,</span> <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Training Matrix Factorization Model ...
k=10 	 alpha=0.01 	 lambda=1.5
epoch 1/10 - loss : 2.734 - val_loss : 2.779
epoch 2/10 - loss : 1.764 - val_loss : 1.794
epoch 3/10 - loss : 1.592 - val_loss : 1.614
epoch 4/10 - loss : 1.538 - val_loss : 1.556
epoch 5/10 - loss : 1.515 - val_loss : 1.531
epoch 6/10 - loss : 1.503 - val_loss : 1.517
epoch 7/10 - loss : 1.496 - val_loss : 1.509
epoch 8/10 - loss : 1.491 - val_loss : 1.504
epoch 9/10 - loss : 1.488 - val_loss : 1.5
epoch 10/10 - loss : 1.486 - val_loss : 1.497
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="id17">
<h4>Non-negative Matrix Factorization<a class="headerlink" href="#id17" title="Permalink to this headline">¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">surprise</span> <span class="kn">import</span> <span class="n">NMF</span>
<span class="kn">from</span> <span class="nn">surprise</span> <span class="kn">import</span> <span class="n">Dataset</span>
<span class="kn">from</span> <span class="nn">surprise.model_selection</span> <span class="kn">import</span> <span class="n">cross_validate</span>

<span class="c1">## Load the movielens-100k dataset (download it if needed).</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">Dataset</span><span class="o">.</span><span class="n">load_builtin</span><span class="p">(</span><span class="s1">&#39;ml-100k&#39;</span><span class="p">)</span>

<span class="c1">## Use the NMF algorithm.</span>
<span class="n">nmf</span> <span class="o">=</span> <span class="n">NMF</span><span class="p">(</span><span class="n">n_factors</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">n_epochs</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="c1">## Run 5-fold cross-validation and print results.</span>
<span class="n">history</span> <span class="o">=</span> <span class="n">cross_validate</span><span class="p">(</span><span class="n">nmf</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">measures</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;MAE&#39;</span><span class="p">],</span> <span class="n">cv</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evaluating MAE of algorithm NMF on 5 split(s).

                  Fold 1  Fold 2  Fold 3  Fold 4  Fold 5  Mean    Std     
MAE (testset)     0.9615  0.9501  0.9548  0.9582  0.9675  0.9584  0.0059  
Fit time          0.67    0.72    0.79    0.72    0.72    0.72    0.04    
Test time         0.15    0.09    0.16    0.10    0.14    0.13    0.03    
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="id18">
<h4>Explainable Matrix Factorization<a class="headerlink" href="#id18" title="Permalink to this headline">¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">## load data</span>
<span class="n">ratings</span><span class="p">,</span> <span class="n">movies</span> <span class="o">=</span> <span class="n">ml100k</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>

<span class="c1">## encode users and items ids</span>
<span class="n">ratings</span><span class="p">,</span> <span class="n">uencoder</span><span class="p">,</span> <span class="n">iencoder</span> <span class="o">=</span> <span class="n">ids_encoder</span><span class="p">(</span><span class="n">ratings</span><span class="p">)</span>

<span class="n">users</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">ratings</span><span class="o">.</span><span class="n">userid</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
<span class="n">items</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">ratings</span><span class="o">.</span><span class="n">itemid</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>

<span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">users</span><span class="p">)</span>
<span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">)</span>

<span class="c1">## get examples as tuples of userids and itemids and labels from normalize ratings</span>
<span class="n">raw_examples</span><span class="p">,</span> <span class="n">raw_labels</span> <span class="o">=</span> <span class="n">get_examples</span><span class="p">(</span><span class="n">ratings</span><span class="p">)</span>

<span class="c1">## train test split</span>
<span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">x_test</span><span class="p">),</span> <span class="p">(</span><span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">examples</span><span class="o">=</span><span class="n">raw_examples</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">raw_labels</span><span class="p">)</span>

<span class="c1">## create the user to user model for similarity measure</span>
<span class="n">usertouser</span> <span class="o">=</span> <span class="n">UserToUser</span><span class="p">(</span><span class="n">ratings</span><span class="p">,</span> <span class="n">movies</span><span class="p">)</span>

<span class="c1">## compute explainable score</span>
<span class="n">W</span> <span class="o">=</span> <span class="n">explainable_score</span><span class="p">(</span><span class="n">usertouser</span><span class="p">,</span> <span class="n">users</span><span class="p">,</span> <span class="n">items</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;===================&quot;</span><span class="p">)</span>
<span class="c1">## initialize the model</span>
<span class="n">emf</span> <span class="o">=</span> <span class="n">EMF</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">W</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">lamb</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="n">history</span> <span class="o">=</span> <span class="n">emf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="n">epochs</span><span class="p">,</span> <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;===================&quot;</span><span class="p">)</span>
<span class="n">emf</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Normalize users ratings ...
Initialize the similarity model ...
Compute nearest neighbors ...
User to user recommendation model created with success ...
Compute explainable scores ...
===================
Training EMF
k=10 	 alpha=0.01 	 beta=0.4 	 lambda=0.01
epoch 1/10 - loss : 0.922 - val_loss : 1.036
epoch 2/10 - loss : 0.79 - val_loss : 0.873
epoch 3/10 - loss : 0.766 - val_loss : 0.837
epoch 4/10 - loss : 0.757 - val_loss : 0.822
epoch 5/10 - loss : 0.753 - val_loss : 0.814
epoch 6/10 - loss : 0.751 - val_loss : 0.808
epoch 7/10 - loss : 0.749 - val_loss : 0.805
epoch 8/10 - loss : 0.748 - val_loss : 0.802
epoch 9/10 - loss : 0.746 - val_loss : 0.799
epoch 10/10 - loss : 0.745 - val_loss : 0.797
===================
MAE : 0.797
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.7973478247232839
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="results-on-movielens-1m-ml-1m">
<h3>Results on MovieLens 1M (ML-1M)<a class="headerlink" href="#results-on-movielens-1m-ml-1m" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id19">
<h4>User-based CF<a class="headerlink" href="#id19" title="Permalink to this headline">¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">## load ml100k ratings</span>
<span class="n">ratings</span><span class="p">,</span> <span class="n">movies</span> <span class="o">=</span> <span class="n">ml1m</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>

<span class="c1">## prepare data</span>
<span class="n">ratings</span><span class="p">,</span> <span class="n">uencoder</span><span class="p">,</span> <span class="n">iencoder</span> <span class="o">=</span> <span class="n">ids_encoder</span><span class="p">(</span><span class="n">ratings</span><span class="p">)</span>

<span class="c1">## get examples as tuples of userids and itemids and labels from normalize ratings</span>
<span class="n">raw_examples</span><span class="p">,</span> <span class="n">raw_labels</span> <span class="o">=</span> <span class="n">get_examples</span><span class="p">(</span><span class="n">ratings</span><span class="p">,</span> <span class="n">labels_column</span><span class="o">=</span><span class="s1">&#39;rating&#39;</span><span class="p">)</span>

<span class="c1">## train test split</span>
<span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">x_test</span><span class="p">),</span> <span class="p">(</span><span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">examples</span><span class="o">=</span><span class="n">raw_examples</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">raw_labels</span><span class="p">)</span>

<span class="c1">## metric : cosine</span>

<span class="c1">## create the user-based CF</span>
<span class="n">usertouser</span> <span class="o">=</span> <span class="n">UserToUser</span><span class="p">(</span><span class="n">ratings</span><span class="p">,</span> <span class="n">movies</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="s1">&#39;cosine&#39;</span><span class="p">)</span>

<span class="c1">## evaluate the user-based CF on the ml1m test data</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;==========================&quot;</span><span class="p">)</span>
<span class="n">usertouser</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Normalize users ratings ...
Initialize the similarity model ...
Compute nearest neighbors ...
User to user recommendation model created with success ...
==========================
Evaluate the model on 100021 test data ...

MAE : 0.732267005840993
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.732267005840993
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">## metric : euclidean</span>

<span class="c1">## create the user-based CF</span>
<span class="n">usertouser</span> <span class="o">=</span> <span class="n">UserToUser</span><span class="p">(</span><span class="n">ratings</span><span class="p">,</span> <span class="n">movies</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="s1">&#39;euclidean&#39;</span><span class="p">)</span>

<span class="c1">## evaluate the user-based CF on the ml1m test data</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;==========================&quot;</span><span class="p">)</span>
<span class="n">usertouser</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Normalize users ratings ...
Initialize the similarity model ...
Compute nearest neighbors ...
User to user recommendation model created with success ...
==========================
Evaluate the model on 100021 test data ...

MAE : 0.8069332535426615
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.8069332535426615
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="id20">
<h4>Item-based CF<a class="headerlink" href="#id20" title="Permalink to this headline">¶</a></h4>
<p><strong>Cosine similarity</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">itemtoitem</span> <span class="o">=</span> <span class="n">ItemToItem</span><span class="p">(</span><span class="n">ratings</span><span class="p">,</span> <span class="n">movies</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="s1">&#39;cosine&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;==========================&quot;</span><span class="p">)</span>
<span class="n">itemtoitem</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Normalize ratings ...
Create the similarity model ...
Compute nearest neighbors ...
Item to item recommendation model created with success ...
==========================
Evaluate the model on 100021 test data ...

MAE : 0.42514728655396045
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.42514728655396045
</pre></div>
</div>
</div>
</div>
<p><strong>Euclidean distance</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">itemtoitem</span> <span class="o">=</span> <span class="n">ItemToItem</span><span class="p">(</span><span class="n">ratings</span><span class="p">,</span> <span class="n">movies</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="s1">&#39;euclidean&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;==========================&quot;</span><span class="p">)</span>
<span class="n">itemtoitem</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Normalize ratings ...
Create the similarity model ...
Compute nearest neighbors ...
Item to item recommendation model created with success ...
==========================
Evaluate the model on 100021 test data ...

MAE : 0.82502173206615
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.82502173206615
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="id21">
<h4>Matrix Factorization<a class="headerlink" href="#id21" title="Permalink to this headline">¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">## load the ml1m dataset</span>
<span class="n">ratings</span><span class="p">,</span> <span class="n">movies</span> <span class="o">=</span> <span class="n">ml1m</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>

<span class="n">ratings</span><span class="p">,</span> <span class="n">uencoder</span><span class="p">,</span> <span class="n">iencoder</span> <span class="o">=</span> <span class="n">ids_encoder</span><span class="p">(</span><span class="n">ratings</span><span class="p">)</span>

<span class="n">m</span> <span class="o">=</span> <span class="n">ratings</span><span class="o">.</span><span class="n">userid</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span>   <span class="c1">## total number of users</span>
<span class="n">n</span> <span class="o">=</span> <span class="n">ratings</span><span class="o">.</span><span class="n">itemid</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span>   <span class="c1">## total number of items</span>

<span class="c1">## get examples as tuples of userids and itemids and labels from normalize ratings</span>
<span class="n">raw_examples</span><span class="p">,</span> <span class="n">raw_labels</span> <span class="o">=</span> <span class="n">get_examples</span><span class="p">(</span><span class="n">ratings</span><span class="p">)</span>

<span class="c1">## train test split</span>
<span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">x_test</span><span class="p">),</span> <span class="p">(</span><span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">examples</span><span class="o">=</span><span class="n">raw_examples</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">raw_labels</span><span class="p">)</span>

<span class="c1">## create the model</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">MF</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">lamb</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>

<span class="c1">## fit the model on the training set</span>
<span class="n">history</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="n">epochs</span><span class="p">,</span> <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;===================&quot;</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Training Matrix Factorization Model ...
k=10 	 alpha=0.01 	 lambda=1.5
epoch 1/10 - loss : 1.713 - val_loss : 1.718
epoch 2/10 - loss : 1.523 - val_loss : 1.526
epoch 3/10 - loss : 1.496 - val_loss : 1.498
epoch 4/10 - loss : 1.489 - val_loss : 1.489
epoch 5/10 - loss : 1.485 - val_loss : 1.486
epoch 6/10 - loss : 1.484 - val_loss : 1.484
epoch 7/10 - loss : 1.483 - val_loss : 1.483
epoch 8/10 - loss : 1.483 - val_loss : 1.483
epoch 9/10 - loss : 1.482 - val_loss : 1.482
epoch 10/10 - loss : 1.482 - val_loss : 1.482
===================
validation error : 1.482
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.4820034560467208
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="id22">
<h4>Non-negative Matrix Factorization<a class="headerlink" href="#id22" title="Permalink to this headline">¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">surprise</span> <span class="kn">import</span> <span class="n">NMF</span>
<span class="kn">from</span> <span class="nn">surprise</span> <span class="kn">import</span> <span class="n">Dataset</span>
<span class="kn">from</span> <span class="nn">surprise.model_selection</span> <span class="kn">import</span> <span class="n">cross_validate</span>

<span class="c1">## Load the movielens-100k dataset (download it if needed).</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">Dataset</span><span class="o">.</span><span class="n">load_builtin</span><span class="p">(</span><span class="s1">&#39;ml-1m&#39;</span><span class="p">)</span>

<span class="c1">## Use the NMF algorithm.</span>
<span class="n">nmf</span> <span class="o">=</span> <span class="n">NMF</span><span class="p">(</span><span class="n">n_factors</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">n_epochs</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="c1">## Run 5-fold cross-validation and print results.</span>
<span class="n">history</span> <span class="o">=</span> <span class="n">cross_validate</span><span class="p">(</span><span class="n">nmf</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">measures</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;MAE&#39;</span><span class="p">],</span> <span class="n">cv</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evaluating MAE of algorithm NMF on 5 split(s).

                  Fold 1  Fold 2  Fold 3  Fold 4  Fold 5  Mean    Std     
MAE (testset)     0.9435  0.9456  0.9527  0.9546  0.9524  0.9498  0.0044  
Fit time          6.35    6.51    6.52    6.52    6.55    6.49    0.07    
Test time         1.20    1.47    1.46    1.47    1.47    1.42    0.11    
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="id23">
<h4>Explainable Matrix Factorization<a class="headerlink" href="#id23" title="Permalink to this headline">¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">## load data</span>
<span class="n">ratings</span><span class="p">,</span> <span class="n">movies</span> <span class="o">=</span> <span class="n">ml1m</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>

<span class="c1">## encode users and items ids</span>
<span class="n">ratings</span><span class="p">,</span> <span class="n">uencoder</span><span class="p">,</span> <span class="n">iencoder</span> <span class="o">=</span> <span class="n">ids_encoder</span><span class="p">(</span><span class="n">ratings</span><span class="p">)</span>

<span class="n">users</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">ratings</span><span class="o">.</span><span class="n">userid</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
<span class="n">items</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">ratings</span><span class="o">.</span><span class="n">itemid</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>

<span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">users</span><span class="p">)</span>
<span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">)</span>

<span class="c1">## get examples as tuples of userids and itemids and labels from normalize ratings</span>
<span class="n">raw_examples</span><span class="p">,</span> <span class="n">raw_labels</span> <span class="o">=</span> <span class="n">get_examples</span><span class="p">(</span><span class="n">ratings</span><span class="p">)</span>

<span class="c1">## train test split</span>
<span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">x_test</span><span class="p">),</span> <span class="p">(</span><span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">examples</span><span class="o">=</span><span class="n">raw_examples</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">raw_labels</span><span class="p">)</span>

<span class="c1">## create the user to user model for similarity measure</span>
<span class="n">usertouser</span> <span class="o">=</span> <span class="n">UserToUser</span><span class="p">(</span><span class="n">ratings</span><span class="p">,</span> <span class="n">movies</span><span class="p">)</span>

<span class="c1">## compute explainable score</span>
<span class="n">W</span> <span class="o">=</span> <span class="n">explainable_score</span><span class="p">(</span><span class="n">usertouser</span><span class="p">,</span> <span class="n">users</span><span class="p">,</span> <span class="n">items</span><span class="p">)</span>

<span class="c1">## initialize the model</span>
<span class="n">emf</span> <span class="o">=</span> <span class="n">EMF</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">W</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">lamb</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="n">history</span> <span class="o">=</span> <span class="n">emf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="n">epochs</span><span class="p">,</span> <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Normalize users ratings ...
Initialize the similarity model ...
Compute nearest neighbors ...
User to user recommendation model created with success ...
Compute explainable scores ...
Training EMF
k=10 	 alpha=0.01 	 beta=0.4 	 lambda=0.01
epoch 1/10 - loss : 0.782 - val_loss : 0.807
epoch 2/10 - loss : 0.762 - val_loss : 0.781
epoch 3/10 - loss : 0.76 - val_loss : 0.775
epoch 4/10 - loss : 0.758 - val_loss : 0.771
epoch 5/10 - loss : 0.757 - val_loss : 0.769
epoch 6/10 - loss : 0.756 - val_loss : 0.767
epoch 7/10 - loss : 0.754 - val_loss : 0.764
epoch 8/10 - loss : 0.752 - val_loss : 0.762
epoch 9/10 - loss : 0.751 - val_loss : 0.761
epoch 10/10 - loss : 0.75 - val_loss : 0.76
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="id24">
<h3>Summary<a class="headerlink" href="#id24" title="Permalink to this headline">¶</a></h3>
<center> <b> MAE comparison between User-based and Item-based CF </b> </center>
<table class="colwidths-auto table">
<thead>
<tr class="row-odd"><th class="text-align:center head"><p>Metric</p></th>
<th class="text-align:center head"><p>Dataset</p></th>
<th class="text-align:center head"><p>User-based</p></th>
<th class="text-align:center head"><p>Item-based</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td class="text-align:center"><p>Euclidean</p></td>
<td class="text-align:center"><p>ML-100k</p></td>
<td class="text-align:center"><p>0.81</p></td>
<td class="text-align:center"><p>0.83</p></td>
</tr>
<tr class="row-odd"><td class="text-align:center"><p>Euclidean</p></td>
<td class="text-align:center"><p>ML-1M</p></td>
<td class="text-align:center"><p>0.81</p></td>
<td class="text-align:center"><p>0.82</p></td>
</tr>
<tr class="row-even"><td class="text-align:center"><p>Cosine</p></td>
<td class="text-align:center"><p>ML-100k</p></td>
<td class="text-align:center"><p>0.75</p></td>
<td class="text-align:center"><p>0.51</p></td>
</tr>
<tr class="row-odd"><td class="text-align:center"><p>Cosine</p></td>
<td class="text-align:center"><p>ML-1M</p></td>
<td class="text-align:center"><p>0.73</p></td>
<td class="text-align:center"><p>0.42</p></td>
</tr>
</tbody>
</table>
<hr class="docutils" />
<center> <b> MAE comparison between MF, NMF and EMF </b> </center>
<table class="colwidths-auto table">
<thead>
<tr class="row-odd"><th class="text-align:center head"><p>Preprocessing</p></th>
<th class="text-align:center head"><p>Dataset</p></th>
<th class="text-align:center head"><p>MF</p></th>
<th class="text-align:center head"><p>NMF</p></th>
<th class="head"><p>EMF</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td class="text-align:center"><p>Raw data</p></td>
<td class="text-align:center"><p>ML-100k</p></td>
<td class="text-align:center"><p>1.497</p></td>
<td class="text-align:center"><p>0.951</p></td>
<td><p>0.797</p></td>
</tr>
<tr class="row-odd"><td class="text-align:center"><p>Raw data</p></td>
<td class="text-align:center"><p>ML-1M</p></td>
<td class="text-align:center"><p>1.482</p></td>
<td class="text-align:center"><p>0.9567</p></td>
<td><p>0.76</p></td>
</tr>
<tr class="row-even"><td class="text-align:center"><p>Normalized data</p></td>
<td class="text-align:center"><p>ML-100k</p></td>
<td class="text-align:center"><p>0.828</p></td>
<td class="text-align:center"><p>—</p></td>
<td><p>0.783</p></td>
</tr>
<tr class="row-odd"><td class="text-align:center"><p>Normalized data</p></td>
<td class="text-align:center"><p>ML-1M</p></td>
<td class="text-align:center"><p>0.825</p></td>
<td class="text-align:center"><p>—</p></td>
<td><p>0.758</p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./nbs"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        
            



<div class='prev-next-bottom'>
    
    <div id="prev">
        <a class="left-prev" href="T022961_Amazon_Personalize_Workshop.html" title="previous page">
            <i class="prevnext-label fas fa-angle-left"></i>
            <div class="prevnext-info">
                <p class="prevnext-label">previous</p>
                <p class="prevnext-title">Amazon Personalize Workshop</p>
            </div>
        </a>
    </div>
     <div id="next">
        <a class="right-next" href="T539160_Building_and_Deploying_ASOS_Fashion_Recommender.html" title="next page">
            <div class="prevnext-info">
                <p class="prevnext-label">next</p>
                <p class="prevnext-title">Building and deploying ASOS fashion recommender</p>
            </div>
            <i class="prevnext-label fas fa-angle-right"></i>
        </a>
     </div>

</div>
        
        </div>
    </div>
    <footer class="footer">
    <div class="container">
      <p>
        
          By Sparsh A.<br/>
        
            &copy; Copyright 2021.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>
  
  <script src="../_static/js/index.1c5a1a01449ed65a7b51.js"></script>

  
  </body>
</html>