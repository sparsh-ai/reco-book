
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sequence Aware Recommender Systems &#8212; Reco Book</title>
    
  <link href="../_static/css/theme.css" rel="stylesheet" />
  <link href="../_static/css/index.c5995385ac14fb8791e8eb36b4908be2.css" rel="stylesheet" />

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/sphinx-book-theme.css?digest=c3fdc42140077d1ad13ad2f1588a4309" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../_static/js/index.1c5a1a01449ed65a7b51.js">

    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/togglebutton.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/sphinx-book-theme.12a9622fbb08dcb3a2a40b2c02b83a57.js"></script>
    <script async="async" src="https://unpkg.com/thebe@0.5.1/lib/index.js"></script>
    <script >
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Similar Product Recommendations" href="T051777_image_similarity_recommendations.html" />
    <link rel="prev" title="Retail Product Recommendation with Negative Implicit Feedback" href="T501828_Recommender_Implicit_Negative_Feedback.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
      
      
      <h1 class="site-logo" id="site-title">Reco Book</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../index.html">
   Tutorials in Jupyter notebook format
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  User Stories
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="US780867_Transformer_based_Recommenders.html">
   Transformer-based Recommenders
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="T034923_BERT4Rec_on_ML1M_in_PyTorch.html">
     BERT4Rec on ML-1M in PyTorch
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="T595874_BERT4Rec_on_ML25M_in_PyTorch_Lightning.html">
     BERT4Rec on ML-25M
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="T088416_BST_Implementation_in_MXNet.html">
     BST Implementation in MXNet
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="T602245_BST_implementation_in_PyTorch.html">
     BST implementation in PyTorch
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="T007665_BST_on_ML1M_in_Keras.html">
     A Transformer-based recommendation system
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="T881207_BST_PTLightning_ML1M.html">
     Rating prediction using the Behavior Sequence Transformer (BST) model on ML-1M dataset in PyTorch Lightning
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="T757997_SASRec_PyTorch.html">
     SASRec implementation with PyTorch Library
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="T225287_SASRec_PaddlePaddle.html">
     SASRec implementation with Paddle Library
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="T701627_SR_SAN_Session_based_Model.html">
     SR-SAN Session-based Recommender
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="T975104_SSEPT_ML1M_Tensorflow1x.html">
     SSE-PT Personalized Transformer Recommender on ML-1M in Tensorflow 1.x
    </a>
   </li>
  </ul>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Prototypes
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="T382881_DeepWalk_Karateclub.html">
   DeepWalk from scratch referencing Karateclub library
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T384270_DeepWalk_pure_python.html">
   DeepWalk in pure python
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T677598_Jaccard_Cosine_SVD_DeepWalk_ML100K.html">
   Recommender System with DeepWalk Graph Embeddings
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T815556_Node2vec_Karateclub.html">
   Node2vec from scratch referencing Karateclub library
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T894941_Node2vec_MovieLens_Keras.html">
   Graph representation learning with node2vec
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T611050_Node2vec_PyG.html">
   Node2vec from scratch in PyTorch Geometric
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T186367_Node2vec_library.html">
   Node2vec from scratch referencing node2vec library
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T331379_bayesian_personalized_ranking.html">
   BPR from scratch
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T081831_Data_Poisoning_Attacks_on_Factorization_Based_Collaborative_Filtering.html">
   Data Poisoning Attacks on Factorization-Based Collaborative Filtering
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T102448_Adversarial_Learning_for_Recommendation.html">
   Adversarial Training (Regularization) on a Recommender System
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T865035_Simulating_Data_Poisoning_Attacks_against_Twitter_Recommender.html">
   Load and process dataset
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T711285_Data_Poisoning_Attack_using_LFM_and_ItemAE_on_Synthetic_Dataset.html">
   Injection attack using LFM and ItemAE model trained on Toy dataset
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T355514_Black_box_Attack_on_Sequential_Recs.html">
   Black-box Attack on Sequential Recs
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T873451_Statistics_fundamentals.html">
   Statictics Fundamentals
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T890478_Batch_Learning_from_Bandit_Feedback_%28BLBF%29.html">
   Imports
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T257798_Off_Policy_Learning_in_Two_stage_Recommender_Systems.html">
   Off-Policy Learning in Two-stage Recommender Systems
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T471827_Adaptive_Estimator_Selection_for_Off_Policy_Evaluation.html">
   Adaptive Estimator Selection for Off-Policy Evaluation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T902666_Evaluating_the_Robustness_of_Off_Policy_Evaluation.html">
   Evaluating the Robustness of Off-Policy Evaluation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T705904_Evaluation_of_Multiple_Off_Policy_Estimators_on_Synthetic_Dataset.html">
   Evaluation of Multiple Off-Policy Estimators on Synthetic Dataset
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T874693_Evaluating_Standard_Off_Policy_Estimators_with_Small_Sample_Open_Bandit_Dataset.html">
   Evaluating Standard Off-Policy Estimators with Small Sample Open-Bandit Dataset
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T792262_Optimal_Off_Policy_Evaluation_from_Multiple_Logging_Policies.html">
   Optimal Off-Policy Evaluation from Multiple Logging Policies
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T167249_Offline_Policy_Evaluation_with_VW_Command_Line.html">
   Offline Policy Evaluation with VW Command Line
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T966055_OBP_Library_Workshop_Tutorials.html">
   OBP Library Workshop Tutorials
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T632722_PyTorch_Fundamentals_Part_1.html">
   PyTorch Fundamentals Part 1
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T472467_PyTorch_Fundamentals_Part_2.html">
   PyTorch Fundamentals Part 2
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T206654_PyTorch_Fundamentals_Part_3.html">
   PyTorch Fundamentals Part 3
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T536348_Attention_Mechanisms.html">
   Imports
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T500796_Agricultural_Satellite_Image_Segmentation.html">
   Agricultural Satellite Image Segmentation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T611432_Image_Analysis_with_Tensorflow.html">
   Image Analysis with Tensorflow
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T925716_MongoDB_to_CSV_Conversion.html">
   MongoDB to CSV conversion
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T396469_PDF_to_Word_Cloud_via_Email.html">
   PDF to WordCloud via Email
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T030890_Job_Scraping_and_Clustering.html">
   Job scraping and clustering
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T897054_Scene_Text_Recognition.html">
   Scene Text Recognition
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T034809_Large_scale_Document_Retrieval_with_Elastic_Search.html">
   Large-scale Document Retrieval with ElasticSearch
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T467251_vowpal_wabbit_contextual_recommender.html">
   Simulating a news personalization scenario using Contextual Bandits
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T686684_similar_product_recommender.html">
   Similar Product Recommender system using Deep Learning for an online e-commerce store
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T132203_Retail_Product_Recommendations_using_Word2vec.html">
   Retail Product Recommendations using word2vec
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T501828_Recommender_Implicit_Negative_Feedback.html">
   Retail Product Recommendation with Negative Implicit Feedback
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Sequence Aware Recommender Systems
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T051777_image_similarity_recommendations.html">
   Similar Product Recommendations
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990172_recobook_diversity_aware_book_recommender.html">
   Diversity Aware Book Recommender
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T488549_Goodreads_Diversity_Aware_Book_Recommender.html">
   Diversity Aware Book Recommender
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T023535_Kafka_MongoDB_Real_time_Streaming.html">
   Kafka MongoDB Real-time Streaming
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T622304_Session_based_Recommender_Using_Word2vec.html">
   Session-based recommendation using word2vec
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T416854_bandit_based_recommender_using_thompson_sampling_app.html">
   Bandit-based Online Learning using Thompson Sampling
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T198578_Booking_dot_com_Trip_Recommendation.html">
   Booking.com Trip Recommendation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T519734_Vowpal_Wabbit_Contextual_Bandit.html">
   Vowpal Wabbit Contextual Bandit
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T871537_Recommendation_Systems_using_Olist_Dataset.html">
   Recommendation systems using Olist dataset
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T057885_Offline_Replayer_Evaluation.html">
   Offline Replayer Evaluation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T915054_method_for_effective_online_testing.html">
   Methods for effective online testing
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T513987_Recsys_2020_Feature_Engineering_Tutorial.html">
   Recsys’20 Feature Engineering Tutorial
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T227901_amazon_personalize_batch_job.html">
   Amazon Personalize Batch Job
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T022961_Amazon_Personalize_Workshop.html">
   Amazon Personalize Workshop
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T424437_Collaborative_Filtering_on_ML_latest_small.html">
   Collaborative Filtering on ML-latest-small
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T539160_Building_and_Deploying_ASOS_Fashion_Recommender.html">
   Building and deploying ASOS fashion recommender
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T757697_Simple_Similarity_based_Recommender.html">
   Simple Similarity based Recommmendations
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T051594_Analytics_Zoo.html">
   Analytics Zoo
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T313645_A_B_Testing.html">
   A/B Testing
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T475711_PinSage_Graph_based_Recommender.html">
   PinSage Graph-based Recommender
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T516490_Graph_Embeddings.html">
   Learn Embeddings using Graph Networks
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T822164_movielens_milvus_redis_efficient_retrieval.html">
   Recommender with Redis and Milvus
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T845186_Anime_Recommender.html">
   RekoNet Anime Recommender
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T855843_kafka_spark_streaming_colab.html">
   Kafka and Spark Streaming in Colab
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T460437_Building_Models_From_Scratch.html">
   Building Models from scratch
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T855971_Conet_Model_for_Movie_Recommender.html">
   CoNet model
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T996996_content_based_and_collaborative_movielens.html">
   Movie Recommendation with Content-Based and Collaborative Filtering
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T239418_Simple_Movie_Recommenders.html">
   Simple Movie Recommenders
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T138337_Simple_Movie_Recommender.html">
   Simple movie recommender in implicit, explicit, and cold-start settings
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T935440_The_importance_of_Rating_Normalization.html">
   The importance of Rating Normalization
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T612622_cornac_examples.html">
   Cornac Examples
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T561435_Flower_Classification.html">
   Flower classification
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T680910_Trivago_Session_based_Recommender.html">
   Trivago Session-based Recommender
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990000_ads_selection_using_bandits.html">
   Best Ads detection using bandit methods
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990000_book_crossing_surprise_svd_nmf.html">
   Book-Crossing Recommendation System
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990000_book_recommender_kubeflow.html">
   Books recommendations with Kubeflow Pipelines on Scaleway Kapsule
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990000_build_a_kubeflow_pipeline.html">
   Build a Kubeflow Pipeline
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990000_causal_inference.html">
   Causal Inference
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990000_concept_embedding_nlp.html">
   Exploring Word Embeddings
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990000_concept_neural_net.html">
   Neural Network
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990000_concept_nlp_basics.html">
   Natural Language Processing 101
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990000_concept_transformer_lm.html">
   TransformerLM Quick Start and Guide
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990000_content_based_music_recommender_lyricsfreak.html">
   Content-based method for song recommendation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990000_evaluation_metrics_basics.html">
   Recommender System Evaluations
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990000_implicit_synthetic.html">
   Comparing Implicit Models on Synthetic Data
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990000_movie_recommender_tensorflow.html">
   Recommendation Systems with TensorFlow
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990000_movie_recommender_tensorflow_sagemaker.html">
   Movie recommender using Tensorflow in Sagemaker
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990000_movielens_eda_modeling.html">
   Movielens EDA and Modeling
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990000_read_data_from_cassandra_into_pandas.html">
   Read Cassandra Data Snapshot as DataFrame
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990000_rl_in_action.html">
   Reinforcement Learning fundamentals in action
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990000_rnn_cnn_basics.html">
   Processing sequences using RNNs and CNNs
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990000_tf_serving_in_action.html">
   TF Serving in action
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990000_training_indexing_movie_recommender.html">
   Training and indexing movie recommender
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T207114_EduRec_MOOCCube_Course_Recommender.html">
   EduRec MOOCCube Course Recommender
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T273184_Multi_Task_Learning.html">
   Multi-task Learning
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T661108_Book_Recommender_API.html">
   Book Recommender API
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T912764_Simple_Movie_Recommender_App.html">
   Simple Movie Recommender App
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T964554_Career_Village_Questions_Recommendation.html">
   CareerVillage Questions Recommendation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990001_amazon_women_apparel_tfidf_word2vec.html">
   Amazon Product Recommender
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990001_anime_recommender_graph_network.html">
   Anime Recommender with Bi-partite Graph Network
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990001_concept_self_attention.html">
   Self-Attention
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990001_course_recommender_svd_flask.html">
   Course Recommender with SVD based similarity
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990001_data_mining_similarity_measures.html">
   Concept - Data Mining Similarity Measures
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990001_jaccard_recommender.html">
   Jaccard Similarity based Recommender
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990001_live_streamer_recommender.html">
   Live Streamer Recommender with Implicit feedback
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990001_songs_embedding_skipgram_recommender.html">
   Song Embeddings - Skipgram Recommender
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990001_toy_example_car_recommender_knn.html">
   Toy example - Car Recommender using KNN method
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990001_wikirecs_recommender.html">
   WikiRecs
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../_sources/nbs/T315965_Sequence_Aware_Recommenders_Music.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/sparsh-ai/reco-book/main?urlpath=tree/nbs/T315965_Sequence_Aware_Recommenders_Music.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="../_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav" aria-label="Page">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#data-loading">
   Data loading
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#data-statistics">
   Data statistics
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#split-the-dataset">
   Split the dataset
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#fitting-the-recommender">
   Fitting the recommender
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#algorithm-summary">
     Algorithm summary
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#popularity-recommender">
     Popularity recommender
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#frequent-sequential-patterns">
     Frequent Sequential Patterns
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#markov-chains">
     Markov Chains
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#fpmc">
     FPMC
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#prod2vec">
     Prod2vec
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#session-based-rnn">
     Session based RNN
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#personalized-rnn">
     Personalized RNN
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#knn-recommender">
     KNN recommender
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#sequential-evaluation">
   Sequential Evaluation
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#evaluation-with-sequentially-revealed-user-profiles">
     Evaluation with sequentially revealed user-profiles
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#logging">
       Logging
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#evaluation-with-static-user-profiles">
     Evaluation with “static” user-profiles
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id1">
       Logging
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#analysis-of-next-item-recommendation">
   Analysis of next-item recommendation
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#evaluation-for-different-recommendation-list-lengths">
     Evaluation for different recommendation list lengths
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id2">
       Logging
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#evaluation-for-different-user-profile-lengths">
     Evaluation for different user profile lengths
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id3">
       Logging
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#artifact-versioning">
   Artifact versioning
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#model-logging">
     Model logging
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#data-logging">
     Data logging
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#w-b-experiment-link">
   W&amp;B Experiment Link
  </a>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="section" id="sequence-aware-recommender-systems">
<h1>Sequence Aware Recommender Systems<a class="headerlink" href="#sequence-aware-recommender-systems" title="Permalink to this headline">¶</a></h1>
<blockquote>
<div><p>A tutorial on Sequence-Aware Recommender Systems</p>
</div></blockquote>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>!pip install pymining
!pip install treelib==1.5.3
!pip install networkx==1.11
!pip install theano==1.0.3
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">calendar</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">Counter</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">from</span> <span class="nn">scipy.sparse</span> <span class="kn">import</span> <span class="n">find</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">operator</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">import</span> <span class="nn">gc</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">reduce</span>
<span class="kn">import</span> <span class="nn">networkx</span> <span class="k">as</span> <span class="nn">nx</span>
<span class="kn">import</span> <span class="nn">uuid</span>
<span class="kn">import</span> <span class="nn">treelib</span>
<span class="kn">import</span> <span class="nn">theano</span>
<span class="kn">from</span> <span class="nn">theano</span> <span class="kn">import</span> <span class="n">tensor</span> <span class="k">as</span> <span class="n">T</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>
<span class="kn">from</span> <span class="nn">theano</span> <span class="kn">import</span> <span class="n">function</span>
<span class="kn">from</span> <span class="nn">theano.sandbox.rng_mrg</span> <span class="kn">import</span> <span class="n">MRG_RandomStreams</span>
<span class="kn">import</span> <span class="nn">pickle</span>

<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">subprocess</span>

<span class="kn">import</span> <span class="nn">csv</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">from</span> <span class="nn">numba</span> <span class="kn">import</span> <span class="n">jit</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">random</span>

<span class="kn">import</span> <span class="nn">gensim</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2021-04-25 14:00:03,787 - INFO - &#39;pattern&#39; package not found; tag filters are not available for English
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span># WnB Remote Logging Setup
!pip install -q wandb
import wandb
wandb.login()
</pre></div>
</div>
</div>
</div>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>wandb: You can find your API key in your browser here: https://wandb.ai/authorize
wandb: Paste an API key from your profile and hit enter: ··········
wandb: Appending key for api.wandb.ai to your netrc file: /root/.netrc
True
</pre></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Helper functions</span>
<span class="k">def</span> <span class="nf">get_test_sequences</span><span class="p">(</span><span class="n">test_data</span><span class="p">,</span> <span class="n">given_k</span><span class="p">):</span>
  <span class="c1"># we can run evaluation only over sequences longer than abs(LAST_K)</span>
  <span class="n">test_sequences</span> <span class="o">=</span> <span class="n">test_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">test_data</span><span class="p">[</span><span class="s1">&#39;sequence&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="nb">len</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">abs</span><span class="p">(</span><span class="n">given_k</span><span class="p">),</span> <span class="s1">&#39;sequence&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
  <span class="k">return</span> <span class="n">test_sequences</span>

  <span class="k">def</span> <span class="nf">get_test_sequences_and_users</span><span class="p">(</span><span class="n">test_data</span><span class="p">,</span> <span class="n">given_k</span><span class="p">,</span> <span class="n">train_users</span><span class="p">):</span>
    <span class="c1"># we can run evaluation only over sequences longer than abs(LAST_K)</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">test_data</span><span class="p">[</span><span class="s1">&#39;sequence&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="nb">len</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">abs</span><span class="p">(</span><span class="n">given_k</span><span class="p">)</span>
    <span class="n">mask</span> <span class="o">&amp;=</span> <span class="n">test_data</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">train_users</span><span class="p">)</span>
    <span class="n">test_sequences</span> <span class="o">=</span> <span class="n">test_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask</span><span class="p">,</span> <span class="s1">&#39;sequence&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">test_users</span> <span class="o">=</span> <span class="n">test_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask</span><span class="p">,</span> <span class="s1">&#39;user_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="k">return</span> <span class="n">test_sequences</span><span class="p">,</span> <span class="n">test_users</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="data-loading">
<h2>Data loading<a class="headerlink" href="#data-loading" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>!mkdir datasets &amp;&amp; \
cd datasets &amp;&amp; \
wget https://raw.githubusercontent.com/mquad/sars_tutorial/master/datasets/sessions.zip &amp;&amp; \
unzip sessions.zip
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dataset_path</span> <span class="o">=</span> <span class="s1">&#39;datasets/sessions.csv&#39;</span>
<span class="c1"># load this sample if you experience a severe slowdown with the previous dataset</span>
<span class="n">dataset_path</span> <span class="o">=</span> <span class="s1">&#39;datasets/sessions_sample_10.csv&#39;</span> 
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">load_and_adapt</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">last_months</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="n">file_ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">path</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">file_ext</span> <span class="o">==</span> <span class="s1">&#39;.csv&#39;</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">file_ext</span> <span class="o">==</span> <span class="s1">&#39;.hdf&#39;</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_hdf</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Unsupported file </span><span class="si">{}</span><span class="s1"> having extension </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">file_ext</span><span class="p">))</span>

    <span class="n">col_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;session_id&#39;</span><span class="p">,</span> <span class="s1">&#39;user_id&#39;</span><span class="p">,</span> <span class="s1">&#39;item_id&#39;</span><span class="p">,</span> <span class="s1">&#39;ts&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()[</span><span class="mi">4</span><span class="p">:]</span>
    <span class="n">data</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">col_names</span>

    <span class="k">if</span> <span class="n">last_months</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">def</span> <span class="nf">add_months</span><span class="p">(</span><span class="n">sourcedate</span><span class="p">,</span> <span class="n">months</span><span class="p">):</span>
            <span class="n">month</span> <span class="o">=</span> <span class="n">sourcedate</span><span class="o">.</span><span class="n">month</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">months</span>
            <span class="n">year</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sourcedate</span><span class="o">.</span><span class="n">year</span> <span class="o">+</span> <span class="n">month</span> <span class="o">/</span> <span class="mi">12</span><span class="p">)</span>
            <span class="n">month</span> <span class="o">=</span> <span class="n">month</span> <span class="o">%</span> <span class="mi">12</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">day</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">sourcedate</span><span class="o">.</span><span class="n">day</span><span class="p">,</span> <span class="n">calendar</span><span class="o">.</span><span class="n">monthrange</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">)</span>

        <span class="n">lastdate</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">ts</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
        <span class="n">firstdate</span> <span class="o">=</span> <span class="n">add_months</span><span class="p">(</span><span class="n">lastdate</span><span class="p">,</span> <span class="o">-</span><span class="n">last_months</span><span class="p">)</span>
        <span class="n">initial_unix</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">mktime</span><span class="p">(</span><span class="n">firstdate</span><span class="o">.</span><span class="n">timetuple</span><span class="p">())</span>

        <span class="c1"># filter out older interactions</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;ts&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">initial_unix</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">data</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">create_seq_db_filter_top_k</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">topk</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">last_months</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="n">file</span> <span class="o">=</span> <span class="n">load_and_adapt</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">last_months</span><span class="o">=</span><span class="n">last_months</span><span class="p">)</span>

    <span class="n">c</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">file</span><span class="p">[</span><span class="s1">&#39;item_id&#39;</span><span class="p">]))</span>

    <span class="k">if</span> <span class="n">topk</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">keeper</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">most_common</span><span class="p">(</span><span class="n">topk</span><span class="p">)])</span>
        <span class="n">file</span> <span class="o">=</span> <span class="n">file</span><span class="p">[</span><span class="n">file</span><span class="p">[</span><span class="s1">&#39;item_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">keeper</span><span class="p">)]</span>

    <span class="c1"># group by session id and concat song_id</span>
    <span class="n">groups</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;session_id&#39;</span><span class="p">)</span>

    <span class="c1"># convert item ids to string, then aggregate them to lists</span>
    <span class="n">aggregated</span> <span class="o">=</span> <span class="n">groups</span><span class="p">[</span><span class="s1">&#39;item_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">sequence</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">x</span><span class="p">)))</span>
    <span class="n">init_ts</span> <span class="o">=</span> <span class="n">groups</span><span class="p">[</span><span class="s1">&#39;ts&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="n">users</span> <span class="o">=</span> <span class="n">groups</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>  <span class="c1"># it&#39;s just fast, min doesn&#39;t actually make sense</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">aggregated</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">init_ts</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">users</span><span class="p">)</span>
    <span class="n">result</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># for the sake of speed, let&#39;s keep only the top-1k most popular items in the last month</span>
<span class="n">dataset</span> <span class="o">=</span> <span class="n">create_seq_db_filter_top_k</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">dataset_path</span><span class="p">,</span> <span class="n">topk</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">last_months</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dataset</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>session_id</th>
      <th>sequence</th>
      <th>ts</th>
      <th>user_id</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>357</td>
      <td>[793, 3489]</td>
      <td>1421003874</td>
      <td>4296</td>
    </tr>
    <tr>
      <th>1</th>
      <td>359</td>
      <td>[1762]</td>
      <td>1421018535</td>
      <td>4296</td>
    </tr>
    <tr>
      <th>2</th>
      <td>394</td>
      <td>[1256]</td>
      <td>1421007470</td>
      <td>30980</td>
    </tr>
    <tr>
      <th>3</th>
      <td>4127</td>
      <td>[1948, 1364, 2060, 1115, 6488, 2060]</td>
      <td>1421416896</td>
      <td>28117</td>
    </tr>
    <tr>
      <th>4</th>
      <td>6400</td>
      <td>[687, 1394]</td>
      <td>1420807778</td>
      <td>35247</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</div>
<div class="section" id="data-statistics">
<h2>Data statistics<a class="headerlink" href="#data-statistics" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cnt</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">()</span>
<span class="n">dataset</span><span class="o">.</span><span class="n">sequence</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">cnt</span><span class="o">.</span><span class="n">update</span><span class="p">);</span>

<span class="n">sequence_length</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">sequence</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="nb">len</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>
<span class="n">n_sessions_per_user</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;user_id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Number of items: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cnt</span><span class="p">)))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Number of users: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">user_id</span><span class="o">.</span><span class="n">nunique</span><span class="p">()))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Number of sessions: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">))</span> <span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Session length:</span><span class="se">\n\t</span><span class="s1">Average: </span><span class="si">{:.2f}</span><span class="se">\n\t</span><span class="s1">Median: </span><span class="si">{}</span><span class="se">\n\t</span><span class="s1">Min: </span><span class="si">{}</span><span class="se">\n\t</span><span class="s1">Max: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
    <span class="n">sequence_length</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> 
    <span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">sequence_length</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span> 
    <span class="n">sequence_length</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> 
    <span class="n">sequence_length</span><span class="o">.</span><span class="n">max</span><span class="p">()))</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Sessions per user:</span><span class="se">\n\t</span><span class="s1">Average: </span><span class="si">{:.2f}</span><span class="se">\n\t</span><span class="s1">Median: </span><span class="si">{}</span><span class="se">\n\t</span><span class="s1">Min: </span><span class="si">{}</span><span class="se">\n\t</span><span class="s1">Max: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
    <span class="n">n_sessions_per_user</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> 
    <span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">n_sessions_per_user</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span> 
    <span class="n">n_sessions_per_user</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> 
    <span class="n">n_sessions_per_user</span><span class="o">.</span><span class="n">max</span><span class="p">()))</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Most popular items: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cnt</span><span class="o">.</span><span class="n">most_common</span><span class="p">(</span><span class="mi">5</span><span class="p">)))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Number of items: 1000
Number of users: 4165
Number of sessions: 6765

Session length:
	Average: 4.29
	Median: 3.0
	Min: 1
	Max: 148
Sessions per user:
	Average: 1.62
	Median: 1.0
	Min: 1
	Max: 13
Most popular items: [(&#39;443&#39;, 207), (&#39;1065&#39;, 155), (&#39;67&#39;, 146), (&#39;2308&#39;, 138), (&#39;658&#39;, 131)]
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="split-the-dataset">
<h2>Split the dataset<a class="headerlink" href="#split-the-dataset" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">random_holdout</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">perc</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">1234</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Split sequence dataset randomly</span>
<span class="sd">    :param dataset: the sequence dataset</span>
<span class="sd">    :param perc: the training percentange</span>
<span class="sd">    :param seed: the random seed</span>
<span class="sd">    :return: the training and test splits</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">frac</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>
    <span class="n">nseqs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
    <span class="n">train_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">nseqs</span> <span class="o">*</span> <span class="n">perc</span><span class="p">)</span>
    <span class="c1"># split data according to the shuffled index and the holdout size</span>
    <span class="n">train_split</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[:</span><span class="n">train_size</span><span class="p">]</span>
    <span class="n">test_split</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[</span><span class="n">train_size</span><span class="p">:]</span>

    <span class="k">return</span> <span class="n">train_split</span><span class="p">,</span> <span class="n">test_split</span>


<span class="k">def</span> <span class="nf">temporal_holdout</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">ts_threshold</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Split sequence dataset using timestamps</span>
<span class="sd">    :param dataset: the sequence dataset</span>
<span class="sd">    :param ts_threshold: the timestamp from which test sequences will start</span>
<span class="sd">    :return: the training and test splits</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">train</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dataset</span><span class="p">[</span><span class="s1">&#39;ts&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">ts_threshold</span><span class="p">]</span>
    <span class="n">test</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dataset</span><span class="p">[</span><span class="s1">&#39;ts&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">ts_threshold</span><span class="p">]</span>
    <span class="n">train</span><span class="p">,</span> <span class="n">test</span> <span class="o">=</span> <span class="n">clean_split</span><span class="p">(</span><span class="n">train</span><span class="p">,</span> <span class="n">test</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">train</span><span class="p">,</span> <span class="n">test</span>


<span class="k">def</span> <span class="nf">last_session_out_split</span><span class="p">(</span><span class="n">data</span><span class="p">,</span>
                           <span class="n">user_key</span><span class="o">=</span><span class="s1">&#39;user_id&#39;</span><span class="p">,</span>
                           <span class="n">session_key</span><span class="o">=</span><span class="s1">&#39;session_id&#39;</span><span class="p">,</span>
                           <span class="n">time_key</span><span class="o">=</span><span class="s1">&#39;ts&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Assign the last session of every user to the test set and the remaining ones to the training set</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sessions</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="n">user_key</span><span class="p">,</span> <span class="n">time_key</span><span class="p">])</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">user_key</span><span class="p">)[</span><span class="n">session_key</span><span class="p">]</span>
    <span class="n">last_session</span> <span class="o">=</span> <span class="n">sessions</span><span class="o">.</span><span class="n">last</span><span class="p">()</span>
    <span class="n">train</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="o">~</span><span class="n">data</span><span class="o">.</span><span class="n">session_id</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">last_session</span><span class="o">.</span><span class="n">values</span><span class="p">)]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">test</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">session_id</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">last_session</span><span class="o">.</span><span class="n">values</span><span class="p">)]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">train</span><span class="p">,</span> <span class="n">test</span> <span class="o">=</span> <span class="n">clean_split</span><span class="p">(</span><span class="n">train</span><span class="p">,</span> <span class="n">test</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">train</span><span class="p">,</span> <span class="n">test</span>


<span class="k">def</span> <span class="nf">clean_split</span><span class="p">(</span><span class="n">train</span><span class="p">,</span> <span class="n">test</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Remove new items from the test set.</span>
<span class="sd">    :param train: The training set.</span>
<span class="sd">    :param test: The test set.</span>
<span class="sd">    :return: The cleaned training and test sets.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">train_items</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">train</span><span class="p">[</span><span class="s1">&#39;sequence&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">seq</span><span class="p">:</span> <span class="n">train_items</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">seq</span><span class="p">)))</span>
    <span class="n">test</span><span class="p">[</span><span class="s1">&#39;sequence&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">test</span><span class="p">[</span><span class="s1">&#39;sequence&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">seq</span><span class="p">:</span> <span class="p">[</span><span class="n">it</span> <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="n">seq</span> <span class="k">if</span> <span class="n">it</span> <span class="ow">in</span> <span class="n">train_items</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">train</span><span class="p">,</span> <span class="n">test</span>


<span class="k">def</span> <span class="nf">balance_dataset</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="n">number_of_elements</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">nnz</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">find</span><span class="p">(</span><span class="n">y</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">zero</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">number_of_elements</span><span class="p">))</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">nnz</span><span class="p">)</span>

    <span class="n">max_samples</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">zero</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">nnz</span><span class="p">))</span>

    <span class="n">nnz_indices</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">nnz</span><span class="p">,</span> <span class="n">max_samples</span><span class="p">)</span>
    <span class="n">zero_indeces</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">zero</span><span class="p">,</span> <span class="n">max_samples</span><span class="p">)</span>
    <span class="n">indeces</span> <span class="o">=</span> <span class="n">nnz_indices</span> <span class="o">+</span> <span class="n">zero_indeces</span>

    <span class="k">return</span> <span class="n">x</span><span class="p">[</span><span class="n">indeces</span><span class="p">,</span> <span class="p">:],</span> <span class="n">y</span><span class="p">[</span><span class="n">indeces</span><span class="p">,</span> <span class="p">:]</span>
</pre></div>
</div>
</div>
</div>
<p>For simplicity, let’s split the dataset by assigning the last session of every user to the test set, and all the previous ones to the training set.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">train_data</span><span class="p">,</span> <span class="n">test_data</span> <span class="o">=</span> <span class="n">last_session_out_split</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Train sessions: </span><span class="si">{}</span><span class="s2"> - Test sessions: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">train_data</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_data</span><span class="p">)))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Train sessions: 2600 - Test sessions: 4165
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="fitting-the-recommender">
<h2>Fitting the recommender<a class="headerlink" href="#fitting-the-recommender" title="Permalink to this headline">¶</a></h2>
<div class="section" id="algorithm-summary">
<h3>Algorithm summary<a class="headerlink" href="#algorithm-summary" title="Permalink to this headline">¶</a></h3>
<img src='https://www.notion.so/image/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2Fec4cd24b-d212-4225-93b8-f021d2dc5fc1%2FUntitled.png?table=block&id=6e90aea9-6ab5-4074-a76f-08a5ddf0d124&spaceId=63b72b1f-0e90-4ab8-a6df-a060a6545a56&width=2000&userId=21ec183f-f0be-4b6b-9b3e-6f0d4e5c5469&cache=v2'><div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">ISeqRecommender</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Abstract Recommender class&quot;&quot;&quot;</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1"> - </span><span class="si">%(levelname)s</span><span class="s1"> - </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ISeqRecommender</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">train_data</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">recommend</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_profile</span><span class="p">,</span> <span class="n">user_id</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Given the user profile return a list of recommendation</span>
<span class="sd">        :param user_profile: the user profile as a list of item identifiers</span>
<span class="sd">        :param user_id: (optional) the user id</span>
<span class="sd">        :return: list of recommendations e.g. [([2], 0.875), ([6], 1.0)]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_recommendation_list</span><span class="p">(</span><span class="n">recommendation</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">recommendation</span><span class="p">))</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_recommendation_confidence_list</span><span class="p">(</span><span class="n">recommendation</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">recommendation</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">activate_debug_print</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">deactivate_debug_print</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="popularity-recommender">
<h3>Popularity recommender<a class="headerlink" href="#popularity-recommender" title="Permalink to this headline">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">PopularityRecommender</span></code> simply recommends items ordered by their popularity in the training set.</p>
<p>It doesn’t have any hyper-parameter, so we can move on!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">PopularityRecommender</span><span class="p">(</span><span class="n">ISeqRecommender</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">PopularityRecommender</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">train_data</span><span class="p">):</span>
        <span class="n">sequences</span> <span class="o">=</span> <span class="n">train_data</span><span class="p">[</span><span class="s1">&#39;sequence&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

        <span class="n">count_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sequences</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">item</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">count_dict</span><span class="p">:</span>
                    <span class="n">count_dict</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">count_dict</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">top</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">count_dict</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="n">operator</span><span class="o">.</span><span class="n">itemgetter</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">top</span> <span class="o">=</span> <span class="p">[([</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">top</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">recommend</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_profile</span><span class="p">,</span> <span class="n">user_id</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">top</span>

    <span class="k">def</span> <span class="nf">get_popular_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">top</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">poprecommender</span> <span class="o">=</span> <span class="n">PopularityRecommender</span><span class="p">()</span>
<span class="n">poprecommender</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_data</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="frequent-sequential-patterns">
<h3>Frequent Sequential Patterns<a class="headerlink" href="#frequent-sequential-patterns" title="Permalink to this headline">¶</a></h3>
<img src='https://www.notion.so/image/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2Fdf7f4468-d71e-4855-9d06-087f3e89bbab%2FUntitled.png?table=block&id=222f2d0b-e4da-4e38-af6c-fa462a830817&spaceId=63b72b1f-0e90-4ab8-a6df-a060a6545a56&width=2000&userId=21ec183f-f0be-4b6b-9b3e-6f0d4e5c5469&cache=v2'><p>This algorithm extract Frequent Sequential Patterns from all the training sequences. Patterns are having support lower than <code class="docutils literal notranslate"><span class="pre">minsup</span></code> are discarded (support = # occurrences of a pattern in the traning data).<br />
Recommendations are then generated by looking for patterns having a <em>prefix</em> corresponding to the last <code class="docutils literal notranslate"><span class="pre">[max_context,</span> <span class="pre">min_context]</span></code> elements in the user profile, taken in order. Matches are then sorted by decreasing <em>confidence</em> score (ratio between the support of the matched rule and the support of the context). Matches having confidence below <code class="docutils literal notranslate"><span class="pre">minconf</span></code> are discarded.</p>
<p>The class <code class="docutils literal notranslate"><span class="pre">FSMRecommender</span></code> has the following initialization hyper-parameters:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">minsup</span></code>: the minimum support threshold. It is interpreted as relative count if in [0-1], otherwise as an absolute count. NOTE: Relative count required for training with SPFM (faster).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">minconf</span></code>: the minimum confidence threshold. Use to filter irrelevent recommendations.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">max_context</span></code>: the maximum number of items in the user profile (starting from the last) that will be used for lookup in the database of frequent sequences.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">min_context</span></code>: the minimum number of items in the user profile (starting from the last) that will be used for lookup in the database of frequent sequences.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">spmf_path</span></code>: path to SPMF jar file. If provided, SPFM library will be used for pattern extraction (algorithm: Prefix Span). Otherwise, use pymining, which can be significantly slower depending on the sequence database size.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">db_path</span></code>: path to the sequence database file</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">callSPMF</span><span class="p">(</span><span class="n">spmfPath</span><span class="p">,</span> <span class="n">command</span><span class="p">):</span>
    <span class="c1"># java -jar spmf.jar run PrefixSpan contextPrefixSpan.txt output.txt 50%</span>
    <span class="n">comm</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;java -jar&#39;</span><span class="p">,</span> <span class="n">spmfPath</span><span class="p">,</span> <span class="s1">&#39;run&#39;</span><span class="p">,</span> <span class="n">command</span><span class="p">])</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">comm</span><span class="p">)</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">comm</span><span class="p">,</span>
                         <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                         <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">STDOUT</span><span class="p">,</span>
                         <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>  <span class="c1"># wait for completion</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SmartTree</span><span class="p">(</span><span class="n">treelib</span><span class="o">.</span><span class="n">Tree</span><span class="p">):</span>
    <span class="n">_PATH_NOT_FOUND</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

    <span class="k">def</span> <span class="nf">find_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">origin</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Takes the nodeId where to start the path search and the path to look for,</span>
<span class="sd">        :returns -1 if path not found, nodeId of the last node if path found</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="p">:</span>
            <span class="c1"># path found</span>
            <span class="k">return</span> <span class="n">origin</span>

        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_PATH_NOT_FOUND</span>
        <span class="c1"># note: fpointer getting deprecation warning, would improve in next ver.</span>
        <span class="k">for</span> <span class="n">nodeId</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span><span class="n">origin</span><span class="p">]</span><span class="o">.</span><span class="n">fpointer</span><span class="p">:</span>
            <span class="n">node</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">nodeId</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_path</span><span class="p">(</span><span class="n">nodeId</span><span class="p">,</span> <span class="n">path</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
                <span class="k">break</span>

        <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># path not found</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_PATH_NOT_FOUND</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">res</span>

    <span class="k">def</span> <span class="nf">longest_subpath</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">origin</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Takes the nodeId where to start the path search and the path to look for,</span>
<span class="sd">        :returns the nodeId of the node where the path is broken and the number of missing element for the complete path</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="p">:</span>  <span class="c1"># path empty, all nodes matched</span>
            <span class="c1"># path found</span>
            <span class="k">return</span> <span class="n">origin</span><span class="p">,</span> <span class="mi">0</span>

        <span class="n">res</span> <span class="o">=</span> <span class="p">()</span>

        <span class="k">for</span> <span class="n">nodeId</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span><span class="n">origin</span><span class="p">]</span><span class="o">.</span><span class="n">fpointer</span><span class="p">:</span>
            <span class="n">node</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">nodeId</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">longest_subpath</span><span class="p">(</span><span class="n">nodeId</span><span class="p">,</span> <span class="n">path</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
                <span class="k">break</span>

        <span class="k">if</span> <span class="n">res</span> <span class="o">==</span> <span class="p">():</span>
            <span class="c1"># path not found</span>
            <span class="k">return</span> <span class="n">origin</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">res</span>

    <span class="k">def</span> <span class="nf">add_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">origin</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">support</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;add a path, starting from origin&quot;&quot;&quot;</span>
        <span class="n">sub</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">longest_subpath</span><span class="p">(</span><span class="n">origin</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sub</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># path already exists, updating support</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">sub</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;support&#39;</span><span class="p">:</span> <span class="n">support</span><span class="p">}</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># add what&#39;s missing</span>
            <span class="n">missingPath</span> <span class="o">=</span> <span class="n">path</span><span class="p">[</span><span class="o">-</span><span class="n">sub</span><span class="p">[</span><span class="mi">1</span><span class="p">]:]</span>

            <span class="n">par</span> <span class="o">=</span> <span class="n">sub</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">missingPath</span><span class="p">:</span>
                <span class="n">itemId</span> <span class="o">=</span> <span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">create_node</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">itemId</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">par</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;support&#39;</span><span class="p">:</span> <span class="n">support</span><span class="p">})</span>
                <span class="n">par</span> <span class="o">=</span> <span class="n">itemId</span>

    <span class="k">def</span> <span class="nf">path_is_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">path</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_PATH_NOT_FOUND</span>

    <span class="k">def</span> <span class="nf">create_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">identifier</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;override to get a random id if none provided&quot;&quot;&quot;</span>
        <span class="nb">id</span> <span class="o">=</span> <span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span> <span class="k">if</span> <span class="n">identifier</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">identifier</span>
        <span class="k">if</span> <span class="nb">id</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_PATH_NOT_FOUND</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NameError</span><span class="p">(</span><span class="s2">&quot;Cannot create a node with special id &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_PATH_NOT_FOUND</span><span class="p">))</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SmartTree</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">create_node</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">set_root</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">root_tag</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">root_id</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">id</span> <span class="o">=</span> <span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span>
        <span class="n">root_id</span> <span class="o">=</span> <span class="n">root_id</span> <span class="k">if</span> <span class="n">root_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">id</span>
        <span class="n">root_tag</span> <span class="o">=</span> <span class="n">root_tag</span> <span class="k">if</span> <span class="n">root_tag</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s1">&#39;root&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_node</span><span class="p">(</span><span class="n">root_tag</span><span class="p">,</span> <span class="n">root_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">root</span> <span class="o">=</span> <span class="n">root_id</span>
        <span class="k">return</span> <span class="n">root_id</span>

    <span class="k">def</span> <span class="nf">get_root</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">find_n_length_paths</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">origin</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">exclude_origin</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[[]]</span> <span class="k">if</span> <span class="n">exclude_origin</span> <span class="k">else</span> <span class="p">[[</span><span class="n">origin</span><span class="p">]]</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">children</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">origin</span><span class="p">]</span><span class="o">.</span><span class="n">fpointer</span>
            <span class="n">paths</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">children</span><span class="p">:</span>
                <span class="n">children_paths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_n_length_paths</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                <span class="c1"># this line is magic, if there are no children the all path gets lost,</span>
                <span class="c1"># that&#39;s how i get paths of exactly length wanted</span>
                <span class="n">l</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">[]</span> <span class="o">+</span> <span class="n">x</span><span class="p">,</span> <span class="n">children_paths</span><span class="p">))</span> <span class="k">if</span> <span class="n">exclude_origin</span> <span class="k">else</span> <span class="nb">list</span><span class="p">(</span>
                    <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">[</span><span class="n">origin</span><span class="p">]</span> <span class="o">+</span> <span class="n">x</span><span class="p">,</span> <span class="n">children_paths</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">l</span><span class="p">:</span>
                    <span class="n">paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">el</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">paths</span>

    <span class="k">def</span> <span class="nf">get_paths_tag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">list_of_paths</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_nodes_tag</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">list_of_paths</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">get_nodes_tag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">list_of_nids</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">y</span><span class="p">:</span> <span class="bp">self</span><span class="p">[</span><span class="n">y</span><span class="p">]</span><span class="o">.</span><span class="n">tag</span><span class="p">,</span> <span class="n">list_of_nids</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">FSMRecommender</span><span class="p">(</span><span class="n">ISeqRecommender</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Frequent Sequence Mining recommender&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">minsup</span><span class="p">,</span> <span class="n">minconf</span><span class="p">,</span> <span class="n">max_context</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">min_context</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">spmf_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">db_path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :param minsup: the minimum support threshold. It is interpreted as relative count if in [0-1],</span>
<span class="sd">                otherwise as an absolute count. NOTE: Relative count required for training with SPFM (faster).</span>
<span class="sd">        :param minconf: the minimum confidence threshold.</span>
<span class="sd">        :param max_context: (optional) the maximum number of items in the user profile (starting from the last) that will be used</span>
<span class="sd">                for lookup in the database of frequent sequences.</span>
<span class="sd">        :param min_context: (optional) the minimum number of items in the user profile (starting from the last) that will be used</span>
<span class="sd">                for lookup in the database of frequent sequences.</span>
<span class="sd">        :param spmf_path: (optional) path to SPMF jar file. If provided, SPFM library will be used for pattern extraction (algorithm: Prefix Span).</span>
<span class="sd">                Otherwise, use pymining, which can be significantly slower depending on the sequence database size.</span>
<span class="sd">        :param db_path: (optional) path to the sequence database file</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">FSMRecommender</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">minsup</span> <span class="o">=</span> <span class="n">minsup</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">minconf</span> <span class="o">=</span> <span class="n">minconf</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_context</span> <span class="o">=</span> <span class="n">max_context</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_context</span> <span class="o">=</span> <span class="n">min_context</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">recommendation_length</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db_path</span> <span class="o">=</span> <span class="n">db_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spmf_path</span> <span class="o">=</span> <span class="n">spmf_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spmf_algorithm</span> <span class="o">=</span> <span class="s2">&quot;PrefixSpan&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_path</span> <span class="o">=</span> <span class="s2">&quot;tmp/tmp_output.txt&quot;</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;FreqSeqMiningRecommender: &#39;</span> \
               <span class="s1">&#39;minsup=</span><span class="si">{minsup}</span><span class="s1">, &#39;</span> \
               <span class="s1">&#39;minconf=</span><span class="si">{minconf}</span><span class="s1">, &#39;</span> \
               <span class="s1">&#39;max_context=</span><span class="si">{max_context}</span><span class="s1">, &#39;</span> \
               <span class="s1">&#39;min_context=</span><span class="si">{min_context}</span><span class="s1">, &#39;</span> \
               <span class="s1">&#39;spmf_path=</span><span class="si">{spmf_path}</span><span class="s1">, &#39;</span> \
               <span class="s1">&#39;db_path=</span><span class="si">{db_path}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">train_data</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fit the model</span>
<span class="sd">        :param train_data: (optional) DataFrame with the training sequences, which must be assigned to column &quot;sequence&quot;.</span>
<span class="sd">            If None, run FSM using SPFM over the sequence database stored in `self.db_path`.</span>
<span class="sd">            Otherwise, run FSM using `pymining.seqmining` (slower).</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">train_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spmf_path</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;You should set db_path and spfm_path before calling fit() without arguments.&quot;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Using SPFM (Java) for Frequent Sequence Mining&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">minsup</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">percentage_min_sup</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">minsup</span> <span class="o">*</span> <span class="mi">100</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NameError</span><span class="p">(</span><span class="s2">&quot;SPMF only accepts 0&lt;=minsup&lt;=1&quot;</span><span class="p">)</span>

            <span class="c1"># call spmf</span>
            <span class="n">command</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">spmf_algorithm</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">percentage_min_sup</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;%&#39;</span><span class="p">])</span>
            <span class="n">callSPMF</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spmf_path</span><span class="p">,</span> <span class="n">command</span><span class="p">)</span>

            <span class="c1"># parse back output from text file</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_parse_spfm_output</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># use pymining</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Using pymining.seqmining (python) for Frequent Sequence Mining&#39;</span><span class="p">)</span>
            <span class="n">sequences</span> <span class="o">=</span> <span class="n">train_data</span><span class="p">[</span><span class="s1">&#39;sequence&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
            <span class="n">msup</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">minsup</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">sequences</span><span class="p">))</span> <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">minsup</span> <span class="o">&lt;=</span> <span class="mi">1</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">minsup</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Mining frequent sequences (minsup=</span><span class="si">{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">msup</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">freq_seqs</span> <span class="o">=</span> <span class="n">seqmining</span><span class="o">.</span><span class="n">freq_seq_enum</span><span class="p">(</span><span class="n">sequences</span><span class="p">,</span> <span class="n">msup</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> frequent sequences found&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">freq_seqs</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Building the prefix tree&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tree</span> <span class="o">=</span> <span class="n">SmartTree</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">root_node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">set_root</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">pattern</span><span class="p">,</span> <span class="n">support</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">freq_seqs</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># add node to root</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">create_node</span><span class="p">(</span><span class="n">pattern</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">root_node</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;support&quot;</span><span class="p">:</span> <span class="n">support</span><span class="p">})</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># add entire path starting from root</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">add_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root_node</span><span class="p">,</span> <span class="n">pattern</span><span class="p">,</span> <span class="n">support</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Frequent sequence of length 0&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Training completed&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">recommend</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_profile</span><span class="p">,</span> <span class="n">user_id</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">user_profile</span><span class="p">)</span>
        <span class="n">c</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_context</span><span class="p">)</span>
        <span class="n">match</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># iterate over decreasing context lengths until a match with sufficient confidence is found</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">match</span> <span class="ow">and</span> <span class="n">c</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_context</span><span class="p">:</span>
            <span class="n">q</span> <span class="o">=</span> <span class="n">user_profile</span><span class="p">[</span><span class="n">n</span> <span class="o">-</span> <span class="n">c</span><span class="p">:</span><span class="n">n</span><span class="p">]</span>
            <span class="n">match</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_match</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">recommendation_length</span><span class="p">)</span>
            <span class="n">c</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">match</span>

    <span class="k">def</span> <span class="nf">_find_match</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">recommendation_length</span><span class="p">):</span>
        <span class="c1"># search context</span>
        <span class="n">lastNode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">find_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root_node</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">lastNode</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># context matched</span>
            <span class="n">context_support</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="p">[</span><span class="n">lastNode</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;support&#39;</span><span class="p">]</span>
            <span class="n">children</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="p">[</span><span class="n">lastNode</span><span class="p">]</span><span class="o">.</span><span class="n">fpointer</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">children</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">[]</span>

            <span class="c1"># find all path of length recommendation_length from match</span>
            <span class="n">paths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">find_n_length_paths</span><span class="p">(</span><span class="n">lastNode</span><span class="p">,</span> <span class="n">recommendation_length</span><span class="p">)</span>
            <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_filter_confidence</span><span class="p">(</span><span class="n">context_support</span><span class="p">,</span> <span class="n">paths</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_filter_confidence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context_support</span><span class="p">,</span> <span class="n">path_list</span><span class="p">):</span>
        <span class="n">goodPaths</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">path_list</span><span class="p">:</span>
            <span class="n">confidence</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;support&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">context_support</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">confidence</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">minconf</span><span class="p">:</span>
                <span class="n">goodPaths</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">get_nodes_tag</span><span class="p">(</span><span class="n">p</span><span class="p">),</span> <span class="n">confidence</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">goodPaths</span>

    <span class="k">def</span> <span class="nf">_set_tree_debug_only</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tree</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tree</span> <span class="o">=</span> <span class="n">tree</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">root_node</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">get_root</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get_freq_seqs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">freq_seqs</span>

    <span class="k">def</span> <span class="nf">get_sequence_tree</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree</span>

    <span class="k">def</span> <span class="nf">show_tree</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get_confidence_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recommendation</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">recommendation</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_parse_spfm_output</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fin</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">freq_seqs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">fin</span><span class="p">:</span>
                <span class="n">pieces</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;#SUP: &#39;</span><span class="p">)</span>
                <span class="n">support</span> <span class="o">=</span> <span class="n">pieces</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">items</span> <span class="o">=</span> <span class="n">pieces</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
                <span class="n">seq</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">items</span> <span class="k">if</span> <span class="n">x</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span> <span class="ow">and</span> <span class="n">x</span> <span class="o">!=</span> <span class="s1">&#39;-1&#39;</span><span class="p">)</span>
                <span class="n">seq_and_support</span> <span class="o">=</span> <span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">support</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">freq_seqs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">seq_and_support</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">sequences_to_spfm_format</span><span class="p">(</span><span class="n">sequences</span><span class="p">,</span> <span class="n">tmp_path</span><span class="o">=</span><span class="s1">&#39;tmp/sequences.txt&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert a list of sequences to SPFM format and write them to `tmp_path`</span>
<span class="sd">    :param sequences: the list of sequences</span>
<span class="sd">    :param tmp_path: the path where sequences will be written in the SPFM format</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">basedir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">basedir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fout</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sequences</span><span class="p">:</span>
            <span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; -1 &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">s</span><span class="p">)))</span>
            <span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; -2</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>!mkdir spmf &amp;&amp; \
cd spmf &amp;&amp; \
wget https://raw.githubusercontent.com/mquad/sars_tutorial/master/spmf/spmf.jar
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># convert the training sequences to SPFM format first</span>
<span class="n">db_path</span> <span class="o">=</span> <span class="s1">&#39;tmp/sequences.txt&#39;</span>
<span class="n">sequences_to_spfm_format</span><span class="p">(</span><span class="n">train_data</span><span class="p">[</span><span class="s1">&#39;sequence&#39;</span><span class="p">],</span> <span class="n">tmp_path</span><span class="o">=</span><span class="n">db_path</span><span class="p">)</span>

<span class="c1"># then we instantiate and fit the recommender</span>
<span class="n">fsmrecommender</span> <span class="o">=</span> <span class="n">FSMRecommender</span><span class="p">(</span><span class="n">minsup</span><span class="o">=</span><span class="mf">0.002</span><span class="p">,</span> 
                             <span class="n">minconf</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> 
                             <span class="n">min_context</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
                             <span class="n">max_context</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                             <span class="n">spmf_path</span><span class="o">=</span><span class="s1">&#39;spmf/spmf.jar&#39;</span><span class="p">,</span>
                             <span class="n">db_path</span><span class="o">=</span><span class="n">db_path</span><span class="p">)</span>

<span class="c1"># calling fit() without arguments to use SPFM and the sequences stored in db_path</span>
<span class="n">fsmrecommender</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2021-04-25 13:57:15,144 - INFO - Using SPFM (Java) for Frequent Sequence Mining
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>java -jar spmf/spmf.jar run PrefixSpan tmp/sequences.txt tmp/tmp_output.txt 0.2%
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2021-04-25 13:57:16,823 - INFO - 66730 frequent sequences found
2021-04-25 13:57:16,827 - INFO - Building the prefix tree
2021-04-25 13:57:29,086 - INFO - Training completed
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="markov-chains">
<h3>Markov Chains<a class="headerlink" href="#markov-chains" title="Permalink to this headline">¶</a></h3>
<img src='https://www.notion.so/image/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F35b572f7-a65c-458f-922a-8e59a2b9edc5%2FUntitled.png?table=block&id=3c851d27-3aad-40e0-aca5-da3ec7a88662&spaceId=63b72b1f-0e90-4ab8-a6df-a060a6545a56&width=2000&userId=21ec183f-f0be-4b6b-9b3e-6f0d4e5c5469&cache=v2'><p>Here we fit the recommedation algorithm over the sessions in the training set.<br />
This recommender is based on the <code class="docutils literal notranslate"><span class="pre">MarkovChainRecommender</span></code> implemented from:</p>
<p><em>Shani, Guy, David Heckerman, and Ronen I. Brafman. “An MDP-based recommender system.” Journal of Machine Learning Research 6, no. Sep (2005): 1265-1295. Chapter 3-4</em></p>
<p>This recommender computes the item transition matrices for any Markov Chain having order in <code class="docutils literal notranslate"><span class="pre">[min_order,</span> <span class="pre">max_order]</span></code>. Each individual Markov Chain model employes some heristics like skipping or clustering to deal better with data sparsity. Recommendations are generated by sorting items by their transition probability to being next, given the user profile. The scores coming from different MC are weighted <em>inversely</em> wrt to their order.</p>
<p>The class <code class="docutils literal notranslate"><span class="pre">MixedMarkovChainRecommender</span></code> has the following initialization hyper-parameters:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">min_order</span></code>: the minimum order of the Mixed Markov Chain</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">max_order</span></code>: the maximum order of the Mixed Markov Chain</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1"> - </span><span class="si">%(levelname)s</span><span class="s1"> - </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">add_nodes_to_graph</span><span class="p">(</span><span class="n">seqs</span><span class="p">,</span> <span class="n">last_k</span><span class="p">):</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">SmartTree</span><span class="p">()</span>
    <span class="n">rootNode</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">set_root</span><span class="p">()</span>

    <span class="n">countDict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">G</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">DiGraph</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">seqs</span><span class="p">:</span>
        <span class="n">nearHistory</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="o">-</span><span class="p">(</span><span class="n">last_k</span><span class="p">):])</span>
        <span class="k">if</span> <span class="n">nearHistory</span> <span class="ow">in</span> <span class="n">countDict</span><span class="p">:</span>
            <span class="c1"># increment count</span>
            <span class="n">countDict</span><span class="p">[</span><span class="n">nearHistory</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># init count</span>
            <span class="n">countDict</span><span class="p">[</span><span class="n">nearHistory</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="c1"># add seq to sequence tree</span>
            <span class="n">t</span><span class="o">.</span><span class="n">add_path</span><span class="p">(</span><span class="n">rootNode</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">nearHistory</span><span class="p">))</span>
            <span class="c1"># add node to graph</span>
            <span class="n">G</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">nearHistory</span><span class="p">)</span>

        <span class="c1">## i also have to save the sequence of length k+1 because otherwise I cannot calculate the count</span>
        <span class="c1">## from state x to state y. So the seqeunces of length k+1 are in the tree but not in the states</span>
        <span class="n">nearHistoryLong</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span>
            <span class="n">s</span><span class="p">[</span><span class="o">-</span><span class="p">(</span><span class="n">last_k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):])</span>  <span class="c1"># +1 because I need one more element to calculate the transition prob</span>
        <span class="k">if</span> <span class="n">nearHistory</span> <span class="o">!=</span> <span class="n">nearHistoryLong</span><span class="p">:</span>  <span class="c1"># otherwise short seq are counted double</span>
            <span class="k">if</span> <span class="n">nearHistoryLong</span> <span class="ow">in</span> <span class="n">countDict</span><span class="p">:</span>
                <span class="c1"># increment count</span>
                <span class="n">countDict</span><span class="p">[</span><span class="n">nearHistoryLong</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># init count</span>
                <span class="n">countDict</span><span class="p">[</span><span class="n">nearHistoryLong</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">countDict</span><span class="p">,</span> <span class="n">G</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">add_edges</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">countDict</span><span class="p">,</span> <span class="n">G</span><span class="p">,</span> <span class="n">last_k</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :param t: Tree of the sequnces available as states</span>
<span class="sd">    :param countDict: dicionary counting the occurence for each sequence</span>
<span class="sd">    :param G: the graph containing the states (each one is a sequence)</span>
<span class="sd">    :param last_k: the number of recent item considered</span>
<span class="sd">    :return: the same graph G, with edges connecting states</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># add links</span>
    <span class="n">rootNode</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">get_root</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">G</span><span class="o">.</span><span class="n">nodes_iter</span><span class="p">():</span>
        <span class="c1"># if the sequence is shorter than states&#39;s len, the next state has all the sequence as prefix</span>
        <span class="n">next_state_prefix</span> <span class="o">=</span> <span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="o">==</span> <span class="n">last_k</span> <span class="k">else</span> <span class="n">node</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">find_path</span><span class="p">(</span><span class="n">rootNode</span><span class="p">,</span> <span class="n">next_state_prefix</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">path_is_valid</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
            <span class="n">children</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">get_nodes_tag</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="n">p</span><span class="p">]</span><span class="o">.</span><span class="n">fpointer</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">children</span><span class="p">:</span>
                <span class="c1"># the tree may suggest a children which is not a state of the graph, because it was part of a longer</span>
                <span class="c1"># sequence, in that case no edge has to be added</span>
                <span class="k">if</span> <span class="n">next_state_prefix</span> <span class="o">+</span> <span class="p">(</span><span class="n">c</span><span class="p">,)</span> <span class="ow">in</span> <span class="n">G</span><span class="o">.</span><span class="n">nodes</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">countDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">node</span> <span class="o">+</span> <span class="p">(</span><span class="n">c</span><span class="p">,),</span> <span class="mi">0</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># do not add edge if count is 0</span>
                        <span class="n">G</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">next_state_prefix</span> <span class="o">+</span> <span class="p">(</span><span class="n">c</span><span class="p">,),</span> <span class="p">{</span><span class="s1">&#39;count&#39;</span><span class="p">:</span> <span class="n">countDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">node</span> <span class="o">+</span> <span class="p">(</span><span class="n">c</span><span class="p">,),</span> <span class="mi">0</span><span class="p">)})</span>
    <span class="k">return</span> <span class="n">G</span>


<span class="k">def</span> <span class="nf">apply_skipping</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">last_k</span><span class="p">,</span> <span class="n">seqs</span><span class="p">):</span>
    <span class="c1"># iterate over seqs to add skipping count</span>
    <span class="n">window</span> <span class="o">=</span> <span class="n">last_k</span>

    <span class="k">for</span> <span class="n">us</span> <span class="ow">in</span> <span class="n">seqs</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">us</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">-</span> <span class="n">window</span><span class="p">):</span>
            <span class="n">previous_state</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="n">window</span><span class="p">]</span>
            <span class="n">next_state_prefix</span> <span class="o">=</span> <span class="n">previous_state</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="n">window</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)):</span>
                <span class="n">fractional_count</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="p">(</span><span class="n">j</span> <span class="o">-</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="n">window</span><span class="p">)))</span>
                <span class="n">next_state</span> <span class="o">=</span> <span class="n">next_state_prefix</span> <span class="o">+</span> <span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">j</span><span class="p">],)</span>
                <span class="c1"># update count</span>
                <span class="n">old_count</span> <span class="o">=</span> <span class="n">G</span><span class="o">.</span><span class="n">get_edge_data</span><span class="p">(</span><span class="n">previous_state</span><span class="p">,</span> <span class="n">next_state</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;count&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">G</span><span class="o">.</span><span class="n">has_edge</span><span class="p">(</span><span class="n">previous_state</span><span class="p">,</span> <span class="n">next_state</span><span class="p">):</span>
                    <span class="n">G</span><span class="p">[</span><span class="n">previous_state</span><span class="p">][</span><span class="n">next_state</span><span class="p">][</span><span class="s1">&#39;count&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">old_count</span> <span class="o">+</span> <span class="n">fractional_count</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">G</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">previous_state</span><span class="p">,</span> <span class="n">next_state</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;count&#39;</span><span class="p">:</span> <span class="n">fractional_count</span><span class="p">})</span>
                <span class="c1"># print(&#39;updating &#39;+str(previous_state)+&#39;-&gt;&#39;+str(next_state)+&#39; from &#39;+str(old_count)+&#39; to &#39;+str(old_count+fractional_count))</span>

    <span class="c1"># normalize</span>
    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">G</span><span class="o">.</span><span class="n">nodes_iter</span><span class="p">():</span>
        <span class="n">edges</span> <span class="o">=</span> <span class="n">G</span><span class="o">.</span><span class="n">out_edges</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="n">countSum</span> <span class="o">=</span> <span class="n">reduce</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span><span class="p">,</span> <span class="p">[</span><span class="n">G</span><span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="s1">&#39;count&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">edges</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">edges</span><span class="p">:</span>
            <span class="n">G</span><span class="p">[</span><span class="n">e</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="n">e</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="s1">&#39;count&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">G</span><span class="p">[</span><span class="n">e</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="n">e</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="s1">&#39;count&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">countSum</span><span class="p">)</span> <span class="k">if</span> <span class="n">countSum</span> <span class="k">else</span> <span class="mi">0</span>

    <span class="k">return</span> <span class="n">G</span>


<span class="k">def</span> <span class="nf">apply_clustering</span><span class="p">(</span><span class="n">G</span><span class="p">):</span>
    <span class="c1">##clustering</span>
    <span class="k">def</span> <span class="nf">sequence_similarity</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
        <span class="nb">sum</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">))):</span>
            <span class="nb">sum</span> <span class="o">+=</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">else</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">sum</span>

    <span class="n">similarity_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="c1"># for each state in the graph, calculate similarity</span>
    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">G</span><span class="o">.</span><span class="n">nodes_iter</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">deno</span> <span class="ow">in</span> <span class="n">G</span><span class="o">.</span><span class="n">nodes_iter</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">node</span> <span class="o">==</span> <span class="n">deno</span> <span class="ow">or</span> <span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">deno</span><span class="p">)</span> <span class="ow">in</span> <span class="n">similarity_dict</span><span class="p">:</span>
                <span class="k">continue</span>  <span class="c1"># skip if same or already done</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sim</span> <span class="o">=</span> <span class="n">sequence_similarity</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">deno</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">sim</span><span class="p">:</span>  <span class="c1"># save only if different from zero</span>
                    <span class="n">similarity_dict</span><span class="p">[</span><span class="n">node</span><span class="p">,</span> <span class="n">deno</span><span class="p">]</span> <span class="o">=</span> <span class="n">similarity_dict</span><span class="p">[</span><span class="n">deno</span><span class="p">,</span> <span class="n">node</span><span class="p">]</span> <span class="o">=</span> <span class="n">sim</span>

    <span class="n">similarity_count_dict</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">G</span><span class="o">.</span><span class="n">nodes_iter</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">deno</span> <span class="ow">in</span> <span class="n">G</span><span class="o">.</span><span class="n">nodes_iter</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">node</span> <span class="o">==</span> <span class="n">deno</span><span class="p">:</span> <span class="k">continue</span>
            <span class="nb">sum</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">in_edge</span> <span class="ow">in</span> <span class="n">G</span><span class="o">.</span><span class="n">in_edges_iter</span><span class="p">([</span><span class="n">deno</span><span class="p">]):</span>
                <span class="n">intermediate_node</span> <span class="o">=</span> <span class="n">in_edge</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">intermediate_node</span> <span class="o">!=</span> <span class="n">node</span><span class="p">:</span>  <span class="c1"># I want to count the effect of going through Other nodes</span>
                    <span class="nb">sum</span> <span class="o">+=</span> <span class="n">similarity_dict</span><span class="o">.</span><span class="n">get</span><span class="p">((</span><span class="n">node</span><span class="p">,</span> <span class="n">intermediate_node</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="n">G</span><span class="p">[</span><span class="n">intermediate_node</span><span class="p">][</span><span class="n">deno</span><span class="p">][</span><span class="s1">&#39;count&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">sum</span><span class="p">:</span>
                <span class="n">similarity_count_dict</span><span class="p">[</span><span class="n">node</span><span class="p">,</span> <span class="n">deno</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sum</span>

    <span class="k">def</span> <span class="nf">compute_normalization_similarity_count</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="n">normalization_sum</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">other_state</span> <span class="ow">in</span> <span class="n">G</span><span class="o">.</span><span class="n">nodes_iter</span><span class="p">():</span>
            <span class="c1"># skip similarity with myself is 0 because of how similarity_dict is calculated</span>
            <span class="n">normalization_sum</span> <span class="o">+=</span> <span class="n">similarity_count_dict</span><span class="o">.</span><span class="n">get</span><span class="p">((</span><span class="n">node</span><span class="p">,</span> <span class="n">other_state</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">normalization_sum</span>

    <span class="c1">##update transition probability</span>
    <span class="c1">### this can be made faster(?) if I store the adjancency matrix where node are connected if</span>
    <span class="c1"># there is a probability due to the clustering (i.e. there is an entry in similarity_count_dict</span>
    <span class="c1"># in this way I only have to check those edges. now it&#39;s already pretty optimized anyway</span>
    <span class="n">ALPHA</span> <span class="o">=</span> <span class="mf">0.5</span>
    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">G</span><span class="o">.</span><span class="n">nodes_iter</span><span class="p">():</span>
        <span class="n">normalization_sum</span> <span class="o">=</span> <span class="n">compute_normalization_similarity_count</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>

        <span class="c1"># first half the original transition prob</span>
        <span class="k">for</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">G</span><span class="o">.</span><span class="n">out_edges_iter</span><span class="p">([</span><span class="n">node</span><span class="p">]):</span>
            <span class="n">G</span><span class="p">[</span><span class="n">u</span><span class="p">][</span><span class="n">v</span><span class="p">][</span><span class="s1">&#39;count&#39;</span><span class="p">]</span> <span class="o">*=</span> <span class="n">ALPHA</span>

        <span class="c1"># if there is similarity probability somewhere</span>
        <span class="k">if</span> <span class="n">normalization_sum</span><span class="p">:</span>
            <span class="c1"># add similarity probability</span>
            <span class="k">for</span> <span class="n">deno</span> <span class="ow">in</span> <span class="n">G</span><span class="o">.</span><span class="n">nodes_iter</span><span class="p">():</span>
                <span class="c1"># skip if same node or there is nothing that can be added to that node</span>
                <span class="k">if</span> <span class="n">node</span> <span class="o">==</span> <span class="n">deno</span> <span class="ow">or</span> <span class="n">similarity_count_dict</span><span class="o">.</span><span class="n">get</span><span class="p">((</span><span class="n">node</span><span class="p">,</span> <span class="n">deno</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">continue</span>

                <span class="n">partial_prob</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">ALPHA</span><span class="p">)</span> <span class="o">*</span> <span class="n">similarity_count_dict</span><span class="o">.</span><span class="n">get</span><span class="p">((</span><span class="n">node</span><span class="p">,</span> <span class="n">deno</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="n">normalization_sum</span>

                <span class="k">if</span> <span class="n">G</span><span class="o">.</span><span class="n">has_edge</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">deno</span><span class="p">):</span>
                    <span class="n">G</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="n">deno</span><span class="p">][</span><span class="s1">&#39;count&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">partial_prob</span>
                <span class="k">elif</span> <span class="n">partial_prob</span><span class="p">:</span>  <span class="c1"># there wasn&#39;t an edge but now there is partial prob from other nodes</span>
                    <span class="n">G</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">deno</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;count&#39;</span><span class="p">:</span> <span class="n">partial_prob</span><span class="p">})</span>

    <span class="k">return</span> <span class="n">G</span><span class="p">,</span> <span class="n">similarity_dict</span><span class="p">,</span> <span class="n">similarity_count_dict</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MarkovChainRecommender</span><span class="p">(</span><span class="n">ISeqRecommender</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Implementation from Shani, Guy, David Heckerman, and Ronen I. Brafman. &quot;An MDP-based recommender system.&quot;</span>
<span class="sd">    Journal of Machine Learning Research 6, no. Sep (2005): 1265-1295. Chapter 3-4</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1"> - </span><span class="si">%(levelname)s</span><span class="s1"> - </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param order: the order of the Markov Chain</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">MarkovChainRecommender</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">order</span> <span class="o">=</span> <span class="n">order</span>

    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">train_data</span><span class="p">):</span>
        <span class="n">sequences</span> <span class="o">=</span> <span class="n">train_data</span><span class="p">[</span><span class="s1">&#39;sequence&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Building Markov Chain model with k = &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">order</span><span class="p">))</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Adding nodes&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">count_dict</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">G</span> <span class="o">=</span> <span class="n">add_nodes_to_graph</span><span class="p">(</span><span class="n">sequences</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">order</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Adding edges&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">G</span> <span class="o">=</span> <span class="n">add_edges</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">count_dict</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">G</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">order</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Applying skipping&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">G</span> <span class="o">=</span> <span class="n">apply_skipping</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">G</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">order</span><span class="p">,</span> <span class="n">sequences</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Applying clustering&#39;</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> states in the graph&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">G</span><span class="o">.</span><span class="n">nodes</span><span class="p">())))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">G</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">apply_clustering</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">G</span><span class="p">)</span>
        <span class="c1"># drop not useful resources</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tree</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">count_dict</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">recommend</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_profile</span><span class="p">,</span> <span class="n">user_id</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="c1"># if the user profile is longer than the markov order, chop it keeping recent history</span>
        <span class="n">state</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">user_profile</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">order</span><span class="p">:])</span>
        <span class="c1"># see if graph has that state</span>
        <span class="n">recommendations</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">G</span><span class="o">.</span><span class="n">has_node</span><span class="p">(</span><span class="n">state</span><span class="p">):</span>
            <span class="c1"># search for recommendations in the forward star</span>
            <span class="n">rec_dict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">G</span><span class="o">.</span><span class="n">out_edges_iter</span><span class="p">([</span><span class="n">state</span><span class="p">]):</span>
                <span class="n">lastElement</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:])</span>
                <span class="k">if</span> <span class="n">lastElement</span> <span class="ow">in</span> <span class="n">rec_dict</span><span class="p">:</span>
                    <span class="n">rec_dict</span><span class="p">[</span><span class="n">lastElement</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">G</span><span class="p">[</span><span class="n">u</span><span class="p">][</span><span class="n">v</span><span class="p">][</span><span class="s1">&#39;count&#39;</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">rec_dict</span><span class="p">[</span><span class="n">lastElement</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">G</span><span class="p">[</span><span class="n">u</span><span class="p">][</span><span class="n">v</span><span class="p">][</span><span class="s1">&#39;count&#39;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">rec_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">recommendations</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="nb">list</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="n">v</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">recommendations</span>

    <span class="k">def</span> <span class="nf">_set_graph_debug</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">G</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">G</span> <span class="o">=</span> <span class="n">G</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MixedMarkovChainRecommender</span><span class="p">(</span><span class="n">ISeqRecommender</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates markov models with different values of k, and return recommendation by weighting the list of</span>
<span class="sd">    recommendation of each model.</span>

<span class="sd">    Reference: Shani, Guy, David Heckerman, and Ronen I. Brafman. &quot;An MDP-based recommender system.&quot;</span>
<span class="sd">    Journal of Machine Learning Research 6, no. Sep (2005): 1265-1295. Chapter 3-4</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1"> - </span><span class="si">%(levelname)s</span><span class="s1"> - </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="n">recommenders</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">min_order</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_order</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param min_order: the minimum order of the Mixed Markov Chain</span>
<span class="sd">        :param max_order: the maximum order of the Mixed Markov Chain</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">MixedMarkovChainRecommender</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_order</span> <span class="o">=</span> <span class="n">min_order</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_order</span> <span class="o">=</span> <span class="n">max_order</span>
        <span class="c1"># define the models</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">min_order</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_order</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">recommenders</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">MarkovChainRecommender</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_profile</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">order</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">recommenders</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">recommenders</span><span class="p">[</span><span class="n">order</span><span class="p">]</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">user_profile</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">recommend</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_profile</span><span class="p">,</span> <span class="n">user_id</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">rec_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">recommendations</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">sum_of_weights</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">order</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">recommenders</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">rec_list</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">recommend</span><span class="p">(</span><span class="n">user_profile</span><span class="p">)</span>
            <span class="n">sum_of_weights</span> <span class="o">+=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">order</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">rec_list</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">in</span> <span class="n">rec_dict</span><span class="p">:</span>
                    <span class="n">rec_dict</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span> <span class="o">+=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">order</span> <span class="o">*</span> <span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">rec_dict</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">order</span> <span class="o">*</span> <span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">rec_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">recommendations</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="nb">list</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="n">v</span> <span class="o">/</span> <span class="n">sum_of_weights</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">recommendations</span>

    <span class="k">def</span> <span class="nf">_set_model_debug</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recommender</span><span class="p">,</span> <span class="n">order</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">recommenders</span><span class="p">[</span><span class="n">order</span><span class="p">]</span> <span class="o">=</span> <span class="n">recommender</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># You can try with max_order=2 or higher too, but it will take some time to complete though due to slow heristic computations</span>
<span class="n">mmcrecommender</span> <span class="o">=</span> <span class="n">MixedMarkovChainRecommender</span><span class="p">(</span><span class="n">min_order</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_order</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">mmcrecommender</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_data</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2021-04-25 13:57:40,210 - INFO - Building Markov Chain model with k = 1
2021-04-25 13:57:40,213 - INFO - Adding nodes
2021-04-25 13:57:40,499 - INFO - Adding edges
2021-04-25 13:57:58,752 - INFO - Applying skipping
2021-04-25 13:57:58,973 - INFO - Applying clustering
2021-04-25 13:57:58,974 - INFO - 999 states in the graph
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="fpmc">
<h3>FPMC<a class="headerlink" href="#fpmc" title="Permalink to this headline">¶</a></h3>
<p>Here we fit the recommedation algorithm over the sessions in the training set.<br />
This recommender is based on the following paper:</p>
<p><em>Rendle, S., Freudenthaler, C., &amp; Schmidt-Thieme, L. (2010). Factorizing personalized Markov chains for next-basket recommendation. Proceedings of the 19th International Conference on World Wide Web - WWW ’10, 811</em></p>
<p>In short, FPMC factorizes a personalized order-1 transition tensor using Tensor Factorization with pairwise loss function akin to BPR (Bayesian Pairwise Ranking).</p>
<p>TF allows to impute values for the missing transitions between items for each user. For this reason, FPMC can be used for generating <em>personalized</em> recommendations in session-aware recommenders as well.</p>
<p>In this notebook, you will be able to change the number of latent factors and a few other learning hyper-parameters and see the impact on the recommendation quality.</p>
<p>The class <code class="docutils literal notranslate"><span class="pre">FPMCRecommender</span></code> has the following initialization hyper-parameters:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">n_factor</span></code>: (optional) the number of latent factors</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">learn_rate</span></code>: (optional) the learning rate</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">regular</span></code>: (optional) the L2 regularization coefficient</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">n_epoch</span></code>: (optional) the number of training epochs</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">n_neg</span></code>: (optional) the number of negative samples used in BPR learning</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">sigmoid</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">logaddexp</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">x</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">logaddexp</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">load_data_from_dir</span><span class="p">(</span><span class="n">dirname</span><span class="p">):</span>
    <span class="n">fname_user_idxseq</span> <span class="o">=</span> <span class="n">dirname</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="s1">&#39;idxseq.txt&#39;</span>
    <span class="n">fname_user_list</span> <span class="o">=</span> <span class="n">dirname</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="s1">&#39;user_idx_list.txt&#39;</span>
    <span class="n">fname_item_list</span> <span class="o">=</span> <span class="n">dirname</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="s1">&#39;item_idx_list.txt&#39;</span>
    <span class="n">user_set</span> <span class="o">=</span> <span class="n">load_idx_list_file</span><span class="p">(</span><span class="n">fname_user_list</span><span class="p">)</span>
    <span class="n">item_set</span> <span class="o">=</span> <span class="n">load_idx_list_file</span><span class="p">(</span><span class="n">fname_item_list</span><span class="p">)</span>

    <span class="n">data_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname_user_idxseq</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">l</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">l</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()]</span>
            <span class="n">user</span> <span class="o">=</span> <span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">b_tm1</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
            <span class="n">label</span> <span class="o">=</span> <span class="n">l</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

            <span class="n">data_list</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">user</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">b_tm1</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">data_list</span><span class="p">,</span> <span class="n">user_set</span><span class="p">,</span> <span class="n">item_set</span>


<span class="k">def</span> <span class="nf">load_idx_list_file</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">):</span>
    <span class="n">idx_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="c1"># dicard header</span>
        <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="n">delimiter</span><span class="p">,</span> <span class="n">quotechar</span><span class="o">=</span><span class="s1">&#39;&quot;&#39;</span><span class="p">):</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">idx_set</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">idx_set</span>


<span class="k">def</span> <span class="nf">data_to_3_list</span><span class="p">(</span><span class="n">data_list</span><span class="p">):</span>
    <span class="n">u_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">i_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">b_tm1_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">max_l</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data_list</span><span class="p">:</span>
        <span class="n">u_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">i_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">b_tm1_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">max_l</span><span class="p">:</span>
            <span class="n">max_l</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">b_tm1</span> <span class="ow">in</span> <span class="n">b_tm1_list</span><span class="p">:</span>
        <span class="n">b_tm1</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_l</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">b_tm1</span><span class="p">))])</span>
    <span class="n">b_tm1_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">b_tm1_list</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">u_list</span><span class="p">,</span> <span class="n">i_list</span><span class="p">,</span> <span class="n">b_tm1_list</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">FPMC_basic</span><span class="p">:</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1"> - </span><span class="si">%(levelname)s</span><span class="s1"> - </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_user</span><span class="p">,</span> <span class="n">n_item</span><span class="p">,</span> <span class="n">n_factor</span><span class="p">,</span> <span class="n">learn_rate</span><span class="p">,</span> <span class="n">regular</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">item_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">n_user</span> <span class="o">=</span> <span class="n">n_user</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_item</span> <span class="o">=</span> <span class="n">n_item</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">n_factor</span> <span class="o">=</span> <span class="n">n_factor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">learn_rate</span> <span class="o">=</span> <span class="n">learn_rate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">regular</span> <span class="o">=</span> <span class="n">regular</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">dump</span><span class="p">(</span><span class="n">fpmcObj</span><span class="p">,</span> <span class="n">fname</span><span class="p">):</span>
        <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">fpmcObj</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">))</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="n">fname</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">init_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">std</span><span class="o">=</span><span class="mf">0.01</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">VUI</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">std</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_user</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_factor</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">VIU</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">std</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_item</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_factor</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">VIL</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">std</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_item</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_factor</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">VLI</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">std</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_item</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_factor</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">VUI_m_VIU</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">VUI</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">VIU</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">VIL_m_VLI</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">VIL</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">VLI</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">compute_x</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">b_tm1</span><span class="p">):</span>
        <span class="n">acc_val</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">b_tm1</span><span class="p">:</span>
            <span class="n">acc_val</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">VIL</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">VLI</span><span class="p">[</span><span class="n">l</span><span class="p">])</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">VUI</span><span class="p">[</span><span class="n">u</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">VIU</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">+</span> <span class="p">(</span><span class="n">acc_val</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">b_tm1</span><span class="p">)))</span>

    <span class="k">def</span> <span class="nf">compute_x_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">b_tm1</span><span class="p">):</span>
        <span class="n">former</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">VUI_m_VIU</span><span class="p">[</span><span class="n">u</span><span class="p">]</span>
        <span class="n">latter</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">VIL_m_VLI</span><span class="p">[:,</span> <span class="n">b_tm1</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">former</span> <span class="o">+</span> <span class="n">latter</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">evaluation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_list</span><span class="p">):</span>
        <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">VUI</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">VIU</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">VUI_m_VIU</span><span class="p">)</span>
        <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">VIL</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">VLI</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">VIL_m_VLI</span><span class="p">)</span>

        <span class="n">correct_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">rr_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">b_tm1</span><span class="p">)</span> <span class="ow">in</span> <span class="n">data_list</span><span class="p">:</span>
            <span class="n">scores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_x_batch</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">b_tm1</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">scores</span><span class="o">.</span><span class="n">argmax</span><span class="p">():</span>
                <span class="n">correct_count</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="n">rank</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">scores</span> <span class="o">&gt;</span> <span class="n">scores</span><span class="p">[</span><span class="n">i</span><span class="p">])[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">rr</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">rank</span>
            <span class="n">rr_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rr</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">acc</span> <span class="o">=</span> <span class="n">correct_count</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">rr_list</span><span class="p">)</span>
            <span class="n">mrr</span> <span class="o">=</span> <span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">rr_list</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">rr_list</span><span class="p">))</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">acc</span><span class="p">,</span> <span class="n">mrr</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">learn_epoch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tr_data</span><span class="p">,</span> <span class="n">neg_batch_size</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">iter_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tr_data</span><span class="p">)):</span>
            <span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">b_tm1</span><span class="p">)</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">tr_data</span><span class="p">)</span>

            <span class="n">exclu_set</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_set</span> <span class="o">-</span> <span class="nb">set</span><span class="p">([</span><span class="n">i</span><span class="p">])</span>
            <span class="n">j_list</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">exclu_set</span><span class="p">,</span> <span class="n">neg_batch_size</span><span class="p">)</span>

            <span class="n">z1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_x</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">b_tm1</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">j_list</span><span class="p">:</span>
                <span class="n">z2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_x</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">b_tm1</span><span class="p">)</span>
                <span class="n">delta</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">sigmoid</span><span class="p">(</span><span class="n">z1</span> <span class="o">-</span> <span class="n">z2</span><span class="p">)</span>

                <span class="n">VUI_update</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">learn_rate</span> <span class="o">*</span> <span class="p">(</span><span class="n">delta</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">VIU</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">VIU</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">regular</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">VUI</span><span class="p">[</span><span class="n">u</span><span class="p">])</span>
                <span class="n">VIUi_update</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">learn_rate</span> <span class="o">*</span> <span class="p">(</span><span class="n">delta</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">VUI</span><span class="p">[</span><span class="n">u</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">regular</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">VIU</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">VIUj_update</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">learn_rate</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="n">delta</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">VUI</span><span class="p">[</span><span class="n">u</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">regular</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">VIU</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">VUI</span><span class="p">[</span><span class="n">u</span><span class="p">]</span> <span class="o">+=</span> <span class="n">VUI_update</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">VIU</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">VIUi_update</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">VIU</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+=</span> <span class="n">VIUj_update</span>

                <span class="n">eta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">VLI</span><span class="p">[</span><span class="n">b_tm1</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">VILi_update</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">learn_rate</span> <span class="o">*</span> <span class="p">(</span><span class="n">delta</span> <span class="o">*</span> <span class="n">eta</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">regular</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">VIL</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">VILj_update</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">learn_rate</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="n">delta</span> <span class="o">*</span> <span class="n">eta</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">regular</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">VIL</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
                <span class="n">VLI_update</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">learn_rate</span> <span class="o">*</span> <span class="p">(</span>
                        <span class="p">(</span><span class="n">delta</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">VIL</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">VIL</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">b_tm1</span><span class="p">))</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">regular</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">VLI</span><span class="p">[</span><span class="n">b_tm1</span><span class="p">])</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">VIL</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">VILi_update</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">VIL</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+=</span> <span class="n">VILj_update</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">VLI</span><span class="p">[</span><span class="n">b_tm1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">VLI_update</span>

    <span class="k">def</span> <span class="nf">learnSBPR_FPMC</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tr_data</span><span class="p">,</span> <span class="n">n_epoch</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">neg_batch_size</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_epoch</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">learn_epoch</span><span class="p">(</span><span class="n">tr_data</span><span class="p">,</span> <span class="n">neg_batch_size</span><span class="o">=</span><span class="n">neg_batch_size</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;epoch </span><span class="si">%d</span><span class="s1"> done&#39;</span> <span class="o">%</span> <span class="n">epoch</span><span class="p">)</span>
            <span class="c1"># if eval_per_epoch == True:</span>
            <span class="c1">#     acc_in, mrr_in = self.evaluation(tr_data)</span>
            <span class="c1">#     if te_data != None:</span>
            <span class="c1">#         acc_out, mrr_out = self.evaluation(te_data)</span>
            <span class="c1">#         self.logger.info (&#39;In sample:%.4f\t%.4f \t Out sample:%.4f\t%.4f&#39; % (acc_in, mrr_in, acc_out, mrr_out))</span>
            <span class="c1">#     else:</span>
            <span class="c1">#         self.logger.info (&#39;In sample:%.4f\t%.4f&#39; % (acc_in, mrr_in))</span>
            <span class="c1"># else:</span>
            <span class="c1">#</span>

        <span class="c1"># if eval_per_epoch == False:</span>
        <span class="c1">#     acc_in, mrr_in = self.evaluation(tr_data)</span>
        <span class="c1">#     if te_data != None:</span>
        <span class="c1">#         acc_out, mrr_out = self.evaluation(te_data)</span>
        <span class="c1">#         print (&#39;In sample:%.4f\t%.4f \t Out sample:%.4f\t%.4f&#39; % (acc_in, mrr_in, acc_out, mrr_out))</span>
        <span class="c1">#     else:</span>
        <span class="c1">#         print (&#39;In sample:%.4f\t%.4f&#39; % (acc_in, mrr_in))</span>
        <span class="c1">#</span>
        <span class="c1"># if te_data != None:</span>
        <span class="c1">#     return (acc_out, mrr_out)</span>
        <span class="c1"># else:</span>
        <span class="c1">#     return None</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">FPMC</span><span class="p">(</span><span class="n">FPMC_basic</span><span class="p">):</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1"> - </span><span class="si">%(levelname)s</span><span class="s1"> - </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_user</span><span class="p">,</span> <span class="n">n_item</span><span class="p">,</span> <span class="n">n_factor</span><span class="p">,</span> <span class="n">learn_rate</span><span class="p">,</span> <span class="n">regular</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">FPMC</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">n_user</span><span class="p">,</span> <span class="n">n_item</span><span class="p">,</span> <span class="n">n_factor</span><span class="p">,</span> <span class="n">learn_rate</span><span class="p">,</span> <span class="n">regular</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">evaluation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_3_list</span><span class="p">):</span>
        <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">VUI</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">VIU</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">VUI_m_VIU</span><span class="p">)</span>
        <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">VIL</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">VLI</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">VIL_m_VLI</span><span class="p">)</span>
        <span class="n">acc</span><span class="p">,</span> <span class="n">mrr</span> <span class="o">=</span> <span class="n">evaluation_jit</span><span class="p">(</span><span class="n">data_3_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">data_3_list</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">data_3_list</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">VUI_m_VIU</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">VIL_m_VLI</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">acc</span><span class="p">,</span> <span class="n">mrr</span>

    <span class="k">def</span> <span class="nf">evaluation_recommender</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">user_profile</span><span class="p">):</span>
        <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">VUI</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">VIU</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">VUI_m_VIU</span><span class="p">)</span>
        <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">VIL</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">VLI</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">VIL_m_VLI</span><span class="p">)</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="n">evaluation_jit_recommender</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">user_profile</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">VUI_m_VIU</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">VIL_m_VLI</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">scores</span><span class="p">)),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="o">-</span><span class="n">scores</span><span class="p">[</span><span class="n">x</span><span class="p">]),</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">scores</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">learn_epoch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_3_list</span><span class="p">,</span> <span class="n">neg_batch_size</span><span class="p">):</span>
        <span class="n">VUI</span><span class="p">,</span> <span class="n">VIU</span><span class="p">,</span> <span class="n">VLI</span><span class="p">,</span> <span class="n">VIL</span> <span class="o">=</span> <span class="n">learn_epoch_jit</span><span class="p">(</span><span class="n">data_3_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">data_3_list</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">data_3_list</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">neg_batch_size</span><span class="p">,</span>
                                             <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">item_set</span><span class="p">)),</span> <span class="bp">self</span><span class="o">.</span><span class="n">VUI</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">VIU</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">VLI</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">VIL</span><span class="p">,</span>
                                             <span class="bp">self</span><span class="o">.</span><span class="n">learn_rate</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">regular</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">VUI</span> <span class="o">=</span> <span class="n">VUI</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">VIU</span> <span class="o">=</span> <span class="n">VIU</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">VLI</span> <span class="o">=</span> <span class="n">VLI</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">VIL</span> <span class="o">=</span> <span class="n">VIL</span>

    <span class="k">def</span> <span class="nf">learnSBPR_FPMC</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tr_data</span><span class="p">,</span> <span class="n">n_epoch</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">neg_batch_size</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
        <span class="n">tr_3_list</span> <span class="o">=</span> <span class="n">data_to_3_list</span><span class="p">(</span><span class="n">tr_data</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_epoch</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">learn_epoch</span><span class="p">(</span><span class="n">tr_3_list</span><span class="p">,</span> <span class="n">neg_batch_size</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;epoch </span><span class="si">%d</span><span class="s1"> done&#39;</span> <span class="o">%</span> <span class="n">epoch</span><span class="p">)</span>

        <span class="c1"># if eval_per_epoch == False:</span>
        <span class="c1">#     acc_in, mrr_in = self.evaluation(tr_3_list)</span>
        <span class="c1">#     if te_data != None:</span>
        <span class="c1">#         acc_out, mrr_out = self.evaluation(te_3_list)</span>
        <span class="c1">#         print (&#39;In sample:%.4f\t%.4f \t Out sample:%.4f\t%.4f&#39; % (acc_in, mrr_in, acc_out, mrr_out))</span>
        <span class="c1">#     else:</span>
        <span class="c1">#         print (&#39;In sample:%.4f\t%.4f&#39; % (acc_in, mrr_in))</span>
        <span class="c1">#</span>
        <span class="c1">#</span>
        <span class="c1"># if te_data != None:</span>
        <span class="c1">#     if ret_in_score:</span>
        <span class="c1">#         return (acc_in, mrr_in, acc_out, mrr_out)</span>
        <span class="c1">#     else:</span>
        <span class="c1">#         return (acc_out, mrr_out)</span>
        <span class="c1"># else:</span>
        <span class="c1">#     return None</span>


<span class="nd">@jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">compute_x_jit</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">b_tm1</span><span class="p">,</span> <span class="n">VUI</span><span class="p">,</span> <span class="n">VIU</span><span class="p">,</span> <span class="n">VLI</span><span class="p">,</span> <span class="n">VIL</span><span class="p">):</span>
    <span class="n">acc_val</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">b_tm1</span><span class="p">:</span>
        <span class="n">acc_val</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">VIL</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">VLI</span><span class="p">[</span><span class="n">l</span><span class="p">])</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">VUI</span><span class="p">[</span><span class="n">u</span><span class="p">],</span> <span class="n">VIU</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">+</span> <span class="p">(</span><span class="n">acc_val</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">b_tm1</span><span class="p">)))</span>


<span class="nd">@jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">learn_epoch_jit</span><span class="p">(</span><span class="n">u_list</span><span class="p">,</span> <span class="n">i_list</span><span class="p">,</span> <span class="n">b_tm1_list</span><span class="p">,</span> <span class="n">neg_batch_size</span><span class="p">,</span> <span class="n">item_set</span><span class="p">,</span> <span class="n">VUI</span><span class="p">,</span> <span class="n">VIU</span><span class="p">,</span> <span class="n">VLI</span><span class="p">,</span> <span class="n">VIL</span><span class="p">,</span> <span class="n">learn_rate</span><span class="p">,</span> <span class="n">regular</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">iter_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">u_list</span><span class="p">)):</span>
        <span class="n">d_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">u_list</span><span class="p">))</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">u_list</span><span class="p">[</span><span class="n">d_idx</span><span class="p">]</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">i_list</span><span class="p">[</span><span class="n">d_idx</span><span class="p">]</span>
        <span class="n">b_tm1</span> <span class="o">=</span> <span class="n">b_tm1_list</span><span class="p">[</span><span class="n">d_idx</span><span class="p">][</span><span class="n">b_tm1_list</span><span class="p">[</span><span class="n">d_idx</span><span class="p">]</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">j_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">item_set</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">neg_batch_size</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">z1</span> <span class="o">=</span> <span class="n">compute_x_jit</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">b_tm1</span><span class="p">,</span> <span class="n">VUI</span><span class="p">,</span> <span class="n">VIU</span><span class="p">,</span> <span class="n">VLI</span><span class="p">,</span> <span class="n">VIL</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">j_list</span><span class="p">:</span>
            <span class="n">z2</span> <span class="o">=</span> <span class="n">compute_x_jit</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">b_tm1</span><span class="p">,</span> <span class="n">VUI</span><span class="p">,</span> <span class="n">VIU</span><span class="p">,</span> <span class="n">VLI</span><span class="p">,</span> <span class="n">VIL</span><span class="p">)</span>
            <span class="n">delta</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">sigmoid_jit</span><span class="p">(</span><span class="n">z1</span> <span class="o">-</span> <span class="n">z2</span><span class="p">)</span>

            <span class="n">VUI_update</span> <span class="o">=</span> <span class="n">learn_rate</span> <span class="o">*</span> <span class="p">(</span><span class="n">delta</span> <span class="o">*</span> <span class="p">(</span><span class="n">VIU</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">VIU</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="o">-</span> <span class="n">regular</span> <span class="o">*</span> <span class="n">VUI</span><span class="p">[</span><span class="n">u</span><span class="p">])</span>
            <span class="n">VIUi_update</span> <span class="o">=</span> <span class="n">learn_rate</span> <span class="o">*</span> <span class="p">(</span><span class="n">delta</span> <span class="o">*</span> <span class="n">VUI</span><span class="p">[</span><span class="n">u</span><span class="p">]</span> <span class="o">-</span> <span class="n">regular</span> <span class="o">*</span> <span class="n">VIU</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">VIUj_update</span> <span class="o">=</span> <span class="n">learn_rate</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="n">delta</span> <span class="o">*</span> <span class="n">VUI</span><span class="p">[</span><span class="n">u</span><span class="p">]</span> <span class="o">-</span> <span class="n">regular</span> <span class="o">*</span> <span class="n">VIU</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>

            <span class="n">VUI</span><span class="p">[</span><span class="n">u</span><span class="p">]</span> <span class="o">+=</span> <span class="n">VUI_update</span>
            <span class="n">VIU</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">VIUi_update</span>
            <span class="n">VIU</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+=</span> <span class="n">VIUj_update</span>

            <span class="n">eta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">VLI</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">b_tm1</span><span class="p">:</span>
                <span class="n">eta</span> <span class="o">+=</span> <span class="n">VLI</span><span class="p">[</span><span class="n">l</span><span class="p">]</span>
            <span class="n">eta</span> <span class="o">=</span> <span class="n">eta</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">b_tm1</span><span class="p">)</span>

            <span class="n">VILi_update</span> <span class="o">=</span> <span class="n">learn_rate</span> <span class="o">*</span> <span class="p">(</span><span class="n">delta</span> <span class="o">*</span> <span class="n">eta</span> <span class="o">-</span> <span class="n">regular</span> <span class="o">*</span> <span class="n">VIL</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">VILj_update</span> <span class="o">=</span> <span class="n">learn_rate</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="n">delta</span> <span class="o">*</span> <span class="n">eta</span> <span class="o">-</span> <span class="n">regular</span> <span class="o">*</span> <span class="n">VIL</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
            <span class="n">VLI_updates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">b_tm1</span><span class="p">),</span> <span class="n">VLI</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">b_tm1</span><span class="p">):</span>
                <span class="n">VLI_updates</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">learn_rate</span> <span class="o">*</span> <span class="p">((</span><span class="n">delta</span> <span class="o">*</span> <span class="p">(</span><span class="n">VIL</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">VIL</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">b_tm1</span><span class="p">))</span> <span class="o">-</span> <span class="n">regular</span> <span class="o">*</span> <span class="n">VLI</span><span class="p">[</span><span class="n">l</span><span class="p">])</span>

            <span class="n">VIL</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">VILi_update</span>
            <span class="n">VIL</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+=</span> <span class="n">VILj_update</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">b_tm1</span><span class="p">):</span>
                <span class="n">VLI</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="o">+=</span> <span class="n">VLI_updates</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">VUI</span><span class="p">,</span> <span class="n">VIU</span><span class="p">,</span> <span class="n">VLI</span><span class="p">,</span> <span class="n">VIL</span>


<span class="nd">@jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">sigmoid_jit</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">logaddexp</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">x</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">logaddexp</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>


<span class="nd">@jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">compute_x_batch_jit</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">b_tm1</span><span class="p">,</span> <span class="n">VUI_m_VIU</span><span class="p">,</span> <span class="n">VIL_m_VLI</span><span class="p">):</span>
    <span class="n">former</span> <span class="o">=</span> <span class="n">VUI_m_VIU</span><span class="p">[</span><span class="n">u</span><span class="p">]</span>
    <span class="n">latter</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">VIL_m_VLI</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">VIL_m_VLI</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">b_tm1</span><span class="p">:</span>
            <span class="n">latter</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">+=</span> <span class="n">VIL_m_VLI</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="n">l</span><span class="p">]</span>
    <span class="n">latter</span> <span class="o">=</span> <span class="n">latter</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">b_tm1</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">former</span> <span class="o">+</span> <span class="n">latter</span><span class="p">)</span>


<span class="nd">@jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">evaluation_jit</span><span class="p">(</span><span class="n">u_list</span><span class="p">,</span> <span class="n">i_list</span><span class="p">,</span> <span class="n">b_tm1_list</span><span class="p">,</span> <span class="n">VUI_m_VIU</span><span class="p">,</span> <span class="n">VIL_m_VLI</span><span class="p">):</span>
    <span class="n">correct_count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">acc_rr</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">d_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">u_list</span><span class="p">)):</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">u_list</span><span class="p">[</span><span class="n">d_idx</span><span class="p">]</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">i_list</span><span class="p">[</span><span class="n">d_idx</span><span class="p">]</span>
        <span class="n">b_tm1</span> <span class="o">=</span> <span class="n">b_tm1_list</span><span class="p">[</span><span class="n">d_idx</span><span class="p">][</span><span class="n">b_tm1_list</span><span class="p">[</span><span class="n">d_idx</span><span class="p">]</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="n">compute_x_batch_jit</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">b_tm1</span><span class="p">,</span> <span class="n">VUI_m_VIU</span><span class="p">,</span> <span class="n">VIL_m_VLI</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">scores</span><span class="o">.</span><span class="n">argmax</span><span class="p">():</span>
            <span class="n">correct_count</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">rank</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">scores</span> <span class="o">&gt;</span> <span class="n">scores</span><span class="p">[</span><span class="n">i</span><span class="p">])[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">rr</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">rank</span>
        <span class="n">acc_rr</span> <span class="o">+=</span> <span class="n">rr</span>

    <span class="n">acc</span> <span class="o">=</span> <span class="n">correct_count</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">u_list</span><span class="p">)</span>
    <span class="n">mrr</span> <span class="o">=</span> <span class="n">acc_rr</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">u_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">acc</span><span class="p">,</span> <span class="n">mrr</span><span class="p">)</span>


<span class="nd">@jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">evaluation_jit_recommender</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">b_tm1_list</span><span class="p">,</span> <span class="n">VUI_m_VIU</span><span class="p">,</span> <span class="n">VIL_m_VLI</span><span class="p">):</span>
    <span class="n">u</span> <span class="o">=</span> <span class="n">user</span>
    <span class="c1"># b_tm1 = [x for x in b_tm1_list if x!=-1]</span>
    <span class="n">b_tm1</span> <span class="o">=</span> <span class="n">b_tm1_list</span>
    <span class="n">scores</span> <span class="o">=</span> <span class="n">compute_x_batch_jit</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">b_tm1</span><span class="p">,</span> <span class="n">VUI_m_VIU</span><span class="p">,</span> <span class="n">VIL_m_VLI</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">scores</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">FPMCRecommender</span><span class="p">(</span><span class="n">ISeqRecommender</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Implementation of</span>
<span class="sd">    Rendle, S., Freudenthaler, C., &amp; Schmidt-Thieme, L. (2010). Factorizing personalized Markov chains for next-basket recommendation.</span>
<span class="sd">    Proceedings of the 19th International Conference on World Wide Web - WWW ’10, 811</span>

<span class="sd">    Based on the implementation available at https://github.com/khesui/FPMC</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_factor</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">learn_rate</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">regular</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">n_epoch</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">n_neg</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param n_factor: (optional) the number of latent factors</span>
<span class="sd">        :param learn_rate: (optional) the learning rate</span>
<span class="sd">        :param regular: (optional) the L2 regularization coefficient</span>
<span class="sd">        :param n_epoch: (optional) the number of training epochs</span>
<span class="sd">        :param n_neg: (optional) the number of negative samples used in BPR learning</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">FPMCRecommender</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_epoch</span> <span class="o">=</span> <span class="n">n_epoch</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_neg</span> <span class="o">=</span> <span class="n">n_neg</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_factor</span> <span class="o">=</span> <span class="n">n_factor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">learn_rate</span> <span class="o">=</span> <span class="n">learn_rate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">regular</span> <span class="o">=</span> <span class="n">regular</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;FPMCRecommender(n_epoch=</span><span class="si">{n_epoch}</span><span class="s1">, &#39;</span> \
               <span class="s1">&#39;n_neg=</span><span class="si">{n_neg}</span><span class="s1">, &#39;</span> \
               <span class="s1">&#39;n_factor=</span><span class="si">{n_factor}</span><span class="s1">, &#39;</span> \
               <span class="s1">&#39;learn_rate=</span><span class="si">{learn_rate}</span><span class="s1">, &#39;</span> \
               <span class="s1">&#39;regular=</span><span class="si">{regular}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">train_data</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_declare</span><span class="p">(</span><span class="n">train_data</span><span class="p">)</span>

        <span class="n">train_data_supervised</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">train_data</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_mapping</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">]]</span>

            <span class="n">seq</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;sequence&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># cannot use sequences with length 1 for supervised learning</span>
                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;sequence&#39;</span><span class="p">]:</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_mapping</span><span class="p">[</span><span class="n">item</span><span class="p">]</span>
                    <span class="n">seq</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

                <span class="n">train_data_supervised</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">u</span><span class="p">,</span> <span class="n">seq</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">seq</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="n">seq</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">seq</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fpmc</span> <span class="o">=</span> <span class="n">FPMC</span><span class="p">(</span><span class="n">n_user</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_mapping</span><span class="p">),</span> <span class="n">n_item</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">item_mapping</span><span class="p">),</span>
                         <span class="n">n_factor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n_factor</span><span class="p">,</span> <span class="n">learn_rate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">learn_rate</span><span class="p">,</span> <span class="n">regular</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">regular</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fpmc</span><span class="o">.</span><span class="n">user_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_mapping</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fpmc</span><span class="o">.</span><span class="n">item_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">item_mapping</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fpmc</span><span class="o">.</span><span class="n">init_model</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fpmc</span><span class="o">.</span><span class="n">learnSBPR_FPMC</span><span class="p">(</span><span class="n">train_data_supervised</span><span class="p">,</span> <span class="n">n_epoch</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n_epoch</span><span class="p">,</span> <span class="n">neg_batch_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n_neg</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">recommend</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_profile</span><span class="p">,</span> <span class="n">user_id</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">context</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">user_profile</span><span class="p">:</span>
            <span class="n">context</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">item_mapping</span><span class="p">[</span><span class="n">item</span><span class="p">])</span>

        <span class="n">items</span><span class="p">,</span> <span class="n">scores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fpmc</span><span class="o">.</span><span class="n">evaluation_recommender</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_mapping</span><span class="p">[</span><span class="n">user_id</span><span class="p">],</span> <span class="n">context</span><span class="p">)</span>
        <span class="n">recommendations</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">it</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">items</span><span class="p">):</span>
            <span class="n">recommendations</span><span class="o">.</span><span class="n">append</span><span class="p">(([</span><span class="bp">self</span><span class="o">.</span><span class="n">reverse_item_mapping</span><span class="p">[</span><span class="n">it</span><span class="p">]],</span> <span class="n">scores</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
        <span class="k">return</span> <span class="n">recommendations</span>

    <span class="k">def</span> <span class="nf">_declare</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_mapping</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">item_mapping</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reverse_item_mapping</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">user_counter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">item_counter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_mapping</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">user_mapping</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">user_counter</span>
                <span class="n">user_counter</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;sequence&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">item</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_mapping</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">item_mapping</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="o">=</span> <span class="n">item_counter</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">reverse_item_mapping</span><span class="p">[</span><span class="n">item_counter</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span>
                    <span class="n">item_counter</span> <span class="o">+=</span> <span class="mi">1</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">fpmcrecommender</span> <span class="o">=</span> <span class="n">FPMCRecommender</span><span class="p">(</span><span class="n">n_factor</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">n_epoch</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="n">fpmcrecommender</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_data</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2021-04-25 13:59:28,886 - INFO - epoch 0 done
2021-04-25 13:59:28,992 - INFO - epoch 1 done
2021-04-25 13:59:29,107 - INFO - epoch 2 done
2021-04-25 13:59:29,217 - INFO - epoch 3 done
2021-04-25 13:59:29,330 - INFO - epoch 4 done
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="prod2vec">
<h3>Prod2vec<a class="headerlink" href="#prod2vec" title="Permalink to this headline">¶</a></h3>
<img src='https://www.notion.so/image/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F4fb989da-3eee-495e-b562-92ef930df86d%2FUntitled.png?table=block&id=44191bff-f7b6-43a9-8cad-4431fe776d83&spaceId=63b72b1f-0e90-4ab8-a6df-a060a6545a56&width=2000&userId=21ec183f-f0be-4b6b-9b3e-6f0d4e5c5469&cache=v2'><p>Here we fit the recommedation algorithm over the sessions in the training set.</p>
<p>This is simplified implementation of the following:</p>
<p><em>Grbovic, Mihajlo, Vladan Radosavljevic, Nemanja Djuric, Narayan Bhamidipati,
Jaikit Savla, Varun Bhagwan, and Doug Sharp. “E-commerce in your inbox: Product recommendations at scale.”
In Proceedings of the 21th ACM SIGKDD International Conference on Knowledge Discovery and Data Mining, pp. 1809-1818. ACM, 2015.</em></p>
<p>This implementation uses the <code class="docutils literal notranslate"><span class="pre">gensim</span></code> implementation of Word2Vec to compute item embeddings using the skip-gram model.</p>
<p>Recommendations are generated by returning the k-nearest neighbors of the last items in the user profile, whose relevance is weighted using a simple <em>exponential decay</em> (the <em>last item</em> in the user profile is the <em>most relevant</em> one, and the <em>first item</em> the <em>least relevant</em>).</p>
<p>The original paper contains other variants of this algorithm (namely bagged-prod2vec and prod2vec-cluster) which are not subject of this tutorial.</p>
<p>The class <code class="docutils literal notranslate"><span class="pre">Prod2VecRecommender</span></code> has the following initialization hyper-parameters:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">min_count</span></code>: the minimum item frequency. Items less frequent that min_count will be pruned</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">size</span></code>: the size of the embeddings</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">window</span></code>: the size of the context window</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">decay_alpha</span></code>: the exponential decay factor used to discount the similarity scores for items  back in the user profile. Lower values mean higher discounting of past user interactions. Allows values in [0-1]</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">workers</span></code>: the number of threads used for training</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Prod2VecRecommender</span><span class="p">(</span><span class="n">ISeqRecommender</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Implementation of the Prod2Vec skipgram model from</span>
<span class="sd">    Grbovic Mihajlo, Vladan Radosavljevic, Nemanja Djuric, Narayan Bhamidipati, Jaikit Savla, Varun Bhagwan, and Doug Sharp.</span>
<span class="sd">    &quot;E-commerce in your inbox: Product recommendations at scale.&quot;</span>
<span class="sd">    In Proceedings of the 21th ACM SIGKDD International Conference on Knowledge Discovery and Data Mining,</span>
<span class="sd">    pp. 1809-1818. ACM, 2015.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1"> - </span><span class="si">%(levelname)s</span><span class="s1"> - </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">min_count</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">decay_alpha</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">workers</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param min_count: (optional) the minimum item frequency. Items less frequent that min_count will be pruned</span>
<span class="sd">        :param size: (optional) the size of the embeddings</span>
<span class="sd">        :param window: (optional) the size of the context window</span>
<span class="sd">        :param decay_alpha: (optional) the exponential decay factor used to discount the similarity scores for items</span>
<span class="sd">                back in the user profile. Lower values mean higher discounting of past user interactions. Allows values in [0-1].</span>
<span class="sd">        :param workers: (optional) the number of threads used for training</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Prod2VecRecommender</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_count</span> <span class="o">=</span> <span class="n">min_count</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">window</span> <span class="o">=</span> <span class="n">window</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">decay_alpha</span> <span class="o">=</span> <span class="n">decay_alpha</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">workers</span> <span class="o">=</span> <span class="n">workers</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;Prod2VecRecommender(min_count=</span><span class="si">{min_count}</span><span class="s1">, &#39;</span> \
               <span class="s1">&#39;size=</span><span class="si">{size}</span><span class="s1">, &#39;</span> \
               <span class="s1">&#39;window=</span><span class="si">{window}</span><span class="s1">, &#39;</span> \
               <span class="s1">&#39;decay_alpha=</span><span class="si">{decay_alpha}</span><span class="s1">, &#39;</span> \
               <span class="s1">&#39;workers=</span><span class="si">{workers}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">train_data</span><span class="p">):</span>
        <span class="n">sequences</span> <span class="o">=</span> <span class="n">train_data</span><span class="p">[</span><span class="s1">&#39;sequence&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">gensim</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Word2Vec</span><span class="p">(</span><span class="n">sequences</span><span class="p">,</span>
                                            <span class="n">min_count</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">min_count</span><span class="p">,</span>
                                            <span class="n">window</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">window</span><span class="p">,</span>
                                            <span class="n">hs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                            <span class="n">size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">,</span>
                                            <span class="n">sg</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                            <span class="n">workers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">workers</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">recommend</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_profile</span><span class="p">,</span> <span class="n">user_id</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">user_profile</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">user_profile</span><span class="p">))</span>
        <span class="n">rec</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># iterate the user profile backwards</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">user_profile</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">ms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">most_similar</span><span class="p">(</span><span class="n">positive</span><span class="o">=</span><span class="n">item</span><span class="p">)</span>
                <span class="c1"># apply exponential decay to the similarity scores</span>
                <span class="n">decay</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decay_alpha</span> <span class="o">**</span> <span class="n">i</span>
                <span class="n">ms</span> <span class="o">=</span> <span class="p">[(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">decay</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">ms</span><span class="p">]</span>
                <span class="n">rec</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">ms</span><span class="p">)</span>
            <span class="c1"># sort items by similarity score</span>
            <span class="n">rec</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="o">-</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">rec</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">return</span> <span class="p">[([</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">rec</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">p2vrecommender</span> <span class="o">=</span> <span class="n">Prod2VecRecommender</span><span class="p">(</span><span class="n">min_count</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> 
                                  <span class="n">size</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> 
                                  <span class="n">window</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                                  <span class="n">decay_alpha</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span>
                                  <span class="n">workers</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
<span class="n">p2vrecommender</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_data</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="session-based-rnn">
<h3>Session based RNN<a class="headerlink" href="#session-based-rnn" title="Permalink to this headline">¶</a></h3>
<p>Here we fit the recommedation algorithm over the sessions in the training set.</p>
<p>This is a <strong>simplified</strong> interface to Recurrent Neural Network models for Session-based recommendation.
Based on the following two papers:</p>
<ul class="simple">
<li><p>Recurrent Neural Networks with Top-k Gains for Session-based Recommendations, Hidasi and Karatzoglou, CIKM 2018</p></li>
<li><p>Personalizing Session-based Recommendation with Hierarchical Recurrent Neural Networks, Quadrana et al, Recsys 2017</p></li>
</ul>
<p>In this notebook, we will consider the session-based (<strong>non-personalized</strong>) version of the algorithm.
Here’s a schematic representation of the model:</p>
<img src='https://www.notion.so/image/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2Ffe88d088-1384-4c25-ae8b-626e148099c7%2FUntitled.png?table=block&id=f3bdbe38-a195-4525-bbb5-cb4c84499aee&spaceId=63b72b1f-0e90-4ab8-a6df-a060a6545a56&width=2000&userId=21ec183f-f0be-4b6b-9b3e-6f0d4e5c5469&cache=v2'>
<p>Each item in the current user session is first encoded either using <em>1-hot encoding</em> or a <em>dense embedding vector</em>. The item representation is then forwarded to one or more Gated Reucurrent Unit (GRU) layers, which “mix” the information coming from the past steps of the sequence with the representation of the current item. The last hidden state of the network is finally use to compute the likelihood scores for the next items by using one out of several loss functions (e.g. cross-entropy, BPR, TOP1, BPR-max, TOP1-max, etc.).</p>
<p>For simplicity, we only support <em>1-hot encoded</em> inputs and the <em>BPR-max</em> loss function here.</p>
<p>The hyper-parameters of the model are:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">session_layers</span></code>: number of units per layer used at session level.
It has to be a list of integers for multi-layer networks, or a integer value for single-layer networks.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">user_layers</span></code>: number of units per layer used at user level. Required only by personalized models. (<code class="docutils literal notranslate"><span class="pre">None</span></code> in this case)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">batch_size</span></code>: the mini-batch size used in training</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">learning_rate</span></code>: the learning rate used in training (Adagrad optimized)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">momentum</span></code>: the momentum coefficient used in training</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">dropout</span></code>: it’s a float value for the hidden-layer(s) dropout.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">epochs</span></code>: number of training epochs</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">personalized</span></code>: whether to train a personalized model using the HRNN model (<code class="docutils literal notranslate"><span class="pre">False</span></code> in this case).</p></li>
</ul>
<p><strong>NOTE: GRU4Rec originally has many more hyper-parameters. Going through all of them is out from the scope of this tutorial, but we suggest to check-out the original source code <a class="reference external" href="https://github.com/hidasib/GRU4Rec">here</a> if you are interested.</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">dataset_to_gru4rec_format</span><span class="p">(</span><span class="n">dataset</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert a list of sequences to GRU4Rec format.</span>
<span class="sd">    Based on this StackOverflow answer: https://stackoverflow.com/a/48532692</span>

<span class="sd">    :param dataset: the dataset to be transformed</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">lst_col</span> <span class="o">=</span> <span class="s1">&#39;sequence&#39;</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="n">unstacked</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
        <span class="n">col</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">df</span><span class="p">[</span><span class="n">lst_col</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">len</span><span class="p">())</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">lst_col</span><span class="p">)}</span>
    <span class="p">)</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="n">lst_col</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">lst_col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)})[</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
    <span class="c1"># ensure that events in the session have increasing timestamps</span>
    <span class="n">unstacked</span><span class="p">[</span><span class="s1">&#39;ts&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">unstacked</span><span class="p">[</span><span class="s1">&#39;ts&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">unstacked</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;user_id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">cumcount</span><span class="p">()</span>
    <span class="n">unstacked</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;sequence&#39;</span><span class="p">:</span> <span class="s1">&#39;item_id&#39;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">unstacked</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">gpu_diag_wide</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>
    <span class="n">E</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="o">*</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">T</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">X</span><span class="o">*</span><span class="n">E</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">gpu_diag_tall</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>
    <span class="n">E</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="o">*</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">T</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">X</span><span class="o">*</span><span class="n">E</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mrng</span> <span class="o">=</span> <span class="n">MRG_RandomStreams</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">GRU4Rec</span><span class="p">:</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    GRU4Rec(loss=&#39;bpr-max&#39;, final_act=&#39;elu-1&#39;, hidden_act=&#39;tanh&#39;, layers=[100],</span>
<span class="sd">                 n_epochs=10, batch_size=32, dropout_p_hidden=0.0, dropout_p_embed=0.0, learning_rate=0.1, momentum=0.0, lmbd=0.0, embedding=0, n_sample=2048, sample_alpha=0.75, smoothing=0.0, constrained_embedding=False,</span>
<span class="sd">                 adapt=&#39;adagrad&#39;, adapt_params=[], grad_cap=0.0, bpreg=1.0,</span>
<span class="sd">                 sigma=0.0, init_as_normal=False, train_random_order=False, time_sort=True,</span>
<span class="sd">                 session_key=&#39;SessionId&#39;, item_key=&#39;ItemId&#39;, time_key=&#39;Time&#39;)</span>
<span class="sd">    Initializes the network.</span>

<span class="sd">    Parameters</span>
<span class="sd">    -----------</span>
<span class="sd">    loss : &#39;top1&#39;, &#39;bpr&#39;, &#39;cross-entropy&#39;, &#39;xe_logit&#39;, &#39;top1-max&#39;, &#39;bpr-max&#39;</span>
<span class="sd">        selects the loss function (default : &#39;bpr-max&#39;)</span>
<span class="sd">    final_act : &#39;softmax&#39;, &#39;linear&#39;, &#39;relu&#39;, &#39;tanh&#39;, &#39;softmax_logit&#39;, &#39;leaky-&lt;X&gt;&#39;, &#39;elu-&lt;X&gt;&#39;, &#39;selu-&lt;X&gt;-&lt;Y&gt;&#39;</span>
<span class="sd">        selects the activation function of the final layer, &lt;X&gt; and &lt;Y&gt; are the parameters of the activation function (default : &#39;elu-1&#39;)</span>
<span class="sd">    hidden_act : &#39;linear&#39;, &#39;relu&#39;, &#39;tanh&#39;, &#39;leaky-&lt;X&gt;&#39;, &#39;elu-&lt;X&gt;&#39;, &#39;selu-&lt;X&gt;-&lt;Y&gt;&#39;</span>
<span class="sd">        selects the activation function on the hidden states, &lt;X&gt; and &lt;Y&gt; are the parameters of the activation function (default : &#39;tanh&#39;)</span>
<span class="sd">    layers : list of int values</span>
<span class="sd">        list of the number of GRU units in the layers (default : [100])</span>
<span class="sd">    n_epochs : int</span>
<span class="sd">        number of training epochs (default: 10)</span>
<span class="sd">    batch_size : int</span>
<span class="sd">        size of the minibacth, also effect the number of negative samples through minibatch based sampling (default: 32)</span>
<span class="sd">    dropout_p_hidden : float</span>
<span class="sd">        probability of dropout of hidden units (default: 0.0)</span>
<span class="sd">    dropout_p_embed : float</span>
<span class="sd">        probability of dropout of the input units, applicable only if embeddings are used (default: 0.0)</span>
<span class="sd">    learning_rate : float</span>
<span class="sd">        learning rate (default: 0.05)</span>
<span class="sd">    momentum : float</span>
<span class="sd">        if not zero, Nesterov momentum will be applied during training with the given strength (default: 0.0)</span>
<span class="sd">    lmbd : float</span>
<span class="sd">        coefficient of the L2 regularization (default: 0.0)</span>
<span class="sd">    embedding : int</span>
<span class="sd">        size of the embedding used, 0 means not to use embedding (default: 0)</span>
<span class="sd">    n_sample : int</span>
<span class="sd">        number of additional negative samples to be used (besides the other examples of the minibatch) (default: 2048)</span>
<span class="sd">    sample_alpha : float</span>
<span class="sd">        the probability of an item used as an additional negative sample is supp^sample_alpha (default: 0.75)</span>
<span class="sd">        (e.g.: sample_alpha=1 --&gt; popularity based sampling; sample_alpha=0 --&gt; uniform sampling)</span>
<span class="sd">    smoothing : float</span>
<span class="sd">        (only works with cross-entropy and xe_logit losses) if set to non-zero class labels are smoothed with this value, i.e. the expected utput is (e/N, ..., e/N, 1-e+e/N, e/N, ..., e/N) instead of (0, ..., 0, 1, 0, ..., 0), where N is the number of outputs and e is the smoothing value (default: 0.0)</span>
<span class="sd">    constrained_embedding : bool</span>
<span class="sd">        if True, the output weight matrix is also used as input embedding (default: False)</span>
<span class="sd">    adapt : None, &#39;adagrad&#39;, &#39;rmsprop&#39;, &#39;adam&#39;, &#39;adadelta&#39;</span>
<span class="sd">        sets the appropriate learning rate adaptation strategy, use None for standard SGD (default: &#39;adagrad&#39;)</span>
<span class="sd">    adapt_params : list</span>
<span class="sd">        parameters for the adaptive learning methods (default: [])</span>
<span class="sd">    grad_cap : float</span>
<span class="sd">        clip gradients that exceede this value to this value, 0 means no clipping (default: 0.0)</span>
<span class="sd">    bpreg : float</span>
<span class="sd">        score regularization coefficient for the BPR-max loss function (default: 1.0)</span>
<span class="sd">    sigma : float</span>
<span class="sd">        &quot;width&quot; of initialization; either the standard deviation or the min/max of the init interval (with normal and uniform initializations respectively); 0 means adaptive normalization (sigma depends on the size of the weight matrix); (default: 0.0)</span>
<span class="sd">    init_as_normal : boolean</span>
<span class="sd">        False: init from uniform distribution on [-sigma,sigma]; True: init from normal distribution N(0,sigma); (default: False)</span>
<span class="sd">    train_random_order : boolean</span>
<span class="sd">        whether to randomize the order of sessions in each epoch (default: False)</span>
<span class="sd">    time_sort : boolean</span>
<span class="sd">        whether to ensure the the order of sessions is chronological (default: True)</span>
<span class="sd">    session_key : string</span>
<span class="sd">        header of the session ID column in the input file (default: &#39;SessionId&#39;)</span>
<span class="sd">    item_key : string</span>
<span class="sd">        header of the item ID column in the input file (default: &#39;ItemId&#39;)</span>
<span class="sd">    time_key : string</span>
<span class="sd">        header of the timestamp column in the input file (default: &#39;Time&#39;)</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">loss</span><span class="o">=</span><span class="s1">&#39;bpr-max&#39;</span><span class="p">,</span> <span class="n">final_act</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="n">hidden_act</span><span class="o">=</span><span class="s1">&#39;tanh&#39;</span><span class="p">,</span> <span class="n">layers</span><span class="o">=</span><span class="p">[</span><span class="mi">100</span><span class="p">],</span>
                 <span class="n">n_epochs</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">dropout_p_hidden</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">dropout_p_embed</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">momentum</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
                 <span class="n">lmbd</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">embedding</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_sample</span><span class="o">=</span><span class="mi">2048</span><span class="p">,</span> <span class="n">sample_alpha</span><span class="o">=</span><span class="mf">0.75</span><span class="p">,</span> <span class="n">smoothing</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">constrained_embedding</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">adapt</span><span class="o">=</span><span class="s1">&#39;adagrad&#39;</span><span class="p">,</span> <span class="n">adapt_params</span><span class="o">=</span><span class="p">[],</span> <span class="n">grad_cap</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">bpreg</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                 <span class="n">sigma</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">init_as_normal</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">train_random_order</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">time_sort</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="n">session_key</span><span class="o">=</span><span class="s1">&#39;SessionId&#39;</span><span class="p">,</span> <span class="n">item_key</span><span class="o">=</span><span class="s1">&#39;ItemId&#39;</span><span class="p">,</span> <span class="n">time_key</span><span class="o">=</span><span class="s1">&#39;Time&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layers</span> <span class="o">=</span> <span class="n">layers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_epochs</span> <span class="o">=</span> <span class="n">n_epochs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="n">batch_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dropout_p_hidden</span> <span class="o">=</span> <span class="n">dropout_p_hidden</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dropout_p_embed</span> <span class="o">=</span> <span class="n">dropout_p_embed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">learning_rate</span> <span class="o">=</span> <span class="n">learning_rate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">adapt_params</span> <span class="o">=</span> <span class="n">adapt_params</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">momentum</span> <span class="o">=</span> <span class="n">momentum</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sigma</span> <span class="o">=</span> <span class="n">sigma</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_as_normal</span> <span class="o">=</span> <span class="n">init_as_normal</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session_key</span> <span class="o">=</span> <span class="n">session_key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">item_key</span> <span class="o">=</span> <span class="n">item_key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time_key</span> <span class="o">=</span> <span class="n">time_key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grad_cap</span> <span class="o">=</span> <span class="n">grad_cap</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bpreg</span> <span class="o">=</span> <span class="n">bpreg</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_random_order</span> <span class="o">=</span> <span class="n">train_random_order</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lmbd</span> <span class="o">=</span> <span class="n">lmbd</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">embedding</span> <span class="o">=</span> <span class="n">embedding</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">constrained_embedding</span> <span class="o">=</span> <span class="n">constrained_embedding</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time_sort</span> <span class="o">=</span> <span class="n">time_sort</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">adapt</span> <span class="o">=</span> <span class="n">adapt</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loss</span> <span class="o">=</span> <span class="n">loss</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_loss_function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loss</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">final_act</span> <span class="o">=</span> <span class="n">final_act</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_final_activation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">final_act</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hidden_act</span> <span class="o">=</span> <span class="n">hidden_act</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_hidden_activation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hidden_act</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_sample</span> <span class="o">=</span> <span class="n">n_sample</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sample_alpha</span> <span class="o">=</span> <span class="n">sample_alpha</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">smoothing</span> <span class="o">=</span> <span class="n">smoothing</span>

    <span class="k">def</span> <span class="nf">set_loss_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">loss</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">loss</span> <span class="o">==</span> <span class="s1">&#39;cross-entropy&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">loss_function</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cross_entropy</span>
        <span class="k">elif</span> <span class="n">loss</span> <span class="o">==</span> <span class="s1">&#39;bpr&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">loss_function</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bpr</span>
        <span class="k">elif</span> <span class="n">loss</span> <span class="o">==</span> <span class="s1">&#39;bpr-max&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">loss_function</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bpr_max</span>
        <span class="k">elif</span> <span class="n">loss</span> <span class="o">==</span> <span class="s1">&#39;top1&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">loss_function</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">top1</span>
        <span class="k">elif</span> <span class="n">loss</span> <span class="o">==</span> <span class="s1">&#39;top1-max&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">loss_function</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">top1_max</span>
        <span class="k">elif</span> <span class="n">loss</span> <span class="o">==</span> <span class="s1">&#39;xe_logit&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">loss_function</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cross_entropy_logits</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">def</span> <span class="nf">set_final_activation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">final_act</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">final_act</span> <span class="o">==</span> <span class="s1">&#39;linear&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">final_activation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">linear</span>
        <span class="k">elif</span> <span class="n">final_act</span> <span class="o">==</span> <span class="s1">&#39;relu&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">final_activation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relu</span>
        <span class="k">elif</span> <span class="n">final_act</span> <span class="o">==</span> <span class="s1">&#39;softmax&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">final_activation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">softmax</span>
        <span class="k">elif</span> <span class="n">final_act</span> <span class="o">==</span> <span class="s1">&#39;tanh&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">final_activation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tanh</span>
        <span class="k">elif</span> <span class="n">final_act</span> <span class="o">==</span> <span class="s1">&#39;softmax_logit&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">final_activation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">softmax_logit</span>
        <span class="k">elif</span> <span class="n">final_act</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;leaky-&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">final_activation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">LeakyReLU</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">final_act</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]))</span><span class="o">.</span><span class="n">execute</span>
        <span class="k">elif</span> <span class="n">final_act</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;elu-&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">final_activation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Elu</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">final_act</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]))</span><span class="o">.</span><span class="n">execute</span>
        <span class="k">elif</span> <span class="n">final_act</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;selu-&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">final_activation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Selu</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">final_act</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]])</span><span class="o">.</span><span class="n">execute</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">def</span> <span class="nf">set_hidden_activation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hidden_act</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">hidden_act</span> <span class="o">==</span> <span class="s1">&#39;relu&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hidden_activation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relu</span>
        <span class="k">elif</span> <span class="n">hidden_act</span> <span class="o">==</span> <span class="s1">&#39;tanh&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hidden_activation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tanh</span>
        <span class="k">elif</span> <span class="n">hidden_act</span> <span class="o">==</span> <span class="s1">&#39;linear&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hidden_activation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">linear</span>
        <span class="k">elif</span> <span class="n">hidden_act</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;leaky-&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hidden_activation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">LeakyReLU</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">hidden_act</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]))</span><span class="o">.</span><span class="n">execute</span>
        <span class="k">elif</span> <span class="n">hidden_act</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;elu-&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hidden_activation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Elu</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">hidden_act</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]))</span><span class="o">.</span><span class="n">execute</span>
        <span class="k">elif</span> <span class="n">hidden_act</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;selu-&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hidden_activation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Selu</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">hidden_act</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]])</span><span class="o">.</span><span class="n">execute</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">def</span> <span class="nf">set_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kvargs</span><span class="p">):</span>
        <span class="n">maxk_len</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">kvargs</span><span class="o">.</span><span class="n">keys</span><span class="p">()])</span>
        <span class="n">maxv_len</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">kvargs</span><span class="o">.</span><span class="n">values</span><span class="p">()])</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kvargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Unkown attribute: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="s1">&#39;adapt_params&#39;</span><span class="p">:</span>
                    <span class="n">v</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)]</span>
                <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">))</span> <span class="o">==</span> <span class="nb">list</span><span class="p">:</span>
                    <span class="n">v</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)]</span>
                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">))</span> <span class="o">==</span> <span class="nb">bool</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">v</span> <span class="o">==</span> <span class="s1">&#39;True&#39;</span> <span class="ow">or</span> <span class="n">v</span> <span class="o">==</span> <span class="s1">&#39;1&#39;</span><span class="p">:</span>
                        <span class="n">v</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">elif</span> <span class="n">v</span> <span class="o">==</span> <span class="s1">&#39;False&#39;</span> <span class="ow">or</span> <span class="n">v</span> <span class="o">==</span> <span class="s1">&#39;0&#39;</span><span class="p">:</span>
                        <span class="n">v</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Invalid value for boolean parameter: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
                        <span class="k">raise</span> <span class="ne">NotImplementedError</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">))(</span><span class="n">v</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="s1">&#39;loss&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_loss_function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loss</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="s1">&#39;final_act&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_final_activation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">final_act</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="s1">&#39;hidden_act&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_hidden_activation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hidden_act</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;SET   </span><span class="si">{}{}</span><span class="s1">TO   </span><span class="si">{}{}</span><span class="s1">(type: </span><span class="si">{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="s1">&#39; &#39;</span> <span class="o">*</span> <span class="p">(</span><span class="n">maxk_len</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="mi">3</span><span class="p">),</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">),</span>
                                                             <span class="s1">&#39; &#39;</span> <span class="o">*</span> <span class="p">(</span><span class="n">maxv_len</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">)))</span> <span class="o">+</span> <span class="mi">3</span><span class="p">),</span>
                                                             <span class="nb">type</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">))))</span>

    <span class="c1">######################ACTIVATION FUNCTIONS#####################</span>
    <span class="k">def</span> <span class="nf">linear</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">X</span>

    <span class="k">def</span> <span class="nf">tanh</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">T</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">softmax</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="n">e_x</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">X</span> <span class="o">-</span> <span class="n">X</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">dimshuffle</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">e_x</span> <span class="o">/</span> <span class="n">e_x</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">dimshuffle</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">softmax_logit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">X</span> <span class="o">-</span> <span class="n">X</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">dimshuffle</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">T</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">T</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">dimshuffle</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">))</span> <span class="o">-</span> <span class="n">X</span>

    <span class="k">def</span> <span class="nf">softmax_neg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="n">hm</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">T</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="o">*</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">X</span> <span class="o">*</span> <span class="n">hm</span>
        <span class="n">e_x</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">X</span> <span class="o">-</span> <span class="n">X</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">dimshuffle</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">))</span> <span class="o">*</span> <span class="n">hm</span>
        <span class="k">return</span> <span class="n">e_x</span> <span class="o">/</span> <span class="n">e_x</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">dimshuffle</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">relu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">T</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">sigmoid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">T</span><span class="o">.</span><span class="n">nnet</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Selu</span><span class="p">:</span>
        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lmbd</span><span class="p">,</span> <span class="n">alpha</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lmbd</span> <span class="o">=</span> <span class="n">lmbd</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="n">alpha</span>

        <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">lmbd</span> <span class="o">*</span> <span class="n">T</span><span class="o">.</span><span class="n">switch</span><span class="p">(</span><span class="n">T</span><span class="o">.</span><span class="n">ge</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">X</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">*</span> <span class="p">(</span><span class="n">T</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">X</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>

    <span class="k">class</span> <span class="nc">Elu</span><span class="p">:</span>
        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alpha</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="n">alpha</span>

        <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">T</span><span class="o">.</span><span class="n">switch</span><span class="p">(</span><span class="n">T</span><span class="o">.</span><span class="n">ge</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">X</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">*</span> <span class="p">(</span><span class="n">T</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">X</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>

    <span class="k">class</span> <span class="nc">LeakyReLU</span><span class="p">:</span>
        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">leak</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">leak</span> <span class="o">=</span> <span class="n">leak</span>

        <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">T</span><span class="o">.</span><span class="n">switch</span><span class="p">(</span><span class="n">T</span><span class="o">.</span><span class="n">ge</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">X</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">leak</span> <span class="o">*</span> <span class="n">X</span><span class="p">)</span>

    <span class="c1">#################################LOSS FUNCTIONS################################</span>
    <span class="k">def</span> <span class="nf">cross_entropy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">yhat</span><span class="p">,</span> <span class="n">M</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">smoothing</span><span class="p">:</span>
            <span class="n">n_out</span> <span class="o">=</span> <span class="n">M</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_sample</span>
            <span class="k">return</span> <span class="n">T</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">T</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span>
                <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="p">(</span><span class="n">n_out</span> <span class="o">/</span> <span class="p">(</span><span class="n">n_out</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">smoothing</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="n">T</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">gpu_diag_wide</span><span class="p">(</span><span class="n">yhat</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1e-24</span><span class="p">))</span> <span class="o">+</span> <span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">smoothing</span> <span class="o">/</span> <span class="p">(</span><span class="n">n_out</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">*</span> <span class="n">T</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">-</span><span class="n">T</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">yhat</span> <span class="o">+</span> <span class="mf">1e-24</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)),</span> <span class="n">theano</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">floatX</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">T</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">T</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="o">-</span><span class="n">T</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">gpu_diag_wide</span><span class="p">(</span><span class="n">yhat</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1e-24</span><span class="p">)),</span> <span class="n">theano</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">floatX</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">cross_entropy_logits</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">yhat</span><span class="p">,</span> <span class="n">M</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">smoothing</span><span class="p">:</span>
            <span class="n">n_out</span> <span class="o">=</span> <span class="n">M</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_sample</span>
            <span class="k">return</span> <span class="n">T</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">T</span><span class="o">.</span><span class="n">mean</span><span class="p">((</span><span class="mf">1.0</span> <span class="o">-</span> <span class="p">(</span><span class="n">n_out</span> <span class="o">/</span> <span class="p">(</span><span class="n">n_out</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">smoothing</span><span class="p">)</span> <span class="o">*</span> <span class="n">gpu_diag_wide</span><span class="p">(</span><span class="n">yhat</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">smoothing</span> <span class="o">/</span> <span class="p">(</span><span class="n">n_out</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">*</span> <span class="n">T</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">yhat</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)),</span> <span class="n">theano</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">floatX</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">T</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">T</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">gpu_diag_wide</span><span class="p">(</span><span class="n">yhat</span><span class="p">)),</span> <span class="n">theano</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">floatX</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">bpr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">yhat</span><span class="p">,</span> <span class="n">M</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">T</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">T</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="o">-</span><span class="n">T</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">T</span><span class="o">.</span><span class="n">nnet</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">gpu_diag_wide</span><span class="p">(</span><span class="n">yhat</span><span class="p">)</span><span class="o">.</span><span class="n">dimshuffle</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">))</span> <span class="o">-</span> <span class="n">yhat</span><span class="p">))),</span>
                      <span class="n">theano</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">floatX</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">bpr_max</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">yhat</span><span class="p">,</span> <span class="n">M</span><span class="p">):</span>
        <span class="n">softmax_scores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">softmax_neg</span><span class="p">(</span><span class="n">yhat</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">T</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">T</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="o">-</span><span class="n">T</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
            <span class="n">T</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">T</span><span class="o">.</span><span class="n">nnet</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">gpu_diag_wide</span><span class="p">(</span><span class="n">yhat</span><span class="p">)</span><span class="o">.</span><span class="n">dimshuffle</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">))</span> <span class="o">-</span> <span class="n">yhat</span><span class="p">)</span> <span class="o">*</span> <span class="n">softmax_scores</span><span class="p">,</span>
                  <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1e-24</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">bpreg</span> <span class="o">*</span> <span class="n">T</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">yhat</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">softmax_scores</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)),</span> <span class="n">theano</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">floatX</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">top1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">yhat</span><span class="p">,</span> <span class="n">M</span><span class="p">):</span>
        <span class="n">ydiag</span> <span class="o">=</span> <span class="n">gpu_diag_wide</span><span class="p">(</span><span class="n">yhat</span><span class="p">)</span><span class="o">.</span><span class="n">dimshuffle</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">T</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">T</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span>
            <span class="n">T</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">T</span><span class="o">.</span><span class="n">nnet</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="o">-</span><span class="n">ydiag</span> <span class="o">+</span> <span class="n">yhat</span><span class="p">)</span> <span class="o">+</span> <span class="n">T</span><span class="o">.</span><span class="n">nnet</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">yhat</span> <span class="o">**</span> <span class="mi">2</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">T</span><span class="o">.</span><span class="n">nnet</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">ydiag</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span>
                        <span class="n">M</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_sample</span><span class="p">)),</span> <span class="n">theano</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">floatX</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">top1_max</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">yhat</span><span class="p">,</span> <span class="n">M</span><span class="p">):</span>
        <span class="n">softmax_scores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">softmax_neg</span><span class="p">(</span><span class="n">yhat</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">softmax_scores</span> <span class="o">*</span> <span class="p">(</span>
                    <span class="n">T</span><span class="o">.</span><span class="n">nnet</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="o">-</span><span class="n">gpu_diag_wide</span><span class="p">(</span><span class="n">yhat</span><span class="p">)</span><span class="o">.</span><span class="n">dimshuffle</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">))</span> <span class="o">+</span> <span class="n">yhat</span><span class="p">)</span> <span class="o">+</span> <span class="n">T</span><span class="o">.</span><span class="n">nnet</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">yhat</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">T</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">T</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">T</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)),</span> <span class="n">theano</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">floatX</span><span class="p">)</span>

    <span class="c1">###############################################################################</span>
    <span class="k">def</span> <span class="nf">floatX</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">theano</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">floatX</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">init_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">theano</span><span class="o">.</span><span class="n">shared</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">init_matrix</span><span class="p">(</span><span class="n">shape</span><span class="p">),</span> <span class="n">borrow</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">init_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shape</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigma</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">sigma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigma</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">6.0</span> <span class="o">/</span> <span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_as_normal</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">floatX</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="o">*</span><span class="n">shape</span><span class="p">)</span> <span class="o">*</span> <span class="n">sigma</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">floatX</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="o">*</span><span class="n">shape</span><span class="p">)</span> <span class="o">*</span> <span class="n">sigma</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">sigma</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">extend_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">W</span><span class="p">,</span> <span class="n">n_new</span><span class="p">):</span>
        <span class="n">matrix</span> <span class="o">=</span> <span class="n">W</span><span class="o">.</span><span class="n">get_value</span><span class="p">()</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigma</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigma</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">6.0</span> <span class="o">/</span> <span class="p">(</span><span class="n">matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">n_new</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_as_normal</span><span class="p">:</span>
            <span class="n">new_rows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">floatX</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">n_new</span><span class="p">,</span> <span class="n">matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="n">sigma</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">new_rows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">floatX</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">n_new</span><span class="p">,</span> <span class="n">matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="n">sigma</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">sigma</span><span class="p">)</span>
        <span class="n">W</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">matrix</span><span class="p">,</span> <span class="n">new_rows</span><span class="p">]))</span>

    <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="n">data</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">session_key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_key</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">offset_sessions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">session_key</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
        <span class="n">offset_sessions</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session_key</span><span class="p">)</span><span class="o">.</span><span class="n">size</span><span class="p">()</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>
        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Wx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Wh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Wrz</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Bh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">H</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">constrained_embedding</span><span class="p">:</span>
            <span class="n">n_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">E</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_weights</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">n_items</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;E&#39;</span><span class="p">)</span>
            <span class="n">n_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">n_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_items</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">)):</span>
            <span class="n">m</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">m</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">init_matrix</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">n_features</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">i</span><span class="p">])))</span>
            <span class="n">m</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">init_matrix</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">n_features</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">i</span><span class="p">])))</span>
            <span class="n">m</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">init_matrix</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">n_features</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">i</span><span class="p">])))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Wx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">theano</span><span class="o">.</span><span class="n">shared</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span><span class="n">m</span><span class="p">),</span> <span class="n">borrow</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Wx</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)))</span>  <span class="c1"># For compatibility&#39;s sake</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Wh</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">init_weights</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Wh</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)))</span>
            <span class="n">m2</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">m2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">init_matrix</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">i</span><span class="p">])))</span>
            <span class="n">m2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">init_matrix</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">i</span><span class="p">])))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Wrz</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">theano</span><span class="o">.</span><span class="n">shared</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span><span class="n">m2</span><span class="p">),</span> <span class="n">borrow</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Wrz</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)))</span>  <span class="c1"># For compatibility&#39;s sake</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Bh</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">theano</span><span class="o">.</span><span class="n">shared</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">theano</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">floatX</span><span class="p">),</span> <span class="n">borrow</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                         <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Bh</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">theano</span><span class="o">.</span><span class="n">shared</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">theano</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">floatX</span><span class="p">),</span>
                                        <span class="n">borrow</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;H</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Wy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_weights</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">n_items</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Wy&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">By</span> <span class="o">=</span> <span class="n">theano</span><span class="o">.</span><span class="n">shared</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">n_items</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">theano</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">floatX</span><span class="p">),</span> <span class="n">borrow</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;By&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">offset_sessions</span>

    <span class="k">def</span> <span class="nf">dropout</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">drop_p</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">drop_p</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">retain_prob</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">drop_p</span>
            <span class="n">X</span> <span class="o">*=</span> <span class="n">mrng</span><span class="o">.</span><span class="n">binomial</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">retain_prob</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">theano</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">floatX</span><span class="p">)</span> <span class="o">/</span> <span class="n">retain_prob</span>
        <span class="k">return</span> <span class="n">X</span>

    <span class="k">def</span> <span class="nf">adam</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">grad</span><span class="p">,</span> <span class="n">updates</span><span class="p">,</span> <span class="n">sample_idx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">):</span>
        <span class="n">v1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">adapt_params</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">v2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">adapt_params</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">v3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">adapt_params</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">v4</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">adapt_params</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">acc</span> <span class="o">=</span> <span class="n">theano</span><span class="o">.</span><span class="n">shared</span><span class="p">(</span><span class="n">param</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="n">borrow</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">borrow</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">meang</span> <span class="o">=</span> <span class="n">theano</span><span class="o">.</span><span class="n">shared</span><span class="p">(</span><span class="n">param</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="n">borrow</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">borrow</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">countt</span> <span class="o">=</span> <span class="n">theano</span><span class="o">.</span><span class="n">shared</span><span class="p">(</span><span class="n">param</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="n">borrow</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">borrow</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sample_idx</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">acc_new</span> <span class="o">=</span> <span class="n">v3</span> <span class="o">*</span> <span class="n">acc</span> <span class="o">+</span> <span class="n">v4</span> <span class="o">*</span> <span class="p">(</span><span class="n">grad</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">meang_new</span> <span class="o">=</span> <span class="n">v1</span> <span class="o">*</span> <span class="n">meang</span> <span class="o">+</span> <span class="n">v2</span> <span class="o">*</span> <span class="n">grad</span>
            <span class="n">countt_new</span> <span class="o">=</span> <span class="n">countt</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">updates</span><span class="p">[</span><span class="n">acc</span><span class="p">]</span> <span class="o">=</span> <span class="n">acc_new</span>
            <span class="n">updates</span><span class="p">[</span><span class="n">meang</span><span class="p">]</span> <span class="o">=</span> <span class="n">meang_new</span>
            <span class="n">updates</span><span class="p">[</span><span class="n">countt</span><span class="p">]</span> <span class="o">=</span> <span class="n">countt_new</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">acc_s</span> <span class="o">=</span> <span class="n">acc</span><span class="p">[</span><span class="n">sample_idx</span><span class="p">]</span>
            <span class="n">meang_s</span> <span class="o">=</span> <span class="n">meang</span><span class="p">[</span><span class="n">sample_idx</span><span class="p">]</span>
            <span class="n">countt_s</span> <span class="o">=</span> <span class="n">countt</span><span class="p">[</span><span class="n">sample_idx</span><span class="p">]</span>
            <span class="c1">#            acc_new = v3 * acc_s + v4 * (grad**2) #Faster, but inaccurate when an index occurs multiple times</span>
            <span class="c1">#            updates[acc] = T.set_subtensor(acc_s, acc_new) #Faster, but inaccurate when an index occurs multiple times</span>
            <span class="n">updates</span><span class="p">[</span><span class="n">acc</span><span class="p">]</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">inc_subtensor</span><span class="p">(</span><span class="n">T</span><span class="o">.</span><span class="n">set_subtensor</span><span class="p">(</span><span class="n">acc_s</span><span class="p">,</span> <span class="n">acc_s</span> <span class="o">*</span> <span class="n">v3</span><span class="p">)[</span><span class="n">sample_idx</span><span class="p">],</span>
                                           <span class="n">v4</span> <span class="o">*</span> <span class="p">(</span><span class="n">grad</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>  <span class="c1"># Slower, but accurate when an index occurs multiple times</span>
            <span class="n">acc_new</span> <span class="o">=</span> <span class="n">updates</span><span class="p">[</span><span class="n">acc</span><span class="p">][</span><span class="n">sample_idx</span><span class="p">]</span>  <span class="c1"># Slower, but accurate when an index occurs multiple times</span>
            <span class="c1">#            meang_new = v1 * meang_s + v2 * grad</span>
            <span class="c1">#            updates[meang] = T.set_subtensor(meang_s, meang_new) #Faster, but inaccurate when an index occurs multiple times</span>
            <span class="n">updates</span><span class="p">[</span><span class="n">meang</span><span class="p">]</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">inc_subtensor</span><span class="p">(</span><span class="n">T</span><span class="o">.</span><span class="n">set_subtensor</span><span class="p">(</span><span class="n">meang_s</span><span class="p">,</span> <span class="n">meang_s</span> <span class="o">*</span> <span class="n">v1</span><span class="p">)[</span><span class="n">sample_idx</span><span class="p">],</span> <span class="n">v2</span> <span class="o">*</span> <span class="p">(</span>
                        <span class="n">grad</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>  <span class="c1"># Slower, but accurate when an index occurs multiple times</span>
            <span class="n">meang_new</span> <span class="o">=</span> <span class="n">updates</span><span class="p">[</span><span class="n">meang</span><span class="p">][</span><span class="n">sample_idx</span><span class="p">]</span>  <span class="c1"># Slower, but accurate when an index occurs multiple times</span>
            <span class="n">countt_new</span> <span class="o">=</span> <span class="n">countt_s</span> <span class="o">+</span> <span class="mf">1.0</span>
            <span class="n">updates</span><span class="p">[</span><span class="n">countt</span><span class="p">]</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">set_subtensor</span><span class="p">(</span><span class="n">countt_s</span><span class="p">,</span> <span class="n">countt_new</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">meang_new</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">v1</span> <span class="o">**</span> <span class="n">countt_new</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">T</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">acc_new</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">v1</span> <span class="o">**</span> <span class="n">countt_new</span><span class="p">))</span> <span class="o">+</span> <span class="n">epsilon</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">adagrad</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">grad</span><span class="p">,</span> <span class="n">updates</span><span class="p">,</span> <span class="n">sample_idx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">):</span>
        <span class="n">acc</span> <span class="o">=</span> <span class="n">theano</span><span class="o">.</span><span class="n">shared</span><span class="p">(</span><span class="n">param</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="n">borrow</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">borrow</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sample_idx</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">acc_new</span> <span class="o">=</span> <span class="n">acc</span> <span class="o">+</span> <span class="n">grad</span> <span class="o">**</span> <span class="mi">2</span>
            <span class="n">updates</span><span class="p">[</span><span class="n">acc</span><span class="p">]</span> <span class="o">=</span> <span class="n">acc_new</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">acc_s</span> <span class="o">=</span> <span class="n">acc</span><span class="p">[</span><span class="n">sample_idx</span><span class="p">]</span>
            <span class="n">acc_new</span> <span class="o">=</span> <span class="n">acc_s</span> <span class="o">+</span> <span class="n">grad</span> <span class="o">**</span> <span class="mi">2</span>
            <span class="n">updates</span><span class="p">[</span><span class="n">acc</span><span class="p">]</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">set_subtensor</span><span class="p">(</span><span class="n">acc_s</span><span class="p">,</span> <span class="n">acc_new</span><span class="p">)</span>
        <span class="n">gradient_scaling</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">T</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">acc_new</span> <span class="o">+</span> <span class="n">epsilon</span><span class="p">),</span> <span class="n">theano</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">floatX</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">grad</span> <span class="o">/</span> <span class="n">gradient_scaling</span>

    <span class="k">def</span> <span class="nf">adadelta</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">grad</span><span class="p">,</span> <span class="n">updates</span><span class="p">,</span> <span class="n">sample_idx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">):</span>
        <span class="n">v1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">adapt_params</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">v2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">adapt_params</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">acc</span> <span class="o">=</span> <span class="n">theano</span><span class="o">.</span><span class="n">shared</span><span class="p">(</span><span class="n">param</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="n">borrow</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">borrow</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">upd</span> <span class="o">=</span> <span class="n">theano</span><span class="o">.</span><span class="n">shared</span><span class="p">(</span><span class="n">param</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="n">borrow</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">borrow</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sample_idx</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">acc_new</span> <span class="o">=</span> <span class="n">v1</span> <span class="o">*</span> <span class="n">acc</span> <span class="o">+</span> <span class="n">v2</span> <span class="o">*</span> <span class="p">(</span><span class="n">grad</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">updates</span><span class="p">[</span><span class="n">acc</span><span class="p">]</span> <span class="o">=</span> <span class="n">acc_new</span>
            <span class="n">grad_scaling</span> <span class="o">=</span> <span class="p">(</span><span class="n">upd</span> <span class="o">+</span> <span class="n">epsilon</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">acc_new</span> <span class="o">+</span> <span class="n">epsilon</span><span class="p">)</span>
            <span class="n">upd_new</span> <span class="o">=</span> <span class="n">v1</span> <span class="o">*</span> <span class="n">upd</span> <span class="o">+</span> <span class="n">v2</span> <span class="o">*</span> <span class="n">grad_scaling</span> <span class="o">*</span> <span class="p">(</span><span class="n">grad</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">updates</span><span class="p">[</span><span class="n">upd</span><span class="p">]</span> <span class="o">=</span> <span class="n">upd_new</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">acc_s</span> <span class="o">=</span> <span class="n">acc</span><span class="p">[</span><span class="n">sample_idx</span><span class="p">]</span>
            <span class="c1">#            acc_new = v1 * acc_s + v2 * (grad**2) #Faster, but inaccurate when an index occurs multiple times</span>
            <span class="c1">#            updates[acc] = T.set_subtensor(acc_s, acc_new) #Faster, but inaccurate when an index occurs multiple times</span>
            <span class="n">updates</span><span class="p">[</span><span class="n">acc</span><span class="p">]</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">inc_subtensor</span><span class="p">(</span><span class="n">T</span><span class="o">.</span><span class="n">set_subtensor</span><span class="p">(</span><span class="n">acc_s</span><span class="p">,</span> <span class="n">acc_s</span> <span class="o">*</span> <span class="n">v1</span><span class="p">)[</span><span class="n">sample_idx</span><span class="p">],</span>
                                           <span class="n">v2</span> <span class="o">*</span> <span class="p">(</span><span class="n">grad</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>  <span class="c1"># Slower, but accurate when an index occurs multiple times</span>
            <span class="n">acc_new</span> <span class="o">=</span> <span class="n">updates</span><span class="p">[</span><span class="n">acc</span><span class="p">][</span><span class="n">sample_idx</span><span class="p">]</span>  <span class="c1"># Slower, but accurate when an index occurs multiple times</span>
            <span class="n">upd_s</span> <span class="o">=</span> <span class="n">upd</span><span class="p">[</span><span class="n">sample_idx</span><span class="p">]</span>
            <span class="n">grad_scaling</span> <span class="o">=</span> <span class="p">(</span><span class="n">upd_s</span> <span class="o">+</span> <span class="n">epsilon</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">acc_new</span> <span class="o">+</span> <span class="n">epsilon</span><span class="p">)</span>
            <span class="c1">#            updates[upd] = T.set_subtensor(upd_s, v1 * upd_s + v2 * grad_scaling * (grad**2)) #Faster, but inaccurate when an index occurs multiple times</span>
            <span class="n">updates</span><span class="p">[</span><span class="n">upd</span><span class="p">]</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">inc_subtensor</span><span class="p">(</span><span class="n">T</span><span class="o">.</span><span class="n">set_subtensor</span><span class="p">(</span><span class="n">upd_s</span><span class="p">,</span> <span class="n">upd_s</span> <span class="o">*</span> <span class="n">v1</span><span class="p">)[</span><span class="n">sample_idx</span><span class="p">],</span> <span class="n">v2</span> <span class="o">*</span> <span class="n">grad_scaling</span> <span class="o">*</span> <span class="p">(</span>
                        <span class="n">grad</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>  <span class="c1"># Slower, but accurate when an index occurs multiple times</span>
        <span class="n">gradient_scaling</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">T</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">grad_scaling</span><span class="p">),</span> <span class="n">theano</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">floatX</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">learning_rate</span> <span class="o">!=</span> <span class="mf">1.0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Warn: learning_rate is not 1.0 while using adadelta. Setting learning_rate to 1.0&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">learning_rate</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="k">return</span> <span class="n">grad</span> <span class="o">*</span> <span class="n">gradient_scaling</span>  <span class="c1"># Ok, checked</span>

    <span class="k">def</span> <span class="nf">rmsprop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">grad</span><span class="p">,</span> <span class="n">updates</span><span class="p">,</span> <span class="n">sample_idx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">):</span>
        <span class="n">v1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">adapt_params</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">v2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">adapt_params</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">acc</span> <span class="o">=</span> <span class="n">theano</span><span class="o">.</span><span class="n">shared</span><span class="p">(</span><span class="n">param</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="n">borrow</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">borrow</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sample_idx</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">acc_new</span> <span class="o">=</span> <span class="n">v1</span> <span class="o">*</span> <span class="n">acc</span> <span class="o">+</span> <span class="n">v2</span> <span class="o">*</span> <span class="n">grad</span> <span class="o">**</span> <span class="mi">2</span>
            <span class="n">updates</span><span class="p">[</span><span class="n">acc</span><span class="p">]</span> <span class="o">=</span> <span class="n">acc_new</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">acc_s</span> <span class="o">=</span> <span class="n">acc</span><span class="p">[</span><span class="n">sample_idx</span><span class="p">]</span>
            <span class="c1">#            acc_new = v1 * acc_s + v2 * grad ** 2 #Faster, but inaccurate when an index occurs multiple times</span>
            <span class="c1">#            updates[acc] = T.set_subtensor(acc_s, acc_new) #Faster, but inaccurate when an index occurs multiple times</span>
            <span class="n">updates</span><span class="p">[</span><span class="n">acc</span><span class="p">]</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">inc_subtensor</span><span class="p">(</span><span class="n">T</span><span class="o">.</span><span class="n">set_subtensor</span><span class="p">(</span><span class="n">acc_s</span><span class="p">,</span> <span class="n">acc_s</span> <span class="o">*</span> <span class="n">v1</span><span class="p">)[</span><span class="n">sample_idx</span><span class="p">],</span>
                                           <span class="n">v2</span> <span class="o">*</span> <span class="n">grad</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># Slower, but accurate when an index occurs multiple times</span>
            <span class="n">acc_new</span> <span class="o">=</span> <span class="n">updates</span><span class="p">[</span><span class="n">acc</span><span class="p">][</span><span class="n">sample_idx</span><span class="p">]</span>  <span class="c1"># Slower, but accurate when an index occurs multiple times</span>
        <span class="n">gradient_scaling</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">T</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">acc_new</span> <span class="o">+</span> <span class="n">epsilon</span><span class="p">),</span> <span class="n">theano</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">floatX</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">grad</span> <span class="o">/</span> <span class="n">gradient_scaling</span>

    <span class="k">def</span> <span class="nf">RMSprop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cost</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">full_params</span><span class="p">,</span> <span class="n">sampled_params</span><span class="p">,</span> <span class="n">sidxs</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">):</span>
        <span class="n">grads</span> <span class="o">=</span> <span class="p">[</span><span class="n">T</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="n">cost</span><span class="p">,</span> <span class="n">wrt</span><span class="o">=</span><span class="n">param</span><span class="p">)</span> <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">params</span><span class="p">]</span>
        <span class="n">sgrads</span> <span class="o">=</span> <span class="p">[</span><span class="n">T</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="n">cost</span><span class="p">,</span> <span class="n">wrt</span><span class="o">=</span><span class="n">sparam</span><span class="p">)</span> <span class="k">for</span> <span class="n">sparam</span> <span class="ow">in</span> <span class="n">sampled_params</span><span class="p">]</span>
        <span class="n">updates</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">grad_cap</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">norm</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">T</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">T</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">T</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">T</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">g</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">g_list</span><span class="p">])</span> <span class="k">for</span> <span class="n">g_list</span> <span class="ow">in</span> <span class="n">grads</span><span class="p">])</span> <span class="o">+</span> <span class="n">T</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
                <span class="p">[</span><span class="n">T</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">g</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">sgrads</span><span class="p">])),</span> <span class="n">theano</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">floatX</span><span class="p">)</span>
            <span class="n">grads</span> <span class="o">=</span> <span class="p">[[</span><span class="n">T</span><span class="o">.</span><span class="n">switch</span><span class="p">(</span><span class="n">T</span><span class="o">.</span><span class="n">ge</span><span class="p">(</span><span class="n">norm</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">grad_cap</span><span class="p">),</span> <span class="n">g</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">grad_cap</span> <span class="o">/</span> <span class="n">norm</span><span class="p">,</span> <span class="n">g</span><span class="p">)</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">g_list</span><span class="p">]</span> <span class="k">for</span> <span class="n">g_list</span> <span class="ow">in</span>
                     <span class="n">grads</span><span class="p">]</span>
            <span class="n">sgrads</span> <span class="o">=</span> <span class="p">[</span><span class="n">T</span><span class="o">.</span><span class="n">switch</span><span class="p">(</span><span class="n">T</span><span class="o">.</span><span class="n">ge</span><span class="p">(</span><span class="n">norm</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">grad_cap</span><span class="p">),</span> <span class="n">g</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">grad_cap</span> <span class="o">/</span> <span class="n">norm</span><span class="p">,</span> <span class="n">g</span><span class="p">)</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">sgrads</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">p_list</span><span class="p">,</span> <span class="n">g_list</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">grads</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">p</span><span class="p">,</span> <span class="n">g</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">p_list</span><span class="p">,</span> <span class="n">g_list</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">adapt</span> <span class="o">==</span> <span class="s1">&#39;adagrad&#39;</span><span class="p">:</span>
                    <span class="n">g</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">adagrad</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">updates</span><span class="p">)</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">adapt</span> <span class="o">==</span> <span class="s1">&#39;rmsprop&#39;</span><span class="p">:</span>
                    <span class="n">g</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rmsprop</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">updates</span><span class="p">)</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">adapt</span> <span class="o">==</span> <span class="s1">&#39;adadelta&#39;</span><span class="p">:</span>
                    <span class="n">g</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">adadelta</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">updates</span><span class="p">)</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">adapt</span> <span class="o">==</span> <span class="s1">&#39;adam&#39;</span><span class="p">:</span>
                    <span class="n">g</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">adam</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">updates</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">momentum</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">velocity</span> <span class="o">=</span> <span class="n">theano</span><span class="o">.</span><span class="n">shared</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="n">borrow</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">borrow</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">velocity2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">momentum</span> <span class="o">*</span> <span class="n">velocity</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">learning_rate</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">g</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">lmbd</span> <span class="o">*</span> <span class="n">p</span><span class="p">)</span>
                    <span class="n">updates</span><span class="p">[</span><span class="n">velocity</span><span class="p">]</span> <span class="o">=</span> <span class="n">velocity2</span>
                    <span class="n">updates</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span> <span class="o">+</span> <span class="n">velocity2</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">updates</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">learning_rate</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">lmbd</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">learning_rate</span><span class="p">)</span> <span class="o">*</span> <span class="n">g</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sgrads</span><span class="p">)):</span>
            <span class="n">g</span> <span class="o">=</span> <span class="n">sgrads</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">fullP</span> <span class="o">=</span> <span class="n">full_params</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">sample_idx</span> <span class="o">=</span> <span class="n">sidxs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">sparam</span> <span class="o">=</span> <span class="n">sampled_params</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">adapt</span> <span class="o">==</span> <span class="s1">&#39;adagrad&#39;</span><span class="p">:</span>
                <span class="n">g</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">adagrad</span><span class="p">(</span><span class="n">fullP</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">updates</span><span class="p">,</span> <span class="n">sample_idx</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">adapt</span> <span class="o">==</span> <span class="s1">&#39;rmsprop&#39;</span><span class="p">:</span>
                <span class="n">g</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rmsprop</span><span class="p">(</span><span class="n">fullP</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">updates</span><span class="p">,</span> <span class="n">sample_idx</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">adapt</span> <span class="o">==</span> <span class="s1">&#39;adadelta&#39;</span><span class="p">:</span>
                <span class="n">g</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">adadelta</span><span class="p">(</span><span class="n">fullP</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">updates</span><span class="p">,</span> <span class="n">sample_idx</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">adapt</span> <span class="o">==</span> <span class="s1">&#39;adam&#39;</span><span class="p">:</span>
                <span class="n">g</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">adam</span><span class="p">(</span><span class="n">fullP</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">updates</span><span class="p">,</span> <span class="n">sample_idx</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lmbd</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">delta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">learning_rate</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">g</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">lmbd</span> <span class="o">*</span> <span class="n">sparam</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">delta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">learning_rate</span><span class="p">)</span> <span class="o">*</span> <span class="n">g</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">momentum</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">velocity</span> <span class="o">=</span> <span class="n">theano</span><span class="o">.</span><span class="n">shared</span><span class="p">(</span><span class="n">fullP</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="n">borrow</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">borrow</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">vs</span> <span class="o">=</span> <span class="n">velocity</span><span class="p">[</span><span class="n">sample_idx</span><span class="p">]</span>
                <span class="n">velocity2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">momentum</span> <span class="o">*</span> <span class="n">vs</span> <span class="o">-</span> <span class="n">delta</span>
                <span class="n">updates</span><span class="p">[</span><span class="n">velocity</span><span class="p">]</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">set_subtensor</span><span class="p">(</span><span class="n">vs</span><span class="p">,</span> <span class="n">velocity2</span><span class="p">)</span>
                <span class="n">updates</span><span class="p">[</span><span class="n">fullP</span><span class="p">]</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">inc_subtensor</span><span class="p">(</span><span class="n">sparam</span><span class="p">,</span> <span class="n">velocity2</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">updates</span><span class="p">[</span><span class="n">fullP</span><span class="p">]</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">inc_subtensor</span><span class="p">(</span><span class="n">sparam</span><span class="p">,</span> <span class="o">-</span> <span class="n">delta</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">updates</span>

    <span class="k">def</span> <span class="nf">model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">R</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Y</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">drop_p_hidden</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">drop_p_embed</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">predict</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">sparams</span><span class="p">,</span> <span class="n">full_params</span><span class="p">,</span> <span class="n">sidxs</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">constrained_embedding</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">Y</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">X</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">S</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Wy</span><span class="p">[</span><span class="n">X</span><span class="p">]</span>
            <span class="n">Sx</span> <span class="o">=</span> <span class="n">S</span><span class="p">[:</span><span class="n">M</span><span class="p">]</span>
            <span class="n">Sy</span> <span class="o">=</span> <span class="n">S</span><span class="p">[</span><span class="n">M</span><span class="p">:]</span>
            <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span><span class="p">(</span><span class="n">Sx</span><span class="p">,</span> <span class="n">drop_p_embed</span><span class="p">)</span>
            <span class="n">H_new</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">sparams</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">S</span><span class="p">)</span>
            <span class="n">full_params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Wy</span><span class="p">)</span>
            <span class="n">sidxs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding</span><span class="p">:</span>
            <span class="n">Sx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">E</span><span class="p">[</span><span class="n">X</span><span class="p">]</span>
            <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span><span class="p">(</span><span class="n">Sx</span><span class="p">,</span> <span class="n">drop_p_embed</span><span class="p">)</span>
            <span class="n">H_new</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">sparams</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Sx</span><span class="p">)</span>
            <span class="n">full_params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">E</span><span class="p">)</span>
            <span class="n">sidxs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Sx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Wx</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">X</span><span class="p">]</span>
            <span class="n">vec</span> <span class="o">=</span> <span class="n">Sx</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">Bh</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">rz</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">nnet</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">vec</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">0</span><span class="p">]:]</span> <span class="o">+</span> <span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">H</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">Wrz</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hidden_activation</span><span class="p">(</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">H</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">rz</span><span class="p">[:,</span> <span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="bp">self</span><span class="o">.</span><span class="n">Wh</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="n">vec</span><span class="p">[:,</span> <span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
            <span class="n">z</span> <span class="o">=</span> <span class="n">rz</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">0</span><span class="p">]:]</span>
            <span class="n">h</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">z</span><span class="p">)</span> <span class="o">*</span> <span class="n">H</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">z</span> <span class="o">*</span> <span class="n">h</span>
            <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">drop_p_hidden</span><span class="p">)</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">h</span>
            <span class="n">H_new</span> <span class="o">=</span> <span class="p">[</span><span class="n">T</span><span class="o">.</span><span class="n">switch</span><span class="p">(</span><span class="n">R</span><span class="o">.</span><span class="n">dimshuffle</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">)),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">h</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">predict</span> <span class="k">else</span> <span class="n">h</span><span class="p">]</span>
            <span class="n">start</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">sparams</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Sx</span><span class="p">)</span>
            <span class="n">full_params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Wx</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">sidxs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">)):</span>
            <span class="n">vec</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Wx</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">Bh</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">rz</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">nnet</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">vec</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">i</span><span class="p">]:]</span> <span class="o">+</span> <span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">H</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">Wrz</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
            <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hidden_activation</span><span class="p">(</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">H</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">rz</span><span class="p">[:,</span> <span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span> <span class="bp">self</span><span class="o">.</span><span class="n">Wh</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">+</span> <span class="n">vec</span><span class="p">[:,</span> <span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>
            <span class="n">z</span> <span class="o">=</span> <span class="n">rz</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">i</span><span class="p">]:]</span>
            <span class="n">h</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">z</span><span class="p">)</span> <span class="o">*</span> <span class="n">H</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">z</span> <span class="o">*</span> <span class="n">h</span>
            <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">drop_p_hidden</span><span class="p">)</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">h</span>
            <span class="n">H_new</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">T</span><span class="o">.</span><span class="n">switch</span><span class="p">(</span><span class="n">R</span><span class="o">.</span><span class="n">dimshuffle</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">)),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">h</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">predict</span> <span class="k">else</span> <span class="n">h</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">Y</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">constrained_embedding</span><span class="p">)</span> <span class="ow">or</span> <span class="n">predict</span><span class="p">:</span>
                <span class="n">Sy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Wy</span><span class="p">[</span><span class="n">Y</span><span class="p">]</span>
                <span class="n">sparams</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Sy</span><span class="p">)</span>
                <span class="n">full_params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Wy</span><span class="p">)</span>
                <span class="n">sidxs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span>
            <span class="n">SBy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">By</span><span class="p">[</span><span class="n">Y</span><span class="p">]</span>
            <span class="n">sparams</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">SBy</span><span class="p">)</span>
            <span class="n">full_params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">By</span><span class="p">)</span>
            <span class="n">sidxs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">predict</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">final_act</span> <span class="o">==</span> <span class="s1">&#39;softmax_logit&#39;</span><span class="p">:</span>
                <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">Sy</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="o">+</span> <span class="n">SBy</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">final_activation</span><span class="p">(</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">Sy</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="o">+</span> <span class="n">SBy</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>
            <span class="k">return</span> <span class="n">H_new</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">sparams</span><span class="p">,</span> <span class="n">full_params</span><span class="p">,</span> <span class="n">sidxs</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">predict</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">final_act</span> <span class="o">==</span> <span class="s1">&#39;softmax_logit&#39;</span><span class="p">:</span>
                <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Wy</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">By</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">final_activation</span><span class="p">(</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Wy</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">By</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>
            <span class="k">return</span> <span class="n">H_new</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">sparams</span><span class="p">,</span> <span class="n">full_params</span><span class="p">,</span> <span class="n">sidxs</span>

    <span class="k">def</span> <span class="nf">generate_neg_samples</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pop</span><span class="p">,</span> <span class="n">length</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_alpha</span><span class="p">:</span>
            <span class="n">sample</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">pop</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_sample</span> <span class="o">*</span> <span class="n">length</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sample</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_items</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n_sample</span> <span class="o">*</span> <span class="n">length</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">length</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">sample</span> <span class="o">=</span> <span class="n">sample</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">length</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_sample</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">sample</span>

    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">sample_store</span><span class="o">=</span><span class="mi">10000000</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Trains the network.</span>

<span class="sd">        Parameters</span>
<span class="sd">        --------</span>
<span class="sd">        data : pandas.DataFrame</span>
<span class="sd">            Training data. It contains the transactions of the sessions. It has one column for session IDs, one for item IDs and one for the timestamp of the events (unix timestamps).</span>
<span class="sd">            It must have a header. Column names are arbitrary, but must correspond to the ones you set during the initialization of the network (session_key, item_key, time_key properties).</span>
<span class="sd">        sample_store : int</span>
<span class="sd">            If additional negative samples are used (n_sample &gt; 0), the efficiency of GPU utilization can be sped up, by precomputing a large batch of negative samples (and recomputing when necessary).</span>
<span class="sd">            This parameter regulizes the size of this precomputed ID set. Its value is the maximum number of int values (IDs) to be stored. Precomputed IDs are stored in the RAM.</span>
<span class="sd">            For the most efficient computation, a balance must be found between storing few examples and constantly interrupting GPU computations for a short time vs. computing many examples and interrupting GPU computations for a long time (but rarely).</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">predict</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">error_during_train</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">itemids</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">item_key</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_items</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">itemids</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">itemidmap</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_items</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="n">itemids</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="bp">self</span><span class="o">.</span><span class="n">item_key</span><span class="p">:</span> <span class="n">itemids</span><span class="p">,</span> <span class="s1">&#39;ItemIdx&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">itemidmap</span><span class="p">[</span><span class="n">itemids</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">}),</span>
                        <span class="n">on</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">item_key</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">)</span>
        <span class="n">offset_sessions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_sample</span><span class="p">:</span>
            <span class="n">pop</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">item_key</span><span class="p">)</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>
            <span class="n">pop</span> <span class="o">=</span> <span class="n">pop</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">itemidmap</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">**</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_alpha</span>
            <span class="n">pop</span> <span class="o">=</span> <span class="n">pop</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span> <span class="o">/</span> <span class="n">pop</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="n">pop</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">sample_store</span><span class="p">:</span>
                <span class="n">generate_length</span> <span class="o">=</span> <span class="n">sample_store</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_sample</span>
                <span class="k">if</span> <span class="n">generate_length</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">sample_store</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No example store was used&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">neg_samples</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_neg_samples</span><span class="p">(</span><span class="n">pop</span><span class="p">,</span> <span class="n">generate_length</span><span class="p">)</span>
                    <span class="n">sample_pointer</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No example store was used&#39;</span><span class="p">)</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">ivector</span><span class="p">()</span>
        <span class="n">Y</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">ivector</span><span class="p">()</span>
        <span class="n">M</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">iscalar</span><span class="p">()</span>
        <span class="n">R</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">bvector</span><span class="p">()</span>
        <span class="n">H_new</span><span class="p">,</span> <span class="n">Y_pred</span><span class="p">,</span> <span class="n">sparams</span><span class="p">,</span> <span class="n">full_params</span><span class="p">,</span> <span class="n">sidxs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout_p_hidden</span><span class="p">,</span>
                                                                <span class="bp">self</span><span class="o">.</span><span class="n">dropout_p_embed</span><span class="p">)</span>
        <span class="n">cost</span> <span class="o">=</span> <span class="p">(</span><span class="n">M</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_function</span><span class="p">(</span><span class="n">Y_pred</span><span class="p">,</span> <span class="n">M</span><span class="p">)</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">Wx</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">constrained_embedding</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">Wx</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="bp">self</span><span class="o">.</span><span class="n">Wh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Wrz</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Bh</span><span class="p">]</span>
        <span class="n">updates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">RMSprop</span><span class="p">(</span><span class="n">cost</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">full_params</span><span class="p">,</span> <span class="n">sparams</span><span class="p">,</span> <span class="n">sidxs</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="p">)):</span>
            <span class="n">updates</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">H_new</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">train_function</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="p">[</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">R</span><span class="p">],</span> <span class="n">outputs</span><span class="o">=</span><span class="n">cost</span><span class="p">,</span> <span class="n">updates</span><span class="o">=</span><span class="n">updates</span><span class="p">,</span> <span class="n">allow_input_downcast</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">base_order</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span>
            <span class="n">data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session_key</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_key</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_sort</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">offset_sessions</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">data_items</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">ItemIdx</span><span class="o">.</span><span class="n">values</span>
        <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_epochs</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">)):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">theano</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">floatX</span><span class="p">),</span>
                                    <span class="n">borrow</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">c</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">cc</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">session_idx_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">permutation</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">offset_sessions</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_random_order</span> <span class="k">else</span> <span class="n">base_order</span>
            <span class="n">iters</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">)</span>
            <span class="n">maxiter</span> <span class="o">=</span> <span class="n">iters</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">offset_sessions</span><span class="p">[</span><span class="n">session_idx_arr</span><span class="p">[</span><span class="n">iters</span><span class="p">]]</span>
            <span class="n">end</span> <span class="o">=</span> <span class="n">offset_sessions</span><span class="p">[</span><span class="n">session_idx_arr</span><span class="p">[</span><span class="n">iters</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">finished</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">while</span> <span class="ow">not</span> <span class="n">finished</span><span class="p">:</span>
                <span class="n">minlen</span> <span class="o">=</span> <span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
                <span class="n">out_idx</span> <span class="o">=</span> <span class="n">data_items</span><span class="p">[</span><span class="n">start</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">minlen</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="n">in_idx</span> <span class="o">=</span> <span class="n">out_idx</span>
                    <span class="n">out_idx</span> <span class="o">=</span> <span class="n">data_items</span><span class="p">[</span><span class="n">start</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_sample</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">sample_store</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">sample_pointer</span> <span class="o">==</span> <span class="n">generate_length</span><span class="p">:</span>
                                <span class="n">neg_samples</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_neg_samples</span><span class="p">(</span><span class="n">pop</span><span class="p">,</span> <span class="n">generate_length</span><span class="p">)</span>
                                <span class="n">sample_pointer</span> <span class="o">=</span> <span class="mi">0</span>
                            <span class="n">sample</span> <span class="o">=</span> <span class="n">neg_samples</span><span class="p">[</span><span class="n">sample_pointer</span><span class="p">]</span>
                            <span class="n">sample_pointer</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">sample</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_neg_samples</span><span class="p">(</span><span class="n">pop</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                        <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">out_idx</span><span class="p">,</span> <span class="n">sample</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">y</span> <span class="o">=</span> <span class="n">out_idx</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_sample</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">sample_pointer</span> <span class="o">==</span> <span class="n">generate_length</span><span class="p">:</span>
                                <span class="n">generate_samples</span><span class="p">()</span>
                                <span class="n">sample_pointer</span> <span class="o">=</span> <span class="mi">0</span>
                            <span class="n">sample_pointer</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">reset</span> <span class="o">=</span> <span class="p">(</span><span class="n">start</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">==</span> <span class="n">end</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="n">cost</span> <span class="o">=</span> <span class="n">train_function</span><span class="p">(</span><span class="n">in_idx</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">iters</span><span class="p">),</span> <span class="n">reset</span><span class="p">)</span>
                    <span class="n">c</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cost</span><span class="p">)</span>
                    <span class="n">cc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">iters</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">cost</span><span class="p">):</span>
                        <span class="nb">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">epoch</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;: NaN error!&#39;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">error_during_train</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">return</span>
                <span class="n">start</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">minlen</span> <span class="o">-</span> <span class="mi">1</span>
                <span class="n">finished_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">n_finished</span> <span class="o">=</span> <span class="n">finished_mask</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                <span class="n">iters</span><span class="p">[</span><span class="n">finished_mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">maxiter</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_finished</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">maxiter</span> <span class="o">+=</span> <span class="n">n_finished</span>
                <span class="n">valid_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">iters</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">offset_sessions</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">n_valid</span> <span class="o">=</span> <span class="n">valid_mask</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">n_valid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">n_valid</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_sample</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                    <span class="n">finished</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">break</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="n">finished_mask</span> <span class="o">&amp;</span> <span class="n">valid_mask</span>
                <span class="n">sessions</span> <span class="o">=</span> <span class="n">session_idx_arr</span><span class="p">[</span><span class="n">iters</span><span class="p">[</span><span class="n">mask</span><span class="p">]]</span>
                <span class="n">start</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">offset_sessions</span><span class="p">[</span><span class="n">sessions</span><span class="p">]</span>
                <span class="n">end</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">offset_sessions</span><span class="p">[</span><span class="n">sessions</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
                <span class="n">iters</span> <span class="o">=</span> <span class="n">iters</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">]</span>
                <span class="n">start</span> <span class="o">=</span> <span class="n">start</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">]</span>
                <span class="n">end</span> <span class="o">=</span> <span class="n">end</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">n_valid</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">valid_mask</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="p">)):</span>
                        <span class="n">tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="n">borrow</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="n">tmp</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">]</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">borrow</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
            <span class="n">cc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cc</span><span class="p">)</span>
            <span class="n">avgc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">c</span> <span class="o">*</span> <span class="n">cc</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">cc</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">avgc</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Epoch </span><span class="si">{}</span><span class="s1">: NaN error!&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">epoch</span><span class="p">)))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">error_during_train</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">return</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Epoch</span><span class="si">{}</span><span class="se">\t</span><span class="s1">loss: </span><span class="si">{:.6f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">epoch</span><span class="p">,</span> <span class="n">avgc</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">predict_next_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session_ids</span><span class="p">,</span> <span class="n">input_item_ids</span><span class="p">,</span> <span class="n">predict_for_item_ids</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">batch</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Gives predicton scores for a selected set of items. Can be used in batch mode to predict for multiple independent events (i.e. events of different sessions) at once and thus speed up evaluation.</span>

<span class="sd">        If the session ID at a given coordinate of the session_ids parameter remains the same during subsequent calls of the function, the corresponding hidden state of the network will be kept intact (i.e. that&#39;s how one can predict an item to a session).</span>
<span class="sd">        If it changes, the hidden state of the network is reset to zeros.</span>

<span class="sd">        Parameters</span>
<span class="sd">        --------</span>
<span class="sd">        session_ids : 1D array</span>
<span class="sd">            Contains the session IDs of the events of the batch. Its length must equal to the prediction batch size (batch param).</span>
<span class="sd">        input_item_ids : 1D array</span>
<span class="sd">            Contains the item IDs of the events of the batch. Every item ID must be must be in the training data of the network. Its length must equal to the prediction batch size (batch param).</span>
<span class="sd">        predict_for_item_ids : 1D array (optional)</span>
<span class="sd">            IDs of items for which the network should give prediction scores. Every ID must be in the training set. The default value is None, which means that the network gives prediction on its every output (i.e. for all items in the training set).</span>
<span class="sd">        batch : int</span>
<span class="sd">            Prediction batch size.</span>

<span class="sd">        Returns</span>
<span class="sd">        --------</span>
<span class="sd">        out : pandas.DataFrame</span>
<span class="sd">            Prediction scores for selected items for every event of the batch.</span>
<span class="sd">            Columns: events of the batch; rows: items. Rows are indexed by the item IDs.</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_during_train</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict_batch</span> <span class="o">!=</span> <span class="n">batch</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">predict_batch</span> <span class="o">=</span> <span class="n">batch</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">ivector</span><span class="p">()</span>
            <span class="n">Y</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">ivector</span><span class="p">()</span>
            <span class="n">M</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">iscalar</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">constrained_embedding</span> <span class="ow">or</span> <span class="p">(</span><span class="n">predict_for_item_ids</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">)):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">batch</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">theano</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">floatX</span><span class="p">),</span> <span class="n">borrow</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">predict_for_item_ids</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">H_new</span><span class="p">,</span> <span class="n">yhat</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">Y</span><span class="o">=</span><span class="n">Y</span><span class="p">,</span> <span class="n">predict</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">H_new</span><span class="p">,</span> <span class="n">yhat</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">predict</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">updatesH</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="p">)):</span>
                <span class="n">updatesH</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">H_new</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">predict_for_item_ids</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">constrained_embedding</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">predict</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="p">[</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">M</span><span class="p">],</span> <span class="n">outputs</span><span class="o">=</span><span class="n">yhat</span><span class="p">,</span> <span class="n">updates</span><span class="o">=</span><span class="n">updatesH</span><span class="p">,</span> <span class="n">allow_input_downcast</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">predict</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="p">[</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">],</span> <span class="n">outputs</span><span class="o">=</span><span class="n">yhat</span><span class="p">,</span> <span class="n">updates</span><span class="o">=</span><span class="n">updatesH</span><span class="p">,</span> <span class="n">allow_input_downcast</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">constrained_embedding</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">predict</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="p">[</span><span class="n">X</span><span class="p">,</span> <span class="n">M</span><span class="p">],</span> <span class="n">outputs</span><span class="o">=</span><span class="n">yhat</span><span class="p">,</span> <span class="n">updates</span><span class="o">=</span><span class="n">updatesH</span><span class="p">,</span> <span class="n">allow_input_downcast</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">predict</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="p">[</span><span class="n">X</span><span class="p">],</span> <span class="n">outputs</span><span class="o">=</span><span class="n">yhat</span><span class="p">,</span> <span class="n">updates</span><span class="o">=</span><span class="n">updatesH</span><span class="p">,</span> <span class="n">allow_input_downcast</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_session</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span> <span class="o">*</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">session_change</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">batch</span><span class="p">)[</span><span class="n">session_ids</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_session</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">session_change</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="p">)):</span>
                <span class="n">tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="n">borrow</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">tmp</span><span class="p">[</span><span class="n">session_change</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">borrow</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_session</span> <span class="o">=</span> <span class="n">session_ids</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">in_idxs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">itemidmap</span><span class="p">[</span><span class="n">input_item_ids</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">in_idxs</span><span class="p">)):</span>
            <span class="n">preds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">itemidmap</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">in_idxs</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">preds</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">itemidmap</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">predict_for_item_ids</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">iIdxs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">itemidmap</span><span class="p">[</span><span class="n">predict_for_item_ids</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">constrained_embedding</span><span class="p">:</span>
                <span class="n">preds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">in_idxs</span><span class="p">,</span> <span class="n">iIdxs</span><span class="p">,</span> <span class="n">batch</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">preds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">in_idxs</span><span class="p">,</span> <span class="n">iIdxs</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">preds</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">predict_for_item_ids</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">constrained_embedding</span><span class="p">:</span>
                <span class="n">preds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">in_idxs</span><span class="p">,</span> <span class="n">batch</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">preds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">in_idxs</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">preds</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">itemidmap</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">symbolic_predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">items</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">constrained_embedding</span><span class="p">:</span> <span class="n">M</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">H</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">)):</span>
            <span class="n">H</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">theano</span><span class="o">.</span><span class="n">shared</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">batch_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">theano</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">floatX</span><span class="p">)))</span>
        <span class="k">if</span> <span class="n">items</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">H_new</span><span class="p">,</span> <span class="n">yhat</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">Y</span><span class="o">=</span><span class="n">Y</span><span class="p">,</span> <span class="n">predict</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">H_new</span><span class="p">,</span> <span class="n">yhat</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">predict</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">updatesH</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">H</span><span class="p">)):</span>
            <span class="n">updatesH</span><span class="p">[</span><span class="n">H</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">H_new</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">yhat</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="n">updatesH</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span>
    <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
    <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%(asctime)s</span><span class="s2">: </span><span class="si">%(name)s</span><span class="s2">: </span><span class="si">%(levelname)s</span><span class="s2">: </span><span class="si">%(message)s</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">srng</span> <span class="o">=</span> <span class="n">MRG_RandomStreams</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">inspect</span><span class="p">(</span><span class="n">tvar</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">tvar</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="n">borrow</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">print_norm</span><span class="p">(</span><span class="n">tvar</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;var&#39;</span><span class="p">):</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">: </span><span class="si">{:.4f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">inspect</span><span class="p">(</span><span class="n">tvar</span><span class="p">))))</span>


<span class="k">class</span> <span class="nc">Sampler</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">n_sample</span><span class="p">,</span> <span class="n">rng</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">item_key</span><span class="o">=</span><span class="s1">&#39;item_id&#39;</span><span class="p">,</span> <span class="n">sample_alpha</span><span class="o">=</span><span class="mf">0.75</span><span class="p">,</span> <span class="n">sample_store</span><span class="o">=</span><span class="mi">10000000</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sample_alpha</span> <span class="o">=</span> <span class="n">sample_alpha</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sample_store</span> <span class="o">=</span> <span class="n">sample_store</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_sample</span> <span class="o">=</span> <span class="n">n_sample</span>
        <span class="k">if</span> <span class="n">rng</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">(</span><span class="mi">1234</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rng</span> <span class="o">=</span> <span class="n">rng</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pop</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">item_key</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span> <span class="o">**</span> <span class="n">sample_alpha</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_store</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">generate_length</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_store</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_sample</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_length</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sample_store</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;No example store was used&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">neg_samples</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_neg_samples</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_length</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sample_pointer</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Created sample store with </span><span class="si">{}</span><span class="s1"> batches of samples&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">generate_length</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;No example store was used&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">next_sample</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_store</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_pointer</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_length</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">neg_samples</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_neg_samples</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_length</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sample_pointer</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">sample</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">neg_samples</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_pointer</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sample_pointer</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sample</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_neg_samples</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sample</span>

    <span class="k">def</span> <span class="nf">_generate_neg_samples</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pop</span><span class="p">,</span> <span class="n">length</span><span class="p">):</span>
        <span class="n">n_items</span> <span class="o">=</span> <span class="n">pop</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_alpha</span><span class="p">:</span>
            <span class="n">sample</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">pop</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_sample</span> <span class="o">*</span> <span class="n">length</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sample</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">n_items</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n_sample</span> <span class="o">*</span> <span class="n">length</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">length</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">sample</span> <span class="o">=</span> <span class="n">sample</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">length</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_sample</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">sample</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">HGRU4Rec</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    HGRU4Rec(session_layers, user_layers, n_epochs=10, batch_size=50,</span>
<span class="sd">             learning_rate=0.05, momentum=0.0,</span>
<span class="sd">             adapt=&#39;adagrad&#39;, decay=0.9, grad_cap=0, sigma=0,</span>
<span class="sd">             dropout_p_hidden_usr=0.0,</span>
<span class="sd">             dropout_p_hidden_ses=0.0, dropout_p_init=0.0,</span>
<span class="sd">             init_as_normal=False, reset_after_session=True, loss=&#39;top1&#39;, hidden_act=&#39;tanh&#39;, final_act=None,</span>
<span class="sd">             train_random_order=False, lmbd=0.0,</span>
<span class="sd">             session_key=&#39;SessionId&#39;, item_key=&#39;ItemId&#39;, time_key=&#39;Time&#39;, user_key=&#39;UserId&#39;, n_sample=0,</span>
<span class="sd">             sample_alpha=0.75,</span>
<span class="sd">             item_embedding=None, init_item_embeddings=None,</span>
<span class="sd">             user_hidden_bias_mode=&#39;init&#39;, user_output_bias=False,</span>
<span class="sd">             user_to_session_act=&#39;tanh&#39;, seed=42)</span>
<span class="sd">    Initializes the network.</span>

<span class="sd">    Parameters</span>
<span class="sd">    -----------</span>
<span class="sd">    session_layers : 1D array</span>
<span class="sd">        list of the number of GRU units in the session layers</span>
<span class="sd">    user_layers : 1D array</span>
<span class="sd">        list of the number of GRU units in the user layers</span>
<span class="sd">    n_epochs : int</span>
<span class="sd">        number of training epochs (default: 10)</span>
<span class="sd">    batch_size : int</span>
<span class="sd">        size of the minibatch, also effect the number of negative samples through minibatch based sampling (default: 50)</span>
<span class="sd">    dropout_p_hidden_usr : float</span>
<span class="sd">        probability of dropout of hidden units for the user layers (default: 0.0)</span>
<span class="sd">    dropout_p_hidden_ses : float</span>
<span class="sd">        probability of dropout of hidden units for the session layers (default: 0.0)</span>
<span class="sd">    dropout_p_init : float</span>
<span class="sd">        probability of dropout of the session-level initialization (default: 0.0)</span>
<span class="sd">    learning_rate : float</span>
<span class="sd">        learning rate (default: 0.05)</span>
<span class="sd">    momentum : float</span>
<span class="sd">        if not zero, Nesterov momentum will be applied during training with the given strength (default: 0.0)</span>
<span class="sd">    adapt : None, &#39;adagrad&#39;, &#39;rmsprop&#39;, &#39;adam&#39;, &#39;adadelta&#39;</span>
<span class="sd">        sets the appropriate learning rate adaptation strategy, use None for standard SGD (default: &#39;adagrad&#39;)</span>
<span class="sd">    decay : float</span>
<span class="sd">        decay parameter for RMSProp, has no effect in other modes (default: 0.9)</span>
<span class="sd">    grad_cap : float</span>
<span class="sd">        clip gradients that exceede this value to this value, 0 means no clipping (default: 0.0)</span>
<span class="sd">    sigma : float</span>
<span class="sd">        &quot;width&quot; of initialization; either the standard deviation or the min/max of the init interval (with normal and uniform initializations respectively); 0 means adaptive normalization (sigma depends on the size of the weight matrix); (default: 0)</span>
<span class="sd">    init_as_normal : boolean</span>
<span class="sd">        False: init from uniform distribution on [-sigma,sigma]; True: init from normal distribution N(0,sigma); (default: False)</span>
<span class="sd">    reset_after_session : boolean</span>
<span class="sd">        whether the hidden state is set to zero after a session finished (default: True)</span>
<span class="sd">    loss : &#39;top1&#39;, &#39;bpr&#39; or &#39;cross-entropy&#39;</span>
<span class="sd">        selects the loss function (default: &#39;top1&#39;)</span>
<span class="sd">    hidden_act : &#39;tanh&#39; or &#39;relu&#39;</span>
<span class="sd">        selects the activation function on the hidden states (default: &#39;tanh&#39;)</span>
<span class="sd">    final_act : None, &#39;linear&#39;, &#39;relu&#39; or &#39;tanh&#39;</span>
<span class="sd">        selects the activation function of the final layer where appropriate, None means default (tanh if the loss is brp or top1; softmax for cross-entropy),</span>
<span class="sd">        cross-entropy is only affeted by &#39;tanh&#39; where the softmax layers is preceeded by a tanh nonlinearity (default: None)</span>
<span class="sd">    train_random_order : boolean</span>
<span class="sd">        whether to randomize the order of sessions in each epoch (default: False)</span>
<span class="sd">    lmbd : float</span>
<span class="sd">        coefficient of the L2 regularization (default: 0.0)</span>
<span class="sd">    session_key : string</span>
<span class="sd">        header of the session ID column in the input file (default: &#39;SessionId&#39;)</span>
<span class="sd">    item_key : string</span>
<span class="sd">        header of the item ID column in the input file (default: &#39;ItemId&#39;)</span>
<span class="sd">    time_key : string</span>
<span class="sd">        header of the timestamp column in the input file (default: &#39;Time&#39;)</span>
<span class="sd">    user_key : string</span>
<span class="sd">        header of the user column in the input file (default: &#39;UserId&#39;)</span>
<span class="sd">    n_sample : int</span>
<span class="sd">        number of additional negative samples to be used (besides the other examples of the minibatch) (default: 0)</span>
<span class="sd">    sample_alpha : float</span>
<span class="sd">        the probability of an item used as an additional negative sample is supp^sample_alpha (default: 0.75)</span>
<span class="sd">        (e.g.: sample_alpha=1 --&gt; popularity based sampling; sample_alpha=0 --&gt; uniform sampling)</span>
<span class="sd">    item_embedding: int</span>
<span class="sd">        size of the item embedding vector (default: None)</span>
<span class="sd">    init_item_embeddings: 2D array or dict</span>
<span class="sd">        array with the initial values of the embeddings vector of every item,</span>
<span class="sd">        or dict that maps each item id to its embedding vector (default: None)</span>
<span class="sd">    user_propagation_mode: string</span>
<span class="sd">        &#39;init&#39; to use the (last) user hidden state to initialize the (first) session hidden state;</span>
<span class="sd">        &#39;all&#39; to propagate the user hidden also in input the the (first) session layers. (default: &#39;init&#39;)</span>
<span class="sd">    user_to_output: boolean</span>
<span class="sd">        True to propagate the (last) user hidden state in input to the final output layer, False otherwise (default: False)</span>
<span class="sd">    user_to_session_act: string</span>
<span class="sd">        activation of the user-to-session initialization network (default: &#39;tanh&#39;)</span>
<span class="sd">    seed: int</span>
<span class="sd">        random seed (default: 42)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session_layers</span><span class="p">,</span> <span class="n">user_layers</span><span class="p">,</span> <span class="n">n_epochs</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">momentum</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
                 <span class="n">adapt</span><span class="o">=</span><span class="s1">&#39;adagrad&#39;</span><span class="p">,</span> <span class="n">decay</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">grad_cap</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">dropout_p_hidden_usr</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
                 <span class="n">dropout_p_hidden_ses</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">dropout_p_init</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">init_as_normal</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">reset_after_session</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">loss</span><span class="o">=</span><span class="s1">&#39;top1&#39;</span><span class="p">,</span> <span class="n">hidden_act</span><span class="o">=</span><span class="s1">&#39;tanh&#39;</span><span class="p">,</span> <span class="n">final_act</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">train_random_order</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">lmbd</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">session_key</span><span class="o">=</span><span class="s1">&#39;SessionId&#39;</span><span class="p">,</span> <span class="n">item_key</span><span class="o">=</span><span class="s1">&#39;ItemId&#39;</span><span class="p">,</span> <span class="n">time_key</span><span class="o">=</span><span class="s1">&#39;Time&#39;</span><span class="p">,</span> <span class="n">user_key</span><span class="o">=</span><span class="s1">&#39;UserId&#39;</span><span class="p">,</span> <span class="n">n_sample</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                 <span class="n">sample_alpha</span><span class="o">=</span><span class="mf">0.75</span><span class="p">,</span> <span class="n">item_embedding</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">init_item_embeddings</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">user_propagation_mode</span><span class="o">=</span><span class="s1">&#39;init&#39;</span><span class="p">,</span>
                 <span class="n">user_to_output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">user_to_session_act</span><span class="o">=</span><span class="s1">&#39;tanh&#39;</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">42</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session_layers</span> <span class="o">=</span> <span class="n">session_layers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_layers</span> <span class="o">=</span> <span class="n">user_layers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_epochs</span> <span class="o">=</span> <span class="n">n_epochs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="n">batch_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dropout_p_hidden_usr</span> <span class="o">=</span> <span class="n">dropout_p_hidden_usr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dropout_p_hidden_ses</span> <span class="o">=</span> <span class="n">dropout_p_hidden_ses</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dropout_p_init</span> <span class="o">=</span> <span class="n">dropout_p_init</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">learning_rate</span> <span class="o">=</span> <span class="n">learning_rate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">decay</span> <span class="o">=</span> <span class="n">decay</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">momentum</span> <span class="o">=</span> <span class="n">momentum</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sigma</span> <span class="o">=</span> <span class="n">sigma</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_as_normal</span> <span class="o">=</span> <span class="n">init_as_normal</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_after_session</span> <span class="o">=</span> <span class="n">reset_after_session</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session_key</span> <span class="o">=</span> <span class="n">session_key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">item_key</span> <span class="o">=</span> <span class="n">item_key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time_key</span> <span class="o">=</span> <span class="n">time_key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_key</span> <span class="o">=</span> <span class="n">user_key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grad_cap</span> <span class="o">=</span> <span class="n">grad_cap</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_random_order</span> <span class="o">=</span> <span class="n">train_random_order</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lmbd</span> <span class="o">=</span> <span class="n">lmbd</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">user_propagation_mode</span> <span class="o">=</span> <span class="n">user_propagation_mode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_to_output</span> <span class="o">=</span> <span class="n">user_to_output</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">item_embedding</span> <span class="o">=</span> <span class="n">item_embedding</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_item_embeddings</span> <span class="o">=</span> <span class="n">init_item_embeddings</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">adapt</span> <span class="o">==</span> <span class="s1">&#39;rmsprop&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">adapt</span> <span class="o">=</span> <span class="s1">&#39;rmsprop&#39;</span>
        <span class="k">elif</span> <span class="n">adapt</span> <span class="o">==</span> <span class="s1">&#39;adagrad&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">adapt</span> <span class="o">=</span> <span class="s1">&#39;adagrad&#39;</span>
        <span class="k">elif</span> <span class="n">adapt</span> <span class="o">==</span> <span class="s1">&#39;adadelta&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">adapt</span> <span class="o">=</span> <span class="s1">&#39;adadelta&#39;</span>
        <span class="k">elif</span> <span class="n">adapt</span> <span class="o">==</span> <span class="s1">&#39;adam&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">adapt</span> <span class="o">=</span> <span class="s1">&#39;adam&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">adapt</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">loss</span> <span class="o">==</span> <span class="s1">&#39;cross-entropy&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">final_act</span> <span class="o">==</span> <span class="s1">&#39;tanh&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">final_activation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">softmaxth</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">final_activation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">softmax</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">loss_function</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cross_entropy</span>
        <span class="k">elif</span> <span class="n">loss</span> <span class="o">==</span> <span class="s1">&#39;bpr&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">final_act</span> <span class="o">==</span> <span class="s1">&#39;linear&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">final_activation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">linear</span>
            <span class="k">elif</span> <span class="n">final_act</span> <span class="o">==</span> <span class="s1">&#39;relu&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">final_activation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relu</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">final_activation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tanh</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">loss_function</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bpr</span>
        <span class="k">elif</span> <span class="n">loss</span> <span class="o">==</span> <span class="s1">&#39;top1&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">final_act</span> <span class="o">==</span> <span class="s1">&#39;linear&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">final_activation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">linear</span>
            <span class="k">elif</span> <span class="n">final_act</span> <span class="o">==</span> <span class="s1">&#39;relu&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">final_activation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relu</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">final_activation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tanh</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">loss_function</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">top1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;loss </span><span class="si">{}</span><span class="s1"> not implemented&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">loss</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">hidden_act</span> <span class="o">==</span> <span class="s1">&#39;relu&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hidden_activation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relu</span>
        <span class="k">elif</span> <span class="n">hidden_act</span> <span class="o">==</span> <span class="s1">&#39;tanh&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hidden_activation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tanh</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;hidden activation </span><span class="si">{}</span><span class="s1"> not implemented&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">hidden_act</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">user_to_session_act</span> <span class="o">==</span> <span class="s1">&#39;relu&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">s_init_act</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relu</span>
        <span class="k">elif</span> <span class="n">user_to_session_act</span> <span class="o">==</span> <span class="s1">&#39;tanh&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">s_init_act</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tanh</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;user-to-session activation </span><span class="si">{}</span><span class="s1"> not implemented&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">hidden_act</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">n_sample</span> <span class="o">=</span> <span class="n">n_sample</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sample_alpha</span> <span class="o">=</span> <span class="n">sample_alpha</span>

    <span class="c1">######################ACTIVATION FUNCTIONS#####################</span>
    <span class="k">def</span> <span class="nf">linear</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">X</span>

    <span class="k">def</span> <span class="nf">tanh</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">T</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">softmax</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="n">e_x</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">X</span> <span class="o">-</span> <span class="n">X</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">dimshuffle</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">e_x</span> <span class="o">/</span> <span class="n">e_x</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">dimshuffle</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">softmaxth</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="n">X</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="n">e_x</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">X</span> <span class="o">-</span> <span class="n">X</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">dimshuffle</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">e_x</span> <span class="o">/</span> <span class="n">e_x</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">dimshuffle</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">relu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">T</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">sigmoid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">T</span><span class="o">.</span><span class="n">nnet</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

    <span class="c1">#################################LOSS FUNCTIONS################################</span>
    <span class="k">def</span> <span class="nf">cross_entropy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">yhat</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">T</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">T</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="o">-</span><span class="n">T</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">T</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">yhat</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1e-24</span><span class="p">)),</span> <span class="n">theano</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">floatX</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">bpr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">yhat</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">T</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">T</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="o">-</span><span class="n">T</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">T</span><span class="o">.</span><span class="n">nnet</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">T</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">yhat</span><span class="p">)</span> <span class="o">-</span> <span class="n">yhat</span><span class="o">.</span><span class="n">T</span><span class="p">))),</span> <span class="n">theano</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">floatX</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">top1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">yhat</span><span class="p">):</span>
        <span class="n">yhatT</span> <span class="o">=</span> <span class="n">yhat</span><span class="o">.</span><span class="n">T</span>
        <span class="k">return</span> <span class="n">T</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">T</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span>
            <span class="n">T</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">T</span><span class="o">.</span><span class="n">nnet</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="o">-</span><span class="n">T</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">yhat</span><span class="p">)</span> <span class="o">+</span> <span class="n">yhatT</span><span class="p">)</span> <span class="o">+</span> <span class="n">T</span><span class="o">.</span><span class="n">nnet</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">yhatT</span> <span class="o">**</span> <span class="mi">2</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">T</span><span class="o">.</span><span class="n">nnet</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span>
                <span class="n">T</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">yhat</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">),</span> <span class="n">theano</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">floatX</span><span class="p">)</span>

    <span class="c1">###############################################################################</span>
    <span class="k">def</span> <span class="nf">floatX</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">theano</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">floatX</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">init_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shape</span><span class="p">):</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigma</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigma</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">6.0</span> <span class="o">/</span> <span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_as_normal</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">theano</span><span class="o">.</span><span class="n">shared</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">floatX</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="o">*</span><span class="n">shape</span><span class="p">)</span> <span class="o">*</span> <span class="n">sigma</span><span class="p">),</span> <span class="n">borrow</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">theano</span><span class="o">.</span><span class="n">shared</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">floatX</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="o">*</span><span class="n">shape</span><span class="p">)</span> <span class="o">*</span> <span class="n">sigma</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">sigma</span><span class="p">),</span> <span class="n">borrow</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">init_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shape</span><span class="p">):</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigma</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigma</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">6.0</span> <span class="o">/</span> <span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_as_normal</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">floatX</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="o">*</span><span class="n">shape</span><span class="p">)</span> <span class="o">*</span> <span class="n">sigma</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">floatX</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="o">*</span><span class="n">shape</span><span class="p">)</span> <span class="o">*</span> <span class="n">sigma</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">sigma</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">extend_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">W</span><span class="p">,</span> <span class="n">n_new</span><span class="p">):</span>
        <span class="n">matrix</span> <span class="o">=</span> <span class="n">W</span><span class="o">.</span><span class="n">get_value</span><span class="p">()</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigma</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigma</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">6.0</span> <span class="o">/</span> <span class="p">(</span><span class="n">matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">n_new</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_as_normal</span><span class="p">:</span>
            <span class="n">new_rows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">floatX</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">n_new</span><span class="p">,</span> <span class="n">matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="n">sigma</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">new_rows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">floatX</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">n_new</span><span class="p">,</span> <span class="n">matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="n">sigma</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">sigma</span><span class="p">)</span>
        <span class="n">W</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">matrix</span><span class="p">,</span> <span class="n">new_rows</span><span class="p">]))</span>

    <span class="k">def</span> <span class="nf">set_item_embeddings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">E</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">keys</span><span class="p">,</span> <span class="n">values</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">values</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="c1"># use item ids ranging from 0 to the number of rows in values</span>
            <span class="n">keys</span><span class="p">,</span> <span class="n">values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">values</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">values</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;Unsupported type&#39;</span><span class="p">)</span>
        <span class="c1"># map item ids to the internal indices</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">in1d</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">itemidmap</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">assume_unique</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">itemidmap</span><span class="p">[</span><span class="n">keys</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>
        <span class="n">emb</span> <span class="o">=</span> <span class="n">E</span><span class="o">.</span><span class="n">get_value</span><span class="p">()</span>
        <span class="n">emb</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
        <span class="n">E</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">emb</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">preprocess_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="c1"># sort by user and time key in order</span>
        <span class="n">data</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">user_key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_key</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">data</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">offset_session</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">user_key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_key</span><span class="p">],</span> <span class="n">sort</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">size</span><span class="p">()</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
        <span class="n">user_indptr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_key</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">session_key</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
        <span class="k">return</span> <span class="n">user_indptr</span><span class="p">,</span> <span class="n">offset_session</span>

    <span class="k">def</span> <span class="nf">save_state</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">state</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session_layers</span><span class="p">)):</span>
            <span class="n">state</span><span class="p">[</span><span class="s1">&#39;Ws_in_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ws_in</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">get_value</span><span class="p">()</span>
            <span class="n">state</span><span class="p">[</span><span class="s1">&#39;Ws_hh_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ws_hh</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">get_value</span><span class="p">()</span>
            <span class="n">state</span><span class="p">[</span><span class="s1">&#39;Ws_rz_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ws_rz</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">get_value</span><span class="p">()</span>
            <span class="n">state</span><span class="p">[</span><span class="s1">&#39;Bs_h_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Bs_h</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">get_value</span><span class="p">()</span>
            <span class="n">state</span><span class="p">[</span><span class="s1">&#39;Hs_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Hs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">get_value</span><span class="p">()</span>
        <span class="n">state</span><span class="p">[</span><span class="s1">&#39;Wsy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Wsy</span><span class="o">.</span><span class="n">get_value</span><span class="p">()</span>
        <span class="n">state</span><span class="p">[</span><span class="s1">&#39;By&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">By</span><span class="o">.</span><span class="n">get_value</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_layers</span><span class="p">)):</span>
            <span class="n">state</span><span class="p">[</span><span class="s1">&#39;Wu_in_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Wu_in</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">get_value</span><span class="p">()</span>
            <span class="n">state</span><span class="p">[</span><span class="s1">&#39;Wu_hh_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Wu_hh</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">get_value</span><span class="p">()</span>
            <span class="n">state</span><span class="p">[</span><span class="s1">&#39;Wu_rz_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Wu_rz</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">get_value</span><span class="p">()</span>
            <span class="n">state</span><span class="p">[</span><span class="s1">&#39;Bu_h_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Bu_h</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">get_value</span><span class="p">()</span>
            <span class="n">state</span><span class="p">[</span><span class="s1">&#39;Hu_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Hu</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">get_value</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_to_output</span><span class="p">:</span>
            <span class="n">state</span><span class="p">[</span><span class="s1">&#39;Wuy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Wuy</span><span class="o">.</span><span class="n">get_value</span><span class="p">()</span>
        <span class="n">state</span><span class="p">[</span><span class="s1">&#39;Wu_to_s_init&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ws_init</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_value</span><span class="p">()</span>
        <span class="n">state</span><span class="p">[</span><span class="s1">&#39;Bu_to_s_init&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Bs_init</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_value</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_propagation_mode</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
            <span class="n">state</span><span class="p">[</span><span class="s1">&#39;Wu_to_s&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Wu_to_s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_value</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">state</span>

    <span class="k">def</span> <span class="nf">load_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session_layers</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Ws_in</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;Ws_in_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)],</span> <span class="n">borrow</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Ws_hh</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;Ws_hh_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)],</span> <span class="n">borrow</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Ws_rz</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;Ws_rz_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)],</span> <span class="n">borrow</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Bs_h</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;Bs_h_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)],</span> <span class="n">borrow</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Hs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;Hs_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)],</span> <span class="n">borrow</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Wsy</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;Wsy&#39;</span><span class="p">],</span> <span class="n">borrow</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">By</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;By&#39;</span><span class="p">],</span> <span class="n">borrow</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_layers</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Wu_in</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;Wu_in_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)],</span> <span class="n">borrow</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Wu_hh</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;Wu_hh_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)],</span> <span class="n">borrow</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Wu_rz</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;Wu_rz_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)],</span> <span class="n">borrow</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Bu_h</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;Bu_h_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)],</span> <span class="n">borrow</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Hu</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;Hu_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)],</span> <span class="n">borrow</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_to_output</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Wuy</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;Wuy&#39;</span><span class="p">],</span> <span class="n">borrow</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Ws_init</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;Wu_to_s_init&#39;</span><span class="p">],</span> <span class="n">borrow</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Bs_init</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;Bu_to_s_init&#39;</span><span class="p">],</span> <span class="n">borrow</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_propagation_mode</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Wu_to_s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;Wu_to_s&#39;</span><span class="p">],</span> <span class="n">borrow</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">print_state</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session_layers</span><span class="p">)):</span>
            <span class="n">print_norm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Ws_in</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s1">&#39;Ws_in_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
            <span class="n">print_norm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Ws_hh</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s1">&#39;Ws_hh_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
            <span class="n">print_norm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Ws_rz</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s1">&#39;Ws_rz_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
            <span class="n">print_norm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Bs_h</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s1">&#39;Bs_h_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
            <span class="n">print_norm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Hs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s1">&#39;Hs_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
        <span class="n">print_norm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Wsy</span><span class="p">,</span> <span class="s1">&#39;Wsy&#39;</span><span class="p">)</span>
        <span class="n">print_norm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">By</span><span class="p">,</span> <span class="s1">&#39;By&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_layers</span><span class="p">)):</span>
            <span class="n">print_norm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Wu_in</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s1">&#39;Wu_in_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
            <span class="n">print_norm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Wu_hh</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s1">&#39;Wu_hh_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
            <span class="n">print_norm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Wu_rz</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s1">&#39;Wu_rz_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
            <span class="n">print_norm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Bu_h</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s1">&#39;Bu_h_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
            <span class="n">print_norm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Hu</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s1">&#39;Hu_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_to_output</span><span class="p">:</span>
            <span class="n">print_norm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Wuy</span><span class="p">,</span> <span class="s1">&#39;Wuy&#39;</span><span class="p">)</span>
        <span class="n">print_norm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Ws_init</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;Wu_to_s_init&#39;</span><span class="p">)</span>
        <span class="n">print_norm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Bs_init</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;Bu_to_s_init&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_propagation_mode</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
            <span class="n">print_norm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Wu_to_s</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;Wu_to_s&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">rnn_input_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_items</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_embedding</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">E_item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_weights</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">n_items</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_embedding</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_item_embeddings</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_item_embeddings</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">E_item</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_item_embeddings</span><span class="p">)</span>
            <span class="n">rnn_input_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_embedding</span>

        <span class="c1"># Initialize the session parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Ws_in</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ws_hh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ws_rz</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Bs_h</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Hs</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session_layers</span><span class="p">)):</span>
            <span class="n">m</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">m</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">init_matrix</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">session_layers</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">rnn_input_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_layers</span><span class="p">[</span><span class="n">i</span><span class="p">])))</span>
            <span class="n">m</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">init_matrix</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">session_layers</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">rnn_input_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_layers</span><span class="p">[</span><span class="n">i</span><span class="p">])))</span>
            <span class="n">m</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">init_matrix</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">session_layers</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">rnn_input_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_layers</span><span class="p">[</span><span class="n">i</span><span class="p">])))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Ws_in</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">theano</span><span class="o">.</span><span class="n">shared</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span><span class="n">m</span><span class="p">),</span> <span class="n">borrow</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Ws_hh</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">init_weights</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">session_layers</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_layers</span><span class="p">[</span><span class="n">i</span><span class="p">])))</span>
            <span class="n">m2</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">m2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">init_matrix</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">session_layers</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_layers</span><span class="p">[</span><span class="n">i</span><span class="p">])))</span>
            <span class="n">m2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">init_matrix</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">session_layers</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_layers</span><span class="p">[</span><span class="n">i</span><span class="p">])))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Ws_rz</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">theano</span><span class="o">.</span><span class="n">shared</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span><span class="n">m2</span><span class="p">),</span> <span class="n">borrow</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Bs_h</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">theano</span><span class="o">.</span><span class="n">shared</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">session_layers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">theano</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">floatX</span><span class="p">),</span> <span class="n">borrow</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Hs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">theano</span><span class="o">.</span><span class="n">shared</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_layers</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">theano</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">floatX</span><span class="p">),</span>
                              <span class="n">borrow</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="c1"># Session to output weights</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Wsy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_weights</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">n_items</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_layers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
        <span class="c1"># Global output bias</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">By</span> <span class="o">=</span> <span class="n">theano</span><span class="o">.</span><span class="n">shared</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">n_items</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">theano</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">floatX</span><span class="p">),</span> <span class="n">borrow</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Initialize the user parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Wu_in</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Wu_hh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Wu_rz</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Bu_h</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Hu</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_layers</span><span class="p">)):</span>
            <span class="n">m</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">m</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">init_matrix</span><span class="p">(</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_layers</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_layers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_layers</span><span class="p">[</span><span class="n">i</span><span class="p">])))</span>
            <span class="n">m</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">init_matrix</span><span class="p">(</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_layers</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_layers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_layers</span><span class="p">[</span><span class="n">i</span><span class="p">])))</span>
            <span class="n">m</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">init_matrix</span><span class="p">(</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_layers</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_layers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_layers</span><span class="p">[</span><span class="n">i</span><span class="p">])))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Wu_in</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">theano</span><span class="o">.</span><span class="n">shared</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span><span class="n">m</span><span class="p">),</span> <span class="n">borrow</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Wu_hh</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">init_weights</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">user_layers</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_layers</span><span class="p">[</span><span class="n">i</span><span class="p">])))</span>
            <span class="n">m2</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">m2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">init_matrix</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">user_layers</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_layers</span><span class="p">[</span><span class="n">i</span><span class="p">])))</span>
            <span class="n">m2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">init_matrix</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">user_layers</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_layers</span><span class="p">[</span><span class="n">i</span><span class="p">])))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Wu_rz</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">theano</span><span class="o">.</span><span class="n">shared</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span><span class="n">m2</span><span class="p">),</span> <span class="n">borrow</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Bu_h</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">theano</span><span class="o">.</span><span class="n">shared</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">user_layers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">theano</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">floatX</span><span class="p">),</span> <span class="n">borrow</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Hu</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">theano</span><span class="o">.</span><span class="n">shared</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_layers</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">theano</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">floatX</span><span class="p">),</span>
                              <span class="n">borrow</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_to_output</span><span class="p">:</span>
            <span class="c1"># User to output weights</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Wuy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_weights</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">n_items</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_layers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>

        <span class="c1"># User-to-Session parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Ws_init</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Bs_init</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Ws_init</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">init_weights</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">user_layers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_layers</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Bs_init</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">theano</span><span class="o">.</span><span class="n">shared</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">session_layers</span><span class="p">[</span><span class="mi">0</span><span class="p">],),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">theano</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">floatX</span><span class="p">),</span> <span class="n">borrow</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_propagation_mode</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">m</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">init_matrix</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">user_layers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_layers</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
            <span class="n">m</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">init_matrix</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">user_layers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_layers</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
            <span class="n">m</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">init_matrix</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">user_layers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_layers</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Wu_to_s</span> <span class="o">=</span> <span class="p">[</span><span class="n">theano</span><span class="o">.</span><span class="n">shared</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span><span class="n">m</span><span class="p">),</span> <span class="n">borrow</span><span class="o">=</span><span class="kc">True</span><span class="p">)]</span>

    <span class="k">def</span> <span class="nf">dropout</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">drop_p</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">drop_p</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">retain_prob</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">drop_p</span>
            <span class="n">X</span> <span class="o">*=</span> <span class="n">srng</span><span class="o">.</span><span class="n">binomial</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">retain_prob</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">theano</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">floatX</span><span class="p">)</span> <span class="o">/</span> <span class="n">retain_prob</span>
        <span class="k">return</span> <span class="n">X</span>

    <span class="k">def</span> <span class="nf">adam</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">grad</span><span class="p">,</span> <span class="n">updates</span><span class="p">,</span> <span class="n">sample_idx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">):</span>
        <span class="n">v1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">decay</span><span class="p">)</span>
        <span class="n">v2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">decay</span><span class="p">)</span>
        <span class="n">acc</span> <span class="o">=</span> <span class="n">theano</span><span class="o">.</span><span class="n">shared</span><span class="p">(</span><span class="n">param</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="n">borrow</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">borrow</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">meang</span> <span class="o">=</span> <span class="n">theano</span><span class="o">.</span><span class="n">shared</span><span class="p">(</span><span class="n">param</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="n">borrow</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">borrow</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">countt</span> <span class="o">=</span> <span class="n">theano</span><span class="o">.</span><span class="n">shared</span><span class="p">(</span><span class="n">param</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="n">borrow</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">borrow</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sample_idx</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">acc_new</span> <span class="o">=</span> <span class="n">v1</span> <span class="o">*</span> <span class="n">acc</span> <span class="o">+</span> <span class="n">v2</span> <span class="o">*</span> <span class="n">grad</span> <span class="o">**</span> <span class="mi">2</span>
            <span class="n">meang_new</span> <span class="o">=</span> <span class="n">v1</span> <span class="o">*</span> <span class="n">meang</span> <span class="o">+</span> <span class="n">v2</span> <span class="o">*</span> <span class="n">grad</span>
            <span class="n">countt_new</span> <span class="o">=</span> <span class="n">countt</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">updates</span><span class="p">[</span><span class="n">acc</span><span class="p">]</span> <span class="o">=</span> <span class="n">acc_new</span>
            <span class="n">updates</span><span class="p">[</span><span class="n">meang</span><span class="p">]</span> <span class="o">=</span> <span class="n">meang_new</span>
            <span class="n">updates</span><span class="p">[</span><span class="n">countt</span><span class="p">]</span> <span class="o">=</span> <span class="n">countt_new</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">acc_s</span> <span class="o">=</span> <span class="n">acc</span><span class="p">[</span><span class="n">sample_idx</span><span class="p">]</span>
            <span class="n">meang_s</span> <span class="o">=</span> <span class="n">meang</span><span class="p">[</span><span class="n">sample_idx</span><span class="p">]</span>
            <span class="n">countt_s</span> <span class="o">=</span> <span class="n">countt</span><span class="p">[</span><span class="n">sample_idx</span><span class="p">]</span>
            <span class="n">acc_new</span> <span class="o">=</span> <span class="n">v1</span> <span class="o">*</span> <span class="n">acc_s</span> <span class="o">+</span> <span class="n">v2</span> <span class="o">*</span> <span class="n">grad</span> <span class="o">**</span> <span class="mi">2</span>
            <span class="n">meang_new</span> <span class="o">=</span> <span class="n">v1</span> <span class="o">*</span> <span class="n">meang_s</span> <span class="o">+</span> <span class="n">v2</span> <span class="o">*</span> <span class="n">grad</span>
            <span class="n">countt_new</span> <span class="o">=</span> <span class="n">countt_s</span> <span class="o">+</span> <span class="mf">1.0</span>
            <span class="n">updates</span><span class="p">[</span><span class="n">acc</span><span class="p">]</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">set_subtensor</span><span class="p">(</span><span class="n">acc_s</span><span class="p">,</span> <span class="n">acc_new</span><span class="p">)</span>
            <span class="n">updates</span><span class="p">[</span><span class="n">meang</span><span class="p">]</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">set_subtensor</span><span class="p">(</span><span class="n">meang_s</span><span class="p">,</span> <span class="n">meang_new</span><span class="p">)</span>
            <span class="n">updates</span><span class="p">[</span><span class="n">countt</span><span class="p">]</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">set_subtensor</span><span class="p">(</span><span class="n">countt_s</span><span class="p">,</span> <span class="n">countt_new</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">meang_new</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">v1</span> <span class="o">**</span> <span class="n">countt_new</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">T</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">acc_new</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">v1</span> <span class="o">**</span> <span class="n">countt_new</span><span class="p">))</span> <span class="o">+</span> <span class="n">epsilon</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">adagrad</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">grad</span><span class="p">,</span> <span class="n">updates</span><span class="p">,</span> <span class="n">sample_idx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">):</span>
        <span class="n">acc</span> <span class="o">=</span> <span class="n">theano</span><span class="o">.</span><span class="n">shared</span><span class="p">(</span><span class="n">param</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="n">borrow</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">borrow</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sample_idx</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">acc_new</span> <span class="o">=</span> <span class="n">acc</span> <span class="o">+</span> <span class="n">grad</span> <span class="o">**</span> <span class="mi">2</span>
            <span class="n">updates</span><span class="p">[</span><span class="n">acc</span><span class="p">]</span> <span class="o">=</span> <span class="n">acc_new</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">acc_s</span> <span class="o">=</span> <span class="n">acc</span><span class="p">[</span><span class="n">sample_idx</span><span class="p">]</span>
            <span class="n">acc_new</span> <span class="o">=</span> <span class="n">acc_s</span> <span class="o">+</span> <span class="n">grad</span> <span class="o">**</span> <span class="mi">2</span>
            <span class="n">updates</span><span class="p">[</span><span class="n">acc</span><span class="p">]</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">set_subtensor</span><span class="p">(</span><span class="n">acc_s</span><span class="p">,</span> <span class="n">acc_new</span><span class="p">)</span>
        <span class="n">gradient_scaling</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">T</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">acc_new</span> <span class="o">+</span> <span class="n">epsilon</span><span class="p">),</span> <span class="n">theano</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">floatX</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">grad</span> <span class="o">/</span> <span class="n">gradient_scaling</span>

    <span class="k">def</span> <span class="nf">adadelta</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">grad</span><span class="p">,</span> <span class="n">updates</span><span class="p">,</span> <span class="n">sample_idx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">):</span>
        <span class="n">v1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">decay</span><span class="p">)</span>
        <span class="n">v2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">decay</span><span class="p">)</span>
        <span class="n">acc</span> <span class="o">=</span> <span class="n">theano</span><span class="o">.</span><span class="n">shared</span><span class="p">(</span><span class="n">param</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="n">borrow</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">borrow</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">upd</span> <span class="o">=</span> <span class="n">theano</span><span class="o">.</span><span class="n">shared</span><span class="p">(</span><span class="n">param</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="n">borrow</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">borrow</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sample_idx</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">acc_new</span> <span class="o">=</span> <span class="n">acc</span> <span class="o">+</span> <span class="n">grad</span> <span class="o">**</span> <span class="mi">2</span>
            <span class="n">updates</span><span class="p">[</span><span class="n">acc</span><span class="p">]</span> <span class="o">=</span> <span class="n">acc_new</span>
            <span class="n">grad</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">upd</span> <span class="o">+</span> <span class="n">epsilon</span><span class="p">)</span> <span class="o">*</span> <span class="n">grad</span>
            <span class="n">upd_new</span> <span class="o">=</span> <span class="n">v1</span> <span class="o">*</span> <span class="n">upd</span> <span class="o">+</span> <span class="n">v2</span> <span class="o">*</span> <span class="n">grad</span> <span class="o">**</span> <span class="mi">2</span>
            <span class="n">updates</span><span class="p">[</span><span class="n">upd</span><span class="p">]</span> <span class="o">=</span> <span class="n">upd_new</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">acc_s</span> <span class="o">=</span> <span class="n">acc</span><span class="p">[</span><span class="n">sample_idx</span><span class="p">]</span>
            <span class="n">acc_new</span> <span class="o">=</span> <span class="n">acc_s</span> <span class="o">+</span> <span class="n">grad</span> <span class="o">**</span> <span class="mi">2</span>
            <span class="n">updates</span><span class="p">[</span><span class="n">acc</span><span class="p">]</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">set_subtensor</span><span class="p">(</span><span class="n">acc_s</span><span class="p">,</span> <span class="n">acc_new</span><span class="p">)</span>
            <span class="n">upd_s</span> <span class="o">=</span> <span class="n">upd</span><span class="p">[</span><span class="n">sample_idx</span><span class="p">]</span>
            <span class="n">upd_new</span> <span class="o">=</span> <span class="n">v1</span> <span class="o">*</span> <span class="n">upd_s</span> <span class="o">+</span> <span class="n">v2</span> <span class="o">*</span> <span class="n">grad</span> <span class="o">**</span> <span class="mi">2</span>
            <span class="n">updates</span><span class="p">[</span><span class="n">upd</span><span class="p">]</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">set_subtensor</span><span class="p">(</span><span class="n">upd_s</span><span class="p">,</span> <span class="n">upd_new</span><span class="p">)</span>
            <span class="n">grad</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">upd_s</span> <span class="o">+</span> <span class="n">epsilon</span><span class="p">)</span> <span class="o">*</span> <span class="n">grad</span>
        <span class="n">gradient_scaling</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">T</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">acc_new</span> <span class="o">+</span> <span class="n">epsilon</span><span class="p">),</span> <span class="n">theano</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">floatX</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">grad</span> <span class="o">/</span> <span class="n">gradient_scaling</span>

    <span class="k">def</span> <span class="nf">rmsprop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">grad</span><span class="p">,</span> <span class="n">updates</span><span class="p">,</span> <span class="n">sample_idx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">):</span>
        <span class="n">v1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">decay</span><span class="p">)</span>
        <span class="n">v2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">decay</span><span class="p">)</span>
        <span class="n">acc</span> <span class="o">=</span> <span class="n">theano</span><span class="o">.</span><span class="n">shared</span><span class="p">(</span><span class="n">param</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="n">borrow</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">borrow</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sample_idx</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">acc_new</span> <span class="o">=</span> <span class="n">v1</span> <span class="o">*</span> <span class="n">acc</span> <span class="o">+</span> <span class="n">v2</span> <span class="o">*</span> <span class="n">grad</span> <span class="o">**</span> <span class="mi">2</span>
            <span class="n">updates</span><span class="p">[</span><span class="n">acc</span><span class="p">]</span> <span class="o">=</span> <span class="n">acc_new</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">acc_s</span> <span class="o">=</span> <span class="n">acc</span><span class="p">[</span><span class="n">sample_idx</span><span class="p">]</span>
            <span class="n">acc_new</span> <span class="o">=</span> <span class="n">v1</span> <span class="o">*</span> <span class="n">acc_s</span> <span class="o">+</span> <span class="n">v2</span> <span class="o">*</span> <span class="n">grad</span> <span class="o">**</span> <span class="mi">2</span>
            <span class="n">updates</span><span class="p">[</span><span class="n">acc</span><span class="p">]</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">set_subtensor</span><span class="p">(</span><span class="n">acc_s</span><span class="p">,</span> <span class="n">acc_new</span><span class="p">)</span>
        <span class="n">gradient_scaling</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">T</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">acc_new</span> <span class="o">+</span> <span class="n">epsilon</span><span class="p">),</span> <span class="n">theano</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">floatX</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">grad</span> <span class="o">/</span> <span class="n">gradient_scaling</span>

    <span class="k">def</span> <span class="nf">RMSprop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cost</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">full_params</span><span class="p">,</span> <span class="n">sampled_params</span><span class="p">,</span> <span class="n">sidxs</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">):</span>
        <span class="n">grads</span> <span class="o">=</span> <span class="p">[</span><span class="n">T</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="n">cost</span><span class="p">,</span> <span class="n">wrt</span><span class="o">=</span><span class="n">param</span><span class="p">)</span> <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">params</span><span class="p">]</span>
        <span class="n">sgrads</span> <span class="o">=</span> <span class="p">[</span><span class="n">T</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="n">cost</span><span class="p">,</span> <span class="n">wrt</span><span class="o">=</span><span class="n">sparam</span><span class="p">)</span> <span class="k">for</span> <span class="n">sparam</span> <span class="ow">in</span> <span class="n">sampled_params</span><span class="p">]</span>
        <span class="n">updates</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">grad_cap</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">norm</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">T</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">T</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">T</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">T</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">g</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">g_list</span><span class="p">])</span> <span class="k">for</span> <span class="n">g_list</span> <span class="ow">in</span> <span class="n">grads</span><span class="p">])</span> <span class="o">+</span> <span class="n">T</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
                <span class="p">[</span><span class="n">T</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">g</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">sgrads</span><span class="p">])),</span> <span class="n">theano</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">floatX</span><span class="p">)</span>
            <span class="n">grads</span> <span class="o">=</span> <span class="p">[[</span><span class="n">T</span><span class="o">.</span><span class="n">switch</span><span class="p">(</span><span class="n">T</span><span class="o">.</span><span class="n">ge</span><span class="p">(</span><span class="n">norm</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">grad_cap</span><span class="p">),</span> <span class="n">g</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">grad_cap</span> <span class="o">/</span> <span class="n">norm</span><span class="p">,</span> <span class="n">g</span><span class="p">)</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">g_list</span><span class="p">]</span> <span class="k">for</span> <span class="n">g_list</span> <span class="ow">in</span>
                     <span class="n">grads</span><span class="p">]</span>
            <span class="n">sgrads</span> <span class="o">=</span> <span class="p">[</span><span class="n">T</span><span class="o">.</span><span class="n">switch</span><span class="p">(</span><span class="n">T</span><span class="o">.</span><span class="n">ge</span><span class="p">(</span><span class="n">norm</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">grad_cap</span><span class="p">),</span> <span class="n">g</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">grad_cap</span> <span class="o">/</span> <span class="n">norm</span><span class="p">,</span> <span class="n">g</span><span class="p">)</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">sgrads</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">p_list</span><span class="p">,</span> <span class="n">g_list</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">grads</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">p</span><span class="p">,</span> <span class="n">g</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">p_list</span><span class="p">,</span> <span class="n">g_list</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">adapt</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">adapt</span> <span class="o">==</span> <span class="s1">&#39;adagrad&#39;</span><span class="p">:</span>
                        <span class="n">g</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">adagrad</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">updates</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">adapt</span> <span class="o">==</span> <span class="s1">&#39;rmsprop&#39;</span><span class="p">:</span>
                        <span class="n">g</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rmsprop</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">updates</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">adapt</span> <span class="o">==</span> <span class="s1">&#39;adadelta&#39;</span><span class="p">:</span>
                        <span class="n">g</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">adadelta</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">updates</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">adapt</span> <span class="o">==</span> <span class="s1">&#39;adam&#39;</span><span class="p">:</span>
                        <span class="n">g</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">adam</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">updates</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">momentum</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">velocity</span> <span class="o">=</span> <span class="n">theano</span><span class="o">.</span><span class="n">shared</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="n">borrow</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">borrow</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">velocity2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">momentum</span> <span class="o">*</span> <span class="n">velocity</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">learning_rate</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">g</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">lmbd</span> <span class="o">*</span> <span class="n">p</span><span class="p">)</span>
                    <span class="n">updates</span><span class="p">[</span><span class="n">velocity</span><span class="p">]</span> <span class="o">=</span> <span class="n">velocity2</span>
                    <span class="n">updates</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span> <span class="o">+</span> <span class="n">velocity2</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">updates</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">learning_rate</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">lmbd</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">learning_rate</span><span class="p">)</span> <span class="o">*</span> <span class="n">g</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sgrads</span><span class="p">)):</span>
            <span class="n">g</span> <span class="o">=</span> <span class="n">sgrads</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">fullP</span> <span class="o">=</span> <span class="n">full_params</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">sample_idx</span> <span class="o">=</span> <span class="n">sidxs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">sparam</span> <span class="o">=</span> <span class="n">sampled_params</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">adapt</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">adapt</span> <span class="o">==</span> <span class="s1">&#39;adagrad&#39;</span><span class="p">:</span>
                    <span class="n">g</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">adagrad</span><span class="p">(</span><span class="n">fullP</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">updates</span><span class="p">,</span> <span class="n">sample_idx</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">adapt</span> <span class="o">==</span> <span class="s1">&#39;rmsprop&#39;</span><span class="p">:</span>
                    <span class="n">g</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rmsprop</span><span class="p">(</span><span class="n">fullP</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">updates</span><span class="p">,</span> <span class="n">sample_idx</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">adapt</span> <span class="o">==</span> <span class="s1">&#39;adadelta&#39;</span><span class="p">:</span>
                    <span class="n">g</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">adadelta</span><span class="p">(</span><span class="n">fullP</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">updates</span><span class="p">,</span> <span class="n">sample_idx</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">adapt</span> <span class="o">==</span> <span class="s1">&#39;adam&#39;</span><span class="p">:</span>
                    <span class="n">g</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">adam</span><span class="p">(</span><span class="n">fullP</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">updates</span><span class="p">,</span> <span class="n">sample_idx</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lmbd</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">delta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">learning_rate</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">g</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">lmbd</span> <span class="o">*</span> <span class="n">sparam</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">delta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">learning_rate</span><span class="p">)</span> <span class="o">*</span> <span class="n">g</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">momentum</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">velocity</span> <span class="o">=</span> <span class="n">theano</span><span class="o">.</span><span class="n">shared</span><span class="p">(</span><span class="n">fullP</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="n">borrow</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">borrow</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">vs</span> <span class="o">=</span> <span class="n">velocity</span><span class="p">[</span><span class="n">sample_idx</span><span class="p">]</span>
                <span class="n">velocity2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">momentum</span> <span class="o">*</span> <span class="n">vs</span> <span class="o">-</span> <span class="n">delta</span>
                <span class="n">updates</span><span class="p">[</span><span class="n">velocity</span><span class="p">]</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">set_subtensor</span><span class="p">(</span><span class="n">vs</span><span class="p">,</span> <span class="n">velocity2</span><span class="p">)</span>
                <span class="n">updates</span><span class="p">[</span><span class="n">fullP</span><span class="p">]</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">inc_subtensor</span><span class="p">(</span><span class="n">sparam</span><span class="p">,</span> <span class="n">velocity2</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">updates</span><span class="p">[</span><span class="n">fullP</span><span class="p">]</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">inc_subtensor</span><span class="p">(</span><span class="n">sparam</span><span class="p">,</span> <span class="o">-</span> <span class="n">delta</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">updates</span>

    <span class="k">def</span> <span class="nf">model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">Sstart</span><span class="p">,</span> <span class="n">Ustart</span><span class="p">,</span> <span class="n">Hs</span><span class="p">,</span> <span class="n">Hu</span><span class="p">,</span> <span class="n">Y</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
              <span class="n">drop_p_hidden_usr</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
              <span class="n">drop_p_hidden_ses</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
              <span class="n">drop_p_init</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
        <span class="c1">#</span>
        <span class="c1"># USER GRU</span>
        <span class="c1">#</span>
        <span class="c1"># update the User GRU with the last hidden state of the Session GRU</span>
        <span class="c1"># NOTE: the User GRU gets actually updated only when a new session starts</span>
        <span class="n">user_in</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Hs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">Wu_in</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">Bu_h</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">user_in</span> <span class="o">=</span> <span class="n">user_in</span><span class="o">.</span><span class="n">T</span>
        <span class="c1"># ^ 3 * user_layers[0] x batch_size</span>

        <span class="n">rz_u</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">nnet</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">user_in</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">user_layers</span><span class="p">[</span><span class="mi">0</span><span class="p">]:]</span>
                              <span class="o">+</span> <span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Hu</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">Wu_rz</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="c1"># ^ 2 * user_layers[0] x batch_size</span>

        <span class="n">h_u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hidden_activation</span><span class="p">(</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Hu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">rz_u</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">user_layers</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Wu_hh</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
                                     <span class="o">+</span> <span class="n">user_in</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">user_layers</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
        <span class="c1"># ^ user_layers[0] x batch_size</span>

        <span class="n">z</span> <span class="o">=</span> <span class="n">rz_u</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">user_layers</span><span class="p">[</span><span class="mi">0</span><span class="p">]:]</span><span class="o">.</span><span class="n">T</span>
        <span class="c1"># batch_size x user_layers[0]</span>
        <span class="n">h_u</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">z</span><span class="p">)</span> <span class="o">*</span> <span class="n">Hu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">z</span> <span class="o">*</span> <span class="n">h_u</span><span class="o">.</span><span class="n">T</span>
        <span class="n">h_u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span><span class="p">(</span><span class="n">h_u</span><span class="p">,</span> <span class="n">drop_p_hidden_usr</span><span class="p">)</span>
        <span class="c1"># ^ batch_size x user_layers[0]</span>

        <span class="c1"># update the User GRU only when a new session starts</span>
        <span class="c1"># Hu contains the state of the previous session</span>
        <span class="n">h_u</span> <span class="o">=</span> <span class="n">Hu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">Sstart</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">])</span> <span class="o">+</span> <span class="n">h_u</span> <span class="o">*</span> <span class="n">Sstart</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
        <span class="c1"># ^ batch_size x user_layers[0]</span>

        <span class="c1"># reset the user network state for new users</span>
        <span class="n">h_u</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">h_u</span><span class="p">)</span> <span class="o">*</span> <span class="n">Ustart</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">+</span> <span class="n">h_u</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">Ustart</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">])</span>

        <span class="n">Hu_new</span> <span class="o">=</span> <span class="p">[</span><span class="n">h_u</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_layers</span><span class="p">)):</span>
            <span class="n">user_in</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">h_u</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Wu_in</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">Bu_h</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">user_in</span> <span class="o">=</span> <span class="n">user_in</span><span class="o">.</span><span class="n">T</span>
            <span class="n">rz_u</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">nnet</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">user_in</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">user_layers</span><span class="p">[</span><span class="n">i</span><span class="p">]:]</span>
                                  <span class="o">+</span> <span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Hu</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">Wu_rz</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

            <span class="n">h_u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hidden_activation</span><span class="p">(</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Hu</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">rz_u</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">user_layers</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Wu_hh</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
                                         <span class="o">+</span> <span class="n">user_in</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">user_layers</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>

            <span class="n">z</span> <span class="o">=</span> <span class="n">rz_u</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">user_layers</span><span class="p">[</span><span class="n">i</span><span class="p">]:]</span><span class="o">.</span><span class="n">T</span>
            <span class="n">h_u</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">z</span><span class="p">)</span> <span class="o">*</span> <span class="n">Hu</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">z</span> <span class="o">*</span> <span class="n">h_u</span><span class="o">.</span><span class="n">T</span>
            <span class="n">h_u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span><span class="p">(</span><span class="n">h_u</span><span class="p">,</span> <span class="n">drop_p_hidden_usr</span><span class="p">)</span>
            <span class="n">h_u</span> <span class="o">=</span> <span class="n">Hu</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">Sstart</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">])</span> <span class="o">+</span> <span class="n">h_u</span> <span class="o">*</span> <span class="n">Sstart</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
            <span class="n">h_u</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">h_u</span><span class="p">)</span> <span class="o">*</span> <span class="n">Ustart</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">+</span> <span class="n">h_u</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">Ustart</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">])</span>
            <span class="n">Hu_new</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">h_u</span><span class="p">)</span>

        <span class="c1">#</span>
        <span class="c1"># SESSION GRU</span>
        <span class="c1">#</span>
        <span class="c1"># Process the input items</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_embedding</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># get the item embedding</span>
            <span class="n">SE_item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">E_item</span><span class="p">[</span><span class="n">X</span><span class="p">]</span>  <span class="c1"># sampled item embedding</span>
            <span class="n">vec</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">SE_item</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ws_in</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">Bs_h</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">Sin</span> <span class="o">=</span> <span class="n">SE_item</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Sx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ws_in</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">X</span><span class="p">]</span>
            <span class="n">vec</span> <span class="o">=</span> <span class="n">Sx</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">Bs_h</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">Sin</span> <span class="o">=</span> <span class="n">Sx</span>
        <span class="n">session_in</span> <span class="o">=</span> <span class="n">vec</span><span class="o">.</span><span class="n">T</span>
        <span class="c1"># ^ session_layers[0] x batch_size</span>

        <span class="c1"># initialize the h_s with h_c only for starting sessions</span>
        <span class="n">h_s_init</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">s_init_act</span><span class="p">(</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">h_u</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ws_init</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">Bs_init</span><span class="p">),</span> <span class="n">drop_p_init</span><span class="p">)</span>
        <span class="n">h_s</span> <span class="o">=</span> <span class="n">Hs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">Sstart</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">])</span> <span class="o">+</span> <span class="n">h_s_init</span> <span class="o">*</span> <span class="n">Sstart</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
        <span class="c1"># reset h_s for starting users</span>
        <span class="n">h_s</span> <span class="o">=</span> <span class="n">h_s</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">Ustart</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">])</span> <span class="o">+</span> <span class="n">T</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">h_s</span><span class="p">)</span> <span class="o">*</span> <span class="n">Ustart</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h_s_init</span> <span class="o">=</span> <span class="n">h_s</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_propagation_mode</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
            <span class="c1"># this propagates the bias throughout all the session</span>
            <span class="n">user_bias</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">h_u</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Wu_to_s</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
            <span class="c1"># ^ 3*session_layers[0] x batch_size</span>

            <span class="c1"># update the Session GRU</span>
            <span class="n">rz_s</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">nnet</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">user_bias</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">session_layers</span><span class="p">[</span><span class="mi">0</span><span class="p">]:]</span>
                                  <span class="o">+</span> <span class="n">session_in</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">session_layers</span><span class="p">[</span><span class="mi">0</span><span class="p">]:]</span>
                                  <span class="o">+</span> <span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">h_s</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ws_rz</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
            <span class="c1"># ^ 2*session_layers[0] x batch_size</span>

            <span class="n">h_s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hidden_activation</span><span class="p">(</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">h_s</span> <span class="o">*</span> <span class="n">rz_s</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">session_layers</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ws_hh</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
                                         <span class="o">+</span> <span class="n">session_in</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">session_layers</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
            <span class="c1"># ^ session_layers[0] x batch_size</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rz_s</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">nnet</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">session_in</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">session_layers</span><span class="p">[</span><span class="mi">0</span><span class="p">]:]</span>
                                  <span class="o">+</span> <span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">h_s</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ws_rz</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
            <span class="n">h_s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hidden_activation</span><span class="p">(</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">h_s</span> <span class="o">*</span> <span class="n">rz_s</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">session_layers</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ws_hh</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
                                         <span class="o">+</span> <span class="n">session_in</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">session_layers</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>

        <span class="n">z</span> <span class="o">=</span> <span class="n">rz_s</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">session_layers</span><span class="p">[</span><span class="mi">0</span><span class="p">]:]</span><span class="o">.</span><span class="n">T</span>
        <span class="c1"># ^ batch_size x session_layers[0]</span>
        <span class="n">h_s</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">z</span><span class="p">)</span> <span class="o">*</span> <span class="n">Hs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">z</span> <span class="o">*</span> <span class="n">h_s</span><span class="o">.</span><span class="n">T</span>
        <span class="n">h_s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span><span class="p">(</span><span class="n">h_s</span><span class="p">,</span> <span class="n">drop_p_hidden_ses</span><span class="p">)</span>
        <span class="c1"># ^ batch_size x session_layers[0]</span>
        <span class="n">Hs_new</span> <span class="o">=</span> <span class="p">[</span><span class="n">h_s</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session_layers</span><span class="p">)):</span>
            <span class="n">session_in</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">h_s</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ws_in</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">Bs_h</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">session_in</span> <span class="o">=</span> <span class="n">session_in</span><span class="o">.</span><span class="n">T</span>
            <span class="n">rz_s</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">nnet</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">session_in</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">session_layers</span><span class="p">[</span><span class="n">i</span><span class="p">]:]</span>
                                  <span class="o">+</span> <span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Hs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ws_rz</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
            <span class="n">h_s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hidden_activation</span><span class="p">(</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Hs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">rz_s</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">session_layers</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ws_hh</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
                                         <span class="o">+</span> <span class="n">session_in</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">session_layers</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>
            <span class="n">z</span> <span class="o">=</span> <span class="n">rz_s</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">session_layers</span><span class="p">[</span><span class="n">i</span><span class="p">]:]</span><span class="o">.</span><span class="n">T</span>
            <span class="n">h_s</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">z</span><span class="p">)</span> <span class="o">*</span> <span class="n">Hs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">z</span> <span class="o">*</span> <span class="n">h_s</span><span class="o">.</span><span class="n">T</span>
            <span class="n">h_s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span><span class="p">(</span><span class="n">h_s</span><span class="p">,</span> <span class="n">drop_p_hidden_ses</span><span class="p">)</span>
            <span class="n">Hs_new</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">h_s</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">h_s_new</span> <span class="o">=</span> <span class="n">h_s</span>

        <span class="k">if</span> <span class="n">Y</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">Ssy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Wsy</span><span class="p">[</span><span class="n">Y</span><span class="p">]</span>
            <span class="n">SBy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">By</span><span class="p">[</span><span class="n">Y</span><span class="p">]</span>
            <span class="n">preact</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">h_s</span><span class="p">,</span> <span class="n">Ssy</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="o">+</span> <span class="n">SBy</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="n">sampled_params</span> <span class="o">=</span> <span class="p">[</span><span class="n">Sin</span><span class="p">,</span> <span class="n">Ssy</span><span class="p">,</span> <span class="n">SBy</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_to_output</span><span class="p">:</span>
                <span class="n">Scy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Wuy</span><span class="p">[</span><span class="n">Y</span><span class="p">]</span>
                <span class="n">preact</span> <span class="o">+=</span> <span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">h_u</span><span class="p">,</span> <span class="n">Scy</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
                <span class="n">sampled_params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Scy</span><span class="p">)</span>
            <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">final_activation</span><span class="p">(</span><span class="n">preact</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">Hs_new</span><span class="p">,</span> <span class="n">Hu_new</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">sampled_params</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">preact</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">h_s</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Wsy</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">By</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_to_output</span><span class="p">:</span>
                <span class="n">preact</span> <span class="o">+=</span> <span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">h_u</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Wuy</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
            <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">final_activation</span><span class="p">(</span><span class="n">preact</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">Hs_new</span><span class="p">,</span> <span class="n">Hu_new</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="p">[</span><span class="n">Sin</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">train_data</span><span class="p">,</span> <span class="n">valid_data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">retrain</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sample_store</span><span class="o">=</span><span class="mi">10000000</span><span class="p">,</span> <span class="n">patience</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">margin</span><span class="o">=</span><span class="mf">1.003</span><span class="p">,</span>
            <span class="n">save_to</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">load_from</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Trains the network.</span>

<span class="sd">        Parameters</span>
<span class="sd">        --------</span>
<span class="sd">        train_data : pandas.DataFrame</span>
<span class="sd">            Training data. It contains the transactions of the sessions. It has one column for session IDs, one for item IDs and one for the timestamp of the events (unix timestamps).</span>
<span class="sd">            It must have a header. Column names are arbitrary, but must correspond to the ones you set during the initialization of the network (session_key, item_key, time_key properties).</span>
<span class="sd">        valid_data: pandas.DataFrame</span>
<span class="sd">            Validation data. If not none, it enables early stopping.</span>
<span class="sd">             Contains the transactions in the same format as in train_data, and it is used exclusively to compute the loss after each training iteration over train_data.</span>
<span class="sd">        retrain : boolean</span>
<span class="sd">            If False, do normal train. If True, do additional train (weights from previous trainings are kept as the initial network) (default: False)</span>
<span class="sd">        sample_store : int</span>
<span class="sd">            If additional negative samples are used (n_sample &gt; 0), the efficiency of GPU utilization can be sped up, by precomputing a large batch of negative samples (and recomputing when necessary).</span>
<span class="sd">            This parameter regulizes the size of this precomputed ID set. Its value is the maximum number of int values (IDs) to be stored. Precomputed IDs are stored in the RAM.</span>
<span class="sd">            For the most efficient computation, a balance must be found between storing few examples and constantly interrupting GPU computations for a short time vs. computing many examples and interrupting GPU computations for a long time (but rarely).</span>
<span class="sd">        patience: int</span>
<span class="sd">            Patience of the early stopping procedure. Number of iterations with not decreasing validation loss before terminating the training procedure</span>
<span class="sd">        margin: float</span>
<span class="sd">            Margin of early stopping. Percentage improvement over the current best validation loss to do not incur into a patience penalty</span>
<span class="sd">        save_to: string</span>
<span class="sd">            Path where to save the state of the best model resulting from training.</span>
<span class="sd">            If early stopping is enabled, saves the model with the lowest validation loss. Otherwise, saves the model corresponding to the last iteration.</span>
<span class="sd">        load_from: string</span>
<span class="sd">            Path from where to load the state of a previously saved model.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">predict</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">error_during_train</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">itemids</span> <span class="o">=</span> <span class="n">train_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">item_key</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_items</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">itemids</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="p">()</span>  <span class="c1"># initialize the network</span>
        <span class="k">if</span> <span class="n">load_from</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Resuming from state: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">load_from</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">load_state</span><span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">load_from</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">retrain</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">itemidmap</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_items</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="n">itemids</span><span class="p">)</span>
            <span class="n">train_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">train_data</span><span class="p">,</span>
                                  <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="bp">self</span><span class="o">.</span><span class="n">item_key</span><span class="p">:</span> <span class="n">itemids</span><span class="p">,</span> <span class="s1">&#39;ItemIdx&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">itemidmap</span><span class="p">[</span><span class="n">itemids</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">}),</span>
                                  <span class="n">on</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">item_key</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">)</span>
            <span class="n">user_indptr</span><span class="p">,</span> <span class="n">offset_sessions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">preprocess_data</span><span class="p">(</span><span class="n">train_data</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Not supported yet!&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">valid_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">valid_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">valid_data</span><span class="p">,</span>
                                  <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="bp">self</span><span class="o">.</span><span class="n">item_key</span><span class="p">:</span> <span class="n">itemids</span><span class="p">,</span> <span class="s1">&#39;ItemIdx&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">itemidmap</span><span class="p">[</span><span class="n">itemids</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">}),</span>
                                  <span class="n">on</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">item_key</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">)</span>
            <span class="n">user_indptr_valid</span><span class="p">,</span> <span class="n">offset_sessions_valid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">preprocess_data</span><span class="p">(</span><span class="n">valid_data</span><span class="p">)</span>

        <span class="n">X</span><span class="p">,</span> <span class="n">Y</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">ivectors</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">Sstart</span><span class="p">,</span> <span class="n">Ustart</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">fvectors</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">Hs_new</span><span class="p">,</span> <span class="n">Hu_new</span><span class="p">,</span> <span class="n">Y_pred</span><span class="p">,</span> <span class="n">sampled_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Sstart</span><span class="p">,</span> <span class="n">Ustart</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Hs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Hu</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span>
                                                            <span class="n">drop_p_hidden_usr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dropout_p_hidden_usr</span><span class="p">,</span>
                                                            <span class="n">drop_p_hidden_ses</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dropout_p_hidden_ses</span><span class="p">,</span>
                                                            <span class="n">drop_p_init</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dropout_p_init</span><span class="p">)</span>
        <span class="n">cost</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_function</span><span class="p">(</span><span class="n">Y_pred</span><span class="p">)</span>
        <span class="c1"># set up the parameter and sampled parameter vectors</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_embedding</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">params</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">Ws_in</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ws_hh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ws_rz</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Bs_h</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ws_init</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Bs_init</span><span class="p">,</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">Wu_in</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Wu_hh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Wu_rz</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Bu_h</span><span class="p">]</span>
            <span class="n">full_params</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">Ws_in</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">Wsy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">By</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">params</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">Ws_in</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ws_hh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ws_rz</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Bs_h</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ws_init</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Bs_init</span><span class="p">,</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">Wu_in</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Wu_hh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Wu_rz</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Bu_h</span><span class="p">]</span>
            <span class="n">full_params</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">E_item</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Wsy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">By</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_propagation_mode</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
            <span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Wu_to_s</span><span class="p">)</span>
        <span class="n">sidxs</span> <span class="o">=</span> <span class="p">[</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">Y</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_to_output</span><span class="p">:</span>
            <span class="n">full_params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Wuy</span><span class="p">)</span>
            <span class="n">sidxs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span>

        <span class="n">updates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">RMSprop</span><span class="p">(</span><span class="n">cost</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">full_params</span><span class="p">,</span> <span class="n">sampled_params</span><span class="p">,</span> <span class="n">sidxs</span><span class="p">)</span>
        <span class="n">eval_updates</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="c1"># Update the hidden states of the Session GRU</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Hs</span><span class="p">)):</span>
            <span class="n">updates</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">Hs</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">Hs_new</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">eval_updates</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">Hs</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">Hs_new</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="c1"># Update the hidden states of the User GRU</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Hu</span><span class="p">)):</span>
            <span class="n">updates</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">Hu</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">Hu_new</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">eval_updates</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">Hu</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">Hu_new</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="c1"># Compile the training and evaluation functions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_function</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="p">[</span><span class="n">X</span><span class="p">,</span> <span class="n">Sstart</span><span class="p">,</span> <span class="n">Ustart</span><span class="p">,</span> <span class="n">Y</span><span class="p">],</span> <span class="n">outputs</span><span class="o">=</span><span class="n">cost</span><span class="p">,</span> <span class="n">updates</span><span class="o">=</span><span class="n">updates</span><span class="p">,</span>
                                       <span class="n">allow_input_downcast</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                       <span class="n">on_unused_input</span><span class="o">=</span><span class="s1">&#39;warn&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eval_function</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="p">[</span><span class="n">X</span><span class="p">,</span> <span class="n">Sstart</span><span class="p">,</span> <span class="n">Ustart</span><span class="p">,</span> <span class="n">Y</span><span class="p">],</span> <span class="n">outputs</span><span class="o">=</span><span class="n">cost</span><span class="p">,</span> <span class="n">updates</span><span class="o">=</span><span class="n">eval_updates</span><span class="p">,</span>
                                      <span class="n">allow_input_downcast</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                      <span class="n">on_unused_input</span><span class="o">=</span><span class="s1">&#39;warn&#39;</span><span class="p">)</span>
        <span class="c1"># Negative item sampling</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_sample</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">neg_sampler</span> <span class="o">=</span> <span class="n">Sampler</span><span class="p">(</span><span class="n">train_data</span><span class="p">,</span>
                                       <span class="bp">self</span><span class="o">.</span><span class="n">n_sample</span><span class="p">,</span>
                                       <span class="n">rng</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="p">,</span>
                                       <span class="n">item_key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">item_key</span><span class="p">,</span>
                                       <span class="n">sample_alpha</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_alpha</span><span class="p">,</span>
                                       <span class="n">sample_store</span><span class="o">=</span><span class="n">sample_store</span><span class="p">)</span>
        <span class="c1"># Training starts here</span>
        <span class="n">best_valid</span><span class="p">,</span> <span class="n">best_state</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
        <span class="n">my_patience</span> <span class="o">=</span> <span class="n">patience</span>
        <span class="n">epoch</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">epoch</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_epochs</span> <span class="ow">and</span> <span class="n">my_patience</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">train_cost</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">iterate</span><span class="p">(</span><span class="n">train_data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_function</span><span class="p">,</span> <span class="n">offset_sessions</span><span class="p">,</span> <span class="n">user_indptr</span><span class="p">)</span>
            <span class="c1"># self.print_state()</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">train_cost</span><span class="p">):</span>
                <span class="k">return</span>
            <span class="k">if</span> <span class="n">valid_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">valid_cost</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">iterate</span><span class="p">(</span><span class="n">valid_data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eval_function</span><span class="p">,</span> <span class="n">offset_sessions_valid</span><span class="p">,</span> <span class="n">user_indptr_valid</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">best_valid</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">valid_cost</span> <span class="o">&lt;</span> <span class="n">best_valid</span><span class="p">:</span>
                    <span class="n">best_valid</span> <span class="o">=</span> <span class="n">valid_cost</span>
                    <span class="n">best_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_state</span><span class="p">()</span>
                    <span class="n">my_patience</span> <span class="o">=</span> <span class="n">patience</span>
                <span class="k">elif</span> <span class="n">valid_cost</span> <span class="o">&gt;=</span> <span class="n">best_valid</span> <span class="o">*</span> <span class="n">margin</span><span class="p">:</span>
                    <span class="n">my_patience</span> <span class="o">-=</span> <span class="mi">1</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s1">&#39;Epoch </span><span class="si">{}</span><span class="s1"> - train cost: </span><span class="si">{:.4f}</span><span class="s1"> - valid cost: </span><span class="si">{:.4f}</span><span class="s1"> (patience: </span><span class="si">{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">epoch</span><span class="p">,</span>
                                                                                               <span class="n">train_cost</span><span class="p">,</span>
                                                                                               <span class="n">valid_cost</span><span class="p">,</span>
                                                                                               <span class="n">my_patience</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Epoch </span><span class="si">{}</span><span class="s1"> - train cost: </span><span class="si">{:.4f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">epoch</span><span class="p">,</span> <span class="n">train_cost</span><span class="p">))</span>
            <span class="n">epoch</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">my_patience</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Early stopping condition met!&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">best_state</span><span class="p">:</span>
            <span class="c1"># always load the state associated with the best validation cost</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">load_state</span><span class="p">(</span><span class="n">best_state</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">save_to</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">best_state</span><span class="p">:</span>
                <span class="n">state</span> <span class="o">=</span> <span class="n">best_state</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_state</span><span class="p">()</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Saving model to: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">save_to</span><span class="p">))</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="n">save_to</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">),</span> <span class="n">pickle</span><span class="o">.</span><span class="n">HIGHEST_PROTOCOL</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">iterate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">fun</span><span class="p">,</span> <span class="n">offset_sessions</span><span class="p">,</span> <span class="n">user_indptr</span><span class="p">,</span> <span class="n">reset_state</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">reset_state</span><span class="p">:</span>
            <span class="c1"># Reset session layers</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session_layers</span><span class="p">)):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Hs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_layers</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">theano</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">floatX</span><span class="p">),</span>
                                     <span class="n">borrow</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="c1"># Reset user layers</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_layers</span><span class="p">)):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Hu</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_layers</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">theano</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">floatX</span><span class="p">),</span>
                                     <span class="n">borrow</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># variables to manage iterations over users</span>
        <span class="n">n_users</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">user_indptr</span><span class="p">)</span>
        <span class="n">offset_users</span> <span class="o">=</span> <span class="n">offset_sessions</span><span class="p">[</span><span class="n">user_indptr</span><span class="p">]</span>
        <span class="n">user_idx_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_users</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">user_iters</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">)</span>
        <span class="n">user_maxiter</span> <span class="o">=</span> <span class="n">user_iters</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">user_start</span> <span class="o">=</span> <span class="n">offset_users</span><span class="p">[</span><span class="n">user_idx_arr</span><span class="p">[</span><span class="n">user_iters</span><span class="p">]]</span>
        <span class="n">user_end</span> <span class="o">=</span> <span class="n">offset_users</span><span class="p">[</span><span class="n">user_idx_arr</span><span class="p">[</span><span class="n">user_iters</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>

        <span class="c1"># variables to manage iterations over sessions</span>
        <span class="n">session_iters</span> <span class="o">=</span> <span class="n">user_indptr</span><span class="p">[</span><span class="n">user_iters</span><span class="p">]</span>
        <span class="n">session_start</span> <span class="o">=</span> <span class="n">offset_sessions</span><span class="p">[</span><span class="n">session_iters</span><span class="p">]</span>
        <span class="n">session_end</span> <span class="o">=</span> <span class="n">offset_sessions</span><span class="p">[</span><span class="n">session_iters</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>

        <span class="n">sstart</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">ustart</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">finished</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">c</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">finished</span><span class="p">:</span>
            <span class="n">session_minlen</span> <span class="o">=</span> <span class="p">(</span><span class="n">session_end</span> <span class="o">-</span> <span class="n">session_start</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
            <span class="n">out_idx</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">ItemIdx</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">session_start</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">session_minlen</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">in_idx</span> <span class="o">=</span> <span class="n">out_idx</span>
                <span class="n">out_idx</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">ItemIdx</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">session_start</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_sample</span><span class="p">:</span>
                    <span class="n">sample</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">neg_sampler</span><span class="o">.</span><span class="n">next_sample</span><span class="p">()</span>
                    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">out_idx</span><span class="p">,</span> <span class="n">sample</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">y</span> <span class="o">=</span> <span class="n">out_idx</span>
                <span class="n">cost</span> <span class="o">=</span> <span class="n">fun</span><span class="p">(</span><span class="n">in_idx</span><span class="p">,</span> <span class="n">sstart</span><span class="p">,</span> <span class="n">ustart</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
                <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="c1"># reset sstart and ustart</span>
                <span class="n">sstart</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">sstart</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
                <span class="n">ustart</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">ustart</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
                <span class="n">c</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cost</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">cost</span><span class="p">):</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;NaN error!&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">error_during_train</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">return</span>
            <span class="n">session_start</span> <span class="o">=</span> <span class="n">session_start</span> <span class="o">+</span> <span class="n">session_minlen</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="n">session_start_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">session_iters</span><span class="p">))[(</span><span class="n">session_end</span> <span class="o">-</span> <span class="n">session_start</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">sstart</span><span class="p">[</span><span class="n">session_start_mask</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">session_start_mask</span><span class="p">:</span>
                <span class="n">session_iters</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">session_iters</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">offset_sessions</span><span class="p">):</span>
                    <span class="n">finished</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">break</span>
                <span class="n">session_start</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">offset_sessions</span><span class="p">[</span><span class="n">session_iters</span><span class="p">[</span><span class="n">idx</span><span class="p">]]</span>
                <span class="n">session_end</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">offset_sessions</span><span class="p">[</span><span class="n">session_iters</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>

            <span class="c1"># reset the User hidden state at user change</span>
            <span class="n">user_change_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">user_iters</span><span class="p">))[(</span><span class="n">user_end</span> <span class="o">-</span> <span class="n">session_start</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)]</span>
            <span class="n">ustart</span><span class="p">[</span><span class="n">user_change_mask</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">user_change_mask</span><span class="p">:</span>
                <span class="n">user_maxiter</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">user_maxiter</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">offset_users</span><span class="p">):</span>
                    <span class="n">finished</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">break</span>
                <span class="n">user_iters</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">user_maxiter</span>
                <span class="n">user_start</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">offset_users</span><span class="p">[</span><span class="n">user_maxiter</span><span class="p">]</span>
                <span class="n">user_end</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">offset_users</span><span class="p">[</span><span class="n">user_maxiter</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
                <span class="n">session_iters</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">user_indptr</span><span class="p">[</span><span class="n">user_maxiter</span><span class="p">]</span>
                <span class="n">session_start</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">offset_sessions</span><span class="p">[</span><span class="n">session_iters</span><span class="p">[</span><span class="n">idx</span><span class="p">]]</span>
                <span class="n">session_end</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">offset_sessions</span><span class="p">[</span><span class="n">session_iters</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">avgc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">avgc</span>

    <span class="k">def</span> <span class="nf">predict_next_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session_ids</span><span class="p">,</span> <span class="n">input_item_ids</span><span class="p">,</span> <span class="n">input_user_ids</span><span class="p">,</span>
                           <span class="n">predict_for_item_ids</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">batch</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Gives predicton scores for a selected set of items. Can be used in batch mode to predict for multiple independent events (i.e. events of different sessions) at once and thus speed up evaluation.</span>

<span class="sd">        If the session ID at a given coordinate of the session_ids parameter remains the same during subsequent calls of the function, the corresponding hidden state of the network will be kept intact (i.e. that&#39;s how one can predict an item to a session).</span>
<span class="sd">        If it changes, the hidden state of the network is reset to zeros.</span>

<span class="sd">        Parameters</span>
<span class="sd">        --------</span>
<span class="sd">        session_ids : 1D array</span>
<span class="sd">            Contains the session IDs of the events of the batch. Its length must equal to the prediction batch size (batch param).</span>
<span class="sd">        input_item_ids : 1D array</span>
<span class="sd">            Contains the item IDs of the events of the batch. Every item ID must be must be in the training data of the network. Its length must equal to the prediction batch size (batch param).</span>
<span class="sd">        input_user_ids : 1D array</span>
<span class="sd">            Contains the user IDs of the events of the batch. Every user ID must be must be in the training data of the network. Its length must equal to the prediction batch size (batch param).</span>
<span class="sd">        predict_for_item_ids : 1D array (optional)</span>
<span class="sd">            IDs of items for which the network should give prediction scores. Every ID must be in the training set. The default value is None, which means that the network gives prediction on its every output (i.e. for all items in the training set).</span>
<span class="sd">        batch : int</span>
<span class="sd">            Prediction batch size.</span>

<span class="sd">        Returns</span>
<span class="sd">        --------</span>
<span class="sd">        out : pandas.DataFrame</span>
<span class="sd">            Prediction scores for selected items for every event of the batch.</span>
<span class="sd">            Columns: events of the batch; rows: items. Rows are indexed by the item IDs.</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_during_train</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict_batch</span> <span class="o">!=</span> <span class="n">batch</span><span class="p">:</span>
            <span class="n">X</span><span class="p">,</span> <span class="n">Y</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">ivectors</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">Sstart</span><span class="p">,</span> <span class="n">Ustart</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">fvectors</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session_layers</span><span class="p">)):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Hs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">batch</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_layers</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">theano</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">floatX</span><span class="p">),</span> <span class="n">borrow</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_layers</span><span class="p">)):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Hu</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">batch</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_layers</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">theano</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">floatX</span><span class="p">),</span> <span class="n">borrow</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">predict_for_item_ids</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">Hs_new</span><span class="p">,</span> <span class="n">Hu_new</span><span class="p">,</span> <span class="n">yhat</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Sstart</span><span class="p">,</span> <span class="n">Ustart</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Hs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Hu</span><span class="p">,</span> <span class="n">Y</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">Hs_new</span><span class="p">,</span> <span class="n">Hu_new</span><span class="p">,</span> <span class="n">yhat</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Sstart</span><span class="p">,</span> <span class="n">Ustart</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Hs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Hu</span><span class="p">)</span>
            <span class="n">updatesH</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Hs</span><span class="p">)):</span>
                <span class="n">updatesH</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">Hs</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">Hs_new</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Hu</span><span class="p">)):</span>
                <span class="n">updatesH</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">Hu</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">Hu_new</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">predict_for_item_ids</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">predict</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="p">[</span><span class="n">X</span><span class="p">,</span> <span class="n">Sstart</span><span class="p">,</span> <span class="n">Ustart</span><span class="p">,</span> <span class="n">Y</span><span class="p">],</span> <span class="n">outputs</span><span class="o">=</span><span class="n">yhat</span><span class="p">,</span> <span class="n">updates</span><span class="o">=</span><span class="n">updatesH</span><span class="p">,</span>
                                        <span class="n">on_unused_input</span><span class="o">=</span><span class="s1">&#39;warn&#39;</span><span class="p">,</span> <span class="n">allow_input_downcast</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">predict</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="p">[</span><span class="n">X</span><span class="p">,</span> <span class="n">Sstart</span><span class="p">,</span> <span class="n">Ustart</span><span class="p">],</span> <span class="n">outputs</span><span class="o">=</span><span class="n">yhat</span><span class="p">,</span> <span class="n">updates</span><span class="o">=</span><span class="n">updatesH</span><span class="p">,</span>
                                        <span class="n">on_unused_input</span><span class="o">=</span><span class="s1">&#39;warn&#39;</span><span class="p">,</span> <span class="n">allow_input_downcast</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_session</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span> <span class="o">*</span> <span class="o">-</span><span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_users</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span> <span class="o">*</span> <span class="o">-</span><span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">predict_batch</span> <span class="o">=</span> <span class="n">batch</span>

        <span class="n">session_change</span> <span class="o">=</span> <span class="n">session_ids</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_session</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_session</span> <span class="o">=</span> <span class="n">session_ids</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">user_change</span> <span class="o">=</span> <span class="n">input_user_ids</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_users</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_users</span> <span class="o">=</span> <span class="n">input_user_ids</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">in_idxs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">itemidmap</span><span class="p">[</span><span class="n">input_item_ids</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">predict_for_item_ids</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">iIdxs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">itemidmap</span><span class="p">[</span><span class="n">predict_for_item_ids</span><span class="p">]</span>
            <span class="n">preds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">in_idxs</span><span class="p">,</span> <span class="n">session_change</span><span class="p">,</span> <span class="n">user_change</span><span class="p">,</span> <span class="n">iIdxs</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">preds</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">predict_for_item_ids</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">preds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">in_idxs</span><span class="p">,</span> <span class="n">session_change</span><span class="p">,</span> <span class="n">user_change</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">preds</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">itemidmap</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">RNNRecommender</span><span class="p">(</span><span class="n">ISeqRecommender</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A **simplified** interface to Recurrent Neural Network models for Session-based recommendation.</span>
<span class="sd">    Based on the following two papers:</span>

<span class="sd">    * Recurrent Neural Networks with Top-k Gains for Session-based Recommendations, Hidasi and Karatzoglou, CIKM 2018</span>
<span class="sd">    * Personalizing Session-based Recommendation with Hierarchical Recurrent Neural Networks, Quadrana et al, Recsys 2017</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">session_layers</span><span class="p">,</span>
                 <span class="n">user_layers</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span>
                 <span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
                 <span class="n">momentum</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
                 <span class="n">dropout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">epochs</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                 <span class="n">personalized</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param session_layers: number of units per layer used at session level.</span>
<span class="sd">            It has to be a list of integers for multi-layer networks, or a integer value for single-layer networks.</span>
<span class="sd">        :param user_layers: number of units per layer used at user level. Required only by personalized models.</span>
<span class="sd">            It has to be a list of integers for multi-layer networks, or a integer value for single-layer networks.</span>
<span class="sd">        :param batch_size: the mini-batch size used in training</span>
<span class="sd">        :param learning_rate: the learning rate used in training (Adagrad optimized)</span>
<span class="sd">        :param momentum: the momentum coefficient used in training</span>
<span class="sd">        :param dropout: dropout coefficients.</span>
<span class="sd">            If personalized=False, it&#39;s a float value for the hidden-layer(s) dropout.</span>
<span class="sd">            If personalized=True, it&#39;s a 3-tuple with the values for the dropout of (user hidden, session hidden, user-to-session hidden) layers.</span>
<span class="sd">        :param epochs: number of training epochs</span>
<span class="sd">        :param personalized: whether to train a personalized model using the HRNN model.</span>
<span class="sd">            It will require user ids at prediction time.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">RNNRecommender</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">session_layers</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">session_layers</span> <span class="o">=</span> <span class="p">[</span><span class="n">session_layers</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">user_layers</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">user_layers</span> <span class="o">=</span> <span class="p">[</span><span class="n">user_layers</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session_layers</span> <span class="o">=</span> <span class="n">session_layers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_layers</span> <span class="o">=</span> <span class="n">user_layers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="n">batch_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">learning_rate</span> <span class="o">=</span> <span class="n">learning_rate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">momentum</span> <span class="o">=</span> <span class="n">momentum</span>
        <span class="k">if</span> <span class="n">dropout</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">personalized</span><span class="p">:</span>
                <span class="n">dropout</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dropout</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span> <span class="o">=</span> <span class="n">dropout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epochs</span> <span class="o">=</span> <span class="n">epochs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">personalized</span> <span class="o">=</span> <span class="n">personalized</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pseudo_session_id</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;RNNRecommender(&#39;</span> \
               <span class="s1">&#39;session_layers=</span><span class="si">{session_layers}</span><span class="s1">, &#39;</span> \
               <span class="s1">&#39;user_layers=</span><span class="si">{user_layers}</span><span class="s1">, &#39;</span> \
               <span class="s1">&#39;batch_size=</span><span class="si">{batch_size}</span><span class="s1">, &#39;</span> \
               <span class="s1">&#39;learning_rate=</span><span class="si">{learning_rate}</span><span class="s1">, &#39;</span> \
               <span class="s1">&#39;momentum=</span><span class="si">{momentum}</span><span class="s1">, &#39;</span> \
               <span class="s1">&#39;dropout=</span><span class="si">{dropout}</span><span class="s1">, &#39;</span> \
               <span class="s1">&#39;epochs=</span><span class="si">{epochs}</span><span class="s1">, &#39;</span> \
               <span class="s1">&#39;personalized=</span><span class="si">{personalized}</span><span class="s1">, &#39;</span> \
               <span class="s1">&#39;)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">train_data</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Converting training data to GRU4Rec format&#39;</span><span class="p">)</span>
        <span class="c1"># parse training data to GRU4Rec format</span>
        <span class="n">train_data</span> <span class="o">=</span> <span class="n">dataset_to_gru4rec_format</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="n">train_data</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">personalized</span><span class="p">:</span>
            <span class="c1"># fit GRU4Rec</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">GRU4Rec</span><span class="p">(</span><span class="n">layers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">session_layers</span><span class="p">,</span>
                                 <span class="n">n_epochs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">epochs</span><span class="p">,</span>
                                 <span class="n">batch_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span>
                                 <span class="n">learning_rate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">learning_rate</span><span class="p">,</span>
                                 <span class="n">momentum</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">momentum</span><span class="p">,</span>
                                 <span class="n">dropout_p_hidden</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dropout</span><span class="p">,</span>
                                 <span class="n">session_key</span><span class="o">=</span><span class="s1">&#39;session_id&#39;</span><span class="p">,</span>
                                 <span class="n">item_key</span><span class="o">=</span><span class="s1">&#39;item_id&#39;</span><span class="p">,</span>
                                 <span class="n">time_key</span><span class="o">=</span><span class="s1">&#39;ts&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_layers</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;You should set the value of user_layers before training the personalized model.&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dropout</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;dropout should be a 3 tuple with &#39;</span>
                                 <span class="s1">&#39;(user hidden, session hidden, user-to-session hidden) dropout values.&#39;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">HGRU4Rec</span><span class="p">(</span><span class="n">session_layers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">session_layers</span><span class="p">,</span>
                                  <span class="n">user_layers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">user_layers</span><span class="p">,</span>
                                  <span class="n">batch_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span>
                                  <span class="n">n_epochs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">epochs</span><span class="p">,</span>
                                  <span class="n">learning_rate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">learning_rate</span><span class="p">,</span>
                                  <span class="n">momentum</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">momentum</span><span class="p">,</span>
                                  <span class="n">dropout_p_hidden_usr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dropout</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                  <span class="n">dropout_p_hidden_ses</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dropout</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                  <span class="n">dropout_p_init</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dropout</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                                  <span class="n">session_key</span><span class="o">=</span><span class="s1">&#39;session_id&#39;</span><span class="p">,</span>
                                  <span class="n">user_key</span><span class="o">=</span><span class="s1">&#39;user_id&#39;</span><span class="p">,</span>
                                  <span class="n">item_key</span><span class="o">=</span><span class="s1">&#39;item_id&#39;</span><span class="p">,</span>
                                  <span class="n">time_key</span><span class="o">=</span><span class="s1">&#39;ts&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Training started&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Training completed&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">recommend</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_profile</span><span class="p">,</span> <span class="n">user_id</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">personalized</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">user_profile</span><span class="p">:</span>
                <span class="n">pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict_next_batch</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">pseudo_session_id</span><span class="p">]),</span>
                                                     <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">item</span><span class="p">]),</span>
                                                     <span class="n">batch</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">user_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;user_id required by personalized models&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">user_profile</span><span class="p">:</span>
                <span class="n">pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict_next_batch</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">pseudo_session_id</span><span class="p">]),</span>
                                                     <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">item</span><span class="p">]),</span>
                                                     <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">user_id</span><span class="p">]),</span>
                                                     <span class="n">batch</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># sort items by predicted score</span>
        <span class="n">pred</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># increase the psuedo-session id so that future call to recommend() won&#39;t be connected</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pseudo_session_id</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="c1"># convert to the required output format</span>
        <span class="k">return</span> <span class="p">[([</span><span class="n">x</span><span class="o">.</span><span class="n">index</span><span class="p">],</span> <span class="n">x</span><span class="o">.</span><span class="n">_2</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">pred</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">itertuples</span><span class="p">()]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">rnnrecommender</span> <span class="o">=</span> <span class="n">RNNRecommender</span><span class="p">(</span><span class="n">session_layers</span><span class="o">=</span><span class="p">[</span><span class="mi">20</span><span class="p">],</span> 
                             <span class="n">batch_size</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span>
                             <span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
                             <span class="n">momentum</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
                             <span class="n">dropout</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
                             <span class="n">epochs</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                             <span class="n">personalized</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">rnnrecommender</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_data</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2021-04-25 14:00:57,953 - INFO - Converting training data to GRU4Rec format
2021-04-25 14:00:57,980 - INFO - Training started
WARNING (theano.tensor.blas): We did not find a dynamic library in the library_dir of the library we use for blas. If you use ATLAS, make sure to compile it with dynamics library.
2021-04-25 14:01:11,615 - WARNING - We did not find a dynamic library in the library_dir of the library we use for blas. If you use ATLAS, make sure to compile it with dynamics library.
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch0	loss: 0.627941
Epoch1	loss: 0.533681
Epoch2	loss: 0.505859
Epoch3	loss: 0.491371
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2021-04-25 14:02:15,525 - INFO - Training completed
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch4	loss: 0.483965
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="personalized-rnn">
<h3>Personalized RNN<a class="headerlink" href="#personalized-rnn" title="Permalink to this headline">¶</a></h3>
<p>Here we fit the recommedation algorithm over the sessions in the training set.</p>
<p>This is a <strong>simplified</strong> interface to Recurrent Neural Network models for Session-based recommendation.
Based on the following two papers:</p>
<ul class="simple">
<li><p>Recurrent Neural Networks with Top-k Gains for Session-based Recommendations, Hidasi and Karatzoglou, CIKM 2018</p></li>
<li><p>Personalizing Session-based Recommendation with Hierarchical Recurrent Neural Networks, Quadrana et al, Recsys 2017</p></li>
</ul>
<p>In this notebook, we will consider the session-aware (<strong>personalized</strong>) version of the algorithm.
Here’s a schematic representation of the model:</p>
<img src='https://www.notion.so/image/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2Fb0715490-8128-45cf-b98e-8c5e557e8076%2FUntitled.png?table=block&id=e75f1410-aacc-4984-87f3-d042400d725a&spaceId=63b72b1f-0e90-4ab8-a6df-a060a6545a56&width=2000&userId=21ec183f-f0be-4b6b-9b3e-6f0d4e5c5469&cache=v2'>
<p>Each user session goes through a <em>session</em> RNN, which models <strong>short-term</strong> user preferences. At the end of each session, the state of the <em>session</em> RNN is used to update a <em>user</em> RNN, which models more <strong>long-term</strong> user preferences. It’s state is passed forward to the next <em>session</em> RNN, which can now personalize recommendations depending on both short-term and long-term user interests.</p>
<p>The hyper-parameters of the model are:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">session_layers</span></code>: number of units per layer used at session level.
It has to be a list of integers for multi-layer networks, or a integer value for single-layer networks.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">user_layers</span></code>: number of units per layer used at user level. Required only by personalized models.
It has to be a list of integers for multi-layer networks, or a integer value for single-layer networks.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">batch_size</span></code>: the mini-batch size used in training</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">learning_rate</span></code>: the learning rate used in training (Adagrad optimized)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">momentum</span></code>: the momentum coefficient used in training</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">dropout</span></code>: it’s a 3-tuple with the values for the dropout of (user hidden, session hidden, user-to-session hidden) layers.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">epochs</span></code>: number of training epochs</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">personalized</span></code>: whether to train a personalized model using the HRNN model (<code class="docutils literal notranslate"><span class="pre">True</span></code> in this case).</p></li>
</ul>
<p><strong>NOTE: HGRU4Rec originally has more hyper-parameters. Going through all of them is out from the scope of this tutorial, but we suggest to check-out the original source code <a class="reference external" href="https://github.com/mquad/hgru4rec">here</a> in case you are interested.</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">prnnrecommender</span> <span class="o">=</span> <span class="n">RNNRecommender</span><span class="p">(</span><span class="n">session_layers</span><span class="o">=</span><span class="p">[</span><span class="mi">20</span><span class="p">],</span> 
                             <span class="n">user_layers</span><span class="o">=</span><span class="p">[</span><span class="mi">20</span><span class="p">],</span>
                             <span class="n">batch_size</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span>
                             <span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                             <span class="n">momentum</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
                             <span class="n">dropout</span><span class="o">=</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span><span class="mf">0.1</span><span class="p">,</span><span class="mf">0.1</span><span class="p">),</span>
                             <span class="n">epochs</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                             <span class="n">personalized</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">prnnrecommender</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_data</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2021-04-25 14:02:15,598 - INFO - Converting training data to GRU4Rec format
2021-04-25 14:02:15,633 - INFO - Training started
2021-04-25 14:02:51,671 - INFO - Epoch 0 - train cost: 1.0400
2021-04-25 14:02:52,260 - INFO - Epoch 1 - train cost: 0.9588
2021-04-25 14:02:52,854 - INFO - Epoch 2 - train cost: 0.9023
2021-04-25 14:02:53,433 - INFO - Epoch 3 - train cost: 0.8703
2021-04-25 14:02:54,036 - INFO - Epoch 4 - train cost: 0.8492
2021-04-25 14:02:54,039 - INFO - Training completed
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="knn-recommender">
<h3>KNN recommender<a class="headerlink" href="#knn-recommender" title="Permalink to this headline">¶</a></h3>
<p>The class <code class="docutils literal notranslate"><span class="pre">KNNRecommender</span></code> takes the following initialization hyper-parameters:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">model</span></code>: One among the following KNN models:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">iknn</span></code>: ItemKNN, item-to-item KNN based on the <em>last</em> item in the session to determine the items to be recommended.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">sknn</span></code>: SessionKNN, compares the <em>entire</em> current session with the past sessions in the training data to determine the items to be recommended.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">v-sknn</span></code>: VMSessionKNN, use linearly decayed real-valued vectors to encode the current session, then compares the current session with the past sessions in the training data using the dot-product to determine the items to be recommended.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">s-sknn</span></code>: SeqSessionKNN, this variant also puts more weight on elements that appear later in the session by using a custom scoring function (see the paper by Ludewng and Jannach).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">sf-sknn</span></code>: SeqFilterSessionKNN, this variant also puts more weight on elements that appear later in the session in a more restrictive way by using a custom scoring function (see the paper by Ludewng and Jannach).</p></li>
</ul>
</li>
<li><p>param <code class="docutils literal notranslate"><span class="pre">init_args</span></code>: The model initialization arguments. See the following initializations or check <code class="docutils literal notranslate"><span class="pre">util.knn</span></code> for more details on each model:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">iknn</span></code>: ItemKNN(n_sims=100, lmbd=20, alpha=0.5)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">sknn</span></code>: SessionKNN(k, sample_size=500, sampling=’recent’, similarity=’jaccard’, remind=False, pop_boost=0)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">v-sknn</span></code>: VMSessionKNN(k, sample_size=1000, sampling=’recent’, similarity=’cosine’, weighting=’div’,
dwelling_time=False, last_n_days=None, last_n_clicks=None, extend=False, weighting_score=’div_score’,
weighting_time=False, normalize=True)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">s-knn</span></code>: SeqSessionKNN(k, sample_size=1000, sampling=’recent’, similarity=’jaccard’, weighting=’div’,
remind=False, pop_boost=0, extend=False, normalize=True)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">sf-sknn</span></code>: SeqFilterSessionKNN(k, sample_size=1000, sampling=’recent’, similarity=’jaccard’, remind=False, pop_boost=0,extend=False, normalize=True)</p></li>
</ul>
</li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">ItemKNN</span><span class="p">:</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    ItemKNN(n_sims = 100, lmbd = 20, alpha = 0.5, session_key = &#39;SessionId&#39;, item_key = &#39;ItemId&#39;, time_key = &#39;Time&#39;)</span>
<span class="sd">    </span>
<span class="sd">    Item-to-item predictor that computes the the similarity to all items to the given item.</span>
<span class="sd">    </span>
<span class="sd">    Similarity of two items is given by:</span>
<span class="sd">    </span>
<span class="sd">    .. math::</span>
<span class="sd">        s_{i,j}=\sum_{s}I\{(s,i)\in D &amp; (s,j)\in D\} / (supp_i+\\lambda)^{\\alpha}(supp_j+\\lambda)^{1-\\alpha}</span>
<span class="sd">        </span>
<span class="sd">    Parameters</span>
<span class="sd">    --------</span>
<span class="sd">    n_sims : int</span>
<span class="sd">        Only give back non-zero scores to the N most similar items. Should be higher or equal than the cut-off of your evaluation. (Default value: 100)</span>
<span class="sd">    lmbd : float</span>
<span class="sd">        Regularization. Discounts the similarity of rare items (incidental co-occurrences). (Default value: 20)</span>
<span class="sd">    alpha : float</span>
<span class="sd">        Balance between normalizing with the supports of the two items. 0.5 gives cosine similarity, 1.0 gives confidence (as in association rules).</span>
<span class="sd">    session_key : string</span>
<span class="sd">        header of the session ID column in the input file (default: &#39;SessionId&#39;)</span>
<span class="sd">    item_key : string</span>
<span class="sd">        header of the item ID column in the input file (default: &#39;ItemId&#39;)</span>
<span class="sd">    time_key : string</span>
<span class="sd">        header of the timestamp column in the input file (default: &#39;Time&#39;)</span>
<span class="sd">    </span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_sims</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">lmbd</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">session_key</span><span class="o">=</span><span class="s1">&#39;SessionId&#39;</span><span class="p">,</span> <span class="n">item_key</span><span class="o">=</span><span class="s1">&#39;ItemId&#39;</span><span class="p">,</span> <span class="n">time_key</span><span class="o">=</span><span class="s1">&#39;Time&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_sims</span> <span class="o">=</span> <span class="n">n_sims</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lmbd</span> <span class="o">=</span> <span class="n">lmbd</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="n">alpha</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">item_key</span> <span class="o">=</span> <span class="n">item_key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session_key</span> <span class="o">=</span> <span class="n">session_key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time_key</span> <span class="o">=</span> <span class="n">time_key</span>

    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Trains the predictor.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        --------</span>
<span class="sd">        data: pandas.DataFrame</span>
<span class="sd">            Training data. It contains the transactions of the sessions. It has one column for session IDs, one for item IDs and one for the timestamp of the events (unix timestamps).</span>
<span class="sd">            It must have a header. Column names are arbitrary, but must correspond to the ones you set during the initialization of the network (session_key, item_key, time_key properties).</span>
<span class="sd">            </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">data</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)),</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">itemids</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">item_key</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
        <span class="n">n_items</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">itemids</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="bp">self</span><span class="o">.</span><span class="n">item_key</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">itemids</span><span class="p">,</span> <span class="s1">&#39;ItemIdx&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">itemids</span><span class="p">))}),</span>
                        <span class="n">on</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">item_key</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">)</span>
        <span class="n">sessionids</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">session_key</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="bp">self</span><span class="o">.</span><span class="n">session_key</span><span class="p">:</span> <span class="n">sessionids</span><span class="p">,</span> <span class="s1">&#39;SessionIdx&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sessionids</span><span class="p">))}),</span>
                        <span class="n">on</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">session_key</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">)</span>
        <span class="n">supp</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;SessionIdx&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>
        <span class="n">session_offsets</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">supp</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
        <span class="n">session_offsets</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">supp</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>
        <span class="n">index_by_sessions</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s1">&#39;SessionIdx&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_key</span><span class="p">])</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span>
        <span class="n">supp</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;ItemIdx&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>
        <span class="n">item_offsets</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_items</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
        <span class="n">item_offsets</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">supp</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>
        <span class="n">index_by_items</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s1">&#39;ItemIdx&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_key</span><span class="p">])</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sims</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_items</span><span class="p">):</span>
            <span class="n">iarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_items</span><span class="p">)</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">item_offsets</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">end</span> <span class="o">=</span> <span class="n">item_offsets</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">index_by_items</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">]:</span>
                <span class="n">uidx</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">SessionIdx</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">e</span><span class="p">]</span>
                <span class="n">ustart</span> <span class="o">=</span> <span class="n">session_offsets</span><span class="p">[</span><span class="n">uidx</span><span class="p">]</span>
                <span class="n">uend</span> <span class="o">=</span> <span class="n">session_offsets</span><span class="p">[</span><span class="n">uidx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
                <span class="n">user_events</span> <span class="o">=</span> <span class="n">index_by_sessions</span><span class="p">[</span><span class="n">ustart</span><span class="p">:</span><span class="n">uend</span><span class="p">]</span>
                <span class="n">iarray</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">ItemIdx</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">user_events</span><span class="p">]]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">iarray</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">((</span><span class="n">supp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">lmbd</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">((</span><span class="n">supp</span><span class="o">.</span><span class="n">values</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">lmbd</span><span class="p">),</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">))</span>
            <span class="n">norm</span><span class="p">[</span><span class="n">norm</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">iarray</span> <span class="o">=</span> <span class="n">iarray</span> <span class="o">/</span> <span class="n">norm</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">iarray</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_sims</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sims</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">itemids</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">iarray</span><span class="p">[</span><span class="n">indices</span><span class="p">],</span> <span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">itemids</span><span class="p">[</span><span class="n">indices</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">predict_next</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session_id</span><span class="p">,</span> <span class="n">input_item_id</span><span class="p">,</span> <span class="n">predict_for_item_ids</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">skip</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;view&#39;</span><span class="p">,</span> <span class="n">timestamp</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Gives predicton scores for a selected set of items on how likely they be the next item in the session.</span>
<span class="sd">                </span>
<span class="sd">        Parameters</span>
<span class="sd">        --------</span>
<span class="sd">        session_id : int or string</span>
<span class="sd">            The session IDs of the event.</span>
<span class="sd">        input_item_id : int or string</span>
<span class="sd">            The item ID of the event. Must be in the set of item IDs of the training set.</span>
<span class="sd">        predict_for_item_ids : 1D array</span>
<span class="sd">            IDs of items for which the network should give prediction scores. Every ID must be in the set of item IDs of the training set.</span>
<span class="sd">            </span>
<span class="sd">        Returns</span>
<span class="sd">        --------</span>
<span class="sd">        out : pandas.Series</span>
<span class="sd">            Prediction scores for selected items on how likely to be the next item of this session. Indexed by the item IDs.</span>
<span class="sd">        </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">predict_for_item_ids</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">predict_for_item_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">itemids</span>
        <span class="n">preds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">predict_for_item_ids</span><span class="p">))</span>
        <span class="n">sim_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sims</span><span class="p">[</span><span class="n">input_item_id</span><span class="p">]</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">in1d</span><span class="p">(</span><span class="n">predict_for_item_ids</span><span class="p">,</span> <span class="n">sim_list</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="n">preds</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">sim_list</span><span class="p">[</span><span class="n">predict_for_item_ids</span><span class="p">[</span><span class="n">mask</span><span class="p">]]</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">preds</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">predict_for_item_ids</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">_operator</span> <span class="kn">import</span> <span class="n">itemgetter</span>
<span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">sqrt</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">log10</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span> <span class="k">as</span> <span class="n">dt</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">timedelta</span> <span class="k">as</span> <span class="n">td</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SeqFilterSessionKNN</span><span class="p">:</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    SessionKNN( k, sample_size=500, sampling=&#39;recent&#39;,  similarity = &#39;jaccard&#39;, remind=False, pop_boost=0, session_key = &#39;SessionId&#39;, item_key= &#39;ItemId&#39;)</span>

<span class="sd">    Parameters</span>
<span class="sd">    -----------</span>
<span class="sd">    k : int</span>
<span class="sd">        Number of neighboring session to calculate the item scores from. (Default value: 100)</span>
<span class="sd">    sample_size : int</span>
<span class="sd">        Defines the length of a subset of all training sessions to calculate the nearest neighbors from. (Default value: 500)</span>
<span class="sd">    sampling : string</span>
<span class="sd">        String to define the sampling method for sessions (recent, random). (default: recent)</span>
<span class="sd">    similarity : string</span>
<span class="sd">        String to define the method for the similarity calculation (jaccard, cosine, binary, tanimoto). (default: jaccard)</span>
<span class="sd">    remind : bool</span>
<span class="sd">        Should the last items of the current session be boosted to the top as reminders</span>
<span class="sd">    pop_boost : int</span>
<span class="sd">        Push popular items in the neighbor sessions by this factor. (default: 0 to leave out)</span>
<span class="sd">    extend : bool</span>
<span class="sd">        Add evaluated sessions to the maps</span>
<span class="sd">    normalize : bool</span>
<span class="sd">        Normalize the scores in the end</span>
<span class="sd">    session_key : string</span>
<span class="sd">        Header of the session ID column in the input file. (default: &#39;SessionId&#39;)</span>
<span class="sd">    item_key : string</span>
<span class="sd">        Header of the item ID column in the input file. (default: &#39;ItemId&#39;)</span>
<span class="sd">    time_key : string</span>
<span class="sd">        Header of the timestamp column in the input file. (default: &#39;Time&#39;)</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">sample_size</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">sampling</span><span class="o">=</span><span class="s1">&#39;recent&#39;</span><span class="p">,</span> <span class="n">similarity</span><span class="o">=</span><span class="s1">&#39;jaccard&#39;</span><span class="p">,</span> <span class="n">remind</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">pop_boost</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                 <span class="n">extend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">session_key</span><span class="o">=</span><span class="s1">&#39;SessionId&#39;</span><span class="p">,</span> <span class="n">item_key</span><span class="o">=</span><span class="s1">&#39;ItemId&#39;</span><span class="p">,</span> <span class="n">time_key</span><span class="o">=</span><span class="s1">&#39;Time&#39;</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">remind</span> <span class="o">=</span> <span class="n">remind</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k</span> <span class="o">=</span> <span class="n">k</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sample_size</span> <span class="o">=</span> <span class="n">sample_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sampling</span> <span class="o">=</span> <span class="n">sampling</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">similarity</span> <span class="o">=</span> <span class="n">similarity</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pop_boost</span> <span class="o">=</span> <span class="n">pop_boost</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session_key</span> <span class="o">=</span> <span class="n">session_key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">item_key</span> <span class="o">=</span> <span class="n">item_key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time_key</span> <span class="o">=</span> <span class="n">time_key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extend</span> <span class="o">=</span> <span class="n">extend</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">normalize</span> <span class="o">=</span> <span class="n">normalize</span>

        <span class="c1"># updated while recommending</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session_items</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">relevant_sessions</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="c1"># cache relations once at startup</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session_item_map</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">item_session_map</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session_time</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">followed_by</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sim_time</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">train</span><span class="p">,</span> <span class="n">items</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Trains the predictor.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        --------</span>
<span class="sd">        data: pandas.DataFrame</span>
<span class="sd">            Training data. It contains the transactions of the sessions. It has one column for session IDs, one for item IDs and one for the timestamp of the events (unix timestamps).</span>
<span class="sd">            It must have a header. Column names are arbitrary, but must correspond to the ones you set during the initialization of the network (session_key, item_key, time_key properties).</span>
<span class="sd">            </span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">index_session</span> <span class="o">=</span> <span class="n">train</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session_key</span><span class="p">)</span>
        <span class="n">index_item</span> <span class="o">=</span> <span class="n">train</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">item_key</span><span class="p">)</span>
        <span class="n">index_time</span> <span class="o">=</span> <span class="n">train</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time_key</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">itemids</span> <span class="o">=</span> <span class="n">train</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">item_key</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>

        <span class="n">session</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">session_items</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">last_item</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">time</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="c1"># cnt = 0</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">train</span><span class="o">.</span><span class="n">itertuples</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
            <span class="c1"># cache items of sessions</span>
            <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="n">index_session</span><span class="p">]</span> <span class="o">!=</span> <span class="n">session</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">session_items</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">session_item_map</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">session</span><span class="p">:</span> <span class="n">session_items</span><span class="p">})</span>
                    <span class="c1"># cache the last time stamp of the session</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">session_time</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">session</span><span class="p">:</span> <span class="n">time</span><span class="p">})</span>
                <span class="n">session</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">index_session</span><span class="p">]</span>
                <span class="n">session_items</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">last_item</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>  <span class="c1"># fill followed by map for filtering of candidate items</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">last_item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">followed_by</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">followed_by</span><span class="p">[</span><span class="n">last_item</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">followed_by</span><span class="p">[</span><span class="n">last_item</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">index_item</span><span class="p">])</span>

            <span class="n">time</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">index_time</span><span class="p">]</span>
            <span class="n">session_items</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">index_item</span><span class="p">])</span>

            <span class="c1"># cache sessions involving an item</span>
            <span class="n">map_is</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_session_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">index_item</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">map_is</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">map_is</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">item_session_map</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">row</span><span class="p">[</span><span class="n">index_item</span><span class="p">]:</span> <span class="n">map_is</span><span class="p">})</span>
            <span class="n">map_is</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">index_session</span><span class="p">])</span>

            <span class="n">last_item</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">index_item</span><span class="p">]</span>

        <span class="c1"># Add the last tuple    </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session_item_map</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">session</span><span class="p">:</span> <span class="n">session_items</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session_time</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">session</span><span class="p">:</span> <span class="n">time</span><span class="p">})</span>

    <span class="k">def</span> <span class="nf">predict_next</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session_id</span><span class="p">,</span> <span class="n">input_item_id</span><span class="p">,</span> <span class="n">predict_for_item_ids</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">skip</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;view&#39;</span><span class="p">,</span> <span class="n">timestamp</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Gives predicton scores for a selected set of items on how likely they be the next item in the session.</span>
<span class="sd">                </span>
<span class="sd">        Parameters</span>
<span class="sd">        --------</span>
<span class="sd">        session_id : int or string</span>
<span class="sd">            The session IDs of the event.</span>
<span class="sd">        input_item_id : int or string</span>
<span class="sd">            The item ID of the event. Must be in the set of item IDs of the training set.</span>
<span class="sd">        predict_for_item_ids : 1D array</span>
<span class="sd">            IDs of items for which the network should give prediction scores. Every ID must be in the set of item IDs of the training set.</span>
<span class="sd">            </span>
<span class="sd">        Returns</span>
<span class="sd">        --------</span>
<span class="sd">        out : pandas.Series</span>
<span class="sd">            Prediction scores for selected items on how likely to be the next item of this session. Indexed by the item IDs.</span>
<span class="sd">        </span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="c1">#         gc.collect()</span>
        <span class="c1">#         process = psutil.Process(os.getpid())</span>
        <span class="c1">#         print( &#39;cknn.predict_next: &#39;, process.memory_info().rss, &#39; memory used&#39;)</span>

        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">!=</span> <span class="n">session_id</span><span class="p">):</span>  <span class="c1"># new session</span>

            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">extend</span><span class="p">):</span>
                <span class="n">item_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session_items</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">session_item_map</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">]</span> <span class="o">=</span> <span class="n">item_set</span><span class="p">;</span>
                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">item_set</span><span class="p">:</span>
                    <span class="n">map_is</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_session_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">map_is</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">map_is</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">item_session_map</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">item</span><span class="p">:</span> <span class="n">map_is</span><span class="p">})</span>
                    <span class="n">map_is</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">)</span>

                <span class="n">ts</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">session_time</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">:</span> <span class="n">ts</span><span class="p">})</span>

                <span class="n">last_item</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_items</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">last_item</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">last_item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">followed_by</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">followed_by</span><span class="p">[</span><span class="n">last_item</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">followed_by</span><span class="p">[</span><span class="n">last_item</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                    <span class="n">last_item</span> <span class="o">=</span> <span class="n">item</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">session_id</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">session_items</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">relevant_sessions</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;view&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">session_items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">input_item_id</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">skip</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">neighbors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_neighbors</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session_items</span><span class="p">),</span> <span class="n">input_item_id</span><span class="p">,</span> <span class="n">session_id</span><span class="p">)</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">score_items</span><span class="p">(</span><span class="n">neighbors</span><span class="p">,</span> <span class="n">input_item_id</span><span class="p">)</span>

        <span class="c1"># add some reminders</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">remind</span><span class="p">:</span>

            <span class="n">reminderScore</span> <span class="o">=</span> <span class="mi">5</span>
            <span class="n">takeLastN</span> <span class="o">=</span> <span class="mi">3</span>

            <span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_items</span><span class="p">[</span><span class="o">-</span><span class="n">takeLastN</span><span class="p">:]:</span>
                <span class="n">cnt</span> <span class="o">=</span> <span class="n">cnt</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="c1"># reminderScore = reminderScore + (cnt/100)</span>

                <span class="n">oldScore</span> <span class="o">=</span> <span class="n">scores</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span>
                <span class="n">newScore</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="n">oldScore</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">newScore</span> <span class="o">=</span> <span class="n">reminderScore</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">newScore</span> <span class="o">=</span> <span class="n">oldScore</span> <span class="o">+</span> <span class="n">reminderScore</span>
                <span class="c1"># print &#39;old score &#39;, oldScore</span>
                <span class="c1"># update the score and add a small number for the position </span>
                <span class="n">newScore</span> <span class="o">=</span> <span class="p">(</span><span class="n">newScore</span> <span class="o">*</span> <span class="n">reminderScore</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>

                <span class="n">scores</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">elem</span><span class="p">:</span> <span class="n">newScore</span><span class="p">})</span>

        <span class="c1"># push popular ones</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pop_boost</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>

            <span class="n">pop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_pop</span><span class="p">(</span><span class="n">neighbors</span><span class="p">)</span>
            <span class="c1"># Iterate over the item neighbors</span>
            <span class="c1"># print itemScores</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">scores</span><span class="p">:</span>
                <span class="n">item_pop</span> <span class="o">=</span> <span class="n">pop</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="c1"># Gives some minimal MRR boost?</span>
                <span class="n">scores</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">key</span><span class="p">:</span> <span class="p">(</span><span class="n">scores</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pop_boost</span> <span class="o">*</span> <span class="n">item_pop</span><span class="p">))})</span>

        <span class="c1"># Create things in the format ..</span>
        <span class="k">if</span> <span class="n">predict_for_item_ids</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">predict_for_item_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">itemids</span>
        <span class="n">predictions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">predict_for_item_ids</span><span class="p">))</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">in1d</span><span class="p">(</span><span class="n">predict_for_item_ids</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">scores</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>

        <span class="n">items</span> <span class="o">=</span> <span class="n">predict_for_item_ids</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
        <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="n">scores</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">items</span><span class="p">]</span>
        <span class="n">predictions</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">values</span>
        <span class="n">series</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">predictions</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">predict_for_item_ids</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalize</span><span class="p">:</span>
            <span class="n">series</span> <span class="o">=</span> <span class="n">series</span> <span class="o">/</span> <span class="n">series</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">series</span>

    <span class="k">def</span> <span class="nf">item_pop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sessions</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Returns a dict(item,score) of the item popularity for the given list of sessions (only a set of ids)</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        --------</span>
<span class="sd">        sessions: set</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        --------</span>
<span class="sd">        out : dict            </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">max_pop</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">session</span><span class="p">,</span> <span class="n">weight</span> <span class="ow">in</span> <span class="n">sessions</span><span class="p">:</span>
            <span class="n">items</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">items_for_session</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>

                <span class="n">count</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">count</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">item</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">item</span><span class="p">:</span> <span class="n">count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">})</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_pop</span><span class="p">):</span>
                    <span class="n">max_pop</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">key</span><span class="p">:</span> <span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">/</span> <span class="n">max_pop</span><span class="p">)})</span>

        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">jaccard</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">first</span><span class="p">,</span> <span class="n">second</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Calculates the jaccard index for two sessions</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        --------</span>
<span class="sd">        first: Id of a session</span>
<span class="sd">        second: Id of a session</span>
<span class="sd">        </span>
<span class="sd">        Returns </span>
<span class="sd">        --------</span>
<span class="sd">        out : float value           </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">sc</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">clock</span><span class="p">()</span>
        <span class="n">intersection</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">first</span> <span class="o">&amp;</span> <span class="n">second</span><span class="p">)</span>
        <span class="n">union</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">first</span> <span class="o">|</span> <span class="n">second</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">intersection</span> <span class="o">/</span> <span class="n">union</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sim_time</span> <span class="o">+=</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">clock</span><span class="p">()</span> <span class="o">-</span> <span class="n">sc</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">res</span>

    <span class="k">def</span> <span class="nf">cosine</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">first</span><span class="p">,</span> <span class="n">second</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Calculates the cosine similarity for two sessions</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        --------</span>
<span class="sd">        first: Id of a session</span>
<span class="sd">        second: Id of a session</span>
<span class="sd">        </span>
<span class="sd">        Returns </span>
<span class="sd">        --------</span>
<span class="sd">        out : float value           </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">li</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">first</span> <span class="o">&amp;</span> <span class="n">second</span><span class="p">)</span>
        <span class="n">la</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">first</span><span class="p">)</span>
        <span class="n">lb</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">second</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">li</span> <span class="o">/</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">la</span><span class="p">)</span> <span class="o">*</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">lb</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">tanimoto</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">first</span><span class="p">,</span> <span class="n">second</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Calculates the cosine tanimoto similarity for two sessions</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        --------</span>
<span class="sd">        first: Id of a session</span>
<span class="sd">        second: Id of a session</span>
<span class="sd">        </span>
<span class="sd">        Returns </span>
<span class="sd">        --------</span>
<span class="sd">        out : float value           </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">li</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">first</span> <span class="o">&amp;</span> <span class="n">second</span><span class="p">)</span>
        <span class="n">la</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">first</span><span class="p">)</span>
        <span class="n">lb</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">second</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">li</span> <span class="o">/</span> <span class="p">(</span><span class="n">la</span> <span class="o">+</span> <span class="n">lb</span> <span class="o">-</span> <span class="n">li</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">binary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">first</span><span class="p">,</span> <span class="n">second</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Calculates the ? for 2 sessions</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        --------</span>
<span class="sd">        first: Id of a session</span>
<span class="sd">        second: Id of a session</span>
<span class="sd">        </span>
<span class="sd">        Returns </span>
<span class="sd">        --------</span>
<span class="sd">        out : float value           </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">a</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">first</span> <span class="o">&amp;</span> <span class="n">second</span><span class="p">)</span>
        <span class="n">b</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">first</span><span class="p">)</span>
        <span class="n">c</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">second</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">a</span><span class="p">)</span> <span class="o">/</span> <span class="p">((</span><span class="mi">2</span> <span class="o">*</span> <span class="n">a</span><span class="p">)</span> <span class="o">+</span> <span class="n">b</span> <span class="o">+</span> <span class="n">c</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">items_for_session</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Returns all items in the session</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        --------</span>
<span class="sd">        session: Id of a session</span>
<span class="sd">        </span>
<span class="sd">        Returns </span>
<span class="sd">        --------</span>
<span class="sd">        out : set           </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_item_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">session</span><span class="p">);</span>

    <span class="k">def</span> <span class="nf">sessions_for_item</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item_id</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Returns all session for an item</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        --------</span>
<span class="sd">        item: Id of the item session</span>
<span class="sd">        </span>
<span class="sd">        Returns </span>
<span class="sd">        --------</span>
<span class="sd">        out : set           </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_session_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">item_id</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">most_recent_sessions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sessions</span><span class="p">,</span> <span class="n">number</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Find the most recent sessions in the given set</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        --------</span>
<span class="sd">        sessions: set of session ids</span>
<span class="sd">        </span>
<span class="sd">        Returns </span>
<span class="sd">        --------</span>
<span class="sd">        out : set           </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">sample</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="n">tuples</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">session</span> <span class="ow">in</span> <span class="n">sessions</span><span class="p">:</span>
            <span class="n">time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_time</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">time</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; EMPTY TIMESTAMP!! &#39;</span><span class="p">,</span> <span class="n">session</span><span class="p">)</span>
            <span class="n">tuples</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">session</span><span class="p">,</span> <span class="n">time</span><span class="p">))</span>

        <span class="n">tuples</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">tuples</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">itemgetter</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># print &#39;sorted list &#39;, sortedList</span>
        <span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">tuples</span><span class="p">:</span>
            <span class="n">cnt</span> <span class="o">=</span> <span class="n">cnt</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">cnt</span> <span class="o">&gt;</span> <span class="n">number</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">sample</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">element</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="c1"># print &#39;returning sample of size &#39;, len(sample)</span>
        <span class="k">return</span> <span class="n">sample</span>

    <span class="k">def</span> <span class="nf">possible_neighbor_sessions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session_items</span><span class="p">,</span> <span class="n">input_item_id</span><span class="p">,</span> <span class="n">session_id</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Find a set of session to later on find neighbors in.</span>
<span class="sd">        A self.sample_size of 0 uses all sessions in which any item of the current session appears.</span>
<span class="sd">        self.sampling can be performed with the options &quot;recent&quot; or &quot;random&quot;.</span>
<span class="sd">        &quot;recent&quot; selects the self.sample_size most recent sessions while &quot;random&quot; just choses randomly. </span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        --------</span>
<span class="sd">        sessions: set of session ids</span>
<span class="sd">        </span>
<span class="sd">        Returns </span>
<span class="sd">        --------</span>
<span class="sd">        out : set           </span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">relevant_sessions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relevant_sessions</span> <span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">sessions_for_item</span><span class="p">(</span><span class="n">input_item_id</span><span class="p">);</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># use all session as possible neighbors</span>

            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;!!!!! runnig KNN without a sample size (check config)&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">relevant_sessions</span>

        <span class="k">else</span><span class="p">:</span>  <span class="c1"># sample some sessions</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">relevant_sessions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relevant_sessions</span> <span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">sessions_for_item</span><span class="p">(</span><span class="n">input_item_id</span><span class="p">);</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">relevant_sessions</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_size</span><span class="p">:</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sampling</span> <span class="o">==</span> <span class="s1">&#39;recent&#39;</span><span class="p">:</span>
                    <span class="n">sample</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">most_recent_sessions</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">relevant_sessions</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_size</span><span class="p">)</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">sampling</span> <span class="o">==</span> <span class="s1">&#39;random&#39;</span><span class="p">:</span>
                    <span class="n">sample</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">relevant_sessions</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_size</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">sample</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relevant_sessions</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_size</span><span class="p">]</span>

                <span class="k">return</span> <span class="n">sample</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">relevant_sessions</span>

    <span class="k">def</span> <span class="nf">calc_similarity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session_items</span><span class="p">,</span> <span class="n">sessions</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Calculates the configured similarity for the items in session_items and each session in sessions.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        --------</span>
<span class="sd">        session_items: set of item ids</span>
<span class="sd">        sessions: list of session ids</span>
<span class="sd">        </span>
<span class="sd">        Returns </span>
<span class="sd">        --------</span>
<span class="sd">        out : list of tuple (session_id,similarity)           </span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="c1"># print &#39;nb of sessions to test &#39;, len(sessionsToTest), &#39; metric: &#39;, self.metric</span>
        <span class="n">neighbors</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">session</span> <span class="ow">in</span> <span class="n">sessions</span><span class="p">:</span>
            <span class="n">cnt</span> <span class="o">=</span> <span class="n">cnt</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="c1"># get items of the session, look up the cache first </span>
            <span class="n">session_items_test</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">items_for_session</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>

            <span class="n">similarity</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">similarity</span><span class="p">)(</span><span class="n">session_items_test</span><span class="p">,</span> <span class="n">session_items</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">similarity</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">neighbors</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">session</span><span class="p">,</span> <span class="n">similarity</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">neighbors</span>

    <span class="c1"># -----------------</span>
    <span class="c1"># Find a set of neighbors, returns a list of tuples (sessionid: similarity) </span>
    <span class="c1"># -----------------</span>
    <span class="k">def</span> <span class="nf">find_neighbors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session_items</span><span class="p">,</span> <span class="n">input_item_id</span><span class="p">,</span> <span class="n">session_id</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Finds the k nearest neighbors for the given session_id and the current item input_item_id. </span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        --------</span>
<span class="sd">        session_items: set of item ids</span>
<span class="sd">        input_item_id: int </span>
<span class="sd">        session_id: int</span>
<span class="sd">        </span>
<span class="sd">        Returns </span>
<span class="sd">        --------</span>
<span class="sd">        out : list of tuple (session_id, similarity)           </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">possible_neighbors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">possible_neighbor_sessions</span><span class="p">(</span><span class="n">session_items</span><span class="p">,</span> <span class="n">input_item_id</span><span class="p">,</span> <span class="n">session_id</span><span class="p">)</span>
        <span class="n">possible_neighbors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_similarity</span><span class="p">(</span><span class="n">session_items</span><span class="p">,</span> <span class="n">possible_neighbors</span><span class="p">)</span>

        <span class="n">possible_neighbors</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">possible_neighbors</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">possible_neighbors</span> <span class="o">=</span> <span class="n">possible_neighbors</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">possible_neighbors</span>

    <span class="k">def</span> <span class="nf">score_items</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">neighbors</span><span class="p">,</span> <span class="n">input_item_id</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Compute a set of scores for all items given a set of neighbors.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        --------</span>
<span class="sd">        neighbors: set of session ids</span>
<span class="sd">        </span>
<span class="sd">        Returns </span>
<span class="sd">        --------</span>
<span class="sd">        out : list of tuple (item, score)           </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># now we have the set of relevant items to make predictions</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="c1"># iterate over the sessions</span>
        <span class="k">for</span> <span class="n">session</span> <span class="ow">in</span> <span class="n">neighbors</span><span class="p">:</span>
            <span class="c1"># get the items in this session</span>
            <span class="n">items</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">items_for_session</span><span class="p">(</span><span class="n">session</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>

                <span class="k">if</span> <span class="n">input_item_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">followed_by</span> <span class="ow">and</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">followed_by</span><span class="p">[</span>
                    <span class="n">input_item_id</span><span class="p">]:</span>  <span class="c1"># hard filter the candidates</span>

                    <span class="n">old_score</span> <span class="o">=</span> <span class="n">scores</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                    <span class="n">new_score</span> <span class="o">=</span> <span class="n">session</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

                    <span class="k">if</span> <span class="n">old_score</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">scores</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">item</span><span class="p">:</span> <span class="n">new_score</span><span class="p">})</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">new_score</span> <span class="o">=</span> <span class="n">old_score</span> <span class="o">+</span> <span class="n">new_score</span>
                        <span class="n">scores</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">item</span><span class="p">:</span> <span class="n">new_score</span><span class="p">})</span>

        <span class="k">return</span> <span class="n">scores</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">VMSessionKNN</span><span class="p">:</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    VMSessionKNN( k, sample_size=1000, sampling=&#39;recent&#39;, similarity=&#39;cosine&#39;, weighting=&#39;div&#39;, dwelling_time=False, last_n_days=None, last_n_clicks=None, extend=False, weighting_score=&#39;div_score&#39;, weighting_time=False, normalize=True, session_key = &#39;SessionId&#39;, item_key= &#39;ItemId&#39;, time_key= &#39;Time&#39;)</span>

<span class="sd">    Parameters</span>
<span class="sd">    -----------</span>
<span class="sd">    k : int</span>
<span class="sd">        Number of neighboring session to calculate the item scores from. (Default value: 100)</span>
<span class="sd">    sample_size : int</span>
<span class="sd">        Defines the length of a subset of all training sessions to calculate the nearest neighbors from. (Default value: 500)</span>
<span class="sd">    sampling : string</span>
<span class="sd">        String to define the sampling method for sessions (recent, random). (default: recent)</span>
<span class="sd">    similarity : string</span>
<span class="sd">        String to define the method for the similarity calculation (jaccard, cosine, binary, tanimoto). (default: jaccard)</span>
<span class="sd">    weighting : string</span>
<span class="sd">        Decay function to determine the importance/weight of individual actions in the current session (linear, same, div, log, quadratic). (default: div)</span>
<span class="sd">    weighting_score : string</span>
<span class="sd">        Decay function to lower the score of candidate items from a neighboring sessions that were selected by less recently clicked items in the current session. (linear, same, div, log, quadratic). (default: div_score)</span>
<span class="sd">    weighting_time : boolean</span>
<span class="sd">        Experimental function to give less weight to items from older sessions (default: False)</span>
<span class="sd">    dwelling_time : boolean</span>
<span class="sd">        Experimental function to use the dwelling time for item view actions as a weight in the similarity calculation. (default: False)</span>
<span class="sd">    last_n_days : int</span>
<span class="sd">        Use only data from the last N days. (default: None)</span>
<span class="sd">    last_n_clicks : int</span>
<span class="sd">        Use only the last N clicks of the current session when recommending. (default: None)</span>
<span class="sd">    extend : bool</span>
<span class="sd">        Add evaluated sessions to the maps.</span>
<span class="sd">    normalize : bool</span>
<span class="sd">        Normalize the scores in the end.</span>
<span class="sd">    session_key : string</span>
<span class="sd">        Header of the session ID column in the input file. (default: &#39;SessionId&#39;)</span>
<span class="sd">    item_key : string</span>
<span class="sd">        Header of the item ID column in the input file. (default: &#39;ItemId&#39;)</span>
<span class="sd">    time_key : string</span>
<span class="sd">        Header of the timestamp column in the input file. (default: &#39;Time&#39;)</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">sample_size</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">sampling</span><span class="o">=</span><span class="s1">&#39;recent&#39;</span><span class="p">,</span> <span class="n">similarity</span><span class="o">=</span><span class="s1">&#39;cosine&#39;</span><span class="p">,</span> <span class="n">weighting</span><span class="o">=</span><span class="s1">&#39;div&#39;</span><span class="p">,</span>
                 <span class="n">dwelling_time</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">last_n_days</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">last_n_clicks</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">extend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">weighting_score</span><span class="o">=</span><span class="s1">&#39;div_score&#39;</span><span class="p">,</span>
                 <span class="n">weighting_time</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">session_key</span><span class="o">=</span><span class="s1">&#39;SessionId&#39;</span><span class="p">,</span> <span class="n">item_key</span><span class="o">=</span><span class="s1">&#39;ItemId&#39;</span><span class="p">,</span> <span class="n">time_key</span><span class="o">=</span><span class="s1">&#39;Time&#39;</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">k</span> <span class="o">=</span> <span class="n">k</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sample_size</span> <span class="o">=</span> <span class="n">sample_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sampling</span> <span class="o">=</span> <span class="n">sampling</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weighting</span> <span class="o">=</span> <span class="n">weighting</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dwelling_time</span> <span class="o">=</span> <span class="n">dwelling_time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weighting_score</span> <span class="o">=</span> <span class="n">weighting_score</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weighting_time</span> <span class="o">=</span> <span class="n">weighting_time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">similarity</span> <span class="o">=</span> <span class="n">similarity</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session_key</span> <span class="o">=</span> <span class="n">session_key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">item_key</span> <span class="o">=</span> <span class="n">item_key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time_key</span> <span class="o">=</span> <span class="n">time_key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extend</span> <span class="o">=</span> <span class="n">extend</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">normalize</span> <span class="o">=</span> <span class="n">normalize</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_n_days</span> <span class="o">=</span> <span class="n">last_n_days</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_n_clicks</span> <span class="o">=</span> <span class="n">last_n_clicks</span>

        <span class="c1"># updated while recommending</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session_items</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">relevant_sessions</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="c1"># cache relations once at startup</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session_item_map</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">item_session_map</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session_time</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_time</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sim_time</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">items</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Trains the predictor.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        --------</span>
<span class="sd">        data: pandas.DataFrame</span>
<span class="sd">            Training data. It contains the transactions of the sessions. It has one column for session IDs, one for item IDs and one for the timestamp of the events (unix timestamps).</span>
<span class="sd">            It must have a header. Column names are arbitrary, but must correspond to the ones you set during the initialization of the network (session_key, item_key, time_key properties).</span>
<span class="sd">            </span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_n_days</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>

            <span class="n">max_time</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_key</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
            <span class="n">date_threshold</span> <span class="o">=</span> <span class="n">max_time</span><span class="o">.</span><span class="n">date</span><span class="p">()</span> <span class="o">-</span> <span class="n">td</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">last_n_days</span><span class="p">)</span>
            <span class="n">stamp</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">combine</span><span class="p">(</span><span class="n">date_threshold</span><span class="p">,</span> <span class="n">dt</span><span class="o">.</span><span class="n">min</span><span class="o">.</span><span class="n">time</span><span class="p">())</span><span class="o">.</span><span class="n">timestamp</span><span class="p">()</span>
            <span class="n">train</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_key</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">stamp</span><span class="p">]</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">train</span> <span class="o">=</span> <span class="n">data</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">num_items</span> <span class="o">=</span> <span class="n">train</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">item_key</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

        <span class="n">index_session</span> <span class="o">=</span> <span class="n">train</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session_key</span><span class="p">)</span>
        <span class="n">index_item</span> <span class="o">=</span> <span class="n">train</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">item_key</span><span class="p">)</span>
        <span class="n">index_time</span> <span class="o">=</span> <span class="n">train</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time_key</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">itemids</span> <span class="o">=</span> <span class="n">train</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">item_key</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>

        <span class="n">session</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">session_items</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">time</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="c1"># cnt = 0</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">train</span><span class="o">.</span><span class="n">itertuples</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
            <span class="c1"># cache items of sessions</span>
            <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="n">index_session</span><span class="p">]</span> <span class="o">!=</span> <span class="n">session</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">session_items</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">session_item_map</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">session</span><span class="p">:</span> <span class="n">session_items</span><span class="p">})</span>
                    <span class="c1"># cache the last time stamp of the session</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">session_time</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">session</span><span class="p">:</span> <span class="n">time</span><span class="p">})</span>
                    <span class="k">if</span> <span class="n">time</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_time</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">min_time</span> <span class="o">=</span> <span class="n">time</span>
                <span class="n">session</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">index_session</span><span class="p">]</span>
                <span class="n">session_items</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="n">time</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">index_time</span><span class="p">]</span>
            <span class="n">session_items</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">index_item</span><span class="p">])</span>

            <span class="c1"># cache sessions involving an item</span>
            <span class="n">map_is</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_session_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">index_item</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">map_is</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">map_is</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">item_session_map</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">row</span><span class="p">[</span><span class="n">index_item</span><span class="p">]:</span> <span class="n">map_is</span><span class="p">})</span>
            <span class="n">map_is</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">index_session</span><span class="p">])</span>

        <span class="c1"># Add the last tuple    </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session_item_map</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">session</span><span class="p">:</span> <span class="n">session_items</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session_time</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">session</span><span class="p">:</span> <span class="n">time</span><span class="p">})</span>

    <span class="k">def</span> <span class="nf">predict_next</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session_id</span><span class="p">,</span> <span class="n">input_item_id</span><span class="p">,</span> <span class="n">predict_for_item_ids</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">skip</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;view&#39;</span><span class="p">,</span> <span class="n">timestamp</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Gives predicton scores for a selected set of items on how likely they be the next item in the session.</span>
<span class="sd">                </span>
<span class="sd">        Parameters</span>
<span class="sd">        --------</span>
<span class="sd">        session_id : int or string</span>
<span class="sd">            The session IDs of the event.</span>
<span class="sd">        input_item_id : int or string</span>
<span class="sd">            The item ID of the event. Must be in the set of item IDs of the training set.</span>
<span class="sd">        predict_for_item_ids : 1D array</span>
<span class="sd">            IDs of items for which the network should give prediction scores. Every ID must be in the set of item IDs of the training set.</span>
<span class="sd">            </span>
<span class="sd">        Returns</span>
<span class="sd">        --------</span>
<span class="sd">        out : pandas.Series</span>
<span class="sd">            Prediction scores for selected items on how likely to be the next item of this session. Indexed by the item IDs.</span>
<span class="sd">        </span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="c1">#         gc.collect()</span>
        <span class="c1">#         process = psutil.Process(os.getpid())</span>
        <span class="c1">#         print( &#39;cknn.predict_next: &#39;, process.memory_info().rss, &#39; memory used&#39;)</span>

        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">!=</span> <span class="n">session_id</span><span class="p">):</span>  <span class="c1"># new session</span>

            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">extend</span><span class="p">):</span>
                <span class="n">item_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session_items</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">session_item_map</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">]</span> <span class="o">=</span> <span class="n">item_set</span><span class="p">;</span>
                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">item_set</span><span class="p">:</span>
                    <span class="n">map_is</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_session_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">map_is</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">map_is</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">item_session_map</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">item</span><span class="p">:</span> <span class="n">map_is</span><span class="p">})</span>
                    <span class="n">map_is</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">)</span>

                <span class="n">ts</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">session_time</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">:</span> <span class="n">ts</span><span class="p">})</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">last_ts</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">session_id</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">session_items</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dwelling_times</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">relevant_sessions</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;view&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">session_items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">input_item_id</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dwelling_time</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_ts</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dwelling_times</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">timestamp</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_ts</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">last_ts</span> <span class="o">=</span> <span class="n">timestamp</span>

        <span class="k">if</span> <span class="n">skip</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">items</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_items</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_n_clicks</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_items</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">last_n_clicks</span><span class="p">:]</span>
        <span class="n">neighbors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_neighbors</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="n">input_item_id</span><span class="p">,</span> <span class="n">session_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dwelling_times</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">)</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">score_items</span><span class="p">(</span><span class="n">neighbors</span><span class="p">,</span> <span class="n">items</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">)</span>

        <span class="c1"># Create things in the format ..</span>
        <span class="k">if</span> <span class="n">predict_for_item_ids</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">predict_for_item_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">itemids</span>
        <span class="n">predictions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">predict_for_item_ids</span><span class="p">))</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">in1d</span><span class="p">(</span><span class="n">predict_for_item_ids</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">scores</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>

        <span class="n">items</span> <span class="o">=</span> <span class="n">predict_for_item_ids</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
        <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="n">scores</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">items</span><span class="p">]</span>
        <span class="n">predictions</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">values</span>
        <span class="n">series</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">predictions</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">predict_for_item_ids</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalize</span><span class="p">:</span>
            <span class="n">series</span> <span class="o">=</span> <span class="n">series</span> <span class="o">/</span> <span class="n">series</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">series</span>

    <span class="k">def</span> <span class="nf">item_pop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sessions</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Returns a dict(item,score) of the item popularity for the given list of sessions (only a set of ids)</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        --------</span>
<span class="sd">        sessions: set</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        --------</span>
<span class="sd">        out : dict            </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">max_pop</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">session</span><span class="p">,</span> <span class="n">weight</span> <span class="ow">in</span> <span class="n">sessions</span><span class="p">:</span>
            <span class="n">items</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">items_for_session</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>

                <span class="n">count</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">count</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">item</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">item</span><span class="p">:</span> <span class="n">count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">})</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_pop</span><span class="p">):</span>
                    <span class="n">max_pop</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">key</span><span class="p">:</span> <span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">/</span> <span class="n">max_pop</span><span class="p">)})</span>

        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">jaccard</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">first</span><span class="p">,</span> <span class="n">second</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Calculates the jaccard index for two sessions</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        --------</span>
<span class="sd">        first: Id of a session</span>
<span class="sd">        second: Id of a session</span>
<span class="sd">        </span>
<span class="sd">        Returns </span>
<span class="sd">        --------</span>
<span class="sd">        out : float value           </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">sc</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">clock</span><span class="p">()</span>
        <span class="n">intersection</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">first</span> <span class="o">&amp;</span> <span class="n">second</span><span class="p">)</span>
        <span class="n">union</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">first</span> <span class="o">|</span> <span class="n">second</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">intersection</span> <span class="o">/</span> <span class="n">union</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sim_time</span> <span class="o">+=</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">clock</span><span class="p">()</span> <span class="o">-</span> <span class="n">sc</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">res</span>

    <span class="k">def</span> <span class="nf">cosine</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">first</span><span class="p">,</span> <span class="n">second</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Calculates the cosine similarity for two sessions</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        --------</span>
<span class="sd">        first: Id of a session</span>
<span class="sd">        second: Id of a session</span>
<span class="sd">        </span>
<span class="sd">        Returns </span>
<span class="sd">        --------</span>
<span class="sd">        out : float value           </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">li</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">first</span> <span class="o">&amp;</span> <span class="n">second</span><span class="p">)</span>
        <span class="n">la</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">first</span><span class="p">)</span>
        <span class="n">lb</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">second</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">li</span> <span class="o">/</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">la</span><span class="p">)</span> <span class="o">*</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">lb</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">tanimoto</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">first</span><span class="p">,</span> <span class="n">second</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Calculates the cosine tanimoto similarity for two sessions</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        --------</span>
<span class="sd">        first: Id of a session</span>
<span class="sd">        second: Id of a session</span>
<span class="sd">        </span>
<span class="sd">        Returns </span>
<span class="sd">        --------</span>
<span class="sd">        out : float value           </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">li</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">first</span> <span class="o">&amp;</span> <span class="n">second</span><span class="p">)</span>
        <span class="n">la</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">first</span><span class="p">)</span>
        <span class="n">lb</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">second</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">li</span> <span class="o">/</span> <span class="p">(</span><span class="n">la</span> <span class="o">+</span> <span class="n">lb</span> <span class="o">-</span> <span class="n">li</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">binary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">first</span><span class="p">,</span> <span class="n">second</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Calculates the ? for 2 sessions</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        --------</span>
<span class="sd">        first: Id of a session</span>
<span class="sd">        second: Id of a session</span>
<span class="sd">        </span>
<span class="sd">        Returns </span>
<span class="sd">        --------</span>
<span class="sd">        out : float value           </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">a</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">first</span> <span class="o">&amp;</span> <span class="n">second</span><span class="p">)</span>
        <span class="n">b</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">first</span><span class="p">)</span>
        <span class="n">c</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">second</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">a</span><span class="p">)</span> <span class="o">/</span> <span class="p">((</span><span class="mi">2</span> <span class="o">*</span> <span class="n">a</span><span class="p">)</span> <span class="o">+</span> <span class="n">b</span> <span class="o">+</span> <span class="n">c</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">vec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">first</span><span class="p">,</span> <span class="n">second</span><span class="p">,</span> <span class="nb">map</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Calculates the ? for 2 sessions</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        --------</span>
<span class="sd">        first: Id of a session</span>
<span class="sd">        second: Id of a session</span>
<span class="sd">        </span>
<span class="sd">        Returns </span>
<span class="sd">        --------</span>
<span class="sd">        out : float value           </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">first</span> <span class="o">&amp;</span> <span class="n">second</span>
        <span class="nb">sum</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">a</span><span class="p">:</span>
            <span class="nb">sum</span> <span class="o">+=</span> <span class="nb">map</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="n">result</span> <span class="o">=</span> <span class="nb">sum</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="nb">map</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">items_for_session</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Returns all items in the session</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        --------</span>
<span class="sd">        session: Id of a session</span>
<span class="sd">        </span>
<span class="sd">        Returns </span>
<span class="sd">        --------</span>
<span class="sd">        out : set           </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_item_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">session</span><span class="p">);</span>

    <span class="k">def</span> <span class="nf">vec_for_session</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Returns all items in the session</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        --------</span>
<span class="sd">        session: Id of a session</span>
<span class="sd">        </span>
<span class="sd">        Returns </span>
<span class="sd">        --------</span>
<span class="sd">        out : set           </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_vec_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">session</span><span class="p">);</span>

    <span class="k">def</span> <span class="nf">sessions_for_item</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item_id</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Returns all session for an item</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        --------</span>
<span class="sd">        item: Id of the item session</span>
<span class="sd">        </span>
<span class="sd">        Returns </span>
<span class="sd">        --------</span>
<span class="sd">        out : set           </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_session_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">item_id</span><span class="p">)</span> <span class="k">if</span> <span class="n">item_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_session_map</span> <span class="k">else</span> <span class="nb">set</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">most_recent_sessions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sessions</span><span class="p">,</span> <span class="n">number</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Find the most recent sessions in the given set</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        --------</span>
<span class="sd">        sessions: set of session ids</span>
<span class="sd">        </span>
<span class="sd">        Returns </span>
<span class="sd">        --------</span>
<span class="sd">        out : set           </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">sample</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="n">tuples</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">session</span> <span class="ow">in</span> <span class="n">sessions</span><span class="p">:</span>
            <span class="n">time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_time</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">time</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; EMPTY TIMESTAMP!! &#39;</span><span class="p">,</span> <span class="n">session</span><span class="p">)</span>
            <span class="n">tuples</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">session</span><span class="p">,</span> <span class="n">time</span><span class="p">))</span>

        <span class="n">tuples</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">tuples</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">itemgetter</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># print &#39;sorted list &#39;, sortedList</span>
        <span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">tuples</span><span class="p">:</span>
            <span class="n">cnt</span> <span class="o">=</span> <span class="n">cnt</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">cnt</span> <span class="o">&gt;</span> <span class="n">number</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">sample</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">element</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="c1"># print &#39;returning sample of size &#39;, len(sample)</span>
        <span class="k">return</span> <span class="n">sample</span>

    <span class="k">def</span> <span class="nf">possible_neighbor_sessions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session_items</span><span class="p">,</span> <span class="n">input_item_id</span><span class="p">,</span> <span class="n">session_id</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Find a set of session to later on find neighbors in.</span>
<span class="sd">        A self.sample_size of 0 uses all sessions in which any item of the current session appears.</span>
<span class="sd">        self.sampling can be performed with the options &quot;recent&quot; or &quot;random&quot;.</span>
<span class="sd">        &quot;recent&quot; selects the self.sample_size most recent sessions while &quot;random&quot; just choses randomly. </span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        --------</span>
<span class="sd">        sessions: set of session ids</span>
<span class="sd">        </span>
<span class="sd">        Returns </span>
<span class="sd">        --------</span>
<span class="sd">        out : set           </span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">relevant_sessions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relevant_sessions</span> <span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">sessions_for_item</span><span class="p">(</span><span class="n">input_item_id</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># use all session as possible neighbors</span>

            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;!!!!! runnig KNN without a sample size (check config)&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">relevant_sessions</span>

        <span class="k">else</span><span class="p">:</span>  <span class="c1"># sample some sessions</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">relevant_sessions</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_size</span><span class="p">:</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sampling</span> <span class="o">==</span> <span class="s1">&#39;recent&#39;</span><span class="p">:</span>
                    <span class="n">sample</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">most_recent_sessions</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">relevant_sessions</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_size</span><span class="p">)</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">sampling</span> <span class="o">==</span> <span class="s1">&#39;random&#39;</span><span class="p">:</span>
                    <span class="n">sample</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">relevant_sessions</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_size</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">sample</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relevant_sessions</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_size</span><span class="p">]</span>

                <span class="k">return</span> <span class="n">sample</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">relevant_sessions</span>

    <span class="k">def</span> <span class="nf">calc_similarity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session_items</span><span class="p">,</span> <span class="n">sessions</span><span class="p">,</span> <span class="n">dwelling_times</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Calculates the configured similarity for the items in session_items and each session in sessions.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        --------</span>
<span class="sd">        session_items: set of item ids</span>
<span class="sd">        sessions: list of session ids</span>
<span class="sd">        </span>
<span class="sd">        Returns </span>
<span class="sd">        --------</span>
<span class="sd">        out : list of tuple (session_id,similarity)           </span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">pos_map</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">session_items</span><span class="p">)</span>

        <span class="n">count</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">session_items</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">weighting</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">pos_map</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">weighting</span><span class="p">)(</span><span class="n">count</span><span class="p">,</span> <span class="n">length</span><span class="p">)</span>
                <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pos_map</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="n">dt</span> <span class="o">=</span> <span class="n">dwelling_times</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">dt</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">session_items</span><span class="p">)</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">dt</span> <span class="o">/</span> <span class="n">dt</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="c1"># dt[session_items[-1]] = dt.mean() if len(session_items) &gt; 1 else 1</span>
        <span class="n">dt</span><span class="p">[</span><span class="n">session_items</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dwelling_time</span><span class="p">:</span>
            <span class="c1"># print(dt)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dt</span><span class="p">)):</span>
                <span class="n">pos_map</span><span class="p">[</span><span class="n">session_items</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">*=</span> <span class="n">dt</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="c1"># print(pos_map)</span>
        <span class="c1"># print &#39;nb of sessions to test &#39;, len(sessionsToTest), &#39; metric: &#39;, self.metric</span>
        <span class="n">items</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">session_items</span><span class="p">)</span>
        <span class="n">neighbors</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">session</span> <span class="ow">in</span> <span class="n">sessions</span><span class="p">:</span>
            <span class="n">cnt</span> <span class="o">=</span> <span class="n">cnt</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="c1"># get items of the session, look up the cache first </span>
            <span class="n">n_items</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">items_for_session</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>
            <span class="n">sts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_time</span><span class="p">[</span><span class="n">session</span><span class="p">]</span>

            <span class="n">similarity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vec</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="n">n_items</span><span class="p">,</span> <span class="n">pos_map</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">similarity</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">weighting_time</span><span class="p">:</span>
                    <span class="n">diff</span> <span class="o">=</span> <span class="n">timestamp</span> <span class="o">-</span> <span class="n">sts</span>
                    <span class="n">days</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">diff</span> <span class="o">/</span> <span class="mi">60</span> <span class="o">/</span> <span class="mi">60</span> <span class="o">/</span> <span class="mi">24</span><span class="p">)</span>
                    <span class="n">decay</span> <span class="o">=</span> <span class="nb">pow</span><span class="p">(</span><span class="mi">7</span> <span class="o">/</span> <span class="mi">8</span><span class="p">,</span> <span class="n">days</span><span class="p">)</span>
                    <span class="n">similarity</span> <span class="o">*=</span> <span class="n">decay</span>

                <span class="c1"># print(&quot;days:&quot;,days,&quot; =&gt; &quot;,decay)</span>

                <span class="n">neighbors</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">session</span><span class="p">,</span> <span class="n">similarity</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">neighbors</span>

    <span class="c1"># -----------------</span>
    <span class="c1"># Find a set of neighbors, returns a list of tuples (sessionid: similarity) </span>
    <span class="c1"># -----------------</span>
    <span class="k">def</span> <span class="nf">find_neighbors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session_items</span><span class="p">,</span> <span class="n">input_item_id</span><span class="p">,</span> <span class="n">session_id</span><span class="p">,</span> <span class="n">dwelling_times</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Finds the k nearest neighbors for the given session_id and the current item input_item_id. </span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        --------</span>
<span class="sd">        session_items: set of item ids</span>
<span class="sd">        input_item_id: int </span>
<span class="sd">        session_id: int</span>
<span class="sd">        </span>
<span class="sd">        Returns </span>
<span class="sd">        --------</span>
<span class="sd">        out : list of tuple (session_id, similarity)           </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">possible_neighbors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">possible_neighbor_sessions</span><span class="p">(</span><span class="n">session_items</span><span class="p">,</span> <span class="n">input_item_id</span><span class="p">,</span> <span class="n">session_id</span><span class="p">)</span>
        <span class="n">possible_neighbors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_similarity</span><span class="p">(</span><span class="n">session_items</span><span class="p">,</span> <span class="n">possible_neighbors</span><span class="p">,</span> <span class="n">dwelling_times</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">)</span>

        <span class="n">possible_neighbors</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">possible_neighbors</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">possible_neighbors</span> <span class="o">=</span> <span class="n">possible_neighbors</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">possible_neighbors</span>

    <span class="k">def</span> <span class="nf">score_items</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">neighbors</span><span class="p">,</span> <span class="n">current_session</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Compute a set of scores for all items given a set of neighbors.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        --------</span>
<span class="sd">        neighbors: set of session ids</span>
<span class="sd">        </span>
<span class="sd">        Returns </span>
<span class="sd">        --------</span>
<span class="sd">        out : list of tuple (item, score)           </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># now we have the set of relevant items to make predictions</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="c1"># iterate over the sessions</span>
        <span class="k">for</span> <span class="n">session</span> <span class="ow">in</span> <span class="n">neighbors</span><span class="p">:</span>
            <span class="c1"># get the items in this session</span>
            <span class="n">items</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">items_for_session</span><span class="p">(</span><span class="n">session</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">step</span> <span class="o">=</span> <span class="mi">1</span>

            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">current_session</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
                    <span class="n">decay</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">weighting_score</span><span class="p">)(</span><span class="n">step</span><span class="p">)</span>
                    <span class="k">break</span>
                <span class="n">step</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
                <span class="n">old_score</span> <span class="o">=</span> <span class="n">scores</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                <span class="n">similarity</span> <span class="o">=</span> <span class="n">session</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">old_score</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">scores</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">item</span><span class="p">:</span> <span class="p">(</span><span class="n">similarity</span> <span class="o">*</span> <span class="n">decay</span><span class="p">)})</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">new_score</span> <span class="o">=</span> <span class="n">old_score</span> <span class="o">+</span> <span class="p">(</span><span class="n">similarity</span> <span class="o">*</span> <span class="n">decay</span><span class="p">)</span>
                    <span class="n">scores</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">item</span><span class="p">:</span> <span class="n">new_score</span><span class="p">})</span>

        <span class="k">return</span> <span class="n">scores</span>

    <span class="k">def</span> <span class="nf">linear_score</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="mf">0.1</span> <span class="o">*</span> <span class="n">i</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">100</span> <span class="k">else</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">same_score</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">div_score</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">i</span>

    <span class="k">def</span> <span class="nf">log_score</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">log10</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mf">1.7</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">quadratic_score</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="n">i</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">linear</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">length</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="mf">0.1</span> <span class="o">*</span> <span class="p">(</span><span class="n">length</span> <span class="o">-</span> <span class="n">i</span><span class="p">))</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">10</span> <span class="k">else</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">same</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">length</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">div</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">length</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">i</span> <span class="o">/</span> <span class="n">length</span>

    <span class="k">def</span> <span class="nf">log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">length</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">log10</span><span class="p">((</span><span class="n">length</span> <span class="o">-</span> <span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1.7</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">quadratic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">length</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">i</span> <span class="o">/</span> <span class="n">length</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SessionKNN</span><span class="p">:</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    SessionKNN( k, sample_size=500, sampling=&#39;recent&#39;,  similarity = &#39;jaccard&#39;, remind=False, pop_boost=0, session_key = &#39;SessionId&#39;, item_key= &#39;ItemId&#39;)</span>

<span class="sd">    Parameters</span>
<span class="sd">    -----------</span>
<span class="sd">    k : int</span>
<span class="sd">        Number of neighboring session to calculate the item scores from. (Default value: 100)</span>
<span class="sd">    sample_size : int</span>
<span class="sd">        Defines the length of a subset of all training sessions to calculate the nearest neighbors from. (Default value: 500)</span>
<span class="sd">    sampling : string</span>
<span class="sd">        String to define the sampling method for sessions (recent, random). (default: recent)</span>
<span class="sd">    similarity : string</span>
<span class="sd">        String to define the method for the similarity calculation (jaccard, cosine, binary, tanimoto). (default: jaccard)</span>
<span class="sd">    remind : bool</span>
<span class="sd">        Should the last items of the current session be boosted to the top as reminders</span>
<span class="sd">    pop_boost : int</span>
<span class="sd">        Push popular items in the neighbor sessions by this factor. (default: 0 to leave out)</span>
<span class="sd">    extend : bool</span>
<span class="sd">        Add evaluated sessions to the maps</span>
<span class="sd">    normalize : bool</span>
<span class="sd">        Normalize the scores in the end</span>
<span class="sd">    session_key : string</span>
<span class="sd">        Header of the session ID column in the input file. (default: &#39;SessionId&#39;)</span>
<span class="sd">    item_key : string</span>
<span class="sd">        Header of the item ID column in the input file. (default: &#39;ItemId&#39;)</span>
<span class="sd">    time_key : string</span>
<span class="sd">        Header of the timestamp column in the input file. (default: &#39;Time&#39;)</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">sample_size</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">sampling</span><span class="o">=</span><span class="s1">&#39;recent&#39;</span><span class="p">,</span> <span class="n">similarity</span><span class="o">=</span><span class="s1">&#39;jaccard&#39;</span><span class="p">,</span> <span class="n">remind</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">pop_boost</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                 <span class="n">extend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">session_key</span><span class="o">=</span><span class="s1">&#39;SessionId&#39;</span><span class="p">,</span> <span class="n">item_key</span><span class="o">=</span><span class="s1">&#39;ItemId&#39;</span><span class="p">,</span> <span class="n">time_key</span><span class="o">=</span><span class="s1">&#39;Time&#39;</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">remind</span> <span class="o">=</span> <span class="n">remind</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k</span> <span class="o">=</span> <span class="n">k</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sample_size</span> <span class="o">=</span> <span class="n">sample_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sampling</span> <span class="o">=</span> <span class="n">sampling</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">similarity</span> <span class="o">=</span> <span class="n">similarity</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pop_boost</span> <span class="o">=</span> <span class="n">pop_boost</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session_key</span> <span class="o">=</span> <span class="n">session_key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">item_key</span> <span class="o">=</span> <span class="n">item_key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time_key</span> <span class="o">=</span> <span class="n">time_key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extend</span> <span class="o">=</span> <span class="n">extend</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">normalize</span> <span class="o">=</span> <span class="n">normalize</span>

        <span class="c1"># updated while recommending</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session_items</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">relevant_sessions</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="c1"># cache relations once at startup</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session_item_map</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">item_session_map</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session_time</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sim_time</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">train</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Trains the predictor.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        --------</span>
<span class="sd">        data: pandas.DataFrame</span>
<span class="sd">            Training data. It contains the transactions of the sessions. It has one column for session IDs, one for item IDs and one for the timestamp of the events (unix timestamps).</span>
<span class="sd">            It must have a header. Column names are arbitrary, but must correspond to the ones you set during the initialization of the network (session_key, item_key, time_key properties).</span>
<span class="sd">            </span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">index_session</span> <span class="o">=</span> <span class="n">train</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session_key</span><span class="p">)</span>
        <span class="n">index_item</span> <span class="o">=</span> <span class="n">train</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">item_key</span><span class="p">)</span>
        <span class="n">index_time</span> <span class="o">=</span> <span class="n">train</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time_key</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">itemids</span> <span class="o">=</span> <span class="n">train</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">item_key</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>

        <span class="n">session</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">session_items</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">time</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="c1"># cnt = 0</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">train</span><span class="o">.</span><span class="n">itertuples</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
            <span class="c1"># cache items of sessions</span>
            <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="n">index_session</span><span class="p">]</span> <span class="o">!=</span> <span class="n">session</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">session_items</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">session_item_map</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">session</span><span class="p">:</span> <span class="n">session_items</span><span class="p">})</span>
                    <span class="c1"># cache the last time stamp of the session</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">session_time</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">session</span><span class="p">:</span> <span class="n">time</span><span class="p">})</span>
                <span class="n">session</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">index_session</span><span class="p">]</span>
                <span class="n">session_items</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="n">time</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">index_time</span><span class="p">]</span>
            <span class="n">session_items</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">index_item</span><span class="p">])</span>

            <span class="c1"># cache sessions involving an item</span>
            <span class="n">map_is</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_session_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">index_item</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">map_is</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">map_is</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">item_session_map</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">row</span><span class="p">[</span><span class="n">index_item</span><span class="p">]:</span> <span class="n">map_is</span><span class="p">})</span>
            <span class="n">map_is</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">index_session</span><span class="p">])</span>

        <span class="c1"># Add the last tuple    </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session_item_map</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">session</span><span class="p">:</span> <span class="n">session_items</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session_time</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">session</span><span class="p">:</span> <span class="n">time</span><span class="p">})</span>

    <span class="k">def</span> <span class="nf">predict_next</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session_id</span><span class="p">,</span> <span class="n">input_item_id</span><span class="p">,</span> <span class="n">predict_for_item_ids</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">skip</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;view&#39;</span><span class="p">,</span> <span class="n">timestamp</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Gives predicton scores for a selected set of items on how likely they be the next item in the session.</span>
<span class="sd">                </span>
<span class="sd">        Parameters</span>
<span class="sd">        --------</span>
<span class="sd">        session_id : int or string</span>
<span class="sd">            The session IDs of the event.</span>
<span class="sd">        input_item_id : int or string</span>
<span class="sd">            The item ID of the event. Must be in the set of item IDs of the training set.</span>
<span class="sd">        predict_for_item_ids : 1D array</span>
<span class="sd">            IDs of items for which the network should give prediction scores. Every ID must be in the set of item IDs of the training set.</span>
<span class="sd">            </span>
<span class="sd">        Returns</span>
<span class="sd">        --------</span>
<span class="sd">        out : pandas.Series</span>
<span class="sd">            Prediction scores for selected items on how likely to be the next item of this session. Indexed by the item IDs.</span>
<span class="sd">        </span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="c1">#         gc.collect()</span>
        <span class="c1">#         process = psutil.Process(os.getpid())</span>
        <span class="c1">#         print( &#39;cknn.predict_next: &#39;, process.memory_info().rss, &#39; memory used&#39;)</span>

        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">!=</span> <span class="n">session_id</span><span class="p">):</span>  <span class="c1"># new session</span>

            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">extend</span><span class="p">):</span>
                <span class="n">item_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session_items</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">session_item_map</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">]</span> <span class="o">=</span> <span class="n">item_set</span><span class="p">;</span>
                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">item_set</span><span class="p">:</span>
                    <span class="n">map_is</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_session_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">map_is</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">map_is</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">item_session_map</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">item</span><span class="p">:</span> <span class="n">map_is</span><span class="p">})</span>
                    <span class="n">map_is</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">)</span>

                <span class="n">ts</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">session_time</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">:</span> <span class="n">ts</span><span class="p">})</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">session_id</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">session_items</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">relevant_sessions</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;view&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">session_items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">input_item_id</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">skip</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">neighbors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_neighbors</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session_items</span><span class="p">),</span> <span class="n">input_item_id</span><span class="p">,</span> <span class="n">session_id</span><span class="p">)</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">score_items</span><span class="p">(</span><span class="n">neighbors</span><span class="p">)</span>

        <span class="c1"># add some reminders</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">remind</span><span class="p">:</span>

            <span class="n">reminderScore</span> <span class="o">=</span> <span class="mi">5</span>
            <span class="n">takeLastN</span> <span class="o">=</span> <span class="mi">3</span>

            <span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_items</span><span class="p">[</span><span class="o">-</span><span class="n">takeLastN</span><span class="p">:]:</span>
                <span class="n">cnt</span> <span class="o">=</span> <span class="n">cnt</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="c1"># reminderScore = reminderScore + (cnt/100)</span>

                <span class="n">oldScore</span> <span class="o">=</span> <span class="n">scores</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span>
                <span class="n">newScore</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="n">oldScore</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">newScore</span> <span class="o">=</span> <span class="n">reminderScore</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">newScore</span> <span class="o">=</span> <span class="n">oldScore</span> <span class="o">+</span> <span class="n">reminderScore</span>
                <span class="c1"># print &#39;old score &#39;, oldScore</span>
                <span class="c1"># update the score and add a small number for the position </span>
                <span class="n">newScore</span> <span class="o">=</span> <span class="p">(</span><span class="n">newScore</span> <span class="o">*</span> <span class="n">reminderScore</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>

                <span class="n">scores</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">elem</span><span class="p">:</span> <span class="n">newScore</span><span class="p">})</span>

        <span class="c1"># push popular ones</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pop_boost</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>

            <span class="n">pop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_pop</span><span class="p">(</span><span class="n">neighbors</span><span class="p">)</span>
            <span class="c1"># Iterate over the item neighbors</span>
            <span class="c1"># print itemScores</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">scores</span><span class="p">:</span>
                <span class="n">item_pop</span> <span class="o">=</span> <span class="n">pop</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="c1"># Gives some minimal MRR boost?</span>
                <span class="n">scores</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">key</span><span class="p">:</span> <span class="p">(</span><span class="n">scores</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pop_boost</span> <span class="o">*</span> <span class="n">item_pop</span><span class="p">))})</span>

        <span class="c1"># Create things in the format ..</span>
        <span class="k">if</span> <span class="n">predict_for_item_ids</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">predict_for_item_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">itemids</span>
        <span class="n">predictions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">predict_for_item_ids</span><span class="p">))</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">in1d</span><span class="p">(</span><span class="n">predict_for_item_ids</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">scores</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>

        <span class="n">items</span> <span class="o">=</span> <span class="n">predict_for_item_ids</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
        <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="n">scores</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">items</span><span class="p">]</span>
        <span class="n">predictions</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">values</span>
        <span class="n">series</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">predictions</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">predict_for_item_ids</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalize</span><span class="p">:</span>
            <span class="n">series</span> <span class="o">=</span> <span class="n">series</span> <span class="o">/</span> <span class="n">series</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">series</span>

    <span class="k">def</span> <span class="nf">item_pop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sessions</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Returns a dict(item,score) of the item popularity for the given list of sessions (only a set of ids)</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        --------</span>
<span class="sd">        sessions: set</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        --------</span>
<span class="sd">        out : dict            </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">max_pop</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">session</span><span class="p">,</span> <span class="n">weight</span> <span class="ow">in</span> <span class="n">sessions</span><span class="p">:</span>
            <span class="n">items</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">items_for_session</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>

                <span class="n">count</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">count</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">item</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">item</span><span class="p">:</span> <span class="n">count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">})</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_pop</span><span class="p">):</span>
                    <span class="n">max_pop</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">key</span><span class="p">:</span> <span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">/</span> <span class="n">max_pop</span><span class="p">)})</span>

        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">jaccard</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">first</span><span class="p">,</span> <span class="n">second</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Calculates the jaccard index for two sessions</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        --------</span>
<span class="sd">        first: Id of a session</span>
<span class="sd">        second: Id of a session</span>
<span class="sd">        </span>
<span class="sd">        Returns </span>
<span class="sd">        --------</span>
<span class="sd">        out : float value           </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">sc</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">clock</span><span class="p">()</span>
        <span class="n">intersection</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">first</span> <span class="o">&amp;</span> <span class="n">second</span><span class="p">)</span>
        <span class="n">union</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">first</span> <span class="o">|</span> <span class="n">second</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">intersection</span> <span class="o">/</span> <span class="n">union</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sim_time</span> <span class="o">+=</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">clock</span><span class="p">()</span> <span class="o">-</span> <span class="n">sc</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">res</span>

    <span class="k">def</span> <span class="nf">cosine</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">first</span><span class="p">,</span> <span class="n">second</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Calculates the cosine similarity for two sessions</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        --------</span>
<span class="sd">        first: Id of a session</span>
<span class="sd">        second: Id of a session</span>
<span class="sd">        </span>
<span class="sd">        Returns </span>
<span class="sd">        --------</span>
<span class="sd">        out : float value           </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">li</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">first</span> <span class="o">&amp;</span> <span class="n">second</span><span class="p">)</span>
        <span class="n">la</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">first</span><span class="p">)</span>
        <span class="n">lb</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">second</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">li</span> <span class="o">/</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">la</span><span class="p">)</span> <span class="o">*</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">lb</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">tanimoto</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">first</span><span class="p">,</span> <span class="n">second</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Calculates the cosine tanimoto similarity for two sessions</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        --------</span>
<span class="sd">        first: Id of a session</span>
<span class="sd">        second: Id of a session</span>
<span class="sd">        </span>
<span class="sd">        Returns </span>
<span class="sd">        --------</span>
<span class="sd">        out : float value           </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">li</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">first</span> <span class="o">&amp;</span> <span class="n">second</span><span class="p">)</span>
        <span class="n">la</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">first</span><span class="p">)</span>
        <span class="n">lb</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">second</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">li</span> <span class="o">/</span> <span class="p">(</span><span class="n">la</span> <span class="o">+</span> <span class="n">lb</span> <span class="o">-</span> <span class="n">li</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">binary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">first</span><span class="p">,</span> <span class="n">second</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Calculates the ? for 2 sessions</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        --------</span>
<span class="sd">        first: Id of a session</span>
<span class="sd">        second: Id of a session</span>
<span class="sd">        </span>
<span class="sd">        Returns </span>
<span class="sd">        --------</span>
<span class="sd">        out : float value           </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">a</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">first</span> <span class="o">&amp;</span> <span class="n">second</span><span class="p">)</span>
        <span class="n">b</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">first</span><span class="p">)</span>
        <span class="n">c</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">second</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">a</span><span class="p">)</span> <span class="o">/</span> <span class="p">((</span><span class="mi">2</span> <span class="o">*</span> <span class="n">a</span><span class="p">)</span> <span class="o">+</span> <span class="n">b</span> <span class="o">+</span> <span class="n">c</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">random</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">first</span><span class="p">,</span> <span class="n">second</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Calculates the ? for 2 sessions</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        --------</span>
<span class="sd">        first: Id of a session</span>
<span class="sd">        second: Id of a session</span>
<span class="sd">        </span>
<span class="sd">        Returns </span>
<span class="sd">        --------</span>
<span class="sd">        out : float value           </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">items_for_session</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Returns all items in the session</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        --------</span>
<span class="sd">        session: Id of a session</span>
<span class="sd">        </span>
<span class="sd">        Returns </span>
<span class="sd">        --------</span>
<span class="sd">        out : set           </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_item_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">session</span><span class="p">);</span>

    <span class="k">def</span> <span class="nf">sessions_for_item</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item_id</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Returns all session for an item</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        --------</span>
<span class="sd">        item: Id of the item session</span>
<span class="sd">        </span>
<span class="sd">        Returns </span>
<span class="sd">        --------</span>
<span class="sd">        out : set           </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_session_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">item_id</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">most_recent_sessions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sessions</span><span class="p">,</span> <span class="n">number</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Find the most recent sessions in the given set</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        --------</span>
<span class="sd">        sessions: set of session ids</span>
<span class="sd">        </span>
<span class="sd">        Returns </span>
<span class="sd">        --------</span>
<span class="sd">        out : set           </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">sample</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="n">tuples</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">session</span> <span class="ow">in</span> <span class="n">sessions</span><span class="p">:</span>
            <span class="n">time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_time</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">time</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; EMPTY TIMESTAMP!! &#39;</span><span class="p">,</span> <span class="n">session</span><span class="p">)</span>
            <span class="n">tuples</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">session</span><span class="p">,</span> <span class="n">time</span><span class="p">))</span>

        <span class="n">tuples</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">tuples</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">itemgetter</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># print &#39;sorted list &#39;, sortedList</span>
        <span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">tuples</span><span class="p">:</span>
            <span class="n">cnt</span> <span class="o">=</span> <span class="n">cnt</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">cnt</span> <span class="o">&gt;</span> <span class="n">number</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">sample</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">element</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="c1"># print &#39;returning sample of size &#39;, len(sample)</span>
        <span class="k">return</span> <span class="n">sample</span>

    <span class="k">def</span> <span class="nf">possible_neighbor_sessions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session_items</span><span class="p">,</span> <span class="n">input_item_id</span><span class="p">,</span> <span class="n">session_id</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Find a set of session to later on find neighbors in.</span>
<span class="sd">        A self.sample_size of 0 uses all sessions in which any item of the current session appears.</span>
<span class="sd">        self.sampling can be performed with the options &quot;recent&quot; or &quot;random&quot;.</span>
<span class="sd">        &quot;recent&quot; selects the self.sample_size most recent sessions while &quot;random&quot; just choses randomly. </span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        --------</span>
<span class="sd">        sessions: set of session ids</span>
<span class="sd">        </span>
<span class="sd">        Returns </span>
<span class="sd">        --------</span>
<span class="sd">        out : set           </span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">relevant_sessions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relevant_sessions</span> <span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">sessions_for_item</span><span class="p">(</span><span class="n">input_item_id</span><span class="p">);</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># use all session as possible neighbors</span>

            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;!!!!! runnig KNN without a sample size (check config)&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">relevant_sessions</span>

        <span class="k">else</span><span class="p">:</span>  <span class="c1"># sample some sessions</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">relevant_sessions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relevant_sessions</span> <span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">sessions_for_item</span><span class="p">(</span><span class="n">input_item_id</span><span class="p">);</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">relevant_sessions</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_size</span><span class="p">:</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sampling</span> <span class="o">==</span> <span class="s1">&#39;recent&#39;</span><span class="p">:</span>
                    <span class="n">sample</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">most_recent_sessions</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">relevant_sessions</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_size</span><span class="p">)</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">sampling</span> <span class="o">==</span> <span class="s1">&#39;random&#39;</span><span class="p">:</span>
                    <span class="n">sample</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">relevant_sessions</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_size</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">sample</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relevant_sessions</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_size</span><span class="p">]</span>

                <span class="k">return</span> <span class="n">sample</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">relevant_sessions</span>

    <span class="k">def</span> <span class="nf">calc_similarity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session_items</span><span class="p">,</span> <span class="n">sessions</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Calculates the configured similarity for the items in session_items and each session in sessions.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        --------</span>
<span class="sd">        session_items: set of item ids</span>
<span class="sd">        sessions: list of session ids</span>
<span class="sd">        </span>
<span class="sd">        Returns </span>
<span class="sd">        --------</span>
<span class="sd">        out : list of tuple (session_id,similarity)           </span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="c1"># print &#39;nb of sessions to test &#39;, len(sessionsToTest), &#39; metric: &#39;, self.metric</span>
        <span class="n">neighbors</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">session</span> <span class="ow">in</span> <span class="n">sessions</span><span class="p">:</span>
            <span class="n">cnt</span> <span class="o">=</span> <span class="n">cnt</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="c1"># get items of the session, look up the cache first </span>
            <span class="n">session_items_test</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">items_for_session</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>

            <span class="n">similarity</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">similarity</span><span class="p">)(</span><span class="n">session_items_test</span><span class="p">,</span> <span class="n">session_items</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">similarity</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">neighbors</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">session</span><span class="p">,</span> <span class="n">similarity</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">neighbors</span>

    <span class="c1"># -----------------</span>
    <span class="c1"># Find a set of neighbors, returns a list of tuples (sessionid: similarity) </span>
    <span class="c1"># -----------------</span>
    <span class="k">def</span> <span class="nf">find_neighbors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session_items</span><span class="p">,</span> <span class="n">input_item_id</span><span class="p">,</span> <span class="n">session_id</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Finds the k nearest neighbors for the given session_id and the current item input_item_id. </span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        --------</span>
<span class="sd">        session_items: set of item ids</span>
<span class="sd">        input_item_id: int </span>
<span class="sd">        session_id: int</span>
<span class="sd">        </span>
<span class="sd">        Returns </span>
<span class="sd">        --------</span>
<span class="sd">        out : list of tuple (session_id, similarity)           </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">possible_neighbors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">possible_neighbor_sessions</span><span class="p">(</span><span class="n">session_items</span><span class="p">,</span> <span class="n">input_item_id</span><span class="p">,</span> <span class="n">session_id</span><span class="p">)</span>
        <span class="n">possible_neighbors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_similarity</span><span class="p">(</span><span class="n">session_items</span><span class="p">,</span> <span class="n">possible_neighbors</span><span class="p">)</span>

        <span class="n">possible_neighbors</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">possible_neighbors</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">possible_neighbors</span> <span class="o">=</span> <span class="n">possible_neighbors</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">possible_neighbors</span>

    <span class="k">def</span> <span class="nf">score_items</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">neighbors</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Compute a set of scores for all items given a set of neighbors.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        --------</span>
<span class="sd">        neighbors: set of session ids</span>
<span class="sd">        </span>
<span class="sd">        Returns </span>
<span class="sd">        --------</span>
<span class="sd">        out : list of tuple (item, score)           </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># now we have the set of relevant items to make predictions</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="c1"># iterate over the sessions</span>
        <span class="k">for</span> <span class="n">session</span> <span class="ow">in</span> <span class="n">neighbors</span><span class="p">:</span>
            <span class="c1"># get the items in this session</span>
            <span class="n">items</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">items_for_session</span><span class="p">(</span><span class="n">session</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
                <span class="n">old_score</span> <span class="o">=</span> <span class="n">scores</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                <span class="n">new_score</span> <span class="o">=</span> <span class="n">session</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">old_score</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">scores</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">item</span><span class="p">:</span> <span class="n">new_score</span><span class="p">})</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">new_score</span> <span class="o">=</span> <span class="n">old_score</span> <span class="o">+</span> <span class="n">new_score</span>
                    <span class="n">scores</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">item</span><span class="p">:</span> <span class="n">new_score</span><span class="p">})</span>

        <span class="k">return</span> <span class="n">scores</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SeqSessionKNN</span><span class="p">:</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    SeqSessionKNN( k, sample_size=500, sampling=&#39;recent&#39;,  similarity = &#39;jaccard&#39;, remind=False, pop_boost=0, session_key = &#39;SessionId&#39;, item_key= &#39;ItemId&#39;)</span>

<span class="sd">    Parameters</span>
<span class="sd">    -----------</span>
<span class="sd">    k : int</span>
<span class="sd">        Number of neighboring session to calculate the item scores from. (Default value: 100)</span>
<span class="sd">    sample_size : int</span>
<span class="sd">        Defines the length of a subset of all training sessions to calculate the nearest neighbors from. (Default value: 500)</span>
<span class="sd">    sampling : string</span>
<span class="sd">        String to define the sampling method for sessions (recent, random). (default: recent)</span>
<span class="sd">    similarity : string</span>
<span class="sd">        String to define the method for the similarity calculation (jaccard, cosine, binary, tanimoto). (default: jaccard)</span>
<span class="sd">    remind : bool</span>
<span class="sd">        Should the last items of the current session be boosted to the top as reminders</span>
<span class="sd">    pop_boost : int</span>
<span class="sd">        Push popular items in the neighbor sessions by this factor. (default: 0 to leave out)</span>
<span class="sd">    extend : bool</span>
<span class="sd">        Add evaluated sessions to the maps</span>
<span class="sd">    normalize : bool</span>
<span class="sd">        Normalize the scores in the end</span>
<span class="sd">    session_key : string</span>
<span class="sd">        Header of the session ID column in the input file. (default: &#39;SessionId&#39;)</span>
<span class="sd">    item_key : string</span>
<span class="sd">        Header of the item ID column in the input file. (default: &#39;ItemId&#39;)</span>
<span class="sd">    time_key : string</span>
<span class="sd">        Header of the timestamp column in the input file. (default: &#39;Time&#39;)</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">sample_size</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">sampling</span><span class="o">=</span><span class="s1">&#39;recent&#39;</span><span class="p">,</span> <span class="n">similarity</span><span class="o">=</span><span class="s1">&#39;jaccard&#39;</span><span class="p">,</span> <span class="n">weighting</span><span class="o">=</span><span class="s1">&#39;div&#39;</span><span class="p">,</span> <span class="n">remind</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">pop_boost</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">extend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">session_key</span><span class="o">=</span><span class="s1">&#39;SessionId&#39;</span><span class="p">,</span> <span class="n">item_key</span><span class="o">=</span><span class="s1">&#39;ItemId&#39;</span><span class="p">,</span>
                 <span class="n">time_key</span><span class="o">=</span><span class="s1">&#39;Time&#39;</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">remind</span> <span class="o">=</span> <span class="n">remind</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k</span> <span class="o">=</span> <span class="n">k</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sample_size</span> <span class="o">=</span> <span class="n">sample_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sampling</span> <span class="o">=</span> <span class="n">sampling</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weighting</span> <span class="o">=</span> <span class="n">weighting</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">similarity</span> <span class="o">=</span> <span class="n">similarity</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pop_boost</span> <span class="o">=</span> <span class="n">pop_boost</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session_key</span> <span class="o">=</span> <span class="n">session_key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">item_key</span> <span class="o">=</span> <span class="n">item_key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time_key</span> <span class="o">=</span> <span class="n">time_key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extend</span> <span class="o">=</span> <span class="n">extend</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">normalize</span> <span class="o">=</span> <span class="n">normalize</span>

        <span class="c1"># updated while recommending</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session_items</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">relevant_sessions</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="c1"># cache relations once at startup</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session_item_map</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">item_session_map</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session_time</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sim_time</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">train</span><span class="p">,</span> <span class="n">items</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Trains the predictor.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        --------</span>
<span class="sd">        data: pandas.DataFrame</span>
<span class="sd">            Training data. It contains the transactions of the sessions. It has one column for session IDs, one for item IDs and one for the timestamp of the events (unix timestamps).</span>
<span class="sd">            It must have a header. Column names are arbitrary, but must correspond to the ones you set during the initialization of the network (session_key, item_key, time_key properties).</span>
<span class="sd">            </span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">index_session</span> <span class="o">=</span> <span class="n">train</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session_key</span><span class="p">)</span>
        <span class="n">index_item</span> <span class="o">=</span> <span class="n">train</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">item_key</span><span class="p">)</span>
        <span class="n">index_time</span> <span class="o">=</span> <span class="n">train</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time_key</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">itemids</span> <span class="o">=</span> <span class="n">train</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">item_key</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>

        <span class="n">session</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">session_items</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">time</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="c1"># cnt = 0</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">train</span><span class="o">.</span><span class="n">itertuples</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
            <span class="c1"># cache items of sessions</span>
            <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="n">index_session</span><span class="p">]</span> <span class="o">!=</span> <span class="n">session</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">session_items</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">session_item_map</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">session</span><span class="p">:</span> <span class="n">session_items</span><span class="p">})</span>
                    <span class="c1"># cache the last time stamp of the session</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">session_time</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">session</span><span class="p">:</span> <span class="n">time</span><span class="p">})</span>
                <span class="n">session</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">index_session</span><span class="p">]</span>
                <span class="n">session_items</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="n">time</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">index_time</span><span class="p">]</span>
            <span class="n">session_items</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">index_item</span><span class="p">])</span>

            <span class="c1"># cache sessions involving an item</span>
            <span class="n">map_is</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_session_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">index_item</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">map_is</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">map_is</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">item_session_map</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">row</span><span class="p">[</span><span class="n">index_item</span><span class="p">]:</span> <span class="n">map_is</span><span class="p">})</span>
            <span class="n">map_is</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">index_session</span><span class="p">])</span>

        <span class="c1"># Add the last tuple    </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session_item_map</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">session</span><span class="p">:</span> <span class="n">session_items</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session_time</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">session</span><span class="p">:</span> <span class="n">time</span><span class="p">})</span>

    <span class="k">def</span> <span class="nf">predict_next</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session_id</span><span class="p">,</span> <span class="n">input_item_id</span><span class="p">,</span> <span class="n">predict_for_item_ids</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">skip</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;view&#39;</span><span class="p">,</span> <span class="n">timestamp</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Gives predicton scores for a selected set of items on how likely they be the next item in the session.</span>
<span class="sd">                </span>
<span class="sd">        Parameters</span>
<span class="sd">        --------</span>
<span class="sd">        session_id : int or string</span>
<span class="sd">            The session IDs of the event.</span>
<span class="sd">        input_item_id : int or string</span>
<span class="sd">            The item ID of the event. Must be in the set of item IDs of the training set.</span>
<span class="sd">        predict_for_item_ids : 1D array</span>
<span class="sd">            IDs of items for which the network should give prediction scores. Every ID must be in the set of item IDs of the training set.</span>
<span class="sd">            </span>
<span class="sd">        Returns</span>
<span class="sd">        --------</span>
<span class="sd">        out : pandas.Series</span>
<span class="sd">            Prediction scores for selected items on how likely to be the next item of this session. Indexed by the item IDs.</span>
<span class="sd">        </span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="c1">#         gc.collect()</span>
        <span class="c1">#         process = psutil.Process(os.getpid())</span>
        <span class="c1">#         print( &#39;cknn.predict_next: &#39;, process.memory_info().rss, &#39; memory used&#39;)</span>

        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">!=</span> <span class="n">session_id</span><span class="p">):</span>  <span class="c1"># new session</span>

            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">extend</span><span class="p">):</span>
                <span class="n">item_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session_items</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">session_item_map</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">]</span> <span class="o">=</span> <span class="n">item_set</span>
                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">item_set</span><span class="p">:</span>
                    <span class="n">map_is</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_session_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">map_is</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">map_is</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">item_session_map</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">item</span><span class="p">:</span> <span class="n">map_is</span><span class="p">})</span>
                    <span class="n">map_is</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">)</span>

                <span class="n">ts</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">session_time</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">:</span> <span class="n">ts</span><span class="p">})</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">session_id</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">session_items</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">relevant_sessions</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;view&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">session_items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">input_item_id</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">skip</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">neighbors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_neighbors</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session_items</span><span class="p">),</span> <span class="n">input_item_id</span><span class="p">,</span> <span class="n">session_id</span><span class="p">)</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">score_items</span><span class="p">(</span><span class="n">neighbors</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_items</span><span class="p">)</span>

        <span class="c1"># add some reminders</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">remind</span><span class="p">:</span>

            <span class="n">reminderScore</span> <span class="o">=</span> <span class="mi">5</span>
            <span class="n">takeLastN</span> <span class="o">=</span> <span class="mi">3</span>

            <span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_items</span><span class="p">[</span><span class="o">-</span><span class="n">takeLastN</span><span class="p">:]:</span>
                <span class="n">cnt</span> <span class="o">=</span> <span class="n">cnt</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="c1"># reminderScore = reminderScore + (cnt/100)</span>

                <span class="n">oldScore</span> <span class="o">=</span> <span class="n">scores</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span>
                <span class="n">newScore</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="n">oldScore</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">newScore</span> <span class="o">=</span> <span class="n">reminderScore</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">newScore</span> <span class="o">=</span> <span class="n">oldScore</span> <span class="o">+</span> <span class="n">reminderScore</span>
                <span class="c1"># print &#39;old score &#39;, oldScore</span>
                <span class="c1"># update the score and add a small number for the position </span>
                <span class="n">newScore</span> <span class="o">=</span> <span class="p">(</span><span class="n">newScore</span> <span class="o">*</span> <span class="n">reminderScore</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>

                <span class="n">scores</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">elem</span><span class="p">:</span> <span class="n">newScore</span><span class="p">})</span>

        <span class="c1"># push popular ones</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pop_boost</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>

            <span class="n">pop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_pop</span><span class="p">(</span><span class="n">neighbors</span><span class="p">)</span>
            <span class="c1"># Iterate over the item neighbors</span>
            <span class="c1"># print itemScores</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">scores</span><span class="p">:</span>
                <span class="n">item_pop</span> <span class="o">=</span> <span class="n">pop</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="c1"># Gives some minimal MRR boost?</span>
                <span class="n">scores</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">key</span><span class="p">:</span> <span class="p">(</span><span class="n">scores</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pop_boost</span> <span class="o">*</span> <span class="n">item_pop</span><span class="p">))})</span>

        <span class="c1"># Create things in the format ..</span>
        <span class="k">if</span> <span class="n">predict_for_item_ids</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">predict_for_item_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">itemids</span>
        <span class="n">predictions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">predict_for_item_ids</span><span class="p">))</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">in1d</span><span class="p">(</span><span class="n">predict_for_item_ids</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">scores</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>

        <span class="n">items</span> <span class="o">=</span> <span class="n">predict_for_item_ids</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
        <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="n">scores</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">items</span><span class="p">]</span>
        <span class="n">predictions</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">values</span>
        <span class="n">series</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">predictions</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">predict_for_item_ids</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalize</span><span class="p">:</span>
            <span class="n">series</span> <span class="o">=</span> <span class="n">series</span> <span class="o">/</span> <span class="n">series</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">series</span>

    <span class="k">def</span> <span class="nf">item_pop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sessions</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Returns a dict(item,score) of the item popularity for the given list of sessions (only a set of ids)</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        --------</span>
<span class="sd">        sessions: set</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        --------</span>
<span class="sd">        out : dict            </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">max_pop</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">session</span><span class="p">,</span> <span class="n">weight</span> <span class="ow">in</span> <span class="n">sessions</span><span class="p">:</span>
            <span class="n">items</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">items_for_session</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>

                <span class="n">count</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">count</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">item</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">item</span><span class="p">:</span> <span class="n">count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">})</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_pop</span><span class="p">):</span>
                    <span class="n">max_pop</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">key</span><span class="p">:</span> <span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">/</span> <span class="n">max_pop</span><span class="p">)})</span>

        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">jaccard</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">first</span><span class="p">,</span> <span class="n">second</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Calculates the jaccard index for two sessions</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        --------</span>
<span class="sd">        first: Id of a session</span>
<span class="sd">        second: Id of a session</span>
<span class="sd">        </span>
<span class="sd">        Returns </span>
<span class="sd">        --------</span>
<span class="sd">        out : float value           </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">sc</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">clock</span><span class="p">()</span>
        <span class="n">intersection</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">first</span> <span class="o">&amp;</span> <span class="n">second</span><span class="p">)</span>
        <span class="n">union</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">first</span> <span class="o">|</span> <span class="n">second</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">intersection</span> <span class="o">/</span> <span class="n">union</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sim_time</span> <span class="o">+=</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">clock</span><span class="p">()</span> <span class="o">-</span> <span class="n">sc</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">res</span>

    <span class="k">def</span> <span class="nf">cosine</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">first</span><span class="p">,</span> <span class="n">second</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Calculates the cosine similarity for two sessions</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        --------</span>
<span class="sd">        first: Id of a session</span>
<span class="sd">        second: Id of a session</span>
<span class="sd">        </span>
<span class="sd">        Returns </span>
<span class="sd">        --------</span>
<span class="sd">        out : float value           </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">li</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">first</span> <span class="o">&amp;</span> <span class="n">second</span><span class="p">)</span>
        <span class="n">la</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">first</span><span class="p">)</span>
        <span class="n">lb</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">second</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">li</span> <span class="o">/</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">la</span><span class="p">)</span> <span class="o">*</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">lb</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">tanimoto</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">first</span><span class="p">,</span> <span class="n">second</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Calculates the cosine tanimoto similarity for two sessions</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        --------</span>
<span class="sd">        first: Id of a session</span>
<span class="sd">        second: Id of a session</span>
<span class="sd">        </span>
<span class="sd">        Returns </span>
<span class="sd">        --------</span>
<span class="sd">        out : float value           </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">li</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">first</span> <span class="o">&amp;</span> <span class="n">second</span><span class="p">)</span>
        <span class="n">la</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">first</span><span class="p">)</span>
        <span class="n">lb</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">second</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">li</span> <span class="o">/</span> <span class="p">(</span><span class="n">la</span> <span class="o">+</span> <span class="n">lb</span> <span class="o">-</span> <span class="n">li</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">binary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">first</span><span class="p">,</span> <span class="n">second</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Calculates the ? for 2 sessions</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        --------</span>
<span class="sd">        first: Id of a session</span>
<span class="sd">        second: Id of a session</span>
<span class="sd">        </span>
<span class="sd">        Returns </span>
<span class="sd">        --------</span>
<span class="sd">        out : float value           </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">a</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">first</span> <span class="o">&amp;</span> <span class="n">second</span><span class="p">)</span>
        <span class="n">b</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">first</span><span class="p">)</span>
        <span class="n">c</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">second</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">a</span><span class="p">)</span> <span class="o">/</span> <span class="p">((</span><span class="mi">2</span> <span class="o">*</span> <span class="n">a</span><span class="p">)</span> <span class="o">+</span> <span class="n">b</span> <span class="o">+</span> <span class="n">c</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">items_for_session</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Returns all items in the session</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        --------</span>
<span class="sd">        session: Id of a session</span>
<span class="sd">        </span>
<span class="sd">        Returns </span>
<span class="sd">        --------</span>
<span class="sd">        out : set           </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_item_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">session</span><span class="p">);</span>

    <span class="k">def</span> <span class="nf">sessions_for_item</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item_id</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Returns all session for an item</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        --------</span>
<span class="sd">        item: Id of the item session</span>
<span class="sd">        </span>
<span class="sd">        Returns </span>
<span class="sd">        --------</span>
<span class="sd">        out : set           </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_session_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">item_id</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">most_recent_sessions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sessions</span><span class="p">,</span> <span class="n">number</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Find the most recent sessions in the given set</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        --------</span>
<span class="sd">        sessions: set of session ids</span>
<span class="sd">        </span>
<span class="sd">        Returns </span>
<span class="sd">        --------</span>
<span class="sd">        out : set           </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">sample</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="n">tuples</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">session</span> <span class="ow">in</span> <span class="n">sessions</span><span class="p">:</span>
            <span class="n">time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_time</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">time</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; EMPTY TIMESTAMP!! &#39;</span><span class="p">,</span> <span class="n">session</span><span class="p">)</span>
            <span class="n">tuples</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">session</span><span class="p">,</span> <span class="n">time</span><span class="p">))</span>

        <span class="n">tuples</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">tuples</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">itemgetter</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># print &#39;sorted list &#39;, sortedList</span>
        <span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">tuples</span><span class="p">:</span>
            <span class="n">cnt</span> <span class="o">=</span> <span class="n">cnt</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">cnt</span> <span class="o">&gt;</span> <span class="n">number</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">sample</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">element</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="c1"># print &#39;returning sample of size &#39;, len(sample)</span>
        <span class="k">return</span> <span class="n">sample</span>

    <span class="k">def</span> <span class="nf">possible_neighbor_sessions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session_items</span><span class="p">,</span> <span class="n">input_item_id</span><span class="p">,</span> <span class="n">session_id</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Find a set of session to later on find neighbors in.</span>
<span class="sd">        A self.sample_size of 0 uses all sessions in which any item of the current session appears.</span>
<span class="sd">        self.sampling can be performed with the options &quot;recent&quot; or &quot;random&quot;.</span>
<span class="sd">        &quot;recent&quot; selects the self.sample_size most recent sessions while &quot;random&quot; just choses randomly. </span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        --------</span>
<span class="sd">        sessions: set of session ids</span>
<span class="sd">        </span>
<span class="sd">        Returns </span>
<span class="sd">        --------</span>
<span class="sd">        out : set           </span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">relevant_sessions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relevant_sessions</span> <span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">sessions_for_item</span><span class="p">(</span><span class="n">input_item_id</span><span class="p">);</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># use all session as possible neighbors</span>

            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;!!!!! runnig KNN without a sample size (check config)&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">relevant_sessions</span>

        <span class="k">else</span><span class="p">:</span>  <span class="c1"># sample some sessions</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">relevant_sessions</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_size</span><span class="p">:</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sampling</span> <span class="o">==</span> <span class="s1">&#39;recent&#39;</span><span class="p">:</span>
                    <span class="n">sample</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">most_recent_sessions</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">relevant_sessions</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_size</span><span class="p">)</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">sampling</span> <span class="o">==</span> <span class="s1">&#39;random&#39;</span><span class="p">:</span>
                    <span class="n">sample</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">relevant_sessions</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_size</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">sample</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relevant_sessions</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_size</span><span class="p">]</span>

                <span class="k">return</span> <span class="n">sample</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">relevant_sessions</span>

    <span class="k">def</span> <span class="nf">calc_similarity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session_items</span><span class="p">,</span> <span class="n">sessions</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Calculates the configured similarity for the items in session_items and each session in sessions.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        --------</span>
<span class="sd">        session_items: set of item ids</span>
<span class="sd">        sessions: list of session ids</span>
<span class="sd">        </span>
<span class="sd">        Returns </span>
<span class="sd">        --------</span>
<span class="sd">        out : list of tuple (session_id,similarity)           </span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="c1"># print &#39;nb of sessions to test &#39;, len(sessionsToTest), &#39; metric: &#39;, self.metric</span>
        <span class="n">neighbors</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">session</span> <span class="ow">in</span> <span class="n">sessions</span><span class="p">:</span>
            <span class="n">cnt</span> <span class="o">=</span> <span class="n">cnt</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="c1"># get items of the session, look up the cache first </span>
            <span class="n">session_items_test</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">items_for_session</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>

            <span class="n">similarity</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">similarity</span><span class="p">)(</span><span class="n">session_items_test</span><span class="p">,</span> <span class="n">session_items</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">similarity</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">neighbors</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">session</span><span class="p">,</span> <span class="n">similarity</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">neighbors</span>

    <span class="c1"># -----------------</span>
    <span class="c1"># Find a set of neighbors, returns a list of tuples (sessionid: similarity) </span>
    <span class="c1"># -----------------</span>
    <span class="k">def</span> <span class="nf">find_neighbors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session_items</span><span class="p">,</span> <span class="n">input_item_id</span><span class="p">,</span> <span class="n">session_id</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Finds the k nearest neighbors for the given session_id and the current item input_item_id. </span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        --------</span>
<span class="sd">        session_items: set of item ids</span>
<span class="sd">        input_item_id: int </span>
<span class="sd">        session_id: int</span>
<span class="sd">        </span>
<span class="sd">        Returns </span>
<span class="sd">        --------</span>
<span class="sd">        out : list of tuple (session_id, similarity)           </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">possible_neighbors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">possible_neighbor_sessions</span><span class="p">(</span><span class="n">session_items</span><span class="p">,</span> <span class="n">input_item_id</span><span class="p">,</span> <span class="n">session_id</span><span class="p">)</span>
        <span class="n">possible_neighbors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_similarity</span><span class="p">(</span><span class="n">session_items</span><span class="p">,</span> <span class="n">possible_neighbors</span><span class="p">)</span>

        <span class="n">possible_neighbors</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">possible_neighbors</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">possible_neighbors</span> <span class="o">=</span> <span class="n">possible_neighbors</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">possible_neighbors</span>

    <span class="k">def</span> <span class="nf">score_items</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">neighbors</span><span class="p">,</span> <span class="n">current_session</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Compute a set of scores for all items given a set of neighbors.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        --------</span>
<span class="sd">        neighbors: set of session ids</span>
<span class="sd">        </span>
<span class="sd">        Returns </span>
<span class="sd">        --------</span>
<span class="sd">        out : list of tuple (item, score)           </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># now we have the set of relevant items to make predictions</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="c1"># iterate over the sessions</span>
        <span class="k">for</span> <span class="n">session</span> <span class="ow">in</span> <span class="n">neighbors</span><span class="p">:</span>
            <span class="c1"># get the items in this session</span>
            <span class="n">items</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">items_for_session</span><span class="p">(</span><span class="n">session</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">step</span> <span class="o">=</span> <span class="mi">1</span>

            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">current_session</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
                    <span class="n">decay</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">weighting</span><span class="p">)(</span><span class="n">step</span><span class="p">)</span>
                    <span class="k">break</span>
                <span class="n">step</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
                <span class="n">old_score</span> <span class="o">=</span> <span class="n">scores</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                <span class="n">similarity</span> <span class="o">=</span> <span class="n">session</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">old_score</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">scores</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">item</span><span class="p">:</span> <span class="p">(</span><span class="n">similarity</span> <span class="o">*</span> <span class="n">decay</span><span class="p">)})</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">new_score</span> <span class="o">=</span> <span class="n">old_score</span> <span class="o">+</span> <span class="p">(</span><span class="n">similarity</span> <span class="o">*</span> <span class="n">decay</span><span class="p">)</span>
                    <span class="n">scores</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">item</span><span class="p">:</span> <span class="n">new_score</span><span class="p">})</span>

        <span class="k">return</span> <span class="n">scores</span>

    <span class="k">def</span> <span class="nf">linear</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="mf">0.1</span> <span class="o">*</span> <span class="n">i</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">100</span> <span class="k">else</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">same</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">div</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">i</span>

    <span class="k">def</span> <span class="nf">log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">log10</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mf">1.7</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">quadratic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="n">i</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">KNNRecommender</span><span class="p">(</span><span class="n">ISeqRecommender</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Interface to ItemKNN and Session-based KNN methods. Based on:</span>

<span class="sd">    Evaluation of Session-based Recommendation Algorithms, Malte Ludewig and Dietmar Jannach</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">knn_models</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;iknn&#39;</span><span class="p">:</span> <span class="n">ItemKNN</span><span class="p">,</span>
        <span class="s1">&#39;sknn&#39;</span><span class="p">:</span> <span class="n">SessionKNN</span><span class="p">,</span>
        <span class="s1">&#39;v-sknn&#39;</span><span class="p">:</span> <span class="n">VMSessionKNN</span><span class="p">,</span>
        <span class="s1">&#39;s-sknn&#39;</span><span class="p">:</span> <span class="n">SeqSessionKNN</span><span class="p">,</span>
        <span class="s1">&#39;sf-sknn&#39;</span><span class="p">:</span> <span class="n">SeqFilterSessionKNN</span>
    <span class="p">}</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">model</span><span class="o">=</span><span class="s1">&#39;cknn&#39;</span><span class="p">,</span>
                 <span class="o">**</span><span class="n">init_args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param model: One among the following KNN models:</span>
<span class="sd">            - iknn: ItemKNN, item-to-item KNN based on the *last* item in the session to determine the items to be recommended.</span>
<span class="sd">            - sknn: SessionKNN, compares the *entire* current session with the past sessions in the training data to</span>
<span class="sd">                    determine the items to be recommended.</span>
<span class="sd">            - v-sknn: VMSessionKNN, use linearly decayed real-valued vectors to encode the current session,</span>
<span class="sd">                    then compares the current session with the past sessions in the training data using the dot-product</span>
<span class="sd">                    to determine the items to be recommended.</span>
<span class="sd">            - s-sknn: SeqSessionKNN, this variant also puts more weight on elements that appear later in the session by</span>
<span class="sd">                using a custom scoring function (see the paper by Ludewng and Jannach).</span>
<span class="sd">            - sf-sknn: SeqFilterSessionKNN, this variant also puts more weight on elements that appear later in the session</span>
<span class="sd">                in a more restrictive way by using a custom scoring function (see the paper by Ludewng and Jannach).</span>

<span class="sd">        :param init_args: The model initialization arguments. See the following initializations or</span>
<span class="sd">            check `util.knn` for more details on each model:</span>
<span class="sd">            - iknn: ItemKNN(n_sims=100, lmbd=20, alpha=0.5)</span>
<span class="sd">            - sknn: SessionKNN(k, sample_size=500, sampling=&#39;recent&#39;, similarity=&#39;jaccard&#39;, remind=False, pop_boost=0)</span>
<span class="sd">            - v-sknn: VMSessionKNN(k, sample_size=1000, sampling=&#39;recent&#39;, similarity=&#39;cosine&#39;, weighting=&#39;div&#39;,</span>
<span class="sd">                 dwelling_time=False, last_n_days=None, last_n_clicks=None, extend=False, weighting_score=&#39;div_score&#39;,</span>
<span class="sd">                 weighting_time=False, normalize=True)</span>
<span class="sd">            - s-knn: SeqSessionKNN(k, sample_size=1000, sampling=&#39;recent&#39;, similarity=&#39;jaccard&#39;, weighting=&#39;div&#39;,</span>
<span class="sd">                remind=False, pop_boost=0, extend=False, normalize=True)</span>
<span class="sd">            - sf-sknn: SeqFilterSessionKNN(k, sample_size=1000, sampling=&#39;recent&#39;, similarity=&#39;jaccard&#39;, remind=False, pop_boost=0,</span>
<span class="sd">                 extend=False, normalize=True)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">KNNRecommender</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">model</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">knn_models</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unknown KNN model &#39;</span><span class="si">{}</span><span class="s2">&#39;. The available ones are: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">model</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">knn_models</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_args</span> <span class="o">=</span> <span class="n">init_args</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_args</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">session_key</span><span class="o">=</span><span class="s1">&#39;session_id&#39;</span><span class="p">,</span>
                                   <span class="n">item_key</span><span class="o">=</span><span class="s1">&#39;item_id&#39;</span><span class="p">,</span>
                                   <span class="n">time_key</span><span class="o">=</span><span class="s1">&#39;ts&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">knn_models</span><span class="p">[</span><span class="n">model</span><span class="p">](</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">init_args</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pseudo_session_id</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">train_data</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Converting training data to GRU4Rec format&#39;</span><span class="p">)</span>
        <span class="c1"># parse training data to GRU4Rec format</span>
        <span class="n">train_data</span> <span class="o">=</span> <span class="n">dataset_to_gru4rec_format</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="n">train_data</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Training started&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Training completed&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pseudo_session_id</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">recommend</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_profile</span><span class="p">,</span> <span class="n">user_id</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">user_profile</span><span class="p">:</span>
            <span class="n">pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict_next</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pseudo_session_id</span><span class="p">,</span>
                                           <span class="n">input_item_id</span><span class="o">=</span><span class="n">item</span><span class="p">)</span>
        <span class="c1"># sort items by predicted score</span>
        <span class="n">pred</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># increase the psuedo-session id so that future call to recommend() won&#39;t be connected</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pseudo_session_id</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="c1"># convert to the required output format</span>
        <span class="k">return</span> <span class="p">[([</span><span class="n">x</span><span class="o">.</span><span class="n">index</span><span class="p">],</span> <span class="n">x</span><span class="o">.</span><span class="n">_2</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">pred</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">itertuples</span><span class="p">()]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">knnrecommender</span> <span class="o">=</span> <span class="n">KNNRecommender</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="s1">&#39;sknn&#39;</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">knnrecommender</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_data</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2021-04-25 14:10:51,373 - INFO - Converting training data to GRU4Rec format
2021-04-25 14:10:51,398 - INFO - Training started
2021-04-25 14:10:51,429 - INFO - Training completed
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="sequential-evaluation">
<h2>Sequential Evaluation<a class="headerlink" href="#sequential-evaluation" title="Permalink to this headline">¶</a></h2>
<p>In the evaluation of sequence-aware recommenders, each sequence in the test set is split into:</p>
<ul class="simple">
<li><p>the <em>user profile</em>, used to compute recommendations, is composed by the first <em>k</em> events in the sequence;</p></li>
<li><p>the <em>ground truth</em>, used for performance evaluation, is composed by the remainder of the sequence.</p></li>
</ul>
<p>In the cells below, you can control the dimension of the <em>user profile</em> by assigning a <strong>positive</strong> value to <code class="docutils literal notranslate"><span class="pre">GIVEN_K</span></code>, which correspond to the number of events from the beginning of the sequence that will be assigned to the initial user profile. This ensures that each user profile in the test set will have exactly the same initial size, but the size of the ground truth will change for every sequence.</p>
<p>Alternatively, by assigning a <strong>negative</strong> value to <code class="docutils literal notranslate"><span class="pre">GIVEN_K</span></code>, you will set the initial size of the <em>ground truth</em>. In this way the <em>ground truth</em> will have the same size for all sequences, but the dimension of the user profile will differ.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">precision</span><span class="p">(</span><span class="n">ground_truth</span><span class="p">,</span> <span class="n">prediction</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute Precision metric</span>
<span class="sd">    :param ground_truth: the ground truth set or sequence</span>
<span class="sd">    :param prediction: the predicted set or sequence</span>
<span class="sd">    :return: the value of the metric</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ground_truth</span> <span class="o">=</span> <span class="n">remove_duplicates</span><span class="p">(</span><span class="n">ground_truth</span><span class="p">)</span>
    <span class="n">prediction</span> <span class="o">=</span> <span class="n">remove_duplicates</span><span class="p">(</span><span class="n">prediction</span><span class="p">)</span>
    <span class="n">precision_score</span> <span class="o">=</span> <span class="n">count_a_in_b_unique</span><span class="p">(</span><span class="n">prediction</span><span class="p">,</span> <span class="n">ground_truth</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">prediction</span><span class="p">))</span>
    <span class="k">assert</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">precision_score</span> <span class="o">&lt;=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">precision_score</span>


<span class="k">def</span> <span class="nf">recall</span><span class="p">(</span><span class="n">ground_truth</span><span class="p">,</span> <span class="n">prediction</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute Recall metric</span>
<span class="sd">    :param ground_truth: the ground truth set or sequence</span>
<span class="sd">    :param prediction: the predicted set or sequence</span>
<span class="sd">    :return: the value of the metric</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ground_truth</span> <span class="o">=</span> <span class="n">remove_duplicates</span><span class="p">(</span><span class="n">ground_truth</span><span class="p">)</span>
    <span class="n">prediction</span> <span class="o">=</span> <span class="n">remove_duplicates</span><span class="p">(</span><span class="n">prediction</span><span class="p">)</span>
    <span class="n">recall_score</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">prediction</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">count_a_in_b_unique</span><span class="p">(</span><span class="n">prediction</span><span class="p">,</span> <span class="n">ground_truth</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span>
        <span class="nb">len</span><span class="p">(</span><span class="n">ground_truth</span><span class="p">))</span>
    <span class="k">assert</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">recall_score</span> <span class="o">&lt;=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">recall_score</span>


<span class="k">def</span> <span class="nf">mrr</span><span class="p">(</span><span class="n">ground_truth</span><span class="p">,</span> <span class="n">prediction</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute Mean Reciprocal Rank metric. Reciprocal Rank is set 0 if no predicted item is in contained the ground truth.</span>
<span class="sd">    :param ground_truth: the ground truth set or sequence</span>
<span class="sd">    :param prediction: the predicted set or sequence</span>
<span class="sd">    :return: the value of the metric</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rr</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="k">for</span> <span class="n">rank</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">prediction</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">ground_truth</span><span class="p">:</span>
            <span class="n">rr</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">/</span> <span class="p">(</span><span class="n">rank</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">break</span>
    <span class="k">return</span> <span class="n">rr</span>


<span class="k">def</span> <span class="nf">count_a_in_b_unique</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :param a: list of lists</span>
<span class="sd">    :param b: list of lists</span>
<span class="sd">    :return: number of elements of a in b</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">a</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">b</span><span class="p">:</span>
            <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">count</span>


<span class="k">def</span> <span class="nf">remove_duplicates</span><span class="p">(</span><span class="n">l</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">l</span><span class="p">)]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">METRICS</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;precision&#39;</span><span class="p">:</span><span class="n">precision</span><span class="p">,</span> 
           <span class="s1">&#39;recall&#39;</span><span class="p">:</span><span class="n">recall</span><span class="p">,</span>
           <span class="s1">&#39;mrr&#39;</span><span class="p">:</span> <span class="n">mrr</span><span class="p">}</span>
<span class="n">TOPN</span><span class="o">=</span><span class="mi">100</span> <span class="c1"># length of the recommendation list</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">sequential_evaluation</span><span class="p">(</span><span class="n">recommender</span><span class="p">,</span>
                          <span class="n">test_sequences</span><span class="p">,</span>
                          <span class="n">evaluation_functions</span><span class="p">,</span>
                          <span class="n">users</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                          <span class="n">given_k</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">look_ahead</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">top_n</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                          <span class="n">scroll</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                          <span class="n">step</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Runs sequential evaluation of a recommender over a set of test sequences</span>
<span class="sd">    :param recommender: the instance of the recommender to test</span>
<span class="sd">    :param test_sequences: the set of test sequences</span>
<span class="sd">    :param evaluation_functions: list of evaluation metric functions</span>
<span class="sd">    :param users: (optional) the list of user ids associated to each test sequence. Required by personalized models like FPMC.</span>
<span class="sd">    :param given_k: (optional) the initial size of each user profile, starting from the first interaction in the sequence.</span>
<span class="sd">                    If &lt;0, start counting from the end of the sequence. It must be != 0.</span>
<span class="sd">    :param look_ahead: (optional) number of subsequent interactions in the sequence to be considered as ground truth.</span>
<span class="sd">                    It can be any positive number or &#39;all&#39; to extend the ground truth until the end of the sequence.</span>
<span class="sd">    :param top_n: (optional) size of the recommendation list</span>
<span class="sd">    :param scroll: (optional) whether to scroll the ground truth until the end of the sequence.</span>
<span class="sd">                If True, expand the user profile and move the ground truth forward of `step` interactions. Recompute and evaluate recommendations every time.</span>
<span class="sd">                If False, evaluate recommendations once per sequence without expanding the user profile.</span>
<span class="sd">    :param step: (optional) number of interactions that will be added to the user profile at each step of the sequential evaluation.</span>
<span class="sd">    :return: the list of the average values for each evaluation metric</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">given_k</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;given_k must be != 0&#39;</span><span class="p">)</span>

    <span class="n">metrics</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">evaluation_functions</span><span class="p">))</span>
    <span class="k">with</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">test_sequences</span><span class="p">))</span> <span class="k">as</span> <span class="n">pbar</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">test_seq</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">test_sequences</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">users</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">user</span> <span class="o">=</span> <span class="n">users</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">user</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">scroll</span><span class="p">:</span>
                <span class="n">metrics</span> <span class="o">+=</span> <span class="n">sequence_sequential_evaluation</span><span class="p">(</span><span class="n">recommender</span><span class="p">,</span>
                                                          <span class="n">test_seq</span><span class="p">,</span>
                                                          <span class="n">evaluation_functions</span><span class="p">,</span>
                                                          <span class="n">user</span><span class="p">,</span>
                                                          <span class="n">given_k</span><span class="p">,</span>
                                                          <span class="n">look_ahead</span><span class="p">,</span>
                                                          <span class="n">top_n</span><span class="p">,</span>
                                                          <span class="n">step</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">metrics</span> <span class="o">+=</span> <span class="n">evaluate_sequence</span><span class="p">(</span><span class="n">recommender</span><span class="p">,</span>
                                             <span class="n">test_seq</span><span class="p">,</span>
                                             <span class="n">evaluation_functions</span><span class="p">,</span>
                                             <span class="n">user</span><span class="p">,</span>
                                             <span class="n">given_k</span><span class="p">,</span>
                                             <span class="n">look_ahead</span><span class="p">,</span>
                                             <span class="n">top_n</span><span class="p">)</span>
            <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">metrics</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_sequences</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">evaluate_sequence</span><span class="p">(</span><span class="n">recommender</span><span class="p">,</span> <span class="n">seq</span><span class="p">,</span> <span class="n">evaluation_functions</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">given_k</span><span class="p">,</span> <span class="n">look_ahead</span><span class="p">,</span> <span class="n">top_n</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :param recommender: which recommender to use</span>
<span class="sd">    :param seq: the user_profile/ context</span>
<span class="sd">    :param given_k: last element used as ground truth. NB if &lt;0 it is interpreted as first elements to keep</span>
<span class="sd">    :param evaluation_functions: which function to use to evaluate the rec performance</span>
<span class="sd">    :param look_ahead: number of elements in ground truth to consider. if look_ahead = &#39;all&#39; then all the ground_truth sequence is considered</span>
<span class="sd">    :return: performance of recommender</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># safety checks</span>
    <span class="k">if</span> <span class="n">given_k</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">given_k</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">seq</span><span class="p">)</span> <span class="o">+</span> <span class="n">given_k</span>

    <span class="n">user_profile</span> <span class="o">=</span> <span class="n">seq</span><span class="p">[:</span><span class="n">given_k</span><span class="p">]</span>
    <span class="n">ground_truth</span> <span class="o">=</span> <span class="n">seq</span><span class="p">[</span><span class="n">given_k</span><span class="p">:]</span>

    <span class="c1"># restrict ground truth to look_ahead</span>
    <span class="n">ground_truth</span> <span class="o">=</span> <span class="n">ground_truth</span><span class="p">[:</span><span class="n">look_ahead</span><span class="p">]</span> <span class="k">if</span> <span class="n">look_ahead</span> <span class="o">!=</span> <span class="s1">&#39;all&#39;</span> <span class="k">else</span> <span class="n">ground_truth</span>
    <span class="n">ground_truth</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="n">ground_truth</span><span class="p">))</span>  <span class="c1"># list of list format</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">user_profile</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">ground_truth</span><span class="p">:</span>
        <span class="c1"># if any of the two missing all evaluation functions are 0</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">evaluation_functions</span><span class="p">))</span>

    <span class="n">r</span> <span class="o">=</span> <span class="n">recommender</span><span class="o">.</span><span class="n">recommend</span><span class="p">(</span><span class="n">user_profile</span><span class="p">,</span> <span class="n">user</span><span class="p">)[:</span><span class="n">top_n</span><span class="p">]</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">r</span><span class="p">:</span>
        <span class="c1"># no recommendation found</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">evaluation_functions</span><span class="p">))</span>
    <span class="n">reco_list</span> <span class="o">=</span> <span class="n">recommender</span><span class="o">.</span><span class="n">get_recommendation_list</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>

    <span class="n">tmp_results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">evaluation_functions</span><span class="p">:</span>
        <span class="n">tmp_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">(</span><span class="n">ground_truth</span><span class="p">,</span> <span class="n">reco_list</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">tmp_results</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">sequence_sequential_evaluation</span><span class="p">(</span><span class="n">recommender</span><span class="p">,</span> <span class="n">seq</span><span class="p">,</span> <span class="n">evaluation_functions</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">given_k</span><span class="p">,</span> <span class="n">look_ahead</span><span class="p">,</span> <span class="n">top_n</span><span class="p">,</span> <span class="n">step</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">given_k</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">given_k</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">seq</span><span class="p">)</span> <span class="o">+</span> <span class="n">given_k</span>

    <span class="n">eval_res</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">eval_cnt</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">gk</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">given_k</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">seq</span><span class="p">),</span> <span class="n">step</span><span class="p">):</span>
        <span class="n">eval_res</span> <span class="o">+=</span> <span class="n">evaluate_sequence</span><span class="p">(</span><span class="n">recommender</span><span class="p">,</span> <span class="n">seq</span><span class="p">,</span> <span class="n">evaluation_functions</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">gk</span><span class="p">,</span> <span class="n">look_ahead</span><span class="p">,</span> <span class="n">top_n</span><span class="p">)</span>
        <span class="n">eval_cnt</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">eval_res</span> <span class="o">/</span> <span class="n">eval_cnt</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="evaluation-with-sequentially-revealed-user-profiles">
<h3>Evaluation with sequentially revealed user-profiles<a class="headerlink" href="#evaluation-with-sequentially-revealed-user-profiles" title="Permalink to this headline">¶</a></h3>
<p>Here we evaluate the quality of the recommendations in a setting in which user profiles are revealed <em>sequentially</em>.</p>
<p>The <em>user profile</em> starts from the first <code class="docutils literal notranslate"><span class="pre">GIVEN_K</span></code> events (or, alternatively, from the last <code class="docutils literal notranslate"><span class="pre">-GIVEN_K</span></code> events if <code class="docutils literal notranslate"><span class="pre">GIVEN_K&lt;0</span></code>).<br />
The recommendations are evaluated against the next <code class="docutils literal notranslate"><span class="pre">LOOK_AHEAD</span></code> events (the <em>ground truth</em>).<br />
The <em>user profile</em> is next expanded to the next <code class="docutils literal notranslate"><span class="pre">STEP</span></code> events, the ground truth is scrolled forward accordingly, and the evaluation continues until the sequence ends.</p>
<p>In typical <strong>next-item recommendation</strong>, we start with <code class="docutils literal notranslate"><span class="pre">GIVEN_K=1</span></code>, generate a set of <strong>alternatives</strong> that will evaluated against the next event in the sequence (<code class="docutils literal notranslate"><span class="pre">LOOK_AHEAD=1</span></code>), move forward of one step (<code class="docutils literal notranslate"><span class="pre">STEP=1</span></code>) and repeat until the sequence ends.</p>
<p>You can set the <code class="docutils literal notranslate"><span class="pre">LOOK_AHEAD='all'</span></code> to see what happens if you had to recommend a <strong>whole sequence</strong> instead of a set of a set of alternatives to a user.</p>
<p>NOTE: Metrics are averaged over each sequence first, then averaged over all test sequences.</p>
<img src='https://www.notion.so/image/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F4b67fedc-22b5-4445-ad22-49e32f9445e6%2FUntitled.png?table=block&id=e35f084b-10b0-47d4-bd59-c336f459217d&spaceId=63b72b1f-0e90-4ab8-a6df-a060a6545a56&width=2000&userId=21ec183f-f0be-4b6b-9b3e-6f0d4e5c5469&cache=v2'><p>GIVEN_K=1, LOOK_AHEAD=1, STEP=1 corresponds to the classical next-item evaluation</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">eval_seqreveal</span><span class="p">(</span><span class="n">recommender</span><span class="p">,</span> <span class="n">user_flg</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
  <span class="n">GIVEN_K</span> <span class="o">=</span> <span class="mi">1</span>
  <span class="n">LOOK_AHEAD</span> <span class="o">=</span> <span class="mi">1</span>
  <span class="n">STEP</span><span class="o">=</span><span class="mi">1</span>

  <span class="k">if</span> <span class="n">user_flg</span><span class="p">:</span>
    <span class="n">test_sequences</span><span class="p">,</span> <span class="n">test_users</span> <span class="o">=</span> <span class="n">get_test_sequences_and_users</span><span class="p">(</span><span class="n">test_data</span><span class="p">,</span> <span class="n">GIVEN_K</span><span class="p">,</span> <span class="n">train_data</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span> <span class="c1"># we need user ids now!</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> sequences available for evaluation (</span><span class="si">{}</span><span class="s1"> users)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">test_sequences</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">test_users</span><span class="p">))))</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">sequential_evaluation</span><span class="p">(</span><span class="n">recommender</span><span class="p">,</span>
                                           <span class="n">test_sequences</span><span class="o">=</span><span class="n">test_sequences</span><span class="p">,</span>
                                           <span class="n">users</span><span class="o">=</span><span class="n">test_users</span><span class="p">,</span>
                                           <span class="n">given_k</span><span class="o">=</span><span class="n">GIVEN_K</span><span class="p">,</span>
                                           <span class="n">look_ahead</span><span class="o">=</span><span class="n">LOOK_AHEAD</span><span class="p">,</span>
                                           <span class="n">evaluation_functions</span><span class="o">=</span><span class="n">METRICS</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span>
                                           <span class="n">top_n</span><span class="o">=</span><span class="n">TOPN</span><span class="p">,</span>
                                           <span class="n">scroll</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># scrolling averages metrics over all profile lengths</span>
                                           <span class="n">step</span><span class="o">=</span><span class="n">STEP</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">test_sequences</span> <span class="o">=</span> <span class="n">get_test_sequences</span><span class="p">(</span><span class="n">test_data</span><span class="p">,</span> <span class="n">GIVEN_K</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> sequences available for evaluation&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">test_sequences</span><span class="p">)))</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">sequential_evaluation</span><span class="p">(</span><span class="n">recommender</span><span class="p">,</span>
                                           <span class="n">test_sequences</span><span class="o">=</span><span class="n">test_sequences</span><span class="p">,</span>
                                           <span class="n">given_k</span><span class="o">=</span><span class="n">GIVEN_K</span><span class="p">,</span>
                                           <span class="n">look_ahead</span><span class="o">=</span><span class="n">LOOK_AHEAD</span><span class="p">,</span>
                                           <span class="n">evaluation_functions</span><span class="o">=</span><span class="n">METRICS</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span>
                                           <span class="n">top_n</span><span class="o">=</span><span class="n">TOPN</span><span class="p">,</span>
                                           <span class="n">scroll</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># scrolling averages metrics over all profile lengths</span>
                                           <span class="n">step</span><span class="o">=</span><span class="n">STEP</span><span class="p">)</span>


  
  <span class="c1"># print(&#39;Sequential evaluation (GIVEN_K={}, LOOK_AHEAD={}, STEP={})&#39;.format(GIVEN_K, LOOK_AHEAD, STEP))</span>
  <span class="c1"># for mname, mvalue in zip(METRICS.keys(), results):</span>
  <span class="c1">#     print(&#39;\t{}@{}: {:.4f}&#39;.format(mname, TOPN, mvalue))</span>
  <span class="k">return</span> <span class="p">[</span><span class="n">results</span><span class="p">,</span> <span class="n">GIVEN_K</span><span class="p">,</span> <span class="n">LOOK_AHEAD</span><span class="p">,</span> <span class="n">STEP</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<img src='https://www.notion.so/image/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2Fd7873215-bcd2-4e0e-a48c-ac28feb4f208%2FUntitled.png?table=block&id=527b67cd-0771-4848-94d6-c6be9b208ebf&spaceId=63b72b1f-0e90-4ab8-a6df-a060a6545a56&width=2000&userId=21ec183f-f0be-4b6b-9b3e-6f0d4e5c5469&cache=v2'><div class="section" id="logging">
<h4>Logging<a class="headerlink" href="#logging" title="Permalink to this headline">¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="p">[</span><span class="n">poprecommender</span><span class="p">,</span> <span class="n">fsmrecommender</span><span class="p">,</span>  <span class="n">mmcrecommender</span><span class="p">,</span> <span class="n">p2vrecommender</span><span class="p">,</span>
              <span class="n">rnnrecommender</span><span class="p">,</span> <span class="n">fpmcrecommender</span><span class="p">,</span> <span class="n">prnnrecommender</span><span class="p">,</span>
              <span class="p">]:</span>
  <span class="k">if</span> <span class="n">model</span> <span class="ow">in</span> <span class="p">[</span><span class="n">fpmcrecommender</span><span class="p">,</span> <span class="n">prnnrecommender</span><span class="p">]:</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">eval_seqreveal</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">user_flg</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1"># results = eval_staticprofile(model, user_flg=1)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">eval_seqreveal</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>

  <span class="n">wandb</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;seqreveal-&#39;</span><span class="o">+</span><span class="nb">type</span><span class="p">(</span><span class="n">model</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> 
           <span class="n">project</span><span class="o">=</span><span class="s1">&#39;SARS Music30 x1&#39;</span><span class="p">,</span>
           <span class="n">notes</span><span class="o">=</span><span class="s1">&#39;sequentially revelaed user profile evaluation&#39;</span><span class="p">,</span> 
           <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;sequence&#39;</span><span class="p">,</span> <span class="s1">&#39;music&#39;</span><span class="p">,</span> <span class="s1">&#39;seqreveal&#39;</span><span class="p">])</span>
  <span class="n">wandb</span><span class="o">.</span><span class="n">log</span><span class="p">({</span>
      <span class="s2">&quot;Model&quot;</span><span class="p">:</span> <span class="nb">type</span><span class="p">(</span><span class="n">model</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
      <span class="s2">&quot;GIVEN_K&quot;</span><span class="p">:</span> <span class="n">results</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
      <span class="s2">&quot;LOOK_AHEAD&quot;</span><span class="p">:</span> <span class="n">results</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
      <span class="s2">&quot;STEP&quot;</span><span class="p">:</span> <span class="n">results</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
      <span class="s2">&quot;Precision@100&quot;</span><span class="p">:</span> <span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
      <span class="s2">&quot;Recall@100&quot;</span><span class="p">:</span> <span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
      <span class="s2">&quot;MRR@100&quot;</span><span class="p">:</span> <span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span>
      <span class="p">})</span>
</pre></div>
</div>
</div>
</div>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Run summary:

Model	Prod2VecRecommender
GIVEN_K	1
LOOK_AHEAD	1
STEP	1
Precision@100	0.01922
Recall@100	0.28801
MRR@100	0.10133
_runtime	144
_timestamp	1619363510
_step	3
Run history:

GIVEN_K	▁▁▁▁
LOOK_AHEAD	▁▁▁▁
STEP	▁▁▁▁
Precision@100	▁█▆▄
Recall@100	▂▁█▅
MRR@100	▁▅█▆
_runtime	▁▅▅█
_timestamp	▁▅▅█
_step	▁▃▆█

Synced 5 W&amp;B file(s), 0 media file(s), 0 artifact file(s) and 0 other file(s)

Synced seqreveal: https://wandb.ai/sparsh121/SARS%20Music30/runs/3gg65exl
...Successfully finished last run (ID:3gg65exl). Initializing new run:

Tracking run with wandb version 0.10.27
Syncing run seqreveal-PopularityRecommender to Weights &amp; Biases (Documentation).
Project page: https://wandb.ai/sparsh121/SARS%20Music30%20x1
Run page: https://wandb.ai/sparsh121/SARS%20Music30%20x1/runs/3maoqo8c
Run data is saved locally in /content/wandb/run-20210425_153508-3maoqo8c

  1%|          | 19/2891 [00:00&lt;00:15, 189.65it/s]2891 sequences available for evaluation
100%|██████████| 2891/2891 [00:17&lt;00:00, 163.97it/s]
Finishing last run (ID:3maoqo8c) before initializing another...

Waiting for W&amp;B process to finish, PID 1516
Program ended successfully.
0.01MB of 0.01MB uploaded (0.00MB deduped)
Find user logs for this run at: /content/wandb/run-20210425_153508-3maoqo8c/logs/debug.log
Find internal logs for this run at: /content/wandb/run-20210425_153508-3maoqo8c/logs/debug-internal.log
Run summary:

Model	PopularityRecommende...
GIVEN_K	1
LOOK_AHEAD	1
STEP	1
Precision@100	0.00176
Recall@100	0.17585
MRR@100	0.01509
_runtime	3
_timestamp	1619364913
_step	0
Run history:

GIVEN_K	▁
LOOK_AHEAD	▁
STEP	▁
Precision@100	▁
Recall@100	▁
MRR@100	▁
_runtime	▁
_timestamp	▁
_step	▁

Synced 5 W&amp;B file(s), 0 media file(s), 0 artifact file(s) and 0 other file(s)

Synced seqreveal-PopularityRecommender: https://wandb.ai/sparsh121/SARS%20Music30%20x1/runs/3maoqo8c
...Successfully finished last run (ID:3maoqo8c). Initializing new run:

Tracking run with wandb version 0.10.27
Syncing run seqreveal-FSMRecommender to Weights &amp; Biases (Documentation).
Project page: https://wandb.ai/sparsh121/SARS%20Music30%20x1
Run page: https://wandb.ai/sparsh121/SARS%20Music30%20x1/runs/25j3u2ea
Run data is saved locally in /content/wandb/run-20210425_153531-25j3u2ea

  3%|▎         | 99/2891 [00:00&lt;00:02, 986.59it/s]2891 sequences available for evaluation
100%|██████████| 2891/2891 [00:02&lt;00:00, 1312.88it/s]
Finishing last run (ID:25j3u2ea) before initializing another...

Waiting for W&amp;B process to finish, PID 1549
Program ended successfully.
0.01MB of 0.01MB uploaded (0.00MB deduped)
Find user logs for this run at: /content/wandb/run-20210425_153531-25j3u2ea/logs/debug.log
Find internal logs for this run at: /content/wandb/run-20210425_153531-25j3u2ea/logs/debug-internal.log
Run summary:

Model	FSMRecommender
GIVEN_K	1
LOOK_AHEAD	1
STEP	1
Precision@100	0.04325
Recall@100	0.11793
MRR@100	0.0898
_runtime	2
_timestamp	1619364936
_step	0
Run history:

GIVEN_K	▁
LOOK_AHEAD	▁
STEP	▁
Precision@100	▁
Recall@100	▁
MRR@100	▁
_runtime	▁
_timestamp	▁
_step	▁

Synced 5 W&amp;B file(s), 0 media file(s), 0 artifact file(s) and 0 other file(s)

Synced seqreveal-FSMRecommender: https://wandb.ai/sparsh121/SARS%20Music30%20x1/runs/25j3u2ea
...Successfully finished last run (ID:25j3u2ea). Initializing new run:

Tracking run with wandb version 0.10.27
Syncing run seqreveal-MixedMarkovChainRecommender to Weights &amp; Biases (Documentation).
Project page: https://wandb.ai/sparsh121/SARS%20Music30%20x1
Run page: https://wandb.ai/sparsh121/SARS%20Music30%20x1/runs/2ae9o59i
Run data is saved locally in /content/wandb/run-20210425_153539-2ae9o59i

  1%|          | 15/2891 [00:00&lt;00:21, 136.79it/s]2891 sequences available for evaluation
100%|██████████| 2891/2891 [00:17&lt;00:00, 164.35it/s]
Finishing last run (ID:2ae9o59i) before initializing another...

Waiting for W&amp;B process to finish, PID 1580
Program ended successfully.
0.01MB of 0.01MB uploaded (0.00MB deduped)
Find user logs for this run at: /content/wandb/run-20210425_153539-2ae9o59i/logs/debug.log
Find internal logs for this run at: /content/wandb/run-20210425_153539-2ae9o59i/logs/debug-internal.log
Run summary:

Model	MixedMarkovChainReco...
GIVEN_K	1
LOOK_AHEAD	1
STEP	1
Precision@100	0.03049
Recall@100	0.40207
MRR@100	0.13409
_runtime	3
_timestamp	1619364945
_step	0
Run history:

GIVEN_K	▁
LOOK_AHEAD	▁
STEP	▁
Precision@100	▁
Recall@100	▁
MRR@100	▁
_runtime	▁
_timestamp	▁
_step	▁

Synced 5 W&amp;B file(s), 0 media file(s), 0 artifact file(s) and 0 other file(s)

Synced seqreveal-MixedMarkovChainRecommender: https://wandb.ai/sparsh121/SARS%20Music30%20x1/runs/2ae9o59i
...Successfully finished last run (ID:2ae9o59i). Initializing new run:

Tracking run with wandb version 0.10.27
Syncing run seqreveal-Prod2VecRecommender to Weights &amp; Biases (Documentation).
Project page: https://wandb.ai/sparsh121/SARS%20Music30%20x1
Run page: https://wandb.ai/sparsh121/SARS%20Music30%20x1/runs/1efzboqz
Run data is saved locally in /content/wandb/run-20210425_153602-1efzboqz

  0%|          | 0/2891 [00:00&lt;?, ?it/s]2891 sequences available for evaluation
100%|██████████| 2891/2891 [02:02&lt;00:00, 23.66it/s]
Finishing last run (ID:1efzboqz) before initializing another...

Waiting for W&amp;B process to finish, PID 1614
Program ended successfully.
0.01MB of 0.01MB uploaded (0.00MB deduped)
Find user logs for this run at: /content/wandb/run-20210425_153602-1efzboqz/logs/debug.log
Find internal logs for this run at: /content/wandb/run-20210425_153602-1efzboqz/logs/debug-internal.log
Run summary:

Model	Prod2VecRecommender
GIVEN_K	1
LOOK_AHEAD	1
STEP	1
Precision@100	0.01922
Recall@100	0.28801
MRR@100	0.10133
_runtime	3
_timestamp	1619364968
_step	0
Run history:

GIVEN_K	▁
LOOK_AHEAD	▁
STEP	▁
Precision@100	▁
Recall@100	▁
MRR@100	▁
_runtime	▁
_timestamp	▁
_step	▁

Synced 5 W&amp;B file(s), 0 media file(s), 0 artifact file(s) and 0 other file(s)

Synced seqreveal-Prod2VecRecommender: https://wandb.ai/sparsh121/SARS%20Music30%20x1/runs/1efzboqz
...Successfully finished last run (ID:1efzboqz). Initializing new run:

Tracking run with wandb version 0.10.27
Syncing run seqreveal-RNNRecommender to Weights &amp; Biases (Documentation).
Project page: https://wandb.ai/sparsh121/SARS%20Music30%20x1
Run page: https://wandb.ai/sparsh121/SARS%20Music30%20x1/runs/coi5um5y
Run data is saved locally in /content/wandb/run-20210425_153810-coi5um5y

  0%|          | 0/1079 [00:00&lt;?, ?it/s]1079 sequences available for evaluation (1079 users)
100%|██████████| 1079/1079 [00:59&lt;00:00, 18.14it/s]
Finishing last run (ID:coi5um5y) before initializing another...

Waiting for W&amp;B process to finish, PID 1652
Program ended successfully.
0.01MB of 0.01MB uploaded (0.00MB deduped)
Find user logs for this run at: /content/wandb/run-20210425_153810-coi5um5y/logs/debug.log
Find internal logs for this run at: /content/wandb/run-20210425_153810-coi5um5y/logs/debug-internal.log
Run summary:

Model	RNNRecommender
GIVEN_K	1
LOOK_AHEAD	1
STEP	1
Precision@100	0.00488
Recall@100	0.48776
MRR@100	0.24084
_runtime	3
_timestamp	1619365096
_step	0
Run history:

GIVEN_K	▁
LOOK_AHEAD	▁
STEP	▁
Precision@100	▁
Recall@100	▁
MRR@100	▁
_runtime	▁
_timestamp	▁
_step	▁

Synced 5 W&amp;B file(s), 0 media file(s), 0 artifact file(s) and 0 other file(s)

Synced seqreveal-RNNRecommender: https://wandb.ai/sparsh121/SARS%20Music30%20x1/runs/coi5um5y
...Successfully finished last run (ID:coi5um5y). Initializing new run:

Tracking run with wandb version 0.10.27
Syncing run seqreveal-FPMCRecommender to Weights &amp; Biases (Documentation).
Project page: https://wandb.ai/sparsh121/SARS%20Music30%20x1
Run page: https://wandb.ai/sparsh121/SARS%20Music30%20x1/runs/pv3hklma
Run data is saved locally in /content/wandb/run-20210425_153915-pv3hklma

  0%|          | 0/1079 [00:00&lt;?, ?it/s]1079 sequences available for evaluation (1079 users)
100%|██████████| 1079/1079 [00:47&lt;00:00, 22.64it/s]
Finishing last run (ID:pv3hklma) before initializing another...

Waiting for W&amp;B process to finish, PID 1682
Program ended successfully.
0.01MB of 0.01MB uploaded (0.00MB deduped)
Find user logs for this run at: /content/wandb/run-20210425_153915-pv3hklma/logs/debug.log
Find internal logs for this run at: /content/wandb/run-20210425_153915-pv3hklma/logs/debug-internal.log
Run summary:

Model	FPMCRecommender
GIVEN_K	1
LOOK_AHEAD	1
STEP	1
Precision@100	0.00184
Recall@100	0.18351
MRR@100	0.04037
_runtime	3
_timestamp	1619365161
_step	0
Run history:

GIVEN_K	▁
LOOK_AHEAD	▁
STEP	▁
Precision@100	▁
Recall@100	▁
MRR@100	▁
_runtime	▁
_timestamp	▁
_step	▁

Synced 5 W&amp;B file(s), 0 media file(s), 0 artifact file(s) and 0 other file(s)

Synced seqreveal-FPMCRecommender: https://wandb.ai/sparsh121/SARS%20Music30%20x1/runs/pv3hklma
...Successfully finished last run (ID:pv3hklma). Initializing new run:

Tracking run with wandb version 0.10.27
Syncing run seqreveal-RNNRecommender to Weights &amp; Biases (Documentation).
Project page: https://wandb.ai/sparsh121/SARS%20Music30%20x1
Run page: https://wandb.ai/sparsh121/SARS%20Music30%20x1/runs/2xkkfena
Run data is saved locally in /content/wandb/run-20210425_154009-2xkkfena
</pre></div>
</div>
</div>
</div>
<div class="section" id="evaluation-with-static-user-profiles">
<h3>Evaluation with “static” user-profiles<a class="headerlink" href="#evaluation-with-static-user-profiles" title="Permalink to this headline">¶</a></h3>
<p>Here we evaluate the quality of the recommendations in a setting in which user profiles are instead <em>static</em>.</p>
<p>The <em>user profile</em> starts from the first <code class="docutils literal notranslate"><span class="pre">GIVEN_K</span></code> events (or, alternatively, from the last <code class="docutils literal notranslate"><span class="pre">-GIVEN_K</span></code> events if <code class="docutils literal notranslate"><span class="pre">GIVEN_K&lt;0</span></code>).<br />
The recommendations are evaluated against the next <code class="docutils literal notranslate"><span class="pre">LOOK_AHEAD</span></code> events (the <em>ground truth</em>).</p>
<p>The user profile is <em>not extended</em> and the ground truth <em>doesn’t move forward</em>.
This allows to obtain “snapshots” of the recommendation performance for different user profile and ground truth lenghts.</p>
<p>Also here you can set the <code class="docutils literal notranslate"><span class="pre">LOOK_AHEAD='all'</span></code> to see what happens if you had to recommend a <strong>whole sequence</strong> instead of a set of a set of alternatives to a user.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">eval_staticprofile</span><span class="p">(</span><span class="n">recommender</span><span class="p">,</span> <span class="n">user_flg</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
  <span class="n">GIVEN_K</span> <span class="o">=</span> <span class="mi">1</span>
  <span class="n">LOOK_AHEAD</span> <span class="o">=</span> <span class="s1">&#39;all&#39;</span>
  <span class="n">STEP</span><span class="o">=</span><span class="mi">1</span>

  <span class="k">if</span> <span class="n">user_flg</span><span class="p">:</span>
    <span class="n">test_sequences</span><span class="p">,</span> <span class="n">test_users</span> <span class="o">=</span> <span class="n">get_test_sequences_and_users</span><span class="p">(</span><span class="n">test_data</span><span class="p">,</span> <span class="n">GIVEN_K</span><span class="p">,</span> <span class="n">train_data</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span> <span class="c1"># we need user ids now!</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> sequences available for evaluation (</span><span class="si">{}</span><span class="s1"> users)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">test_sequences</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">test_users</span><span class="p">))))</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">sequential_evaluation</span><span class="p">(</span><span class="n">recommender</span><span class="p">,</span>
                                           <span class="n">test_sequences</span><span class="o">=</span><span class="n">test_sequences</span><span class="p">,</span>
                                           <span class="n">users</span><span class="o">=</span><span class="n">test_users</span><span class="p">,</span>
                                           <span class="n">given_k</span><span class="o">=</span><span class="n">GIVEN_K</span><span class="p">,</span>
                                           <span class="n">look_ahead</span><span class="o">=</span><span class="n">LOOK_AHEAD</span><span class="p">,</span>
                                           <span class="n">evaluation_functions</span><span class="o">=</span><span class="n">METRICS</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span>
                                           <span class="n">top_n</span><span class="o">=</span><span class="n">TOPN</span><span class="p">,</span>
                                           <span class="n">scroll</span><span class="o">=</span><span class="kc">False</span>  <span class="c1"># notice that scrolling is disabled!</span>
                                    <span class="p">)</span>                                
  <span class="k">else</span><span class="p">:</span>
    <span class="n">test_sequences</span> <span class="o">=</span> <span class="n">get_test_sequences</span><span class="p">(</span><span class="n">test_data</span><span class="p">,</span> <span class="n">GIVEN_K</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> sequences available for evaluation&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">test_sequences</span><span class="p">)))</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">sequential_evaluation</span><span class="p">(</span><span class="n">recommender</span><span class="p">,</span>
                                            <span class="n">test_sequences</span><span class="o">=</span><span class="n">test_sequences</span><span class="p">,</span>
                                            <span class="n">given_k</span><span class="o">=</span><span class="n">GIVEN_K</span><span class="p">,</span>
                                            <span class="n">look_ahead</span><span class="o">=</span><span class="n">LOOK_AHEAD</span><span class="p">,</span>
                                            <span class="n">evaluation_functions</span><span class="o">=</span><span class="n">METRICS</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span>
                                            <span class="n">top_n</span><span class="o">=</span><span class="n">TOPN</span><span class="p">,</span>
                                            <span class="n">scroll</span><span class="o">=</span><span class="kc">False</span>  <span class="c1"># notice that scrolling is disabled!</span>
                                    <span class="p">)</span>
    
  <span class="k">return</span> <span class="p">[</span><span class="n">results</span><span class="p">,</span> <span class="n">GIVEN_K</span><span class="p">,</span> <span class="n">LOOK_AHEAD</span><span class="p">,</span> <span class="n">STEP</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="id1">
<h4>Logging<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="p">[</span><span class="n">poprecommender</span><span class="p">,</span> <span class="n">fsmrecommender</span><span class="p">,</span>  <span class="n">mmcrecommender</span><span class="p">,</span> <span class="n">p2vrecommender</span><span class="p">,</span>
              <span class="n">rnnrecommender</span><span class="p">,</span> <span class="n">fpmcrecommender</span><span class="p">,</span> <span class="n">prnnrecommender</span><span class="p">,</span>
              <span class="p">]:</span>
  <span class="k">if</span> <span class="n">model</span> <span class="ow">in</span> <span class="p">[</span><span class="n">fpmcrecommender</span><span class="p">,</span> <span class="n">prnnrecommender</span><span class="p">]:</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">eval_staticprofile</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">user_flg</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">eval_staticprofile</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>


  <span class="n">wandb</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;staticprofile-&#39;</span><span class="o">+</span><span class="nb">type</span><span class="p">(</span><span class="n">model</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> 
           <span class="n">project</span><span class="o">=</span><span class="s1">&#39;SARS Music30 x1&#39;</span><span class="p">,</span>
           <span class="n">notes</span><span class="o">=</span><span class="s1">&#39;sequentially static user profile evaluation&#39;</span><span class="p">,</span> 
           <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;sequence&#39;</span><span class="p">,</span> <span class="s1">&#39;music&#39;</span><span class="p">,</span> <span class="s1">&#39;staticprofile&#39;</span><span class="p">])</span>
  <span class="n">wandb</span><span class="o">.</span><span class="n">log</span><span class="p">({</span>
      <span class="s2">&quot;Model&quot;</span><span class="p">:</span> <span class="nb">type</span><span class="p">(</span><span class="n">model</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
      <span class="s2">&quot;GIVEN_K&quot;</span><span class="p">:</span> <span class="n">results</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
      <span class="s2">&quot;LOOK_AHEAD&quot;</span><span class="p">:</span> <span class="n">results</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
      <span class="s2">&quot;STEP&quot;</span><span class="p">:</span> <span class="n">results</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
      <span class="s2">&quot;Precision@100&quot;</span><span class="p">:</span> <span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
      <span class="s2">&quot;Recall@100&quot;</span><span class="p">:</span> <span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
      <span class="s2">&quot;MRR@100&quot;</span><span class="p">:</span> <span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span>
      <span class="p">})</span>
</pre></div>
</div>
</div>
</div>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Run summary:

Model	RNNRecommender
GIVEN_K	1
LOOK_AHEAD	1
STEP	1
Precision@100	0.00445
Recall@100	0.44485
MRR@100	0.05859
_runtime	3
_timestamp	1619365214
_step	0
Run history:

GIVEN_K	▁
LOOK_AHEAD	▁
STEP	▁
Precision@100	▁
Recall@100	▁
MRR@100	▁
_runtime	▁
_timestamp	▁
_step	▁

Synced 5 W&amp;B file(s), 0 media file(s), 0 artifact file(s) and 0 other file(s)

Synced seqreveal-RNNRecommender: https://wandb.ai/sparsh121/SARS%20Music30%20x1/runs/2xkkfena
...Successfully finished last run (ID:2xkkfena). Initializing new run:

Tracking run with wandb version 0.10.27
Syncing run staticprofile-PopularityRecommender to Weights &amp; Biases (Documentation).
Project page: https://wandb.ai/sparsh121/SARS%20Music30%20x1
Run page: https://wandb.ai/sparsh121/SARS%20Music30%20x1/runs/30hai298
Run data is saved locally in /content/wandb/run-20210425_154439-30hai298

  8%|▊         | 242/2891 [00:00&lt;00:01, 2415.10it/s]2891 sequences available for evaluation
100%|██████████| 2891/2891 [00:01&lt;00:00, 2526.75it/s]
Finishing last run (ID:30hai298) before initializing another...

Waiting for W&amp;B process to finish, PID 1806
Program ended successfully.
0.01MB of 0.01MB uploaded (0.00MB deduped)
Find user logs for this run at: /content/wandb/run-20210425_154439-30hai298/logs/debug.log
Find internal logs for this run at: /content/wandb/run-20210425_154439-30hai298/logs/debug-internal.log
Run summary:

Model	PopularityRecommende...
GIVEN_K	1
LOOK_AHEAD	all
STEP	1
Precision@100	0.00837
Recall@100	0.175
MRR@100	0.05131
_runtime	2
_timestamp	1619365485
_step	0
Run history:

GIVEN_K	▁
STEP	▁
Precision@100	▁
Recall@100	▁
MRR@100	▁
_runtime	▁
_timestamp	▁
_step	▁

Synced 5 W&amp;B file(s), 0 media file(s), 0 artifact file(s) and 0 other file(s)

Synced staticprofile-PopularityRecommender: https://wandb.ai/sparsh121/SARS%20Music30%20x1/runs/30hai298
...Successfully finished last run (ID:30hai298). Initializing new run:

Tracking run with wandb version 0.10.27
Syncing run staticprofile-FSMRecommender to Weights &amp; Biases (Documentation).
Project page: https://wandb.ai/sparsh121/SARS%20Music30%20x1
Run page: https://wandb.ai/sparsh121/SARS%20Music30%20x1/runs/bx66eotg
Run data is saved locally in /content/wandb/run-20210425_154446-bx66eotg

 16%|█▋        | 471/2891 [00:00&lt;00:00, 4702.07it/s]2891 sequences available for evaluation
100%|██████████| 2891/2891 [00:00&lt;00:00, 5916.58it/s]
Finishing last run (ID:bx66eotg) before initializing another...

Waiting for W&amp;B process to finish, PID 1835
Program ended successfully.
0.01MB of 0.01MB uploaded (0.00MB deduped)
Find user logs for this run at: /content/wandb/run-20210425_154446-bx66eotg/logs/debug.log
Find internal logs for this run at: /content/wandb/run-20210425_154446-bx66eotg/logs/debug-internal.log
Run summary:

Model	FSMRecommender
GIVEN_K	1
LOOK_AHEAD	all
STEP	1
Precision@100	0.10803
Recall@100	0.09833
MRR@100	0.13287
_runtime	2
_timestamp	1619365491
_step	0
Run history:

GIVEN_K	▁
STEP	▁
Precision@100	▁
Recall@100	▁
MRR@100	▁
_runtime	▁
_timestamp	▁
_step	▁

Synced 5 W&amp;B file(s), 0 media file(s), 0 artifact file(s) and 0 other file(s)

Synced staticprofile-FSMRecommender: https://wandb.ai/sparsh121/SARS%20Music30%20x1/runs/bx66eotg
...Successfully finished last run (ID:bx66eotg). Initializing new run:

Tracking run with wandb version 0.10.27
Syncing run staticprofile-MixedMarkovChainRecommender to Weights &amp; Biases (Documentation).
Project page: https://wandb.ai/sparsh121/SARS%20Music30%20x1
Run page: https://wandb.ai/sparsh121/SARS%20Music30%20x1/runs/2rmv1ke5
Run data is saved locally in /content/wandb/run-20210425_154452-2rmv1ke5

  9%|▉         | 265/2891 [00:00&lt;00:00, 2643.59it/s]2891 sequences available for evaluation
100%|██████████| 2891/2891 [00:00&lt;00:00, 3322.28it/s]
Finishing last run (ID:2rmv1ke5) before initializing another...

Waiting for W&amp;B process to finish, PID 1866
Program ended successfully.
0.01MB of 0.01MB uploaded (0.00MB deduped)
Find user logs for this run at: /content/wandb/run-20210425_154452-2rmv1ke5/logs/debug.log
Find internal logs for this run at: /content/wandb/run-20210425_154452-2rmv1ke5/logs/debug-internal.log
Run summary:

Model	MixedMarkovChainReco...
GIVEN_K	1
LOOK_AHEAD	all
STEP	1
Precision@100	0.09713
Recall@100	0.39545
MRR@100	0.23382
_runtime	2
_timestamp	1619365497
_step	0
Run history:

GIVEN_K	▁
STEP	▁
Precision@100	▁
Recall@100	▁
MRR@100	▁
_runtime	▁
_timestamp	▁
_step	▁

Synced 5 W&amp;B file(s), 0 media file(s), 0 artifact file(s) and 0 other file(s)

Synced staticprofile-MixedMarkovChainRecommender: https://wandb.ai/sparsh121/SARS%20Music30%20x1/runs/2rmv1ke5
...Successfully finished last run (ID:2rmv1ke5). Initializing new run:

Tracking run with wandb version 0.10.27
Syncing run staticprofile-Prod2VecRecommender to Weights &amp; Biases (Documentation).
Project page: https://wandb.ai/sparsh121/SARS%20Music30%20x1
Run page: https://wandb.ai/sparsh121/SARS%20Music30%20x1/runs/2ur3bf4o
Run data is saved locally in /content/wandb/run-20210425_154458-2ur3bf4o

  1%|          | 19/2891 [00:00&lt;00:15, 181.37it/s]2891 sequences available for evaluation
100%|██████████| 2891/2891 [00:12&lt;00:00, 232.78it/s]
Finishing last run (ID:2ur3bf4o) before initializing another...

Waiting for W&amp;B process to finish, PID 1896
Program ended successfully.
0.01MB of 0.01MB uploaded (0.00MB deduped)
Find user logs for this run at: /content/wandb/run-20210425_154458-2ur3bf4o/logs/debug.log
Find internal logs for this run at: /content/wandb/run-20210425_154458-2ur3bf4o/logs/debug-internal.log
Run summary:

Model	Prod2VecRecommender
GIVEN_K	1
LOOK_AHEAD	all
STEP	1
Precision@100	0.10218
Recall@100	0.19719
MRR@100	0.20517
_runtime	2
_timestamp	1619365503
_step	0
Run history:

GIVEN_K	▁
STEP	▁
Precision@100	▁
Recall@100	▁
MRR@100	▁
_runtime	▁
_timestamp	▁
_step	▁

Synced 5 W&amp;B file(s), 0 media file(s), 0 artifact file(s) and 0 other file(s)

Synced staticprofile-Prod2VecRecommender: https://wandb.ai/sparsh121/SARS%20Music30%20x1/runs/2ur3bf4o
...Successfully finished last run (ID:2ur3bf4o). Initializing new run:

Tracking run with wandb version 0.10.27
Syncing run staticprofile-RNNRecommender to Weights &amp; Biases (Documentation).
Project page: https://wandb.ai/sparsh121/SARS%20Music30%20x1
Run page: https://wandb.ai/sparsh121/SARS%20Music30%20x1/runs/44zzy1je
Run data is saved locally in /content/wandb/run-20210425_154516-44zzy1je

  1%|          | 7/1079 [00:00&lt;00:17, 62.97it/s]1079 sequences available for evaluation (1079 users)
100%|██████████| 1079/1079 [00:13&lt;00:00, 81.83it/s]
Finishing last run (ID:44zzy1je) before initializing another...

Waiting for W&amp;B process to finish, PID 1925
Program ended successfully.
0.01MB of 0.01MB uploaded (0.00MB deduped)
Find user logs for this run at: /content/wandb/run-20210425_154516-44zzy1je/logs/debug.log
Find internal logs for this run at: /content/wandb/run-20210425_154516-44zzy1je/logs/debug-internal.log
Run summary:

Model	RNNRecommender
GIVEN_K	1
LOOK_AHEAD	all
STEP	1
Precision@100	0.01542
Recall@100	0.38361
MRR@100	0.29362
_runtime	3
_timestamp	1619365522
_step	0
Run history:

GIVEN_K	▁
STEP	▁
Precision@100	▁
Recall@100	▁
MRR@100	▁
_runtime	▁
_timestamp	▁
_step	▁

Synced 5 W&amp;B file(s), 0 media file(s), 0 artifact file(s) and 0 other file(s)

Synced staticprofile-RNNRecommender: https://wandb.ai/sparsh121/SARS%20Music30%20x1/runs/44zzy1je
...Successfully finished last run (ID:44zzy1je). Initializing new run:

Tracking run with wandb version 0.10.27
Syncing run staticprofile-FPMCRecommender to Weights &amp; Biases (Documentation).
Project page: https://wandb.ai/sparsh121/SARS%20Music30%20x1
Run page: https://wandb.ai/sparsh121/SARS%20Music30%20x1/runs/263glj4g
Run data is saved locally in /content/wandb/run-20210425_154535-263glj4g

  2%|▏         | 20/1079 [00:00&lt;00:05, 199.38it/s]1079 sequences available for evaluation (1079 users)
100%|██████████| 1079/1079 [00:04&lt;00:00, 221.29it/s]
Finishing last run (ID:263glj4g) before initializing another...

Waiting for W&amp;B process to finish, PID 1957
Program ended successfully.
0.01MB of 0.01MB uploaded (0.00MB deduped)
Find user logs for this run at: /content/wandb/run-20210425_154535-263glj4g/logs/debug.log
Find internal logs for this run at: /content/wandb/run-20210425_154535-263glj4g/logs/debug-internal.log
Run summary:

Model	FPMCRecommender
GIVEN_K	1
LOOK_AHEAD	all
STEP	1
Precision@100	0.00651
Recall@100	0.17196
MRR@100	0.08583
_runtime	3
_timestamp	1619365541
_step	0
Run history:

GIVEN_K	▁
STEP	▁
Precision@100	▁
Recall@100	▁
MRR@100	▁
_runtime	▁
_timestamp	▁
_step	▁

Synced 5 W&amp;B file(s), 0 media file(s), 0 artifact file(s) and 0 other file(s)

Synced staticprofile-FPMCRecommender: https://wandb.ai/sparsh121/SARS%20Music30%20x1/runs/263glj4g
...Successfully finished last run (ID:263glj4g). Initializing new run:

Tracking run with wandb version 0.10.27
Syncing run staticprofile-RNNRecommender to Weights &amp; Biases (Documentation).
Project page: https://wandb.ai/sparsh121/SARS%20Music30%20x1
Run page: https://wandb.ai/sparsh121/SARS%20Music30%20x1/runs/4c27los9
Run data is saved locally in /content/wandb/run-20210425_154546-4c27los9
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="analysis-of-next-item-recommendation">
<h2>Analysis of next-item recommendation<a class="headerlink" href="#analysis-of-next-item-recommendation" title="Permalink to this headline">¶</a></h2>
<p>Here we propose to analyse the performance of the recommender system in the scenario of <em>next-item recommendation</em> over the following dimensions:</p>
<ul class="simple">
<li><p>the <em>length</em> of the <strong>recommendation list</strong>, and</p></li>
<li><p>the <em>length</em> of the <strong>user profile</strong>.</p></li>
</ul>
<p>NOTE: This evaluation is by no means exhaustive, as different the hyper-parameters of the recommendation algorithm should be <em>carefully tuned</em> before drawing any conclusions. Unfortunately, given the time constraints for this tutorial, we had to leave hyper-parameter tuning out. A very useful reference about careful evaluation of (session-based) recommenders can be found at:</p>
<ul class="simple">
<li><p>Evaluation of Session-based Recommendation Algorithms, Ludewig and Jannach, 2018 (<a class="reference external" href="https://arxiv.org/abs/1803.09587">paper</a>)</p></li>
</ul>
<div class="section" id="evaluation-for-different-recommendation-list-lengths">
<h3>Evaluation for different recommendation list lengths<a class="headerlink" href="#evaluation-for-different-recommendation-list-lengths" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">eval_reclength</span><span class="p">(</span><span class="n">recommender</span><span class="p">,</span> <span class="n">user_flg</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
  <span class="n">GIVEN_K</span> <span class="o">=</span> <span class="mi">1</span>
  <span class="n">LOOK_AHEAD</span> <span class="o">=</span> <span class="mi">1</span>
  <span class="n">STEP</span> <span class="o">=</span> <span class="mi">1</span>
  <span class="n">topn_list</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">100</span><span class="p">]</span>

  <span class="n">res_list</span> <span class="o">=</span> <span class="p">[]</span>

  <span class="k">if</span> <span class="n">user_flg</span><span class="p">:</span>
    <span class="n">test_sequences</span><span class="p">,</span> <span class="n">test_users</span> <span class="o">=</span> <span class="n">get_test_sequences_and_users</span><span class="p">(</span><span class="n">test_data</span><span class="p">,</span> <span class="n">GIVEN_K</span><span class="p">,</span> <span class="n">train_data</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span> <span class="c1"># we need user ids now!</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> sequences available for evaluation (</span><span class="si">{}</span><span class="s1"> users)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">test_sequences</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">test_users</span><span class="p">))))</span>
    <span class="k">for</span> <span class="n">topn</span> <span class="ow">in</span> <span class="n">topn_list</span><span class="p">:</span>
      <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Evaluating recommendation lists with length: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">topn</span><span class="p">))</span> 
      <span class="n">res_tmp</span> <span class="o">=</span> <span class="n">sequential_evaluation</span><span class="p">(</span><span class="n">recommender</span><span class="p">,</span>
                                            <span class="n">test_sequences</span><span class="o">=</span><span class="n">test_sequences</span><span class="p">,</span>
                                            <span class="n">users</span><span class="o">=</span><span class="n">test_users</span><span class="p">,</span>
                                            <span class="n">given_k</span><span class="o">=</span><span class="n">GIVEN_K</span><span class="p">,</span>
                                            <span class="n">look_ahead</span><span class="o">=</span><span class="n">LOOK_AHEAD</span><span class="p">,</span>
                                            <span class="n">evaluation_functions</span><span class="o">=</span><span class="n">METRICS</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span>
                                            <span class="n">top_n</span><span class="o">=</span><span class="n">topn</span><span class="p">,</span>
                                            <span class="n">scroll</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># here we average over all profile lengths</span>
                                            <span class="n">step</span><span class="o">=</span><span class="n">STEP</span>
                                      <span class="p">)</span>
      <span class="n">mvalues</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">METRICS</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">res_tmp</span><span class="p">))</span>
      <span class="n">res_list</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">topn</span><span class="p">,</span> <span class="n">mvalues</span><span class="p">))</span>                            
  <span class="k">else</span><span class="p">:</span>
    <span class="n">test_sequences</span> <span class="o">=</span> <span class="n">get_test_sequences</span><span class="p">(</span><span class="n">test_data</span><span class="p">,</span> <span class="n">GIVEN_K</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> sequences available for evaluation&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">test_sequences</span><span class="p">)))</span>
    <span class="k">for</span> <span class="n">topn</span> <span class="ow">in</span> <span class="n">topn_list</span><span class="p">:</span>
      <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Evaluating recommendation lists with length: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">topn</span><span class="p">))</span>      
      <span class="n">res_tmp</span> <span class="o">=</span> <span class="n">sequential_evaluation</span><span class="p">(</span><span class="n">recommender</span><span class="p">,</span>
                                                <span class="n">test_sequences</span><span class="o">=</span><span class="n">test_sequences</span><span class="p">,</span>
                                                <span class="n">given_k</span><span class="o">=</span><span class="n">GIVEN_K</span><span class="p">,</span>
                                                <span class="n">look_ahead</span><span class="o">=</span><span class="n">LOOK_AHEAD</span><span class="p">,</span>
                                                <span class="n">evaluation_functions</span><span class="o">=</span><span class="n">METRICS</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span>
                                                <span class="n">top_n</span><span class="o">=</span><span class="n">topn</span><span class="p">,</span>
                                                <span class="n">scroll</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># here we average over all profile lengths</span>
                                                <span class="n">step</span><span class="o">=</span><span class="n">STEP</span><span class="p">)</span>
      <span class="n">mvalues</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">METRICS</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">res_tmp</span><span class="p">))</span>
      <span class="n">res_list</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">topn</span><span class="p">,</span> <span class="n">mvalues</span><span class="p">))</span>

  <span class="c1"># show separate plots per metric</span>
  <span class="c1"># fig, axes = plt.subplots(nrows=1, ncols=len(METRICS), figsize=(15,5))</span>
  <span class="n">res_list_t</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">res_list</span><span class="p">))</span>
  <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="k">for</span> <span class="n">midx</span><span class="p">,</span> <span class="n">metric</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">METRICS</span><span class="p">):</span>
      <span class="n">mvalues</span> <span class="o">=</span> <span class="p">[</span><span class="n">res_list_t</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">j</span><span class="p">][</span><span class="n">midx</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">res_list_t</span><span class="p">[</span><span class="mi">1</span><span class="p">]))]</span>
      <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
      <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">topn_list</span><span class="p">,</span> <span class="n">mvalues</span><span class="p">)</span>
      <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span>
      <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">topn_list</span><span class="p">)</span>
      <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;List length&#39;</span><span class="p">)</span>
      <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
      <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
  <span class="k">return</span> <span class="p">[</span><span class="n">results</span><span class="p">,</span> <span class="n">GIVEN_K</span><span class="p">,</span> <span class="n">LOOK_AHEAD</span><span class="p">,</span> <span class="n">STEP</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="id2">
<h4>Logging<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="p">[</span><span class="n">poprecommender</span><span class="p">,</span> <span class="n">fsmrecommender</span><span class="p">,</span>  <span class="n">mmcrecommender</span><span class="p">,</span> <span class="n">p2vrecommender</span><span class="p">,</span>
              <span class="n">rnnrecommender</span><span class="p">,</span> <span class="n">fpmcrecommender</span><span class="p">,</span> <span class="n">prnnrecommender</span><span class="p">,</span>
              <span class="p">]:</span>
  <span class="k">if</span> <span class="n">model</span> <span class="ow">in</span> <span class="p">[</span><span class="n">fpmcrecommender</span><span class="p">,</span> <span class="n">prnnrecommender</span><span class="p">]:</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">eval_reclength</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">user_flg</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">eval_reclength</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
    
  <span class="n">wandb</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;plotreclen-&#39;</span><span class="o">+</span><span class="nb">type</span><span class="p">(</span><span class="n">model</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> 
           <span class="n">project</span><span class="o">=</span><span class="s1">&#39;SARS Music30 x1&#39;</span><span class="p">,</span>
           <span class="n">notes</span><span class="o">=</span><span class="s1">&#39;rec list length variation evaluation&#39;</span><span class="p">,</span> 
           <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;sequence&#39;</span><span class="p">,</span> <span class="s1">&#39;music&#39;</span><span class="p">,</span> <span class="s1">&#39;plotreclen&#39;</span><span class="p">])</span>
  <span class="n">wandb</span><span class="o">.</span><span class="n">log</span><span class="p">({</span><span class="s2">&quot;Precision&quot;</span><span class="p">:</span> <span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
             <span class="s2">&quot;Recall&quot;</span><span class="p">:</span> <span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
             <span class="s2">&quot;MRR&quot;</span><span class="p">:</span> <span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span>
             <span class="s2">&quot;Model&quot;</span><span class="p">:</span> <span class="nb">type</span><span class="p">(</span><span class="n">model</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
             <span class="s2">&quot;GIVEN_K&quot;</span><span class="p">:</span> <span class="n">results</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
             <span class="s2">&quot;LOOK_AHEAD&quot;</span><span class="p">:</span> <span class="n">results</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
             <span class="s2">&quot;STEP&quot;</span><span class="p">:</span> <span class="n">results</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
             <span class="p">})</span>
</pre></div>
</div>
</div>
</div>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Run summary:

Model	PopularityRecommende...
GIVEN_K	1
LOOK_AHEAD	1
STEP	1
_runtime	3
_timestamp	1619368731
_step	0
Run history:

GIVEN_K	▁
LOOK_AHEAD	▁
STEP	▁
_runtime	▁
_timestamp	▁
_step	▁

Synced 5 W&amp;B file(s), 3 media file(s), 0 artifact file(s) and 0 other file(s)

Synced test-PopularityRecommender: https://wandb.ai/sparsh121/SARS%20Music30%20x1/runs/3jzh0nf4
...Successfully finished last run (ID:3jzh0nf4). Initializing new run:

Tracking run with wandb version 0.10.27
Syncing run plotreclen-PopularityRecommender to Weights &amp; Biases (Documentation).
Project page: https://wandb.ai/sparsh121/SARS%20Music30%20x1
Run page: https://wandb.ai/sparsh121/SARS%20Music30%20x1/runs/258r6fiv
Run data is saved locally in /content/wandb/run-20210425_164026-258r6fiv

  1%|          | 16/2891 [00:00&lt;00:18, 155.20it/s]2891 sequences available for evaluation
Evaluating recommendation lists with length: 1
100%|██████████| 2891/2891 [00:16&lt;00:00, 174.48it/s]
  1%|          | 25/2891 [00:00&lt;00:14, 191.72it/s]Evaluating recommendation lists with length: 5
100%|██████████| 2891/2891 [00:16&lt;00:00, 176.09it/s]
  1%|          | 25/2891 [00:00&lt;00:14, 201.35it/s]Evaluating recommendation lists with length: 10
100%|██████████| 2891/2891 [00:16&lt;00:00, 174.50it/s]
  1%|          | 25/2891 [00:00&lt;00:14, 195.01it/s]Evaluating recommendation lists with length: 20
100%|██████████| 2891/2891 [00:16&lt;00:00, 173.53it/s]
  1%|          | 25/2891 [00:00&lt;00:14, 194.88it/s]Evaluating recommendation lists with length: 50
100%|██████████| 2891/2891 [00:16&lt;00:00, 175.39it/s]
  1%|          | 25/2891 [00:00&lt;00:13, 206.00it/s]Evaluating recommendation lists with length: 100
100%|██████████| 2891/2891 [00:16&lt;00:00, 175.23it/s]
Finishing last run (ID:258r6fiv) before initializing another...

Waiting for W&amp;B process to finish, PID 2717
Program ended successfully.
0.03MB of 0.03MB uploaded (0.00MB deduped)
Find user logs for this run at: /content/wandb/run-20210425_164026-258r6fiv/logs/debug.log
Find internal logs for this run at: /content/wandb/run-20210425_164026-258r6fiv/logs/debug-internal.log
Run summary:

Model	PopularityRecommende...
GIVEN_K	1
LOOK_AHEAD	1
STEP	1
_runtime	3
_timestamp	1619368831
_step	0
Run history:

GIVEN_K	▁
LOOK_AHEAD	▁
STEP	▁
_runtime	▁
_timestamp	▁
_step	▁

Synced 5 W&amp;B file(s), 3 media file(s), 0 artifact file(s) and 0 other file(s)

Synced plotreclen-PopularityRecommender: https://wandb.ai/sparsh121/SARS%20Music30%20x1/runs/258r6fiv
...Successfully finished last run (ID:258r6fiv). Initializing new run:

Tracking run with wandb version 0.10.27
Syncing run plotreclen-FSMRecommender to Weights &amp; Biases (Documentation).
Project page: https://wandb.ai/sparsh121/SARS%20Music30%20x1
Run page: https://wandb.ai/sparsh121/SARS%20Music30%20x1/runs/1o3gi66n
Run data is saved locally in /content/wandb/run-20210425_164211-1o3gi66n

  3%|▎         | 99/2891 [00:00&lt;00:02, 986.29it/s]2891 sequences available for evaluation
Evaluating recommendation lists with length: 1
100%|██████████| 2891/2891 [00:01&lt;00:00, 1940.59it/s]
  6%|▌         | 160/2891 [00:00&lt;00:01, 1598.42it/s]Evaluating recommendation lists with length: 5
100%|██████████| 2891/2891 [00:01&lt;00:00, 1896.56it/s]
  6%|▋         | 182/2891 [00:00&lt;00:01, 1792.34it/s]Evaluating recommendation lists with length: 10
100%|██████████| 2891/2891 [00:01&lt;00:00, 1836.88it/s]
  5%|▌         | 148/2891 [00:00&lt;00:01, 1476.30it/s]Evaluating recommendation lists with length: 20
100%|██████████| 2891/2891 [00:01&lt;00:00, 1682.26it/s]
  5%|▌         | 148/2891 [00:00&lt;00:01, 1463.26it/s]Evaluating recommendation lists with length: 50
100%|██████████| 2891/2891 [00:01&lt;00:00, 1552.85it/s]
  4%|▍         | 130/2891 [00:00&lt;00:02, 1296.16it/s]Evaluating recommendation lists with length: 100
100%|██████████| 2891/2891 [00:01&lt;00:00, 1471.60it/s]
Finishing last run (ID:1o3gi66n) before initializing another...

Waiting for W&amp;B process to finish, PID 2771
Program ended successfully.
0.03MB of 0.03MB uploaded (0.00MB deduped)
Find user logs for this run at: /content/wandb/run-20210425_164211-1o3gi66n/logs/debug.log
Find internal logs for this run at: /content/wandb/run-20210425_164211-1o3gi66n/logs/debug-internal.log
Run summary:

Model	FSMRecommender
GIVEN_K	1
LOOK_AHEAD	1
STEP	1
_runtime	3
_timestamp	1619368937
_step	0
Run history:

GIVEN_K	▁
LOOK_AHEAD	▁
STEP	▁
_runtime	▁
_timestamp	▁
_step	▁

Synced 5 W&amp;B file(s), 3 media file(s), 0 artifact file(s) and 0 other file(s)

Synced plotreclen-FSMRecommender: https://wandb.ai/sparsh121/SARS%20Music30%20x1/runs/1o3gi66n
...Successfully finished last run (ID:1o3gi66n). Initializing new run:

Tracking run with wandb version 0.10.27
Syncing run plotreclen-MixedMarkovChainRecommender to Weights &amp; Biases (Documentation).
Project page: https://wandb.ai/sparsh121/SARS%20Music30%20x1
Run page: https://wandb.ai/sparsh121/SARS%20Music30%20x1/runs/2bf08nlv
Run data is saved locally in /content/wandb/run-20210425_164229-2bf08nlv

  1%|          | 24/2891 [00:00&lt;00:12, 237.99it/s]2891 sequences available for evaluation
Evaluating recommendation lists with length: 1
100%|██████████| 2891/2891 [00:14&lt;00:00, 193.21it/s]
  1%|          | 25/2891 [00:00&lt;00:11, 245.30it/s]Evaluating recommendation lists with length: 5
100%|██████████| 2891/2891 [00:14&lt;00:00, 193.92it/s]
  1%|          | 27/2891 [00:00&lt;00:11, 259.46it/s]Evaluating recommendation lists with length: 10
100%|██████████| 2891/2891 [00:14&lt;00:00, 193.13it/s]
  1%|          | 25/2891 [00:00&lt;00:11, 239.56it/s]Evaluating recommendation lists with length: 20
100%|██████████| 2891/2891 [00:15&lt;00:00, 189.56it/s]
  1%|          | 25/2891 [00:00&lt;00:12, 233.18it/s]Evaluating recommendation lists with length: 50
100%|██████████| 2891/2891 [00:15&lt;00:00, 184.47it/s]
  1%|          | 25/2891 [00:00&lt;00:12, 228.19it/s]Evaluating recommendation lists with length: 100
100%|██████████| 2891/2891 [00:15&lt;00:00, 181.99it/s]
Finishing last run (ID:2bf08nlv) before initializing another...

Waiting for W&amp;B process to finish, PID 2813
Program ended successfully.
0.03MB of 0.03MB uploaded (0.00MB deduped)
Find user logs for this run at: /content/wandb/run-20210425_164229-2bf08nlv/logs/debug.log
Find internal logs for this run at: /content/wandb/run-20210425_164229-2bf08nlv/logs/debug-internal.log
Run summary:

Model	MixedMarkovChainReco...
GIVEN_K	1
LOOK_AHEAD	1
STEP	1
_runtime	3
_timestamp	1619368954
_step	0
Run history:

GIVEN_K	▁
LOOK_AHEAD	▁
STEP	▁
_runtime	▁
_timestamp	▁
_step	▁

Synced 5 W&amp;B file(s), 3 media file(s), 0 artifact file(s) and 0 other file(s)

Synced plotreclen-MixedMarkovChainRecommender: https://wandb.ai/sparsh121/SARS%20Music30%20x1/runs/2bf08nlv
...Successfully finished last run (ID:2bf08nlv). Initializing new run:

Tracking run with wandb version 0.10.27
Syncing run plotreclen-Prod2VecRecommender to Weights &amp; Biases (Documentation).
Project page: https://wandb.ai/sparsh121/SARS%20Music30%20x1
Run page: https://wandb.ai/sparsh121/SARS%20Music30%20x1/runs/2avtq2c8
Run data is saved locally in /content/wandb/run-20210425_164407-2avtq2c8

  0%|          | 3/2891 [00:00&lt;01:49, 26.47it/s]2891 sequences available for evaluation
Evaluating recommendation lists with length: 1
100%|██████████| 2891/2891 [01:55&lt;00:00, 25.08it/s]
  0%|          | 7/2891 [00:00&lt;00:44, 65.33it/s]Evaluating recommendation lists with length: 5
100%|██████████| 2891/2891 [01:56&lt;00:00, 24.74it/s]
  0%|          | 7/2891 [00:00&lt;00:44, 65.47it/s]Evaluating recommendation lists with length: 10
100%|██████████| 2891/2891 [01:57&lt;00:00, 24.71it/s]
  0%|          | 9/2891 [00:00&lt;00:32, 89.50it/s]Evaluating recommendation lists with length: 20
100%|██████████| 2891/2891 [01:56&lt;00:00, 24.71it/s]
  0%|          | 7/2891 [00:00&lt;00:42, 68.27it/s]Evaluating recommendation lists with length: 50
100%|██████████| 2891/2891 [01:57&lt;00:00, 24.62it/s]
  0%|          | 8/2891 [00:00&lt;00:36, 79.41it/s]Evaluating recommendation lists with length: 100
100%|██████████| 2891/2891 [02:00&lt;00:00, 24.05it/s]
Finishing last run (ID:2avtq2c8) before initializing another...

Waiting for W&amp;B process to finish, PID 2869
Program ended successfully.
0.03MB of 0.03MB uploaded (0.00MB deduped)
Find user logs for this run at: /content/wandb/run-20210425_164407-2avtq2c8/logs/debug.log
Find internal logs for this run at: /content/wandb/run-20210425_164407-2avtq2c8/logs/debug-internal.log
Run summary:

Model	Prod2VecRecommender
GIVEN_K	1
LOOK_AHEAD	1
STEP	1
_runtime	3
_timestamp	1619369052
_step	0
Run history:

GIVEN_K	▁
LOOK_AHEAD	▁
STEP	▁
_runtime	▁
_timestamp	▁
_step	▁

Synced 5 W&amp;B file(s), 3 media file(s), 0 artifact file(s) and 0 other file(s)

Synced plotreclen-Prod2VecRecommender: https://wandb.ai/sparsh121/SARS%20Music30%20x1/runs/2avtq2c8
...Successfully finished last run (ID:2avtq2c8). Initializing new run:

Tracking run with wandb version 0.10.27
Syncing run plotreclen-RNNRecommender to Weights &amp; Biases (Documentation).
Project page: https://wandb.ai/sparsh121/SARS%20Music30%20x1
Run page: https://wandb.ai/sparsh121/SARS%20Music30%20x1/runs/yq96ley7
Run data is saved locally in /content/wandb/run-20210425_165558-yq96ley7

  0%|          | 5/1079 [00:00&lt;00:40, 26.63it/s]1079 sequences available for evaluation (1079 users)
Evaluating recommendation lists with length: 1
100%|██████████| 1079/1079 [00:58&lt;00:00, 18.47it/s]
  0%|          | 5/1079 [00:00&lt;00:35, 30.02it/s]Evaluating recommendation lists with length: 5
100%|██████████| 1079/1079 [00:58&lt;00:00, 18.52it/s]
  0%|          | 5/1079 [00:00&lt;00:36, 29.20it/s]Evaluating recommendation lists with length: 10
100%|██████████| 1079/1079 [00:57&lt;00:00, 18.68it/s]
  0%|          | 5/1079 [00:00&lt;00:34, 31.20it/s]Evaluating recommendation lists with length: 20
100%|██████████| 1079/1079 [00:57&lt;00:00, 18.85it/s]
  0%|          | 5/1079 [00:00&lt;00:37, 28.42it/s]Evaluating recommendation lists with length: 50
100%|██████████| 1079/1079 [00:58&lt;00:00, 18.51it/s]
  0%|          | 5/1079 [00:00&lt;00:37, 28.75it/s]Evaluating recommendation lists with length: 100
100%|██████████| 1079/1079 [00:59&lt;00:00, 18.12it/s]
Finishing last run (ID:yq96ley7) before initializing another...

Waiting for W&amp;B process to finish, PID 3003
Program ended successfully.
0.03MB of 0.03MB uploaded (0.00MB deduped)
Find user logs for this run at: /content/wandb/run-20210425_165558-yq96ley7/logs/debug.log
Find internal logs for this run at: /content/wandb/run-20210425_165558-yq96ley7/logs/debug-internal.log
Run summary:

Model	RNNRecommender
GIVEN_K	1
LOOK_AHEAD	1
STEP	1
_runtime	4
_timestamp	1619369765
_step	0
Run history:

GIVEN_K	▁
LOOK_AHEAD	▁
STEP	▁
_runtime	▁
_timestamp	▁
_step	▁

Synced 5 W&amp;B file(s), 3 media file(s), 0 artifact file(s) and 0 other file(s)

Synced plotreclen-RNNRecommender: https://wandb.ai/sparsh121/SARS%20Music30%20x1/runs/yq96ley7
...Successfully finished last run (ID:yq96ley7). Initializing new run:

Tracking run with wandb version 0.10.27
Syncing run plotreclen-FPMCRecommender to Weights &amp; Biases (Documentation).
Project page: https://wandb.ai/sparsh121/SARS%20Music30%20x1
Run page: https://wandb.ai/sparsh121/SARS%20Music30%20x1/runs/29wevfbw
Run data is saved locally in /content/wandb/run-20210425_170156-29wevfbw

  0%|          | 5/1079 [00:00&lt;00:28, 37.53it/s]1079 sequences available for evaluation (1079 users)
Evaluating recommendation lists with length: 1
100%|██████████| 1079/1079 [00:44&lt;00:00, 24.32it/s]
  0%|          | 0/1079 [00:00&lt;?, ?it/s]Evaluating recommendation lists with length: 5
100%|██████████| 1079/1079 [00:44&lt;00:00, 24.37it/s]
  0%|          | 5/1079 [00:00&lt;00:22, 48.64it/s]Evaluating recommendation lists with length: 10
100%|██████████| 1079/1079 [00:44&lt;00:00, 24.37it/s]
  0%|          | 5/1079 [00:00&lt;00:21, 49.92it/s]Evaluating recommendation lists with length: 20
100%|██████████| 1079/1079 [00:44&lt;00:00, 24.04it/s]
  0%|          | 0/1079 [00:00&lt;?, ?it/s]Evaluating recommendation lists with length: 50
100%|██████████| 1079/1079 [00:45&lt;00:00, 23.96it/s]
  0%|          | 5/1079 [00:00&lt;00:21, 49.89it/s]Evaluating recommendation lists with length: 100
100%|██████████| 1079/1079 [00:44&lt;00:00, 24.04it/s]
Finishing last run (ID:29wevfbw) before initializing another...

Waiting for W&amp;B process to finish, PID 3041
Program ended successfully.
0.03MB of 0.03MB uploaded (0.00MB deduped)
Find user logs for this run at: /content/wandb/run-20210425_170156-29wevfbw/logs/debug.log
Find internal logs for this run at: /content/wandb/run-20210425_170156-29wevfbw/logs/debug-internal.log
Run summary:

Model	FPMCRecommender
GIVEN_K	1
LOOK_AHEAD	1
STEP	1
_runtime	3
_timestamp	1619370121
_step	0
Run history:

GIVEN_K	▁
LOOK_AHEAD	▁
STEP	▁
_runtime	▁
_timestamp	▁
_step	▁

Synced 5 W&amp;B file(s), 3 media file(s), 0 artifact file(s) and 0 other file(s)

Synced plotreclen-FPMCRecommender: https://wandb.ai/sparsh121/SARS%20Music30%20x1/runs/29wevfbw
...Successfully finished last run (ID:29wevfbw). Initializing new run:

Tracking run with wandb version 0.10.27
Syncing run plotreclen-RNNRecommender to Weights &amp; Biases (Documentation).
Project page: https://wandb.ai/sparsh121/SARS%20Music30%20x1
Run page: https://wandb.ai/sparsh121/SARS%20Music30%20x1/runs/3r0qzmw7
Run data is saved locally in /content/wandb/run-20210425_170630-3r0qzmw7
</pre></div>
</div>
</div>
</div>
<div class="section" id="evaluation-for-different-user-profile-lengths">
<h3>Evaluation for different user profile lengths<a class="headerlink" href="#evaluation-for-different-user-profile-lengths" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">eval_profilelength</span><span class="p">(</span><span class="n">recommender</span><span class="p">,</span> <span class="n">user_flg</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
  <span class="n">given_k_list</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span>
  <span class="n">LOOK_AHEAD</span> <span class="o">=</span> <span class="mi">1</span>
  <span class="n">STEP</span> <span class="o">=</span> <span class="mi">1</span>
  <span class="n">TOPN</span> <span class="o">=</span> <span class="mi">20</span>

  <span class="n">res_list</span> <span class="o">=</span> <span class="p">[]</span>

  <span class="k">if</span> <span class="n">user_flg</span><span class="p">:</span>
    <span class="n">test_sequences</span><span class="p">,</span> <span class="n">test_users</span> <span class="o">=</span> <span class="n">get_test_sequences_and_users</span><span class="p">(</span><span class="n">test_data</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">given_k_list</span><span class="p">),</span> <span class="n">train_data</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span> <span class="c1"># we need user ids now!</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> sequences available for evaluation (</span><span class="si">{}</span><span class="s1"> users)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">test_sequences</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">test_users</span><span class="p">))))</span>
    <span class="k">for</span> <span class="n">gk</span> <span class="ow">in</span> <span class="n">given_k_list</span><span class="p">:</span>
      <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Evaluating profiles having length: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">gk</span><span class="p">))</span>
      <span class="n">res_tmp</span> <span class="o">=</span> <span class="n">sequential_evaluation</span><span class="p">(</span><span class="n">recommender</span><span class="p">,</span>
                                                <span class="n">test_sequences</span><span class="o">=</span><span class="n">test_sequences</span><span class="p">,</span>
                                                <span class="n">users</span><span class="o">=</span><span class="n">test_users</span><span class="p">,</span>
                                                <span class="n">given_k</span><span class="o">=</span><span class="n">gk</span><span class="p">,</span>
                                                <span class="n">look_ahead</span><span class="o">=</span><span class="n">LOOK_AHEAD</span><span class="p">,</span>
                                                <span class="n">evaluation_functions</span><span class="o">=</span><span class="n">METRICS</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span>
                                                <span class="n">top_n</span><span class="o">=</span><span class="n">TOPN</span><span class="p">,</span>
                                                <span class="n">scroll</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>  <span class="c1"># here we stop at each profile length</span>
                                                <span class="n">step</span><span class="o">=</span><span class="n">STEP</span><span class="p">)</span>
      <span class="n">mvalues</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">METRICS</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">res_tmp</span><span class="p">))</span>
      <span class="n">res_list</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">gk</span><span class="p">,</span> <span class="n">mvalues</span><span class="p">))</span>                          
  <span class="k">else</span><span class="p">:</span>
    <span class="n">test_sequences</span> <span class="o">=</span> <span class="n">get_test_sequences</span><span class="p">(</span><span class="n">test_data</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">given_k_list</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> sequences available for evaluation&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">test_sequences</span><span class="p">)))</span>
    <span class="k">for</span> <span class="n">gk</span> <span class="ow">in</span> <span class="n">given_k_list</span><span class="p">:</span>
      <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Evaluating profiles having length: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">gk</span><span class="p">))</span>
      <span class="n">res_tmp</span> <span class="o">=</span> <span class="n">sequential_evaluation</span><span class="p">(</span><span class="n">recommender</span><span class="p">,</span>
                                                <span class="n">test_sequences</span><span class="o">=</span><span class="n">test_sequences</span><span class="p">,</span>
                                                <span class="n">given_k</span><span class="o">=</span><span class="n">gk</span><span class="p">,</span>
                                                <span class="n">look_ahead</span><span class="o">=</span><span class="n">LOOK_AHEAD</span><span class="p">,</span>
                                                <span class="n">evaluation_functions</span><span class="o">=</span><span class="n">METRICS</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span>
                                                <span class="n">top_n</span><span class="o">=</span><span class="n">TOPN</span><span class="p">,</span>
                                                <span class="n">scroll</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>  <span class="c1"># here we stop at each profile length</span>
                                                <span class="n">step</span><span class="o">=</span><span class="n">STEP</span><span class="p">)</span>
      <span class="n">mvalues</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">METRICS</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">res_tmp</span><span class="p">))</span>
      <span class="n">res_list</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">gk</span><span class="p">,</span> <span class="n">mvalues</span><span class="p">))</span>

  <span class="c1"># show separate plots per metric</span>
  <span class="c1"># fig, axes = plt.subplots(nrows=1, ncols=len(METRICS), figsize=(15,5))</span>
  <span class="n">res_list_t</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">res_list</span><span class="p">))</span>
  <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="k">for</span> <span class="n">midx</span><span class="p">,</span> <span class="n">metric</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">METRICS</span><span class="p">):</span>
      <span class="n">mvalues</span> <span class="o">=</span> <span class="p">[</span><span class="n">res_list_t</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">j</span><span class="p">][</span><span class="n">midx</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">res_list_t</span><span class="p">[</span><span class="mi">1</span><span class="p">]))]</span>
      <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
      <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">given_k_list</span><span class="p">,</span> <span class="n">mvalues</span><span class="p">)</span>
      <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span>
      <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">given_k_list</span><span class="p">)</span>
      <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Profile length&#39;</span><span class="p">)</span>
      <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
      <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
  <span class="k">return</span> <span class="p">[</span><span class="n">results</span><span class="p">,</span> <span class="n">TOPN</span><span class="p">,</span> <span class="n">LOOK_AHEAD</span><span class="p">,</span> <span class="n">STEP</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="id3">
<h4>Logging<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="p">[</span><span class="n">poprecommender</span><span class="p">,</span> <span class="n">fsmrecommender</span><span class="p">,</span>  <span class="n">mmcrecommender</span><span class="p">,</span> <span class="n">p2vrecommender</span><span class="p">,</span>
              <span class="n">rnnrecommender</span><span class="p">,</span> <span class="n">fpmcrecommender</span><span class="p">,</span> <span class="n">prnnrecommender</span><span class="p">,</span>
              <span class="p">]:</span>
  <span class="k">if</span> <span class="n">model</span> <span class="ow">in</span> <span class="p">[</span><span class="n">fpmcrecommender</span><span class="p">,</span> <span class="n">prnnrecommender</span><span class="p">]:</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">eval_profilelength</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">user_flg</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">eval_profilelength</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
    
  <span class="n">wandb</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;plotproflen-&#39;</span><span class="o">+</span><span class="nb">type</span><span class="p">(</span><span class="n">model</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> 
           <span class="n">project</span><span class="o">=</span><span class="s1">&#39;SARS Music30 x1&#39;</span><span class="p">,</span>
           <span class="n">notes</span><span class="o">=</span><span class="s1">&#39;profile length variation evaluation&#39;</span><span class="p">,</span> 
           <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;sequence&#39;</span><span class="p">,</span> <span class="s1">&#39;music&#39;</span><span class="p">,</span> <span class="s1">&#39;plotproflen&#39;</span><span class="p">])</span>
  <span class="n">wandb</span><span class="o">.</span><span class="n">log</span><span class="p">({</span><span class="s2">&quot;Precision&quot;</span><span class="p">:</span> <span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
             <span class="s2">&quot;Recall&quot;</span><span class="p">:</span> <span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
             <span class="s2">&quot;MRR&quot;</span><span class="p">:</span> <span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span>
             <span class="s2">&quot;Model&quot;</span><span class="p">:</span> <span class="nb">type</span><span class="p">(</span><span class="n">model</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
             <span class="s2">&quot;TOP_N&quot;</span><span class="p">:</span> <span class="n">results</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
             <span class="s2">&quot;LOOK_AHEAD&quot;</span><span class="p">:</span> <span class="n">results</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
             <span class="s2">&quot;STEP&quot;</span><span class="p">:</span> <span class="n">results</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
             <span class="p">})</span>
</pre></div>
</div>
</div>
</div>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Run summary:

Model	RNNRecommender
GIVEN_K	1
LOOK_AHEAD	1
STEP	1
_runtime	3
_timestamp	1619370395
_step	0
Run history:

GIVEN_K	▁
LOOK_AHEAD	▁
STEP	▁
_runtime	▁
_timestamp	▁
_step	▁

Synced 5 W&amp;B file(s), 3 media file(s), 0 artifact file(s) and 0 other file(s)

Synced plotreclen-RNNRecommender: https://wandb.ai/sparsh121/SARS%20Music30%20x1/runs/3r0qzmw7
...Successfully finished last run (ID:3r0qzmw7). Initializing new run:

Tracking run with wandb version 0.10.27
Syncing run plotproflen-PopularityRecommender to Weights &amp; Biases (Documentation).
Project page: https://wandb.ai/sparsh121/SARS%20Music30%20x1
Run page: https://wandb.ai/sparsh121/SARS%20Music30%20x1/runs/35gzppld
Run data is saved locally in /content/wandb/run-20210425_172520-35gzppld

 14%|█▍        | 162/1164 [00:00&lt;00:00, 1619.48it/s]1164 sequences available for evaluation
Evaluating profiles having length: 1
100%|██████████| 1164/1164 [00:00&lt;00:00, 2203.24it/s]
 14%|█▎        | 158/1164 [00:00&lt;00:00, 1565.03it/s]Evaluating profiles having length: 2
100%|██████████| 1164/1164 [00:00&lt;00:00, 1372.39it/s]
  9%|▉         | 104/1164 [00:00&lt;00:01, 1039.84it/s]Evaluating profiles having length: 3
100%|██████████| 1164/1164 [00:01&lt;00:00, 952.05it/s]
  6%|▌         | 70/1164 [00:00&lt;00:01, 686.40it/s]Evaluating profiles having length: 4
100%|██████████| 1164/1164 [00:01&lt;00:00, 738.39it/s]
Finishing last run (ID:35gzppld) before initializing another...

Waiting for W&amp;B process to finish, PID 3161
Program ended successfully.
0.03MB of 0.03MB uploaded (0.00MB deduped)
Find user logs for this run at: /content/wandb/run-20210425_172520-35gzppld/logs/debug.log
Find internal logs for this run at: /content/wandb/run-20210425_172520-35gzppld/logs/debug-internal.log
Run summary:

Model	PopularityRecommende...
TOP_N	20
LOOK_AHEAD	1
STEP	1
_runtime	3
_timestamp	1619371526
_step	0
Run history:

TOP_N	▁
LOOK_AHEAD	▁
STEP	▁
_runtime	▁
_timestamp	▁
_step	▁

Synced 5 W&amp;B file(s), 3 media file(s), 0 artifact file(s) and 0 other file(s)

Synced plotproflen-PopularityRecommender: https://wandb.ai/sparsh121/SARS%20Music30%20x1/runs/35gzppld
...Successfully finished last run (ID:35gzppld). Initializing new run:

Tracking run with wandb version 0.10.27
Syncing run plotproflen-FSMRecommender to Weights &amp; Biases (Documentation).
Project page: https://wandb.ai/sparsh121/SARS%20Music30%20x1
Run page: https://wandb.ai/sparsh121/SARS%20Music30%20x1/runs/yl7evwah
Run data is saved locally in /content/wandb/run-20210425_172531-yl7evwah

 32%|███▏      | 375/1164 [00:00&lt;00:00, 3722.11it/s]1164 sequences available for evaluation
Evaluating profiles having length: 1
100%|██████████| 1164/1164 [00:00&lt;00:00, 4971.87it/s]
100%|██████████| 1164/1164 [00:00&lt;00:00, 6303.63it/s]
  0%|          | 0/1164 [00:00&lt;?, ?it/s]Evaluating profiles having length: 2
Evaluating profiles having length: 3
100%|██████████| 1164/1164 [00:00&lt;00:00, 6272.96it/s]
100%|██████████| 1164/1164 [00:00&lt;00:00, 6726.65it/s]
Evaluating profiles having length: 4
Finishing last run (ID:yl7evwah) before initializing another...

Waiting for W&amp;B process to finish, PID 3199
Program ended successfully.
0.03MB of 0.03MB uploaded (0.00MB deduped)
Find user logs for this run at: /content/wandb/run-20210425_172531-yl7evwah/logs/debug.log
Find internal logs for this run at: /content/wandb/run-20210425_172531-yl7evwah/logs/debug-internal.log
Run summary:

Model	FSMRecommender
TOP_N	20
LOOK_AHEAD	1
STEP	1
_runtime	3
_timestamp	1619371537
_step	0
Run history:

TOP_N	▁
LOOK_AHEAD	▁
STEP	▁
_runtime	▁
_timestamp	▁
_step	▁

Synced 5 W&amp;B file(s), 3 media file(s), 0 artifact file(s) and 0 other file(s)

Synced plotproflen-FSMRecommender: https://wandb.ai/sparsh121/SARS%20Music30%20x1/runs/yl7evwah
...Successfully finished last run (ID:yl7evwah). Initializing new run:

Tracking run with wandb version 0.10.27
Syncing run plotproflen-MixedMarkovChainRecommender to Weights &amp; Biases (Documentation).
Project page: https://wandb.ai/sparsh121/SARS%20Music30%20x1
Run page: https://wandb.ai/sparsh121/SARS%20Music30%20x1/runs/2j9putlt
Run data is saved locally in /content/wandb/run-20210425_172540-2j9putlt

 23%|██▎       | 268/1164 [00:00&lt;00:00, 2676.49it/s]1164 sequences available for evaluation
Evaluating profiles having length: 1
100%|██████████| 1164/1164 [00:00&lt;00:00, 3108.76it/s]
 18%|█▊        | 213/1164 [00:00&lt;00:00, 2123.98it/s]Evaluating profiles having length: 2
100%|██████████| 1164/1164 [00:00&lt;00:00, 1741.40it/s]
 12%|█▏        | 138/1164 [00:00&lt;00:00, 1373.66it/s]Evaluating profiles having length: 3
100%|██████████| 1164/1164 [00:00&lt;00:00, 1288.90it/s]
 10%|█         | 118/1164 [00:00&lt;00:00, 1179.31it/s]Evaluating profiles having length: 4
100%|██████████| 1164/1164 [00:01&lt;00:00, 1048.89it/s]
Finishing last run (ID:2j9putlt) before initializing another...

Waiting for W&amp;B process to finish, PID 3235
Program ended successfully.
0.03MB of 0.03MB uploaded (0.00MB deduped)
Find user logs for this run at: /content/wandb/run-20210425_172540-2j9putlt/logs/debug.log
Find internal logs for this run at: /content/wandb/run-20210425_172540-2j9putlt/logs/debug-internal.log
Run summary:

Model	MixedMarkovChainReco...
TOP_N	20
LOOK_AHEAD	1
STEP	1
_runtime	3
_timestamp	1619371545
_step	0
Run history:

TOP_N	▁
LOOK_AHEAD	▁
STEP	▁
_runtime	▁
_timestamp	▁
_step	▁

Synced 5 W&amp;B file(s), 3 media file(s), 0 artifact file(s) and 0 other file(s)

Synced plotproflen-MixedMarkovChainRecommender: https://wandb.ai/sparsh121/SARS%20Music30%20x1/runs/2j9putlt
...Successfully finished last run (ID:2j9putlt). Initializing new run:

Tracking run with wandb version 0.10.27
Syncing run plotproflen-Prod2VecRecommender to Weights &amp; Biases (Documentation).
Project page: https://wandb.ai/sparsh121/SARS%20Music30%20x1
Run page: https://wandb.ai/sparsh121/SARS%20Music30%20x1/runs/1hmj6j0q
Run data is saved locally in /content/wandb/run-20210425_172550-1hmj6j0q

  1%|          | 11/1164 [00:00&lt;00:10, 107.21it/s]1164 sequences available for evaluation
Evaluating profiles having length: 1
100%|██████████| 1164/1164 [00:06&lt;00:00, 182.55it/s]
  1%|▏         | 17/1164 [00:00&lt;00:06, 166.10it/s]Evaluating profiles having length: 2
100%|██████████| 1164/1164 [00:07&lt;00:00, 157.29it/s]
  1%|▏         | 15/1164 [00:00&lt;00:08, 143.04it/s]Evaluating profiles having length: 3
100%|██████████| 1164/1164 [00:08&lt;00:00, 138.63it/s]
  1%|          | 11/1164 [00:00&lt;00:10, 107.33it/s]Evaluating profiles having length: 4
100%|██████████| 1164/1164 [00:09&lt;00:00, 122.52it/s]
Finishing last run (ID:1hmj6j0q) before initializing another...

Waiting for W&amp;B process to finish, PID 3271
Program ended successfully.
0.03MB of 0.03MB uploaded (0.00MB deduped)
Find user logs for this run at: /content/wandb/run-20210425_172550-1hmj6j0q/logs/debug.log
Find internal logs for this run at: /content/wandb/run-20210425_172550-1hmj6j0q/logs/debug-internal.log
Run summary:

Model	Prod2VecRecommender
TOP_N	20
LOOK_AHEAD	1
STEP	1
_runtime	3
_timestamp	1619371555
_step	0
Run history:

TOP_N	▁
LOOK_AHEAD	▁
STEP	▁
_runtime	▁
_timestamp	▁
_step	▁

Synced 5 W&amp;B file(s), 3 media file(s), 0 artifact file(s) and 0 other file(s)

Synced plotproflen-Prod2VecRecommender: https://wandb.ai/sparsh121/SARS%20Music30%20x1/runs/1hmj6j0q
...Successfully finished last run (ID:1hmj6j0q). Initializing new run:

Tracking run with wandb version 0.10.27
Syncing run plotproflen-RNNRecommender to Weights &amp; Biases (Documentation).
Project page: https://wandb.ai/sparsh121/SARS%20Music30%20x1
Run page: https://wandb.ai/sparsh121/SARS%20Music30%20x1/runs/qe2pqcf2
Run data is saved locally in /content/wandb/run-20210425_172628-qe2pqcf2

  2%|▏         | 7/463 [00:00&lt;00:07, 63.98it/s]463 sequences available for evaluation (463 users)
Evaluating profiles having length: 1
100%|██████████| 463/463 [00:06&lt;00:00, 76.39it/s]
  2%|▏         | 9/463 [00:00&lt;00:05, 86.68it/s]Evaluating profiles having length: 2
100%|██████████| 463/463 [00:05&lt;00:00, 85.28it/s]
  2%|▏         | 10/463 [00:00&lt;00:04, 90.95it/s]Evaluating profiles having length: 3
100%|██████████| 463/463 [00:05&lt;00:00, 83.33it/s]
  2%|▏         | 9/463 [00:00&lt;00:05, 86.91it/s]Evaluating profiles having length: 4
100%|██████████| 463/463 [00:05&lt;00:00, 83.94it/s]
Finishing last run (ID:qe2pqcf2) before initializing another...

Waiting for W&amp;B process to finish, PID 3309
Program ended successfully.
0.03MB of 0.03MB uploaded (0.00MB deduped)
Find user logs for this run at: /content/wandb/run-20210425_172628-qe2pqcf2/logs/debug.log
Find internal logs for this run at: /content/wandb/run-20210425_172628-qe2pqcf2/logs/debug-internal.log
Run summary:

Model	RNNRecommender
TOP_N	20
LOOK_AHEAD	1
STEP	1
_runtime	3
_timestamp	1619371594
_step	0
Run history:

TOP_N	▁
LOOK_AHEAD	▁
STEP	▁
_runtime	▁
_timestamp	▁
_step	▁

Synced 5 W&amp;B file(s), 3 media file(s), 0 artifact file(s) and 0 other file(s)

Synced plotproflen-RNNRecommender: https://wandb.ai/sparsh121/SARS%20Music30%20x1/runs/qe2pqcf2
...Successfully finished last run (ID:qe2pqcf2). Initializing new run:

Tracking run with wandb version 0.10.27
Syncing run plotproflen-FPMCRecommender to Weights &amp; Biases (Documentation).
Project page: https://wandb.ai/sparsh121/SARS%20Music30%20x1
Run page: https://wandb.ai/sparsh121/SARS%20Music30%20x1/runs/2g9qwnhv
Run data is saved locally in /content/wandb/run-20210425_172658-2g9qwnhv

  4%|▎         | 17/463 [00:00&lt;00:02, 162.60it/s]463 sequences available for evaluation (463 users)
Evaluating profiles having length: 1
100%|██████████| 463/463 [00:01&lt;00:00, 248.82it/s]
  4%|▍         | 19/463 [00:00&lt;00:02, 186.26it/s]Evaluating profiles having length: 2
100%|██████████| 463/463 [00:02&lt;00:00, 200.31it/s]
  3%|▎         | 16/463 [00:00&lt;00:02, 157.61it/s]Evaluating profiles having length: 3
100%|██████████| 463/463 [00:03&lt;00:00, 142.72it/s]
  3%|▎         | 15/463 [00:00&lt;00:03, 148.40it/s]Evaluating profiles having length: 4
100%|██████████| 463/463 [00:03&lt;00:00, 140.47it/s]
Finishing last run (ID:2g9qwnhv) before initializing another...

Waiting for W&amp;B process to finish, PID 3345
Program ended successfully.
0.03MB of 0.03MB uploaded (0.00MB deduped)
Find user logs for this run at: /content/wandb/run-20210425_172658-2g9qwnhv/logs/debug.log
Find internal logs for this run at: /content/wandb/run-20210425_172658-2g9qwnhv/logs/debug-internal.log
Run summary:

Model	FPMCRecommender
TOP_N	20
LOOK_AHEAD	1
STEP	1
_runtime	3
_timestamp	1619371623
_step	0
Run history:

TOP_N	▁
LOOK_AHEAD	▁
STEP	▁
_runtime	▁
_timestamp	▁
_step	▁

Synced 5 W&amp;B file(s), 3 media file(s), 0 artifact file(s) and 0 other file(s)

Synced plotproflen-FPMCRecommender: https://wandb.ai/sparsh121/SARS%20Music30%20x1/runs/2g9qwnhv
...Successfully finished last run (ID:2g9qwnhv). Initializing new run:

Tracking run with wandb version 0.10.27
Syncing run plotproflen-RNNRecommender to Weights &amp; Biases (Documentation).
Project page: https://wandb.ai/sparsh121/SARS%20Music30%20x1
Run page: https://wandb.ai/sparsh121/SARS%20Music30%20x1/runs/31wyg3ur
Run data is saved locally in /content/wandb/run-20210425_172716-31wyg3ur
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="artifact-versioning">
<h2>Artifact versioning<a class="headerlink" href="#artifact-versioning" title="Permalink to this headline">¶</a></h2>
<div class="section" id="model-logging">
<h3>Model logging<a class="headerlink" href="#model-logging" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pickle</span>
<span class="n">run</span> <span class="o">=</span> <span class="n">wandb</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">job_type</span><span class="o">=</span><span class="s2">&quot;model-logging&quot;</span><span class="p">,</span>
                 <span class="n">name</span><span class="o">=</span><span class="s2">&quot;artifact-model&quot;</span><span class="p">,</span>
                 <span class="n">project</span><span class="o">=</span><span class="s1">&#39;SARS Music30 x1&#39;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="p">[</span><span class="n">poprecommender</span><span class="p">,</span> <span class="n">fsmrecommender</span><span class="p">,</span>  <span class="n">mmcrecommender</span><span class="p">,</span> <span class="n">p2vrecommender</span><span class="p">,</span>
              <span class="n">rnnrecommender</span><span class="p">,</span> <span class="n">fpmcrecommender</span><span class="p">,</span> <span class="n">prnnrecommender</span><span class="p">,</span> <span class="n">knnrecommender</span><span class="p">]:</span>
  <span class="c1"># with open(type(model).__name__+&#39;.p&#39;, &#39;wb&#39;) as handle:</span>
    <span class="c1"># pickle.dump(model, handle, protocol=pickle.HIGHEST_PROTOCOL)</span>
  <span class="n">artifact</span> <span class="o">=</span> <span class="n">wandb</span><span class="o">.</span><span class="n">Artifact</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">model</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;model&#39;</span><span class="p">)</span>
  <span class="n">artifact</span><span class="o">.</span><span class="n">add_file</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">model</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="o">+</span><span class="s1">&#39;.p&#39;</span><span class="p">)</span>
  <span class="n">run</span><span class="o">.</span><span class="n">log_artifact</span><span class="p">(</span><span class="n">artifact</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">Finishing last run (ID:2uswdiud) before initializing another...</div><div class="output text_html"><br/>Waiting for W&B process to finish, PID 3744<br/>Program ended successfully.</div><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "197f244ca32f484b8fc9651559388945", "version_major": 2, "version_minor": 0}
</script><div class="output text_html">Find user logs for this run at: <code>/content/wandb/run-20210425_175159-2uswdiud/logs/debug.log</code></div><div class="output text_html">Find internal logs for this run at: <code>/content/wandb/run-20210425_175159-2uswdiud/logs/debug-internal.log</code></div><div class="output text_html">Synced 4 W&B file(s), 0 media file(s), 7 artifact file(s) and 0 other file(s)</div><div class="output text_html">
<br/>Synced <strong style="color:#cdcd00">misty-dew-37</strong>: <a href="https://wandb.ai/sparsh121/SARS%20Music30%20x1/runs/2uswdiud" target="_blank">https://wandb.ai/sparsh121/SARS%20Music30%20x1/runs/2uswdiud</a><br/>
</div><div class="output text_html">...Successfully finished last run (ID:2uswdiud). Initializing new run:<br/><br/></div><div class="output text_html">
Tracking run with wandb version 0.10.27<br/>
Syncing run <strong style="color:#cdcd00">artifact-model</strong> to <a href="https://wandb.ai" target="_blank">Weights & Biases</a> <a href="https://docs.wandb.com/integrations/jupyter.html" target="_blank">(Documentation)</a>.<br/>
Project page: <a href="https://wandb.ai/sparsh121/SARS%20Music30%20x1" target="_blank">https://wandb.ai/sparsh121/SARS%20Music30%20x1</a><br/>
Run page: <a href="https://wandb.ai/sparsh121/SARS%20Music30%20x1/runs/1hx1av67" target="_blank">https://wandb.ai/sparsh121/SARS%20Music30%20x1/runs/1hx1av67</a><br/>
Run data is saved locally in <code>/content/wandb/run-20210425_175524-1hx1av67</code><br/><br/>
</div></div>
</div>
</div>
<div class="section" id="data-logging">
<h3>Data logging<a class="headerlink" href="#data-logging" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">run</span> <span class="o">=</span> <span class="n">wandb</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">job_type</span><span class="o">=</span><span class="s2">&quot;data-logging&quot;</span><span class="p">,</span>
                 <span class="n">name</span><span class="o">=</span><span class="s2">&quot;artifact-data&quot;</span><span class="p">,</span>
                 <span class="n">project</span><span class="o">=</span><span class="s1">&#39;SARS Music30 x1&#39;</span><span class="p">)</span>
<span class="n">artifact</span> <span class="o">=</span> <span class="n">wandb</span><span class="o">.</span><span class="n">Artifact</span><span class="p">(</span><span class="s1">&#39;datasets&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;dataset&#39;</span><span class="p">)</span>

<span class="n">train_data</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;train_dataset&#39;</span>
<span class="n">test_data</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;test_dataset&#39;</span>

<span class="k">for</span> <span class="n">dataset</span> <span class="ow">in</span> <span class="p">[</span><span class="n">train_data</span><span class="p">,</span> <span class="n">test_data</span><span class="p">]:</span>
  <span class="n">dataset</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">name</span><span class="o">+</span><span class="s1">&#39;.p&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
  <span class="n">artifact</span><span class="o">.</span><span class="n">add_file</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">name</span><span class="o">+</span><span class="s1">&#39;.p&#39;</span><span class="p">)</span>

<span class="n">run</span><span class="o">.</span><span class="n">log_artifact</span><span class="p">(</span><span class="n">artifact</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">Finishing last run (ID:1lfb8icq) before initializing another...</div><div class="output text_html"><br/>Waiting for W&B process to finish, PID 3950<br/>Program ended successfully.</div><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "116aef4cef364694b3b232219f53fc7b", "version_major": 2, "version_minor": 0}
</script><div class="output text_html">Find user logs for this run at: <code>/content/wandb/run-20210425_180606-1lfb8icq/logs/debug.log</code></div><div class="output text_html">Find internal logs for this run at: <code>/content/wandb/run-20210425_180606-1lfb8icq/logs/debug-internal.log</code></div><div class="output text_html">Synced 4 W&B file(s), 0 media file(s), 2 artifact file(s) and 0 other file(s)</div><div class="output text_html">
<br/>Synced <strong style="color:#cdcd00">artifact-data</strong>: <a href="https://wandb.ai/sparsh121/SARS%20Music30%20x1/runs/1lfb8icq" target="_blank">https://wandb.ai/sparsh121/SARS%20Music30%20x1/runs/1lfb8icq</a><br/>
</div><div class="output text_html">...Successfully finished last run (ID:1lfb8icq). Initializing new run:<br/><br/></div><div class="output text_html">
Tracking run with wandb version 0.10.27<br/>
Syncing run <strong style="color:#cdcd00">artifact-data</strong> to <a href="https://wandb.ai" target="_blank">Weights & Biases</a> <a href="https://docs.wandb.com/integrations/jupyter.html" target="_blank">(Documentation)</a>.<br/>
Project page: <a href="https://wandb.ai/sparsh121/SARS%20Music30%20x1" target="_blank">https://wandb.ai/sparsh121/SARS%20Music30%20x1</a><br/>
Run page: <a href="https://wandb.ai/sparsh121/SARS%20Music30%20x1/runs/3tjioy7t" target="_blank">https://wandb.ai/sparsh121/SARS%20Music30%20x1/runs/3tjioy7t</a><br/>
Run data is saved locally in <code>/content/wandb/run-20210425_180817-3tjioy7t</code><br/><br/>
</div><div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;wandb.sdk.wandb_artifacts.Artifact at 0x7f2a22eeeb50&gt;
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="w-b-experiment-link">
<h2>W&amp;B Experiment Link<a class="headerlink" href="#w-b-experiment-link" title="Permalink to this headline">¶</a></h2>
<p><a class="reference external" href="https://wandb.ai/sparsh121/SARS%20Music30%20x1/overview?workspace=user-sparsh121">https://wandb.ai/sparsh121/SARS Music30 x1/overview?workspace=user-sparsh121</a></p>
<img src='https://www.notion.so/image/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F657b8726-7c78-42e7-8cff-dda688ebc411%2FUntitled.png?table=block&id=d7de3cfe-b62c-45f2-8575-9797aeccc439&spaceId=63b72b1f-0e90-4ab8-a6df-a060a6545a56&width=2000&userId=21ec183f-f0be-4b6b-9b3e-6f0d4e5c5469&cache=v2'><p><a class="reference external" href="https://github.com/mquad/sars_tutorial/">Credits</a></p>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./nbs"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        
            



<div class='prev-next-bottom'>
    
    <div id="prev">
        <a class="left-prev" href="T501828_Recommender_Implicit_Negative_Feedback.html" title="previous page">
            <i class="prevnext-label fas fa-angle-left"></i>
            <div class="prevnext-info">
                <p class="prevnext-label">previous</p>
                <p class="prevnext-title">Retail Product Recommendation with Negative Implicit Feedback</p>
            </div>
        </a>
    </div>
     <div id="next">
        <a class="right-next" href="T051777_image_similarity_recommendations.html" title="next page">
            <div class="prevnext-info">
                <p class="prevnext-label">next</p>
                <p class="prevnext-title">Similar Product Recommendations</p>
            </div>
            <i class="prevnext-label fas fa-angle-right"></i>
        </a>
     </div>

</div>
        
        </div>
    </div>
    <footer class="footer">
    <div class="container">
      <p>
        
          By Sparsh A.<br/>
        
            &copy; Copyright 2021.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>
  
  <script src="../_static/js/index.1c5a1a01449ed65a7b51.js"></script>

  
  </body>
</html>