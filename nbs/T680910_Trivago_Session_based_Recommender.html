
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Trivago Session-based Recommender &#8212; Reco Book</title>
    
  <link href="../_static/css/theme.css" rel="stylesheet" />
  <link href="../_static/css/index.c5995385ac14fb8791e8eb36b4908be2.css" rel="stylesheet" />

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/sphinx-book-theme.css?digest=c3fdc42140077d1ad13ad2f1588a4309" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../_static/js/index.1c5a1a01449ed65a7b51.js">

    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/togglebutton.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/sphinx-book-theme.12a9622fbb08dcb3a2a40b2c02b83a57.js"></script>
    <script async="async" src="https://unpkg.com/thebe@0.5.1/lib/index.js"></script>
    <script >
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Best Ads detection using bandit methods" href="T990000_ads_selection_using_bandits.html" />
    <link rel="prev" title="Flower classification" href="T561435_Flower_Classification.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
      
      
      <h1 class="site-logo" id="site-title">Reco Book</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../index.html">
   Tutorials in Jupyter notebook format
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  User Stories
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="US780867_Transformer_based_Recommenders.html">
   Transformer-based Recommenders
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="T034923_BERT4Rec_on_ML1M_in_PyTorch.html">
     BERT4Rec on ML-1M in PyTorch
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="T595874_BERT4Rec_on_ML25M_in_PyTorch_Lightning.html">
     BERT4Rec on ML-25M
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="T088416_BST_Implementation_in_MXNet.html">
     BST Implementation in MXNet
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="T602245_BST_implementation_in_PyTorch.html">
     BST implementation in PyTorch
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="T007665_BST_on_ML1M_in_Keras.html">
     A Transformer-based recommendation system
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="T881207_BST_PTLightning_ML1M.html">
     Rating prediction using the Behavior Sequence Transformer (BST) model on ML-1M dataset in PyTorch Lightning
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="T025247_BST_using_Deepctr_library.html">
     BST using Deepctr library
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="T757997_SASRec_PyTorch.html">
     SASRec implementation with PyTorch Library
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="T225287_SASRec_PaddlePaddle.html">
     SASRec implementation with Paddle Library
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="T701627_SR_SAN_Session_based_Model.html">
     SR-SAN Session-based Recommender
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="T975104_SSEPT_ML1M_Tensorflow1x.html">
     SSE-PT Personalized Transformer Recommender on ML-1M in Tensorflow 1.x
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="T472955_GCSAN_Session_based_Model.html">
     GCSAN Session-based Recommender
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="T970274_Transformers4Rec_Session_based_Recommender_on_Yoochoose.html">
     End-to-end session-based recommendation with Transformers4Rec
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="T382183_Transformers4Rec_XLNet_on_Synthetic_data.html">
     Transformers4Rec XLNet on Synthetic data
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="T793395_Session_based_recommendation_on_REES46_Dataset.html">
     End-to-end Session-based recommendation on REES46 Dataset
    </a>
   </li>
  </ul>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Prototypes
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="T382881_DeepWalk_Karateclub.html">
   DeepWalk from scratch referencing Karateclub library
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T384270_DeepWalk_pure_python.html">
   DeepWalk in pure python
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T677598_Jaccard_Cosine_SVD_DeepWalk_ML100K.html">
   Recommender System with DeepWalk Graph Embeddings
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T815556_Node2vec_Karateclub.html">
   Node2vec from scratch referencing Karateclub library
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T894941_Node2vec_MovieLens_Keras.html">
   Graph representation learning with node2vec
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T611050_Node2vec_PyG.html">
   Node2vec from scratch in PyTorch Geometric
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T186367_Node2vec_library.html">
   Node2vec from scratch referencing node2vec library
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T331379_bayesian_personalized_ranking.html">
   BPR from scratch
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T081831_Data_Poisoning_Attacks_on_Factorization_Based_Collaborative_Filtering.html">
   Data Poisoning Attacks on Factorization-Based Collaborative Filtering
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T102448_Adversarial_Learning_for_Recommendation.html">
   Adversarial Training (Regularization) on a Recommender System
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T865035_Simulating_Data_Poisoning_Attacks_against_Twitter_Recommender.html">
   Load and process dataset
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T711285_Data_Poisoning_Attack_using_LFM_and_ItemAE_on_Synthetic_Dataset.html">
   Injection attack using LFM and ItemAE model trained on Toy dataset
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T355514_Black_box_Attack_on_Sequential_Recs.html">
   Black-box Attack on Sequential Recs
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T873451_Statistics_fundamentals.html">
   Statictics Fundamentals
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T890478_Batch_Learning_from_Bandit_Feedback_%28BLBF%29.html">
   Imports
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T257798_Off_Policy_Learning_in_Two_stage_Recommender_Systems.html">
   Off-Policy Learning in Two-stage Recommender Systems
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T471827_Adaptive_Estimator_Selection_for_Off_Policy_Evaluation.html">
   Adaptive Estimator Selection for Off-Policy Evaluation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T902666_Evaluating_the_Robustness_of_Off_Policy_Evaluation.html">
   Evaluating the Robustness of Off-Policy Evaluation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T705904_Evaluation_of_Multiple_Off_Policy_Estimators_on_Synthetic_Dataset.html">
   Evaluation of Multiple Off-Policy Estimators on Synthetic Dataset
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T874693_Evaluating_Standard_Off_Policy_Estimators_with_Small_Sample_Open_Bandit_Dataset.html">
   Evaluating Standard Off-Policy Estimators with Small Sample Open-Bandit Dataset
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T792262_Optimal_Off_Policy_Evaluation_from_Multiple_Logging_Policies.html">
   Optimal Off-Policy Evaluation from Multiple Logging Policies
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T167249_Offline_Policy_Evaluation_with_VW_Command_Line.html">
   Offline Policy Evaluation with VW Command Line
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T966055_OBP_Library_Workshop_Tutorials.html">
   OBP Library Workshop Tutorials
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T632722_PyTorch_Fundamentals_Part_1.html">
   PyTorch Fundamentals Part 1
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T472467_PyTorch_Fundamentals_Part_2.html">
   PyTorch Fundamentals Part 2
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T206654_PyTorch_Fundamentals_Part_3.html">
   PyTorch Fundamentals Part 3
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T536348_Attention_Mechanisms.html">
   Imports
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T500796_Agricultural_Satellite_Image_Segmentation.html">
   Agricultural Satellite Image Segmentation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T611432_Image_Analysis_with_Tensorflow.html">
   Image Analysis with Tensorflow
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T925716_MongoDB_to_CSV_Conversion.html">
   MongoDB to CSV conversion
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T396469_PDF_to_Word_Cloud_via_Email.html">
   PDF to WordCloud via Email
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T030890_Job_Scraping_and_Clustering.html">
   Job scraping and clustering
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T897054_Scene_Text_Recognition.html">
   Scene Text Recognition
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T034809_Large_scale_Document_Retrieval_with_Elastic_Search.html">
   Large-scale Document Retrieval with ElasticSearch
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T467251_vowpal_wabbit_contextual_recommender.html">
   Simulating a news personalization scenario using Contextual Bandits
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T686684_similar_product_recommender.html">
   Similar Product Recommender system using Deep Learning for an online e-commerce store
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T132203_Retail_Product_Recommendations_using_Word2vec.html">
   Retail Product Recommendations using word2vec
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T501828_Recommender_Implicit_Negative_Feedback.html">
   Retail Product Recommendation with Negative Implicit Feedback
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T315965_Sequence_Aware_Recommenders_Music.html">
   Sequence Aware Recommender Systems
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T051777_image_similarity_recommendations.html">
   Similar Product Recommendations
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990172_recobook_diversity_aware_book_recommender.html">
   Diversity Aware Book Recommender
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T488549_Goodreads_Diversity_Aware_Book_Recommender.html">
   Diversity Aware Book Recommender
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T023535_Kafka_MongoDB_Real_time_Streaming.html">
   Kafka MongoDB Real-time Streaming
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T622304_Session_based_Recommender_Using_Word2vec.html">
   Session-based recommendation using word2vec
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T416854_bandit_based_recommender_using_thompson_sampling_app.html">
   Bandit-based Online Learning using Thompson Sampling
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T198578_Booking_dot_com_Trip_Recommendation.html">
   Booking.com Trip Recommendation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T519734_Vowpal_Wabbit_Contextual_Bandit.html">
   Vowpal Wabbit Contextual Bandit
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T871537_Recommendation_Systems_using_Olist_Dataset.html">
   Recommendation systems using Olist dataset
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T057885_Offline_Replayer_Evaluation.html">
   Offline Replayer Evaluation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T915054_method_for_effective_online_testing.html">
   Methods for effective online testing
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T513987_Recsys_2020_Feature_Engineering_Tutorial.html">
   Recsys’20 Feature Engineering Tutorial
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T227901_amazon_personalize_batch_job.html">
   Amazon Personalize Batch Job
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T022961_Amazon_Personalize_Workshop.html">
   Amazon Personalize Workshop
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T424437_Collaborative_Filtering_on_ML_latest_small.html">
   Collaborative Filtering on ML-latest-small
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T539160_Building_and_Deploying_ASOS_Fashion_Recommender.html">
   Building and deploying ASOS fashion recommender
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T757697_Simple_Similarity_based_Recommender.html">
   Simple Similarity based Recommmendations
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T051594_Analytics_Zoo.html">
   Analytics Zoo
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T313645_A_B_Testing.html">
   A/B Testing
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T475711_PinSage_Graph_based_Recommender.html">
   PinSage Graph-based Recommender
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T516490_Graph_Embeddings.html">
   Learn Embeddings using Graph Networks
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T822164_movielens_milvus_redis_efficient_retrieval.html">
   Recommender with Redis and Milvus
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T845186_Anime_Recommender.html">
   RekoNet Anime Recommender
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T855843_kafka_spark_streaming_colab.html">
   Kafka and Spark Streaming in Colab
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T460437_Building_Models_From_Scratch.html">
   Building Models from scratch
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T855971_Conet_Model_for_Movie_Recommender.html">
   CoNet model
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T996996_content_based_and_collaborative_movielens.html">
   Movie Recommendation with Content-Based and Collaborative Filtering
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T239418_Simple_Movie_Recommenders.html">
   Simple Movie Recommenders
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T138337_Simple_Movie_Recommender.html">
   Simple movie recommender in implicit, explicit, and cold-start settings
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T935440_The_importance_of_Rating_Normalization.html">
   The importance of Rating Normalization
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T612622_cornac_examples.html">
   Cornac Examples
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T561435_Flower_Classification.html">
   Flower classification
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Trivago Session-based Recommender
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990000_ads_selection_using_bandits.html">
   Best Ads detection using bandit methods
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990000_book_crossing_surprise_svd_nmf.html">
   Book-Crossing Recommendation System
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990000_book_recommender_kubeflow.html">
   Books recommendations with Kubeflow Pipelines on Scaleway Kapsule
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990000_build_a_kubeflow_pipeline.html">
   Build a Kubeflow Pipeline
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990000_causal_inference.html">
   Causal Inference
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990000_concept_embedding_nlp.html">
   Exploring Word Embeddings
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990000_concept_neural_net.html">
   Neural Network
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990000_concept_nlp_basics.html">
   Natural Language Processing 101
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990000_concept_transformer_lm.html">
   TransformerLM Quick Start and Guide
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990000_content_based_music_recommender_lyricsfreak.html">
   Content-based method for song recommendation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990000_evaluation_metrics_basics.html">
   Recommender System Evaluations
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990000_implicit_synthetic.html">
   Comparing Implicit Models on Synthetic Data
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990000_movie_recommender_tensorflow.html">
   Recommendation Systems with TensorFlow
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990000_movie_recommender_tensorflow_sagemaker.html">
   Movie recommender using Tensorflow in Sagemaker
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990000_movielens_eda_modeling.html">
   Movielens EDA and Modeling
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990000_read_data_from_cassandra_into_pandas.html">
   Read Cassandra Data Snapshot as DataFrame
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990000_rl_in_action.html">
   Reinforcement Learning fundamentals in action
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990000_rnn_cnn_basics.html">
   Processing sequences using RNNs and CNNs
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990000_tf_serving_in_action.html">
   TF Serving in action
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990000_training_indexing_movie_recommender.html">
   Training and indexing movie recommender
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T207114_EduRec_MOOCCube_Course_Recommender.html">
   EduRec MOOCCube Course Recommender
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T273184_Multi_Task_Learning.html">
   Multi-task Learning
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T661108_Book_Recommender_API.html">
   Book Recommender API
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T912764_Simple_Movie_Recommender_App.html">
   Simple Movie Recommender App
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T964554_Career_Village_Questions_Recommendation.html">
   CareerVillage Questions Recommendation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990001_amazon_women_apparel_tfidf_word2vec.html">
   Amazon Product Recommender
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990001_anime_recommender_graph_network.html">
   Anime Recommender with Bi-partite Graph Network
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990001_concept_self_attention.html">
   Self-Attention
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990001_course_recommender_svd_flask.html">
   Course Recommender with SVD based similarity
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990001_data_mining_similarity_measures.html">
   Concept - Data Mining Similarity Measures
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990001_jaccard_recommender.html">
   Jaccard Similarity based Recommender
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990001_live_streamer_recommender.html">
   Live Streamer Recommender with Implicit feedback
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990001_songs_embedding_skipgram_recommender.html">
   Song Embeddings - Skipgram Recommender
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990001_toy_example_car_recommender_knn.html">
   Toy example - Car Recommender using KNN method
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990001_wikirecs_recommender.html">
   WikiRecs
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../_sources/nbs/T680910_Trivago_Session_based_Recommender.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/sparsh-ai/reco-book/main?urlpath=tree/nbs/T680910_Trivago_Session_based_Recommender.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="../_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav" aria-label="Page">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#popularity-based-recommender">
   Popularity-based Recommender
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#setup">
     Setup
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#data-loading">
     Data loading
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#utilities">
     Utilities
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#getting-popular-items">
     Getting popular items
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#identify-target-users">
     Identify target users
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#recommendations">
     Recommendations
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#experimenting-with-8-ml-models">
   Experimenting with 8 ML models
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#problem-statement">
     Problem statement
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#context">
       Context
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#challenges">
       Challenges
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#goal">
       Goal
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#illustration">
       Illustration
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#data-description">
     Data description
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#description-of-action-types-and-reference-values-for-all-possible-session-interactions">
       Description of Action Types and Reference Values for All Possible Session Interactions
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#general-statistics-of-the-recsys-challenge-2019-dataset">
       General Statistics of the RecSys Challenge 2019 Dataset
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#session-actions-files">
       Session Actions Files
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id1">
     Setup
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id2">
     Data loading
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#full-load">
       Full load
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#sample-load">
       Sample load
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id3">
     Utilities
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#feature-engineering">
     Feature engineering
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#models">
     Models
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#list-of-models">
       List of models
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#random">
       random
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#position">
       position
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#pop-abs">
       pop_abs
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#pop-user">
       pop_user
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#nn-item">
       nn_item
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#nn-interaction">
       nn_interaction
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#log-reg">
       log_reg
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#gbm-rank">
       gbm_rank
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="section" id="trivago-session-based-recommender">
<h1>Trivago Session-based Recommender<a class="headerlink" href="#trivago-session-based-recommender" title="Permalink to this headline">¶</a></h1>
<div class="section" id="popularity-based-recommender">
<h2>Popularity-based Recommender<a class="headerlink" href="#popularity-based-recommender" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><p>Using Recsys 2019 challange Trivago travel dataset to build popularity based model and recommending popular most clicked destinations to the users</p>
</div></blockquote>
<div class="section" id="setup">
<h3>Setup<a class="headerlink" href="#setup" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>!pip install -q git+https://github.com/sparsh-ai/recochef.git
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">recochef.datasets.trivago</span> <span class="kn">import</span> <span class="n">Trivago</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="data-loading">
<h3>Data loading<a class="headerlink" href="#data-loading" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">trivago</span> <span class="o">=</span> <span class="n">Trivago</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df_train</span> <span class="o">=</span> <span class="n">trivago</span><span class="o">.</span><span class="n">load_train</span><span class="p">()</span>
<span class="n">df_train</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>USERID</th>
      <th>SESSIONID</th>
      <th>TIMESTAMP</th>
      <th>STEP</th>
      <th>EVENTTYPE</th>
      <th>REFERENCE</th>
      <th>PLATFORM</th>
      <th>CITY</th>
      <th>DEVICE</th>
      <th>FILTERS</th>
      <th>IMPRESSIONS</th>
      <th>PRICES</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>00RL8Z82B2Z1</td>
      <td>aff3928535f48</td>
      <td>1541037460</td>
      <td>1</td>
      <td>search for poi</td>
      <td>Newtown</td>
      <td>AU</td>
      <td>Sydney, Australia</td>
      <td>mobile</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
    </tr>
    <tr>
      <th>1</th>
      <td>00RL8Z82B2Z1</td>
      <td>aff3928535f48</td>
      <td>1541037522</td>
      <td>2</td>
      <td>interaction item image</td>
      <td>666856</td>
      <td>AU</td>
      <td>Sydney, Australia</td>
      <td>mobile</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
    </tr>
    <tr>
      <th>2</th>
      <td>00RL8Z82B2Z1</td>
      <td>aff3928535f48</td>
      <td>1541037522</td>
      <td>3</td>
      <td>interaction item image</td>
      <td>666856</td>
      <td>AU</td>
      <td>Sydney, Australia</td>
      <td>mobile</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
    </tr>
    <tr>
      <th>3</th>
      <td>00RL8Z82B2Z1</td>
      <td>aff3928535f48</td>
      <td>1541037532</td>
      <td>4</td>
      <td>interaction item image</td>
      <td>666856</td>
      <td>AU</td>
      <td>Sydney, Australia</td>
      <td>mobile</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
    </tr>
    <tr>
      <th>4</th>
      <td>00RL8Z82B2Z1</td>
      <td>aff3928535f48</td>
      <td>1541037532</td>
      <td>5</td>
      <td>interaction item image</td>
      <td>109038</td>
      <td>AU</td>
      <td>Sydney, Australia</td>
      <td>mobile</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df_test</span> <span class="o">=</span> <span class="n">trivago</span><span class="o">.</span><span class="n">load_test</span><span class="p">()</span>
<span class="n">df_test</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>USERID</th>
      <th>SESSIONID</th>
      <th>TIMESTAMP</th>
      <th>STEP</th>
      <th>EVENTTYPE</th>
      <th>REFERENCE</th>
      <th>PLATFORM</th>
      <th>CITY</th>
      <th>DEVICE</th>
      <th>FILTERS</th>
      <th>IMPRESSIONS</th>
      <th>PRICES</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>004A07DM0IDW</td>
      <td>1d688ec168932</td>
      <td>1541555614</td>
      <td>1</td>
      <td>interaction item image</td>
      <td>2059240</td>
      <td>CO</td>
      <td>Santa Marta, Colombia</td>
      <td>mobile</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
    </tr>
    <tr>
      <th>1</th>
      <td>004A07DM0IDW</td>
      <td>1d688ec168932</td>
      <td>1541555614</td>
      <td>2</td>
      <td>interaction item image</td>
      <td>2059240</td>
      <td>CO</td>
      <td>Santa Marta, Colombia</td>
      <td>mobile</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
    </tr>
    <tr>
      <th>2</th>
      <td>004A07DM0IDW</td>
      <td>1d688ec168932</td>
      <td>1541555696</td>
      <td>3</td>
      <td>clickout item</td>
      <td>1050068</td>
      <td>CO</td>
      <td>Santa Marta, Colombia</td>
      <td>mobile</td>
      <td>None</td>
      <td>2059240|2033381|1724779|127131|399441|103357|1...</td>
      <td>70|46|48|76|65|65|106|66|87|43|52|44|60|61|50|...</td>
    </tr>
    <tr>
      <th>3</th>
      <td>004A07DM0IDW</td>
      <td>1d688ec168932</td>
      <td>1541555707</td>
      <td>4</td>
      <td>clickout item</td>
      <td>1050068</td>
      <td>CO</td>
      <td>Santa Marta, Colombia</td>
      <td>mobile</td>
      <td>None</td>
      <td>2059240|2033381|1724779|127131|399441|103357|1...</td>
      <td>70|46|48|76|65|65|106|66|87|43|52|44|60|61|50|...</td>
    </tr>
    <tr>
      <th>4</th>
      <td>004A07DM0IDW</td>
      <td>1d688ec168932</td>
      <td>1541555717</td>
      <td>5</td>
      <td>clickout item</td>
      <td>1050068</td>
      <td>CO</td>
      <td>Santa Marta, Colombia</td>
      <td>mobile</td>
      <td>None</td>
      <td>2059240|2033381|1724779|127131|399441|103357|1...</td>
      <td>70|46|48|76|65|65|106|66|87|43|52|44|60|61|50|...</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</div>
<div class="section" id="utilities">
<h3>Utilities<a class="headerlink" href="#utilities" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">GR_COLS</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;USERID&quot;</span><span class="p">,</span> <span class="s2">&quot;SESSIONID&quot;</span><span class="p">,</span> <span class="s2">&quot;TIMESTAMP&quot;</span><span class="p">,</span> <span class="s2">&quot;STEP&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_submission_target</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Identify target rows with missing click outs.&quot;&quot;&quot;</span>

    <span class="n">mask</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;REFERENCE&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;EVENTTYPE&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;clickout item&quot;</span><span class="p">)</span>
    <span class="n">df_out</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">df_out</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_popularity</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get number of clicks that each item received in the df.&quot;&quot;&quot;</span>

    <span class="n">mask</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;EVENTTYPE&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;clickout item&quot;</span>
    <span class="n">df_clicks</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
    <span class="n">df_item_clicks</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">df_clicks</span>
        <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;REFERENCE&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">size</span><span class="p">()</span>
        <span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;NCLICKS&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">))</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">df_item_clicks</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">string_to_array</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert pipe separated string to array.&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;|&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">math</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Value must be either string of nan&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">out</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">explode</span><span class="p">(</span><span class="n">df_in</span><span class="p">,</span> <span class="n">col_expl</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Explode column col_expl of array type into multiple rows.&quot;&quot;&quot;</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">df_in</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">col_expl</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col_expl</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">string_to_array</span><span class="p">)</span>

    <span class="n">df_out</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
        <span class="p">{</span><span class="n">col</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
                        <span class="n">df</span><span class="p">[</span><span class="n">col_expl</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">len</span><span class="p">())</span>
         <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">col_expl</span><span class="p">)}</span>
    <span class="p">)</span>

    <span class="n">df_out</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">col_expl</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">col_expl</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
    <span class="n">df_out</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">col_expl</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_out</span><span class="p">[</span><span class="n">col_expl</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">df_out</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">group_concat</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">gr_cols</span><span class="p">,</span> <span class="n">col_concat</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Concatenate multiple rows into one.&quot;&quot;&quot;</span>

    <span class="n">df_out</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">df</span>
        <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">gr_cols</span><span class="p">)[</span><span class="n">col_concat</span><span class="p">]</span>
        <span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="o">.</span><span class="n">to_frame</span><span class="p">()</span>
        <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">df_out</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">calc_recommendation</span><span class="p">(</span><span class="n">df_expl</span><span class="p">,</span> <span class="n">df_pop</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Calculate recommendations based on popularity of items.</span>
<span class="sd">    The final data frame will have an impression list sorted according to the number of clicks per item in a reference data frame.</span>
<span class="sd">    :param df_expl: Data frame with exploded impression list</span>
<span class="sd">    :param df_pop: Data frame with items and number of clicks</span>
<span class="sd">    :return: Data frame with sorted impression list according to popularity in df_pop</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">df_expl_clicks</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">df_expl</span><span class="p">[</span><span class="n">GR_COLS</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;IMPRESSIONS&quot;</span><span class="p">]]</span>
        <span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df_pop</span><span class="p">,</span>
               <span class="n">left_on</span><span class="o">=</span><span class="s2">&quot;IMPRESSIONS&quot;</span><span class="p">,</span>
               <span class="n">right_on</span><span class="o">=</span><span class="s2">&quot;REFERENCE&quot;</span><span class="p">,</span>
               <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="n">df_out</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">df_expl_clicks</span>
        <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">IMPRESSIONS</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;IMPRESSIONS&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="nb">str</span><span class="p">))</span>
        <span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">GR_COLS</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;NCLICKS&quot;</span><span class="p">],</span>
                     <span class="n">ascending</span><span class="o">=</span><span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">])</span>
    <span class="p">)</span>

    <span class="n">df_out</span> <span class="o">=</span> <span class="n">group_concat</span><span class="p">(</span><span class="n">df_out</span><span class="p">,</span> <span class="n">GR_COLS</span><span class="p">,</span> <span class="s2">&quot;IMPRESSIONS&quot;</span><span class="p">)</span>
    <span class="n">df_out</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;IMPRESSIONS&#39;</span><span class="p">:</span> <span class="s1">&#39;ITEM_RECOMMENDATIONS&#39;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">df_out</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="getting-popular-items">
<h3>Getting popular items<a class="headerlink" href="#getting-popular-items" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Get popular items...&quot;</span><span class="p">)</span>
<span class="n">df_popular</span> <span class="o">=</span> <span class="n">get_popularity</span><span class="p">(</span><span class="n">df_train</span><span class="p">)</span>
<span class="n">df_popular</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;NCLICKS&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Get popular items...
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>REFERENCE</th>
      <th>NCLICKS</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>256511</th>
      <td>8796</td>
      <td>822</td>
    </tr>
    <tr>
      <th>253386</th>
      <td>8561</td>
      <td>763</td>
    </tr>
    <tr>
      <th>254018</th>
      <td>8621</td>
      <td>726</td>
    </tr>
    <tr>
      <th>253665</th>
      <td>8589</td>
      <td>652</td>
    </tr>
    <tr>
      <th>45275</th>
      <td>1455251</td>
      <td>648</td>
    </tr>
    <tr>
      <th>253635</th>
      <td>8586</td>
      <td>634</td>
    </tr>
    <tr>
      <th>253989</th>
      <td>8618</td>
      <td>627</td>
    </tr>
    <tr>
      <th>284354</th>
      <td>9773310</td>
      <td>554</td>
    </tr>
    <tr>
      <th>535</th>
      <td>100227</td>
      <td>539</td>
    </tr>
    <tr>
      <th>256679</th>
      <td>8805412</td>
      <td>525</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</div>
<div class="section" id="identify-target-users">
<h3>Identify target users<a class="headerlink" href="#identify-target-users" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Identify target rows...&quot;</span><span class="p">)</span>
<span class="n">df_target</span> <span class="o">=</span> <span class="n">get_submission_target</span><span class="p">(</span><span class="n">df_test</span><span class="p">)</span>
<span class="n">df_target</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Identify target rows...
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>USERID</th>
      <th>SESSIONID</th>
      <th>TIMESTAMP</th>
      <th>STEP</th>
      <th>EVENTTYPE</th>
      <th>REFERENCE</th>
      <th>PLATFORM</th>
      <th>CITY</th>
      <th>DEVICE</th>
      <th>FILTERS</th>
      <th>IMPRESSIONS</th>
      <th>PRICES</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>6</th>
      <td>004A07DM0IDW</td>
      <td>1d688ec168932</td>
      <td>1541555799</td>
      <td>7</td>
      <td>clickout item</td>
      <td>None</td>
      <td>CO</td>
      <td>Santa Marta, Colombia</td>
      <td>mobile</td>
      <td>None</td>
      <td>2059240|2033381|1724779|127131|399441|103357|1...</td>
      <td>70|46|48|76|65|65|106|66|87|43|52|44|60|61|50|...</td>
    </tr>
    <tr>
      <th>8</th>
      <td>009RGHI3G9A3</td>
      <td>f05ab0de907e2</td>
      <td>1541570940</td>
      <td>2</td>
      <td>clickout item</td>
      <td>None</td>
      <td>IN</td>
      <td>Nathdwara, India</td>
      <td>mobile</td>
      <td>None</td>
      <td>10884872|7065316</td>
      <td>64|28</td>
    </tr>
    <tr>
      <th>10</th>
      <td>00Y1Z24X8084</td>
      <td>26b6d294d66e7</td>
      <td>1541651823</td>
      <td>2</td>
      <td>clickout item</td>
      <td>None</td>
      <td>PH</td>
      <td>Iloilo City, Philippines</td>
      <td>mobile</td>
      <td>None</td>
      <td>2714480|4476010|3843244|3833012|9017890|198100...</td>
      <td>74|14|22|38|55|44|28|34|23|27|12|108|19|21|36|...</td>
    </tr>
    <tr>
      <th>15</th>
      <td>01V3WDTDM5CU</td>
      <td>07628a0f5be0b</td>
      <td>1541575643</td>
      <td>5</td>
      <td>clickout item</td>
      <td>None</td>
      <td>PL</td>
      <td>Wisla, Poland</td>
      <td>mobile</td>
      <td>Sort by Price</td>
      <td>3565720|2947584|4115018|2039671|3836538|801409...</td>
      <td>16|18|20|21|22|22|28|28|28|30|30|33|33|35|35|3...</td>
    </tr>
    <tr>
      <th>61</th>
      <td>02AOAVF9PVYH</td>
      <td>4a01c3afbc224</td>
      <td>1541681278</td>
      <td>46</td>
      <td>clickout item</td>
      <td>None</td>
      <td>JP</td>
      <td>Yokohama, Japan</td>
      <td>desktop</td>
      <td>Hotel|Resort|Sort by Price</td>
      <td>1451247|559056|1045096|1963879|693596|1967173|...</td>
      <td>80|81|81|82|82|82|83|83|83|85|85|88|88|91|92|9...</td>
    </tr>
    <tr>
      <th>109</th>
      <td>0339C84S24ET</td>
      <td>89171d441a304</td>
      <td>1541615683</td>
      <td>36</td>
      <td>clickout item</td>
      <td>None</td>
      <td>TR</td>
      <td>Antalya, Turkey</td>
      <td>mobile</td>
      <td>None</td>
      <td>13361|5647680|116764|898719|8276346|9168|19325...</td>
      <td>185|84|30|19|46|77|123|23|25|25|26|39|73|56|96...</td>
    </tr>
    <tr>
      <th>111</th>
      <td>0386OH8JDE1Q</td>
      <td>e09591d07cdef</td>
      <td>1541620536</td>
      <td>2</td>
      <td>clickout item</td>
      <td>None</td>
      <td>UK</td>
      <td>John o' Groats, United Kingdom</td>
      <td>desktop</td>
      <td>None</td>
      <td>1193320|5488246|3858774|4552034|10620372|22696...</td>
      <td>103|88|100|134|109|138|126|86</td>
    </tr>
    <tr>
      <th>115</th>
      <td>03LTH89QY623</td>
      <td>7663406cf586c</td>
      <td>1541554183</td>
      <td>4</td>
      <td>clickout item</td>
      <td>None</td>
      <td>CA</td>
      <td>Koloa, USA</td>
      <td>desktop</td>
      <td>None</td>
      <td>241961|906477|991561|353701|1149665|77258|4943...</td>
      <td>287|300|261|197|163|263|262|188|540|283|211|22...</td>
    </tr>
    <tr>
      <th>138</th>
      <td>03VT0ODUTZB0</td>
      <td>725e8adf70e86</td>
      <td>1541632490</td>
      <td>23</td>
      <td>clickout item</td>
      <td>None</td>
      <td>UK</td>
      <td>Warrington, United Kingdom</td>
      <td>desktop</td>
      <td>None</td>
      <td>109938|164193|632366|1362450|1070666|164220|11...</td>
      <td>45|67|78|60|58|57|86|68|57|55|148|92|66|55|61|...</td>
    </tr>
    <tr>
      <th>314</th>
      <td>03XH0JWCWHAM</td>
      <td>73f4c417ff730</td>
      <td>1541566143</td>
      <td>176</td>
      <td>clickout item</td>
      <td>None</td>
      <td>MX</td>
      <td>Puebla, Mexico</td>
      <td>mobile</td>
      <td>Sort By Popularity</td>
      <td>42692|5116230|42876|4342578|42864|3148690|2123...</td>
      <td>53|181|60|45|96|60|80|59|41|122|50|43|113|48|5...</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</div>
<div class="section" id="recommendations">
<h3>Recommendations<a class="headerlink" href="#recommendations" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Get recommendations...&quot;</span><span class="p">)</span>
<span class="n">df_expl</span> <span class="o">=</span> <span class="n">explode</span><span class="p">(</span><span class="n">df_target</span><span class="p">,</span> <span class="s2">&quot;IMPRESSIONS&quot;</span><span class="p">)</span>
<span class="n">df_out</span> <span class="o">=</span> <span class="n">calc_recommendation</span><span class="p">(</span><span class="n">df_expl</span><span class="p">,</span> <span class="n">df_popular</span><span class="p">)</span>
<span class="n">df_out</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Get recommendations...
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>USERID</th>
      <th>SESSIONID</th>
      <th>TIMESTAMP</th>
      <th>STEP</th>
      <th>ITEM_RECOMMENDATIONS</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>000324D9BBUC</td>
      <td>89643988fdbfb</td>
      <td>1541593942</td>
      <td>10</td>
      <td>924795 106315 1033140 119494 101758 903037 105...</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0004Q49X39PY</td>
      <td>9de47d9a66494</td>
      <td>1541641157</td>
      <td>1</td>
      <td>3505150 3812004 2227896 2292254 3184842 222702...</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0004Q49X39PY</td>
      <td>beea5c27030cb</td>
      <td>1541561202</td>
      <td>1</td>
      <td>4476010 3505150 3812004 2227896 2292254 222702...</td>
    </tr>
    <tr>
      <th>3</th>
      <td>00071784XQ6B</td>
      <td>9617600e1ba7c</td>
      <td>1541630328</td>
      <td>2</td>
      <td>22854 3067559 22721 22713 16121 22772 22727 22...</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0008BO33KUQ0</td>
      <td>2d0e2102ee0dc</td>
      <td>1541636411</td>
      <td>6</td>
      <td>9857656 5849628 655716 1352530 502066 1405084 ...</td>
    </tr>
    <tr>
      <th>5</th>
      <td>000GO9NY6P4M</td>
      <td>55dbafdbb9bab</td>
      <td>1541594662</td>
      <td>2</td>
      <td>160577 157710 1618677 7231396 483691 1479743 1...</td>
    </tr>
    <tr>
      <th>6</th>
      <td>000IRHJS2DL9</td>
      <td>f6ffffd20d43d</td>
      <td>1541605541</td>
      <td>12</td>
      <td>33191 20144 20166 20154 3054956 346166 102540 ...</td>
    </tr>
    <tr>
      <th>7</th>
      <td>000JB0UNEH23</td>
      <td>7df07dc9fe26e</td>
      <td>1541618174</td>
      <td>1</td>
      <td>3874514 2909994 9503248 2526088 3167136 916982...</td>
    </tr>
    <tr>
      <th>8</th>
      <td>000OWRCYEHKT</td>
      <td>53e84da5c2dad</td>
      <td>1541706095</td>
      <td>3</td>
      <td>8758048 7195486 1153302 7795438 5416250 898083...</td>
    </tr>
    <tr>
      <th>9</th>
      <td>000VBY1D6BP8</td>
      <td>033fddaaa99af</td>
      <td>1541587306</td>
      <td>4</td>
      <td>32230 32233 32256 5411980 32235 6865398 32246 ...</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</div>
</div>
<div class="section" id="experimenting-with-8-ml-models">
<h2>Experimenting with 8 ML models<a class="headerlink" href="#experimenting-with-8-ml-models" title="Permalink to this headline">¶</a></h2>
<div class="section" id="problem-statement">
<h3>Problem statement<a class="headerlink" href="#problem-statement" title="Permalink to this headline">¶</a></h3>
<div class="section" id="context">
<h4>Context<a class="headerlink" href="#context" title="Permalink to this headline">¶</a></h4>
<p>Recommending hotels and other travel-related items is still a difficult task, as travel and tourism is a very complex domain. Planning a trip usually involves searching for a set or package of products that are interconnected (e.g., means of transportation, lodging, attractions), with rather limited availability, and where contextual aspects may have a major impact (e.g., time, location, social context). Users book much fewer hotels than, for example, listen to music tracks, and, given the financial obligation of booking a stay at a hotel, users usually exhibit a strong price sensitivity and a bigger need to be convinced by any given offer. Besides, travelers are often emotionally connected to the products and the experience they provide. Therefore, decision making is not only based on rational and objective criteria. As such, providing the right information to visitors to a travel site, such as a hotel booking service, at the right time is challenging. Information about items such as hotels is often available as item metadata. However, usually, in this domain information about users and their goals and preferences is harder to obtain. Systems need to analyze session-based data of anonymous or first-time users to adapt the search results and anticipate the hotels the users may be interested in.</p>
<p>Trivago is a global hotel search platform focused on reshaping the way travelers search for and compare hotels, while enabling advertisers of hotels to grow their businesses by providing access to a broad audience of travelers via their websites and apps. Trivago provide aggregated information about the characteristics of each accommodation to help travelers to make an informed decision and find their ideal place to stay. Once a choice is made, the users get redirected to the selected booking site to complete the booking. Trivago has established 55 localized platforms in over 190 countries and provides access to over two million hotels, including alternative accommodations, with prices and availability from over 400+ booking sites and hotel chains.</p>
<p>Our users can narrow down their search by selecting filters and specifying the desired characteristics of their preferred accommodation. They can interact with the different offers presented to them and consume the aggregated information for each listing to make an informed decision and find their ideal place to stay. Once a choice is made, the users get redirected to the selected booking site to complete the booking. It is in the interest of all participants (traveler, advertising booking site, and trivago) to suggest suitable accommodations that fit the needs of the traveler.</p>
<blockquote>
<div><p><em>We partnered with researchers from TU Wien, Politecnico di Milano, and Karlsruhe Institute of Technology to launch the RecSys Challenge 2019, the annual data science challenge of the ACM Recommender Systems conference. In this challenge, we invite participants to dig deep into our data and come up with creative ideas to detect the intent of our users and build a click-prediction model that can be used to update the recommendation of accommodations. To this end, we have released a data set of user interactions on our website.</em></p>
</div></blockquote>
</div>
<div class="section" id="challenges">
<h4>Challenges<a class="headerlink" href="#challenges" title="Permalink to this headline">¶</a></h4>
<p>Trivago face a few challenges when it comes to recommending the best options for their visitors, so it’s important to effectively make use of the explicit and implicit user signals within a session (clicks, search refinement, filter usage) to detect the users’ intent as quickly as possible and to update the recommendations to tailor the result list to these needs.</p>
<p>Due to the nature of our domain, we face specific challenges that make it difficult to build predictive models and recommendation systems that are tailored to the needs of our visitors. Here are a few examples of the problems that trivago data scientists have to address:</p>
<ul class="simple">
<li><p>Users search for accommodations comparatively infrequently with sometimes long time intervals between their trips. Furthermore, user intent and preferences change over time and depend on the purpose of the trip (e.g. a business traveler who books accommodation for a weekend trip with her family).</p></li>
<li><p>Booking accommodation is an expensive transaction. Visitors are price sensitive and careful when they make a decision. As the availability of the accommodations, the search criteria, and the actual pricing of the deals from the advertisers vary over time, the context­ of each search has to be taken into consideration.</p></li>
<li><p>Information about the personal preferences of travelers is sparse. The service provided to our users is free of charge ─ users do not have to provide personal data or make an account in order to use the website.</p></li>
</ul>
</div>
<div class="section" id="goal">
<h4>Goal<a class="headerlink" href="#goal" title="Permalink to this headline">¶</a></h4>
<p>The task of the challenge is to use all the information about the behavioral, time-dependent patterns of the users and the content of the displayed accommodations to develop models that allow to predict which accommodations a user is most likely to click on when presented with a list of potential options.</p>
<img src='https://www.notion.so/image/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F13fad4be-f873-405f-91e0-4322f94daed6%2FUntitled.png?table=block&id=d3f22fbe-2e09-4161-ac76-5734799d6046&spaceId=63b72b1f-0e90-4ab8-a6df-a060a6545a56&width=2000&userId=21ec183f-f0be-4b6b-9b3e-6f0d4e5c5469&cache=v2'></div>
<div class="section" id="illustration">
<h4>Illustration<a class="headerlink" href="#illustration" title="Permalink to this headline">¶</a></h4>
<img src='https://www.notion.so/image/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F82e33778-55b7-4b02-8fc0-86be96fa0489%2FUntitled.png?table=block&id=6075b0c6-5288-42f3-9070-6e405d2ec01d&spaceId=63b72b1f-0e90-4ab8-a6df-a060a6545a56&width=2000&userId=21ec183f-f0be-4b6b-9b3e-6f0d4e5c5469&cache=v2'><p>Schematic illustration of the dataset and how it is split between train and test set. Each icon in the schematic represents a different type of website interaction, such as clicking on item content (image, info, rating, deals), refining the search parameters via filtering, or triggering new searches for accommodations (items) or destinations. All interactions can be performed by the users and are indicated by the icons in the schematic. Gaps between consecutive interactions indicate the start of a new user session. The train set contains sessions before November 7, 2018, while the test set contains sessions after said date. The item_id of the final click out (shown as the box with the question marks) has been withheld. Note that the question mark refers only to the accommodation identifier that needs to be predicted and not the action type and that every event for which a prediction needs to be made is a click-out. For the evaluation of the leaderboard, the test set has been split into confirmation and a validation set on a user basis.</p>
</div>
</div>
<div class="section" id="data-description">
<h3>Data description<a class="headerlink" href="#data-description" title="Permalink to this headline">¶</a></h3>
<p>Trivago provided two sets of data, the user-item interaction and the item metadata. The interaction dataset consists of the sequential website interactions of users visiting the trivago website between November 1, 2018, and November 8, 2018. Each website interaction corresponds to a specific timestamp in the dataset. Multiple website interactions can appear in a user session. A session is defined as all interactions of a user on a specific trivago country platform with no gaps between the interaction timestamps of &gt;60 minutes. If a user stops interacting with the website and returns after a couple of minutes to continue the search, then the continued interactions will still be counted to belong to the same session. Because of the grouping of website interactions into sessions, the interactions are in the following often referred to as session actions. For each session interaction, data about the context of the interaction are provided, e.g., the country platform on which the interaction took place or the list of items that were shown at the moment of a click and the prices of the accommodations.</p>
<div class="section" id="description-of-action-types-and-reference-values-for-all-possible-session-interactions">
<h4>Description of Action Types and Reference Values for All Possible Session Interactions<a class="headerlink" href="#description-of-action-types-and-reference-values-for-all-possible-session-interactions" title="Permalink to this headline">¶</a></h4>
<img src='https://www.notion.so/image/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2Facfd9fe5-deb6-45ee-845c-2dd3a998a999%2FUntitled.png?table=block&id=dab10ca3-fad5-47a2-8d6b-efbdda887af6&spaceId=63b72b1f-0e90-4ab8-a6df-a060a6545a56&width=2000&userId=21ec183f-f0be-4b6b-9b3e-6f0d4e5c5469&cache=v2'><p>Each website interaction corresponds to a specific timestamp in the dataset. Multiple website interactions can appear in a user session. A session is defined as all interactions of a user on a specific trivago country platform with no gaps between the interaction timestamps of &gt;60 minutes. If a user stops interacting with the website and returns after a couple of minutes to continue the search, then the continued interactions will still be counted to belong to the same session. Because of the grouping of website interactions into sessions, the interactions are in the following often referred to as session actions. For each session interaction, data about the context of the interaction are provided, e.g., the country platform on which the interaction took place or the list of items that were shown at the moment of a click and the prices of the accommodations. Metadata for each of the accommodations are provided in a separate file.</p>
</div>
<div class="section" id="general-statistics-of-the-recsys-challenge-2019-dataset">
<h4>General Statistics of the RecSys Challenge 2019 Dataset<a class="headerlink" href="#general-statistics-of-the-recsys-challenge-2019-dataset" title="Permalink to this headline">¶</a></h4>
<img src='https://www.notion.so/image/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2Faa1eef49-b9d3-4050-9280-74338885ef03%2FUntitled.png?table=block&id=f01385ea-3da1-4022-aac5-c008ef5a5b2e&spaceId=63b72b1f-0e90-4ab8-a6df-a060a6545a56&width=2000&userId=21ec183f-f0be-4b6b-9b3e-6f0d4e5c5469&cache=v2'></div>
<div class="section" id="session-actions-files">
<h4>Session Actions Files<a class="headerlink" href="#session-actions-files" title="Permalink to this headline">¶</a></h4>
<p>Each row in the session action files (train.csv and test.csv) corresponds to a particular user action in a given session. The schema of these files is shown in the below table. The split between the train and test sets was done at a particular split date. That is, sessions that occurred before November 7, 2018, were put into the train set, while those that occurred after were put into the test set. The target of the test set is items clicked out at the end of the sessions in the test set.</p>
<img src='https://www.notion.so/image/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F72401a25-0243-4ae3-baf3-aaac573e222d%2FUntitled.png?table=block&id=866ddad9-677b-47da-a6b8-0cd7149b82c0&spaceId=63b72b1f-0e90-4ab8-a6df-a060a6545a56&width=2000&userId=21ec183f-f0be-4b6b-9b3e-6f0d4e5c5469&cache=v2'><p>In addition to the user actions, the train.csv and test.csv files also contain information about the accommodations that were displayed to the user at the time a clickout was made. An accommodation that is displayed is referred to as being “impressed” and all displayed accommodations are stored in the “impressions” column. Each row in that column is a list of accommodations (items) in the order in which they were displayed on the website. In case the user action was not a clickout, the impressions column is left empty.</p>
</div>
</div>
<div class="section" id="id1">
<h3>Setup<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>!pip install -q git+https://github.com/sparsh-ai/recochef.git
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="n">load_ext</span> <span class="n">autoreload</span>
<span class="o">%</span><span class="n">autoreload</span> <span class="mi">2</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">sparse</span>

<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LogisticRegression</span>
<span class="kn">import</span> <span class="nn">lightgbm</span> <span class="k">as</span> <span class="nn">lgb</span>

<span class="kn">from</span> <span class="nn">recochef.datasets.trivago</span> <span class="kn">import</span> <span class="n">Trivago</span>
<span class="kn">from</span> <span class="nn">recochef.datasets.synthetic</span> <span class="kn">import</span> <span class="n">Session</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="id2">
<h3>Data loading<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h3>
<div class="section" id="full-load">
<h4>Full load<a class="headerlink" href="#full-load" title="Permalink to this headline">¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">trivago</span> <span class="o">=</span> <span class="n">Trivago</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df_train</span> <span class="o">=</span> <span class="n">trivago</span><span class="o">.</span><span class="n">load_train</span><span class="p">()</span>
<span class="n">df_train</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>USERID</th>
      <th>SESSIONID</th>
      <th>TIMESTAMP</th>
      <th>STEP</th>
      <th>EVENTTYPE</th>
      <th>REFERENCE</th>
      <th>PLATFORM</th>
      <th>CITY</th>
      <th>DEVICE</th>
      <th>FILTERS</th>
      <th>IMPRESSIONS</th>
      <th>PRICES</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>00RL8Z82B2Z1</td>
      <td>aff3928535f48</td>
      <td>1541037460</td>
      <td>1</td>
      <td>search for poi</td>
      <td>Newtown</td>
      <td>AU</td>
      <td>Sydney, Australia</td>
      <td>mobile</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
    </tr>
    <tr>
      <th>1</th>
      <td>00RL8Z82B2Z1</td>
      <td>aff3928535f48</td>
      <td>1541037522</td>
      <td>2</td>
      <td>interaction item image</td>
      <td>666856</td>
      <td>AU</td>
      <td>Sydney, Australia</td>
      <td>mobile</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
    </tr>
    <tr>
      <th>2</th>
      <td>00RL8Z82B2Z1</td>
      <td>aff3928535f48</td>
      <td>1541037522</td>
      <td>3</td>
      <td>interaction item image</td>
      <td>666856</td>
      <td>AU</td>
      <td>Sydney, Australia</td>
      <td>mobile</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
    </tr>
    <tr>
      <th>3</th>
      <td>00RL8Z82B2Z1</td>
      <td>aff3928535f48</td>
      <td>1541037532</td>
      <td>4</td>
      <td>interaction item image</td>
      <td>666856</td>
      <td>AU</td>
      <td>Sydney, Australia</td>
      <td>mobile</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
    </tr>
    <tr>
      <th>4</th>
      <td>00RL8Z82B2Z1</td>
      <td>aff3928535f48</td>
      <td>1541037532</td>
      <td>5</td>
      <td>interaction item image</td>
      <td>109038</td>
      <td>AU</td>
      <td>Sydney, Australia</td>
      <td>mobile</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df_test</span> <span class="o">=</span> <span class="n">trivago</span><span class="o">.</span><span class="n">load_test</span><span class="p">()</span>
<span class="n">df_test</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>USERID</th>
      <th>SESSIONID</th>
      <th>TIMESTAMP</th>
      <th>STEP</th>
      <th>EVENTTYPE</th>
      <th>REFERENCE</th>
      <th>PLATFORM</th>
      <th>CITY</th>
      <th>DEVICE</th>
      <th>FILTERS</th>
      <th>IMPRESSIONS</th>
      <th>PRICES</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>004A07DM0IDW</td>
      <td>1d688ec168932</td>
      <td>1541555614</td>
      <td>1</td>
      <td>interaction item image</td>
      <td>2059240</td>
      <td>CO</td>
      <td>Santa Marta, Colombia</td>
      <td>mobile</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
    </tr>
    <tr>
      <th>1</th>
      <td>004A07DM0IDW</td>
      <td>1d688ec168932</td>
      <td>1541555614</td>
      <td>2</td>
      <td>interaction item image</td>
      <td>2059240</td>
      <td>CO</td>
      <td>Santa Marta, Colombia</td>
      <td>mobile</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
    </tr>
    <tr>
      <th>2</th>
      <td>004A07DM0IDW</td>
      <td>1d688ec168932</td>
      <td>1541555696</td>
      <td>3</td>
      <td>clickout item</td>
      <td>1050068</td>
      <td>CO</td>
      <td>Santa Marta, Colombia</td>
      <td>mobile</td>
      <td>None</td>
      <td>2059240|2033381|1724779|127131|399441|103357|1...</td>
      <td>70|46|48|76|65|65|106|66|87|43|52|44|60|61|50|...</td>
    </tr>
    <tr>
      <th>3</th>
      <td>004A07DM0IDW</td>
      <td>1d688ec168932</td>
      <td>1541555707</td>
      <td>4</td>
      <td>clickout item</td>
      <td>1050068</td>
      <td>CO</td>
      <td>Santa Marta, Colombia</td>
      <td>mobile</td>
      <td>None</td>
      <td>2059240|2033381|1724779|127131|399441|103357|1...</td>
      <td>70|46|48|76|65|65|106|66|87|43|52|44|60|61|50|...</td>
    </tr>
    <tr>
      <th>4</th>
      <td>004A07DM0IDW</td>
      <td>1d688ec168932</td>
      <td>1541555717</td>
      <td>5</td>
      <td>clickout item</td>
      <td>1050068</td>
      <td>CO</td>
      <td>Santa Marta, Colombia</td>
      <td>mobile</td>
      <td>None</td>
      <td>2059240|2033381|1724779|127131|399441|103357|1...</td>
      <td>70|46|48|76|65|65|106|66|87|43|52|44|60|61|50|...</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</div>
<div class="section" id="sample-load">
<h4>Sample load<a class="headerlink" href="#sample-load" title="Permalink to this headline">¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sample_session_data</span> <span class="o">=</span> <span class="n">Session</span><span class="p">(</span><span class="n">version</span><span class="o">=</span><span class="s1">&#39;trivago&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df_train</span> <span class="o">=</span> <span class="n">sample_session_data</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
<span class="n">df_train</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>user_id</th>
      <th>session_id</th>
      <th>timestamp</th>
      <th>step</th>
      <th>action_type</th>
      <th>reference</th>
      <th>impressions</th>
      <th>prices</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>64BL89</td>
      <td>3579f89</td>
      <td>1</td>
      <td>1</td>
      <td>interaction item image</td>
      <td>5001</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1</th>
      <td>64BL89</td>
      <td>3579f89</td>
      <td>2</td>
      <td>2</td>
      <td>clickout item</td>
      <td>5002</td>
      <td>5014|5002|5010</td>
      <td>100|125|120</td>
    </tr>
    <tr>
      <th>2</th>
      <td>64BL89</td>
      <td>3579f89</td>
      <td>3</td>
      <td>3</td>
      <td>interaction item info</td>
      <td>5003</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>3</th>
      <td>64BL89</td>
      <td>3579f89</td>
      <td>4</td>
      <td>4</td>
      <td>filter selection</td>
      <td>unknown</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>4</th>
      <td>64BLF</td>
      <td>4504h9</td>
      <td>2</td>
      <td>1</td>
      <td>interaction item image</td>
      <td>5010</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>5</th>
      <td>64BLF</td>
      <td>4504h9</td>
      <td>4</td>
      <td>2</td>
      <td>clickout item</td>
      <td>5001</td>
      <td>5001|5023|5040|5005</td>
      <td>75|110|65|210</td>
    </tr>
    <tr>
      <th>6</th>
      <td>64BL89</td>
      <td>5504hFL</td>
      <td>7</td>
      <td>1</td>
      <td>filter selection</td>
      <td>unknown</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>7</th>
      <td>64BL89</td>
      <td>5504hFL</td>
      <td>8</td>
      <td>2</td>
      <td>clickout item</td>
      <td>5004</td>
      <td>5010|5001|5023|5004|5002|5008</td>
      <td>120|89|140|126|86|110</td>
    </tr>
    <tr>
      <th>8</th>
      <td>64BL89</td>
      <td>5504hFL</td>
      <td>9</td>
      <td>3</td>
      <td>interaction item image</td>
      <td>5001</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>9</th>
      <td>64BL89</td>
      <td>5504hFL</td>
      <td>10</td>
      <td>4</td>
      <td>clickout item</td>
      <td>5001</td>
      <td>5010|5001|5023|5004|5002|5008</td>
      <td>120|89|140|126|86|110</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<ol class="simple">
<li><p>User <code class="docutils literal notranslate"><span class="pre">64BL89</span></code> viewed the image of item 5001.</p></li>
<li><p>User <code class="docutils literal notranslate"><span class="pre">64BL89</span></code> clicked on item 5002. 3 items (5014, 5002, 5010) were shown to the user and user clicked on 2nd item which is 5002. It was the costliest among the 3 items.</p></li>
<li><p>User <code class="docutils literal notranslate"><span class="pre">64BL89</span></code> viewed more info of item 5003.</p></li>
<li><p>User <code class="docutils literal notranslate"><span class="pre">64BL89</span></code> selected an unknown filter.</p></li>
<li><p>User <code class="docutils literal notranslate"><span class="pre">64BLF</span></code> viewed image of item 5010.</p></li>
<li><p>User <code class="docutils literal notranslate"><span class="pre">64BLF</span></code> clicked item 5001. It was on top of the recommended list.</p></li>
<li><p>User <code class="docutils literal notranslate"><span class="pre">64BL89</span></code> again came back after some time. A new session started for this user. User directly started with applying unknown filter.</p></li>
<li><p>User <code class="docutils literal notranslate"><span class="pre">64BL89</span></code> clicked on item 5004. It was at 4th position.</p></li>
<li><p>User <code class="docutils literal notranslate"><span class="pre">64BL89</span></code> again viewed the image of item 5001.</p></li>
<li><p>User <code class="docutils literal notranslate"><span class="pre">64BL89</span></code> now clicked item 5001 this time. It was at 2nd position.</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df_test</span> <span class="o">=</span> <span class="n">sample_session_data</span><span class="o">.</span><span class="n">test</span><span class="p">()</span>
<span class="n">df_test</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>user_id</th>
      <th>session_id</th>
      <th>timestamp</th>
      <th>step</th>
      <th>action_type</th>
      <th>reference</th>
      <th>impressions</th>
      <th>prices</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>64BL89</td>
      <td>3579f90</td>
      <td>5</td>
      <td>1</td>
      <td>interaction item image</td>
      <td>5023</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1</th>
      <td>64BL89</td>
      <td>3579f90</td>
      <td>6</td>
      <td>2</td>
      <td>clickout item</td>
      <td>NaN</td>
      <td>5002|5003|5010|5004|5001|5023</td>
      <td>120|75|110|105|89|99</td>
    </tr>
    <tr>
      <th>2</th>
      <td>64BL91F2</td>
      <td>3779f92</td>
      <td>9</td>
      <td>1</td>
      <td>interaction item info</td>
      <td>5010</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>3</th>
      <td>64BL91F2</td>
      <td>3779f92</td>
      <td>10</td>
      <td>2</td>
      <td>clickout item</td>
      <td>NaN</td>
      <td>5001|5004|5010|5014</td>
      <td>76|102|115|124</td>
    </tr>
    <tr>
      <th>4</th>
      <td>64BL91F2</td>
      <td>3779f92</td>
      <td>11</td>
      <td>3</td>
      <td>filter selection</td>
      <td>unknown</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df_items</span> <span class="o">=</span> <span class="n">sample_session_data</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
<span class="n">df_items</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>item_id</th>
      <th>properties</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>5001</td>
      <td>Wifi|Croissant|TV</td>
    </tr>
    <tr>
      <th>1</th>
      <td>5002</td>
      <td>Wifi|TV</td>
    </tr>
    <tr>
      <th>2</th>
      <td>5003</td>
      <td>Croissant</td>
    </tr>
    <tr>
      <th>3</th>
      <td>5004</td>
      <td>Shoe dryer</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</div>
</div>
<div class="section" id="id3">
<h3>Utilities<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">explode</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">col_expl</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Separate string in column col_expl and explode elements into multiple rows.&quot;&quot;&quot;</span>

    <span class="n">s</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col_expl</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">stack</span><span class="p">()</span>
    <span class="n">i</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">df2</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">df2</span><span class="p">[</span><span class="n">col_expl</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">values</span>

    <span class="k">return</span> <span class="n">df2</span>


<span class="k">def</span> <span class="nf">explode_mult</span><span class="p">(</span><span class="n">df_in</span><span class="p">,</span> <span class="n">col_list</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Explode each column in col_list into multiple rows.&quot;&quot;&quot;</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">df_in</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">col_list</span><span class="p">:</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;|&quot;</span><span class="p">)</span>

    <span class="n">df_out</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
        <span class="p">{</span><span class="n">col</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span>
                        <span class="n">df</span><span class="p">[</span><span class="n">col_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">len</span><span class="p">())</span>
         <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">col_list</span><span class="p">)}</span>
    <span class="p">)</span>

    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">col_list</span><span class="p">:</span>
        <span class="n">df_out</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">())</span>

    <span class="k">return</span> <span class="n">df_out</span>


<span class="k">def</span> <span class="nf">group_concat</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">gr_cols</span><span class="p">,</span> <span class="n">col_concat</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Concatenate multiple rows into one.&quot;&quot;&quot;</span>

    <span class="n">df_out</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">df</span>
        <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">gr_cols</span><span class="p">)[</span><span class="n">col_concat</span><span class="p">]</span>
        <span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="o">.</span><span class="n">to_frame</span><span class="p">()</span>
        <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">df_out</span>


<span class="k">def</span> <span class="nf">get_target_rows</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Restrict data frame to rows for which a prediction needs to be made.&quot;&quot;&quot;</span>
    
    <span class="n">df_target</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span>
        <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">action_type</span> <span class="o">==</span> <span class="s2">&quot;clickout item&quot;</span><span class="p">)</span> <span class="o">&amp;</span> 
        <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;reference&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">())</span>
    <span class="p">]</span>

    <span class="k">return</span> <span class="n">df_target</span>


<span class="k">def</span> <span class="nf">summarize_recs</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">rec_col</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Bring the data frame into submission format.&quot;&quot;&quot;</span>

    <span class="n">df_rec</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">df</span>
        <span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;user_id&quot;</span><span class="p">,</span> <span class="s2">&quot;session_id&quot;</span><span class="p">,</span> <span class="s2">&quot;timestamp&quot;</span><span class="p">,</span> <span class="s2">&quot;step&quot;</span><span class="p">,</span> <span class="n">rec_col</span><span class="p">],</span>
                        <span class="n">ascending</span><span class="o">=</span><span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">])</span>
        <span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;user_id&quot;</span><span class="p">,</span> <span class="s2">&quot;session_id&quot;</span><span class="p">,</span> <span class="s2">&quot;timestamp&quot;</span><span class="p">,</span> <span class="s2">&quot;step&quot;</span><span class="p">])[</span><span class="s2">&quot;impressed_item&quot;</span><span class="p">]</span>
        <span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="o">.</span><span class="n">to_frame</span><span class="p">()</span>
        <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;impressed_item&#39;</span><span class="p">:</span> <span class="s1">&#39;item_recommendations&#39;</span><span class="p">})</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">df_rec</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">print_time</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Print string s and current time.&quot;&quot;&quot;</span>

    <span class="n">t</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">localtime</span><span class="p">()</span>
    <span class="n">current_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%H:%M:%S&quot;</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">current_time</span><span class="si">}</span><span class="s2"> | </span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">print_header</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Print a nice header for string s.&quot;&quot;&quot;</span>

    <span class="nb">print</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;##</span><span class="si">{</span><span class="s1">&#39;#&#39;</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="si">}</span><span class="s2">##&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;# </span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s2"> #&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;##</span><span class="si">{</span><span class="s1">&#39;#&#39;</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="si">}</span><span class="s2">##&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">validate_model_name</span><span class="p">(</span><span class="n">model_name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Check if the inserted model name is valid.&quot;&quot;&quot;</span>

    <span class="n">model_names</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;gbm_rank&#39;</span><span class="p">,</span> <span class="s1">&#39;logistic_regression&#39;</span><span class="p">,</span>
        <span class="s1">&#39;nn_interaction&#39;</span><span class="p">,</span> <span class="s1">&#39;nn_item&#39;</span><span class="p">,</span>
        <span class="s1">&#39;pop_abs&#39;</span><span class="p">,</span> <span class="s1">&#39;pop_user&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;position&#39;</span><span class="p">,</span> <span class="s1">&#39;random&#39;</span>
    <span class="p">]</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">model_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">model_names</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">NameError</span>
    <span class="k">except</span> <span class="ne">NameError</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No such model. Please choose a valid one.&quot;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="feature-engineering">
<h3>Feature engineering<a class="headerlink" href="#feature-engineering" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">build_features</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Build features for the lightGBM and logistic regression model.&quot;&quot;&quot;</span>

    <span class="c1"># Select columns that are of interest for this method</span>
    <span class="n">print_time</span><span class="p">(</span><span class="s2">&quot;start&quot;</span><span class="p">)</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">,</span> <span class="s1">&#39;session_id&#39;</span><span class="p">,</span> <span class="s1">&#39;timestamp&#39;</span><span class="p">,</span> <span class="s1">&#39;step&#39;</span><span class="p">,</span>
            <span class="s1">&#39;action_type&#39;</span><span class="p">,</span> <span class="s1">&#39;reference&#39;</span><span class="p">,</span> <span class="s1">&#39;impressions&#39;</span><span class="p">,</span> <span class="s1">&#39;prices&#39;</span><span class="p">]</span>
    <span class="n">df_cols</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">cols</span><span class="p">]</span> 

    <span class="c1"># We are only interested in action types, for wich the reference is an item ID</span>
    <span class="n">print_time</span><span class="p">(</span><span class="s2">&quot;filter interactions&quot;</span><span class="p">)</span>
    <span class="n">item_interactions</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;clickout item&#39;</span><span class="p">,</span> <span class="s1">&#39;interaction item deals&#39;</span><span class="p">,</span> <span class="s1">&#39;interaction item image&#39;</span><span class="p">,</span>
        <span class="s1">&#39;interaction item info&#39;</span><span class="p">,</span> <span class="s1">&#39;interaction item rating&#39;</span><span class="p">,</span> <span class="s1">&#39;search for item&#39;</span>
    <span class="p">]</span>
    <span class="n">df_actions</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">df_cols</span>
        <span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_cols</span><span class="o">.</span><span class="n">action_type</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">item_interactions</span><span class="p">),</span> <span class="p">:]</span>
        <span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;reference&#39;</span><span class="p">:</span> <span class="s1">&#39;referenced_item&#39;</span><span class="p">})</span>
    <span class="p">)</span>

    <span class="n">print_time</span><span class="p">(</span><span class="s2">&quot;cleaning&quot;</span><span class="p">)</span>
    <span class="c1"># Clean of instances that have no reference</span>
    <span class="n">idx_rm</span> <span class="o">=</span> <span class="p">(</span><span class="n">df_actions</span><span class="o">.</span><span class="n">action_type</span> <span class="o">!=</span> <span class="s2">&quot;clickout item&quot;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df_actions</span><span class="o">.</span><span class="n">referenced_item</span><span class="o">.</span><span class="n">isna</span><span class="p">())</span>
    <span class="n">df_actions</span> <span class="o">=</span> <span class="n">df_actions</span><span class="p">[</span><span class="o">~</span><span class="n">idx_rm</span><span class="p">]</span>

    <span class="c1"># Get item ID of previous interaction of a user in a session</span>
    <span class="n">print_time</span><span class="p">(</span><span class="s2">&quot;previous interactions&quot;</span><span class="p">)</span>
    <span class="n">df_actions</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;previous_item&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">df_actions</span>
        <span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;user_id&quot;</span><span class="p">,</span> <span class="s2">&quot;session_id&quot;</span><span class="p">,</span> <span class="s2">&quot;timestamp&quot;</span><span class="p">,</span> <span class="s2">&quot;step&quot;</span><span class="p">],</span>
                        <span class="n">ascending</span><span class="o">=</span><span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">])</span>
        <span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;user_id&quot;</span><span class="p">])[</span><span class="s2">&quot;referenced_item&quot;</span><span class="p">]</span>
        <span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># Combine the impressions and item column, they both contain item IDs</span>
    <span class="c1"># and we can expand the impression lists in the next step to get the total</span>
    <span class="c1"># interaction count for an item</span>
    <span class="n">print_time</span><span class="p">(</span><span class="s2">&quot;combining columns - impressions&quot;</span><span class="p">)</span>
    <span class="n">df_actions</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;interacted_item&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
        <span class="n">df_actions</span><span class="o">.</span><span class="n">impressions</span><span class="o">.</span><span class="n">isna</span><span class="p">(),</span>
        <span class="n">df_actions</span><span class="o">.</span><span class="n">referenced_item</span><span class="p">,</span>
        <span class="n">df_actions</span><span class="o">.</span><span class="n">impressions</span>
    <span class="p">)</span>
    <span class="n">df_actions</span> <span class="o">=</span> <span class="n">df_actions</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s2">&quot;impressions&quot;</span><span class="p">)</span>

    <span class="c1"># Price array expansion will get easier without NAs</span>
    <span class="n">print_time</span><span class="p">(</span><span class="s2">&quot;combining columns - prices&quot;</span><span class="p">)</span>
    <span class="n">df_actions</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;prices&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
        <span class="n">df_actions</span><span class="o">.</span><span class="n">prices</span><span class="o">.</span><span class="n">isna</span><span class="p">(),</span>
        <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">df_actions</span><span class="o">.</span><span class="n">prices</span>
    <span class="p">)</span>

    <span class="c1"># Convert pipe separated lists into columns</span>
    <span class="n">print_time</span><span class="p">(</span><span class="s2">&quot;explode arrays&quot;</span><span class="p">)</span>
    <span class="n">df_items</span> <span class="o">=</span> <span class="n">explode_mult</span><span class="p">(</span><span class="n">df_actions</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;interacted_item&quot;</span><span class="p">,</span> <span class="s2">&quot;prices&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="c1"># Feature: Number of previous interactions with an item</span>
    <span class="n">print_time</span><span class="p">(</span><span class="s2">&quot;interaction count&quot;</span><span class="p">)</span>
    <span class="n">df_items</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;interaction_count&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">df_items</span>
        <span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;user_id&quot;</span><span class="p">,</span> <span class="s2">&quot;interacted_item&quot;</span><span class="p">])</span>
        <span class="o">.</span><span class="n">cumcount</span><span class="p">()</span>
    <span class="p">)</span>

    <span class="c1"># Reduce to impression level again </span>
    <span class="n">print_time</span><span class="p">(</span><span class="s2">&quot;reduce to impressions&quot;</span><span class="p">)</span>
    <span class="n">df_impressions</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">df_items</span><span class="p">[</span><span class="n">df_items</span><span class="o">.</span><span class="n">action_type</span> <span class="o">==</span> <span class="s2">&quot;clickout item&quot;</span><span class="p">]</span>
        <span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s2">&quot;action_type&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;interacted_item&quot;</span><span class="p">:</span> <span class="s2">&quot;impressed_item&quot;</span><span class="p">})</span>
    <span class="p">)</span>

    <span class="c1"># Feature: Position of item in the original list.</span>
    <span class="c1"># Items are in original order after the explode for each index</span>
    <span class="n">print_time</span><span class="p">(</span><span class="s2">&quot;position feature&quot;</span><span class="p">)</span>
    <span class="n">df_impressions</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;position&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">df_impressions</span>
        <span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;user_id&quot;</span><span class="p">,</span> <span class="s2">&quot;session_id&quot;</span><span class="p">,</span> <span class="s2">&quot;timestamp&quot;</span><span class="p">,</span> <span class="s2">&quot;step&quot;</span><span class="p">])</span>
        <span class="o">.</span><span class="n">cumcount</span><span class="p">()</span><span class="o">+</span><span class="mi">1</span>
    <span class="p">)</span>

    <span class="c1"># Feature: Is the impressed item the last interacted item</span>
    <span class="n">print_time</span><span class="p">(</span><span class="s2">&quot;last interacted item feature&quot;</span><span class="p">)</span>
    <span class="n">df_impressions</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;is_last_interacted&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">df_impressions</span><span class="p">[</span><span class="s2">&quot;previous_item&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">df_impressions</span><span class="p">[</span><span class="s2">&quot;impressed_item&quot;</span><span class="p">]</span>
    <span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

    <span class="n">print_time</span><span class="p">(</span><span class="s2">&quot;change price datatype&quot;</span><span class="p">)</span>
    <span class="n">df_impressions</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;prices&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_impressions</span><span class="o">.</span><span class="n">prices</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

    <span class="n">return_cols</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;user_id&quot;</span><span class="p">,</span>
        <span class="s2">&quot;session_id&quot;</span><span class="p">,</span>
        <span class="s2">&quot;timestamp&quot;</span><span class="p">,</span>
        <span class="s2">&quot;step&quot;</span><span class="p">,</span>
        <span class="s2">&quot;position&quot;</span><span class="p">,</span>
        <span class="s2">&quot;prices&quot;</span><span class="p">,</span>
        <span class="s2">&quot;interaction_count&quot;</span><span class="p">,</span>
        <span class="s2">&quot;is_last_interacted&quot;</span><span class="p">,</span>
        <span class="s2">&quot;referenced_item&quot;</span><span class="p">,</span>
        <span class="s2">&quot;impressed_item&quot;</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="n">df_return</span> <span class="o">=</span> <span class="n">df_impressions</span><span class="p">[</span><span class="n">return_cols</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">df_return</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="models">
<h3>Models<a class="headerlink" href="#models" title="Permalink to this headline">¶</a></h3>
<div class="section" id="list-of-models">
<h4>List of models<a class="headerlink" href="#list-of-models" title="Permalink to this headline">¶</a></h4>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>- gbm_rank: lightGBM model
- log_reg: Logistic regression
- nn_interaction: kNN w/ session co-occurrence
- nn_item: kNN w/ metadata similarity
- pop_abs: Popularity - total clicks
- pop_user: Popularity - distinct users
- position: Original display position
- random: Random order
</pre></div>
</div>
</div>
<div class="section" id="random">
<h4>random<a class="headerlink" href="#random" title="Permalink to this headline">¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#collapse-hide</span>
<span class="k">class</span> <span class="nc">ModelRandom</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Model class for the random ordering model.</span>
<span class="sd">    Methods</span>
<span class="sd">        fit(df): Not needed. Only added for consistency with other model classes</span>
<span class="sd">        predict(df): Calculate recommendations for test data        </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_</span><span class="p">):</span>
        <span class="k">pass</span>


    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Randomly sort the impressions list.&quot;&quot;&quot;</span>

        <span class="c1"># Target row, withheld item ID that needs to be predicted</span>
        <span class="n">print_time</span><span class="p">(</span><span class="s2">&quot;target rows&quot;</span><span class="p">)</span>
        <span class="n">df_target</span> <span class="o">=</span> <span class="n">get_target_rows</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>

        <span class="c1"># Summarize recommendations</span>
        <span class="n">print_time</span><span class="p">(</span><span class="s2">&quot;summarize recommendations&quot;</span><span class="p">)</span>
        <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">10121</span><span class="p">)</span>
        <span class="n">df_target</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;item_recs_list&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">df_target</span>
            <span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;impressions&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;|&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">k</span><span class="p">:</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()))</span>
        <span class="p">)</span>

        <span class="n">df_target</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;item_recommendations&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
           <span class="n">df_target</span><span class="p">[</span><span class="s2">&quot;item_recs_list&quot;</span><span class="p">]</span>
           <span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">arr</span><span class="p">:</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">arr</span><span class="p">))</span>
        <span class="p">)</span>

        <span class="n">cols_rec</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;user_id&quot;</span><span class="p">,</span> <span class="s2">&quot;session_id&quot;</span><span class="p">,</span> <span class="s2">&quot;timestamp&quot;</span><span class="p">,</span> <span class="s2">&quot;step&quot;</span><span class="p">,</span> <span class="s2">&quot;item_recommendations&quot;</span><span class="p">]</span>
        <span class="n">df_rec</span> <span class="o">=</span> <span class="n">df_target</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">cols_rec</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">df_rec</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">ModelRandom</span><span class="p">()</span>
<span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">df_train</span><span class="p">)</span>
<span class="n">df_recommendations</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">df_test</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>14:47:52 | target rows
14:47:52 | summarize recommendations
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df_recommendations</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>user_id</th>
      <th>session_id</th>
      <th>timestamp</th>
      <th>step</th>
      <th>item_recommendations</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <td>64BL89</td>
      <td>3579f90</td>
      <td>6</td>
      <td>2</td>
      <td>5004 5010 5001 5002 5003 5023</td>
    </tr>
    <tr>
      <th>3</th>
      <td>64BL91F2</td>
      <td>3779f92</td>
      <td>10</td>
      <td>2</td>
      <td>5001 5010 5014 5004</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</div>
<div class="section" id="position">
<h4>position<a class="headerlink" href="#position" title="Permalink to this headline">¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#collapse-hide</span>
<span class="k">class</span> <span class="nc">ModelPosition</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Model class for the model based on the original position in displayed list.</span>
<span class="sd">    Methods</span>
<span class="sd">        fit(df): Not needed. Only added for consistency with other model classes</span>
<span class="sd">        predict(df): Calculate recommendations for test data        </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_</span><span class="p">):</span>
        <span class="k">pass</span>


    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return items in impressions list in original order.&quot;&quot;&quot;</span>

        <span class="c1"># Target row, withheld item ID that needs to be predicted</span>
        <span class="n">print_time</span><span class="p">(</span><span class="s2">&quot;target rows&quot;</span><span class="p">)</span>
        <span class="n">df_target</span> <span class="o">=</span> <span class="n">get_target_rows</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>

        <span class="c1"># Summarize recommendations</span>
        <span class="n">print_time</span><span class="p">(</span><span class="s2">&quot;summarize recommendations&quot;</span><span class="p">)</span>
        <span class="n">df_target</span><span class="p">[</span><span class="s2">&quot;item_recommendations&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">df_target</span>
            <span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">impressions</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;|&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="n">cols_rec</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;user_id&quot;</span><span class="p">,</span> <span class="s2">&quot;session_id&quot;</span><span class="p">,</span> <span class="s2">&quot;timestamp&quot;</span><span class="p">,</span> <span class="s2">&quot;step&quot;</span><span class="p">,</span> <span class="s2">&quot;item_recommendations&quot;</span><span class="p">]</span>
        <span class="n">df_rec</span> <span class="o">=</span> <span class="n">df_target</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">cols_rec</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">df_rec</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">ModelPosition</span><span class="p">()</span>
<span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">df_train</span><span class="p">)</span>
<span class="n">df_recommendations</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">df_test</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>14:51:15 | target rows
14:51:15 | summarize recommendations
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df_recommendations</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>user_id</th>
      <th>session_id</th>
      <th>timestamp</th>
      <th>step</th>
      <th>item_recommendations</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <td>64BL89</td>
      <td>3579f90</td>
      <td>6</td>
      <td>2</td>
      <td>5002 5003 5010 5004 5001 5023</td>
    </tr>
    <tr>
      <th>3</th>
      <td>64BL91F2</td>
      <td>3779f92</td>
      <td>10</td>
      <td>2</td>
      <td>5001 5004 5010 5014</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</div>
<div class="section" id="pop-abs">
<h4>pop_abs<a class="headerlink" href="#pop-abs" title="Permalink to this headline">¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#collapse-hide</span>
<span class="k">class</span> <span class="nc">ModelPopAbs</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Model class for the popularity model based on total number of clicks.</span>
<span class="sd">    Methods</span>
<span class="sd">        fit(df): Fit the model on training data</span>
<span class="sd">        predict(df): Calculate recommendations for test data        </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Count the number of clicks for each item.&quot;&quot;&quot;</span>

        <span class="c1"># Select columns that are of interest for this method</span>
        <span class="n">print_time</span><span class="p">(</span><span class="s2">&quot;start&quot;</span><span class="p">)</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">,</span> <span class="s1">&#39;session_id&#39;</span><span class="p">,</span> <span class="s1">&#39;timestamp&#39;</span><span class="p">,</span> <span class="s1">&#39;step&#39;</span><span class="p">,</span>
                <span class="s1">&#39;action_type&#39;</span><span class="p">,</span> <span class="s1">&#39;reference&#39;</span><span class="p">]</span>
        <span class="n">df_cols</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">cols</span><span class="p">]</span> 

        <span class="c1"># We only need to count clickouts per item</span>
        <span class="n">print_time</span><span class="p">(</span><span class="s2">&quot;clicks per item&quot;</span><span class="p">)</span>
        <span class="n">df_item_clicks</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">df_cols</span>
            <span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_cols</span><span class="p">[</span><span class="s2">&quot;action_type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;clickout item&quot;</span><span class="p">,</span> <span class="p">:]</span>
            <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;reference&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">size</span><span class="p">()</span>
            <span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;n_clicks&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;reference&quot;</span><span class="p">:</span> <span class="s2">&quot;item&quot;</span><span class="p">})</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">df_pop</span> <span class="o">=</span> <span class="n">df_item_clicks</span>


    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sort the impression list by number of clicks in the training phase.&quot;&quot;&quot;</span>

        <span class="c1"># Select columns that are of interest for this method</span>
        <span class="n">print_time</span><span class="p">(</span><span class="s2">&quot;start&quot;</span><span class="p">)</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">,</span> <span class="s1">&#39;session_id&#39;</span><span class="p">,</span> <span class="s1">&#39;timestamp&#39;</span><span class="p">,</span> <span class="s1">&#39;step&#39;</span><span class="p">,</span>
                <span class="s1">&#39;action_type&#39;</span><span class="p">,</span> <span class="s1">&#39;reference&#39;</span><span class="p">,</span> <span class="s2">&quot;impressions&quot;</span><span class="p">]</span>
        <span class="n">df_cols</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">cols</span><span class="p">]</span> 

        <span class="c1"># Target row, withheld item ID that needs to be predicted</span>
        <span class="n">print_time</span><span class="p">(</span><span class="s2">&quot;target rows&quot;</span><span class="p">)</span>
        <span class="n">df_target</span> <span class="o">=</span> <span class="n">get_target_rows</span><span class="p">(</span><span class="n">df_cols</span><span class="p">)</span>

        <span class="c1"># Explode to impression level</span>
        <span class="n">print_time</span><span class="p">(</span><span class="s2">&quot;explode impression array&quot;</span><span class="p">)</span>
        <span class="n">df_impressions</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">explode</span><span class="p">(</span><span class="n">df_target</span><span class="p">,</span> <span class="s2">&quot;impressions&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;impressions&quot;</span><span class="p">:</span> <span class="s2">&quot;impressed_item&quot;</span><span class="p">})</span>
        <span class="p">)</span>
        <span class="n">df_impressions</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">df_impressions</span>
            <span class="o">.</span><span class="n">merge</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">df_pop</span><span class="p">,</span>
                <span class="n">left_on</span><span class="o">=</span><span class="s2">&quot;impressed_item&quot;</span><span class="p">,</span>
                <span class="n">right_on</span><span class="o">=</span><span class="s2">&quot;item&quot;</span><span class="p">,</span>
                <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Summarize recommendations</span>
        <span class="n">print_time</span><span class="p">(</span><span class="s2">&quot;summarize recommendations&quot;</span><span class="p">)</span>
        <span class="n">df_rec</span> <span class="o">=</span> <span class="n">summarize_recs</span><span class="p">(</span><span class="n">df_impressions</span><span class="p">,</span> <span class="s2">&quot;n_clicks&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">df_rec</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">ModelPopAbs</span><span class="p">()</span>
<span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">df_train</span><span class="p">)</span>
<span class="n">df_recommendations</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">df_test</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>14:57:30 | start
14:57:30 | clicks per item
14:57:30 | start
14:57:30 | target rows
14:57:30 | explode impression array
14:57:30 | summarize recommendations
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df_recommendations</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>user_id</th>
      <th>session_id</th>
      <th>timestamp</th>
      <th>step</th>
      <th>item_recommendations</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>64BL89</td>
      <td>3579f90</td>
      <td>6</td>
      <td>2</td>
      <td>5001 5002 5004 5003 5010 5023</td>
    </tr>
    <tr>
      <th>1</th>
      <td>64BL91F2</td>
      <td>3779f92</td>
      <td>10</td>
      <td>2</td>
      <td>5001 5004 5010 5014</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</div>
<div class="section" id="pop-user">
<h4>pop_user<a class="headerlink" href="#pop-user" title="Permalink to this headline">¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#collapse-hide</span>
<span class="k">class</span> <span class="nc">ModelPopUsers</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Model class for the popularity model based on distinct users.</span>
<span class="sd">    Methods</span>
<span class="sd">        fit(df): Fit the model on training data</span>
<span class="sd">        predict(df): Calculate recommendations for test data        </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Count the number of distinct users that click on an item.&quot;&quot;&quot;</span>

        <span class="c1"># Select columns that are of interest for this method</span>
        <span class="n">print_time</span><span class="p">(</span><span class="s2">&quot;start&quot;</span><span class="p">)</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">,</span> <span class="s1">&#39;session_id&#39;</span><span class="p">,</span> <span class="s1">&#39;timestamp&#39;</span><span class="p">,</span> <span class="s1">&#39;step&#39;</span><span class="p">,</span>
                <span class="s1">&#39;action_type&#39;</span><span class="p">,</span> <span class="s1">&#39;reference&#39;</span><span class="p">]</span>
        <span class="n">df_cols</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">cols</span><span class="p">]</span> 

        <span class="c1"># We only need to count clickouts per item</span>
        <span class="n">print_time</span><span class="p">(</span><span class="s2">&quot;clicks per item&quot;</span><span class="p">)</span>
        <span class="n">df_item_clicks</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">df_cols</span>
            <span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_cols</span><span class="p">[</span><span class="s2">&quot;action_type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;clickout item&quot;</span><span class="p">,</span> <span class="p">:]</span>
            <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;reference&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">user_id</span>
            <span class="o">.</span><span class="n">nunique</span><span class="p">()</span>
            <span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;n_users&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;reference&quot;</span><span class="p">:</span> <span class="s2">&quot;item&quot;</span><span class="p">})</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">df_pop</span> <span class="o">=</span> <span class="n">df_item_clicks</span>


    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sort the impression list by number of distinct users in the training phase.&quot;&quot;&quot;</span>

        <span class="c1"># Select columns that are of interest for this method</span>
        <span class="n">print_time</span><span class="p">(</span><span class="s2">&quot;start&quot;</span><span class="p">)</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">,</span> <span class="s1">&#39;session_id&#39;</span><span class="p">,</span> <span class="s1">&#39;timestamp&#39;</span><span class="p">,</span> <span class="s1">&#39;step&#39;</span><span class="p">,</span>
                <span class="s1">&#39;action_type&#39;</span><span class="p">,</span> <span class="s1">&#39;reference&#39;</span><span class="p">,</span> <span class="s2">&quot;impressions&quot;</span><span class="p">]</span>
        <span class="n">df_cols</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">cols</span><span class="p">]</span> 

        <span class="c1"># Target row, withheld item ID that needs to be predicted</span>
        <span class="n">print_time</span><span class="p">(</span><span class="s2">&quot;target rows&quot;</span><span class="p">)</span>
        <span class="n">df_target</span> <span class="o">=</span> <span class="n">get_target_rows</span><span class="p">(</span><span class="n">df_cols</span><span class="p">)</span>

        <span class="c1"># Explode to impression level</span>
        <span class="n">print_time</span><span class="p">(</span><span class="s2">&quot;explode impression array&quot;</span><span class="p">)</span>
        <span class="n">df_impressions</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">explode</span><span class="p">(</span><span class="n">df_target</span><span class="p">,</span> <span class="s2">&quot;impressions&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;impressions&quot;</span><span class="p">:</span> <span class="s2">&quot;impressed_item&quot;</span><span class="p">})</span>
        <span class="p">)</span>
        <span class="n">df_impressions</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">df_impressions</span>
            <span class="o">.</span><span class="n">merge</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">df_pop</span><span class="p">,</span>
                <span class="n">left_on</span><span class="o">=</span><span class="s2">&quot;impressed_item&quot;</span><span class="p">,</span>
                <span class="n">right_on</span><span class="o">=</span><span class="s2">&quot;item&quot;</span><span class="p">,</span>
                <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Summarize recommendations</span>
        <span class="n">print_time</span><span class="p">(</span><span class="s2">&quot;summarize recommendations&quot;</span><span class="p">)</span>
        <span class="n">df_rec</span> <span class="o">=</span> <span class="n">summarize_recs</span><span class="p">(</span><span class="n">df_impressions</span><span class="p">,</span> <span class="s2">&quot;n_users&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">df_rec</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">ModelPopUsers</span><span class="p">()</span>
<span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">df_train</span><span class="p">)</span>
<span class="n">df_recommendations</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">df_test</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>14:59:09 | start
14:59:09 | clicks per item
14:59:09 | start
14:59:09 | target rows
14:59:09 | explode impression array
14:59:09 | summarize recommendations
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df_recommendations</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>user_id</th>
      <th>session_id</th>
      <th>timestamp</th>
      <th>step</th>
      <th>item_recommendations</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>64BL89</td>
      <td>3579f90</td>
      <td>6</td>
      <td>2</td>
      <td>5001 5002 5004 5003 5010 5023</td>
    </tr>
    <tr>
      <th>1</th>
      <td>64BL91F2</td>
      <td>3779f92</td>
      <td>10</td>
      <td>2</td>
      <td>5001 5004 5010 5014</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</div>
<div class="section" id="nn-item">
<h4>nn_item<a class="headerlink" href="#nn-item" title="Permalink to this headline">¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#collapse-hide</span>
<span class="k">def</span> <span class="nf">calc_item_sims</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">item_col</span><span class="p">,</span> <span class="n">reference_col</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Calculate similarity of items based on nearest neighbor algorithm.</span>
<span class="sd">    The final data frame will have similarity scores for pairs of items.</span>
<span class="sd">    :param df: Data frame of training data</span>
<span class="sd">    :param item_col: Name of data frame column that contains the item ID</span>
<span class="sd">    :param reference_col: Name of the reference column, depending on the model either</span>
<span class="sd">        1. session_id for the similarity based on session co-occurrences</span>
<span class="sd">        2. properties for the similarity based on item metadata</span>
<span class="sd">    :return: Data frame with item pairs and similarity scores</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Create data frame with item and reference indices</span>
    <span class="n">print_time</span><span class="p">(</span><span class="s2">&quot;item and reference indices&quot;</span><span class="p">)</span>
    <span class="n">unique_items</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">item_col</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
    <span class="n">unique_refs</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">reference_col</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>

    <span class="n">d_items</span> <span class="o">=</span> <span class="p">{</span><span class="n">item_col</span><span class="p">:</span> <span class="n">unique_items</span><span class="p">,</span> <span class="s1">&#39;item_idx&#39;</span><span class="p">:</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_items</span><span class="p">))}</span>
    <span class="n">d_refs</span> <span class="o">=</span> <span class="p">{</span><span class="n">reference_col</span><span class="p">:</span> <span class="n">unique_refs</span><span class="p">,</span> <span class="s1">&#39;ref_idx&#39;</span><span class="p">:</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_refs</span><span class="p">))}</span>

    <span class="n">df_items</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">d_items</span><span class="p">)</span>
    <span class="n">df_refs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">d_refs</span><span class="p">)</span>

    <span class="n">df</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">df</span>
        <span class="o">.</span><span class="n">merge</span><span class="p">(</span>
            <span class="n">df_items</span><span class="p">,</span>
            <span class="n">how</span><span class="o">=</span><span class="s2">&quot;inner&quot;</span><span class="p">,</span>
            <span class="n">on</span><span class="o">=</span><span class="n">item_col</span>
        <span class="p">)</span>
        <span class="o">.</span><span class="n">merge</span><span class="p">(</span>
            <span class="n">df_refs</span><span class="p">,</span>
            <span class="n">how</span><span class="o">=</span><span class="s2">&quot;inner&quot;</span><span class="p">,</span>
            <span class="n">on</span><span class="o">=</span><span class="n">reference_col</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="n">df_idx</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">df</span>
        <span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">[</span><span class="s2">&quot;item_idx&quot;</span><span class="p">,</span> <span class="s2">&quot;ref_idx&quot;</span><span class="p">]]</span>
        <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mf">1.</span><span class="p">)</span>
        <span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>
    <span class="p">)</span>

    <span class="c1"># Build item co-ooccurrence matrix</span>
    <span class="n">print_time</span><span class="p">(</span><span class="s2">&quot;item co-occurrence matrix&quot;</span><span class="p">)</span>
    <span class="n">mat_coo</span> <span class="o">=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">coo_matrix</span><span class="p">((</span><span class="n">df_idx</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="n">df_idx</span><span class="o">.</span><span class="n">item_idx</span><span class="p">,</span> <span class="n">df_idx</span><span class="o">.</span><span class="n">ref_idx</span><span class="p">)))</span>
    <span class="n">mat_item_coo</span> <span class="o">=</span> <span class="n">mat_coo</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">mat_coo</span><span class="p">)</span>

    <span class="c1"># Calculate Cosine similarities</span>
    <span class="n">print_time</span><span class="p">(</span><span class="s2">&quot;Cosine similarity&quot;</span><span class="p">)</span>
    <span class="n">inv_occ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">mat_item_coo</span><span class="o">.</span><span class="n">diagonal</span><span class="p">())</span>
    <span class="n">cosine_sim</span> <span class="o">=</span> <span class="n">mat_item_coo</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">inv_occ</span><span class="p">)</span>
    <span class="n">cosine_sim</span> <span class="o">=</span> <span class="n">cosine_sim</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">inv_occ</span><span class="p">)</span>

    <span class="c1"># Create item similarity data frame</span>
    <span class="n">print_time</span><span class="p">(</span><span class="s2">&quot;item similarity data frame&quot;</span><span class="p">)</span>
    <span class="n">idx_ref</span><span class="p">,</span> <span class="n">idx_item</span><span class="p">,</span> <span class="n">sim</span> <span class="o">=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">cosine_sim</span><span class="p">)</span>
    <span class="n">d_item_sim</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;idx_ref&#39;</span><span class="p">:</span> <span class="n">idx_ref</span><span class="p">,</span> <span class="s1">&#39;idx_item&#39;</span><span class="p">:</span> <span class="n">idx_item</span><span class="p">,</span> <span class="s1">&#39;similarity&#39;</span><span class="p">:</span> <span class="n">sim</span><span class="p">}</span>
    <span class="n">df_item_sim</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">d_item_sim</span><span class="p">)</span>

    <span class="n">df_item_sim</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">df_item_sim</span>
        <span class="o">.</span><span class="n">merge</span><span class="p">(</span>
            <span class="n">df_items</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">item_ref</span><span class="o">=</span><span class="n">df_items</span><span class="p">[</span><span class="n">item_col</span><span class="p">]),</span>
            <span class="n">how</span><span class="o">=</span><span class="s2">&quot;inner&quot;</span><span class="p">,</span>
            <span class="n">left_on</span><span class="o">=</span><span class="s2">&quot;idx_ref&quot;</span><span class="p">,</span>
            <span class="n">right_on</span><span class="o">=</span><span class="s2">&quot;item_idx&quot;</span>
        <span class="p">)</span>
        <span class="o">.</span><span class="n">merge</span><span class="p">(</span>
            <span class="n">df_items</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">item_sim</span><span class="o">=</span><span class="n">df_items</span><span class="p">[</span><span class="n">item_col</span><span class="p">]),</span>
            <span class="n">how</span><span class="o">=</span><span class="s2">&quot;inner&quot;</span><span class="p">,</span>
            <span class="n">left_on</span><span class="o">=</span><span class="s2">&quot;idx_item&quot;</span><span class="p">,</span>
            <span class="n">right_on</span><span class="o">=</span><span class="s2">&quot;item_idx&quot;</span>
        <span class="p">)</span>
        <span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">[</span><span class="s2">&quot;item_ref&quot;</span><span class="p">,</span> <span class="s2">&quot;item_sim&quot;</span><span class="p">,</span> <span class="s2">&quot;similarity&quot;</span><span class="p">]]</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">df_item_sim</span>


<span class="k">def</span> <span class="nf">predict_nn</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">df_item_sim</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Calculate predictions based on the item similarity scores.&quot;&quot;&quot;</span>

    <span class="c1"># Select columns that are of interest for this function</span>
    <span class="n">print_time</span><span class="p">(</span><span class="s2">&quot;start&quot;</span><span class="p">)</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">,</span> <span class="s1">&#39;session_id&#39;</span><span class="p">,</span> <span class="s1">&#39;timestamp&#39;</span><span class="p">,</span> <span class="s1">&#39;step&#39;</span><span class="p">,</span>
            <span class="s1">&#39;action_type&#39;</span><span class="p">,</span> <span class="s1">&#39;reference&#39;</span><span class="p">,</span> <span class="s1">&#39;impressions&#39;</span><span class="p">]</span>
    <span class="n">df_cols</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">cols</span><span class="p">]</span> 

    <span class="c1"># Get previous reference per user</span>
    <span class="n">print_time</span><span class="p">(</span><span class="s2">&quot;previous reference&quot;</span><span class="p">)</span>
    <span class="n">df_cols</span><span class="p">[</span><span class="s2">&quot;previous_reference&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">df_cols</span>
        <span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;user_id&quot;</span><span class="p">,</span> <span class="s2">&quot;session_id&quot;</span><span class="p">,</span> <span class="s2">&quot;timestamp&quot;</span><span class="p">],</span>
                     <span class="n">ascending</span><span class="o">=</span><span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">])</span>
        <span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;user_id&quot;</span><span class="p">])[</span><span class="s2">&quot;reference&quot;</span><span class="p">]</span>
        <span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># Target row, withheld item ID that needs to be predicted</span>
    <span class="n">print_time</span><span class="p">(</span><span class="s2">&quot;target rows&quot;</span><span class="p">)</span>
    <span class="n">df_target</span> <span class="o">=</span> <span class="n">get_target_rows</span><span class="p">(</span><span class="n">df_cols</span><span class="p">)</span>

    <span class="c1"># Explode to impression level</span>
    <span class="n">print_time</span><span class="p">(</span><span class="s2">&quot;explode impression array&quot;</span><span class="p">)</span>
    <span class="n">df_impressions</span> <span class="o">=</span> <span class="n">explode</span><span class="p">(</span><span class="n">df_target</span><span class="p">,</span> <span class="s2">&quot;impressions&quot;</span><span class="p">)</span>

    <span class="n">df_item_sim</span><span class="p">[</span><span class="s2">&quot;item_ref&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_item_sim</span><span class="p">[</span><span class="s2">&quot;item_ref&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
    <span class="n">df_item_sim</span><span class="p">[</span><span class="s2">&quot;item_sim&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_item_sim</span><span class="p">[</span><span class="s2">&quot;item_sim&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>

    <span class="c1"># Get similarities</span>
    <span class="n">print_time</span><span class="p">(</span><span class="s2">&quot;get similarities&quot;</span><span class="p">)</span>
    <span class="n">df_impressions</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">df_impressions</span>
        <span class="o">.</span><span class="n">merge</span><span class="p">(</span>
            <span class="n">df_item_sim</span><span class="p">,</span>
            <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
            <span class="n">left_on</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;previous_reference&quot;</span><span class="p">,</span> <span class="s2">&quot;impressions&quot;</span><span class="p">],</span>
            <span class="n">right_on</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;item_ref&quot;</span><span class="p">,</span> <span class="s2">&quot;item_sim&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;similarity&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">})</span>
        <span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;user_id&quot;</span><span class="p">,</span> <span class="s2">&quot;timestamp&quot;</span><span class="p">,</span> <span class="s2">&quot;step&quot;</span><span class="p">,</span> <span class="s2">&quot;similarity&quot;</span><span class="p">],</span>
                        <span class="n">ascending</span><span class="o">=</span><span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">])</span>
    <span class="p">)</span>

    <span class="c1"># Summarize recommendations</span>
    <span class="n">print_time</span><span class="p">(</span><span class="s2">&quot;summarize recommendations&quot;</span><span class="p">)</span>
    <span class="n">df_rec</span> <span class="o">=</span> <span class="n">group_concat</span><span class="p">(</span>
        <span class="n">df_impressions</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;user_id&quot;</span><span class="p">,</span> <span class="s2">&quot;session_id&quot;</span><span class="p">,</span> <span class="s2">&quot;timestamp&quot;</span><span class="p">,</span> <span class="s2">&quot;step&quot;</span><span class="p">],</span> 
        <span class="s2">&quot;impressions&quot;</span>
    <span class="p">)</span>

    <span class="n">df_rec</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">df_rec</span>
        <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;impressions&#39;</span><span class="p">:</span> <span class="s1">&#39;item_recommendations&#39;</span><span class="p">})</span>
        <span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">[</span><span class="s2">&quot;user_id&quot;</span><span class="p">,</span> <span class="s2">&quot;session_id&quot;</span><span class="p">,</span> <span class="s2">&quot;timestamp&quot;</span><span class="p">,</span> <span class="s2">&quot;step&quot;</span><span class="p">,</span> <span class="s2">&quot;item_recommendations&quot;</span><span class="p">]]</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">df_rec</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#collapse-hide</span>
<span class="k">class</span> <span class="nc">ModelNNItem</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Model class for the item metadata nearest neighbor model.</span>
<span class="sd">    Methods</span>
<span class="sd">        fit(df): Fit the model on training data</span>
<span class="sd">        predict(df): Calculate recommendations for test data        </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculate item similarity based on item metadata.&quot;&quot;&quot;</span>

        <span class="c1"># Explode property arrays</span>
        <span class="n">print_time</span><span class="p">(</span><span class="s2">&quot;explode properties&quot;</span><span class="p">)</span>
        <span class="n">df_properties</span> <span class="o">=</span> <span class="n">explode</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="s2">&quot;properties&quot;</span><span class="p">)</span>

        <span class="n">df_item_sim</span> <span class="o">=</span> <span class="n">calc_item_sims</span><span class="p">(</span><span class="n">df_properties</span><span class="p">,</span> <span class="s2">&quot;item_id&quot;</span><span class="p">,</span> <span class="s2">&quot;properties&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">df_item_sim</span> <span class="o">=</span> <span class="n">df_item_sim</span>


    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sort impression list by similarity.&quot;&quot;&quot;</span>

        <span class="n">df_rec</span> <span class="o">=</span> <span class="n">predict_nn</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_item_sim</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">df_rec</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">ModelNNItem</span><span class="p">()</span>
<span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">df_items</span><span class="p">)</span>
<span class="n">df_recommendations</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">df_test</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>15:07:50 | explode properties
15:07:50 | item and reference indices
15:07:50 | item co-occurrence matrix
15:07:50 | Cosine similarity
15:07:50 | item similarity data frame
15:07:50 | start
15:07:50 | previous reference
15:07:50 | target rows
15:07:50 | explode impression array
15:07:50 | get similarities
15:07:50 | summarize recommendations
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df_recommendations</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>user_id</th>
      <th>session_id</th>
      <th>timestamp</th>
      <th>step</th>
      <th>item_recommendations</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>64BL89</td>
      <td>3579f90</td>
      <td>6</td>
      <td>2</td>
      <td>5002 5003 5010 5004 5001 5023</td>
    </tr>
    <tr>
      <th>1</th>
      <td>64BL91F2</td>
      <td>3779f92</td>
      <td>10</td>
      <td>2</td>
      <td>5001 5004 5010 5014</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</div>
<div class="section" id="nn-interaction">
<h4>nn_interaction<a class="headerlink" href="#nn-interaction" title="Permalink to this headline">¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#collapse-hide</span>
<span class="k">class</span> <span class="nc">ModelNNInteraction</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Model class for the session co-occurrence nearest neighbor model.</span>
<span class="sd">    Methods</span>
<span class="sd">        fit(df): Fit the model on training data</span>
<span class="sd">        predict(df): Calculate recommendations for test data        </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculate item similarity based on session co-occurrence.&quot;&quot;&quot;</span>

        <span class="c1"># Select columns that are of interest for this method</span>
        <span class="n">print_time</span><span class="p">(</span><span class="s2">&quot;start&quot;</span><span class="p">)</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">,</span> <span class="s1">&#39;session_id&#39;</span><span class="p">,</span> <span class="s1">&#39;timestamp&#39;</span><span class="p">,</span> <span class="s1">&#39;step&#39;</span><span class="p">,</span>
                <span class="s1">&#39;action_type&#39;</span><span class="p">,</span> <span class="s1">&#39;reference&#39;</span><span class="p">]</span>
        <span class="n">df_cols</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">cols</span><span class="p">]</span> 

        <span class="c1"># We are only interested in action types, for wich the reference is an item ID</span>
        <span class="n">print_time</span><span class="p">(</span><span class="s2">&quot;filter interactions&quot;</span><span class="p">)</span>
        <span class="n">item_interactions</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">&#39;clickout item&#39;</span><span class="p">,</span> <span class="s1">&#39;interaction item deals&#39;</span><span class="p">,</span> <span class="s1">&#39;interaction item image&#39;</span><span class="p">,</span>
            <span class="s1">&#39;interaction item info&#39;</span><span class="p">,</span> <span class="s1">&#39;interaction item rating&#39;</span><span class="p">,</span> <span class="s1">&#39;search for item&#39;</span>
        <span class="p">]</span>
        <span class="n">df_actions</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">df_cols</span>
            <span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_cols</span><span class="o">.</span><span class="n">action_type</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">item_interactions</span><span class="p">),</span> <span class="p">:]</span>
            <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;reference&#39;</span><span class="p">:</span> <span class="s1">&#39;item&#39;</span><span class="p">})</span>
            <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s1">&#39;action_type&#39;</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="n">df_item_sim</span> <span class="o">=</span> <span class="n">calc_item_sims</span><span class="p">(</span><span class="n">df_actions</span><span class="p">,</span> <span class="s2">&quot;item&quot;</span><span class="p">,</span> <span class="s2">&quot;session_id&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">df_item_sim</span> <span class="o">=</span> <span class="n">df_item_sim</span>


    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sort impression list by similarity.&quot;&quot;&quot;</span>

        <span class="n">df_rec</span> <span class="o">=</span> <span class="n">predict_nn</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_item_sim</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">df_rec</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">ModelNNInteraction</span><span class="p">()</span>
<span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">df_train</span><span class="p">)</span>
<span class="n">df_recommendations</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">df_test</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>15:09:13 | start
15:09:13 | filter interactions
15:09:13 | item and reference indices
15:09:13 | item co-occurrence matrix
15:09:13 | Cosine similarity
15:09:13 | item similarity data frame
15:09:13 | start
15:09:13 | previous reference
15:09:13 | target rows
15:09:13 | explode impression array
15:09:13 | get similarities
15:09:13 | summarize recommendations
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df_recommendations</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>user_id</th>
      <th>session_id</th>
      <th>timestamp</th>
      <th>step</th>
      <th>item_recommendations</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>64BL89</td>
      <td>3579f90</td>
      <td>6</td>
      <td>2</td>
      <td>5002 5003 5010 5004 5001 5023</td>
    </tr>
    <tr>
      <th>1</th>
      <td>64BL91F2</td>
      <td>3779f92</td>
      <td>10</td>
      <td>2</td>
      <td>5001 5004 5010 5014</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</div>
<div class="section" id="log-reg">
<h4>log_reg<a class="headerlink" href="#log-reg" title="Permalink to this headline">¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#collapse-hide</span>
<span class="k">class</span> <span class="nc">ModelLogReg</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Model class for the logistic regression model.</span>
<span class="sd">    Methods</span>
<span class="sd">        fit(df): Fit the model on training data</span>
<span class="sd">        predict(df): Calculate recommendations for test data        </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Train the logistic regression model.&quot;&quot;&quot;</span>

        <span class="n">df_impressions</span> <span class="o">=</span> <span class="n">build_features</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

        <span class="c1"># Target column, item that was clicked</span>
        <span class="n">print_time</span><span class="p">(</span><span class="s2">&quot;target column&quot;</span><span class="p">)</span>
        <span class="n">df_impressions</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;is_clicked&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">df_impressions</span><span class="p">[</span><span class="s2">&quot;referenced_item&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">df_impressions</span><span class="p">[</span><span class="s2">&quot;impressed_item&quot;</span><span class="p">]</span>
        <span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

        <span class="n">features</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;position&quot;</span><span class="p">,</span>
            <span class="s2">&quot;prices&quot;</span><span class="p">,</span>
            <span class="s2">&quot;interaction_count&quot;</span><span class="p">,</span>
            <span class="s2">&quot;is_last_interacted&quot;</span><span class="p">,</span>
        <span class="p">]</span>

        <span class="n">X</span> <span class="o">=</span> <span class="n">df_impressions</span><span class="p">[</span><span class="n">features</span><span class="p">]</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">df_impressions</span><span class="o">.</span><span class="n">is_clicked</span>

        <span class="c1"># Training the actual model</span>
        <span class="n">print_time</span><span class="p">(</span><span class="s2">&quot;training logistic regression model&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logreg</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">solver</span><span class="o">=</span><span class="s2">&quot;lbfgs&quot;</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1e-11</span><span class="p">,</span> <span class="n">C</span><span class="o">=</span><span class="mf">1e10</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculate click probability based on trained logistic regression model.&quot;&quot;&quot;</span>

        <span class="n">df_impressions</span> <span class="o">=</span> <span class="n">build_features</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

        <span class="c1"># Target row, withheld item ID that needs to be predicted</span>
        <span class="n">df_impressions</span> <span class="o">=</span> <span class="n">df_impressions</span><span class="p">[</span><span class="n">df_impressions</span><span class="o">.</span><span class="n">referenced_item</span><span class="o">.</span><span class="n">isna</span><span class="p">()]</span>

        <span class="n">features</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;position&quot;</span><span class="p">,</span>
            <span class="s2">&quot;prices&quot;</span><span class="p">,</span>
            <span class="s2">&quot;interaction_count&quot;</span><span class="p">,</span>
            <span class="s2">&quot;is_last_interacted&quot;</span>
        <span class="p">]</span>

        <span class="c1"># Predict clickout probabilities for each impressed item</span>
        <span class="n">print_time</span><span class="p">(</span><span class="s2">&quot;predict clickout item&quot;</span><span class="p">)</span>
        <span class="n">df_impressions</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;click_probability&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span>
            <span class="o">.</span><span class="n">logreg</span>
            <span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">df_impressions</span><span class="p">[</span><span class="n">features</span><span class="p">])[:,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="c1"># Summarize recommendations</span>
        <span class="n">print_time</span><span class="p">(</span><span class="s2">&quot;summarize recommendations&quot;</span><span class="p">)</span>
        <span class="n">df_rec</span> <span class="o">=</span> <span class="n">summarize_recs</span><span class="p">(</span><span class="n">df_impressions</span><span class="p">,</span> <span class="s2">&quot;click_probability&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">df_rec</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">ModelLogReg</span><span class="p">()</span>
<span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">df_train</span><span class="p">)</span>
<span class="n">df_recommendations</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">df_test</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>15:16:04 | start
15:16:04 | filter interactions
15:16:04 | cleaning
15:16:04 | previous interactions
15:16:04 | combining columns - impressions
15:16:04 | combining columns - prices
15:16:04 | explode arrays
15:16:04 | interaction count
15:16:04 | reduce to impressions
15:16:04 | position feature
15:16:04 | last interacted item feature
15:16:04 | change price datatype
15:16:04 | target column
15:16:04 | training logistic regression model
15:16:04 | start
15:16:04 | filter interactions
15:16:04 | cleaning
15:16:04 | previous interactions
15:16:04 | combining columns - impressions
15:16:04 | combining columns - prices
15:16:04 | explode arrays
15:16:04 | interaction count
15:16:04 | reduce to impressions
15:16:04 | position feature
15:16:04 | last interacted item feature
15:16:04 | change price datatype
15:16:04 | predict clickout item
15:16:04 | summarize recommendations
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df_recommendations</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>user_id</th>
      <th>session_id</th>
      <th>timestamp</th>
      <th>step</th>
      <th>item_recommendations</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>64BL89</td>
      <td>3579f90</td>
      <td>6</td>
      <td>2</td>
      <td>5023 5002 5003 5010 5004 5001</td>
    </tr>
    <tr>
      <th>1</th>
      <td>64BL91F2</td>
      <td>3779f92</td>
      <td>10</td>
      <td>2</td>
      <td>5010 5001 5004 5014</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</div>
<div class="section" id="gbm-rank">
<h4>gbm_rank<a class="headerlink" href="#gbm-rank" title="Permalink to this headline">¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#collapse-hide</span>
<span class="k">class</span> <span class="nc">ModelGbmRank</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Model class for the lightGBM model.</span>
<span class="sd">    Methods</span>
<span class="sd">        fit(df): Fit the model on training data</span>
<span class="sd">        predict(df): Calculate recommendations for test data        </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Train the lightGBM model.&quot;&quot;&quot;</span>

        <span class="n">df_impressions</span> <span class="o">=</span> <span class="n">build_features</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

        <span class="c1"># Target column, item that was clicked</span>
        <span class="n">print_time</span><span class="p">(</span><span class="s2">&quot;target column&quot;</span><span class="p">)</span>
        <span class="n">df_impressions</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;is_clicked&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">df_impressions</span><span class="p">[</span><span class="s2">&quot;referenced_item&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">df_impressions</span><span class="p">[</span><span class="s2">&quot;impressed_item&quot;</span><span class="p">]</span>
        <span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

        <span class="n">features</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;position&quot;</span><span class="p">,</span>
            <span class="s2">&quot;prices&quot;</span><span class="p">,</span>
            <span class="s2">&quot;interaction_count&quot;</span><span class="p">,</span>
            <span class="s2">&quot;is_last_interacted&quot;</span><span class="p">,</span>
        <span class="p">]</span>

        <span class="c1"># Bring to format suitable for lightGBM</span>
        <span class="n">print_time</span><span class="p">(</span><span class="s2">&quot;lightGBM format&quot;</span><span class="p">)</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">df_impressions</span><span class="p">[</span><span class="n">features</span><span class="p">]</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">df_impressions</span><span class="o">.</span><span class="n">is_clicked</span>

        <span class="n">q</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">df_impressions</span>
            <span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;user_id&quot;</span><span class="p">,</span> <span class="s2">&quot;session_id&quot;</span><span class="p">,</span> <span class="s2">&quot;timestamp&quot;</span><span class="p">,</span> <span class="s2">&quot;step&quot;</span><span class="p">])</span>
            <span class="o">.</span><span class="n">size</span><span class="p">()</span>
            <span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;query_length&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">query_length</span>
        <span class="p">)</span>

        <span class="c1"># Training the actual model</span>
        <span class="n">print_time</span><span class="p">(</span><span class="s2">&quot;training lightGBM model&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gbm</span> <span class="o">=</span> <span class="n">lgb</span><span class="o">.</span><span class="n">LGBMRanker</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gbm</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="n">q</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculate item ranking based on trained lightGBM model.&quot;&quot;&quot;</span>

        <span class="n">df_impressions</span> <span class="o">=</span> <span class="n">build_features</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

        <span class="c1"># Target row, withheld item ID that needs to be predicted</span>
        <span class="n">df_impressions</span> <span class="o">=</span> <span class="n">df_impressions</span><span class="p">[</span><span class="n">df_impressions</span><span class="o">.</span><span class="n">referenced_item</span><span class="o">.</span><span class="n">isna</span><span class="p">()]</span>

        <span class="n">features</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;position&quot;</span><span class="p">,</span>
            <span class="s2">&quot;prices&quot;</span><span class="p">,</span>
            <span class="s2">&quot;interaction_count&quot;</span><span class="p">,</span>
            <span class="s2">&quot;is_last_interacted&quot;</span>
        <span class="p">]</span>

        <span class="n">df_impressions</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;click_propensity&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gbm</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">df_impressions</span><span class="p">[</span><span class="n">features</span><span class="p">])</span>

        <span class="c1"># Summarize recommendations</span>
        <span class="n">print_time</span><span class="p">(</span><span class="s2">&quot;summarize recommendations&quot;</span><span class="p">)</span>
        <span class="n">df_rec</span> <span class="o">=</span> <span class="n">summarize_recs</span><span class="p">(</span><span class="n">df_impressions</span><span class="p">,</span> <span class="s2">&quot;click_propensity&quot;</span><span class="p">)</span>
         
        <span class="k">return</span> <span class="n">df_rec</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">ModelGbmRank</span><span class="p">()</span>
<span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">df_train</span><span class="p">)</span>
<span class="n">df_recommendations</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">df_test</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>15:16:53 | start
15:16:53 | filter interactions
15:16:53 | cleaning
15:16:53 | previous interactions
15:16:53 | combining columns - impressions
15:16:53 | combining columns - prices
15:16:53 | explode arrays
15:16:53 | interaction count
15:16:53 | reduce to impressions
15:16:53 | position feature
15:16:53 | last interacted item feature
15:16:53 | change price datatype
15:16:53 | target column
15:16:53 | lightGBM format
15:16:53 | training lightGBM model
15:16:53 | start
15:16:53 | filter interactions
15:16:53 | cleaning
15:16:53 | previous interactions
15:16:53 | combining columns - impressions
15:16:53 | combining columns - prices
15:16:53 | explode arrays
15:16:53 | interaction count
15:16:53 | reduce to impressions
15:16:53 | position feature
15:16:53 | last interacted item feature
15:16:53 | change price datatype
15:16:53 | summarize recommendations
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df_recommendations</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>user_id</th>
      <th>session_id</th>
      <th>timestamp</th>
      <th>step</th>
      <th>item_recommendations</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>64BL89</td>
      <td>3579f90</td>
      <td>6</td>
      <td>2</td>
      <td>5002 5003 5010 5004 5001 5023</td>
    </tr>
    <tr>
      <th>1</th>
      <td>64BL91F2</td>
      <td>3779f92</td>
      <td>10</td>
      <td>2</td>
      <td>5001 5004 5010 5014</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</div>
</div>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./nbs"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        
            



<div class='prev-next-bottom'>
    
    <div id="prev">
        <a class="left-prev" href="T561435_Flower_Classification.html" title="previous page">
            <i class="prevnext-label fas fa-angle-left"></i>
            <div class="prevnext-info">
                <p class="prevnext-label">previous</p>
                <p class="prevnext-title">Flower classification</p>
            </div>
        </a>
    </div>
     <div id="next">
        <a class="right-next" href="T990000_ads_selection_using_bandits.html" title="next page">
            <div class="prevnext-info">
                <p class="prevnext-label">next</p>
                <p class="prevnext-title">Best Ads detection using bandit methods</p>
            </div>
            <i class="prevnext-label fas fa-angle-right"></i>
        </a>
     </div>

</div>
        
        </div>
    </div>
    <footer class="footer">
    <div class="container">
      <p>
        
          By Sparsh A.<br/>
        
            &copy; Copyright 2021.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>
  
  <script src="../_static/js/index.1c5a1a01449ed65a7b51.js"></script>

  
  </body>
</html>