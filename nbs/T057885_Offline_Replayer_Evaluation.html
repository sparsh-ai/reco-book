
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Offline Replayer Evaluation &#8212; Reco Book</title>
    
  <link href="../_static/css/theme.css" rel="stylesheet" />
  <link href="../_static/css/index.c5995385ac14fb8791e8eb36b4908be2.css" rel="stylesheet" />

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/sphinx-book-theme.css?digest=c3fdc42140077d1ad13ad2f1588a4309" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../_static/js/index.1c5a1a01449ed65a7b51.js">

    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/togglebutton.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/sphinx-book-theme.12a9622fbb08dcb3a2a40b2c02b83a57.js"></script>
    <script async="async" src="https://unpkg.com/thebe@0.5.1/lib/index.js"></script>
    <script >
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Methods for effective online testing" href="T915054_method_for_effective_online_testing.html" />
    <link rel="prev" title="Recommendation systems using Olist dataset" href="T871537_Recommendation_Systems_using_Olist_Dataset.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
      
      
      <h1 class="site-logo" id="site-title">Reco Book</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../index.html">
   Tutorials in Jupyter notebook format
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  User Stories
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="US780867_Transformer_based_Recommenders.html">
   Transformer-based Recommenders
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="T034923_BERT4Rec_on_ML1M_in_PyTorch.html">
     BERT4Rec on ML-1M in PyTorch
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="T595874_BERT4Rec_on_ML25M_in_PyTorch_Lightning.html">
     BERT4Rec on ML-25M
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="T088416_BST_Implementation_in_MXNet.html">
     BST Implementation in MXNet
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="T602245_BST_implementation_in_PyTorch.html">
     BST implementation in PyTorch
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="T007665_BST_on_ML1M_in_Keras.html">
     A Transformer-based recommendation system
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="T881207_BST_PTLightning_ML1M.html">
     Rating prediction using the Behavior Sequence Transformer (BST) model on ML-1M dataset in PyTorch Lightning
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="T757997_SASRec_PyTorch.html">
     SASRec implementation with PyTorch Library
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="T225287_SASRec_PaddlePaddle.html">
     SASRec implementation with Paddle Library
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="T701627_SR_SAN_Session_based_Model.html">
     SR-SAN Session-based Recommender
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="T975104_SSEPT_ML1M_Tensorflow1x.html">
     SSE-PT Personalized Transformer Recommender on ML-1M in Tensorflow 1.x
    </a>
   </li>
  </ul>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Prototypes
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="T382881_DeepWalk_Karateclub.html">
   DeepWalk from scratch referencing Karateclub library
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T384270_DeepWalk_pure_python.html">
   DeepWalk in pure python
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T677598_Jaccard_Cosine_SVD_DeepWalk_ML100K.html">
   Recommender System with DeepWalk Graph Embeddings
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T815556_Node2vec_Karateclub.html">
   Node2vec from scratch referencing Karateclub library
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T894941_Node2vec_MovieLens_Keras.html">
   Graph representation learning with node2vec
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T611050_Node2vec_PyG.html">
   Node2vec from scratch in PyTorch Geometric
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T186367_Node2vec_library.html">
   Node2vec from scratch referencing node2vec library
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T331379_bayesian_personalized_ranking.html">
   BPR from scratch
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T081831_Data_Poisoning_Attacks_on_Factorization_Based_Collaborative_Filtering.html">
   Data Poisoning Attacks on Factorization-Based Collaborative Filtering
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T102448_Adversarial_Learning_for_Recommendation.html">
   Adversarial Training (Regularization) on a Recommender System
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T865035_Simulating_Data_Poisoning_Attacks_against_Twitter_Recommender.html">
   Load and process dataset
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T711285_Data_Poisoning_Attack_using_LFM_and_ItemAE_on_Synthetic_Dataset.html">
   Injection attack using LFM and ItemAE model trained on Toy dataset
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T355514_Black_box_Attack_on_Sequential_Recs.html">
   Black-box Attack on Sequential Recs
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T873451_Statistics_fundamentals.html">
   Statictics Fundamentals
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T890478_Batch_Learning_from_Bandit_Feedback_%28BLBF%29.html">
   Imports
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T257798_Off_Policy_Learning_in_Two_stage_Recommender_Systems.html">
   Off-Policy Learning in Two-stage Recommender Systems
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T471827_Adaptive_Estimator_Selection_for_Off_Policy_Evaluation.html">
   Adaptive Estimator Selection for Off-Policy Evaluation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T902666_Evaluating_the_Robustness_of_Off_Policy_Evaluation.html">
   Evaluating the Robustness of Off-Policy Evaluation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T705904_Evaluation_of_Multiple_Off_Policy_Estimators_on_Synthetic_Dataset.html">
   Evaluation of Multiple Off-Policy Estimators on Synthetic Dataset
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T874693_Evaluating_Standard_Off_Policy_Estimators_with_Small_Sample_Open_Bandit_Dataset.html">
   Evaluating Standard Off-Policy Estimators with Small Sample Open-Bandit Dataset
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T792262_Optimal_Off_Policy_Evaluation_from_Multiple_Logging_Policies.html">
   Optimal Off-Policy Evaluation from Multiple Logging Policies
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T167249_Offline_Policy_Evaluation_with_VW_Command_Line.html">
   Offline Policy Evaluation with VW Command Line
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T966055_OBP_Library_Workshop_Tutorials.html">
   OBP Library Workshop Tutorials
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T632722_PyTorch_Fundamentals_Part_1.html">
   PyTorch Fundamentals Part 1
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T472467_PyTorch_Fundamentals_Part_2.html">
   PyTorch Fundamentals Part 2
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T206654_PyTorch_Fundamentals_Part_3.html">
   PyTorch Fundamentals Part 3
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T536348_Attention_Mechanisms.html">
   Imports
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T500796_Agricultural_Satellite_Image_Segmentation.html">
   Agricultural Satellite Image Segmentation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T611432_Image_Analysis_with_Tensorflow.html">
   Image Analysis with Tensorflow
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T925716_MongoDB_to_CSV_Conversion.html">
   MongoDB to CSV conversion
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T396469_PDF_to_Word_Cloud_via_Email.html">
   PDF to WordCloud via Email
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T030890_Job_Scraping_and_Clustering.html">
   Job scraping and clustering
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T897054_Scene_Text_Recognition.html">
   Scene Text Recognition
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T034809_Large_scale_Document_Retrieval_with_Elastic_Search.html">
   Large-scale Document Retrieval with ElasticSearch
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T467251_vowpal_wabbit_contextual_recommender.html">
   Simulating a news personalization scenario using Contextual Bandits
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T686684_similar_product_recommender.html">
   Similar Product Recommender system using Deep Learning for an online e-commerce store
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T132203_Retail_Product_Recommendations_using_Word2vec.html">
   Retail Product Recommendations using word2vec
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T501828_Recommender_Implicit_Negative_Feedback.html">
   Retail Product Recommendation with Negative Implicit Feedback
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T315965_Sequence_Aware_Recommenders_Music.html">
   Sequence Aware Recommender Systems
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T051777_image_similarity_recommendations.html">
   Similar Product Recommendations
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990172_recobook_diversity_aware_book_recommender.html">
   Diversity Aware Book Recommender
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T488549_Goodreads_Diversity_Aware_Book_Recommender.html">
   Diversity Aware Book Recommender
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T023535_Kafka_MongoDB_Real_time_Streaming.html">
   Kafka MongoDB Real-time Streaming
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T622304_Session_based_Recommender_Using_Word2vec.html">
   Session-based recommendation using word2vec
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T416854_bandit_based_recommender_using_thompson_sampling_app.html">
   Bandit-based Online Learning using Thompson Sampling
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T198578_Booking_dot_com_Trip_Recommendation.html">
   Booking.com Trip Recommendation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T519734_Vowpal_Wabbit_Contextual_Bandit.html">
   Vowpal Wabbit Contextual Bandit
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T871537_Recommendation_Systems_using_Olist_Dataset.html">
   Recommendation systems using Olist dataset
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Offline Replayer Evaluation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T915054_method_for_effective_online_testing.html">
   Methods for effective online testing
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T513987_Recsys_2020_Feature_Engineering_Tutorial.html">
   Recsys’20 Feature Engineering Tutorial
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T227901_amazon_personalize_batch_job.html">
   Amazon Personalize Batch Job
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T022961_Amazon_Personalize_Workshop.html">
   Amazon Personalize Workshop
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T424437_Collaborative_Filtering_on_ML_latest_small.html">
   Collaborative Filtering on ML-latest-small
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T539160_Building_and_Deploying_ASOS_Fashion_Recommender.html">
   Building and deploying ASOS fashion recommender
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T757697_Simple_Similarity_based_Recommender.html">
   Simple Similarity based Recommmendations
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T051594_Analytics_Zoo.html">
   Analytics Zoo
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T313645_A_B_Testing.html">
   A/B Testing
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T475711_PinSage_Graph_based_Recommender.html">
   PinSage Graph-based Recommender
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T516490_Graph_Embeddings.html">
   Learn Embeddings using Graph Networks
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T822164_movielens_milvus_redis_efficient_retrieval.html">
   Recommender with Redis and Milvus
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T845186_Anime_Recommender.html">
   RekoNet Anime Recommender
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T855843_kafka_spark_streaming_colab.html">
   Kafka and Spark Streaming in Colab
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T460437_Building_Models_From_Scratch.html">
   Building Models from scratch
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T855971_Conet_Model_for_Movie_Recommender.html">
   CoNet model
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T996996_content_based_and_collaborative_movielens.html">
   Movie Recommendation with Content-Based and Collaborative Filtering
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T239418_Simple_Movie_Recommenders.html">
   Simple Movie Recommenders
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T138337_Simple_Movie_Recommender.html">
   Simple movie recommender in implicit, explicit, and cold-start settings
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T935440_The_importance_of_Rating_Normalization.html">
   The importance of Rating Normalization
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T612622_cornac_examples.html">
   Cornac Examples
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T561435_Flower_Classification.html">
   Flower classification
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T680910_Trivago_Session_based_Recommender.html">
   Trivago Session-based Recommender
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990000_ads_selection_using_bandits.html">
   Best Ads detection using bandit methods
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990000_book_crossing_surprise_svd_nmf.html">
   Book-Crossing Recommendation System
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990000_book_recommender_kubeflow.html">
   Books recommendations with Kubeflow Pipelines on Scaleway Kapsule
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990000_build_a_kubeflow_pipeline.html">
   Build a Kubeflow Pipeline
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990000_causal_inference.html">
   Causal Inference
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990000_concept_embedding_nlp.html">
   Exploring Word Embeddings
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990000_concept_neural_net.html">
   Neural Network
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990000_concept_nlp_basics.html">
   Natural Language Processing 101
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990000_concept_transformer_lm.html">
   TransformerLM Quick Start and Guide
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990000_content_based_music_recommender_lyricsfreak.html">
   Content-based method for song recommendation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990000_evaluation_metrics_basics.html">
   Recommender System Evaluations
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990000_implicit_synthetic.html">
   Comparing Implicit Models on Synthetic Data
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990000_movie_recommender_tensorflow.html">
   Recommendation Systems with TensorFlow
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990000_movie_recommender_tensorflow_sagemaker.html">
   Movie recommender using Tensorflow in Sagemaker
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990000_movielens_eda_modeling.html">
   Movielens EDA and Modeling
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990000_read_data_from_cassandra_into_pandas.html">
   Read Cassandra Data Snapshot as DataFrame
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990000_rl_in_action.html">
   Reinforcement Learning fundamentals in action
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990000_rnn_cnn_basics.html">
   Processing sequences using RNNs and CNNs
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990000_tf_serving_in_action.html">
   TF Serving in action
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990000_training_indexing_movie_recommender.html">
   Training and indexing movie recommender
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T207114_EduRec_MOOCCube_Course_Recommender.html">
   EduRec MOOCCube Course Recommender
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T273184_Multi_Task_Learning.html">
   Multi-task Learning
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T661108_Book_Recommender_API.html">
   Book Recommender API
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T912764_Simple_Movie_Recommender_App.html">
   Simple Movie Recommender App
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T964554_Career_Village_Questions_Recommendation.html">
   CareerVillage Questions Recommendation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990001_amazon_women_apparel_tfidf_word2vec.html">
   Amazon Product Recommender
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990001_anime_recommender_graph_network.html">
   Anime Recommender with Bi-partite Graph Network
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990001_concept_self_attention.html">
   Self-Attention
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990001_course_recommender_svd_flask.html">
   Course Recommender with SVD based similarity
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990001_data_mining_similarity_measures.html">
   Concept - Data Mining Similarity Measures
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990001_jaccard_recommender.html">
   Jaccard Similarity based Recommender
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990001_live_streamer_recommender.html">
   Live Streamer Recommender with Implicit feedback
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990001_songs_embedding_skipgram_recommender.html">
   Song Embeddings - Skipgram Recommender
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990001_toy_example_car_recommender_knn.html">
   Toy example - Car Recommender using KNN method
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990001_wikirecs_recommender.html">
   WikiRecs
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../_sources/nbs/T057885_Offline_Replayer_Evaluation.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/sparsh-ai/reco-book/main?urlpath=tree/nbs/T057885_Offline_Replayer_Evaluation.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="../_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav" aria-label="Page">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#recogym">
   Recogym
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#defining-evaluation-methods">
     Defining evaluation methods
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#traditional-evaluation">
       Traditional evaluation
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#counterfactual-evaluation">
       Counterfactual evaluation
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#creating-agents">
     Creating agents
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#svd-agent">
       SVD agent
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#item-knn-agent">
       Item-KNN agent
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#user-knn-agent">
       User-KNN agent
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#agent-initializations">
       Agent initializations
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#offline-evaluation">
     Offline evaluation
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#generating-test-logs">
       Generating test logs
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#util-helper-function-to-plot-barchart">
       (Util) helper function to plot barchart
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#leave-one-out-evaluation">
       Leave-one-out evaluation
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#ips-estimators">
       IPS Estimators
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#a-b-tests">
       A/B tests
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#recogym-small">
   Recogym small
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#imports">
     Imports
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id1">
     Defining evaluation methods
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id2">
       Traditional evaluation
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id3">
       Counterfactual evaluation
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id4">
     Creating agents
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id5">
       SVD agent
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id6">
       Item-KNN agent
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id7">
       User-KNN agent
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id8">
       Agent initializations
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id9">
     Offline evaluation
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id10">
       Generating test logs
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id11">
       (Util) helper function to plot barchart
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id12">
       Leave-one-out evaluation
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id13">
       IPS Estimators
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id14">
       A/B tests
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#amazon-electronics-dataset">
   Amazon electronics dataset
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#libraries">
     Libraries
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#data">
     Data
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#utils">
     Utils
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#defining-agents">
     Defining agents
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#running-simulation">
     Running simulation
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#result-analysis">
     Result analysis
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#movielens">
   Movielens
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#import-libraries">
     Import libraries
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#loading-data">
     Loading data
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#util-functions">
     Util functions
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#set-variables">
     Set variables
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#create-agents">
     Create agents
    </a>
   </li>
  </ul>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <p><a href="https://colab.research.google.com/github/sparsh-ai/reco-book/blob/stage/nbs/T057885_Offline_Replayer_Evaluation.ipynb" target="_parent"><img src="https://colab.research.google.com/assets/colab-badge.svg" alt="Open In Colab"/></a></p>
<div class="section" id="offline-replayer-evaluation">
<h1>Offline Replayer Evaluation<a class="headerlink" href="#offline-replayer-evaluation" title="Permalink to this headline">¶</a></h1>
<div class="section" id="recogym">
<h2>Recogym<a class="headerlink" href="#recogym" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><p>Running recogym for offline simulation and evaluation</p>
</div></blockquote>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>!pip install -q recogym
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">numpy.random.mtrand</span> <span class="kn">import</span> <span class="n">RandomState</span>
<span class="kn">from</span> <span class="nn">scipy.special</span> <span class="kn">import</span> <span class="n">logsumexp</span>
<span class="kn">import</span> <span class="nn">scipy</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">scipy.stats.distributions</span> <span class="kn">import</span> <span class="n">beta</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>

<span class="kn">from</span> <span class="nn">scipy.sparse</span> <span class="kn">import</span> <span class="n">csr_matrix</span>
<span class="kn">from</span> <span class="nn">scipy.sparse.linalg</span> <span class="kn">import</span> <span class="n">svds</span>

<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">chain</span>
<span class="kn">from</span> <span class="nn">sklearn.neighbors</span> <span class="kn">import</span> <span class="n">NearestNeighbors</span>
<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">display</span><span class="p">,</span> <span class="n">HTML</span>

<span class="kn">from</span> <span class="nn">matplotlib.ticker</span> <span class="kn">import</span> <span class="n">FormatStrFormatter</span>

<span class="kn">import</span> <span class="nn">gym</span><span class="o">,</span> <span class="nn">recogym</span>
<span class="kn">from</span> <span class="nn">recogym</span> <span class="kn">import</span> <span class="n">env_1_args</span><span class="p">,</span> <span class="n">Configuration</span>
<span class="kn">from</span> <span class="nn">recogym.agents</span> <span class="kn">import</span> <span class="n">OrganicUserEventCounterAgent</span><span class="p">,</span> <span class="n">organic_user_count_args</span>
<span class="kn">from</span> <span class="nn">recogym.agents.organic_count</span> <span class="kn">import</span> <span class="n">OrganicCount</span><span class="p">,</span> <span class="n">organic_count_args</span><span class="p">,</span> <span class="n">to_categorical</span>
<span class="kn">from</span> <span class="nn">recogym</span> <span class="kn">import</span> <span class="n">Configuration</span>
<span class="kn">from</span> <span class="nn">recogym.agents</span> <span class="kn">import</span> <span class="n">Agent</span>
<span class="kn">from</span> <span class="nn">recogym.envs.observation</span> <span class="kn">import</span> <span class="n">Observation</span>
<span class="kn">from</span> <span class="nn">recogym.agents</span> <span class="kn">import</span> <span class="n">RandomAgent</span><span class="p">,</span> <span class="n">random_args</span>
<span class="kn">from</span> <span class="nn">recogym</span> <span class="kn">import</span> <span class="n">verify_agents</span><span class="p">,</span> <span class="n">verify_agents_IPS</span>
<span class="kn">from</span> <span class="nn">recogym.evaluate_agent</span> <span class="kn">import</span> <span class="n">plot_verify_agents</span><span class="p">,</span> <span class="n">verify_agents_recall_at_k</span>

<span class="kn">from</span> <span class="nn">recogym.envs.session</span> <span class="kn">import</span> <span class="n">OrganicSessions</span>
<span class="kn">from</span> <span class="nn">recogym.envs.context</span> <span class="kn">import</span> <span class="n">DefaultContext</span>
<span class="kn">from</span> <span class="nn">recogym.envs.observation</span> <span class="kn">import</span> <span class="n">Observation</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="o">%</span><span class="n">matplotlib</span> <span class="n">inline</span>

<span class="n">P</span> <span class="o">=</span> <span class="mi">2000</span> <span class="c1"># Number of Products</span>
<span class="n">U</span> <span class="o">=</span> <span class="mi">2000</span> <span class="c1"># Number of Users</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># You can overwrite environment arguments here</span>
<span class="n">env_1_args</span><span class="p">[</span><span class="s1">&#39;random_seed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">42</span>
<span class="n">env_1_args</span><span class="p">[</span><span class="s1">&#39;num_products&#39;</span><span class="p">]</span><span class="o">=</span> <span class="n">P</span>
<span class="n">env_1_args</span><span class="p">[</span><span class="s1">&#39;phi_var&#39;</span><span class="p">]</span><span class="o">=</span><span class="mf">0.0</span>
<span class="n">env_1_args</span><span class="p">[</span><span class="s1">&#39;number_of_flips&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">P</span><span class="o">//</span><span class="mi">2</span>
<span class="n">env_1_args</span><span class="p">[</span><span class="s1">&#39;sigma_mu_organic&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.1</span>
<span class="n">env_1_args</span><span class="p">[</span><span class="s1">&#39;sigma_omega&#39;</span><span class="p">]</span><span class="o">=</span><span class="mf">0.05</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Initialize the gym for the first time by calling .make() and .init_gym()</span>
<span class="n">env</span> <span class="o">=</span> <span class="n">gym</span><span class="o">.</span><span class="n">make</span><span class="p">(</span><span class="s1">&#39;reco-gym-v1&#39;</span><span class="p">)</span>
<span class="n">env</span><span class="o">.</span><span class="n">init_gym</span><span class="p">(</span><span class="n">env_1_args</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># env.reset()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Generate RecSys logs for U users</span>
<span class="n">reco_log</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">generate_logs</span><span class="p">(</span><span class="n">U</span><span class="p">)</span>
<span class="n">reco_log</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Organic Users: 0it [00:00, ?it/s]
Users: 100%|██████████| 2000/2000 [02:15&lt;00:00, 14.73it/s]
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>t</th>
      <th>u</th>
      <th>z</th>
      <th>v</th>
      <th>a</th>
      <th>c</th>
      <th>ps</th>
      <th>ps-a</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0.0</td>
      <td>0</td>
      <td>organic</td>
      <td>116</td>
      <td>&lt;NA&gt;</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>None</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1.0</td>
      <td>0</td>
      <td>bandit</td>
      <td>&lt;NA&gt;</td>
      <td>1123</td>
      <td>0.0</td>
      <td>0.0005</td>
      <td>()</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2.0</td>
      <td>0</td>
      <td>bandit</td>
      <td>&lt;NA&gt;</td>
      <td>1332</td>
      <td>0.0</td>
      <td>0.0005</td>
      <td>()</td>
    </tr>
    <tr>
      <th>3</th>
      <td>3.0</td>
      <td>0</td>
      <td>bandit</td>
      <td>&lt;NA&gt;</td>
      <td>805</td>
      <td>0.0</td>
      <td>0.0005</td>
      <td>()</td>
    </tr>
    <tr>
      <th>4</th>
      <td>4.0</td>
      <td>0</td>
      <td>bandit</td>
      <td>&lt;NA&gt;</td>
      <td>1184</td>
      <td>0.0</td>
      <td>0.0005</td>
      <td>()</td>
    </tr>
    <tr>
      <th>5</th>
      <td>0.0</td>
      <td>1</td>
      <td>organic</td>
      <td>1205</td>
      <td>&lt;NA&gt;</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>None</td>
    </tr>
    <tr>
      <th>6</th>
      <td>1.0</td>
      <td>1</td>
      <td>organic</td>
      <td>1137</td>
      <td>&lt;NA&gt;</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>None</td>
    </tr>
    <tr>
      <th>7</th>
      <td>2.0</td>
      <td>1</td>
      <td>organic</td>
      <td>1337</td>
      <td>&lt;NA&gt;</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>None</td>
    </tr>
    <tr>
      <th>8</th>
      <td>3.0</td>
      <td>1</td>
      <td>organic</td>
      <td>972</td>
      <td>&lt;NA&gt;</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>None</td>
    </tr>
    <tr>
      <th>9</th>
      <td>4.0</td>
      <td>1</td>
      <td>organic</td>
      <td>841</td>
      <td>&lt;NA&gt;</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>None</td>
    </tr>
    <tr>
      <th>10</th>
      <td>5.0</td>
      <td>1</td>
      <td>organic</td>
      <td>140</td>
      <td>&lt;NA&gt;</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>None</td>
    </tr>
    <tr>
      <th>11</th>
      <td>6.0</td>
      <td>1</td>
      <td>bandit</td>
      <td>&lt;NA&gt;</td>
      <td>1367</td>
      <td>0.0</td>
      <td>0.0005</td>
      <td>()</td>
    </tr>
    <tr>
      <th>12</th>
      <td>7.0</td>
      <td>1</td>
      <td>bandit</td>
      <td>&lt;NA&gt;</td>
      <td>1086</td>
      <td>0.0</td>
      <td>0.0005</td>
      <td>()</td>
    </tr>
    <tr>
      <th>13</th>
      <td>8.0</td>
      <td>1</td>
      <td>bandit</td>
      <td>&lt;NA&gt;</td>
      <td>1698</td>
      <td>0.0</td>
      <td>0.0005</td>
      <td>()</td>
    </tr>
    <tr>
      <th>14</th>
      <td>9.0</td>
      <td>1</td>
      <td>bandit</td>
      <td>&lt;NA&gt;</td>
      <td>1513</td>
      <td>0.0</td>
      <td>0.0005</td>
      <td>()</td>
    </tr>
    <tr>
      <th>15</th>
      <td>10.0</td>
      <td>1</td>
      <td>bandit</td>
      <td>&lt;NA&gt;</td>
      <td>134</td>
      <td>0.0</td>
      <td>0.0005</td>
      <td>()</td>
    </tr>
    <tr>
      <th>16</th>
      <td>11.0</td>
      <td>1</td>
      <td>bandit</td>
      <td>&lt;NA&gt;</td>
      <td>1056</td>
      <td>0.0</td>
      <td>0.0005</td>
      <td>()</td>
    </tr>
    <tr>
      <th>17</th>
      <td>12.0</td>
      <td>1</td>
      <td>bandit</td>
      <td>&lt;NA&gt;</td>
      <td>1751</td>
      <td>0.0</td>
      <td>0.0005</td>
      <td>()</td>
    </tr>
    <tr>
      <th>18</th>
      <td>13.0</td>
      <td>1</td>
      <td>bandit</td>
      <td>&lt;NA&gt;</td>
      <td>725</td>
      <td>0.0</td>
      <td>0.0005</td>
      <td>()</td>
    </tr>
    <tr>
      <th>19</th>
      <td>14.0</td>
      <td>1</td>
      <td>bandit</td>
      <td>&lt;NA&gt;</td>
      <td>612</td>
      <td>0.0</td>
      <td>0.0005</td>
      <td>()</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">n_events</span> <span class="o">=</span> <span class="n">reco_log</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">n_organic</span> <span class="o">=</span> <span class="n">reco_log</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">reco_log</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;organic&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Training on </span><span class="si">{0}</span><span class="s1"> organic and </span><span class="si">{1}</span><span class="s1"> bandit events&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n_organic</span><span class="p">,</span> <span class="n">n_events</span> <span class="o">-</span> <span class="n">n_organic</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Training on 43753 organic and 159967 bandit events
</pre></div>
</div>
</div>
</div>
<div class="section" id="defining-evaluation-methods">
<h3>Defining evaluation methods<a class="headerlink" href="#defining-evaluation-methods" title="Permalink to this headline">¶</a></h3>
<div class="section" id="traditional-evaluation">
<h4>Traditional evaluation<a class="headerlink" href="#traditional-evaluation" title="Permalink to this headline">¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">leave_one_out</span><span class="p">(</span><span class="n">reco_log</span><span class="p">,</span> <span class="n">agent</span><span class="p">,</span> <span class="n">last</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">N</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">folds</span> <span class="o">=</span> <span class="mi">10</span><span class="p">):</span>
    <span class="c1"># 1. Extract all organic events</span>
    <span class="n">reco_log</span> <span class="o">=</span> <span class="n">reco_log</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">reco_log</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;organic&#39;</span><span class="p">]</span>
    
    <span class="c1"># 2. For every user sequence - randomly sample out an item</span>
    <span class="n">hits</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">folds</span><span class="p">):</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">history</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">session</span> <span class="o">=</span> <span class="n">OrganicSessions</span><span class="p">()</span>
        <span class="n">agent</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">reco_log</span><span class="o">.</span><span class="n">itertuples</span><span class="p">():</span>
            <span class="c1"># If we have a new user</span>
            <span class="k">if</span> <span class="n">row</span><span class="o">.</span><span class="n">u</span> <span class="o">!=</span> <span class="n">user_id</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">last</span><span class="p">:</span>
                    <span class="c1"># Sample out last item</span>
                    <span class="n">index</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">history</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Sample out a random item from the history</span>
                    <span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">history</span><span class="p">),</span>
                                             <span class="n">replace</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
                <span class="n">test</span>  <span class="o">=</span> <span class="n">history</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
                <span class="n">train</span> <span class="o">=</span> <span class="n">history</span><span class="p">[:</span><span class="n">index</span><span class="p">]</span> <span class="o">+</span> <span class="n">history</span><span class="p">[</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:]</span>

                <span class="c1"># 3. Recreate the user sequence without these items - Let the agent observe the incomplete sequence</span>
                <span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">train</span><span class="p">):</span>
                    <span class="n">session</span><span class="o">.</span><span class="n">next</span><span class="p">(</span><span class="n">DefaultContext</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">user_id</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>

                <span class="c1"># 4. Generate a top-N set of recommendations by letting the agent act</span>
                <span class="c1"># TODO - For now only works for N = 1</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">prob_a</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">act</span><span class="p">(</span><span class="n">Observation</span><span class="p">(</span><span class="n">DefaultContext</span><span class="p">(</span><span class="n">t</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">user_id</span><span class="p">),</span> <span class="n">session</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">False</span><span class="p">)[</span><span class="s1">&#39;ps-a&#39;</span><span class="p">]</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">prob_a</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span> <span class="o">/</span> <span class="n">P</span><span class="p">]</span> <span class="o">*</span> <span class="n">P</span>

                <span class="c1"># 5. Compute metrics checking whether the sampled test item is in the top-N</span>
                <span class="k">try</span><span class="p">:</span>
                  <span class="n">hits</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">prob_a</span><span class="p">)</span> <span class="o">==</span> <span class="nb">int</span><span class="p">(</span><span class="n">test</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                <span class="k">except</span><span class="p">:</span>
                  <span class="n">hits</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

                <span class="c1"># Reset variables</span>
                <span class="n">user_id</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">u</span>
                <span class="n">history</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">session</span> <span class="o">=</span> <span class="n">OrganicSessions</span><span class="p">()</span>
                <span class="n">agent</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>

            <span class="c1"># Save the organic interaction to the running average for the session</span>
            <span class="n">history</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">row</span><span class="o">.</span><span class="n">t</span><span class="p">,</span><span class="n">row</span><span class="o">.</span><span class="n">v</span><span class="p">))</span>
    
    <span class="c1"># Error analysis</span>
    <span class="n">mean_hits</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">hits</span><span class="p">)</span>
    <span class="n">serr_hits</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">hits</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">hits</span><span class="p">))</span>
    <span class="n">low_bound</span> <span class="o">=</span> <span class="n">mean_hits</span> <span class="o">-</span> <span class="mf">1.96</span> <span class="o">*</span> <span class="n">serr_hits</span>
    <span class="n">upp_bound</span> <span class="o">=</span> <span class="n">mean_hits</span> <span class="o">+</span> <span class="mf">1.96</span> <span class="o">*</span> <span class="n">serr_hits</span>
    
    <span class="k">return</span> <span class="n">mean_hits</span><span class="p">,</span> <span class="n">low_bound</span><span class="p">,</span> <span class="n">upp_bound</span>

<span class="k">def</span> <span class="nf">verify_agents_traditional</span><span class="p">(</span><span class="n">reco_log</span><span class="p">,</span> <span class="n">agents</span><span class="p">,</span> <span class="n">last</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">N</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">folds</span> <span class="o">=</span> <span class="mi">10</span><span class="p">):</span>
    <span class="c1"># Placeholder DataFrame for result</span>
    <span class="n">stat</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;Agent&#39;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s1">&#39;0.025&#39;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s1">&#39;0.500&#39;</span> <span class="p">:</span> <span class="p">[],</span>
        <span class="s1">&#39;0.975&#39;</span><span class="p">:</span> <span class="p">[],</span>
    <span class="p">}</span>

    <span class="c1"># For every agent</span>
    <span class="k">for</span> <span class="n">agent_id</span> <span class="ow">in</span> <span class="n">agents</span><span class="p">:</span>
        <span class="c1"># Compute HR@k</span>
        <span class="n">mean</span><span class="p">,</span> <span class="n">low</span><span class="p">,</span> <span class="n">upp</span> <span class="o">=</span> <span class="n">leave_one_out</span><span class="p">(</span><span class="n">reco_log</span><span class="p">,</span> <span class="n">agents</span><span class="p">[</span><span class="n">agent_id</span><span class="p">],</span> <span class="n">last</span> <span class="o">=</span> <span class="n">last</span><span class="p">,</span> <span class="n">N</span> <span class="o">=</span> <span class="n">N</span><span class="p">,</span> <span class="n">folds</span> <span class="o">=</span> <span class="n">folds</span><span class="p">)</span>
        <span class="n">stat</span><span class="p">[</span><span class="s1">&#39;Agent&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">agent_id</span><span class="p">)</span>
        <span class="n">stat</span><span class="p">[</span><span class="s1">&#39;0.025&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">low</span><span class="p">)</span>
        <span class="n">stat</span><span class="p">[</span><span class="s1">&#39;0.500&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mean</span><span class="p">)</span>
        <span class="n">stat</span><span class="p">[</span><span class="s1">&#39;0.975&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">upp</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">stat</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="counterfactual-evaluation">
<h4>Counterfactual evaluation<a class="headerlink" href="#counterfactual-evaluation" title="Permalink to this headline">¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">compute_ips_weights</span><span class="p">(</span><span class="n">agent</span><span class="p">,</span> <span class="n">reco_log</span><span class="p">):</span>
    <span class="c1"># Placeholder for return values</span>
    <span class="n">rewards</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># Labels for actions</span>
    <span class="n">t_props</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># Treatment propensities</span>
    <span class="n">l_props</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># Logging propensities</span>
    
    <span class="c1"># For every logged interaction</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">session</span> <span class="o">=</span> <span class="n">OrganicSessions</span><span class="p">()</span>
    <span class="n">agent</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">reco_log</span><span class="o">.</span><span class="n">itertuples</span><span class="p">():</span>
        <span class="c1"># If we have a new user</span>
        <span class="k">if</span> <span class="n">row</span><span class="o">.</span><span class="n">u</span> <span class="o">!=</span> <span class="n">user_id</span><span class="p">:</span>
            <span class="c1"># Reset</span>
            <span class="n">session</span> <span class="o">=</span> <span class="n">OrganicSessions</span><span class="p">()</span>
            <span class="n">agent</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
            <span class="n">user_id</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">u</span>
        
        <span class="c1"># If we have an organic event</span>
        <span class="k">if</span> <span class="n">row</span><span class="o">.</span><span class="n">z</span> <span class="o">==</span> <span class="s1">&#39;organic&#39;</span><span class="p">:</span>
            <span class="n">session</span><span class="o">.</span><span class="n">next</span><span class="p">(</span><span class="n">DefaultContext</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">u</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">v</span><span class="p">))</span>        
            
        <span class="k">else</span><span class="p">:</span>
            <span class="n">prob_a</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">act</span><span class="p">(</span><span class="n">Observation</span><span class="p">(</span><span class="n">DefaultContext</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">u</span><span class="p">),</span> <span class="n">session</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">False</span><span class="p">)[</span><span class="s1">&#39;ps-a&#39;</span><span class="p">]</span>
            <span class="n">rewards</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">c</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
              <span class="n">t_props</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prob_a</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">a</span><span class="p">)])</span>
            <span class="k">except</span><span class="p">:</span>
              <span class="n">t_props</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">l_props</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">ps</span><span class="p">)</span>
            <span class="n">session</span> <span class="o">=</span> <span class="n">OrganicSessions</span><span class="p">()</span>
    
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">rewards</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">t_props</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">l_props</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">verify_agents_counterfactual</span><span class="p">(</span><span class="n">reco_log</span><span class="p">,</span> <span class="n">agents</span><span class="p">,</span> <span class="n">cap</span> <span class="o">=</span> <span class="mi">3</span><span class="p">):</span>
    <span class="c1"># Placeholder DataFrame for results</span>
    <span class="n">IPS_stat</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;Agent&#39;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s1">&#39;0.025&#39;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s1">&#39;0.500&#39;</span> <span class="p">:</span> <span class="p">[],</span>
        <span class="s1">&#39;0.975&#39;</span><span class="p">:</span> <span class="p">[],</span>
    <span class="p">}</span>
    <span class="n">CIPS_stat</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;Agent&#39;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s1">&#39;0.025&#39;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s1">&#39;0.500&#39;</span> <span class="p">:</span> <span class="p">[],</span>
        <span class="s1">&#39;0.975&#39;</span><span class="p">:</span> <span class="p">[],</span>
    <span class="p">}</span>
    <span class="n">SNIPS_stat</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;Agent&#39;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s1">&#39;0.025&#39;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s1">&#39;0.500&#39;</span> <span class="p">:</span> <span class="p">[],</span>
        <span class="s1">&#39;0.975&#39;</span><span class="p">:</span> <span class="p">[],</span>
    <span class="p">}</span>

    <span class="c1"># For every agent</span>
    <span class="k">for</span> <span class="n">agent_id</span> <span class="ow">in</span> <span class="n">agents</span><span class="p">:</span>
        <span class="c1"># Get the rewards and propensities</span>
        <span class="n">rewards</span><span class="p">,</span> <span class="n">t_props</span><span class="p">,</span> <span class="n">l_props</span> <span class="o">=</span> <span class="n">compute_ips_weights</span><span class="p">(</span><span class="n">agents</span><span class="p">[</span><span class="n">agent_id</span><span class="p">],</span> <span class="n">reco_log</span><span class="p">)</span>
        
        <span class="c1"># Compute the sample weights - propensity ratios</span>
        <span class="n">p_ratio</span> <span class="o">=</span> <span class="n">t_props</span> <span class="o">/</span> <span class="n">l_props</span>

        <span class="c1"># Effective sample size for E_t estimate (from A. Owen)</span>
        <span class="n">n_e</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">rewards</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">p_ratio</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">p_ratio</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">n_e</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">n_e</span><span class="p">)</span> <span class="k">else</span> <span class="n">n_e</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Effective sample size for agent </span><span class="si">{}</span><span class="s2"> is </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">agent_id</span><span class="p">),</span> <span class="n">n_e</span><span class="p">))</span>
        
        <span class="c1"># Critical value from t-distribution as we have unknown variance</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="mf">.00125</span>
        <span class="n">cv</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">df</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n_e</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        
        <span class="c1">###############</span>
        <span class="c1"># VANILLA IPS #</span>
        <span class="c1">###############</span>
        <span class="c1"># Expected reward for pi_t</span>
        <span class="n">E_t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">rewards</span> <span class="o">*</span> <span class="n">p_ratio</span><span class="p">)</span>

        <span class="c1"># Variance of the estimate</span>
        <span class="n">var</span> <span class="o">=</span> <span class="p">((</span><span class="n">rewards</span> <span class="o">*</span> <span class="n">p_ratio</span> <span class="o">-</span> <span class="n">E_t</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">stddev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
        
        <span class="c1"># C.I. assuming unknown variance - use t-distribution and effective sample size</span>
        <span class="n">min_bound</span> <span class="o">=</span> <span class="n">E_t</span> <span class="o">-</span> <span class="n">cv</span> <span class="o">*</span> <span class="n">stddev</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">n_e</span><span class="p">))</span>
        <span class="n">max_bound</span> <span class="o">=</span> <span class="n">E_t</span> <span class="o">+</span> <span class="n">cv</span> <span class="o">*</span> <span class="n">stddev</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">n_e</span><span class="p">))</span>
        
        <span class="c1"># Store result</span>
        <span class="n">IPS_stat</span><span class="p">[</span><span class="s1">&#39;Agent&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">agent_id</span><span class="p">)</span>
        <span class="n">IPS_stat</span><span class="p">[</span><span class="s1">&#39;0.025&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">min_bound</span><span class="p">)</span>
        <span class="n">IPS_stat</span><span class="p">[</span><span class="s1">&#39;0.500&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">E_t</span><span class="p">)</span>
        <span class="n">IPS_stat</span><span class="p">[</span><span class="s1">&#39;0.975&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">max_bound</span><span class="p">)</span>
        
        <span class="c1">############### </span>
        <span class="c1"># CAPPED IPS #</span>
        <span class="c1">##############</span>
        <span class="c1"># Cap ratios</span>
        <span class="n">p_ratio_capped</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">p_ratio</span><span class="p">,</span> <span class="n">a_min</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">a_max</span> <span class="o">=</span> <span class="n">cap</span><span class="p">)</span>
        
        <span class="c1"># Expected reward for pi_t</span>
        <span class="n">E_t_capped</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">rewards</span> <span class="o">*</span> <span class="n">p_ratio_capped</span><span class="p">)</span>

        <span class="c1"># Variance of the estimate</span>
        <span class="n">var_capped</span> <span class="o">=</span> <span class="p">((</span><span class="n">rewards</span> <span class="o">*</span> <span class="n">p_ratio_capped</span> <span class="o">-</span> <span class="n">E_t_capped</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">stddev_capped</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">var_capped</span><span class="p">)</span>        
        
        <span class="c1"># C.I. assuming unknown variance - use t-distribution and effective sample size</span>
        <span class="n">min_bound_capped</span> <span class="o">=</span> <span class="n">E_t_capped</span> <span class="o">-</span> <span class="n">cv</span> <span class="o">*</span> <span class="n">stddev_capped</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">n_e</span><span class="p">))</span>
        <span class="n">max_bound_capped</span> <span class="o">=</span> <span class="n">E_t_capped</span> <span class="o">+</span> <span class="n">cv</span> <span class="o">*</span> <span class="n">stddev_capped</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">n_e</span><span class="p">))</span>
        
        <span class="c1"># Store result</span>
        <span class="n">CIPS_stat</span><span class="p">[</span><span class="s1">&#39;Agent&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">agent_id</span><span class="p">)</span>
        <span class="n">CIPS_stat</span><span class="p">[</span><span class="s1">&#39;0.025&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">min_bound_capped</span><span class="p">)</span>
        <span class="n">CIPS_stat</span><span class="p">[</span><span class="s1">&#39;0.500&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">E_t_capped</span><span class="p">)</span>
        <span class="n">CIPS_stat</span><span class="p">[</span><span class="s1">&#39;0.975&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">max_bound_capped</span><span class="p">)</span>
        
        <span class="c1">##############</span>
        <span class="c1"># NORMED IPS #</span>
        <span class="c1">##############</span>
        <span class="c1"># Expected reward for pi_t</span>
        <span class="n">E_t_normed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">rewards</span> <span class="o">*</span> <span class="n">p_ratio</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">p_ratio</span><span class="p">)</span>

        <span class="c1"># Variance of the estimate</span>
        <span class="n">var_normed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(((</span><span class="n">rewards</span> <span class="o">-</span> <span class="n">E_t_normed</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">p_ratio</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">p_ratio</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>    
        <span class="n">stddev_normed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">var_normed</span><span class="p">)</span>

        <span class="c1"># C.I. assuming unknown variance - use t-distribution and effective sample size</span>
        <span class="n">min_bound_normed</span> <span class="o">=</span> <span class="n">E_t_normed</span> <span class="o">-</span> <span class="n">cv</span> <span class="o">*</span> <span class="n">stddev_normed</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">n_e</span><span class="p">))</span>
        <span class="n">max_bound_normed</span> <span class="o">=</span> <span class="n">E_t_normed</span> <span class="o">+</span> <span class="n">cv</span> <span class="o">*</span> <span class="n">stddev_normed</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">n_e</span><span class="p">))</span>

        <span class="c1"># Store result</span>
        <span class="n">SNIPS_stat</span><span class="p">[</span><span class="s1">&#39;Agent&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">agent_id</span><span class="p">)</span>
        <span class="n">SNIPS_stat</span><span class="p">[</span><span class="s1">&#39;0.025&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">min_bound_normed</span><span class="p">)</span>
        <span class="n">SNIPS_stat</span><span class="p">[</span><span class="s1">&#39;0.500&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">E_t_normed</span><span class="p">)</span>
        <span class="n">SNIPS_stat</span><span class="p">[</span><span class="s1">&#39;0.975&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">max_bound_normed</span><span class="p">)</span>
        
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">IPS_stat</span><span class="p">),</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">CIPS_stat</span><span class="p">),</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">SNIPS_stat</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="creating-agents">
<h3>Creating agents<a class="headerlink" href="#creating-agents" title="Permalink to this headline">¶</a></h3>
<div class="section" id="svd-agent">
<h4>SVD agent<a class="headerlink" href="#svd-agent" title="Permalink to this headline">¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SVDAgent</span><span class="p">(</span><span class="n">Agent</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">U</span> <span class="o">=</span> <span class="n">U</span><span class="p">,</span> <span class="n">P</span> <span class="o">=</span> <span class="n">P</span><span class="p">,</span> <span class="n">K</span> <span class="o">=</span> <span class="mi">5</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SVDAgent</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rng</span> <span class="o">=</span> <span class="n">RandomState</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">random_seed</span><span class="p">)</span>
        <span class="k">assert</span><span class="p">(</span><span class="n">P</span> <span class="o">&gt;=</span> <span class="n">K</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">K</span> <span class="o">=</span> <span class="n">K</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">R</span> <span class="o">=</span> <span class="n">csr_matrix</span><span class="p">((</span><span class="n">U</span><span class="p">,</span><span class="n">P</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">V</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">P</span><span class="p">,</span><span class="n">K</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_history</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">P</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reco_log</span><span class="p">,</span> <span class="n">U</span> <span class="o">=</span> <span class="n">U</span><span class="p">,</span> <span class="n">P</span> <span class="o">=</span> <span class="n">P</span><span class="p">):</span>
        <span class="c1"># Extract all organic user logs</span>
        <span class="n">reco_log</span> <span class="o">=</span> <span class="n">reco_log</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">reco_log</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;organic&#39;</span><span class="p">]</span>
        
        <span class="c1"># Generate ratings matrix for training, row-based for efficient row (user) retrieval</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">R</span> <span class="o">=</span> <span class="n">csr_matrix</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">reco_log</span><span class="p">)),</span>
                            <span class="p">(</span><span class="n">reco_log</span><span class="p">[</span><span class="s1">&#39;u&#39;</span><span class="p">],</span><span class="n">reco_log</span><span class="p">[</span><span class="s1">&#39;v&#39;</span><span class="p">])),</span>
                            <span class="p">(</span><span class="n">U</span><span class="p">,</span><span class="n">P</span><span class="p">))</span>

        <span class="c1"># Singular Value Decomposition</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">V</span> <span class="o">=</span> <span class="n">svds</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">K</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">observe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">observation</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">session</span> <span class="ow">in</span> <span class="n">observation</span><span class="o">.</span><span class="n">sessions</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">user_history</span><span class="p">[</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;v&#39;</span><span class="p">]]</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">act</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">observation</span><span class="p">,</span> <span class="n">reward</span><span class="p">,</span> <span class="n">done</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Act method returns an Action based on current observation and past history&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">observe</span><span class="p">(</span><span class="n">observation</span><span class="p">)</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_history</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">)</span>
        <span class="n">action</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span>
        <span class="n">prob</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span>
        <span class="n">prob</span><span class="p">[</span><span class="n">action</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="o">**</span><span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">act</span><span class="p">(</span><span class="n">observation</span><span class="p">,</span> <span class="n">reward</span><span class="p">,</span> <span class="n">done</span><span class="p">),</span>
            <span class="o">**</span><span class="p">{</span>
                <span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="n">action</span><span class="p">,</span>
                <span class="s1">&#39;ps&#39;</span><span class="p">:</span> <span class="n">prob</span><span class="p">[</span><span class="n">action</span><span class="p">],</span>
                <span class="s1">&#39;ps-a&#39;</span><span class="p">:</span> <span class="n">prob</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_history</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">P</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="item-knn-agent">
<h4>Item-KNN agent<a class="headerlink" href="#item-knn-agent" title="Permalink to this headline">¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">itemkNNAgent</span><span class="p">(</span><span class="n">Agent</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">U</span> <span class="o">=</span> <span class="n">U</span><span class="p">,</span> <span class="n">P</span> <span class="o">=</span> <span class="n">P</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="n">greedy</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">itemkNNAgent</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rng</span> <span class="o">=</span> <span class="n">RandomState</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">random_seed</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">greedy</span> <span class="o">=</span> <span class="n">greedy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="n">alpha</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Rt</span> <span class="o">=</span> <span class="n">csr_matrix</span><span class="p">((</span><span class="n">P</span><span class="p">,</span><span class="n">U</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_history</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">P</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">S</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">P</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reco_log</span><span class="p">,</span> <span class="n">U</span> <span class="o">=</span> <span class="n">U</span><span class="p">,</span> <span class="n">P</span> <span class="o">=</span> <span class="n">P</span><span class="p">):</span>
        <span class="c1"># Extract all organic user logs</span>
        <span class="n">reco_log</span> <span class="o">=</span> <span class="n">reco_log</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">reco_log</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;organic&#39;</span><span class="p">]</span>
        
        <span class="c1"># Generate ratings matrix for training, row-based for efficient row (user) retrieval</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">R_t</span> <span class="o">=</span> <span class="n">csr_matrix</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">reco_log</span><span class="p">)),</span>
                              <span class="p">(</span><span class="n">reco_log</span><span class="p">[</span><span class="s1">&#39;v&#39;</span><span class="p">],</span><span class="n">reco_log</span><span class="p">[</span><span class="s1">&#39;u&#39;</span><span class="p">])),</span>
                              <span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="n">U</span><span class="p">))</span>

        <span class="c1"># Set up nearest neighbours module</span>
        <span class="n">nn</span> <span class="o">=</span> <span class="n">NearestNeighbors</span><span class="p">(</span><span class="n">n_neighbors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">,</span>
                              <span class="n">metric</span> <span class="o">=</span> <span class="s1">&#39;cosine&#39;</span><span class="p">)</span>

        <span class="c1"># Initialise placeholder for distances and indices</span>
        <span class="n">distances</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">indices</span>   <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Dirty fix for multiprocessing backend being unable to pickle large objects</span>
        <span class="n">nn</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R_t</span><span class="p">)</span>
        <span class="n">distances</span><span class="p">,</span> <span class="n">indices</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">kneighbors</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R_t</span><span class="p">,</span> <span class="n">return_distance</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Precompute similarity matrix S</span>
        <span class="n">data</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">chain</span><span class="o">.</span><span class="n">from_iterable</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">distances</span><span class="p">))</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">chain</span><span class="o">.</span><span class="n">from_iterable</span><span class="p">([</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">k</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">P</span><span class="p">)))</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">chain</span><span class="o">.</span><span class="n">from_iterable</span><span class="p">(</span><span class="n">indices</span><span class="p">))</span>
        
        <span class="c1"># (P,P)-matrix with cosine similarities between items</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">S</span> <span class="o">=</span> <span class="n">csr_matrix</span><span class="p">((</span><span class="n">data</span><span class="p">,(</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">)),</span> <span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="n">P</span><span class="p">))</span><span class="o">.</span><span class="n">todense</span><span class="p">()</span>
        
    <span class="k">def</span> <span class="nf">observe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">observation</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">session</span> <span class="ow">in</span> <span class="n">observation</span><span class="o">.</span><span class="n">sessions</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">user_history</span><span class="p">[</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;v&#39;</span><span class="p">]]</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">act</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">observation</span><span class="p">,</span> <span class="n">reward</span><span class="p">,</span> <span class="n">done</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Act method returns an Action based on current observation and past history&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">observe</span><span class="p">(</span><span class="n">observation</span><span class="p">)</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_history</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">S</span><span class="p">)</span><span class="o">.</span><span class="n">A1</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">greedy</span><span class="p">:</span>
            <span class="n">action</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span>
            <span class="n">prob</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span>
            <span class="n">prob</span><span class="p">[</span><span class="n">action</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">scores</span> <span class="o">**=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span>
            <span class="n">prob</span> <span class="o">=</span> <span class="n">scores</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span>
            <span class="n">action</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">S</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">p</span> <span class="o">=</span> <span class="n">prob</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="o">**</span><span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">act</span><span class="p">(</span><span class="n">observation</span><span class="p">,</span> <span class="n">reward</span><span class="p">,</span> <span class="n">done</span><span class="p">),</span>
            <span class="o">**</span><span class="p">{</span>
                <span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="n">action</span><span class="p">,</span>
                <span class="s1">&#39;ps&#39;</span><span class="p">:</span> <span class="n">prob</span><span class="p">[</span><span class="n">action</span><span class="p">],</span>
                <span class="s1">&#39;ps-a&#39;</span><span class="p">:</span> <span class="n">prob</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_history</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">P</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="user-knn-agent">
<h4>User-KNN agent<a class="headerlink" href="#user-knn-agent" title="Permalink to this headline">¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">userkNNAgent</span><span class="p">(</span><span class="n">Agent</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">U</span> <span class="o">=</span> <span class="n">U</span><span class="p">,</span> <span class="n">P</span> <span class="o">=</span> <span class="n">P</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="n">greedy</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">userkNNAgent</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rng</span> <span class="o">=</span> <span class="n">RandomState</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">random_seed</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">greedy</span> <span class="o">=</span> <span class="n">greedy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="n">alpha</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">U</span> <span class="o">=</span> <span class="n">U</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">P</span> <span class="o">=</span> <span class="n">P</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">R</span> <span class="o">=</span> <span class="n">csr_matrix</span><span class="p">((</span><span class="n">U</span><span class="p">,</span><span class="n">P</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_history</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">P</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nn</span> <span class="o">=</span> <span class="n">NearestNeighbors</span><span class="p">(</span><span class="n">n_neighbors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">,</span> <span class="n">metric</span> <span class="o">=</span> <span class="s1">&#39;cosine&#39;</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reco_log</span><span class="p">,</span> <span class="n">U</span> <span class="o">=</span> <span class="n">U</span><span class="p">,</span> <span class="n">P</span> <span class="o">=</span> <span class="n">P</span><span class="p">):</span>
        <span class="c1"># Extract all organic user logs</span>
        <span class="n">reco_log</span> <span class="o">=</span> <span class="n">reco_log</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">reco_log</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;organic&#39;</span><span class="p">]</span>
        
        <span class="c1"># Generate ratings matrix for training, row-based for efficient row (user) retrieval</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">R</span> <span class="o">=</span> <span class="n">csr_matrix</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">reco_log</span><span class="p">)),</span>
                            <span class="p">(</span><span class="n">reco_log</span><span class="p">[</span><span class="s1">&#39;u&#39;</span><span class="p">],</span><span class="n">reco_log</span><span class="p">[</span><span class="s1">&#39;v&#39;</span><span class="p">])),</span>
                            <span class="p">(</span><span class="n">U</span><span class="p">,</span><span class="n">P</span><span class="p">))</span>

        <span class="c1"># Fit nearest neighbours</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">observe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">observation</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">session</span> <span class="ow">in</span> <span class="n">observation</span><span class="o">.</span><span class="n">sessions</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">user_history</span><span class="p">[</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;v&#39;</span><span class="p">]]</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">act</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">observation</span><span class="p">,</span> <span class="n">reward</span><span class="p">,</span> <span class="n">done</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Act method returns an Action based on current observation and past history&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">observe</span><span class="p">(</span><span class="n">observation</span><span class="p">)</span>
        
        <span class="c1"># Get neighbouring users based on user history</span>
        <span class="n">distances</span><span class="p">,</span> <span class="n">indices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">kneighbors</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_history</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="o">.</span><span class="n">reduce</span><span class="p">([</span><span class="n">dist</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">[</span><span class="n">idx</span><span class="p">,:]</span> <span class="k">for</span> <span class="n">dist</span><span class="p">,</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">distances</span><span class="p">,</span><span class="n">indices</span><span class="p">)])</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">greedy</span><span class="p">:</span>
            <span class="n">action</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span>
            <span class="n">prob</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span>
            <span class="n">prob</span><span class="p">[</span><span class="n">action</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">scores</span> <span class="o">**=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span>
            <span class="n">prob</span> <span class="o">=</span> <span class="n">scores</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span>
            <span class="n">action</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">P</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="n">prob</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="o">**</span><span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">act</span><span class="p">(</span><span class="n">observation</span><span class="p">,</span> <span class="n">reward</span><span class="p">,</span> <span class="n">done</span><span class="p">),</span>
            <span class="o">**</span><span class="p">{</span>
                <span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="n">action</span><span class="p">,</span>
                <span class="s1">&#39;ps&#39;</span><span class="p">:</span> <span class="n">prob</span><span class="p">[</span><span class="n">action</span><span class="p">],</span>
                <span class="s1">&#39;ps-a&#39;</span><span class="p">:</span> <span class="n">prob</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_history</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">P</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="agent-initializations">
<h4>Agent initializations<a class="headerlink" href="#agent-initializations" title="Permalink to this headline">¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># SVD Agent</span>
<span class="n">SVD_agent</span> <span class="o">=</span> <span class="n">SVDAgent</span><span class="p">(</span><span class="n">Configuration</span><span class="p">(</span><span class="n">env_1_args</span><span class="p">),</span> <span class="n">U</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>
<span class="n">SVD_agent</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">reco_log</span><span class="p">)</span>

<span class="c1"># item-kNN Agent</span>
<span class="n">itemkNN_agent</span> <span class="o">=</span> <span class="n">itemkNNAgent</span><span class="p">(</span><span class="n">Configuration</span><span class="p">(</span><span class="n">env_1_args</span><span class="p">),</span> <span class="n">U</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="n">greedy</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
<span class="n">itemkNN_agent</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">reco_log</span><span class="p">)</span>

<span class="c1"># user-kNN Agent</span>
<span class="n">userkNN_agent</span> <span class="o">=</span> <span class="n">userkNNAgent</span><span class="p">(</span><span class="n">Configuration</span><span class="p">(</span><span class="n">env_1_args</span><span class="p">),</span> <span class="n">U</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="n">greedy</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
<span class="n">userkNN_agent</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">reco_log</span><span class="p">)</span>

<span class="c1"># Generalised Popularity agent</span>
<span class="n">GPOP_agent</span> <span class="o">=</span> <span class="n">OrganicCount</span><span class="p">(</span><span class="n">Configuration</span><span class="p">({</span>
    <span class="o">**</span><span class="n">env_1_args</span><span class="p">,</span>
    <span class="s1">&#39;select_randomly&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">}))</span>

<span class="c1"># Generalised Popularity agent</span>
<span class="n">GPOP_agent_greedy</span> <span class="o">=</span> <span class="n">OrganicCount</span><span class="p">(</span><span class="n">Configuration</span><span class="p">({</span>
    <span class="o">**</span><span class="n">env_1_args</span><span class="p">,</span>
    <span class="s1">&#39;select_randomly&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">}))</span>

<span class="c1"># Peronalised Popularity agent</span>
<span class="n">PPOP_agent</span> <span class="o">=</span> <span class="n">OrganicUserEventCounterAgent</span><span class="p">(</span><span class="n">Configuration</span><span class="p">({</span>
    <span class="o">**</span><span class="n">organic_user_count_args</span><span class="p">,</span>
    <span class="o">**</span><span class="n">env_1_args</span><span class="p">,</span>
    <span class="s1">&#39;select_randomly&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">}))</span>

<span class="c1"># Peronalised Popularity agent</span>
<span class="n">PPOP_agent_greedy</span> <span class="o">=</span> <span class="n">OrganicUserEventCounterAgent</span><span class="p">(</span><span class="n">Configuration</span><span class="p">({</span>
    <span class="o">**</span><span class="n">organic_user_count_args</span><span class="p">,</span>
    <span class="o">**</span><span class="n">env_1_args</span><span class="p">,</span>
    <span class="s1">&#39;select_randomly&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">}))</span>

<span class="c1"># Random Agent</span>
<span class="n">random_args</span><span class="p">[</span><span class="s1">&#39;num_products&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">P</span>
<span class="n">RAND_agent</span> <span class="o">=</span> <span class="n">RandomAgent</span><span class="p">(</span><span class="n">Configuration</span><span class="p">({</span><span class="o">**</span><span class="n">env_1_args</span><span class="p">,</span> <span class="o">**</span><span class="n">random_args</span><span class="p">,}))</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="offline-evaluation">
<h3>Offline evaluation<a class="headerlink" href="#offline-evaluation" title="Permalink to this headline">¶</a></h3>
<div class="section" id="generating-test-logs">
<h4>Generating test logs<a class="headerlink" href="#generating-test-logs" title="Permalink to this headline">¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">time</span>
<span class="c1"># Placeholder for agents</span>
<span class="n">agents</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;    Random&#39;</span><span class="p">:</span> <span class="n">RAND_agent</span><span class="p">,</span>
    <span class="s1">&#39;   Popular&#39;</span><span class="p">:</span> <span class="n">GPOP_agent_greedy</span><span class="p">,</span>
    <span class="s1">&#39;   User-pop&#39;</span><span class="p">:</span> <span class="n">PPOP_agent</span><span class="p">,</span>
    <span class="s1">&#39;  SVD&#39;</span><span class="p">:</span>  <span class="n">SVD_agent</span><span class="p">,</span>
    <span class="s1">&#39; User-kNN&#39;</span><span class="p">:</span> <span class="n">userkNN_agent</span><span class="p">,</span>
    <span class="s1">&#39;Item-kNN&#39;</span><span class="p">:</span> <span class="n">itemkNN_agent</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">agent_ids</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">agents</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span><span class="c1">#[&#39;SVD&#39;,&#39;GPOP&#39;,&#39;PPOP&#39;,&#39;RAND&#39;]</span>
<span class="c1"># Generate new logs, to be used for offline testing</span>
<span class="n">n_test_users</span> <span class="o">=</span> <span class="mi">5000</span> <span class="c1"># U</span>
<span class="n">test_log</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">generate_logs</span><span class="p">(</span><span class="n">n_test_users</span><span class="p">)</span>
<span class="n">n_events</span> <span class="o">=</span> <span class="n">test_log</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">n_organic</span> <span class="o">=</span> <span class="n">test_log</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">test_log</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;organic&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Testing on </span><span class="si">{0}</span><span class="s1"> organic and </span><span class="si">{1}</span><span class="s1"> bandit events&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n_organic</span><span class="p">,</span> <span class="n">n_events</span> <span class="o">-</span> <span class="n">n_organic</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Organic Users: 0it [00:00, ?it/s]
Users: 100%|██████████| 5000/5000 [05:38&lt;00:00, 14.77it/s]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Testing on 109631 organic and 403487 bandit events
CPU times: user 6min 4s, sys: 4min 47s, total: 10min 51s
Wall time: 5min 40s
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="util-helper-function-to-plot-barchart">
<h4>(Util) helper function to plot barchart<a class="headerlink" href="#util-helper-function-to-plot-barchart" title="Permalink to this headline">¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">plot_barchart</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">xlabel</span><span class="p">,</span>  <span class="n">col</span> <span class="o">=</span> <span class="s1">&#39;tab:red&#39;</span><span class="p">,</span> <span class="n">figname</span> <span class="o">=</span> <span class="s1">&#39;fig.eps&#39;</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">12</span><span class="p">):</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="n">size</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="n">fontsize</span><span class="p">)</span>
    <span class="n">n_agents</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
    <span class="n">yticks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_agents</span><span class="p">)</span>
    <span class="n">mean</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;0.500&#39;</span><span class="p">]</span>
    <span class="n">lower</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;0.500&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;0.025&#39;</span><span class="p">]</span>
    <span class="n">upper</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;0.975&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;0.500&#39;</span><span class="p">]</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="n">yticks</span><span class="p">,</span>
             <span class="n">mean</span><span class="p">,</span>
             <span class="n">height</span> <span class="o">=</span> <span class="mf">.25</span><span class="p">,</span>
             <span class="n">xerr</span>  <span class="o">=</span> <span class="p">(</span><span class="n">lower</span><span class="p">,</span> <span class="n">upper</span><span class="p">),</span>
             <span class="n">align</span> <span class="o">=</span> <span class="s1">&#39;center&#39;</span><span class="p">,</span>
             <span class="n">color</span> <span class="o">=</span> <span class="n">col</span><span class="p">,)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="n">yticks</span><span class="p">,</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;Agent&#39;</span><span class="p">],</span> <span class="n">size</span> <span class="o">=</span> <span class="n">fontsize</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">size</span> <span class="o">=</span> <span class="n">fontsize</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="n">xlabel</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="n">fontsize</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mf">.0</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">FormatStrFormatter</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%.2f</span><span class="s1">&#39;</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">figname</span><span class="p">,</span> <span class="n">bbox_inches</span> <span class="o">=</span> <span class="s1">&#39;tight&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="leave-one-out-evaluation">
<h4>Leave-one-out evaluation<a class="headerlink" href="#leave-one-out-evaluation" title="Permalink to this headline">¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">time</span>
<span class="n">result_LOO</span> <span class="o">=</span> <span class="n">verify_agents_traditional</span><span class="p">(</span><span class="n">test_log</span><span class="p">,</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">agents</span><span class="p">))</span>
<span class="n">display</span><span class="p">(</span><span class="n">result_LOO</span><span class="p">)</span>
<span class="n">plot_barchart</span><span class="p">(</span><span class="n">result_LOO</span><span class="p">,</span> <span class="s1">&#39;Evaluate on Organic Feedback&#39;</span><span class="p">,</span> <span class="s1">&#39;HR@1&#39;</span><span class="p">,</span> <span class="s1">&#39;tab:red&#39;</span><span class="p">,</span> <span class="s1">&#39;traditional_eval.eps&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/usr/local/lib/python3.7/dist-packages/recogym/agents/organic_user_count.py:51: RuntimeWarning: invalid value encountered in true_divide
  action_proba = features / np.sum(features)
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Agent</th>
      <th>0.025</th>
      <th>0.500</th>
      <th>0.975</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Random</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Popular</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>2</th>
      <td>User-pop</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>3</th>
      <td>SVD</td>
      <td>0.074560</td>
      <td>0.076895</td>
      <td>0.079231</td>
    </tr>
    <tr>
      <th>4</th>
      <td>User-kNN</td>
      <td>0.079927</td>
      <td>0.082336</td>
      <td>0.084746</td>
    </tr>
    <tr>
      <th>5</th>
      <td>Item-kNN</td>
      <td>0.074461</td>
      <td>0.076795</td>
      <td>0.079130</td>
    </tr>
  </tbody>
</table>
</div></div><img alt="../_images/T057885_Offline_Replayer_Evaluation_30_2.png" src="../_images/T057885_Offline_Replayer_Evaluation_30_2.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>CPU times: user 6min 45s, sys: 43 s, total: 7min 28s
Wall time: 4min 43s
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="ips-estimators">
<h4>IPS Estimators<a class="headerlink" href="#ips-estimators" title="Permalink to this headline">¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Generate new logs, to be used for offline testing</span>
<span class="n">test_log_ppop</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">generate_logs</span><span class="p">(</span><span class="n">n_test_users</span><span class="p">,</span> <span class="n">agent</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">PPOP_agent</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">test_log_ppop</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>t</th>
      <th>u</th>
      <th>z</th>
      <th>v</th>
      <th>a</th>
      <th>c</th>
      <th>ps</th>
      <th>ps-a</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0.0</td>
      <td>0</td>
      <td>organic</td>
      <td>220</td>
      <td>&lt;NA&gt;</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>None</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1.0</td>
      <td>0</td>
      <td>organic</td>
      <td>867</td>
      <td>&lt;NA&gt;</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>None</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2.0</td>
      <td>0</td>
      <td>organic</td>
      <td>969</td>
      <td>&lt;NA&gt;</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>None</td>
    </tr>
    <tr>
      <th>3</th>
      <td>3.0</td>
      <td>0</td>
      <td>organic</td>
      <td>730</td>
      <td>&lt;NA&gt;</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>None</td>
    </tr>
    <tr>
      <th>4</th>
      <td>4.0</td>
      <td>0</td>
      <td>bandit</td>
      <td>&lt;NA&gt;</td>
      <td>969</td>
      <td>0.0</td>
      <td>0.25</td>
      <td>()</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">time</span>
<span class="n">cap</span> <span class="o">=</span> <span class="mi">15</span>
<span class="n">result_IPS</span><span class="p">,</span> <span class="n">result_CIPS</span><span class="p">,</span> <span class="n">result_SNIPS</span> <span class="o">=</span> <span class="n">verify_agents_counterfactual</span><span class="p">(</span><span class="n">test_log_ppop</span><span class="p">,</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">agents</span><span class="p">),</span> <span class="n">cap</span> <span class="o">=</span> <span class="n">cap</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">result_IPS</span><span class="p">)</span>
<span class="n">plot_barchart</span><span class="p">(</span><span class="n">result_IPS</span><span class="p">,</span> <span class="s1">&#39;IPS&#39;</span><span class="p">,</span> <span class="s1">&#39;CTR&#39;</span><span class="p">,</span> <span class="s1">&#39;tab:blue&#39;</span><span class="p">,</span> <span class="s1">&#39;bandit_eval_noclip.eps&#39;</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">result_CIPS</span><span class="p">)</span>
<span class="n">plot_barchart</span><span class="p">(</span><span class="n">result_CIPS</span><span class="p">,</span> <span class="s1">&#39;Clipped IPS&#39;</span><span class="p">,</span> <span class="s1">&#39;CTR&#39;</span><span class="p">,</span> <span class="s1">&#39;tab:blue&#39;</span><span class="p">,</span> <span class="s1">&#39;bandit_eval_clip</span><span class="si">{0}</span><span class="s1">.eps&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cap</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/usr/local/lib/python3.7/dist-packages/ipykernel_launcher.py:65: RuntimeWarning: invalid value encountered in double_scalars
/usr/local/lib/python3.7/dist-packages/ipykernel_launcher.py:120: RuntimeWarning: invalid value encountered in double_scalars
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Effective sample size for agent     Random is 0
Effective sample size for agent    Popular is 0
Effective sample size for agent    User-pop is 0
Effective sample size for agent   SVD is 21243.67667925834
Effective sample size for agent  User-kNN is 33971.880634000554
Effective sample size for agent Item-kNN is 39627.482103973896
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Agent</th>
      <th>0.025</th>
      <th>0.500</th>
      <th>0.975</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Random</td>
      <td>NaN</td>
      <td>0.000000</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Popular</td>
      <td>NaN</td>
      <td>0.000000</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2</th>
      <td>User-pop</td>
      <td>NaN</td>
      <td>0.000000</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>3</th>
      <td>SVD</td>
      <td>0.005323</td>
      <td>0.013057</td>
      <td>0.020791</td>
    </tr>
    <tr>
      <th>4</th>
      <td>User-kNN</td>
      <td>0.010922</td>
      <td>0.017513</td>
      <td>0.024104</td>
    </tr>
    <tr>
      <th>5</th>
      <td>Item-kNN</td>
      <td>0.012314</td>
      <td>0.018250</td>
      <td>0.024186</td>
    </tr>
  </tbody>
</table>
</div></div><img alt="../_images/T057885_Offline_Replayer_Evaluation_34_3.png" src="../_images/T057885_Offline_Replayer_Evaluation_34_3.png" />
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Agent</th>
      <th>0.025</th>
      <th>0.500</th>
      <th>0.975</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Random</td>
      <td>NaN</td>
      <td>0.000000</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Popular</td>
      <td>NaN</td>
      <td>0.000000</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2</th>
      <td>User-pop</td>
      <td>NaN</td>
      <td>0.000000</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>3</th>
      <td>SVD</td>
      <td>0.005590</td>
      <td>0.012160</td>
      <td>0.018731</td>
    </tr>
    <tr>
      <th>4</th>
      <td>User-kNN</td>
      <td>0.010801</td>
      <td>0.016735</td>
      <td>0.022670</td>
    </tr>
    <tr>
      <th>5</th>
      <td>Item-kNN</td>
      <td>0.012184</td>
      <td>0.017599</td>
      <td>0.023014</td>
    </tr>
  </tbody>
</table>
</div></div><img alt="../_images/T057885_Offline_Replayer_Evaluation_34_5.png" src="../_images/T057885_Offline_Replayer_Evaluation_34_5.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>CPU times: user 45min 36s, sys: 2min 15s, total: 47min 51s
Wall time: 29min 38s
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="a-b-tests">
<h4>A/B tests<a class="headerlink" href="#a-b-tests" title="Permalink to this headline">¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">time</span>
<span class="n">result_AB</span> <span class="o">=</span> <span class="n">verify_agents</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">n_test_users</span><span class="p">,</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">agents</span><span class="p">))</span>
<span class="n">display</span><span class="p">(</span><span class="n">result_AB</span><span class="p">)</span>
<span class="n">plot_barchart</span><span class="p">(</span><span class="n">result_AB</span><span class="p">,</span> <span class="s1">&#39;A/B-test&#39;</span><span class="p">,</span> <span class="s1">&#39;CTR&#39;</span><span class="p">,</span> <span class="s1">&#39;tab:green&#39;</span><span class="p">,</span> <span class="s1">&#39;ABtest_eval.eps&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Organic Users: 0it [00:00, ?it/s]
Users: 100%|██████████| 5000/5000 [05:39&lt;00:00, 14.71it/s]
Organic Users: 0it [00:00, ?it/s]
Users: 100%|██████████| 5000/5000 [05:35&lt;00:00, 14.92it/s]
Organic Users: 0it [00:00, ?it/s]
Users: 100%|██████████| 5000/5000 [06:49&lt;00:00, 12.20it/s]
Organic Users: 0it [00:00, ?it/s]
Users: 100%|██████████| 5000/5000 [06:39&lt;00:00, 12.53it/s]
Organic Users: 0it [00:00, ?it/s]
Users:  83%|████████▎ | 4163/5000 [18:04&lt;03:51,  3.62it/s]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">combine_barchart</span><span class="p">(</span><span class="n">resultAB</span><span class="p">,</span> <span class="n">resultCIPS</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">xlabel</span><span class="p">,</span>  <span class="n">figname</span> <span class="o">=</span> <span class="s1">&#39;fig.eps&#39;</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">12</span><span class="p">):</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="n">size</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="n">fontsize</span><span class="p">)</span>
    <span class="n">n_agents</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">resultAB</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">colour</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([(</span><span class="s1">&#39;A/B-test&#39;</span><span class="p">,</span> <span class="s1">&#39;tab:green&#39;</span><span class="p">,</span> <span class="n">result_AB</span><span class="p">),(</span><span class="s1">&#39;CIPS&#39;</span><span class="p">,</span> <span class="s1">&#39;tab:blue&#39;</span><span class="p">,</span> <span class="n">result_CIPS</span><span class="p">)]):</span>
        <span class="n">mean</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;0.500&#39;</span><span class="p">]</span>
        <span class="n">lower</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;0.500&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;0.025&#39;</span><span class="p">]</span>
        <span class="n">upper</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;0.975&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;0.500&#39;</span><span class="p">]</span>
        <span class="n">height</span> <span class="o">=</span> <span class="mf">.25</span>
        <span class="n">yticks</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="n">height</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_agents</span><span class="p">)]</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="n">yticks</span><span class="p">,</span>
                 <span class="n">mean</span><span class="p">,</span>
                 <span class="n">height</span> <span class="o">=</span> <span class="n">height</span><span class="p">,</span>
                 <span class="n">xerr</span>  <span class="o">=</span> <span class="p">(</span><span class="n">lower</span><span class="p">,</span> <span class="n">upper</span><span class="p">),</span>
                 <span class="n">align</span> <span class="o">=</span> <span class="s1">&#39;edge&#39;</span><span class="p">,</span>
                 <span class="n">label</span> <span class="o">=</span> <span class="n">name</span><span class="p">,</span>
                 <span class="n">color</span> <span class="o">=</span> <span class="n">colour</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="n">yticks</span><span class="p">,</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;Agent&#39;</span><span class="p">],</span> <span class="n">size</span> <span class="o">=</span> <span class="n">fontsize</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">size</span> <span class="o">=</span> <span class="n">fontsize</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="n">xlabel</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="n">fontsize</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span> <span class="o">=</span> <span class="s1">&#39;lower right&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mf">.0</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">FormatStrFormatter</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%.3f</span><span class="s1">&#39;</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">figname</span><span class="p">,</span> <span class="n">bbox_inches</span> <span class="o">=</span> <span class="s1">&#39;tight&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="n">combine_barchart</span><span class="p">(</span><span class="n">result_AB</span><span class="p">,</span> <span class="n">result_CIPS</span><span class="p">,</span> <span class="s1">&#39;Evaluate on Bandit Feedback&#39;</span><span class="p">,</span> <span class="s1">&#39;CTR&#39;</span><span class="p">,</span> <span class="s1">&#39;ABtest_CIPS.eps&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">plot_barchart</span><span class="p">(</span><span class="n">result_LOO</span><span class="p">,</span> <span class="s1">&#39;Evaluate on Organic Feedback&#39;</span><span class="p">,</span> <span class="s1">&#39;HR@1&#39;</span><span class="p">,</span> <span class="s1">&#39;tab:red&#39;</span><span class="p">,</span> <span class="s1">&#39;traditional_eval.eps&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="recogym-small">
<h2>Recogym small<a class="headerlink" href="#recogym-small" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><p>Running recogym for offline simulation and evaluation with small number of users and items</p>
</div></blockquote>
<div class="section" id="imports">
<h3>Imports<a class="headerlink" href="#imports" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>!pip install -q recogym
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">numpy.random.mtrand</span> <span class="kn">import</span> <span class="n">RandomState</span>
<span class="kn">from</span> <span class="nn">scipy.special</span> <span class="kn">import</span> <span class="n">logsumexp</span>
<span class="kn">import</span> <span class="nn">scipy</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">scipy.stats.distributions</span> <span class="kn">import</span> <span class="n">beta</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>

<span class="kn">from</span> <span class="nn">scipy.sparse</span> <span class="kn">import</span> <span class="n">csr_matrix</span>
<span class="kn">from</span> <span class="nn">scipy.sparse.linalg</span> <span class="kn">import</span> <span class="n">svds</span>

<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">chain</span>
<span class="kn">from</span> <span class="nn">sklearn.neighbors</span> <span class="kn">import</span> <span class="n">NearestNeighbors</span>
<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">display</span><span class="p">,</span> <span class="n">HTML</span>

<span class="kn">from</span> <span class="nn">matplotlib.ticker</span> <span class="kn">import</span> <span class="n">FormatStrFormatter</span>

<span class="kn">import</span> <span class="nn">gym</span><span class="o">,</span> <span class="nn">recogym</span>
<span class="kn">from</span> <span class="nn">recogym</span> <span class="kn">import</span> <span class="n">env_1_args</span><span class="p">,</span> <span class="n">Configuration</span>
<span class="kn">from</span> <span class="nn">recogym.agents</span> <span class="kn">import</span> <span class="n">OrganicUserEventCounterAgent</span><span class="p">,</span> <span class="n">organic_user_count_args</span>
<span class="kn">from</span> <span class="nn">recogym.agents.organic_count</span> <span class="kn">import</span> <span class="n">OrganicCount</span><span class="p">,</span> <span class="n">organic_count_args</span><span class="p">,</span> <span class="n">to_categorical</span>
<span class="kn">from</span> <span class="nn">recogym</span> <span class="kn">import</span> <span class="n">Configuration</span>
<span class="kn">from</span> <span class="nn">recogym.agents</span> <span class="kn">import</span> <span class="n">Agent</span>
<span class="kn">from</span> <span class="nn">recogym.envs.observation</span> <span class="kn">import</span> <span class="n">Observation</span>
<span class="kn">from</span> <span class="nn">recogym.agents</span> <span class="kn">import</span> <span class="n">RandomAgent</span><span class="p">,</span> <span class="n">random_args</span>
<span class="kn">from</span> <span class="nn">recogym</span> <span class="kn">import</span> <span class="n">verify_agents</span><span class="p">,</span> <span class="n">verify_agents_IPS</span>
<span class="kn">from</span> <span class="nn">recogym.evaluate_agent</span> <span class="kn">import</span> <span class="n">plot_verify_agents</span><span class="p">,</span> <span class="n">verify_agents_recall_at_k</span>

<span class="kn">from</span> <span class="nn">recogym.envs.session</span> <span class="kn">import</span> <span class="n">OrganicSessions</span>
<span class="kn">from</span> <span class="nn">recogym.envs.context</span> <span class="kn">import</span> <span class="n">DefaultContext</span>
<span class="kn">from</span> <span class="nn">recogym.envs.observation</span> <span class="kn">import</span> <span class="n">Observation</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="o">%</span><span class="n">matplotlib</span> <span class="n">inline</span>

<span class="n">P</span> <span class="o">=</span> <span class="mi">50</span> <span class="c1"># Number of Products</span>
<span class="n">U</span> <span class="o">=</span> <span class="mi">50</span> <span class="c1"># Number of Users</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># You can overwrite environment arguments here</span>
<span class="n">env_1_args</span><span class="p">[</span><span class="s1">&#39;random_seed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">42</span>
<span class="n">env_1_args</span><span class="p">[</span><span class="s1">&#39;num_products&#39;</span><span class="p">]</span><span class="o">=</span> <span class="n">P</span>
<span class="n">env_1_args</span><span class="p">[</span><span class="s1">&#39;phi_var&#39;</span><span class="p">]</span><span class="o">=</span><span class="mf">0.0</span>
<span class="n">env_1_args</span><span class="p">[</span><span class="s1">&#39;number_of_flips&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">P</span><span class="o">//</span><span class="mi">2</span>
<span class="n">env_1_args</span><span class="p">[</span><span class="s1">&#39;sigma_mu_organic&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.1</span>
<span class="n">env_1_args</span><span class="p">[</span><span class="s1">&#39;sigma_omega&#39;</span><span class="p">]</span><span class="o">=</span><span class="mf">0.05</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Initialize the gym for the first time by calling .make() and .init_gym()</span>
<span class="n">env</span> <span class="o">=</span> <span class="n">gym</span><span class="o">.</span><span class="n">make</span><span class="p">(</span><span class="s1">&#39;reco-gym-v1&#39;</span><span class="p">)</span>
<span class="n">env</span><span class="o">.</span><span class="n">init_gym</span><span class="p">(</span><span class="n">env_1_args</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">env</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Generate RecSys logs for U users</span>
<span class="n">reco_log</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">generate_logs</span><span class="p">(</span><span class="n">U</span><span class="p">)</span>
<span class="n">reco_log</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Organic Users: 0it [00:00, ?it/s]
Users: 100%|██████████| 50/50 [00:01&lt;00:00, 44.55it/s]
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>t</th>
      <th>u</th>
      <th>z</th>
      <th>v</th>
      <th>a</th>
      <th>c</th>
      <th>ps</th>
      <th>ps-a</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0.0</td>
      <td>0</td>
      <td>organic</td>
      <td>6</td>
      <td>&lt;NA&gt;</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>None</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1.0</td>
      <td>0</td>
      <td>organic</td>
      <td>6</td>
      <td>&lt;NA&gt;</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>None</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2.0</td>
      <td>0</td>
      <td>organic</td>
      <td>31</td>
      <td>&lt;NA&gt;</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>None</td>
    </tr>
    <tr>
      <th>3</th>
      <td>3.0</td>
      <td>0</td>
      <td>organic</td>
      <td>2</td>
      <td>&lt;NA&gt;</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>None</td>
    </tr>
    <tr>
      <th>4</th>
      <td>4.0</td>
      <td>0</td>
      <td>organic</td>
      <td>31</td>
      <td>&lt;NA&gt;</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>None</td>
    </tr>
    <tr>
      <th>5</th>
      <td>5.0</td>
      <td>0</td>
      <td>organic</td>
      <td>32</td>
      <td>&lt;NA&gt;</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>None</td>
    </tr>
    <tr>
      <th>6</th>
      <td>6.0</td>
      <td>0</td>
      <td>organic</td>
      <td>1</td>
      <td>&lt;NA&gt;</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>None</td>
    </tr>
    <tr>
      <th>7</th>
      <td>7.0</td>
      <td>0</td>
      <td>bandit</td>
      <td>&lt;NA&gt;</td>
      <td>23</td>
      <td>0.0</td>
      <td>0.02</td>
      <td>()</td>
    </tr>
    <tr>
      <th>8</th>
      <td>8.0</td>
      <td>0</td>
      <td>bandit</td>
      <td>&lt;NA&gt;</td>
      <td>10</td>
      <td>0.0</td>
      <td>0.02</td>
      <td>()</td>
    </tr>
    <tr>
      <th>9</th>
      <td>9.0</td>
      <td>0</td>
      <td>bandit</td>
      <td>&lt;NA&gt;</td>
      <td>34</td>
      <td>0.0</td>
      <td>0.02</td>
      <td>()</td>
    </tr>
    <tr>
      <th>10</th>
      <td>10.0</td>
      <td>0</td>
      <td>bandit</td>
      <td>&lt;NA&gt;</td>
      <td>38</td>
      <td>0.0</td>
      <td>0.02</td>
      <td>()</td>
    </tr>
    <tr>
      <th>11</th>
      <td>11.0</td>
      <td>0</td>
      <td>bandit</td>
      <td>&lt;NA&gt;</td>
      <td>8</td>
      <td>0.0</td>
      <td>0.02</td>
      <td>()</td>
    </tr>
    <tr>
      <th>12</th>
      <td>12.0</td>
      <td>0</td>
      <td>bandit</td>
      <td>&lt;NA&gt;</td>
      <td>47</td>
      <td>0.0</td>
      <td>0.02</td>
      <td>()</td>
    </tr>
    <tr>
      <th>13</th>
      <td>13.0</td>
      <td>0</td>
      <td>bandit</td>
      <td>&lt;NA&gt;</td>
      <td>36</td>
      <td>0.0</td>
      <td>0.02</td>
      <td>()</td>
    </tr>
    <tr>
      <th>14</th>
      <td>14.0</td>
      <td>0</td>
      <td>bandit</td>
      <td>&lt;NA&gt;</td>
      <td>26</td>
      <td>0.0</td>
      <td>0.02</td>
      <td>()</td>
    </tr>
    <tr>
      <th>15</th>
      <td>15.0</td>
      <td>0</td>
      <td>bandit</td>
      <td>&lt;NA&gt;</td>
      <td>46</td>
      <td>0.0</td>
      <td>0.02</td>
      <td>()</td>
    </tr>
    <tr>
      <th>16</th>
      <td>16.0</td>
      <td>0</td>
      <td>bandit</td>
      <td>&lt;NA&gt;</td>
      <td>25</td>
      <td>0.0</td>
      <td>0.02</td>
      <td>()</td>
    </tr>
    <tr>
      <th>17</th>
      <td>17.0</td>
      <td>0</td>
      <td>bandit</td>
      <td>&lt;NA&gt;</td>
      <td>26</td>
      <td>0.0</td>
      <td>0.02</td>
      <td>()</td>
    </tr>
    <tr>
      <th>18</th>
      <td>18.0</td>
      <td>0</td>
      <td>bandit</td>
      <td>&lt;NA&gt;</td>
      <td>41</td>
      <td>0.0</td>
      <td>0.02</td>
      <td>()</td>
    </tr>
    <tr>
      <th>19</th>
      <td>19.0</td>
      <td>0</td>
      <td>bandit</td>
      <td>&lt;NA&gt;</td>
      <td>31</td>
      <td>0.0</td>
      <td>0.02</td>
      <td>()</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">n_events</span> <span class="o">=</span> <span class="n">reco_log</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">n_organic</span> <span class="o">=</span> <span class="n">reco_log</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">reco_log</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;organic&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Training on </span><span class="si">{0}</span><span class="s1"> organic and </span><span class="si">{1}</span><span class="s1"> bandit events&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n_organic</span><span class="p">,</span> <span class="n">n_events</span> <span class="o">-</span> <span class="n">n_organic</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Training on 1117 organic and 3926 bandit events
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="id1">
<h3>Defining evaluation methods<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id2">
<h4>Traditional evaluation<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">leave_one_out</span><span class="p">(</span><span class="n">reco_log</span><span class="p">,</span> <span class="n">agent</span><span class="p">,</span> <span class="n">last</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">N</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">folds</span> <span class="o">=</span> <span class="mi">10</span><span class="p">):</span>
    <span class="c1"># 1. Extract all organic events</span>
    <span class="n">reco_log</span> <span class="o">=</span> <span class="n">reco_log</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">reco_log</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;organic&#39;</span><span class="p">]</span>
    
    <span class="c1"># 2. For every user sequence - randomly sample out an item</span>
    <span class="n">hits</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">folds</span><span class="p">):</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">history</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">session</span> <span class="o">=</span> <span class="n">OrganicSessions</span><span class="p">()</span>
        <span class="n">agent</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">reco_log</span><span class="o">.</span><span class="n">itertuples</span><span class="p">():</span>
            <span class="c1"># If we have a new user</span>
            <span class="k">if</span> <span class="n">row</span><span class="o">.</span><span class="n">u</span> <span class="o">!=</span> <span class="n">user_id</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">last</span><span class="p">:</span>
                    <span class="c1"># Sample out last item</span>
                    <span class="n">index</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">history</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Sample out a random item from the history</span>
                    <span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">history</span><span class="p">),</span>
                                             <span class="n">replace</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
                <span class="n">test</span>  <span class="o">=</span> <span class="n">history</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
                <span class="n">train</span> <span class="o">=</span> <span class="n">history</span><span class="p">[:</span><span class="n">index</span><span class="p">]</span> <span class="o">+</span> <span class="n">history</span><span class="p">[</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:]</span>

                <span class="c1"># 3. Recreate the user sequence without these items - Let the agent observe the incomplete sequence</span>
                <span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">train</span><span class="p">):</span>
                    <span class="n">session</span><span class="o">.</span><span class="n">next</span><span class="p">(</span><span class="n">DefaultContext</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">user_id</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>

                <span class="c1"># 4. Generate a top-N set of recommendations by letting the agent act</span>
                <span class="c1"># TODO - For now only works for N = 1</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">prob_a</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">act</span><span class="p">(</span><span class="n">Observation</span><span class="p">(</span><span class="n">DefaultContext</span><span class="p">(</span><span class="n">t</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">user_id</span><span class="p">),</span> <span class="n">session</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">False</span><span class="p">)[</span><span class="s1">&#39;ps-a&#39;</span><span class="p">]</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">prob_a</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span> <span class="o">/</span> <span class="n">P</span><span class="p">]</span> <span class="o">*</span> <span class="n">P</span>

                <span class="c1"># 5. Compute metrics checking whether the sampled test item is in the top-N</span>
                <span class="k">try</span><span class="p">:</span>
                  <span class="n">hits</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">prob_a</span><span class="p">)</span> <span class="o">==</span> <span class="nb">int</span><span class="p">(</span><span class="n">test</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                <span class="k">except</span><span class="p">:</span>
                  <span class="n">hits</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

                <span class="c1"># Reset variables</span>
                <span class="n">user_id</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">u</span>
                <span class="n">history</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">session</span> <span class="o">=</span> <span class="n">OrganicSessions</span><span class="p">()</span>
                <span class="n">agent</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>

            <span class="c1"># Save the organic interaction to the running average for the session</span>
            <span class="n">history</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">row</span><span class="o">.</span><span class="n">t</span><span class="p">,</span><span class="n">row</span><span class="o">.</span><span class="n">v</span><span class="p">))</span>
    
    <span class="c1"># Error analysis</span>
    <span class="n">mean_hits</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">hits</span><span class="p">)</span>
    <span class="n">serr_hits</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">hits</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">hits</span><span class="p">))</span>
    <span class="n">low_bound</span> <span class="o">=</span> <span class="n">mean_hits</span> <span class="o">-</span> <span class="mf">1.96</span> <span class="o">*</span> <span class="n">serr_hits</span>
    <span class="n">upp_bound</span> <span class="o">=</span> <span class="n">mean_hits</span> <span class="o">+</span> <span class="mf">1.96</span> <span class="o">*</span> <span class="n">serr_hits</span>
    
    <span class="k">return</span> <span class="n">mean_hits</span><span class="p">,</span> <span class="n">low_bound</span><span class="p">,</span> <span class="n">upp_bound</span>

<span class="k">def</span> <span class="nf">verify_agents_traditional</span><span class="p">(</span><span class="n">reco_log</span><span class="p">,</span> <span class="n">agents</span><span class="p">,</span> <span class="n">last</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">N</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">folds</span> <span class="o">=</span> <span class="mi">10</span><span class="p">):</span>
    <span class="c1"># Placeholder DataFrame for result</span>
    <span class="n">stat</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;Agent&#39;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s1">&#39;0.025&#39;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s1">&#39;0.500&#39;</span> <span class="p">:</span> <span class="p">[],</span>
        <span class="s1">&#39;0.975&#39;</span><span class="p">:</span> <span class="p">[],</span>
    <span class="p">}</span>

    <span class="c1"># For every agent</span>
    <span class="k">for</span> <span class="n">agent_id</span> <span class="ow">in</span> <span class="n">agents</span><span class="p">:</span>
        <span class="c1"># Compute HR@k</span>
        <span class="n">mean</span><span class="p">,</span> <span class="n">low</span><span class="p">,</span> <span class="n">upp</span> <span class="o">=</span> <span class="n">leave_one_out</span><span class="p">(</span><span class="n">reco_log</span><span class="p">,</span> <span class="n">agents</span><span class="p">[</span><span class="n">agent_id</span><span class="p">],</span> <span class="n">last</span> <span class="o">=</span> <span class="n">last</span><span class="p">,</span> <span class="n">N</span> <span class="o">=</span> <span class="n">N</span><span class="p">,</span> <span class="n">folds</span> <span class="o">=</span> <span class="n">folds</span><span class="p">)</span>
        <span class="n">stat</span><span class="p">[</span><span class="s1">&#39;Agent&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">agent_id</span><span class="p">)</span>
        <span class="n">stat</span><span class="p">[</span><span class="s1">&#39;0.025&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">low</span><span class="p">)</span>
        <span class="n">stat</span><span class="p">[</span><span class="s1">&#39;0.500&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mean</span><span class="p">)</span>
        <span class="n">stat</span><span class="p">[</span><span class="s1">&#39;0.975&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">upp</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">stat</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="id3">
<h4>Counterfactual evaluation<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">compute_ips_weights</span><span class="p">(</span><span class="n">agent</span><span class="p">,</span> <span class="n">reco_log</span><span class="p">):</span>
    <span class="c1"># Placeholder for return values</span>
    <span class="n">rewards</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># Labels for actions</span>
    <span class="n">t_props</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># Treatment propensities</span>
    <span class="n">l_props</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># Logging propensities</span>
    
    <span class="c1"># For every logged interaction</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">session</span> <span class="o">=</span> <span class="n">OrganicSessions</span><span class="p">()</span>
    <span class="n">agent</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">reco_log</span><span class="o">.</span><span class="n">itertuples</span><span class="p">():</span>
        <span class="c1"># If we have a new user</span>
        <span class="k">if</span> <span class="n">row</span><span class="o">.</span><span class="n">u</span> <span class="o">!=</span> <span class="n">user_id</span><span class="p">:</span>
            <span class="c1"># Reset</span>
            <span class="n">session</span> <span class="o">=</span> <span class="n">OrganicSessions</span><span class="p">()</span>
            <span class="n">agent</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
            <span class="n">user_id</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">u</span>
        
        <span class="c1"># If we have an organic event</span>
        <span class="k">if</span> <span class="n">row</span><span class="o">.</span><span class="n">z</span> <span class="o">==</span> <span class="s1">&#39;organic&#39;</span><span class="p">:</span>
            <span class="n">session</span><span class="o">.</span><span class="n">next</span><span class="p">(</span><span class="n">DefaultContext</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">u</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">v</span><span class="p">))</span>        
            
        <span class="k">else</span><span class="p">:</span>
            <span class="n">prob_a</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">act</span><span class="p">(</span><span class="n">Observation</span><span class="p">(</span><span class="n">DefaultContext</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">u</span><span class="p">),</span> <span class="n">session</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">False</span><span class="p">)[</span><span class="s1">&#39;ps-a&#39;</span><span class="p">]</span>
            <span class="n">rewards</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">c</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
              <span class="n">t_props</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prob_a</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">a</span><span class="p">)])</span>
            <span class="k">except</span><span class="p">:</span>
              <span class="n">t_props</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">l_props</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">ps</span><span class="p">)</span>
            <span class="n">session</span> <span class="o">=</span> <span class="n">OrganicSessions</span><span class="p">()</span>
    
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">rewards</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">t_props</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">l_props</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">verify_agents_counterfactual</span><span class="p">(</span><span class="n">reco_log</span><span class="p">,</span> <span class="n">agents</span><span class="p">,</span> <span class="n">cap</span> <span class="o">=</span> <span class="mi">3</span><span class="p">):</span>
    <span class="c1"># Placeholder DataFrame for results</span>
    <span class="n">IPS_stat</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;Agent&#39;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s1">&#39;0.025&#39;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s1">&#39;0.500&#39;</span> <span class="p">:</span> <span class="p">[],</span>
        <span class="s1">&#39;0.975&#39;</span><span class="p">:</span> <span class="p">[],</span>
    <span class="p">}</span>
    <span class="n">CIPS_stat</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;Agent&#39;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s1">&#39;0.025&#39;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s1">&#39;0.500&#39;</span> <span class="p">:</span> <span class="p">[],</span>
        <span class="s1">&#39;0.975&#39;</span><span class="p">:</span> <span class="p">[],</span>
    <span class="p">}</span>
    <span class="n">SNIPS_stat</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;Agent&#39;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s1">&#39;0.025&#39;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s1">&#39;0.500&#39;</span> <span class="p">:</span> <span class="p">[],</span>
        <span class="s1">&#39;0.975&#39;</span><span class="p">:</span> <span class="p">[],</span>
    <span class="p">}</span>

    <span class="c1"># For every agent</span>
    <span class="k">for</span> <span class="n">agent_id</span> <span class="ow">in</span> <span class="n">agents</span><span class="p">:</span>
        <span class="c1"># Get the rewards and propensities</span>
        <span class="n">rewards</span><span class="p">,</span> <span class="n">t_props</span><span class="p">,</span> <span class="n">l_props</span> <span class="o">=</span> <span class="n">compute_ips_weights</span><span class="p">(</span><span class="n">agents</span><span class="p">[</span><span class="n">agent_id</span><span class="p">],</span> <span class="n">reco_log</span><span class="p">)</span>
        
        <span class="c1"># Compute the sample weights - propensity ratios</span>
        <span class="n">p_ratio</span> <span class="o">=</span> <span class="n">t_props</span> <span class="o">/</span> <span class="n">l_props</span>

        <span class="c1"># Effective sample size for E_t estimate (from A. Owen)</span>
        <span class="n">n_e</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">rewards</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">p_ratio</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">p_ratio</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">n_e</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">n_e</span><span class="p">)</span> <span class="k">else</span> <span class="n">n_e</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Effective sample size for agent </span><span class="si">{}</span><span class="s2"> is </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">agent_id</span><span class="p">),</span> <span class="n">n_e</span><span class="p">))</span>
        
        <span class="c1"># Critical value from t-distribution as we have unknown variance</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="mf">.00125</span>
        <span class="n">cv</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">df</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n_e</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        
        <span class="c1">###############</span>
        <span class="c1"># VANILLA IPS #</span>
        <span class="c1">###############</span>
        <span class="c1"># Expected reward for pi_t</span>
        <span class="n">E_t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">rewards</span> <span class="o">*</span> <span class="n">p_ratio</span><span class="p">)</span>

        <span class="c1"># Variance of the estimate</span>
        <span class="n">var</span> <span class="o">=</span> <span class="p">((</span><span class="n">rewards</span> <span class="o">*</span> <span class="n">p_ratio</span> <span class="o">-</span> <span class="n">E_t</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">stddev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
        
        <span class="c1"># C.I. assuming unknown variance - use t-distribution and effective sample size</span>
        <span class="n">min_bound</span> <span class="o">=</span> <span class="n">E_t</span> <span class="o">-</span> <span class="n">cv</span> <span class="o">*</span> <span class="n">stddev</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">n_e</span><span class="p">))</span>
        <span class="n">max_bound</span> <span class="o">=</span> <span class="n">E_t</span> <span class="o">+</span> <span class="n">cv</span> <span class="o">*</span> <span class="n">stddev</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">n_e</span><span class="p">))</span>
        
        <span class="c1"># Store result</span>
        <span class="n">IPS_stat</span><span class="p">[</span><span class="s1">&#39;Agent&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">agent_id</span><span class="p">)</span>
        <span class="n">IPS_stat</span><span class="p">[</span><span class="s1">&#39;0.025&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">min_bound</span><span class="p">)</span>
        <span class="n">IPS_stat</span><span class="p">[</span><span class="s1">&#39;0.500&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">E_t</span><span class="p">)</span>
        <span class="n">IPS_stat</span><span class="p">[</span><span class="s1">&#39;0.975&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">max_bound</span><span class="p">)</span>
        
        <span class="c1">############## </span>
        <span class="c1"># CAPPED IPS #</span>
        <span class="c1">##############</span>
        <span class="c1"># Cap ratios</span>
        <span class="n">p_ratio_capped</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">p_ratio</span><span class="p">,</span> <span class="n">a_min</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">a_max</span> <span class="o">=</span> <span class="n">cap</span><span class="p">)</span>
        
        <span class="c1"># Expected reward for pi_t</span>
        <span class="n">E_t_capped</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">rewards</span> <span class="o">*</span> <span class="n">p_ratio_capped</span><span class="p">)</span>

        <span class="c1"># Variance of the estimate</span>
        <span class="n">var_capped</span> <span class="o">=</span> <span class="p">((</span><span class="n">rewards</span> <span class="o">*</span> <span class="n">p_ratio_capped</span> <span class="o">-</span> <span class="n">E_t_capped</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">stddev_capped</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">var_capped</span><span class="p">)</span>        
        
        <span class="c1"># C.I. assuming unknown variance - use t-distribution and effective sample size</span>
        <span class="n">min_bound_capped</span> <span class="o">=</span> <span class="n">E_t_capped</span> <span class="o">-</span> <span class="n">cv</span> <span class="o">*</span> <span class="n">stddev_capped</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">n_e</span><span class="p">))</span>
        <span class="n">max_bound_capped</span> <span class="o">=</span> <span class="n">E_t_capped</span> <span class="o">+</span> <span class="n">cv</span> <span class="o">*</span> <span class="n">stddev_capped</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">n_e</span><span class="p">))</span>
        
        <span class="c1"># Store result</span>
        <span class="n">CIPS_stat</span><span class="p">[</span><span class="s1">&#39;Agent&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">agent_id</span><span class="p">)</span>
        <span class="n">CIPS_stat</span><span class="p">[</span><span class="s1">&#39;0.025&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">min_bound_capped</span><span class="p">)</span>
        <span class="n">CIPS_stat</span><span class="p">[</span><span class="s1">&#39;0.500&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">E_t_capped</span><span class="p">)</span>
        <span class="n">CIPS_stat</span><span class="p">[</span><span class="s1">&#39;0.975&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">max_bound_capped</span><span class="p">)</span>
        
        <span class="c1">##############</span>
        <span class="c1"># NORMED IPS #</span>
        <span class="c1">##############</span>
        <span class="c1"># Expected reward for pi_t</span>
        <span class="n">E_t_normed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">rewards</span> <span class="o">*</span> <span class="n">p_ratio</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">p_ratio</span><span class="p">)</span>

        <span class="c1"># Variance of the estimate</span>
        <span class="n">var_normed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(((</span><span class="n">rewards</span> <span class="o">-</span> <span class="n">E_t_normed</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">p_ratio</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">p_ratio</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>    
        <span class="n">stddev_normed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">var_normed</span><span class="p">)</span>

        <span class="c1"># C.I. assuming unknown variance - use t-distribution and effective sample size</span>
        <span class="n">min_bound_normed</span> <span class="o">=</span> <span class="n">E_t_normed</span> <span class="o">-</span> <span class="n">cv</span> <span class="o">*</span> <span class="n">stddev_normed</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">n_e</span><span class="p">))</span>
        <span class="n">max_bound_normed</span> <span class="o">=</span> <span class="n">E_t_normed</span> <span class="o">+</span> <span class="n">cv</span> <span class="o">*</span> <span class="n">stddev_normed</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">n_e</span><span class="p">))</span>

        <span class="c1"># Store result</span>
        <span class="n">SNIPS_stat</span><span class="p">[</span><span class="s1">&#39;Agent&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">agent_id</span><span class="p">)</span>
        <span class="n">SNIPS_stat</span><span class="p">[</span><span class="s1">&#39;0.025&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">min_bound_normed</span><span class="p">)</span>
        <span class="n">SNIPS_stat</span><span class="p">[</span><span class="s1">&#39;0.500&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">E_t_normed</span><span class="p">)</span>
        <span class="n">SNIPS_stat</span><span class="p">[</span><span class="s1">&#39;0.975&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">max_bound_normed</span><span class="p">)</span>
        
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">IPS_stat</span><span class="p">),</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">CIPS_stat</span><span class="p">),</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">SNIPS_stat</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="id4">
<h3>Creating agents<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id5">
<h4>SVD agent<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SVDAgent</span><span class="p">(</span><span class="n">Agent</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">U</span> <span class="o">=</span> <span class="n">U</span><span class="p">,</span> <span class="n">P</span> <span class="o">=</span> <span class="n">P</span><span class="p">,</span> <span class="n">K</span> <span class="o">=</span> <span class="mi">5</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SVDAgent</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rng</span> <span class="o">=</span> <span class="n">RandomState</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">random_seed</span><span class="p">)</span>
        <span class="k">assert</span><span class="p">(</span><span class="n">P</span> <span class="o">&gt;=</span> <span class="n">K</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">K</span> <span class="o">=</span> <span class="n">K</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">R</span> <span class="o">=</span> <span class="n">csr_matrix</span><span class="p">((</span><span class="n">U</span><span class="p">,</span><span class="n">P</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">V</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">P</span><span class="p">,</span><span class="n">K</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_history</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">P</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reco_log</span><span class="p">,</span> <span class="n">U</span> <span class="o">=</span> <span class="n">U</span><span class="p">,</span> <span class="n">P</span> <span class="o">=</span> <span class="n">P</span><span class="p">):</span>
        <span class="c1"># Extract all organic user logs</span>
        <span class="n">reco_log</span> <span class="o">=</span> <span class="n">reco_log</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">reco_log</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;organic&#39;</span><span class="p">]</span>
        
        <span class="c1"># Generate ratings matrix for training, row-based for efficient row (user) retrieval</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">R</span> <span class="o">=</span> <span class="n">csr_matrix</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">reco_log</span><span class="p">)),</span>
                            <span class="p">(</span><span class="n">reco_log</span><span class="p">[</span><span class="s1">&#39;u&#39;</span><span class="p">],</span><span class="n">reco_log</span><span class="p">[</span><span class="s1">&#39;v&#39;</span><span class="p">])),</span>
                            <span class="p">(</span><span class="n">U</span><span class="p">,</span><span class="n">P</span><span class="p">))</span>

        <span class="c1"># Singular Value Decomposition</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">V</span> <span class="o">=</span> <span class="n">svds</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">K</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">observe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">observation</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">session</span> <span class="ow">in</span> <span class="n">observation</span><span class="o">.</span><span class="n">sessions</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">user_history</span><span class="p">[</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;v&#39;</span><span class="p">]]</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">act</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">observation</span><span class="p">,</span> <span class="n">reward</span><span class="p">,</span> <span class="n">done</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Act method returns an Action based on current observation and past history&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">observe</span><span class="p">(</span><span class="n">observation</span><span class="p">)</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_history</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">)</span>
        <span class="n">action</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span>
        <span class="n">prob</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span>
        <span class="n">prob</span><span class="p">[</span><span class="n">action</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="o">**</span><span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">act</span><span class="p">(</span><span class="n">observation</span><span class="p">,</span> <span class="n">reward</span><span class="p">,</span> <span class="n">done</span><span class="p">),</span>
            <span class="o">**</span><span class="p">{</span>
                <span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="n">action</span><span class="p">,</span>
                <span class="s1">&#39;ps&#39;</span><span class="p">:</span> <span class="n">prob</span><span class="p">[</span><span class="n">action</span><span class="p">],</span>
                <span class="s1">&#39;ps-a&#39;</span><span class="p">:</span> <span class="n">prob</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_history</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">P</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="id6">
<h4>Item-KNN agent<a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">itemkNNAgent</span><span class="p">(</span><span class="n">Agent</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">U</span> <span class="o">=</span> <span class="n">U</span><span class="p">,</span> <span class="n">P</span> <span class="o">=</span> <span class="n">P</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="n">greedy</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">itemkNNAgent</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rng</span> <span class="o">=</span> <span class="n">RandomState</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">random_seed</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">greedy</span> <span class="o">=</span> <span class="n">greedy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="n">alpha</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Rt</span> <span class="o">=</span> <span class="n">csr_matrix</span><span class="p">((</span><span class="n">P</span><span class="p">,</span><span class="n">U</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_history</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">P</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">S</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">P</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reco_log</span><span class="p">,</span> <span class="n">U</span> <span class="o">=</span> <span class="n">U</span><span class="p">,</span> <span class="n">P</span> <span class="o">=</span> <span class="n">P</span><span class="p">):</span>
        <span class="c1"># Extract all organic user logs</span>
        <span class="n">reco_log</span> <span class="o">=</span> <span class="n">reco_log</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">reco_log</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;organic&#39;</span><span class="p">]</span>
        
        <span class="c1"># Generate ratings matrix for training, row-based for efficient row (user) retrieval</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">R_t</span> <span class="o">=</span> <span class="n">csr_matrix</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">reco_log</span><span class="p">)),</span>
                              <span class="p">(</span><span class="n">reco_log</span><span class="p">[</span><span class="s1">&#39;v&#39;</span><span class="p">],</span><span class="n">reco_log</span><span class="p">[</span><span class="s1">&#39;u&#39;</span><span class="p">])),</span>
                              <span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="n">U</span><span class="p">))</span>

        <span class="c1"># Set up nearest neighbours module</span>
        <span class="n">nn</span> <span class="o">=</span> <span class="n">NearestNeighbors</span><span class="p">(</span><span class="n">n_neighbors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">,</span>
                              <span class="n">metric</span> <span class="o">=</span> <span class="s1">&#39;cosine&#39;</span><span class="p">)</span>

        <span class="c1"># Initialise placeholder for distances and indices</span>
        <span class="n">distances</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">indices</span>   <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Dirty fix for multiprocessing backend being unable to pickle large objects</span>
        <span class="n">nn</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R_t</span><span class="p">)</span>
        <span class="n">distances</span><span class="p">,</span> <span class="n">indices</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">kneighbors</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R_t</span><span class="p">,</span> <span class="n">return_distance</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Precompute similarity matrix S</span>
        <span class="n">data</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">chain</span><span class="o">.</span><span class="n">from_iterable</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">distances</span><span class="p">))</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">chain</span><span class="o">.</span><span class="n">from_iterable</span><span class="p">([</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">k</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">P</span><span class="p">)))</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">chain</span><span class="o">.</span><span class="n">from_iterable</span><span class="p">(</span><span class="n">indices</span><span class="p">))</span>
        
        <span class="c1"># (P,P)-matrix with cosine similarities between items</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">S</span> <span class="o">=</span> <span class="n">csr_matrix</span><span class="p">((</span><span class="n">data</span><span class="p">,(</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">)),</span> <span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="n">P</span><span class="p">))</span><span class="o">.</span><span class="n">todense</span><span class="p">()</span>
        
    <span class="k">def</span> <span class="nf">observe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">observation</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">session</span> <span class="ow">in</span> <span class="n">observation</span><span class="o">.</span><span class="n">sessions</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">user_history</span><span class="p">[</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;v&#39;</span><span class="p">]]</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">act</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">observation</span><span class="p">,</span> <span class="n">reward</span><span class="p">,</span> <span class="n">done</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Act method returns an Action based on current observation and past history&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">observe</span><span class="p">(</span><span class="n">observation</span><span class="p">)</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_history</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">S</span><span class="p">)</span><span class="o">.</span><span class="n">A1</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">greedy</span><span class="p">:</span>
            <span class="n">action</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span>
            <span class="n">prob</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span>
            <span class="n">prob</span><span class="p">[</span><span class="n">action</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">scores</span> <span class="o">**=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span>
            <span class="n">prob</span> <span class="o">=</span> <span class="n">scores</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span>
            <span class="n">action</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">S</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">p</span> <span class="o">=</span> <span class="n">prob</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="o">**</span><span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">act</span><span class="p">(</span><span class="n">observation</span><span class="p">,</span> <span class="n">reward</span><span class="p">,</span> <span class="n">done</span><span class="p">),</span>
            <span class="o">**</span><span class="p">{</span>
                <span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="n">action</span><span class="p">,</span>
                <span class="s1">&#39;ps&#39;</span><span class="p">:</span> <span class="n">prob</span><span class="p">[</span><span class="n">action</span><span class="p">],</span>
                <span class="s1">&#39;ps-a&#39;</span><span class="p">:</span> <span class="n">prob</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_history</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">P</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="id7">
<h4>User-KNN agent<a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">userkNNAgent</span><span class="p">(</span><span class="n">Agent</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">U</span> <span class="o">=</span> <span class="n">U</span><span class="p">,</span> <span class="n">P</span> <span class="o">=</span> <span class="n">P</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="n">greedy</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">userkNNAgent</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rng</span> <span class="o">=</span> <span class="n">RandomState</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">random_seed</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">greedy</span> <span class="o">=</span> <span class="n">greedy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="n">alpha</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">U</span> <span class="o">=</span> <span class="n">U</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">P</span> <span class="o">=</span> <span class="n">P</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">R</span> <span class="o">=</span> <span class="n">csr_matrix</span><span class="p">((</span><span class="n">U</span><span class="p">,</span><span class="n">P</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_history</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">P</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nn</span> <span class="o">=</span> <span class="n">NearestNeighbors</span><span class="p">(</span><span class="n">n_neighbors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">,</span> <span class="n">metric</span> <span class="o">=</span> <span class="s1">&#39;cosine&#39;</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reco_log</span><span class="p">,</span> <span class="n">U</span> <span class="o">=</span> <span class="n">U</span><span class="p">,</span> <span class="n">P</span> <span class="o">=</span> <span class="n">P</span><span class="p">):</span>
        <span class="c1"># Extract all organic user logs</span>
        <span class="n">reco_log</span> <span class="o">=</span> <span class="n">reco_log</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">reco_log</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;organic&#39;</span><span class="p">]</span>
        
        <span class="c1"># Generate ratings matrix for training, row-based for efficient row (user) retrieval</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">R</span> <span class="o">=</span> <span class="n">csr_matrix</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">reco_log</span><span class="p">)),</span>
                            <span class="p">(</span><span class="n">reco_log</span><span class="p">[</span><span class="s1">&#39;u&#39;</span><span class="p">],</span><span class="n">reco_log</span><span class="p">[</span><span class="s1">&#39;v&#39;</span><span class="p">])),</span>
                            <span class="p">(</span><span class="n">U</span><span class="p">,</span><span class="n">P</span><span class="p">))</span>

        <span class="c1"># Fit nearest neighbours</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">observe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">observation</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">session</span> <span class="ow">in</span> <span class="n">observation</span><span class="o">.</span><span class="n">sessions</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">user_history</span><span class="p">[</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;v&#39;</span><span class="p">]]</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">act</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">observation</span><span class="p">,</span> <span class="n">reward</span><span class="p">,</span> <span class="n">done</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Act method returns an Action based on current observation and past history&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">observe</span><span class="p">(</span><span class="n">observation</span><span class="p">)</span>
        
        <span class="c1"># Get neighbouring users based on user history</span>
        <span class="n">distances</span><span class="p">,</span> <span class="n">indices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">kneighbors</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_history</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="o">.</span><span class="n">reduce</span><span class="p">([</span><span class="n">dist</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">[</span><span class="n">idx</span><span class="p">,:]</span> <span class="k">for</span> <span class="n">dist</span><span class="p">,</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">distances</span><span class="p">,</span><span class="n">indices</span><span class="p">)])</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">greedy</span><span class="p">:</span>
            <span class="n">action</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span>
            <span class="n">prob</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span>
            <span class="n">prob</span><span class="p">[</span><span class="n">action</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">scores</span> <span class="o">**=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span>
            <span class="n">prob</span> <span class="o">=</span> <span class="n">scores</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span>
            <span class="n">action</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">P</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="n">prob</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="o">**</span><span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">act</span><span class="p">(</span><span class="n">observation</span><span class="p">,</span> <span class="n">reward</span><span class="p">,</span> <span class="n">done</span><span class="p">),</span>
            <span class="o">**</span><span class="p">{</span>
                <span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="n">action</span><span class="p">,</span>
                <span class="s1">&#39;ps&#39;</span><span class="p">:</span> <span class="n">prob</span><span class="p">[</span><span class="n">action</span><span class="p">],</span>
                <span class="s1">&#39;ps-a&#39;</span><span class="p">:</span> <span class="n">prob</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_history</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">P</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="id8">
<h4>Agent initializations<a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># SVD Agent</span>
<span class="n">SVD_agent</span> <span class="o">=</span> <span class="n">SVDAgent</span><span class="p">(</span><span class="n">Configuration</span><span class="p">(</span><span class="n">env_1_args</span><span class="p">),</span> <span class="n">U</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>

<span class="c1"># item-kNN Agent</span>
<span class="n">itemkNN_agent</span> <span class="o">=</span> <span class="n">itemkNNAgent</span><span class="p">(</span><span class="n">Configuration</span><span class="p">(</span><span class="n">env_1_args</span><span class="p">),</span> <span class="n">U</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="n">greedy</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

<span class="c1"># user-kNN Agent</span>
<span class="n">userkNN_agent</span> <span class="o">=</span> <span class="n">userkNNAgent</span><span class="p">(</span><span class="n">Configuration</span><span class="p">(</span><span class="n">env_1_args</span><span class="p">),</span> <span class="n">U</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="n">greedy</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

<span class="c1"># Generalised Popularity agent</span>
<span class="n">GPOP_agent</span> <span class="o">=</span> <span class="n">OrganicCount</span><span class="p">(</span><span class="n">Configuration</span><span class="p">({</span>
    <span class="o">**</span><span class="n">env_1_args</span><span class="p">,</span>
    <span class="s1">&#39;select_randomly&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">}))</span>

<span class="c1"># Generalised Popularity agent</span>
<span class="n">GPOP_agent_greedy</span> <span class="o">=</span> <span class="n">OrganicCount</span><span class="p">(</span><span class="n">Configuration</span><span class="p">({</span>
    <span class="o">**</span><span class="n">env_1_args</span><span class="p">,</span>
    <span class="s1">&#39;select_randomly&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">}))</span>

<span class="c1"># Peronalised Popularity agent</span>
<span class="n">PPOP_agent</span> <span class="o">=</span> <span class="n">OrganicUserEventCounterAgent</span><span class="p">(</span><span class="n">Configuration</span><span class="p">({</span>
    <span class="o">**</span><span class="n">organic_user_count_args</span><span class="p">,</span>
    <span class="o">**</span><span class="n">env_1_args</span><span class="p">,</span>
    <span class="s1">&#39;select_randomly&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">}))</span>

<span class="c1"># Peronalised Popularity agent</span>
<span class="n">PPOP_agent_greedy</span> <span class="o">=</span> <span class="n">OrganicUserEventCounterAgent</span><span class="p">(</span><span class="n">Configuration</span><span class="p">({</span>
    <span class="o">**</span><span class="n">organic_user_count_args</span><span class="p">,</span>
    <span class="o">**</span><span class="n">env_1_args</span><span class="p">,</span>
    <span class="s1">&#39;select_randomly&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">}))</span>

<span class="c1"># Random Agent</span>
<span class="n">random_args</span><span class="p">[</span><span class="s1">&#39;num_products&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">P</span>
<span class="n">RAND_agent</span> <span class="o">=</span> <span class="n">RandomAgent</span><span class="p">(</span><span class="n">Configuration</span><span class="p">({</span><span class="o">**</span><span class="n">env_1_args</span><span class="p">,</span> <span class="o">**</span><span class="n">random_args</span><span class="p">,}))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SVD_agent</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">reco_log</span><span class="p">)</span>
<span class="n">itemkNN_agent</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">reco_log</span><span class="p">)</span>
<span class="n">userkNN_agent</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">reco_log</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="id9">
<h3>Offline evaluation<a class="headerlink" href="#id9" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id10">
<h4>Generating test logs<a class="headerlink" href="#id10" title="Permalink to this headline">¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">time</span>
<span class="c1"># Placeholder for agents</span>
<span class="n">agents</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;    Random&#39;</span><span class="p">:</span> <span class="n">RAND_agent</span><span class="p">,</span>
    <span class="s1">&#39;   Popular&#39;</span><span class="p">:</span> <span class="n">GPOP_agent_greedy</span><span class="p">,</span>
    <span class="s1">&#39;   User-pop&#39;</span><span class="p">:</span> <span class="n">PPOP_agent</span><span class="p">,</span>
    <span class="s1">&#39;  SVD&#39;</span><span class="p">:</span>  <span class="n">SVD_agent</span><span class="p">,</span>
    <span class="s1">&#39; User-kNN&#39;</span><span class="p">:</span> <span class="n">userkNN_agent</span><span class="p">,</span>
    <span class="s1">&#39;Item-kNN&#39;</span><span class="p">:</span> <span class="n">itemkNN_agent</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">agent_ids</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">agents</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span><span class="c1">#[&#39;SVD&#39;,&#39;GPOP&#39;,&#39;PPOP&#39;,&#39;RAND&#39;]</span>
<span class="c1"># Generate new logs, to be used for offline testing</span>
<span class="n">n_test_users</span> <span class="o">=</span> <span class="mi">50</span> <span class="c1"># U</span>
<span class="n">test_log</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">generate_logs</span><span class="p">(</span><span class="n">n_test_users</span><span class="p">)</span>
<span class="n">n_events</span> <span class="o">=</span> <span class="n">test_log</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">n_organic</span> <span class="o">=</span> <span class="n">test_log</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">test_log</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;organic&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Testing on </span><span class="si">{0}</span><span class="s1"> organic and </span><span class="si">{1}</span><span class="s1"> bandit events&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n_organic</span><span class="p">,</span> <span class="n">n_events</span> <span class="o">-</span> <span class="n">n_organic</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Organic Users: 0it [00:00, ?it/s]
Users: 100%|██████████| 50/50 [00:01&lt;00:00, 39.77it/s]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Testing on 1033 organic and 4264 bandit events
CPU times: user 1.29 s, sys: 75.4 ms, total: 1.36 s
Wall time: 1.3 s
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="id11">
<h4>(Util) helper function to plot barchart<a class="headerlink" href="#id11" title="Permalink to this headline">¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">plot_barchart</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">xlabel</span><span class="p">,</span>  <span class="n">col</span> <span class="o">=</span> <span class="s1">&#39;tab:red&#39;</span><span class="p">,</span> <span class="n">figname</span> <span class="o">=</span> <span class="s1">&#39;fig.eps&#39;</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">12</span><span class="p">):</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="n">size</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="n">fontsize</span><span class="p">)</span>
    <span class="n">n_agents</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
    <span class="n">yticks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_agents</span><span class="p">)</span>
    <span class="n">mean</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;0.500&#39;</span><span class="p">]</span>
    <span class="n">lower</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;0.500&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;0.025&#39;</span><span class="p">]</span>
    <span class="n">upper</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;0.975&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;0.500&#39;</span><span class="p">]</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="n">yticks</span><span class="p">,</span>
             <span class="n">mean</span><span class="p">,</span>
             <span class="n">height</span> <span class="o">=</span> <span class="mf">.25</span><span class="p">,</span>
             <span class="n">xerr</span>  <span class="o">=</span> <span class="p">(</span><span class="n">lower</span><span class="p">,</span> <span class="n">upper</span><span class="p">),</span>
             <span class="n">align</span> <span class="o">=</span> <span class="s1">&#39;center&#39;</span><span class="p">,</span>
             <span class="n">color</span> <span class="o">=</span> <span class="n">col</span><span class="p">,)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="n">yticks</span><span class="p">,</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;Agent&#39;</span><span class="p">],</span> <span class="n">size</span> <span class="o">=</span> <span class="n">fontsize</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">size</span> <span class="o">=</span> <span class="n">fontsize</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="n">xlabel</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="n">fontsize</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mf">.0</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">FormatStrFormatter</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%.2f</span><span class="s1">&#39;</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">figname</span><span class="p">,</span> <span class="n">bbox_inches</span> <span class="o">=</span> <span class="s1">&#39;tight&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="id12">
<h4>Leave-one-out evaluation<a class="headerlink" href="#id12" title="Permalink to this headline">¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">time</span>
<span class="n">result_LOO</span> <span class="o">=</span> <span class="n">verify_agents_traditional</span><span class="p">(</span><span class="n">test_log</span><span class="p">,</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">agents</span><span class="p">))</span>
<span class="n">display</span><span class="p">(</span><span class="n">result_LOO</span><span class="p">)</span>
<span class="n">plot_barchart</span><span class="p">(</span><span class="n">result_LOO</span><span class="p">,</span> <span class="s1">&#39;Evaluate on Organic Feedback&#39;</span><span class="p">,</span> <span class="s1">&#39;HR@1&#39;</span><span class="p">,</span> <span class="s1">&#39;tab:red&#39;</span><span class="p">,</span> <span class="s1">&#39;traditional_eval.eps&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/usr/local/lib/python3.7/dist-packages/recogym/agents/organic_user_count.py:51: RuntimeWarning: invalid value encountered in true_divide
  action_proba = features / np.sum(features)
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Agent</th>
      <th>0.025</th>
      <th>0.500</th>
      <th>0.975</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Random</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Popular</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>2</th>
      <td>User-pop</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>3</th>
      <td>SVD</td>
      <td>0.273181</td>
      <td>0.314286</td>
      <td>0.355390</td>
    </tr>
    <tr>
      <th>4</th>
      <td>User-kNN</td>
      <td>0.080663</td>
      <td>0.108163</td>
      <td>0.135664</td>
    </tr>
    <tr>
      <th>5</th>
      <td>Item-kNN</td>
      <td>0.261387</td>
      <td>0.302041</td>
      <td>0.342695</td>
    </tr>
  </tbody>
</table>
</div></div><img alt="../_images/T057885_Offline_Replayer_Evaluation_69_2.png" src="../_images/T057885_Offline_Replayer_Evaluation_69_2.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>CPU times: user 1.5 s, sys: 61.4 ms, total: 1.56 s
Wall time: 1.53 s
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="id13">
<h4>IPS Estimators<a class="headerlink" href="#id13" title="Permalink to this headline">¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Generate new logs, to be used for offline testing</span>
<span class="n">test_log_ppop</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">generate_logs</span><span class="p">(</span><span class="n">n_test_users</span><span class="p">,</span> <span class="n">agent</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">PPOP_agent</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Organic Users: 0it [00:00, ?it/s]
Users: 100%|██████████| 50/50 [00:01&lt;00:00, 27.14it/s]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">test_log_ppop</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>t</th>
      <th>u</th>
      <th>z</th>
      <th>v</th>
      <th>a</th>
      <th>c</th>
      <th>ps</th>
      <th>ps-a</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0.0</td>
      <td>0</td>
      <td>organic</td>
      <td>7</td>
      <td>&lt;NA&gt;</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>None</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1.0</td>
      <td>0</td>
      <td>organic</td>
      <td>9</td>
      <td>&lt;NA&gt;</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>None</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2.0</td>
      <td>0</td>
      <td>organic</td>
      <td>7</td>
      <td>&lt;NA&gt;</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>None</td>
    </tr>
    <tr>
      <th>3</th>
      <td>3.0</td>
      <td>0</td>
      <td>organic</td>
      <td>20</td>
      <td>&lt;NA&gt;</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>None</td>
    </tr>
    <tr>
      <th>4</th>
      <td>4.0</td>
      <td>0</td>
      <td>bandit</td>
      <td>&lt;NA&gt;</td>
      <td>20</td>
      <td>0.0</td>
      <td>0.25</td>
      <td>()</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">time</span>
<span class="n">cap</span> <span class="o">=</span> <span class="mi">15</span>
<span class="n">result_IPS</span><span class="p">,</span> <span class="n">result_CIPS</span><span class="p">,</span> <span class="n">result_SNIPS</span> <span class="o">=</span> <span class="n">verify_agents_counterfactual</span><span class="p">(</span><span class="n">test_log_ppop</span><span class="p">,</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">agents</span><span class="p">),</span> <span class="n">cap</span> <span class="o">=</span> <span class="n">cap</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">result_IPS</span><span class="p">)</span>
<span class="n">plot_barchart</span><span class="p">(</span><span class="n">result_IPS</span><span class="p">,</span> <span class="s1">&#39;IPS&#39;</span><span class="p">,</span> <span class="s1">&#39;CTR&#39;</span><span class="p">,</span> <span class="s1">&#39;tab:blue&#39;</span><span class="p">,</span> <span class="s1">&#39;bandit_eval_noclip.eps&#39;</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">result_CIPS</span><span class="p">)</span>
<span class="n">plot_barchart</span><span class="p">(</span><span class="n">result_CIPS</span><span class="p">,</span> <span class="s1">&#39;Clipped IPS&#39;</span><span class="p">,</span> <span class="s1">&#39;CTR&#39;</span><span class="p">,</span> <span class="s1">&#39;tab:blue&#39;</span><span class="p">,</span> <span class="s1">&#39;bandit_eval_clip</span><span class="si">{0}</span><span class="s1">.eps&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cap</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/usr/local/lib/python3.7/dist-packages/ipykernel_launcher.py:65: RuntimeWarning: invalid value encountered in double_scalars
/usr/local/lib/python3.7/dist-packages/ipykernel_launcher.py:120: RuntimeWarning: invalid value encountered in double_scalars
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Effective sample size for agent     Random is 0
Effective sample size for agent    Popular is 0
Effective sample size for agent    User-pop is 0
Effective sample size for agent   SVD is 1120.7440758663975
Effective sample size for agent  User-kNN is 298.0127276763118
Effective sample size for agent Item-kNN is 889.7428242947079
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Agent</th>
      <th>0.025</th>
      <th>0.500</th>
      <th>0.975</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Random</td>
      <td>NaN</td>
      <td>0.000000</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Popular</td>
      <td>NaN</td>
      <td>0.000000</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2</th>
      <td>User-pop</td>
      <td>NaN</td>
      <td>0.000000</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>3</th>
      <td>SVD</td>
      <td>-0.010231</td>
      <td>0.014218</td>
      <td>0.038666</td>
    </tr>
    <tr>
      <th>4</th>
      <td>User-kNN</td>
      <td>-0.024978</td>
      <td>0.005388</td>
      <td>0.035754</td>
    </tr>
    <tr>
      <th>5</th>
      <td>Item-kNN</td>
      <td>-0.011787</td>
      <td>0.011767</td>
      <td>0.035322</td>
    </tr>
  </tbody>
</table>
</div></div><img alt="../_images/T057885_Offline_Replayer_Evaluation_73_3.png" src="../_images/T057885_Offline_Replayer_Evaluation_73_3.png" />
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Agent</th>
      <th>0.025</th>
      <th>0.500</th>
      <th>0.975</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Random</td>
      <td>NaN</td>
      <td>0.000000</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Popular</td>
      <td>NaN</td>
      <td>0.000000</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2</th>
      <td>User-pop</td>
      <td>NaN</td>
      <td>0.000000</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>3</th>
      <td>SVD</td>
      <td>-0.010231</td>
      <td>0.014218</td>
      <td>0.038666</td>
    </tr>
    <tr>
      <th>4</th>
      <td>User-kNN</td>
      <td>-0.024978</td>
      <td>0.005388</td>
      <td>0.035754</td>
    </tr>
    <tr>
      <th>5</th>
      <td>Item-kNN</td>
      <td>-0.011787</td>
      <td>0.011767</td>
      <td>0.035322</td>
    </tr>
  </tbody>
</table>
</div></div><img alt="../_images/T057885_Offline_Replayer_Evaluation_73_5.png" src="../_images/T057885_Offline_Replayer_Evaluation_73_5.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>CPU times: user 5.97 s, sys: 120 ms, total: 6.09 s
Wall time: 6.03 s
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="id14">
<h4>A/B tests<a class="headerlink" href="#id14" title="Permalink to this headline">¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">n_test_users</span> <span class="o">=</span> <span class="mi">50</span> <span class="c1"># U</span>

<span class="n">agents</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;    Random&#39;</span><span class="p">:</span> <span class="n">RAND_agent</span><span class="p">,</span>
    <span class="s1">&#39;   Popular&#39;</span><span class="p">:</span> <span class="n">GPOP_agent_greedy</span><span class="p">,</span>
    <span class="s1">&#39;   User-pop&#39;</span><span class="p">:</span> <span class="n">PPOP_agent</span><span class="p">,</span>
    <span class="s1">&#39;  SVD&#39;</span><span class="p">:</span>  <span class="n">SVD_agent</span><span class="p">,</span>
    <span class="s1">&#39; User-kNN&#39;</span><span class="p">:</span> <span class="n">userkNN_agent</span><span class="p">,</span>
    <span class="s1">&#39;Item-kNN&#39;</span><span class="p">:</span> <span class="n">itemkNN_agent</span><span class="p">,</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">time</span>
<span class="n">result_AB</span> <span class="o">=</span> <span class="n">verify_agents</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">n_test_users</span><span class="p">,</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">agents</span><span class="p">))</span>
<span class="n">display</span><span class="p">(</span><span class="n">result_AB</span><span class="p">)</span>
<span class="n">plot_barchart</span><span class="p">(</span><span class="n">result_AB</span><span class="p">,</span> <span class="s1">&#39;A/B-test&#39;</span><span class="p">,</span> <span class="s1">&#39;CTR&#39;</span><span class="p">,</span> <span class="s1">&#39;tab:green&#39;</span><span class="p">,</span> <span class="s1">&#39;ABtest_eval.eps&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Organic Users: 0it [00:00, ?it/s]
Users: 100%|██████████| 50/50 [00:01&lt;00:00, 36.23it/s]
Organic Users: 0it [00:00, ?it/s]
Users: 100%|██████████| 50/50 [00:01&lt;00:00, 41.71it/s]
Organic Users: 0it [00:00, ?it/s]
Users: 100%|██████████| 50/50 [00:01&lt;00:00, 28.04it/s]
Organic Users: 0it [00:00, ?it/s]
Users: 100%|██████████| 50/50 [00:01&lt;00:00, 35.95it/s]
Organic Users: 0it [00:00, ?it/s]
Users: 100%|██████████| 50/50 [00:06&lt;00:00,  7.86it/s]
Organic Users: 0it [00:00, ?it/s]
Users: 100%|██████████| 50/50 [00:01&lt;00:00, 33.91it/s]
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Agent</th>
      <th>0.025</th>
      <th>0.500</th>
      <th>0.975</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Random</td>
      <td>0.007624</td>
      <td>0.010324</td>
      <td>0.013590</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Popular</td>
      <td>0.008203</td>
      <td>0.010997</td>
      <td>0.014357</td>
    </tr>
    <tr>
      <th>2</th>
      <td>User-pop</td>
      <td>0.011879</td>
      <td>0.015227</td>
      <td>0.019140</td>
    </tr>
    <tr>
      <th>3</th>
      <td>SVD</td>
      <td>0.012572</td>
      <td>0.015994</td>
      <td>0.019976</td>
    </tr>
    <tr>
      <th>4</th>
      <td>User-kNN</td>
      <td>0.011999</td>
      <td>0.015350</td>
      <td>0.019263</td>
    </tr>
    <tr>
      <th>5</th>
      <td>Item-kNN</td>
      <td>0.012174</td>
      <td>0.015545</td>
      <td>0.019477</td>
    </tr>
  </tbody>
</table>
</div></div><img alt="../_images/T057885_Offline_Replayer_Evaluation_76_2.png" src="../_images/T057885_Offline_Replayer_Evaluation_76_2.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>CPU times: user 14 s, sys: 445 ms, total: 14.4 s
Wall time: 14.1 s
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">combine_barchart</span><span class="p">(</span><span class="n">resultAB</span><span class="p">,</span> <span class="n">resultCIPS</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">xlabel</span><span class="p">,</span>  <span class="n">figname</span> <span class="o">=</span> <span class="s1">&#39;fig.eps&#39;</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">8</span><span class="p">),</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">12</span><span class="p">):</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="n">size</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="n">fontsize</span><span class="p">)</span>
    <span class="n">n_agents</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">resultAB</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">colour</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([(</span><span class="s1">&#39;A/B-test&#39;</span><span class="p">,</span> <span class="s1">&#39;tab:green&#39;</span><span class="p">,</span> <span class="n">result_AB</span><span class="p">),(</span><span class="s1">&#39;CIPS&#39;</span><span class="p">,</span> <span class="s1">&#39;tab:blue&#39;</span><span class="p">,</span> <span class="n">result_CIPS</span><span class="p">)]):</span>
        <span class="n">mean</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;0.500&#39;</span><span class="p">]</span>
        <span class="n">lower</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;0.500&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;0.025&#39;</span><span class="p">]</span>
        <span class="n">upper</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;0.975&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;0.500&#39;</span><span class="p">]</span>
        <span class="n">height</span> <span class="o">=</span> <span class="mf">.25</span>
        <span class="n">yticks</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="n">height</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_agents</span><span class="p">)]</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="n">yticks</span><span class="p">,</span>
                 <span class="n">mean</span><span class="p">,</span>
                 <span class="n">height</span> <span class="o">=</span> <span class="n">height</span><span class="p">,</span>
                 <span class="n">xerr</span>  <span class="o">=</span> <span class="p">(</span><span class="n">lower</span><span class="p">,</span> <span class="n">upper</span><span class="p">),</span>
                 <span class="n">align</span> <span class="o">=</span> <span class="s1">&#39;edge&#39;</span><span class="p">,</span>
                 <span class="n">label</span> <span class="o">=</span> <span class="n">name</span><span class="p">,</span>
                 <span class="n">color</span> <span class="o">=</span> <span class="n">colour</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="n">yticks</span><span class="p">,</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;Agent&#39;</span><span class="p">],</span> <span class="n">size</span> <span class="o">=</span> <span class="n">fontsize</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">size</span> <span class="o">=</span> <span class="n">fontsize</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="n">xlabel</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="n">fontsize</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span> <span class="o">=</span> <span class="s1">&#39;lower right&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mf">.0</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">FormatStrFormatter</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%.3f</span><span class="s1">&#39;</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">figname</span><span class="p">,</span> <span class="n">bbox_inches</span> <span class="o">=</span> <span class="s1">&#39;tight&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="n">combine_barchart</span><span class="p">(</span><span class="n">result_AB</span><span class="p">,</span> <span class="n">result_CIPS</span><span class="p">,</span> <span class="s1">&#39;Evaluate on Bandit Feedback&#39;</span><span class="p">,</span> <span class="s1">&#39;CTR&#39;</span><span class="p">,</span> <span class="s1">&#39;ABtest_CIPS.eps&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>The PostScript backend does not support transparency; partially transparent artists will be rendered opaque.
The PostScript backend does not support transparency; partially transparent artists will be rendered opaque.
</pre></div>
</div>
<img alt="../_images/T057885_Offline_Replayer_Evaluation_77_1.png" src="../_images/T057885_Offline_Replayer_Evaluation_77_1.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">plot_barchart</span><span class="p">(</span><span class="n">result_LOO</span><span class="p">,</span> <span class="s1">&#39;Evaluate on Organic Feedback&#39;</span><span class="p">,</span> <span class="s1">&#39;HR@1&#39;</span><span class="p">,</span> <span class="s1">&#39;tab:red&#39;</span><span class="p">,</span> <span class="s1">&#39;traditional_eval.eps&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/T057885_Offline_Replayer_Evaluation_78_0.png" src="../_images/T057885_Offline_Replayer_Evaluation_78_0.png" />
</div>
</div>
</div>
</div>
</div>
<div class="section" id="amazon-electronics-dataset">
<h2>Amazon electronics dataset<a class="headerlink" href="#amazon-electronics-dataset" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><p>Running bandit models on amazon electronics ratings dataset for offline evaluation</p>
</div></blockquote>
<div class="section" id="libraries">
<h3>Libraries<a class="headerlink" href="#libraries" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="o">%</span><span class="n">matplotlib</span> <span class="n">inline</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="data">
<h3>Data<a class="headerlink" href="#data" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>!pip install -q -U kaggle
!pip install --upgrade --force-reinstall --no-deps kaggle
!mkdir ~/.kaggle
!cp /content/drive/MyDrive/kaggle.json ~/.kaggle/
!chmod 600 ~/.kaggle/kaggle.json

!kaggle datasets download -d saurav9786/amazon-product-reviews
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>!unzip amazon-product-reviews.zip
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Archive:  amazon-product-reviews.zip
  inflating: ratings_Electronics (1).csv  
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="utils">
<h3>Utils<a class="headerlink" href="#utils" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># getting the current system time</span>
<span class="n">current_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">__%H.%M&quot;</span><span class="p">)</span>

<span class="c1"># run folder which will be unique always</span>
<span class="n">run_folder</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>

<span class="c1"># temprary folder location to export the results</span>
<span class="n">temp_folder</span> <span class="o">=</span> <span class="s2">&quot;./output/&quot;</span>

<span class="c1"># target folder to export all the result</span>
<span class="n">target_dir</span> <span class="o">=</span> <span class="n">temp_folder</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">run_folder</span>

<span class="c1"># checking if the temp folder exists. Create one if not</span>
<span class="n">check_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">target_dir</span><span class="p">)</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">check_folder</span><span class="p">:</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">target_dir</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;created folder : &quot;</span><span class="p">,</span> <span class="n">target_dir</span><span class="p">)</span>

<span class="c1"># latency dictionary to hold execution time</span>
<span class="n">latency</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

<span class="c1"># removing any existing log files if present</span>
<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">target_dir</span> <span class="o">+</span> <span class="s1">&#39;/main.log&#39;</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">target_dir</span><span class="o">+</span> <span class="s1">&#39;/main.log&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>created folder :  ./output//2021-06-16 21:35:53.937354
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_loggers</span><span class="p">(</span><span class="n">temp_path</span><span class="p">):</span>
  <span class="c1"># name the logger as HPC-AI skunkworks</span>
  <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;Multi-Arm-Bandit&quot;</span><span class="p">)</span>
  <span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
  <span class="c1"># file where the custom logs needs to be handled</span>
  <span class="n">f_hand</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">FileHandler</span><span class="p">(</span><span class="n">temp_path</span> <span class="o">+</span> <span class="s1">&#39;/.log&#39;</span><span class="p">)</span>
  <span class="n">f_hand</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>  <span class="c1"># level to set for logging the errors</span>
  <span class="n">f_format</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1"> : </span><span class="si">%(levelname)s</span><span class="s1"> : </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">,</span>
                                <span class="n">datefmt</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">-%b-%y %H:%M:%S&#39;</span><span class="p">)</span>
  <span class="c1"># format in which the logs needs to be written</span>
  <span class="n">f_hand</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">f_format</span><span class="p">)</span>  <span class="c1"># setting the format of the logs</span>
  <span class="c1"># setting the logging handler with the above formatter specification</span>
  <span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">f_hand</span><span class="p">)</span>

  <span class="n">stdout_handler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">()</span>
  <span class="n">stdout_handler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">f_format</span><span class="p">)</span>
  <span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">stdout_handler</span><span class="p">)</span>

  <span class="k">return</span> <span class="n">logger</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># get custom logger</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">get_loggers</span><span class="p">(</span><span class="n">target_dir</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">export_to_json</span><span class="p">(</span><span class="n">dictionary</span><span class="p">,</span> <span class="n">file_name</span><span class="p">):</span>
  <span class="k">try</span><span class="p">:</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">json_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">dictionary</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">json_data</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">file</span><span class="p">)</span>
    <span class="c1"># updating into json</span>
    <span class="n">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">stop</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">latency</span><span class="p">[</span><span class="s1">&#39;export_to_json_&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stop</span> <span class="o">-</span> <span class="n">start</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Data exported to JSON successfully!&#39;</span><span class="p">)</span>
  <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="defining-agents">
<h3>Defining agents<a class="headerlink" href="#defining-agents" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="sd">&#39;&#39;&#39;</span>

<span class="sd">Author - Abhishek Maheshwarappa and Jiaxin Tong</span>

<span class="sd">This script is used for simulating AB testing simulator</span>

<span class="sd">&#39;&#39;&#39;</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>


<span class="k">class</span> <span class="nc">ABTestReplayer</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    A class to provide functionality for simulating the method on an A/B test.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_visits</span><span class="p">,</span> <span class="n">n_test_visits</span><span class="p">,</span> <span class="n">reward_history</span><span class="p">,</span> <span class="n">item_col_name</span><span class="p">,</span> <span class="n">visitor_col_name</span><span class="p">,</span> <span class="n">reward_col_name</span><span class="p">,</span> <span class="n">n_iterations</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">reward_history</span> <span class="o">=</span> <span class="n">reward_history</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">item_col_name</span> <span class="o">=</span> <span class="n">item_col_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visitor_col_name</span> <span class="o">=</span> <span class="n">visitor_col_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reward_col_name</span> <span class="o">=</span> <span class="n">reward_col_name</span>

        <span class="c1"># number of runs to average over</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_iterations</span> <span class="o">=</span> <span class="n">n_iterations</span>

        
        <span class="c1"># TODO: validate that n_test_visits &lt;= n_visits</span>
    
        <span class="bp">self</span><span class="o">.</span><span class="n">n_test_visits</span> <span class="o">=</span> <span class="n">n_test_visits</span>

        <span class="c1"># number of visits to replay/simulate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_visits</span> <span class="o">=</span> <span class="n">n_visits</span>

        <span class="c1"># items under test</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">items</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reward_history</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">item_col_name</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_items</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">)</span>
        
        <span class="c1"># visitors in the historical reward_history (e.g., from ratings df)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visitors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reward_history</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">visitor_col_name</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_visitors</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">visitors</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">is_testing</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">best_item_id</span> <span class="o">=</span> <span class="kc">None</span>
        
    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># number of times each item has been sampled (previously n_sampled)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_item_samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_items</span><span class="p">)</span>
        
        <span class="c1"># fraction of time each item has resulted in a reward (previously movie_clicks)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_item_rewards</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_items</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">is_testing</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">best_item_idx</span> <span class="o">=</span> <span class="kc">None</span>
    
    <span class="k">def</span> <span class="nf">select_item</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_testing</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_items</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_item_idx</span>
            
    <span class="k">def</span> <span class="nf">record_result</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">visit</span><span class="p">,</span> <span class="n">item_idx</span><span class="p">,</span> <span class="n">reward</span><span class="p">):</span>
    
        <span class="bp">self</span><span class="o">.</span><span class="n">n_item_samples</span><span class="p">[</span><span class="n">item_idx</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        
        <span class="n">alpha</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">n_item_samples</span><span class="p">[</span><span class="n">item_idx</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">n_item_rewards</span><span class="p">[</span><span class="n">item_idx</span><span class="p">]</span> <span class="o">+=</span> <span class="n">alpha</span> <span class="o">*</span> <span class="p">(</span><span class="n">reward</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_item_rewards</span><span class="p">[</span><span class="n">item_idx</span><span class="p">])</span>
        
        <span class="k">if</span> <span class="p">(</span><span class="n">visit</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_test_visits</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span> <span class="c1"># this was the last visit during the testing phase</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">is_testing</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">best_item_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_item_rewards</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">simulator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">iteration</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_iterations</span><span class="p">)):</span>
        
            <span class="bp">self</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
            
            <span class="n">total_rewards</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">fraction_relevant</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_visits</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">visit</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_visits</span><span class="p">):</span>
            
                <span class="n">found_match</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">while</span> <span class="ow">not</span> <span class="n">found_match</span><span class="p">:</span>
                
                    <span class="c1"># choose a random visitor</span>
                    <span class="n">visitor_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_visitors</span><span class="p">)</span>
                    <span class="n">visitor_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">visitors</span><span class="p">[</span><span class="n">visitor_idx</span><span class="p">]</span>

                    <span class="c1"># select an item to offer the visitor</span>
                    <span class="n">item_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">select_item</span><span class="p">()</span>
                    <span class="n">item_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">[</span><span class="n">item_idx</span><span class="p">]</span>
                    
                    <span class="c1"># if this interaction exists in the history, count it</span>
                    <span class="n">reward</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reward_history</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
                        <span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> == @item_id and </span><span class="si">{}</span><span class="s1"> == @visitor_id&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">item_col_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">visitor_col_name</span><span class="p">))[</span><span class="bp">self</span><span class="o">.</span><span class="n">reward_col_name</span><span class="p">]</span>
                    
                    <span class="n">found_match</span> <span class="o">=</span> <span class="n">reward</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span>
                
                <span class="n">reward_value</span> <span class="o">=</span> <span class="n">reward</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                
                <span class="bp">self</span><span class="o">.</span><span class="n">record_result</span><span class="p">(</span><span class="n">visit</span><span class="p">,</span> <span class="n">item_idx</span><span class="p">,</span> <span class="n">reward_value</span><span class="p">)</span>
                
                <span class="c1"># record metrics</span>
                <span class="n">total_rewards</span> <span class="o">+=</span> <span class="n">reward_value</span>
                <span class="n">fraction_relevant</span><span class="p">[</span><span class="n">visit</span><span class="p">]</span> <span class="o">=</span> <span class="n">total_rewards</span> <span class="o">*</span> <span class="mf">1.</span> <span class="o">/</span> <span class="p">(</span><span class="n">visit</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                
                <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">result</span><span class="p">[</span><span class="s1">&#39;iteration&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">iteration</span>
                <span class="n">result</span><span class="p">[</span><span class="s1">&#39;visit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">visit</span>
                <span class="n">result</span><span class="p">[</span><span class="s1">&#39;item_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">item_id</span>
                <span class="n">result</span><span class="p">[</span><span class="s1">&#39;visitor_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">visitor_id</span>
                <span class="n">result</span><span class="p">[</span><span class="s1">&#39;reward&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">reward_value</span>
                <span class="n">result</span><span class="p">[</span><span class="s1">&#39;total_reward&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">total_rewards</span>
                <span class="n">result</span><span class="p">[</span><span class="s1">&#39;fraction_relevant&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">total_rewards</span> <span class="o">*</span> <span class="mf">1.</span> <span class="o">/</span> <span class="p">(</span><span class="n">visit</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                
                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">results</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="sd">&#39;&#39;&#39;</span>

<span class="sd">Author - Abhishek Maheshwarappa and Jiaxin Tong</span>

<span class="sd">&#39;&#39;&#39;</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>

<span class="k">class</span> <span class="nc">EpsilonGreedyReplayer</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    A class to provide functionality for simulating the replayer method on an epsilon-Greedy bandit algorithm.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epsilon</span><span class="p">,</span> <span class="n">n_visits</span><span class="p">,</span> <span class="n">reward_history</span><span class="p">,</span> <span class="n">item_col_name</span><span class="p">,</span> <span class="n">visitor_col_name</span><span class="p">,</span> <span class="n">reward_col_name</span><span class="p">,</span> <span class="n">n_iterations</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">reward_history</span> <span class="o">=</span> <span class="n">reward_history</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">item_col_name</span> <span class="o">=</span> <span class="n">item_col_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visitor_col_name</span> <span class="o">=</span> <span class="n">visitor_col_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reward_col_name</span> <span class="o">=</span> <span class="n">reward_col_name</span>

        <span class="c1"># number of runs to average over</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_iterations</span> <span class="o">=</span> <span class="n">n_iterations</span>
    
        <span class="c1"># parameter to control exploration vs exploitation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epsilon</span> <span class="o">=</span> <span class="n">epsilon</span>

        <span class="c1"># number of visits to replay/simulate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_visits</span> <span class="o">=</span> <span class="n">n_visits</span>

        <span class="c1"># items under test</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">items</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reward_history</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">item_col_name</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_items</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">)</span>
        
        <span class="c1"># visitors in the historical reward_history (e.g., from ratings df)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visitors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reward_history</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">visitor_col_name</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_visitors</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">visitors</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">is_testing</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">best_item_id</span> <span class="o">=</span> <span class="kc">None</span>
    
    <span class="k">def</span> <span class="nf">select_item</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        
        <span class="c1"># decide to explore or exploit</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">()</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">epsilon</span><span class="p">:</span> <span class="c1"># explore</span>
            <span class="n">item_id</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_items</span><span class="p">)</span>
            
        <span class="k">else</span><span class="p">:</span> <span class="c1"># exploit</span>
            <span class="n">item_id</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_item_rewards</span><span class="p">)</span>
            
        <span class="k">return</span> <span class="n">item_id</span>
    
    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># number of times each item has been sampled (previously n_sampled)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_item_samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_items</span><span class="p">)</span>
        
        <span class="c1"># fraction of time each item has resulted in a reward (previously movie_clicks)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_item_rewards</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_items</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">record_result</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">visit</span><span class="p">,</span> <span class="n">item_idx</span><span class="p">,</span> <span class="n">reward</span><span class="p">):</span>
    
        <span class="bp">self</span><span class="o">.</span><span class="n">n_item_samples</span><span class="p">[</span><span class="n">item_idx</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        
        <span class="n">alpha</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">n_item_samples</span><span class="p">[</span><span class="n">item_idx</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_item_rewards</span><span class="p">[</span><span class="n">item_idx</span><span class="p">]</span> <span class="o">+=</span> <span class="n">alpha</span> <span class="o">*</span> <span class="p">(</span><span class="n">reward</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_item_rewards</span><span class="p">[</span><span class="n">item_idx</span><span class="p">])</span>

    
    <span class="k">def</span> <span class="nf">simulator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">iteration</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_iterations</span><span class="p">)):</span>
        
            <span class="bp">self</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
            
            <span class="n">total_rewards</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">fraction_relevant</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_visits</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">visit</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_visits</span><span class="p">):</span>
            
                <span class="n">found_match</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">while</span> <span class="ow">not</span> <span class="n">found_match</span><span class="p">:</span>
                
                    <span class="c1"># choose a random visitor</span>
                    <span class="n">visitor_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_visitors</span><span class="p">)</span>
                    <span class="n">visitor_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">visitors</span><span class="p">[</span><span class="n">visitor_idx</span><span class="p">]</span>

                    <span class="c1"># select an item to offer the visitor</span>
                    <span class="n">item_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">select_item</span><span class="p">()</span>
                    <span class="n">item_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">[</span><span class="n">item_idx</span><span class="p">]</span>
                    
                    <span class="c1"># if this interaction exists in the history, count it</span>
                    <span class="n">reward</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reward_history</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
                        <span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> == @item_id and </span><span class="si">{}</span><span class="s1"> == @visitor_id&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">item_col_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">visitor_col_name</span><span class="p">))[</span><span class="bp">self</span><span class="o">.</span><span class="n">reward_col_name</span><span class="p">]</span>
                    
                    <span class="n">found_match</span> <span class="o">=</span> <span class="n">reward</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span>
                
                <span class="n">reward_value</span> <span class="o">=</span> <span class="n">reward</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                
                <span class="bp">self</span><span class="o">.</span><span class="n">record_result</span><span class="p">(</span><span class="n">visit</span><span class="p">,</span> <span class="n">item_idx</span><span class="p">,</span> <span class="n">reward_value</span><span class="p">)</span>
                
                <span class="c1"># record metrics</span>
                <span class="n">total_rewards</span> <span class="o">+=</span> <span class="n">reward_value</span>
                <span class="n">fraction_relevant</span><span class="p">[</span><span class="n">visit</span><span class="p">]</span> <span class="o">=</span> <span class="n">total_rewards</span> <span class="o">*</span> <span class="mf">1.</span> <span class="o">/</span> <span class="p">(</span><span class="n">visit</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                
                <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">result</span><span class="p">[</span><span class="s1">&#39;iteration&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">iteration</span>
                <span class="n">result</span><span class="p">[</span><span class="s1">&#39;visit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">visit</span>
                <span class="n">result</span><span class="p">[</span><span class="s1">&#39;item_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">item_id</span>
                <span class="n">result</span><span class="p">[</span><span class="s1">&#39;visitor_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">visitor_id</span>
                <span class="n">result</span><span class="p">[</span><span class="s1">&#39;reward&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">reward_value</span>
                <span class="n">result</span><span class="p">[</span><span class="s1">&#39;total_reward&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">total_rewards</span>
                <span class="n">result</span><span class="p">[</span><span class="s1">&#39;fraction_relevant&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">total_rewards</span> <span class="o">*</span> <span class="mf">1.</span> <span class="o">/</span> <span class="p">(</span><span class="n">visit</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                
                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">results</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="sd">&#39;&#39;&#39;</span>

<span class="sd">Author - Abhishek Maheshwarappa and Jiaxin Tong</span>

<span class="sd">&#39;&#39;&#39;</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>

<span class="k">class</span> <span class="nc">ThompsonSamplingReplayer</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    A class to provide functionality for simulating the replayer method on a Thompson Sampling bandit algorithm</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_visits</span><span class="p">,</span> <span class="n">reward_history</span><span class="p">,</span> <span class="n">item_col_name</span><span class="p">,</span> <span class="n">visitor_col_name</span><span class="p">,</span> <span class="n">reward_col_name</span><span class="p">,</span> <span class="n">n_iterations</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">reward_history</span> <span class="o">=</span> <span class="n">reward_history</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">item_col_name</span> <span class="o">=</span> <span class="n">item_col_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visitor_col_name</span> <span class="o">=</span> <span class="n">visitor_col_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reward_col_name</span> <span class="o">=</span> <span class="n">reward_col_name</span>

        <span class="c1"># number of runs to average over</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_iterations</span> <span class="o">=</span> <span class="n">n_iterations</span>
    


        <span class="c1"># number of visits to replay/simulate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_visits</span> <span class="o">=</span> <span class="n">n_visits</span>

        <span class="c1"># items under test</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">items</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reward_history</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">item_col_name</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_items</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">)</span>
        
        <span class="c1"># visitors in the historical reward_history (e.g., from ratings df)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visitors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reward_history</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">visitor_col_name</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_visitors</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">visitors</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">is_testing</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">best_item_id</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alphas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_items</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">betas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_items</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">select_item</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    
        <span class="n">samples</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">beta</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alphas</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">betas</span><span class="p">)]</span>
        
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">record_result</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">visit</span><span class="p">,</span> <span class="n">item_idx</span><span class="p">,</span> <span class="n">reward</span><span class="p">):</span>
        
        <span class="c1"># update value estimate</span>
        <span class="k">if</span> <span class="n">reward</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">alphas</span><span class="p">[</span><span class="n">item_idx</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">betas</span><span class="p">[</span><span class="n">item_idx</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>



    <span class="k">def</span> <span class="nf">simulator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">iteration</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_iterations</span><span class="p">)):</span>
        
            <span class="bp">self</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
            
            <span class="n">total_rewards</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">fraction_relevant</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_visits</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">visit</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_visits</span><span class="p">):</span>
            
                <span class="n">found_match</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">while</span> <span class="ow">not</span> <span class="n">found_match</span><span class="p">:</span>
                
                    <span class="c1"># choose a random visitor</span>
                    <span class="n">visitor_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_visitors</span><span class="p">)</span>
                    <span class="n">visitor_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">visitors</span><span class="p">[</span><span class="n">visitor_idx</span><span class="p">]</span>

                    <span class="c1"># select an item to offer the visitor</span>
                    <span class="n">item_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">select_item</span><span class="p">()</span>
                    <span class="n">item_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">[</span><span class="n">item_idx</span><span class="p">]</span>
                    
                    <span class="c1"># if this interaction exists in the history, count it</span>
                    <span class="n">reward</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reward_history</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
                        <span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> == @item_id and </span><span class="si">{}</span><span class="s1"> == @visitor_id&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">item_col_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">visitor_col_name</span><span class="p">))[</span><span class="bp">self</span><span class="o">.</span><span class="n">reward_col_name</span><span class="p">]</span>
                    
                    <span class="n">found_match</span> <span class="o">=</span> <span class="n">reward</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span>
                
                <span class="n">reward_value</span> <span class="o">=</span> <span class="n">reward</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                
                <span class="bp">self</span><span class="o">.</span><span class="n">record_result</span><span class="p">(</span><span class="n">visit</span><span class="p">,</span> <span class="n">item_idx</span><span class="p">,</span> <span class="n">reward_value</span><span class="p">)</span>
                
                <span class="c1"># record metrics</span>
                <span class="n">total_rewards</span> <span class="o">+=</span> <span class="n">reward_value</span>
                <span class="n">fraction_relevant</span><span class="p">[</span><span class="n">visit</span><span class="p">]</span> <span class="o">=</span> <span class="n">total_rewards</span> <span class="o">*</span> <span class="mf">1.</span> <span class="o">/</span> <span class="p">(</span><span class="n">visit</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                
                <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">result</span><span class="p">[</span><span class="s1">&#39;iteration&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">iteration</span>
                <span class="n">result</span><span class="p">[</span><span class="s1">&#39;visit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">visit</span>
                <span class="n">result</span><span class="p">[</span><span class="s1">&#39;item_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">item_id</span>
                <span class="n">result</span><span class="p">[</span><span class="s1">&#39;visitor_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">visitor_id</span>
                <span class="n">result</span><span class="p">[</span><span class="s1">&#39;reward&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">reward_value</span>
                <span class="n">result</span><span class="p">[</span><span class="s1">&#39;total_reward&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">total_rewards</span>
                <span class="n">result</span><span class="p">[</span><span class="s1">&#39;fraction_relevant&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">total_rewards</span> <span class="o">*</span> <span class="mf">1.</span> <span class="o">/</span> <span class="p">(</span><span class="n">visit</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                
                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">results</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="sd">&#39;&#39;&#39;</span>

<span class="sd">Author - Abhishek Maheshwarappa and Jiaxin Tong</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>


<span class="k">class</span> <span class="nc">ReplaySimulator</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    A class to provide base functionality for simulating the replayer method for online algorithms.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_visits</span><span class="p">,</span> <span class="n">reward_history</span><span class="p">,</span> <span class="n">item_col_name</span><span class="p">,</span> <span class="n">visitor_col_name</span><span class="p">,</span> <span class="n">reward_col_name</span><span class="p">,</span> <span class="n">n_iterations</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">random_seed</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>

        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">random_seed</span><span class="p">)</span>
    
        <span class="bp">self</span><span class="o">.</span><span class="n">reward_history</span> <span class="o">=</span> <span class="n">reward_history</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">item_col_name</span> <span class="o">=</span> <span class="n">item_col_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visitor_col_name</span> <span class="o">=</span> <span class="n">visitor_col_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reward_col_name</span> <span class="o">=</span> <span class="n">reward_col_name</span>

        <span class="c1"># number of visits to replay/simulate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_visits</span> <span class="o">=</span> <span class="n">n_visits</span>
        
        <span class="c1"># number of runs to average over</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_iterations</span> <span class="o">=</span> <span class="n">n_iterations</span>
    
        <span class="c1"># items under test</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">items</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reward_history</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">item_col_name</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_items</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">)</span>
        
        <span class="c1"># visitors in the historical reward_history (e.g., from ratings df)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visitors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reward_history</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">visitor_col_name</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_visitors</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">visitors</span><span class="p">)</span>
        

    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># number of times each item has been sampled (previously n_sampled)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_item_samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_items</span><span class="p">)</span>
        
        <span class="c1"># fraction of time each item has resulted in a reward (previously movie_clicks)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_item_rewards</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_items</span><span class="p">)</span>
        
    
    <span class="k">def</span> <span class="nf">replay</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">iteration</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_iterations</span><span class="p">)):</span>
        
            <span class="bp">self</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
            
            <span class="n">total_rewards</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">fraction_relevant</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_visits</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">visit</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_visits</span><span class="p">):</span>
            
                <span class="n">found_match</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">while</span> <span class="ow">not</span> <span class="n">found_match</span><span class="p">:</span>
                
                    <span class="c1"># choose a random visitor</span>
                    <span class="n">visitor_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_visitors</span><span class="p">)</span>
                    <span class="n">visitor_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">visitors</span><span class="p">[</span><span class="n">visitor_idx</span><span class="p">]</span>

                    <span class="c1"># select an item to offer the visitor</span>
                    <span class="n">item_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">select_item</span><span class="p">()</span>
                    <span class="n">item_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">[</span><span class="n">item_idx</span><span class="p">]</span>
                    
                    <span class="c1"># if this interaction exists in the history, count it</span>
                    <span class="n">reward</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reward_history</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
                        <span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> == @item_id and </span><span class="si">{}</span><span class="s1"> == @visitor_id&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">item_col_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">visitor_col_name</span><span class="p">))[</span><span class="bp">self</span><span class="o">.</span><span class="n">reward_col_name</span><span class="p">]</span>
                    
                    <span class="n">found_match</span> <span class="o">=</span> <span class="n">reward</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span>
                
                <span class="n">reward_value</span> <span class="o">=</span> <span class="n">reward</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                
                <span class="bp">self</span><span class="o">.</span><span class="n">record_result</span><span class="p">(</span><span class="n">visit</span><span class="p">,</span> <span class="n">item_idx</span><span class="p">,</span> <span class="n">reward_value</span><span class="p">)</span>
                
                <span class="c1">## record metrics</span>
                <span class="n">total_rewards</span> <span class="o">+=</span> <span class="n">reward_value</span>
                <span class="n">fraction_relevant</span><span class="p">[</span><span class="n">visit</span><span class="p">]</span> <span class="o">=</span> <span class="n">total_rewards</span> <span class="o">*</span> <span class="mf">1.</span> <span class="o">/</span> <span class="p">(</span><span class="n">visit</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                
                <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">result</span><span class="p">[</span><span class="s1">&#39;iteration&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">iteration</span>
                <span class="n">result</span><span class="p">[</span><span class="s1">&#39;visit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">visit</span>
                <span class="n">result</span><span class="p">[</span><span class="s1">&#39;item_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">item_id</span>
                <span class="n">result</span><span class="p">[</span><span class="s1">&#39;visitor_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">visitor_id</span>
                <span class="n">result</span><span class="p">[</span><span class="s1">&#39;reward&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">reward_value</span>
                <span class="n">result</span><span class="p">[</span><span class="s1">&#39;total_reward&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">total_rewards</span>
                <span class="n">result</span><span class="p">[</span><span class="s1">&#39;fraction_relevant&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">total_rewards</span> <span class="o">*</span> <span class="mf">1.</span> <span class="o">/</span> <span class="p">(</span><span class="n">visit</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                
                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">results</span>
        
    <span class="k">def</span> <span class="nf">select_item</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_items</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">record_result</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">visit</span><span class="p">,</span> <span class="n">item_idx</span><span class="p">,</span> <span class="n">reward</span><span class="p">):</span>
    
        <span class="bp">self</span><span class="o">.</span><span class="n">n_item_samples</span><span class="p">[</span><span class="n">item_idx</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        
        <span class="n">alpha</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">n_item_samples</span><span class="p">[</span><span class="n">item_idx</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_item_rewards</span><span class="p">[</span><span class="n">item_idx</span><span class="p">]</span> <span class="o">+=</span> <span class="n">alpha</span> <span class="o">*</span> <span class="p">(</span><span class="n">reward</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_item_rewards</span><span class="p">[</span><span class="n">item_idx</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="sd">&#39;&#39;&#39;</span>

<span class="sd">Author - Abhishek Maheshwarappa and Jiaxin Tong</span>

<span class="sd">&#39;&#39;&#39;</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>

<span class="k">class</span> <span class="nc">UCBSamplingReplayer</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    A class to provide functionality for simulating the replayer method on a Thompson Sampling bandit algorithm</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">ucb_c</span><span class="p">,</span> <span class="n">n_visits</span><span class="p">,</span> <span class="n">reward_history</span><span class="p">,</span> <span class="n">item_col_name</span><span class="p">,</span> <span class="n">visitor_col_name</span><span class="p">,</span> <span class="n">reward_col_name</span><span class="p">,</span> <span class="n">n_iterations</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">reward_history</span> <span class="o">=</span> <span class="n">reward_history</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">item_col_name</span> <span class="o">=</span> <span class="n">item_col_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visitor_col_name</span> <span class="o">=</span> <span class="n">visitor_col_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reward_col_name</span> <span class="o">=</span> <span class="n">reward_col_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ucb_c</span> <span class="o">=</span> <span class="n">ucb_c</span>

        <span class="c1"># number of runs to average over</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_iterations</span> <span class="o">=</span> <span class="n">n_iterations</span>
    


        <span class="c1"># number of visits to replay/simulate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_visits</span> <span class="o">=</span> <span class="n">n_visits</span>

        <span class="c1"># items under test</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">items</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reward_history</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">item_col_name</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_items</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">)</span>
        
        <span class="c1"># visitors in the historical reward_history (e.g., from ratings df)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visitors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reward_history</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">visitor_col_name</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_visitors</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">visitors</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">is_testing</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">best_item_id</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_items</span><span class="p">)</span> <span class="c1"># q-value of actions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_items</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.0001</span> <span class="c1"># action count</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timestep</span> <span class="o">=</span> <span class="mi">1</span>


    <span class="k">def</span> <span class="nf">select_item</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">ln_timestep</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_items</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">timestep</span><span class="p">))</span>
        <span class="n">confidence</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ucb_c</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">ln_timestep</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">)</span>

        <span class="n">action</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Q</span> <span class="o">+</span> <span class="n">confidence</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timestep</span> <span class="o">+=</span> <span class="mi">1</span>
        
        <span class="k">return</span> <span class="n">action</span>

    <span class="k">def</span> <span class="nf">record_result</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">visit</span><span class="p">,</span> <span class="n">item_idx</span><span class="p">,</span> <span class="n">reward</span><span class="p">):</span>
        
        <span class="c1"># update value estimate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">[</span><span class="n">item_idx</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span> <span class="c1"># increment action count</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">[</span><span class="n">item_idx</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">[</span><span class="n">item_idx</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">reward</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">[</span><span class="n">item_idx</span><span class="p">])</span> <span class="c1"># inc. update rule</span>


    <span class="k">def</span> <span class="nf">simulator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">iteration</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_iterations</span><span class="p">)):</span>
        
            <span class="bp">self</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
            
            <span class="n">total_rewards</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">fraction_relevant</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_visits</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">visit</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_visits</span><span class="p">):</span>
            
                <span class="n">found_match</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">while</span> <span class="ow">not</span> <span class="n">found_match</span><span class="p">:</span>
                
                    <span class="c1"># choose a random visitor</span>
                    <span class="n">visitor_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_visitors</span><span class="p">)</span>
                    <span class="n">visitor_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">visitors</span><span class="p">[</span><span class="n">visitor_idx</span><span class="p">]</span>

                    <span class="c1"># select an item to offer the visitor</span>
                    <span class="n">item_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">select_item</span><span class="p">()</span>
                    <span class="n">item_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">[</span><span class="n">item_idx</span><span class="p">]</span>
                    
                    <span class="c1"># if this interaction exists in the history, count it</span>
                    <span class="n">reward</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reward_history</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
                        <span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> == @item_id and </span><span class="si">{}</span><span class="s1"> == @visitor_id&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">item_col_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">visitor_col_name</span><span class="p">))[</span><span class="bp">self</span><span class="o">.</span><span class="n">reward_col_name</span><span class="p">]</span>
                    
                    <span class="n">found_match</span> <span class="o">=</span> <span class="n">reward</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span>
                
                <span class="n">reward_value</span> <span class="o">=</span> <span class="n">reward</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                
                <span class="bp">self</span><span class="o">.</span><span class="n">record_result</span><span class="p">(</span><span class="n">visit</span><span class="p">,</span> <span class="n">item_idx</span><span class="p">,</span> <span class="n">reward_value</span><span class="p">)</span>
                
                <span class="c1"># record metrics</span>
                <span class="n">total_rewards</span> <span class="o">+=</span> <span class="n">reward_value</span>
                <span class="n">fraction_relevant</span><span class="p">[</span><span class="n">visit</span><span class="p">]</span> <span class="o">=</span> <span class="n">total_rewards</span> <span class="o">*</span> <span class="mf">1.</span> <span class="o">/</span> <span class="p">(</span><span class="n">visit</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                
                <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">result</span><span class="p">[</span><span class="s1">&#39;iteration&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">iteration</span>
                <span class="n">result</span><span class="p">[</span><span class="s1">&#39;visit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">visit</span>
                <span class="n">result</span><span class="p">[</span><span class="s1">&#39;item_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">item_id</span>
                <span class="n">result</span><span class="p">[</span><span class="s1">&#39;visitor_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">visitor_id</span>
                <span class="n">result</span><span class="p">[</span><span class="s1">&#39;reward&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">reward_value</span>
                <span class="n">result</span><span class="p">[</span><span class="s1">&#39;total_reward&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">total_rewards</span>
                <span class="n">result</span><span class="p">[</span><span class="s1">&#39;fraction_relevant&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">total_rewards</span> <span class="o">*</span> <span class="mf">1.</span> <span class="o">/</span> <span class="p">(</span><span class="n">visit</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                
                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">results</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="running-simulation">
<h3>Running simulation<a class="headerlink" href="#running-simulation" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Multi-Armed-Bandits-for-Recommendations-and-A-B-testing !!!&quot;</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Current time: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">current_time</span><span class="p">))</span>

<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Reading the data..!!&quot;</span><span class="p">)</span>

<span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">header_list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;User_ID&quot;</span><span class="p">,</span> <span class="s2">&quot;Product_ID&quot;</span><span class="p">,</span> <span class="s2">&quot;Rating&quot;</span><span class="p">,</span> <span class="s2">&quot;Time_Stamp&quot;</span><span class="p">]</span>
<span class="n">rating_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;ratings_Electronics (1).csv&#39;</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="n">header_list</span><span class="p">)</span>
<span class="n">latency</span><span class="p">[</span><span class="s2">&quot;Data_reading -&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>
<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Read the data Successfully ..!!!&quot;</span><span class="p">)</span>

<span class="n">reward_threshold</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">rating_df</span><span class="p">[</span><span class="s1">&#39;reward&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rating_df</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="s1">&#39;Rating &gt; @reward_threshold&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>16-Jun-21 22:00:41 : INFO : Multi-Armed-Bandits-for-Recommendations-and-A-B-testing !!!
16-Jun-21 22:00:41 : INFO : Current time: 2021-06-16__21.35
16-Jun-21 22:00:41 : INFO : Reading the data..!!
16-Jun-21 22:00:47 : INFO : Read the data Successfully ..!!!
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">n_visits</span> <span class="o">=</span> <span class="mi">500</span>
<span class="n">n_iterations</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">n_test_visits</span> <span class="o">=</span> <span class="mi">100</span>

<span class="n">reward_history</span> <span class="o">=</span> <span class="n">rating_df</span><span class="p">[:</span><span class="mi">1000</span><span class="p">]</span>
<span class="n">item_col_name</span> <span class="o">=</span> <span class="s1">&#39;Product_ID&#39;</span>
<span class="n">visitor_col_name</span> <span class="o">=</span> <span class="s1">&#39;User_ID&#39;</span>
<span class="n">reward_col_name</span> <span class="o">=</span> <span class="s1">&#39;reward&#39;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#################### A/B testing ###############</span>

<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;A/B Test Simulations...starts...!!!&quot;</span><span class="p">)</span>

<span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">ab_results</span> <span class="o">=</span> <span class="n">ABTestReplayer</span><span class="p">(</span><span class="n">n_visits</span><span class="p">,</span> <span class="n">n_test_visits</span><span class="p">,</span> <span class="n">reward_history</span><span class="p">,</span>
                            <span class="n">item_col_name</span><span class="p">,</span> <span class="n">visitor_col_name</span><span class="p">,</span> <span class="n">reward_col_name</span><span class="p">,</span>
                            <span class="n">n_iterations</span><span class="o">=</span><span class="n">n_iterations</span><span class="p">)</span><span class="o">.</span><span class="n">simulator</span><span class="p">()</span>

<span class="n">ab_results_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">ab_results</span><span class="p">)</span>
<span class="n">latency</span><span class="p">[</span><span class="s2">&quot;A/B testing -&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>

<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;A/B testing completed Successfully..!!&quot;</span><span class="p">)</span>

<span class="n">ab_results_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">target_dir</span> <span class="o">+</span> <span class="s1">&#39;/ab_results_df.csv&#39;</span><span class="p">)</span>

<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Saving the A/B test results saved Successfully..!!&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>16-Jun-21 22:01:52 : INFO : A/B Test Simulations...starts...!!!

  0%|          | 0/1 [00:00&lt;?, ?it/s]
100%|██████████| 1/1 [03:07&lt;00:00, 187.56s/it]
16-Jun-21 22:04:59 : INFO : A/B testing completed Successfully..!!
16-Jun-21 22:04:59 : INFO : Saving the A/B test results saved Successfully..!!
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">################# Epsilon - Greedy Simulations ##############</span>

<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Epsilon - Greedy Simulations...starts...!!!&quot;</span><span class="p">)</span>

<span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">epsilon</span> <span class="o">=</span> <span class="mf">0.05</span>
<span class="n">epsilon_results</span> <span class="o">=</span> <span class="n">EpsilonGreedyReplayer</span><span class="p">(</span><span class="n">epsilon</span><span class="p">,</span> <span class="n">n_visits</span><span class="p">,</span> <span class="n">reward_history</span><span class="p">,</span>
                                        <span class="n">item_col_name</span><span class="p">,</span> <span class="n">visitor_col_name</span><span class="p">,</span> <span class="n">reward_col_name</span><span class="p">,</span>
                                        <span class="n">n_iterations</span><span class="o">=</span><span class="n">n_iterations</span><span class="p">)</span><span class="o">.</span><span class="n">simulator</span><span class="p">()</span>

<span class="n">epsilon_results_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">epsilon_results</span><span class="p">)</span>
<span class="n">latency</span><span class="p">[</span><span class="s2">&quot;Epsilon - Greedy Simulations  -&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>
<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Epsilon - Greedy Simulations completed Successfully..!!&quot;</span><span class="p">)</span>

<span class="n">epsilon_results_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">target_dir</span> <span class="o">+</span><span class="s1">&#39;/epsilon_results_df.csv&#39;</span><span class="p">)</span>

<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Epsilon - Greedy Simulations results saved Successfully..!!&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>16-Jun-21 22:04:59 : INFO : Epsilon - Greedy Simulations...starts...!!!

  0%|          | 0/1 [00:00&lt;?, ?it/s]
100%|██████████| 1/1 [10:38&lt;00:00, 638.64s/it]
16-Jun-21 22:15:38 : INFO : Epsilon - Greedy Simulations completed Successfully..!!
16-Jun-21 22:15:38 : INFO : Epsilon - Greedy Simulations results saved Successfully..!!
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">################### Thompson Sampling Simulations #######################</span>

<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Thompson Sampling Simulations...starts...!!!&quot;</span><span class="p">)</span>

<span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

<span class="n">thompson_results</span> <span class="o">=</span> <span class="n">ThompsonSamplingReplayer</span><span class="p">(</span><span class="n">n_visits</span><span class="p">,</span> <span class="n">reward_history</span><span class="p">,</span>
                                            <span class="n">item_col_name</span><span class="p">,</span> <span class="n">visitor_col_name</span><span class="p">,</span> <span class="n">reward_col_name</span><span class="p">,</span>
                                            <span class="n">n_iterations</span><span class="o">=</span><span class="n">n_iterations</span><span class="p">)</span><span class="o">.</span><span class="n">simulator</span><span class="p">()</span>

<span class="n">thompson_results_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">thompson_results</span><span class="p">)</span>
<span class="n">latency</span><span class="p">[</span><span class="s2">&quot;Thompson Sampling Simulations  -&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>
<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Thompson Sampling Simulations completed Successfully..!!&quot;</span><span class="p">)</span>

<span class="n">thompson_results_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">target_dir</span> <span class="o">+</span><span class="s1">&#39;/thompson_results_df.csv&#39;</span><span class="p">)</span>

<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Thompson Sampling Simulations results saved Successfully..!!&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>16-Jun-21 22:15:38 : INFO : Thompson Sampling Simulations...starts...!!!

  0%|          | 0/1 [00:00&lt;?, ?it/s]
100%|██████████| 1/1 [11:51&lt;00:00, 711.80s/it]
16-Jun-21 22:27:30 : INFO : Thompson Sampling Simulations completed Successfully..!!
16-Jun-21 22:27:30 : INFO : Thompson Sampling Simulations results saved Successfully..!!
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">####################  Upper Confidence Bounds #########################</span>

<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Upper Confidence Bounds Simulations...starts...!!!&quot;</span><span class="p">)</span>

<span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

<span class="n">ucb</span> <span class="o">=</span> <span class="mi">2</span>

<span class="n">ucb_results</span> <span class="o">=</span> <span class="n">UCBSamplingReplayer</span><span class="p">(</span><span class="n">ucb</span><span class="p">,</span> <span class="n">n_visits</span><span class="p">,</span> <span class="n">reward_history</span><span class="p">,</span>
                                  <span class="n">item_col_name</span><span class="p">,</span> <span class="n">visitor_col_name</span><span class="p">,</span> <span class="n">reward_col_name</span><span class="p">,</span>
                                  <span class="n">n_iterations</span><span class="o">=</span><span class="n">n_iterations</span><span class="p">)</span><span class="o">.</span><span class="n">simulator</span><span class="p">()</span>

<span class="n">ucb_results_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">ucb_results</span><span class="p">)</span>
<span class="n">latency</span><span class="p">[</span><span class="s2">&quot;Upper Confidence Bounds Simulations  -&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>

<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Upper Confidence Bounds Simulations completed Successfully..!!&quot;</span><span class="p">)</span>

<span class="n">ucb_results_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">target_dir</span> <span class="o">+</span><span class="s1">&#39;/ucb_results_df.csv&#39;</span><span class="p">)</span>

<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Upper Confidence Bounds Simulations results saved Successfully..!!&quot;</span><span class="p">)</span>

<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Exporting the latency&#39;</span><span class="p">)</span>
<span class="n">file_name</span> <span class="o">=</span> <span class="n">target_dir</span> <span class="o">+</span><span class="s1">&#39;/latency_stats.json&#39;</span>
<span class="n">export_to_json</span><span class="p">(</span><span class="n">latency</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Program completed normally&quot;</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">handlers</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>16-Jun-21 22:27:30 : INFO : Upper Confidence Bounds Simulations...starts...!!!

  0%|          | 0/1 [00:00&lt;?, ?it/s]
100%|██████████| 1/1 [14:35&lt;00:00, 875.29s/it]
16-Jun-21 22:42:05 : INFO : Upper Confidence Bounds Simulations completed Successfully..!!
16-Jun-21 22:42:05 : INFO : Upper Confidence Bounds Simulations results saved Successfully..!!
16-Jun-21 22:42:05 : INFO : Exporting the latency
16-Jun-21 22:42:05 : INFO : Data exported to JSON successfully!
16-Jun-21 22:42:05 : INFO : Program completed normally
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="result-analysis">
<h3>Result analysis<a class="headerlink" href="#result-analysis" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">The Csv files present in current </span>
<span class="sd">output run directory are Read </span>
<span class="sd">for all the algos</span>

<span class="sd">&#39;&#39;&#39;</span>

<span class="n">ucb_results_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">target_dir</span><span class="p">,</span><span class="s1">&#39;ucb_results_df.csv&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;Unnamed: 0&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">thompson_results_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">target_dir</span><span class="p">,</span><span class="s1">&#39;thompson_results_df.csv&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;Unnamed: 0&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">epsilon_results_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">target_dir</span><span class="p">,</span><span class="s1">&#39;epsilon_results_df.csv&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;Unnamed: 0&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ab_results_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">target_dir</span><span class="p">,</span><span class="s1">&#39;ab_results_df.csv&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;Unnamed: 0&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">Grouping the each data frame with visit with mean</span>
<span class="sd">&#39;&#39;&#39;</span>

<span class="n">ucb_avg_results_df</span> <span class="o">=</span> <span class="n">ucb_results_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;visit&#39;</span><span class="p">,</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

<span class="n">thompson_avg_results_df</span> <span class="o">=</span> <span class="n">thompson_results_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;visit&#39;</span><span class="p">,</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

<span class="n">epsilon_avg_results_df</span> <span class="o">=</span> <span class="n">epsilon_results_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;visit&#39;</span><span class="p">,</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

<span class="n">ab_avg_results_df</span> <span class="o">=</span> <span class="n">ab_results_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;visit&#39;</span><span class="p">,</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># using a color-blind friendly palette with 10 colors</span>
<span class="n">color_blind_palette_10</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;#cfcfcf&#39;</span><span class="p">,</span> <span class="s1">&#39;#ffbc79&#39;</span><span class="p">,</span> <span class="s1">&#39;#a2c8ec&#39;</span><span class="p">,</span> <span class="s1">&#39;#898989&#39;</span><span class="p">,</span> <span class="s1">&#39;#c85200&#39;</span><span class="p">,</span>
                          <span class="s1">&#39;#5f9ed1&#39;</span><span class="p">,</span> <span class="s1">&#39;#595959&#39;</span><span class="p">,</span> <span class="s1">&#39;#ababab&#39;</span><span class="p">,</span> <span class="s1">&#39;#ff800e&#39;</span><span class="p">,</span> <span class="s1">&#39;#006ba4&#39;</span><span class="p">]</span>

<span class="n">sns</span><span class="o">.</span><span class="n">palplot</span><span class="p">(</span><span class="n">color_blind_palette_10</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/T057885_Offline_Replayer_Evaluation_106_0.png" src="../_images/T057885_Offline_Replayer_Evaluation_106_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>

<span class="k">for</span> <span class="p">(</span><span class="n">avg_results_df</span><span class="p">,</span> <span class="n">style</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[(</span><span class="n">ucb_avg_results_df</span><span class="p">,</span> <span class="s1">&#39;r-&#39;</span><span class="p">),</span>
                                <span class="p">(</span><span class="n">thompson_avg_results_df</span><span class="p">,</span> <span class="s1">&#39;g--&#39;</span><span class="p">),</span>
                                <span class="p">(</span><span class="n">epsilon_avg_results_df</span><span class="p">,</span> <span class="s1">&#39;b-&#39;</span><span class="p">),</span>
                                <span class="p">(</span><span class="n">ab_avg_results_df</span><span class="p">,</span> <span class="s1">&#39;y--&#39;</span><span class="p">)]:</span>
    
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">avg_results_df</span><span class="o">.</span><span class="n">visit</span><span class="p">,</span> <span class="n">avg_results_df</span><span class="o">.</span><span class="n">fraction_relevant</span><span class="p">,</span> <span class="n">style</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">3.5</span><span class="p">)</span>


<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Percentage of Liked Recommendations&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Recommendation #&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">% o</span><span class="s1">f Recs Clicked&#39;</span><span class="p">)</span>

<span class="c1">#ax.set_xticks(range(0,22000,5000))</span>
<span class="c1">#ax.set_ylim(0.2, 0.6)</span>
<span class="c1">#ax.set_yticks(np.arange(0.2, 0.7, 0.1))</span>

<span class="c1">#rescale the y-axis tick labels to show them as a percentage</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">((</span><span class="n">ax</span><span class="o">.</span><span class="n">get_yticks</span><span class="p">()</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">))</span>

<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s1">&#39;UCB &#39;</span><span class="p">,</span>
           <span class="s1">&#39;Thompson Sampling&#39;</span><span class="p">,</span>
           <span class="s1">&#39;$\epsilon$ Greedy&#39;</span><span class="p">,</span>
           <span class="s1">&#39;A/B Test&#39;</span>
          <span class="p">],</span>
          <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;lower right&#39;</span>
         <span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/T057885_Offline_Replayer_Evaluation_107_0.png" src="../_images/T057885_Offline_Replayer_Evaluation_107_0.png" />
</div>
</div>
<p>From the above it is clear that Thompson smapling of multi arm bandit outperforms A/B testing. In the lower samples the Epsilon Greedy better than all other algorithim, but as in when the number smaples increase the thompsonsampling starts performing beter and better.</p>
</div>
</div>
<div class="section" id="movielens">
<h2>Movielens<a class="headerlink" href="#movielens" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><p>Evaluating bandits offline with replay method on movielens dataset</p>
</div></blockquote>
<div class="section" id="import-libraries">
<h3>Import libraries<a class="headerlink" href="#import-libraries" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">matplotlib.ticker</span> <span class="kn">import</span> <span class="n">FormatStrFormatter</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>

<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">norm</span><span class="p">,</span> <span class="n">beta</span>
<span class="kn">from</span> <span class="nn">abc</span> <span class="kn">import</span> <span class="n">ABC</span><span class="p">,</span> <span class="n">abstractmethod</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="loading-data">
<h3>Loading data<a class="headerlink" href="#loading-data" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>!wget http://files.grouplens.org/datasets/movielens/ml-100k.zip
!unzip ml-100k.zip

rating_df = pd.read_csv(&#39;ml-100k/u.data&#39;, sep=&#39;\t&#39;, header=None, names=[&#39;user_id&#39;,&#39;movie_id&#39;,&#39;rating&#39;,&#39;timestamp&#39;], usecols=[&#39;movie_id&#39;, &#39;rating&#39;])
rating_df.columns = [&#39;movieId&#39;, &#39;rating&#39;]
rating_df.head()
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="util-functions">
<h3>Util functions<a class="headerlink" href="#util-functions" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_data</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">num_ratings</span><span class="p">,</span> <span class="n">num_movies</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Make each movieId/action uniformly distributed &quot;&quot;&quot;</span>
    <span class="c1"># filters out movies with less than `num_ratings` ratings</span>
    <span class="n">movies</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;movieId&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">({</span><span class="s1">&#39;rating&#39;</span><span class="p">:</span> <span class="s1">&#39;count&#39;</span><span class="p">})</span>
    <span class="k">if</span> <span class="n">num_movies</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">movies_to_keep</span> <span class="o">=</span> <span class="n">movies</span><span class="p">[(</span><span class="n">movies</span><span class="p">[</span><span class="s1">&#39;rating&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">num_ratings</span><span class="p">)]</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
            <span class="n">n</span><span class="o">=</span><span class="n">num_movies</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span><span class="o">.</span><span class="n">index</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">movies_to_keep</span> <span class="o">=</span> <span class="n">movies</span><span class="p">[(</span><span class="n">movies</span><span class="p">[</span><span class="s1">&#39;rating&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">num_ratings</span><span class="p">)]</span><span class="o">.</span><span class="n">index</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;movieId&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">movies_to_keep</span><span class="p">)]</span>
    <span class="c1"># take a random sample of size `num_ratings` for each movie</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;movieId&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">num_ratings</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
    <span class="c1"># shuffle rows to randomize data stream</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">frac</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
    <span class="c1"># reset index to create pseudo-timestamp index</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">data</span>


<span class="c1"># Plot ################################################################</span>

<span class="k">def</span> <span class="nf">plot_rewards</span><span class="p">(</span><span class="o">*</span><span class="n">policies</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">policy</span> <span class="ow">in</span> <span class="n">policies</span><span class="p">:</span>
        <span class="c1"># get cumulative rewards</span>
        <span class="n">cumsum_rewards</span> <span class="o">=</span> <span class="n">policy</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">reward</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>
        <span class="c1"># get average rewards</span>
        <span class="n">timesteps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cumsum_rewards</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">avg_rewards</span> <span class="o">=</span> <span class="n">cumsum_rewards</span> <span class="o">/</span> <span class="n">timesteps</span>
        <span class="c1"># plots</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">timesteps</span><span class="p">,</span> <span class="n">avg_rewards</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">policy</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">timesteps</span><span class="p">,</span> <span class="n">cumsum_rewards</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">policy</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="c1">#</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">FormatStrFormatter</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%.1f</span><span class="s1">&#39;</span><span class="p">))</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;time step&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;average reward&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;lower right&#39;</span><span class="p">)</span>
    <span class="c1">#</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">FormatStrFormatter</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">))</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;time step&#39;</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;cumulative reward&#39;</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;lower right&#39;</span><span class="p">)</span>
    <span class="c1">#</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">plot_action_values</span><span class="p">(</span><span class="o">*</span><span class="n">policies</span><span class="p">):</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">policies</span><span class="p">),</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Action scores&quot;</span><span class="p">)</span>
    <span class="n">axs</span> <span class="o">=</span> <span class="n">axs</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">policy</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">policies</span><span class="p">):</span>
        <span class="n">cbar</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">axs</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span> <span class="k">else</span> <span class="kc">False</span>
        <span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">policy</span><span class="o">.</span><span class="n">scores_log</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">vmin</span><span class="o">=</span><span class="mf">2.5</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;hot&#39;</span><span class="p">,</span>
                    <span class="n">cbar</span><span class="o">=</span><span class="n">cbar</span><span class="p">,</span> <span class="n">xticklabels</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">yticklabels</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;time step&#39;</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">set_text</span><span class="p">(</span><span class="n">policy</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;movieId&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="set-variables">
<h3>Set variables<a class="headerlink" href="#set-variables" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">NUM_RATINGS</span> <span class="o">=</span> <span class="mi">30</span>        <span class="c1"># with full dataset  -&gt; 10000</span>
                        <span class="c1"># with small dataset -&gt; 30</span>
<span class="n">NUM_MOVIES</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">SLATE_SIZE</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">BATCH_SIZE</span> <span class="o">=</span> <span class="mi">100</span>        <span class="c1"># with replay eval   -&gt; 100</span>
                        <span class="c1"># with simulated env -&gt; 1</span>
<span class="n">STREAM_LENGTH</span> <span class="o">=</span> <span class="mi">150</span>     <span class="c1"># with full dataset  -&gt; 50000</span>
                        <span class="c1"># with small dataset -&gt; 150</span>
<span class="n">MODE</span> <span class="o">=</span> <span class="s1">&#39;replay&#39;</span>         <span class="c1"># &#39;replay&#39; or &#39;sim&#39;</span>
<span class="n">SCORES_LOG</span> <span class="o">=</span> <span class="kc">False</span>      <span class="c1"># logging movie scores or not</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># get data</span>
<span class="n">logged_events</span> <span class="o">=</span> <span class="n">get_data</span><span class="p">(</span><span class="n">rating_df</span><span class="p">,</span> <span class="n">NUM_RATINGS</span><span class="p">,</span> <span class="n">NUM_MOVIES</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="create-agents">
<h3>Create agents<a class="headerlink" href="#create-agents" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Abstract Base Policy ###############################################</span>

<span class="k">class</span> <span class="nc">ABPolicy</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bandit</span><span class="p">,</span> <span class="n">slate_size</span><span class="p">,</span> <span class="n">scores_logging</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slate_size</span> <span class="o">=</span> <span class="n">slate_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">history</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;movieId&#39;</span><span class="p">,</span> <span class="s1">&#39;reward&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">scores_logging</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scores_log</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">bandit</span><span class="o">.</span><span class="n">actions</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scores_log</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">get_recommendations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="o">...</span>

    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rewards</span><span class="p">):</span>
        <span class="c1"># append new events to history</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">history</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rewards</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">_sort_actions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scores</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Sort actions by score and shuffle actions with same score</span>
<span class="sd">            Inputs:</span>
<span class="sd">                scores: pandas.Series with actions as index &quot;&quot;&quot;</span>
        <span class="n">sorted_actions</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
            <span class="n">scores</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">frac</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
            <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">idx</span><span class="p">:</span> <span class="n">scores</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span>
            <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sorted_actions</span>

    <span class="k">def</span> <span class="nf">_update_scores_history</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scores</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">scores_log</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scores_log</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scores_log</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
                    <span class="n">data</span><span class="o">=</span><span class="n">scores</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)),</span>
                    <span class="n">columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scores_log</span><span class="o">.</span><span class="n">columns</span><span class="p">),</span>
                <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scores_log</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scores_log</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float&#39;</span><span class="p">)</span>



<span class="c1"># Epsilon Greedy Policy ##############################################</span>

<span class="k">class</span> <span class="nc">EpsilonGreedy</span><span class="p">(</span><span class="n">ABPolicy</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bandit</span><span class="p">,</span> <span class="n">epsilon</span><span class="p">,</span> <span class="n">slate_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">scores_logging</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">EpsilonGreedy</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">bandit</span><span class="p">,</span> <span class="n">slate_size</span><span class="p">,</span> <span class="n">scores_logging</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">-Greedy&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">epsilon</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epsilon</span> <span class="o">=</span> <span class="n">epsilon</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">action_values</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="s1">&#39;count&#39;</span><span class="p">],</span>
                                          <span class="n">index</span><span class="o">=</span><span class="n">bandit</span><span class="o">.</span><span class="n">actions</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_recommendations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># sort actions by value and shuffle actions with same value</span>
        <span class="n">sorted_actions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sort_actions</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">action_values</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">])</span>
        <span class="c1"># choose recommendations</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">epsilon</span><span class="p">:</span>
            <span class="n">recs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">sorted_actions</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">slate_size</span><span class="p">:],</span>
                                    <span class="n">size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">slate_size</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">recs</span> <span class="o">=</span> <span class="n">sorted_actions</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">slate_size</span><span class="p">]</span>
        <span class="c1"># update history of action scores</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_scores_history</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">action_values</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">recs</span>

    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rewards</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">EpsilonGreedy</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">rewards</span><span class="p">)</span>
        <span class="c1"># update action values</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="p">(</span><span class="n">movieId</span><span class="p">,</span> <span class="n">reward</span><span class="p">)</span> <span class="ow">in</span> <span class="n">rewards</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">action_values</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">movieId</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">]</span>
            <span class="n">N</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">action_values</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">movieId</span><span class="p">,</span> <span class="s1">&#39;count&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">action_values</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">movieId</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">value</span> <span class="o">*</span> <span class="n">N</span> <span class="o">+</span> <span class="n">reward</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">N</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">action_values</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">movieId</span><span class="p">,</span> <span class="s1">&#39;count&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
    

<span class="c1"># Upper Confidence Bound Policy ######################################</span>

<span class="k">class</span> <span class="nc">UCB1</span><span class="p">(</span><span class="n">ABPolicy</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bandit</span><span class="p">,</span> <span class="n">slate_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">scores_logging</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">UCB1</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">bandit</span><span class="p">,</span> <span class="n">slate_size</span><span class="p">,</span> <span class="n">scores_logging</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;UCB1&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">action_values</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="s1">&#39;count&#39;</span><span class="p">],</span>
                                          <span class="n">index</span><span class="o">=</span><span class="n">bandit</span><span class="o">.</span><span class="n">actions</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_recommendations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># compute UCB for each action</span>
        <span class="n">current_step</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">current_step</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">scores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">action_values</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">N</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">current_step</span><span class="p">)</span> <span class="o">/</span> <span class="n">N</span><span class="p">)</span> <span class="k">if</span> <span class="n">N</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">Inf</span><span class="p">)</span>
            <span class="n">scores</span> <span class="o">=</span> <span class="n">scores</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">action_values</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">scores</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">Inf</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">action_values</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="c1"># sort actions by score and shuffle actions with same score</span>
        <span class="n">sorted_actions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sort_actions</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span>
        <span class="c1"># choose recommendations</span>
        <span class="n">recs</span> <span class="o">=</span> <span class="n">sorted_actions</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">slate_size</span><span class="p">]</span>
        <span class="c1"># update history of action scores</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_scores_history</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">recs</span>

    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rewards</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">UCB1</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">rewards</span><span class="p">)</span>
        <span class="c1"># update action values</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="p">(</span><span class="n">movieId</span><span class="p">,</span> <span class="n">reward</span><span class="p">)</span> <span class="ow">in</span> <span class="n">rewards</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">action_values</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">movieId</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">]</span>
            <span class="n">N</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">action_values</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">movieId</span><span class="p">,</span> <span class="s1">&#39;count&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">action_values</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">movieId</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">value</span> <span class="o">*</span> <span class="n">N</span> <span class="o">+</span> <span class="n">reward</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">N</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">action_values</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">movieId</span><span class="p">,</span> <span class="s1">&#39;count&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>


<span class="c1"># Thompson Sampling Policy ###########################################</span>

<span class="k">class</span> <span class="nc">TS</span><span class="p">(</span><span class="n">ABPolicy</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bandit</span><span class="p">,</span> <span class="n">slate_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">scores_logging</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TS</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">bandit</span><span class="p">,</span> <span class="n">slate_size</span><span class="p">,</span> <span class="n">scores_logging</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;Thompson Sampling&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">beta_params</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">,</span> <span class="s1">&#39;beta&#39;</span><span class="p">],</span>
                                        <span class="n">index</span><span class="o">=</span><span class="n">bandit</span><span class="o">.</span><span class="n">actions</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">get_recommendations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># sample expected value for each action</span>
        <span class="n">expected_values</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="mf">4.5</span> <span class="o">*</span> <span class="n">beta</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beta_params</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta_params</span><span class="p">[</span><span class="s1">&#39;beta&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">,</span>
            <span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">beta_params</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="c1"># sort actions by value and shuffle actions with same value</span>
        <span class="n">sorted_actions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sort_actions</span><span class="p">(</span><span class="n">expected_values</span><span class="p">)</span>
        <span class="c1"># choose recommendations</span>
        <span class="n">recs</span> <span class="o">=</span> <span class="n">sorted_actions</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">slate_size</span><span class="p">]</span>
        <span class="c1"># update history of action scores</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_scores_history</span><span class="p">(</span><span class="n">expected_values</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">recs</span>

    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rewards</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TS</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">rewards</span><span class="p">)</span>
        <span class="c1"># update action value distribution prior</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="p">(</span><span class="n">movieId</span><span class="p">,</span> <span class="n">reward</span><span class="p">)</span> <span class="ow">in</span> <span class="n">rewards</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">beta_params</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">movieId</span><span class="p">,</span> <span class="s1">&#39;alpha&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">reward</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">/</span> <span class="mf">4.5</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">beta_params</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">movieId</span><span class="p">,</span> <span class="s1">&#39;beta&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="mf">5.0</span> <span class="o">-</span> <span class="n">reward</span><span class="p">)</span> <span class="o">/</span> <span class="mf">4.5</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">ReplayBandit</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot; Implementation of a bandit problem with replay evaluation &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logged_events</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">events</span> <span class="o">=</span> <span class="n">logged_events</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;rating&#39;</span><span class="p">:</span> <span class="s1">&#39;reward&#39;</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">actions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">logged_events</span><span class="p">[</span><span class="s1">&#39;movieId&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="n">batch_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stream_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="p">)</span> <span class="o">//</span> <span class="n">batch_size</span>
    
    <span class="k">def</span> <span class="nf">get_rewards</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recommendations</span><span class="p">,</span> <span class="n">n_event</span><span class="p">):</span>
        <span class="c1"># generate events</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">n_event</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span>
        <span class="n">events</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">idx</span><span class="p">:</span><span class="n">idx</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">]</span>
        <span class="c1"># keep only events that match with the recommendation slate</span>
        <span class="n">rewards</span> <span class="o">=</span> <span class="n">events</span><span class="p">[</span><span class="n">events</span><span class="p">[</span><span class="s1">&#39;movieId&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">recommendations</span><span class="p">)]</span>
        <span class="k">return</span> <span class="n">rewards</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">bandit</span> <span class="o">=</span> <span class="n">ReplayBandit</span><span class="p">(</span><span class="n">logged_events</span><span class="p">,</span> <span class="n">BATCH_SIZE</span><span class="p">)</span>
<span class="n">STREAM_LENGTH</span> <span class="o">=</span> <span class="n">bandit</span><span class="o">.</span><span class="n">stream_length</span>
<span class="n">title</span><span class="o">=</span><span class="s2">&quot;rewards for bandit problem with replay evaluation&quot;</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;NUMBER OF MOVIES/ACTIONS: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bandit</span><span class="o">.</span><span class="n">actions</span><span class="p">)))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>NUMBER OF MOVIES/ACTIONS: 806
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># instantiate policies</span>
<span class="n">policies</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">EpsilonGreedy</span><span class="p">(</span><span class="n">bandit</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">slate_size</span><span class="o">=</span><span class="n">SLATE_SIZE</span><span class="p">,</span> <span class="n">scores_logging</span><span class="o">=</span><span class="n">SCORES_LOG</span><span class="p">),</span>
    <span class="n">UCB1</span><span class="p">(</span><span class="n">bandit</span><span class="p">,</span> <span class="n">slate_size</span><span class="o">=</span><span class="n">SLATE_SIZE</span><span class="p">,</span> <span class="n">scores_logging</span><span class="o">=</span><span class="n">SCORES_LOG</span><span class="p">),</span>
    <span class="n">TS</span><span class="p">(</span><span class="n">bandit</span><span class="p">,</span> <span class="n">slate_size</span><span class="o">=</span><span class="n">SLATE_SIZE</span><span class="p">,</span> <span class="n">scores_logging</span><span class="o">=</span><span class="n">SCORES_LOG</span><span class="p">),</span>
    <span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># evaluate policies</span>
<span class="k">for</span> <span class="n">policy</span> <span class="ow">in</span> <span class="n">policies</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;POLICY: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">policy</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">STREAM_LENGTH</span><span class="p">),</span> <span class="n">ascii</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">recs</span> <span class="o">=</span> <span class="n">policy</span><span class="o">.</span><span class="n">get_recommendations</span><span class="p">()</span>
        <span class="n">rewards</span> <span class="o">=</span> <span class="n">bandit</span><span class="o">.</span><span class="n">get_rewards</span><span class="p">(</span><span class="n">recs</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
        <span class="n">policy</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">rewards</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;HISTORY LENGTH: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">policy</span><span class="o">.</span><span class="n">history</span><span class="p">)))</span>
    <span class="nb">print</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  4%|3         | 9/241 [00:00&lt;00:02, 85.23it/s]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>POLICY: 0.1-Greedy
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100%|##########| 241/241 [00:02&lt;00:00, 81.60it/s]
  4%|3         | 9/241 [00:00&lt;00:02, 82.17it/s]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>HISTORY LENGTH: 133

POLICY: UCB1
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100%|##########| 241/241 [00:03&lt;00:00, 74.59it/s]
  3%|3         | 8/241 [00:00&lt;00:02, 78.25it/s]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>HISTORY LENGTH: 144

POLICY: Thompson Sampling
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100%|##########| 241/241 [00:03&lt;00:00, 78.49it/s]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>HISTORY LENGTH: 141
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># plot results</span>
<span class="n">plot_rewards</span><span class="p">(</span><span class="o">*</span><span class="n">policies</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">)</span>
<span class="k">if</span> <span class="n">SCORES_LOG</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">plot_action_values</span><span class="p">(</span><span class="o">*</span><span class="n">policies</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/T057885_Offline_Replayer_Evaluation_125_0.png" src="../_images/T057885_Offline_Replayer_Evaluation_125_0.png" />
</div>
</div>
</div>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./nbs"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        
            



<div class='prev-next-bottom'>
    
    <div id="prev">
        <a class="left-prev" href="T871537_Recommendation_Systems_using_Olist_Dataset.html" title="previous page">
            <i class="prevnext-label fas fa-angle-left"></i>
            <div class="prevnext-info">
                <p class="prevnext-label">previous</p>
                <p class="prevnext-title">Recommendation systems using Olist dataset</p>
            </div>
        </a>
    </div>
     <div id="next">
        <a class="right-next" href="T915054_method_for_effective_online_testing.html" title="next page">
            <div class="prevnext-info">
                <p class="prevnext-label">next</p>
                <p class="prevnext-title">Methods for effective online testing</p>
            </div>
            <i class="prevnext-label fas fa-angle-right"></i>
        </a>
     </div>

</div>
        
        </div>
    </div>
    <footer class="footer">
    <div class="container">
      <p>
        
          By Sparsh A.<br/>
        
            &copy; Copyright 2021.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>
  
  <script src="../_static/js/index.1c5a1a01449ed65a7b51.js"></script>

  
  </body>
</html>