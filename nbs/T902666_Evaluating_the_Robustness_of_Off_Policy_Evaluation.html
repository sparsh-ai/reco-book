
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Evaluating the Robustness of Off-Policy Evaluation &#8212; Reco Book</title>
    
  <link href="../_static/css/theme.css" rel="stylesheet" />
  <link href="../_static/css/index.c5995385ac14fb8791e8eb36b4908be2.css" rel="stylesheet" />

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/sphinx-book-theme.css?digest=c3fdc42140077d1ad13ad2f1588a4309" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../_static/js/index.1c5a1a01449ed65a7b51.js">

    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/togglebutton.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/sphinx-book-theme.12a9622fbb08dcb3a2a40b2c02b83a57.js"></script>
    <script async="async" src="https://unpkg.com/thebe@0.5.1/lib/index.js"></script>
    <script >
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Evaluation of Multiple Off-Policy Estimators on Synthetic Dataset" href="T705904_Evaluation_of_Multiple_Off_Policy_Estimators_on_Synthetic_Dataset.html" />
    <link rel="prev" title="Adaptive Estimator Selection for Off-Policy Evaluation" href="T471827_Adaptive_Estimator_Selection_for_Off_Policy_Evaluation.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
      
      
      <h1 class="site-logo" id="site-title">Reco Book</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../index.html">
   Tutorials in Jupyter notebook format
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  User Stories
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="US780867_Transformer_based_Recommenders.html">
   Transformer-based Recommenders
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="T034923_BERT4Rec_on_ML1M_in_PyTorch.html">
     BERT4Rec on ML-1M in PyTorch
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="T595874_BERT4Rec_on_ML25M_in_PyTorch_Lightning.html">
     BERT4Rec on ML-25M
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="T088416_BST_Implementation_in_MXNet.html">
     BST Implementation in MXNet
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="T602245_BST_implementation_in_PyTorch.html">
     BST implementation in PyTorch
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="T007665_BST_on_ML1M_in_Keras.html">
     A Transformer-based recommendation system
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="T881207_BST_PTLightning_ML1M.html">
     Rating prediction using the Behavior Sequence Transformer (BST) model on ML-1M dataset in PyTorch Lightning
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="T757997_SASRec_PyTorch.html">
     SASRec implementation with PyTorch Library
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="T225287_SASRec_PaddlePaddle.html">
     SASRec implementation with Paddle Library
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="T701627_SR_SAN_Session_based_Model.html">
     SR-SAN Session-based Recommender
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="T975104_SSEPT_ML1M_Tensorflow1x.html">
     SSE-PT Personalized Transformer Recommender on ML-1M in Tensorflow 1.x
    </a>
   </li>
  </ul>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Prototypes
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="T382881_DeepWalk_Karateclub.html">
   DeepWalk from scratch referencing Karateclub library
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T384270_DeepWalk_pure_python.html">
   DeepWalk in pure python
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T677598_Jaccard_Cosine_SVD_DeepWalk_ML100K.html">
   Recommender System with DeepWalk Graph Embeddings
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T815556_Node2vec_Karateclub.html">
   Node2vec from scratch referencing Karateclub library
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T894941_Node2vec_MovieLens_Keras.html">
   Graph representation learning with node2vec
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T611050_Node2vec_PyG.html">
   Node2vec from scratch in PyTorch Geometric
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T186367_Node2vec_library.html">
   Node2vec from scratch referencing node2vec library
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T331379_bayesian_personalized_ranking.html">
   BPR from scratch
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T081831_Data_Poisoning_Attacks_on_Factorization_Based_Collaborative_Filtering.html">
   Data Poisoning Attacks on Factorization-Based Collaborative Filtering
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T102448_Adversarial_Learning_for_Recommendation.html">
   Adversarial Training (Regularization) on a Recommender System
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T865035_Simulating_Data_Poisoning_Attacks_against_Twitter_Recommender.html">
   Load and process dataset
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T711285_Data_Poisoning_Attack_using_LFM_and_ItemAE_on_Synthetic_Dataset.html">
   Injection attack using LFM and ItemAE model trained on Toy dataset
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T355514_Black_box_Attack_on_Sequential_Recs.html">
   Black-box Attack on Sequential Recs
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T873451_Statistics_fundamentals.html">
   Statictics Fundamentals
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T890478_Batch_Learning_from_Bandit_Feedback_%28BLBF%29.html">
   Imports
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T257798_Off_Policy_Learning_in_Two_stage_Recommender_Systems.html">
   Off-Policy Learning in Two-stage Recommender Systems
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T471827_Adaptive_Estimator_Selection_for_Off_Policy_Evaluation.html">
   Adaptive Estimator Selection for Off-Policy Evaluation
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Evaluating the Robustness of Off-Policy Evaluation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T705904_Evaluation_of_Multiple_Off_Policy_Estimators_on_Synthetic_Dataset.html">
   Evaluation of Multiple Off-Policy Estimators on Synthetic Dataset
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T874693_Evaluating_Standard_Off_Policy_Estimators_with_Small_Sample_Open_Bandit_Dataset.html">
   Evaluating Standard Off-Policy Estimators with Small Sample Open-Bandit Dataset
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T792262_Optimal_Off_Policy_Evaluation_from_Multiple_Logging_Policies.html">
   Optimal Off-Policy Evaluation from Multiple Logging Policies
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T167249_Offline_Policy_Evaluation_with_VW_Command_Line.html">
   Offline Policy Evaluation with VW Command Line
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T966055_OBP_Library_Workshop_Tutorials.html">
   OBP Library Workshop Tutorials
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T632722_PyTorch_Fundamentals_Part_1.html">
   PyTorch Fundamentals Part 1
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T472467_PyTorch_Fundamentals_Part_2.html">
   PyTorch Fundamentals Part 2
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T206654_PyTorch_Fundamentals_Part_3.html">
   PyTorch Fundamentals Part 3
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T536348_Attention_Mechanisms.html">
   Imports
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T500796_Agricultural_Satellite_Image_Segmentation.html">
   Agricultural Satellite Image Segmentation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T611432_Image_Analysis_with_Tensorflow.html">
   Image Analysis with Tensorflow
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T925716_MongoDB_to_CSV_Conversion.html">
   MongoDB to CSV conversion
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T396469_PDF_to_Word_Cloud_via_Email.html">
   PDF to WordCloud via Email
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T030890_Job_Scraping_and_Clustering.html">
   Job scraping and clustering
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T897054_Scene_Text_Recognition.html">
   Scene Text Recognition
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T034809_Large_scale_Document_Retrieval_with_Elastic_Search.html">
   Large-scale Document Retrieval with ElasticSearch
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T467251_vowpal_wabbit_contextual_recommender.html">
   Simulating a news personalization scenario using Contextual Bandits
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T686684_similar_product_recommender.html">
   Similar Product Recommender system using Deep Learning for an online e-commerce store
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T132203_Retail_Product_Recommendations_using_Word2vec.html">
   Retail Product Recommendations using word2vec
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T501828_Recommender_Implicit_Negative_Feedback.html">
   Retail Product Recommendation with Negative Implicit Feedback
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T315965_Sequence_Aware_Recommenders_Music.html">
   Sequence Aware Recommender Systems
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T051777_image_similarity_recommendations.html">
   Similar Product Recommendations
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990172_recobook_diversity_aware_book_recommender.html">
   Diversity Aware Book Recommender
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T488549_Goodreads_Diversity_Aware_Book_Recommender.html">
   Diversity Aware Book Recommender
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T023535_Kafka_MongoDB_Real_time_Streaming.html">
   Kafka MongoDB Real-time Streaming
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T622304_Session_based_Recommender_Using_Word2vec.html">
   Session-based recommendation using word2vec
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T416854_bandit_based_recommender_using_thompson_sampling_app.html">
   Bandit-based Online Learning using Thompson Sampling
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T198578_Booking_dot_com_Trip_Recommendation.html">
   Booking.com Trip Recommendation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T519734_Vowpal_Wabbit_Contextual_Bandit.html">
   Vowpal Wabbit Contextual Bandit
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T871537_Recommendation_Systems_using_Olist_Dataset.html">
   Recommendation systems using Olist dataset
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T057885_Offline_Replayer_Evaluation.html">
   Offline Replayer Evaluation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T915054_method_for_effective_online_testing.html">
   Methods for effective online testing
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T513987_Recsys_2020_Feature_Engineering_Tutorial.html">
   Recsys’20 Feature Engineering Tutorial
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T227901_amazon_personalize_batch_job.html">
   Amazon Personalize Batch Job
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T022961_Amazon_Personalize_Workshop.html">
   Amazon Personalize Workshop
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T424437_Collaborative_Filtering_on_ML_latest_small.html">
   Collaborative Filtering on ML-latest-small
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T539160_Building_and_Deploying_ASOS_Fashion_Recommender.html">
   Building and deploying ASOS fashion recommender
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T757697_Simple_Similarity_based_Recommender.html">
   Simple Similarity based Recommmendations
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T051594_Analytics_Zoo.html">
   Analytics Zoo
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T313645_A_B_Testing.html">
   A/B Testing
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T475711_PinSage_Graph_based_Recommender.html">
   PinSage Graph-based Recommender
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T516490_Graph_Embeddings.html">
   Learn Embeddings using Graph Networks
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T822164_movielens_milvus_redis_efficient_retrieval.html">
   Recommender with Redis and Milvus
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T845186_Anime_Recommender.html">
   RekoNet Anime Recommender
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T855843_kafka_spark_streaming_colab.html">
   Kafka and Spark Streaming in Colab
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T460437_Building_Models_From_Scratch.html">
   Building Models from scratch
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T855971_Conet_Model_for_Movie_Recommender.html">
   CoNet model
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T996996_content_based_and_collaborative_movielens.html">
   Movie Recommendation with Content-Based and Collaborative Filtering
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T239418_Simple_Movie_Recommenders.html">
   Simple Movie Recommenders
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T138337_Simple_Movie_Recommender.html">
   Simple movie recommender in implicit, explicit, and cold-start settings
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T935440_The_importance_of_Rating_Normalization.html">
   The importance of Rating Normalization
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T612622_cornac_examples.html">
   Cornac Examples
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T561435_Flower_Classification.html">
   Flower classification
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T680910_Trivago_Session_based_Recommender.html">
   Trivago Session-based Recommender
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990000_ads_selection_using_bandits.html">
   Best Ads detection using bandit methods
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990000_book_crossing_surprise_svd_nmf.html">
   Book-Crossing Recommendation System
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990000_book_recommender_kubeflow.html">
   Books recommendations with Kubeflow Pipelines on Scaleway Kapsule
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990000_build_a_kubeflow_pipeline.html">
   Build a Kubeflow Pipeline
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990000_causal_inference.html">
   Causal Inference
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990000_concept_embedding_nlp.html">
   Exploring Word Embeddings
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990000_concept_neural_net.html">
   Neural Network
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990000_concept_nlp_basics.html">
   Natural Language Processing 101
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990000_concept_transformer_lm.html">
   TransformerLM Quick Start and Guide
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990000_content_based_music_recommender_lyricsfreak.html">
   Content-based method for song recommendation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990000_evaluation_metrics_basics.html">
   Recommender System Evaluations
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990000_implicit_synthetic.html">
   Comparing Implicit Models on Synthetic Data
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990000_movie_recommender_tensorflow.html">
   Recommendation Systems with TensorFlow
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990000_movie_recommender_tensorflow_sagemaker.html">
   Movie recommender using Tensorflow in Sagemaker
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990000_movielens_eda_modeling.html">
   Movielens EDA and Modeling
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990000_read_data_from_cassandra_into_pandas.html">
   Read Cassandra Data Snapshot as DataFrame
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990000_rl_in_action.html">
   Reinforcement Learning fundamentals in action
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990000_rnn_cnn_basics.html">
   Processing sequences using RNNs and CNNs
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990000_tf_serving_in_action.html">
   TF Serving in action
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990000_training_indexing_movie_recommender.html">
   Training and indexing movie recommender
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T207114_EduRec_MOOCCube_Course_Recommender.html">
   EduRec MOOCCube Course Recommender
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T273184_Multi_Task_Learning.html">
   Multi-task Learning
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T661108_Book_Recommender_API.html">
   Book Recommender API
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T912764_Simple_Movie_Recommender_App.html">
   Simple Movie Recommender App
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T964554_Career_Village_Questions_Recommendation.html">
   CareerVillage Questions Recommendation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990001_amazon_women_apparel_tfidf_word2vec.html">
   Amazon Product Recommender
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990001_anime_recommender_graph_network.html">
   Anime Recommender with Bi-partite Graph Network
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990001_concept_self_attention.html">
   Self-Attention
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990001_course_recommender_svd_flask.html">
   Course Recommender with SVD based similarity
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990001_data_mining_similarity_measures.html">
   Concept - Data Mining Similarity Measures
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990001_jaccard_recommender.html">
   Jaccard Similarity based Recommender
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990001_live_streamer_recommender.html">
   Live Streamer Recommender with Implicit feedback
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990001_songs_embedding_skipgram_recommender.html">
   Song Embeddings - Skipgram Recommender
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990001_toy_example_car_recommender_knn.html">
   Toy example - Car Recommender using KNN method
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990001_wikirecs_recommender.html">
   WikiRecs
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../_sources/nbs/T902666_Evaluating_the_Robustness_of_Off_Policy_Evaluation.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/sparsh-ai/reco-book/main?urlpath=tree/nbs/T902666_Evaluating_the_Robustness_of_Off_Policy_Evaluation.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="../_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav" aria-label="Page">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#setup">
   Setup
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#imports">
   Imports
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#utils">
   Utils
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#ope-evaluators">
   OPE Evaluators
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#example-1-synthetic-dataset">
   Example 1 - Synthetic dataset
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#data-preparation">
     Data Preparation
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#setting-hyperparameter-spaces-for-off-policy-evaluation">
     Setting Hyperparameter Spaces for Off-Policy Evaluation
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#interpretable-evaluation-for-off-policy-evaluation">
     Interpretable Evaluation for Off-Policy Evaluation
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#example-2-synthetic-p-score">
   Example 2 - Synthetic P-Score
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id1">
     Data Preparation
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id2">
     Setting Hyperparameter Spaces for Off-Policy Evaluation
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id3">
     Interpretable Evaluation for Off-Policy Evaluation
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#example-3-synthetic-rscv">
   Example 3 - Synthetic RSCV
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id4">
     Data Preparation
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id5">
     Setting Hyperparameter Spaces for Off-Policy Evaluation
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id6">
     Interpretable Evaluation for Off-Policy Evaluation
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#example-4-multiclass-dataset">
   Example 4 - Multiclass dataset
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id7">
     Data Preparation
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id8">
     Setting Hyperparameter Spaces for Off-Policy Evaluation
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id9">
     Interpretable Evaluation for Off-Policy Evaluation
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#example-5-multiclass-p-score">
   Example 5 - Multiclass P-Score
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id10">
     Data Preparation
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id11">
     Setting Hyperparameter Spaces for Off-Policy Evaluation
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id12">
     Interpretable Evaluation for Off-Policy Evaluation
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#example-6-multiclass-rscv">
   Example 6 - Multiclass RSCV
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id13">
     Data Preparation
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id14">
     Setting Hyperparameter Spaces for Off-Policy Evaluation
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id15">
     Interpretable Evaluation for Off-Policy Evaluation
    </a>
   </li>
  </ul>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <p><a href="https://colab.research.google.com/github/sparsh-ai/reco-book/blob/stage/nbs/T902666_Evaluating_the_Robustness_of_Off_Policy_Evaluation.ipynb" target="_parent"><img src="https://colab.research.google.com/assets/colab-badge.svg" alt="Open In Colab"/></a></p>
<div class="section" id="evaluating-the-robustness-of-off-policy-evaluation">
<h1>Evaluating the Robustness of Off-Policy Evaluation<a class="headerlink" href="#evaluating-the-robustness-of-off-policy-evaluation" title="Permalink to this headline">¶</a></h1>
<div class="section" id="setup">
<h2>Setup<a class="headerlink" href="#setup" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>!pip install -q obp
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>!pip install matplotlib==3.1.1
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>!pip install -U pandas
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="imports">
<h2>Imports<a class="headerlink" href="#imports" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">abc</span> <span class="kn">import</span> <span class="n">ABCMeta</span><span class="p">,</span> <span class="n">abstractmethod</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Union</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">loguniform</span>

<span class="kn">from</span> <span class="nn">inspect</span> <span class="kn">import</span> <span class="n">isclass</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Dict</span>
<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">from</span> <span class="nn">sklearn.base</span> <span class="kn">import</span> <span class="n">BaseEstimator</span><span class="p">,</span> <span class="n">clone</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection._search</span> <span class="kn">import</span> <span class="n">BaseSearchCV</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">roc_auc_score</span><span class="p">,</span>
    <span class="n">log_loss</span><span class="p">,</span>
    <span class="n">mean_squared_error</span> <span class="k">as</span> <span class="n">calc_mse</span><span class="p">,</span>
    <span class="n">mean_absolute_error</span> <span class="k">as</span> <span class="n">calc_mae</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">obp.ope</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">RegressionModel</span><span class="p">,</span>
    <span class="n">OffPolicyEvaluation</span><span class="p">,</span>
    <span class="n">BaseOffPolicyEstimator</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">obp.types</span> <span class="kn">import</span> <span class="n">BanditFeedback</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">sklearn.datasets</span> <span class="kn">import</span> <span class="n">load_digits</span>
<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LogisticRegression</span>
<span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">RandomForestClassifier</span> <span class="k">as</span> <span class="n">RandomForest</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">RandomizedSearchCV</span>

<span class="kn">import</span> <span class="nn">obp</span>
<span class="kn">from</span> <span class="nn">obp.dataset</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">SyntheticBanditDataset</span><span class="p">,</span>
    <span class="n">logistic_reward_function</span><span class="p">,</span>
    <span class="n">linear_behavior_policy</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">obp.policy</span> <span class="kn">import</span> <span class="n">IPWLearner</span>
<span class="kn">from</span> <span class="nn">obp.ope</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">DirectMethod</span><span class="p">,</span>
    <span class="n">DoublyRobust</span><span class="p">,</span>
    <span class="n">DoublyRobustWithShrinkage</span><span class="p">,</span>
    <span class="n">InverseProbabilityWeighting</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">obp.dataset</span> <span class="kn">import</span> <span class="n">MultiClassToBanditReduction</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">sklearn.exceptions</span> <span class="kn">import</span> <span class="n">ConvergenceWarning</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="n">action</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="n">ConvergenceWarning</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="utils">
<h2>Utils<a class="headerlink" href="#utils" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">_choose_uniform</span><span class="p">(</span>
    <span class="n">s</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">lower</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
    <span class="n">upper</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
    <span class="n">type_</span><span class="p">:</span> <span class="nb">type</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="n">s</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">lower</span> <span class="o">&lt;=</span> <span class="n">upper</span><span class="p">,</span> <span class="s2">&quot;`upper` must be larger than or equal to `lower`&quot;</span>
    <span class="k">assert</span> <span class="n">type_</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span> <span class="sa">f</span><span class="s2">&quot;`type_` must be int or float but </span><span class="si">{</span><span class="n">type_</span><span class="si">}</span><span class="s2"> is given&quot;</span>
    <span class="k">if</span> <span class="n">lower</span> <span class="o">==</span> <span class="n">upper</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">lower</span>
    <span class="k">if</span> <span class="n">type_</span> <span class="o">==</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="n">lower</span><span class="p">,</span> <span class="n">upper</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">type_</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># type_ == float:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">lower</span><span class="p">,</span> <span class="n">upper</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_choose_log_uniform</span><span class="p">(</span>
    <span class="n">s</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">lower</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
    <span class="n">upper</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
    <span class="n">type_</span><span class="p">:</span> <span class="nb">type</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
    <span class="k">assert</span> <span class="p">(</span>
        <span class="n">lower</span> <span class="o">&gt;</span> <span class="mi">0</span>
    <span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;`lower` must be greater than 0 when drawing from log uniform distribution but </span><span class="si">{</span><span class="n">lower</span><span class="si">}</span><span class="s2"> is given&quot;</span>
    <span class="k">assert</span> <span class="n">lower</span> <span class="o">&lt;=</span> <span class="n">upper</span><span class="p">,</span> <span class="s2">&quot;`upper` must be larger than or equal to `lower`&quot;</span>
    <span class="k">assert</span> <span class="n">type_</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span> <span class="sa">f</span><span class="s2">&quot;`type_` must be int or float but </span><span class="si">{</span><span class="n">type_</span><span class="si">}</span><span class="s2"> is given&quot;</span>
    <span class="k">if</span> <span class="n">lower</span> <span class="o">==</span> <span class="n">upper</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">lower</span>
    <span class="k">if</span> <span class="n">type_</span> <span class="o">==</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">loguniform</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">lower</span><span class="p">,</span> <span class="n">upper</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">s</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># type_ == float:</span>
        <span class="k">return</span> <span class="n">loguniform</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">lower</span><span class="p">,</span> <span class="n">upper</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">s</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="ope-evaluators">
<h2>OPE Evaluators<a class="headerlink" href="#ope-evaluators" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">BaseOPEEvaluator</span><span class="p">(</span><span class="n">metaclass</span><span class="o">=</span><span class="n">ABCMeta</span><span class="p">):</span>
    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">estimate_policy_value</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Estimate policy values.&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">calculate_squared_error</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate squared errors.&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">visualize_cdf</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Create graph of cumulative distribution function of an estimator.&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">visualize_cdf_aggregate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Create graph of cumulative distribution function of all estimators.&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">save_policy_value</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Save estimate policy values to csv file.&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">save_squared_error</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Save squared errors to csv file.&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">calculate_au_cdf_score</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate AU-CDF score.&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">calculate_cvar_score</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate CVaR score.&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">COLORS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;lightcoral&quot;</span><span class="p">,</span>
    <span class="s2">&quot;plum&quot;</span><span class="p">,</span>
    <span class="s2">&quot;lightgreen&quot;</span><span class="p">,</span>
    <span class="s2">&quot;lightskyblue&quot;</span><span class="p">,</span>
    <span class="s2">&quot;lightsalmon&quot;</span><span class="p">,</span>
    <span class="s2">&quot;orange&quot;</span><span class="p">,</span>
    <span class="s2">&quot;forestgreen&quot;</span><span class="p">,</span>
    <span class="s2">&quot;royalblue&quot;</span><span class="p">,</span>
    <span class="s2">&quot;gold&quot;</span><span class="p">,</span>
    <span class="s2">&quot;blueviolet&quot;</span><span class="p">,</span>
    <span class="s2">&quot;fuchsia&quot;</span><span class="p">,</span>
    <span class="s2">&quot;lightpink&quot;</span><span class="p">,</span>
    <span class="s2">&quot;firebrick&quot;</span><span class="p">,</span>
    <span class="s2">&quot;peru&quot;</span><span class="p">,</span>
    <span class="s2">&quot;darkkhaki&quot;</span><span class="p">,</span>
    <span class="s2">&quot;darkolivegreen&quot;</span><span class="p">,</span>
    <span class="s2">&quot;navy&quot;</span><span class="p">,</span>
    <span class="s2">&quot;deeppink&quot;</span><span class="p">,</span>
    <span class="s2">&quot;black&quot;</span><span class="p">,</span>
    <span class="s2">&quot;silver&quot;</span><span class="p">,</span>
<span class="p">]</span>

<span class="n">LINESTYLES</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;solid&quot;</span><span class="p">,</span>
    <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">)),</span>
    <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">)),</span>
    <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">1.8</span><span class="p">)),</span>
    <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">2.4</span><span class="p">)),</span>
    <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)),</span>
<span class="p">]</span>


<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">InterpretableOPEEvaluator</span><span class="p">(</span><span class="n">BaseOPEEvaluator</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Class to carry out Interpretable OPE Evaluation.</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    random_states: np.ndarray</span>
<span class="sd">        list of integers representing random states</span>
<span class="sd">        length of random_states corresponds to the number of runs</span>
<span class="sd">    bandit_feedbacks: List[BanditFeedback]</span>
<span class="sd">        list of bandit feedbacks</span>
<span class="sd">    evaluation_policies: List[Tuple[float, np.ndarray]]</span>
<span class="sd">        list of tuples representing evaluation policies</span>
<span class="sd">        first entry in tuple represents the ground truth policy value</span>
<span class="sd">        second entry in tuple represents action distribution of evaluation policy</span>
<span class="sd">    ope_estimators: List[BaseOffPolicyEstimator]</span>
<span class="sd">        list of ope estimators from obp.ope</span>
<span class="sd">    ope_estimator_hyperparams: dict</span>
<span class="sd">        dictionary storing hyperparameters for ope estimators</span>
<span class="sd">        must be in the following format</span>
<span class="sd">            ope_estimator_hyperparams = dict(</span>
<span class="sd">                [OffPolicyEstimator].estimator_name = dict(</span>
<span class="sd">                    [parameter_name] = dict(</span>
<span class="sd">                        &quot;lower&quot;:</span>
<span class="sd">                        &quot;upper&quot;:</span>
<span class="sd">                        &quot;log&quot;:</span>
<span class="sd">                        &quot;type&quot;:</span>
<span class="sd">                    )</span>
<span class="sd">                ),</span>
<span class="sd">            )</span>
<span class="sd">    regression_models: Optional[List[Union[BaseEstimator, BaseSearchCV]]]</span>
<span class="sd">        list of regression models to be used in off policy evaluation</span>
<span class="sd">        each element must either be of type BaseEstimator or BaseSearchCV</span>
<span class="sd">    regression_model_hyperparams: dict</span>
<span class="sd">        dictionary storing hyperparameters for regression models</span>
<span class="sd">        must be in the following format</span>
<span class="sd">            regression_model_hyperparams = dict(</span>
<span class="sd">                [model_name] = dict(</span>
<span class="sd">                    [parameter_name] = dict(</span>
<span class="sd">                        &quot;lower&quot;:</span>
<span class="sd">                        &quot;upper&quot;:</span>
<span class="sd">                        &quot;log&quot;:</span>
<span class="sd">                        &quot;type&quot;:</span>
<span class="sd">                    )</span>
<span class="sd">                ),</span>
<span class="sd">            )</span>
<span class="sd">    pscore_estimators: Optional[List[Union[BaseEstimator, BaseSearchCV]]]</span>
<span class="sd">        list of classification models to be used in estimating propensity scores of behavior policy</span>
<span class="sd">        each element must either be of type BaseEstimator or BaseSearchCV</span>
<span class="sd">    pscore_estimator_hyperparams: dict</span>
<span class="sd">        dictionary storing hyperparameters for pscore estimators</span>
<span class="sd">        must be in the following format</span>
<span class="sd">            pscore_estimator_hyperparams = dict(</span>
<span class="sd">                [model_name] = dict(</span>
<span class="sd">                    [parameter_name] = dict(</span>
<span class="sd">                        &quot;lower&quot;:</span>
<span class="sd">                        &quot;upper&quot;:</span>
<span class="sd">                        &quot;log&quot;:</span>
<span class="sd">                        &quot;type&quot;:</span>
<span class="sd">                    )</span>
<span class="sd">                ),</span>
<span class="sd">            )</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">random_states</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
    <span class="n">ope_estimators</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">BaseOffPolicyEstimator</span><span class="p">]</span>
    <span class="n">bandit_feedbacks</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">BanditFeedback</span><span class="p">]</span>
    <span class="n">evaluation_policies</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]</span>
    <span class="n">ope_estimator_hyperparams</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">regression_models</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">BaseEstimator</span><span class="p">,</span> <span class="n">BaseSearchCV</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">regression_model_hyperparams</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">pscore_estimators</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">BaseEstimator</span><span class="p">,</span> <span class="n">BaseSearchCV</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">pscore_estimator_hyperparams</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">estimator_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">est</span><span class="o">.</span><span class="n">estimator_name</span> <span class="k">for</span> <span class="n">est</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ope_estimators</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">policy_value</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bandit_feedbacks</span><span class="p">)):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bandit_feedbacks</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;position&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bandit_feedbacks</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;position&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">bandit_feedbacks</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;action&quot;</span><span class="p">],</span>
                    <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
                <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reward_type</span> <span class="o">==</span> <span class="s2">&quot;binary&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reg_model_metric_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;auc&quot;</span><span class="p">,</span> <span class="s2">&quot;rel_ce&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reg_model_metric_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;rel_mse&quot;</span><span class="p">,</span> <span class="s2">&quot;rel_mae&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">ope_estimator_hyperparams</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ope_estimator_hyperparams</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">estimator_name</span><span class="p">:</span> <span class="nb">dict</span><span class="p">()</span> <span class="k">for</span> <span class="n">estimator_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">estimator_names</span>
            <span class="p">}</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">regression_model_hyperparams</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">regression_model_hyperparams</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">regression_model</span><span class="p">:</span> <span class="nb">dict</span><span class="p">()</span> <span class="k">for</span> <span class="n">regression_model</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">regression_models</span>
            <span class="p">}</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pscore_estimators</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">pscore_estimator_hyperparams</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pscore_estimator_hyperparams</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">pscore_estimator</span><span class="p">:</span> <span class="nb">dict</span><span class="p">()</span> <span class="k">for</span> <span class="n">pscore_estimator</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pscore_estimators</span>
            <span class="p">}</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">n_runs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Number of iterations.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">random_states</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">n_rounds</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Number of observations in each given bandit_feedback in self.bandit_feedbacks&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span>
            <span class="p">[</span><span class="n">bandit_feedback</span><span class="p">[</span><span class="s2">&quot;n_rounds&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">bandit_feedback</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bandit_feedbacks</span><span class="p">]</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">n_actions</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Number of actions in each given bandit_feedback in self.bandit_feedbacks&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span>
            <span class="p">[</span><span class="n">bandit_feedback</span><span class="p">[</span><span class="s2">&quot;n_actions&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">bandit_feedback</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bandit_feedbacks</span><span class="p">]</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">reward_type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Whether the reward is binary or continuous&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bandit_feedbacks</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;reward&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;binary&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;continuous&quot;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">len_list</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Number of positions in each given bandit_feedback in self.bandit_feedbacks&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="nb">int</span><span class="p">(</span><span class="n">bandit_feedback</span><span class="p">[</span><span class="s2">&quot;position&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">bandit_feedback</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bandit_feedbacks</span>
            <span class="p">]</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">estimate_policy_value</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">n_folds_</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
        <span class="n">sample_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Estimates the policy values using selected ope estimators under a range of environments.&quot;&quot;&quot;</span>
        <span class="c1"># initialize dictionaries to store results</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">policy_value</span> <span class="o">=</span> <span class="p">{</span><span class="n">est</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_runs</span><span class="p">)</span> <span class="k">for</span> <span class="n">est</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">estimator_names</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">squared_error</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">est</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_runs</span><span class="p">)</span> <span class="k">for</span> <span class="n">est</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">estimator_names</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reg_model_metrics</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">metric</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_runs</span><span class="p">)</span> <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg_model_metric_names</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tqdm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">random_states</span><span class="p">)):</span>
            <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="n">s</span><span class="p">)</span>
            <span class="c1"># randomly select bandit_feedback</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bandit_feedback</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_choose_bandit_feedback</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pscore_estimators</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># randomly choose pscore estimator</span>
                <span class="n">pscore_estimator</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pscore_estimators</span><span class="p">)</span>
                <span class="c1"># randomly choose hyperparameters of pscore estimator</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pscore_estimator</span><span class="p">,</span> <span class="n">BaseEstimator</span><span class="p">):</span>
                    <span class="n">classifier</span> <span class="o">=</span> <span class="n">pscore_estimator</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="n">classifier</span><span class="p">,</span> <span class="s2">&quot;random_state&quot;</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">isclass</span><span class="p">(</span><span class="n">pscore_estimator</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">issubclass</span><span class="p">(</span>
                    <span class="n">pscore_estimator</span><span class="p">,</span> <span class="n">BaseEstimator</span>
                <span class="p">):</span>
                    <span class="n">pscore_estimator_hyperparam</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_choose_pscore_estimator_hyperparam</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">pscore_estimator</span><span class="p">)</span>
                    <span class="p">)</span>
                    <span class="n">classifier</span> <span class="o">=</span> <span class="n">clone</span><span class="p">(</span><span class="n">pscore_estimator</span><span class="p">(</span><span class="o">**</span><span class="n">pscore_estimator_hyperparam</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;pscore_estimator must be BaseEstimator or BaseSearchCV, but </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">pscore_estimator</span><span class="p">)</span><span class="si">}</span><span class="s2"> is given.&quot;</span>
                    <span class="p">)</span>
                <span class="c1"># fit classifier</span>
                <span class="n">classifier</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">bandit_feedback</span><span class="p">[</span><span class="s2">&quot;context&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">bandit_feedback</span><span class="p">[</span><span class="s2">&quot;action&quot;</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="n">estimated_pscore</span> <span class="o">=</span> <span class="n">classifier</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">bandit_feedback</span><span class="p">[</span><span class="s2">&quot;context&quot;</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="c1"># replace pscore in bootstrap bandit feedback with estimated pscore</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bandit_feedback</span><span class="p">[</span><span class="s2">&quot;pscore&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">estimated_pscore</span><span class="p">[</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bandit_feedback</span><span class="p">[</span><span class="s2">&quot;n_rounds&quot;</span><span class="p">]),</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">bandit_feedback</span><span class="p">[</span><span class="s2">&quot;action&quot;</span><span class="p">],</span>
                <span class="p">]</span>

            <span class="c1"># randomly sample from selected bandit_feedback</span>
            <span class="n">bootstrap_bandit_feedback</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sample_bootstrap_bandit_feedback</span><span class="p">(</span>
                <span class="n">s</span><span class="p">,</span> <span class="n">sample_size</span>
            <span class="p">)</span>
            <span class="c1"># randomly choose hyperparameters of ope estimators</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_choose_ope_estimator_hyperparam</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="c1"># randomly choose regression model</span>
            <span class="n">regression_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_choose_regression_model</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="c1"># randomly choose hyperparameters of regression models</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">regression_model</span><span class="p">,</span> <span class="n">BaseEstimator</span><span class="p">):</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="n">regression_model</span><span class="p">,</span> <span class="s2">&quot;random_state&quot;</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">isclass</span><span class="p">(</span><span class="n">regression_model</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">issubclass</span><span class="p">(</span>
                <span class="n">regression_model</span><span class="p">,</span> <span class="n">BaseEstimator</span>
            <span class="p">):</span>
                <span class="n">regression_model_hyperparam</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_choose_regression_model_hyperparam</span><span class="p">(</span>
                    <span class="n">s</span><span class="p">,</span> <span class="n">regression_model</span>
                <span class="p">)</span>
                <span class="n">regression_model</span> <span class="o">=</span> <span class="n">regression_model</span><span class="p">(</span><span class="o">**</span><span class="n">regression_model_hyperparam</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;regression_model must be BaseEstimator or BaseSearchCV, but </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">regression_model</span><span class="p">)</span><span class="si">}</span><span class="s2"> is given.&quot;</span>
                <span class="p">)</span>
            <span class="c1"># randomly choose evaluation policy</span>
            <span class="n">ground_truth</span><span class="p">,</span> <span class="n">bootstrap_action_dist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_choose_evaluation_policy</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="c1"># randomly choose number of folds</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">n_folds_</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">n_folds</span> <span class="o">=</span> <span class="n">_choose_uniform</span><span class="p">(</span>
                    <span class="n">s</span><span class="p">,</span>
                    <span class="n">n_folds_</span><span class="p">[</span><span class="s2">&quot;lower&quot;</span><span class="p">],</span>
                    <span class="n">n_folds_</span><span class="p">[</span><span class="s2">&quot;upper&quot;</span><span class="p">],</span>
                    <span class="n">n_folds_</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">],</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">n_folds</span> <span class="o">=</span> <span class="n">n_folds_</span>
            <span class="c1"># estimate policy value using each ope estimator under setting s</span>
            <span class="p">(</span>
                <span class="n">policy_value_s</span><span class="p">,</span>
                <span class="n">estimated_rewards_by_reg_model_s</span><span class="p">,</span>
            <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_estimate_policy_value_s</span><span class="p">(</span>
                <span class="n">s</span><span class="p">,</span>
                <span class="n">bootstrap_bandit_feedback</span><span class="p">,</span>
                <span class="n">regression_model</span><span class="p">,</span>
                <span class="n">bootstrap_action_dist</span><span class="p">,</span>
                <span class="n">n_folds</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="c1"># calculate squared error for each ope estimator</span>
            <span class="n">squared_error_s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_squared_error_s</span><span class="p">(</span>
                <span class="n">policy_value_s</span><span class="p">,</span>
                <span class="n">ground_truth</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="c1"># evaluate the performance of reg_model</span>
            <span class="n">r_pred</span> <span class="o">=</span> <span class="n">estimated_rewards_by_reg_model_s</span><span class="p">[</span>
                <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">bootstrap_bandit_feedback</span><span class="p">[</span><span class="s2">&quot;n_rounds&quot;</span><span class="p">]),</span>
                <span class="n">bootstrap_bandit_feedback</span><span class="p">[</span><span class="s2">&quot;action&quot;</span><span class="p">],</span>
                <span class="n">bootstrap_bandit_feedback</span><span class="p">[</span><span class="s2">&quot;position&quot;</span><span class="p">],</span>
            <span class="p">]</span>
            <span class="n">reg_model_metrics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_rec_model_performance_s</span><span class="p">(</span>
                <span class="n">r_true</span><span class="o">=</span><span class="n">bootstrap_bandit_feedback</span><span class="p">[</span><span class="s2">&quot;reward&quot;</span><span class="p">],</span>
                <span class="n">r_pred</span><span class="o">=</span><span class="n">r_pred</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="c1"># store results</span>
            <span class="k">for</span> <span class="n">est</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">estimator_names</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">policy_value</span><span class="p">[</span><span class="n">est</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">policy_value_s</span><span class="p">[</span><span class="n">est</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">squared_error</span><span class="p">[</span><span class="n">est</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">squared_error_s</span><span class="p">[</span><span class="n">est</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">metric</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reg_model_metric_names</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reg_model_metrics</span><span class="p">[</span><span class="n">metric</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">reg_model_metrics</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">policy_value</span>

    <span class="k">def</span> <span class="nf">calculate_squared_error</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculates the squared errors using selected ope estimators under a range of environments.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">policy_value</span><span class="p">:</span>
            <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">estimate_policy_value</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">squared_error</span>

    <span class="k">def</span> <span class="nf">calculate_variance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scale</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">std</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculates the variance of squared errors.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">policy_value</span><span class="p">:</span>
            <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">estimate_policy_value</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">std</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">variance</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">key</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">val</span><span class="p">))</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">squared_error</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">variance</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">key</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">squared_error</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="p">}</span>
        <span class="n">variance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">variance</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">scale</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">variance</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
            <span class="k">for</span> <span class="n">est</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">estimator_names</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">variance</span><span class="p">[</span><span class="n">est</span><span class="p">])</span> <span class="o">!=</span> <span class="nb">str</span><span class="p">:</span>
                    <span class="n">variance</span><span class="p">[</span><span class="n">est</span><span class="p">]</span> <span class="o">=</span> <span class="n">variance</span><span class="p">[</span><span class="n">est</span><span class="p">]</span> <span class="o">/</span> <span class="n">c</span>
        <span class="k">return</span> <span class="n">variance</span>

    <span class="k">def</span> <span class="nf">calculate_mean</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scale</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">root</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculates the mean of squared errors.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">policy_value</span><span class="p">:</span>
            <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">estimate_policy_value</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">root</span><span class="p">:</span>  <span class="c1"># root mean squared error</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mean</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">key</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">val</span><span class="p">))</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">squared_error</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># mean squared error</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mean</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">squared_error</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="n">mean</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mean</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">scale</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">mean</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
            <span class="k">for</span> <span class="n">est</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">estimator_names</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">mean</span><span class="p">[</span><span class="n">est</span><span class="p">])</span> <span class="o">!=</span> <span class="nb">str</span><span class="p">:</span>
                    <span class="n">mean</span><span class="p">[</span><span class="n">est</span><span class="p">]</span> <span class="o">=</span> <span class="n">mean</span><span class="p">[</span><span class="n">est</span><span class="p">]</span> <span class="o">/</span> <span class="n">c</span>
        <span class="k">return</span> <span class="n">mean</span>

    <span class="k">def</span> <span class="nf">save_policy_value</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">file_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;results&quot;</span><span class="p">,</span>
        <span class="n">file_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;ieoe_policy_value.csv&quot;</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Save policy_value to csv file.&quot;&quot;&quot;</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">file_dir</span><span class="p">)</span>
        <span class="n">path</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ieoe_policy_value_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">policy_value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">random_states</span><span class="p">)</span>
        <span class="n">ieoe_policy_value_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">file_dir</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">save_squared_error</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">file_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;results&quot;</span><span class="p">,</span>
        <span class="n">file_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;ieoe_squared_error.csv&quot;</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Save squared_error to csv file.&quot;&quot;&quot;</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">file_dir</span><span class="p">)</span>
        <span class="n">path</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ieoe_squared_error_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">squared_error</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">random_states</span><span class="p">)</span>
        <span class="n">ieoe_squared_error_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">file_dir</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">save_variance</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">file_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;results&quot;</span><span class="p">,</span>
        <span class="n">file_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;ieoe_variance.csv&quot;</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Save squared_error to csv file.&quot;&quot;&quot;</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">file_dir</span><span class="p">)</span>
        <span class="n">path</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ieoe_variance_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">variance</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">variance</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">ieoe_variance_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">file_dir</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visualize_cdf</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">fig_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;figures&quot;</span><span class="p">,</span>
        <span class="n">fig_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;cdf.png&quot;</span><span class="p">,</span>
        <span class="n">font_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
        <span class="n">fig_width</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
        <span class="n">fig_height</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span>
        <span class="n">kde</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Create a cdf graph for each ope estimator.&quot;&quot;&quot;</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">fig_dir</span><span class="p">)</span>
        <span class="n">path</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">est</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">estimator_names</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s2">&quot;ggplot&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;font.size&quot;</span><span class="p">:</span> <span class="n">font_size</span><span class="p">})</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">fig_width</span><span class="p">,</span> <span class="n">fig_height</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">kde</span><span class="p">:</span>
                <span class="n">sns</span><span class="o">.</span><span class="n">kdeplot</span><span class="p">(</span>
                    <span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">squared_error</span><span class="p">[</span><span class="n">est</span><span class="p">],</span>
                    <span class="n">kernel</span><span class="o">=</span><span class="s2">&quot;gaussian&quot;</span><span class="p">,</span>
                    <span class="n">cumulative</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
                    <span class="n">label</span><span class="o">=</span><span class="n">est</span><span class="p">,</span>
                    <span class="n">linewidth</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span>
                    <span class="n">bw_method</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sns</span><span class="o">.</span><span class="n">ecdfplot</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">squared_error</span><span class="p">[</span><span class="n">est</span><span class="p">],</span>
                    <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
                    <span class="n">label</span><span class="o">=</span><span class="n">est</span><span class="p">,</span>
                    <span class="n">linewidth</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">est</span><span class="si">}</span><span class="s2">: Cumulative distribution of squared error&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Squared error&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Cumulative probability&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fig_dir</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">est</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">fig_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">visualize_cdf_aggregate</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">fig_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;figures&quot;</span><span class="p">,</span>
        <span class="n">fig_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;cdf.png&quot;</span><span class="p">,</span>
        <span class="n">font_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
        <span class="n">fig_width</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
        <span class="n">fig_height</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span>
        <span class="n">xmax</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">kde</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">linestyles</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Create a graph containing the cdf of all ope estimators.&quot;&quot;&quot;</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">fig_dir</span><span class="p">)</span>
        <span class="n">path</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s2">&quot;ggplot&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;font.size&quot;</span><span class="p">:</span> <span class="n">font_size</span><span class="p">})</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">fig_width</span><span class="p">,</span> <span class="n">fig_height</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">est</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">estimator_names</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">COLORS</span><span class="p">):</span>
                <span class="n">color</span> <span class="o">=</span> <span class="n">COLORS</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">color</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span>
                    <span class="mi">3</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">linestyles</span><span class="p">:</span>
                <span class="n">linestyle</span> <span class="o">=</span> <span class="n">LINESTYLES</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">LINESTYLES</span><span class="p">)]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">linestyle</span> <span class="o">=</span> <span class="s2">&quot;solid&quot;</span>
            <span class="k">if</span> <span class="n">kde</span><span class="p">:</span>
                <span class="n">sns</span><span class="o">.</span><span class="n">kdeplot</span><span class="p">(</span>
                    <span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">squared_error</span><span class="p">[</span><span class="n">est</span><span class="p">],</span>
                    <span class="n">kernel</span><span class="o">=</span><span class="s2">&quot;gaussian&quot;</span><span class="p">,</span>
                    <span class="n">cumulative</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
                    <span class="n">label</span><span class="o">=</span><span class="n">est</span><span class="p">,</span>
                    <span class="n">linewidth</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span>
                    <span class="n">bw_method</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>
                    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
                    <span class="n">c</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
                    <span class="n">linestyle</span><span class="o">=</span><span class="n">linestyle</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sns</span><span class="o">.</span><span class="n">ecdfplot</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">squared_error</span><span class="p">[</span><span class="n">est</span><span class="p">],</span>
                    <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
                    <span class="n">label</span><span class="o">=</span><span class="n">est</span><span class="p">,</span>
                    <span class="n">linewidth</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span>
                    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
                    <span class="n">c</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
                    <span class="n">linestyle</span><span class="o">=</span><span class="n">linestyle</span><span class="p">,</span>
                <span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;lower right&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Cumulative distribution of squared error&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Squared error&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Cumulative probability&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">xmax</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fig_dir</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">fig_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">visualize_squared_error_density</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">fig_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;figures&quot;</span><span class="p">,</span>
        <span class="n">fig_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;squared_error_density_estimation.png&quot;</span><span class="p">,</span>
        <span class="n">font_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
        <span class="n">fig_width</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
        <span class="n">fig_height</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Create a graph based on kernel density estimation of squared error for each ope estimator.&quot;&quot;&quot;</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">fig_dir</span><span class="p">)</span>
        <span class="n">path</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">est</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">estimator_names</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s2">&quot;ggplot&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;font.size&quot;</span><span class="p">:</span> <span class="n">font_size</span><span class="p">})</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">fig_width</span><span class="p">,</span> <span class="n">fig_height</span><span class="p">))</span>
            <span class="n">sns</span><span class="o">.</span><span class="n">kdeplot</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">squared_error</span><span class="p">[</span><span class="n">est</span><span class="p">],</span>
                <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span><span class="n">est</span><span class="p">,</span>
                <span class="n">linewidth</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">est</span><span class="si">}</span><span class="s2">: Graph of estimated density of squared error&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span>
                <span class="s2">&quot;Squared error&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fig_dir</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">est</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">fig_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">calculate_au_cdf_score</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">threshold</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">scale</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate AU-CDF score.&quot;&quot;&quot;</span>
        <span class="n">au_cdf_score</span> <span class="o">=</span> <span class="p">{</span><span class="n">est</span><span class="p">:</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">est</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">estimator_names</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">est</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">estimator_names</span><span class="p">:</span>
            <span class="n">au_cdf_score</span><span class="p">[</span><span class="n">est</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">threshold</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">squared_error</span><span class="p">[</span><span class="n">est</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">scale</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">au_cdf_score</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
            <span class="k">for</span> <span class="n">est</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">estimator_names</span><span class="p">:</span>
                <span class="n">au_cdf_score</span><span class="p">[</span><span class="n">est</span><span class="p">]</span> <span class="o">=</span> <span class="n">au_cdf_score</span><span class="p">[</span><span class="n">est</span><span class="p">]</span> <span class="o">/</span> <span class="n">c</span>
        <span class="k">return</span> <span class="n">au_cdf_score</span>

    <span class="k">def</span> <span class="nf">calculate_cvar_score</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">alpha</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">scale</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate CVaR score.&quot;&quot;&quot;</span>
        <span class="n">cvar_score</span> <span class="o">=</span> <span class="p">{</span><span class="n">est</span><span class="p">:</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">est</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">estimator_names</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">est</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">estimator_names</span><span class="p">:</span>
            <span class="n">threshold</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">squared_error</span><span class="p">[</span><span class="n">est</span><span class="p">],</span> <span class="n">alpha</span><span class="p">)</span>
            <span class="n">bool_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">squared_error</span><span class="p">[</span><span class="n">est</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">threshold</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">bool_</span><span class="p">):</span>
                <span class="n">cvar_score</span><span class="p">[</span><span class="n">est</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">squared_error</span><span class="p">[</span><span class="n">est</span><span class="p">]</span> <span class="o">*</span> <span class="n">bool_</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
                    <span class="n">bool_</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cvar_score</span><span class="p">[</span>
                    <span class="n">est</span>
                <span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;the largest squared error is less than the threshold value </span><span class="si">{</span><span class="n">threshold</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">scale</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">cvar_score</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
            <span class="k">for</span> <span class="n">est</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">estimator_names</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">cvar_score</span><span class="p">[</span><span class="n">est</span><span class="p">])</span> <span class="o">!=</span> <span class="nb">str</span><span class="p">:</span>
                    <span class="n">cvar_score</span><span class="p">[</span><span class="n">est</span><span class="p">]</span> <span class="o">=</span> <span class="n">cvar_score</span><span class="p">[</span><span class="n">est</span><span class="p">]</span> <span class="o">/</span> <span class="n">c</span>
        <span class="k">return</span> <span class="n">cvar_score</span>

    <span class="k">def</span> <span class="nf">set_ope_estimator_hyperparam_space</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">ope_estimator_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">param_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">lower</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
        <span class="n">upper</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
        <span class="n">log</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">type_</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">type</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Specify sampling method of hyperparameter of ope estimator.&quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="n">type_</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="nb">int</span><span class="p">,</span>
            <span class="nb">float</span><span class="p">,</span>
        <span class="p">],</span> <span class="sa">f</span><span class="s2">&quot;`type_` must be int or float but </span><span class="si">{</span><span class="n">type_</span><span class="si">}</span><span class="s2"> is given&quot;</span>
        <span class="n">dic</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;lower&quot;</span><span class="p">:</span> <span class="n">lower</span><span class="p">,</span>
            <span class="s2">&quot;upper&quot;</span><span class="p">:</span> <span class="n">upper</span><span class="p">,</span>
            <span class="s2">&quot;log&quot;</span><span class="p">:</span> <span class="n">log</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="n">type_</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ope_estimator_hyperparams</span><span class="p">[</span><span class="n">ope_estimator_name</span><span class="p">][</span><span class="n">param_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">dic</span>

    <span class="k">def</span> <span class="nf">set_regression_model_hyperparam_space</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">regression_model</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">BaseEstimator</span><span class="p">,</span> <span class="n">BaseSearchCV</span><span class="p">],</span>
        <span class="n">param_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">lower</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
        <span class="n">upper</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
        <span class="n">log</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">type_</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">type</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Specify sampling method of hyperparameter of regression model.&quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="n">type_</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="nb">int</span><span class="p">,</span>
            <span class="nb">float</span><span class="p">,</span>
        <span class="p">],</span> <span class="sa">f</span><span class="s2">&quot;`type_` must be int or float but </span><span class="si">{</span><span class="n">type_</span><span class="si">}</span><span class="s2"> is given&quot;</span>
        <span class="n">dic</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;lower&quot;</span><span class="p">:</span> <span class="n">lower</span><span class="p">,</span>
            <span class="s2">&quot;upper&quot;</span><span class="p">:</span> <span class="n">upper</span><span class="p">,</span>
            <span class="s2">&quot;log&quot;</span><span class="p">:</span> <span class="n">log</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="n">type_</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">regression_model_hyperparams</span><span class="p">[</span><span class="n">regression_model</span><span class="p">][</span><span class="n">param_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">dic</span>

    <span class="k">def</span> <span class="nf">_choose_bandit_feedback</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">s</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BanditFeedback</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Randomly select bandit_feedback.&quot;&quot;&quot;</span>
        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="n">s</span><span class="p">)</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bandit_feedbacks</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">bandit_feedbacks</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_sample_bootstrap_bandit_feedback</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">sample_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BanditFeedback</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Randomly sample bootstrap data from bandit_feedback.&quot;&quot;&quot;</span>
        <span class="n">bootstrap_bandit_feedback</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bandit_feedback</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="n">s</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sample_size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sample_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bandit_feedback</span><span class="p">[</span><span class="s2">&quot;n_rounds&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bootstrap_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">sample_size</span><span class="p">),</span> <span class="n">size</span><span class="o">=</span><span class="n">sample_size</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">key_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bandit_feedback</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="c1"># if the size of a certain key_ is not equal to n_rounds,</span>
            <span class="c1"># we should not resample that certain key_</span>
            <span class="c1"># e.g. we want to resample action and reward, but not n_rounds</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bandit_feedback</span><span class="p">[</span><span class="n">key_</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span>
                <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bandit_feedback</span><span class="p">[</span><span class="n">key_</span><span class="p">])</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bandit_feedback</span><span class="p">[</span><span class="s2">&quot;n_rounds&quot;</span><span class="p">]</span>
            <span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">bootstrap_bandit_feedback</span><span class="p">[</span><span class="n">key_</span><span class="p">]</span> <span class="o">=</span> <span class="n">bootstrap_bandit_feedback</span><span class="p">[</span><span class="n">key_</span><span class="p">][</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bootstrap_idx</span>
            <span class="p">]</span>
        <span class="n">bootstrap_bandit_feedback</span><span class="p">[</span><span class="s2">&quot;n_rounds&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sample_size</span>
        <span class="k">return</span> <span class="n">bootstrap_bandit_feedback</span>

    <span class="k">def</span> <span class="nf">_choose_ope_estimator_hyperparam</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">s</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Randomly choose hyperparameters for ope estimators.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">est</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ope_estimators</span><span class="p">):</span>
            <span class="n">hyperparam</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ope_estimator_hyperparams</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">est</span><span class="o">.</span><span class="n">estimator_name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">hyperparam</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">hyperparam</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">hyperparam</span><span class="p">[</span><span class="n">p</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;log&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="n">_choose_log_uniform</span><span class="p">(</span>
                        <span class="n">s</span><span class="p">,</span>
                        <span class="n">hyperparam</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="s2">&quot;lower&quot;</span><span class="p">],</span>
                        <span class="n">hyperparam</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="s2">&quot;upper&quot;</span><span class="p">],</span>
                        <span class="n">hyperparam</span><span class="p">[</span><span class="n">p</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="n">_choose_uniform</span><span class="p">(</span>
                        <span class="n">s</span><span class="p">,</span>
                        <span class="n">hyperparam</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="s2">&quot;lower&quot;</span><span class="p">],</span>
                        <span class="n">hyperparam</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="s2">&quot;upper&quot;</span><span class="p">],</span>
                        <span class="n">hyperparam</span><span class="p">[</span><span class="n">p</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
                    <span class="p">)</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="n">est</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ope_estimators</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">est</span>

    <span class="k">def</span> <span class="nf">_choose_regression_model</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">s</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">BaseEstimator</span><span class="p">,</span> <span class="n">BaseSearchCV</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Randomly choose regression model.&quot;&quot;&quot;</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">regression_models</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">regression_models</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_choose_regression_model_hyperparam</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">s</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">regression_model</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">BaseEstimator</span><span class="p">,</span> <span class="n">BaseSearchCV</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Randomly choose hyperparameters for regression model.&quot;&quot;&quot;</span>
        <span class="n">hyperparam</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">random_state</span><span class="o">=</span><span class="n">s</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">hyperparam_set</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">regression_model_hyperparams</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">regression_model</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">hyperparam_set</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">hyperparam</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">hyperparam_set</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">hyperparam_set</span><span class="p">[</span><span class="n">p</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;log&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">_choose_log_uniform</span><span class="p">(</span>
                    <span class="n">s</span><span class="p">,</span>
                    <span class="n">hyperparam_set</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="s2">&quot;lower&quot;</span><span class="p">],</span>
                    <span class="n">hyperparam_set</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="s2">&quot;upper&quot;</span><span class="p">],</span>
                    <span class="n">hyperparam_set</span><span class="p">[</span><span class="n">p</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">_choose_uniform</span><span class="p">(</span>
                    <span class="n">s</span><span class="p">,</span>
                    <span class="n">hyperparam_set</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="s2">&quot;lower&quot;</span><span class="p">],</span>
                    <span class="n">hyperparam_set</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="s2">&quot;upper&quot;</span><span class="p">],</span>
                    <span class="n">hyperparam_set</span><span class="p">[</span><span class="n">p</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
                <span class="p">)</span>
            <span class="n">hyperparam</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
        <span class="k">return</span> <span class="n">hyperparam</span>

    <span class="k">def</span> <span class="nf">_choose_pscore_estimator_hyperparam</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">s</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">pscore_estimator</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">BaseEstimator</span><span class="p">,</span> <span class="n">BaseSearchCV</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Randomly choose hyperparameters for pscore estimator.&quot;&quot;&quot;</span>
        <span class="n">hyperparam</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">random_state</span><span class="o">=</span><span class="n">s</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">hyperparam_set</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pscore_estimator_hyperparams</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pscore_estimator</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">hyperparam_set</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">hyperparam</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">hyperparam_set</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">hyperparam_set</span><span class="p">[</span><span class="n">p</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;log&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">_choose_log_uniform</span><span class="p">(</span>
                    <span class="n">s</span><span class="p">,</span>
                    <span class="n">hyperparam_set</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="s2">&quot;lower&quot;</span><span class="p">],</span>
                    <span class="n">hyperparam_set</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="s2">&quot;upper&quot;</span><span class="p">],</span>
                    <span class="n">hyperparam_set</span><span class="p">[</span><span class="n">p</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">_choose_uniform</span><span class="p">(</span>
                    <span class="n">s</span><span class="p">,</span>
                    <span class="n">hyperparam_set</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="s2">&quot;lower&quot;</span><span class="p">],</span>
                    <span class="n">hyperparam_set</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="s2">&quot;upper&quot;</span><span class="p">],</span>
                    <span class="n">hyperparam_set</span><span class="p">[</span><span class="n">p</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
                <span class="p">)</span>
            <span class="n">hyperparam</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
        <span class="k">return</span> <span class="n">hyperparam</span>

    <span class="k">def</span> <span class="nf">_choose_evaluation_policy</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">s</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Randomly choose evaluation policy and resample using bootstrap.&quot;&quot;&quot;</span>
        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="n">s</span><span class="p">)</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">evaluation_policies</span><span class="p">))</span>
        <span class="n">ground_truth</span><span class="p">,</span> <span class="n">action_dist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluation_policies</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="n">action_dist</span> <span class="o">=</span> <span class="n">action_dist</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">bootstrap_idx</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">ground_truth</span><span class="p">,</span> <span class="n">action_dist</span>

    <span class="k">def</span> <span class="nf">_estimate_policy_value_s</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">s</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">bootstrap_bandit_feedback</span><span class="p">:</span> <span class="n">BanditFeedback</span><span class="p">,</span>
        <span class="n">_regression_model</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">BaseEstimator</span><span class="p">,</span> <span class="n">BaseSearchCV</span><span class="p">],</span>
        <span class="n">bootstrap_action_dist</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">n_folds</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Estimates the policy values using selected ope estimators under a particular environments.&quot;&quot;&quot;</span>
        <span class="c1"># prepare regression model for ope</span>
        <span class="n">regression_model</span> <span class="o">=</span> <span class="n">RegressionModel</span><span class="p">(</span>
            <span class="n">n_actions</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bandit_feedback</span><span class="p">[</span><span class="s2">&quot;n_actions&quot;</span><span class="p">],</span>
            <span class="n">len_list</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bandit_feedback</span><span class="p">[</span><span class="s2">&quot;position&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
            <span class="n">base_model</span><span class="o">=</span><span class="n">_regression_model</span><span class="p">,</span>
            <span class="n">fitting_method</span><span class="o">=</span><span class="s2">&quot;normal&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">estimated_reward_by_reg_model</span> <span class="o">=</span> <span class="n">regression_model</span><span class="o">.</span><span class="n">fit_predict</span><span class="p">(</span>
            <span class="n">context</span><span class="o">=</span><span class="n">bootstrap_bandit_feedback</span><span class="p">[</span><span class="s2">&quot;context&quot;</span><span class="p">],</span>
            <span class="n">action</span><span class="o">=</span><span class="n">bootstrap_bandit_feedback</span><span class="p">[</span><span class="s2">&quot;action&quot;</span><span class="p">],</span>
            <span class="n">reward</span><span class="o">=</span><span class="n">bootstrap_bandit_feedback</span><span class="p">[</span><span class="s2">&quot;reward&quot;</span><span class="p">],</span>
            <span class="n">position</span><span class="o">=</span><span class="n">bootstrap_bandit_feedback</span><span class="p">[</span><span class="s2">&quot;position&quot;</span><span class="p">],</span>
            <span class="n">pscore</span><span class="o">=</span><span class="n">bootstrap_bandit_feedback</span><span class="p">[</span><span class="s2">&quot;pscore&quot;</span><span class="p">],</span>
            <span class="n">action_dist</span><span class="o">=</span><span class="n">bootstrap_action_dist</span><span class="p">,</span>
            <span class="n">n_folds</span><span class="o">=</span><span class="n">n_folds</span><span class="p">,</span>
            <span class="n">random_state</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># estimate policy value using ope</span>
        <span class="n">ope</span> <span class="o">=</span> <span class="n">OffPolicyEvaluation</span><span class="p">(</span>
            <span class="n">bandit_feedback</span><span class="o">=</span><span class="n">bootstrap_bandit_feedback</span><span class="p">,</span>
            <span class="n">ope_estimators</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ope_estimators</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">estimated_policy_value</span> <span class="o">=</span> <span class="n">ope</span><span class="o">.</span><span class="n">estimate_policy_values</span><span class="p">(</span>
            <span class="n">action_dist</span><span class="o">=</span><span class="n">bootstrap_action_dist</span><span class="p">,</span>
            <span class="n">estimated_rewards_by_reg_model</span><span class="o">=</span><span class="n">estimated_reward_by_reg_model</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">estimated_policy_value</span><span class="p">,</span> <span class="n">estimated_reward_by_reg_model</span>

    <span class="k">def</span> <span class="nf">_calculate_squared_error_s</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">policy_value</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="n">ground_truth</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate squared error.&quot;&quot;&quot;</span>
        <span class="n">squared_error</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">est</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">policy_value</span><span class="p">[</span><span class="n">est</span><span class="p">]</span> <span class="o">-</span> <span class="n">ground_truth</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">est</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">estimator_names</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">squared_error</span>

    <span class="k">def</span> <span class="nf">_calculate_rec_model_performance_s</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">r_true</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">r_pred</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Calculate performance of reg model.&quot;&quot;&quot;</span>
        <span class="n">r_naive_pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">r_true</span><span class="p">)</span> <span class="o">*</span> <span class="n">r_true</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reward_type</span> <span class="o">==</span> <span class="s2">&quot;binary&quot;</span><span class="p">:</span>
            <span class="n">auc</span> <span class="o">=</span> <span class="n">roc_auc_score</span><span class="p">(</span><span class="n">r_true</span><span class="p">,</span> <span class="n">r_pred</span><span class="p">)</span>
            <span class="n">ce</span> <span class="o">=</span> <span class="n">log_loss</span><span class="p">(</span><span class="n">r_true</span><span class="p">,</span> <span class="n">r_pred</span><span class="p">)</span>
            <span class="n">ce_naive</span> <span class="o">=</span> <span class="n">log_loss</span><span class="p">(</span><span class="n">r_true</span><span class="p">,</span> <span class="n">r_naive_pred</span><span class="p">)</span>
            <span class="n">rel_ce</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">ce</span> <span class="o">/</span> <span class="n">ce_naive</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">auc</span><span class="p">,</span> <span class="n">rel_ce</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">reward_type</span> <span class="o">==</span> <span class="s2">&quot;continuous&quot;</span><span class="p">:</span>
            <span class="n">mse</span> <span class="o">=</span> <span class="n">calc_mse</span><span class="p">(</span><span class="n">r_true</span><span class="p">,</span> <span class="n">r_pred</span><span class="p">)</span>
            <span class="n">mse_naive</span> <span class="o">=</span> <span class="n">calc_mse</span><span class="p">(</span><span class="n">r_true</span><span class="p">,</span> <span class="n">r_naive_pred</span><span class="p">)</span>
            <span class="n">rel_mse</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">mse</span> <span class="o">/</span> <span class="n">mse_naive</span><span class="p">)</span>
            <span class="n">mae</span> <span class="o">=</span> <span class="n">calc_mae</span><span class="p">(</span><span class="n">r_true</span><span class="p">,</span> <span class="n">r_pred</span><span class="p">)</span>
            <span class="n">mae_naive</span> <span class="o">=</span> <span class="n">calc_mae</span><span class="p">(</span><span class="n">r_true</span><span class="p">,</span> <span class="n">r_naive_pred</span><span class="p">)</span>
            <span class="n">rel_mae</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">mae</span> <span class="o">/</span> <span class="n">mse_naive</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">rel_mse</span><span class="p">,</span> <span class="n">rel_mae</span>

    <span class="k">def</span> <span class="nf">load_squared_error</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">file_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">file_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">file_dir</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">squared_error</span> <span class="o">=</span> <span class="p">{</span><span class="n">est</span><span class="p">:</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">est</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">estimator_names</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">est</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">estimator_names</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">squared_error</span><span class="p">[</span><span class="n">est</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">est</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="example-1-synthetic-dataset">
<h2>Example 1 - Synthetic dataset<a class="headerlink" href="#example-1-synthetic-dataset" title="Permalink to this headline">¶</a></h2>
<p>This section demonstrates an example of conducting Interpretable Evaluation for Off-Policy Evaluation (IEOE). We use synthetic logged bandit feedback data generated using <a class="reference external" href="https://github.com/st-tech/zr-obp"><code class="docutils literal notranslate"><span class="pre">obp</span></code></a> and evaluate the performance of Direct Method (DM), Doubly Robust (DR), Doubly Robust with Shrinkage (DRos), and Inverse Probability Weighting (IPW).</p>
<p>Our example contains the following three major steps:</p>
<ol class="simple">
<li><p>Data Preparation</p></li>
<li><p>Setting Hyperparameter Spaces for Off-Policy Evaluation</p></li>
<li><p>Interpretable Evaluation for Off-Policy Evaluation</p></li>
</ol>
<div class="section" id="data-preparation">
<h3>Data Preparation<a class="headerlink" href="#data-preparation" title="Permalink to this headline">¶</a></h3>
<p>In order to conduct IEOE using <code class="docutils literal notranslate"><span class="pre">pyieoe</span></code>, we need to prepare logged bandit feedback data, action distributions of evaluation policies, and ground truth policy values of evaluation policies. Because <code class="docutils literal notranslate"><span class="pre">pyieoe</span></code> is built with the intention of being used with <code class="docutils literal notranslate"><span class="pre">obp</span></code>, these inputs must follow the conventions in <code class="docutils literal notranslate"><span class="pre">obp</span></code>. Specifically, logged bandit feedback data must be of type <code class="docutils literal notranslate"><span class="pre">BanditFeedback</span></code>, action distributions must be of type <code class="docutils literal notranslate"><span class="pre">np.ndarray</span></code>, and ground truth policy values must be of type <code class="docutils literal notranslate"><span class="pre">float</span></code> (or <code class="docutils literal notranslate"><span class="pre">int</span></code>).</p>
<p>In this example, we generate synthetic logged bandit feedback data and perform off-policy learning to obtain two sets of evaluation policies along with their action distributions and ground truth policy values using <code class="docutils literal notranslate"><span class="pre">obp</span></code>. For a detailed explanation of this process, please refer to the <a class="reference external" href="https://github.com/st-tech/zr-obp/blob/master/examples/quickstart/quickstart_synthetic.ipynb">official obp example</a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># generate a synthetic bandit dataset with 10 actions</span>
<span class="c1"># we use `logistic function` as the reward function and `linear_behavior_policy` as the behavior policy.</span>
<span class="c1"># one can define their own reward function and behavior policy such as nonlinear ones. </span>
<span class="n">dataset</span> <span class="o">=</span> <span class="n">SyntheticBanditDataset</span><span class="p">(</span>
    <span class="n">n_actions</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
    <span class="n">dim_context</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
    <span class="n">reward_type</span><span class="o">=</span><span class="s2">&quot;binary&quot;</span><span class="p">,</span> <span class="c1"># &quot;binary&quot; or &quot;continuous&quot;</span>
    <span class="n">reward_function</span><span class="o">=</span><span class="n">logistic_reward_function</span><span class="p">,</span>
    <span class="n">behavior_policy_function</span><span class="o">=</span><span class="n">linear_behavior_policy</span><span class="p">,</span>
    <span class="n">random_state</span><span class="o">=</span><span class="mi">12345</span>
<span class="p">)</span>
<span class="c1"># obtain training and test sets of synthetic logged bandit feedback</span>
<span class="n">n_rounds_train</span><span class="p">,</span> <span class="n">n_rounds_test</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">,</span> <span class="mi">10000</span>
<span class="n">bandit_feedback_train</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">obtain_batch_bandit_feedback</span><span class="p">(</span><span class="n">n_rounds</span><span class="o">=</span><span class="n">n_rounds_train</span><span class="p">)</span>
<span class="n">bandit_feedback_test</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">obtain_batch_bandit_feedback</span><span class="p">(</span><span class="n">n_rounds</span><span class="o">=</span><span class="n">n_rounds_test</span><span class="p">)</span>

<span class="c1"># define IPWLearner with Logistic Regression as its base ML model</span>
<span class="n">evaluation_policy_a</span> <span class="o">=</span> <span class="n">IPWLearner</span><span class="p">(</span>
    <span class="n">n_actions</span><span class="o">=</span><span class="n">dataset</span><span class="o">.</span><span class="n">n_actions</span><span class="p">,</span>
    <span class="n">len_list</span><span class="o">=</span><span class="n">dataset</span><span class="o">.</span><span class="n">len_list</span><span class="p">,</span>
    <span class="n">base_classifier</span><span class="o">=</span><span class="n">LogisticRegression</span><span class="p">(</span><span class="n">C</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">12345</span><span class="p">)</span>
<span class="p">)</span>
<span class="c1"># train IPWLearner on the training set of the synthetic logged bandit feedback</span>
<span class="n">evaluation_policy_a</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
    <span class="n">context</span><span class="o">=</span><span class="n">bandit_feedback_train</span><span class="p">[</span><span class="s2">&quot;context&quot;</span><span class="p">],</span>
    <span class="n">action</span><span class="o">=</span><span class="n">bandit_feedback_train</span><span class="p">[</span><span class="s2">&quot;action&quot;</span><span class="p">],</span>
    <span class="n">reward</span><span class="o">=</span><span class="n">bandit_feedback_train</span><span class="p">[</span><span class="s2">&quot;reward&quot;</span><span class="p">],</span>
    <span class="n">pscore</span><span class="o">=</span><span class="n">bandit_feedback_train</span><span class="p">[</span><span class="s2">&quot;pscore&quot;</span><span class="p">]</span>
<span class="p">)</span>
<span class="c1"># obtains action choice probabilities for the test set of the synthetic logged bandit feedback</span>
<span class="n">action_dist_a</span> <span class="o">=</span> <span class="n">evaluation_policy_a</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span>
    <span class="n">context</span><span class="o">=</span><span class="n">bandit_feedback_test</span><span class="p">[</span><span class="s2">&quot;context&quot;</span><span class="p">],</span>
    <span class="n">tau</span><span class="o">=</span><span class="mf">0.1</span> <span class="c1"># temperature hyperparameter</span>
<span class="p">)</span>

<span class="c1"># define IPWLearner with Random Forest as its base ML model</span>
<span class="n">evaluation_policy_b</span> <span class="o">=</span> <span class="n">IPWLearner</span><span class="p">(</span>
    <span class="n">n_actions</span><span class="o">=</span><span class="n">dataset</span><span class="o">.</span><span class="n">n_actions</span><span class="p">,</span>
    <span class="n">len_list</span><span class="o">=</span><span class="n">dataset</span><span class="o">.</span><span class="n">len_list</span><span class="p">,</span>
    <span class="n">base_classifier</span><span class="o">=</span><span class="n">RandomForest</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">min_samples_leaf</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">12345</span><span class="p">)</span>
<span class="p">)</span>
<span class="c1"># train IPWLearner on the training set of the synthetic logged bandit feedback</span>
<span class="n">evaluation_policy_b</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
    <span class="n">context</span><span class="o">=</span><span class="n">bandit_feedback_train</span><span class="p">[</span><span class="s2">&quot;context&quot;</span><span class="p">],</span>
    <span class="n">action</span><span class="o">=</span><span class="n">bandit_feedback_train</span><span class="p">[</span><span class="s2">&quot;action&quot;</span><span class="p">],</span>
    <span class="n">reward</span><span class="o">=</span><span class="n">bandit_feedback_train</span><span class="p">[</span><span class="s2">&quot;reward&quot;</span><span class="p">],</span>
    <span class="n">pscore</span><span class="o">=</span><span class="n">bandit_feedback_train</span><span class="p">[</span><span class="s2">&quot;pscore&quot;</span><span class="p">]</span>
<span class="p">)</span>
<span class="c1"># obtains action choice probabilities for the test set of the synthetic logged bandit feedback</span>
<span class="n">action_dist_b</span> <span class="o">=</span> <span class="n">evaluation_policy_b</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span>
    <span class="n">context</span><span class="o">=</span><span class="n">bandit_feedback_test</span><span class="p">[</span><span class="s2">&quot;context&quot;</span><span class="p">],</span>
    <span class="n">tau</span><span class="o">=</span><span class="mf">0.1</span> <span class="c1"># temperature hyperparameter</span>
<span class="p">)</span>

<span class="c1"># obtain ground truth policy value for each action choice probabilities</span>
<span class="n">expected_rewards</span> <span class="o">=</span> <span class="n">bandit_feedback_test</span><span class="p">[</span><span class="s2">&quot;expected_reward&quot;</span><span class="p">]</span>
<span class="n">ground_truth_a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">expected_rewards</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">action_dist_a</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">ground_truth_b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">expected_rewards</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">action_dist_b</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="setting-hyperparameter-spaces-for-off-policy-evaluation">
<h3>Setting Hyperparameter Spaces for Off-Policy Evaluation<a class="headerlink" href="#setting-hyperparameter-spaces-for-off-policy-evaluation" title="Permalink to this headline">¶</a></h3>
<p>An integral aspect of IEOE is the different sources of variance. The main sources of variance are evaluation policies, random states, hyperparameters of OPE estimators, and hyperparameters of regression models.</p>
<p>In this step, we define the spaces from which the hyperparameters of OPE estimators / regression models are chosen. (The evaluation policy space is defined in the previous step, and the random state space will be defined in the next step.)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># set hyperparameter space for ope estimators</span>

<span class="c1"># set hyperparameter space for the doubly robust with shrinkage estimator</span>
<span class="c1"># with the following code, lambda_ will be chosen from a logarithm uniform distribution over the interval [0.001, 1000]</span>
<span class="n">lambda_</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;lower&quot;</span><span class="p">:</span> <span class="mf">1e-3</span><span class="p">,</span>
    <span class="s2">&quot;upper&quot;</span><span class="p">:</span> <span class="mf">1e3</span><span class="p">,</span>
    <span class="s2">&quot;log&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="nb">float</span>
<span class="p">}</span>
<span class="n">dros_param</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;lambda_&quot;</span><span class="p">:</span> <span class="n">lambda_</span><span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># set hyperparameter space for regression models</span>

<span class="c1"># set hyperparameter space for logistic regression</span>
<span class="c1"># with the following code, C will be chosen from a logarithm uniform distribution over the interval [0.001, 100]</span>
<span class="n">C</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;lower&quot;</span><span class="p">:</span> <span class="mf">1e-3</span><span class="p">,</span>
    <span class="s2">&quot;upper&quot;</span><span class="p">:</span> <span class="mf">1e2</span><span class="p">,</span>
    <span class="s2">&quot;log&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="nb">float</span>
<span class="p">}</span>
<span class="c1"># create a dictionary mapping hyperparamter names to hyperparamter spaces</span>
<span class="n">logistic_regression_param</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;C&quot;</span><span class="p">:</span> <span class="n">C</span><span class="p">}</span>

<span class="c1"># set hyperparameter space for the random forest classifier</span>
<span class="c1"># with the following code, n_estimators will be chosen from a logarithm uniform distribution over the interval [50, 100]</span>
<span class="c1"># the chosen value will be of type int</span>
<span class="n">n_estimators</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;lower&quot;</span><span class="p">:</span> <span class="mf">5e1</span><span class="p">,</span>
    <span class="s2">&quot;upper&quot;</span><span class="p">:</span> <span class="mf">1e2</span><span class="p">,</span>
    <span class="s2">&quot;log&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="nb">int</span>
<span class="p">}</span>
<span class="c1"># with the following code, max_depth will be chosen from a uniform distribution over the interval [2, 10]</span>
<span class="c1"># the chosen value will be of type int</span>
<span class="n">max_depth</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;lower&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
    <span class="s2">&quot;upper&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
    <span class="s2">&quot;log&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="nb">int</span>
<span class="p">}</span>
<span class="c1"># with the following code, min_samples_split will be chosen from a uniform distribution over the interval [2, 10]</span>
<span class="c1"># the chosen value will be of type int</span>
<span class="n">min_samples_split</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;lower&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
    <span class="s2">&quot;upper&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
    <span class="s2">&quot;log&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="nb">int</span>
<span class="p">}</span>
<span class="c1"># create a dictionary mapping hyperparamter names to hyperparamter spaces</span>
<span class="n">random_forest_param</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;n_estimators&quot;</span><span class="p">:</span> <span class="n">n_estimators</span><span class="p">,</span> 
    <span class="s2">&quot;max_depth&quot;</span><span class="p">:</span> <span class="n">max_depth</span><span class="p">,</span> 
    <span class="s2">&quot;min_samples_split&quot;</span><span class="p">:</span> <span class="n">min_samples_split</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="interpretable-evaluation-for-off-policy-evaluation">
<h3>Interpretable Evaluation for Off-Policy Evaluation<a class="headerlink" href="#interpretable-evaluation-for-off-policy-evaluation" title="Permalink to this headline">¶</a></h3>
<p>With the above steps completed, we can finally conduct IEOE by utilizing the <code class="docutils literal notranslate"><span class="pre">InterpretableOPEEvaluator</span></code> class.</p>
<p>Here is a brief description for each parameter that can be passed into <code class="docutils literal notranslate"><span class="pre">InterpretableOPEEvaluator</span></code>:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">random_states</span></code>: a list of integers representing the random_state used when performing OPE; corresponds to the number of iterations</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">bandit_feedback</span></code>: a list of logged bandit feedback data</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">evaluation_policies</span></code>: a list of tuples representing (ground truth policy value, action distribution)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ope_estimators</span></code>: a list of OPE ope_estimators</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ope_estimator_hyperparams</span></code>: a dictionary mapping OPE estimator names to OPE estimator hyperparameter spaces defined in step 2</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">regression_models</span></code>: a list of regression_models</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">regression_model_hyperparams</span></code>: a dictionary mapping regression models to regression model hyperparameter spaces defined in step 2</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># initializing class</span>
<span class="n">evaluator</span> <span class="o">=</span> <span class="n">InterpretableOPEEvaluator</span><span class="p">(</span>
    <span class="n">random_states</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1000</span><span class="p">),</span>
    <span class="n">bandit_feedbacks</span><span class="o">=</span><span class="p">[</span><span class="n">bandit_feedback_test</span><span class="p">],</span>
    <span class="n">evaluation_policies</span><span class="o">=</span><span class="p">[</span>
        <span class="p">(</span><span class="n">ground_truth_a</span><span class="p">,</span> <span class="n">action_dist_a</span><span class="p">),</span> 
        <span class="p">(</span><span class="n">ground_truth_b</span><span class="p">,</span> <span class="n">action_dist_b</span><span class="p">)</span>
    <span class="p">],</span>
    <span class="n">ope_estimators</span><span class="o">=</span><span class="p">[</span>
        <span class="n">DirectMethod</span><span class="p">(),</span>
        <span class="n">DoublyRobust</span><span class="p">(),</span>
        <span class="n">DoublyRobustWithShrinkage</span><span class="p">(),</span>
        <span class="n">InverseProbabilityWeighting</span><span class="p">(),</span> 
    <span class="p">],</span>
    <span class="n">ope_estimator_hyperparams</span><span class="o">=</span><span class="p">{</span>
        <span class="n">DoublyRobustWithShrinkage</span><span class="o">.</span><span class="n">estimator_name</span><span class="p">:</span> <span class="n">dros_param</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="n">regression_models</span><span class="o">=</span><span class="p">[</span>
        <span class="n">LogisticRegression</span><span class="p">,</span>
        <span class="n">RandomForest</span>
    <span class="p">],</span>
    <span class="n">regression_model_hyperparams</span><span class="o">=</span><span class="p">{</span>
        <span class="n">LogisticRegression</span><span class="p">:</span> <span class="n">logistic_regression_param</span><span class="p">,</span>
        <span class="n">RandomForest</span><span class="p">:</span> <span class="n">random_forest_param</span>
    <span class="p">}</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We can set the hyperparameters of OPE estimators / regression models after initializing <code class="docutils literal notranslate"><span class="pre">InterpretableOPEEvaluator</span></code> as well. Below is an example:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># re-set hyperparameter space for the doubly robust with shrinkage estimator</span>
<span class="c1"># with the following code, lambda_ will now be chosen from a logarithm uniform distribution over the interval [0.001, 100]</span>
<span class="n">evaluator</span><span class="o">.</span><span class="n">set_ope_estimator_hyperparam_space</span><span class="p">(</span>
    <span class="n">DoublyRobustWithShrinkage</span><span class="o">.</span><span class="n">estimator_name</span><span class="p">,</span>
    <span class="n">param_name</span><span class="o">=</span><span class="s2">&quot;lambda_&quot;</span><span class="p">,</span>
    <span class="n">lower</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span>
    <span class="n">upper</span><span class="o">=</span><span class="mf">1e2</span><span class="p">,</span>
    <span class="n">log</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">type_</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># re-set hyperparameter space for logistic regression</span>
<span class="c1"># with the following code, C will now be chosen from a logarithm uniform distribution over the interval [0.001, 100]</span>
<span class="n">evaluator</span><span class="o">.</span><span class="n">set_regression_model_hyperparam_space</span><span class="p">(</span>
    <span class="n">LogisticRegression</span><span class="p">,</span>
    <span class="n">param_name</span><span class="o">=</span><span class="s2">&quot;C&quot;</span><span class="p">,</span>
    <span class="n">lower</span><span class="o">=</span><span class="mf">1e-2</span><span class="p">,</span>
    <span class="n">upper</span><span class="o">=</span><span class="mf">1e2</span><span class="p">,</span>
    <span class="n">log</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">type_</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Once we have initialized <code class="docutils literal notranslate"><span class="pre">InterpretableOPEEvaluator</span></code>, we can call implemented methods to perform IEOE.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># estimate policy values</span>
<span class="c1"># we obtain a dictionary mapping ope estimator names to np.ndarray storing the estimated policy value for each iteration</span>
<span class="n">policy_value</span> <span class="o">=</span> <span class="n">evaluator</span><span class="o">.</span><span class="n">estimate_policy_value</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100%|██████████| 1000/1000 [14:03&lt;00:00,  1.19it/s]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;dm:&quot;</span><span class="p">,</span> <span class="n">policy_value</span><span class="p">[</span><span class="s2">&quot;dm&quot;</span><span class="p">][:</span><span class="mi">3</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;dr:&quot;</span><span class="p">,</span> <span class="n">policy_value</span><span class="p">[</span><span class="s2">&quot;dr&quot;</span><span class="p">][:</span><span class="mi">3</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;dr-os:&quot;</span><span class="p">,</span> <span class="n">policy_value</span><span class="p">[</span><span class="s2">&quot;dr-os&quot;</span><span class="p">][:</span><span class="mi">3</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ipw:&quot;</span><span class="p">,</span> <span class="n">policy_value</span><span class="p">[</span><span class="s2">&quot;ipw&quot;</span><span class="p">][:</span><span class="mi">3</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>dm: [0.61928102 0.61815126 0.62100605]
dr: [0.63673605 0.63065572 0.6394665 ]
dr-os: [0.61845334 0.61717109 0.61962542]
ipw: [0.64121685 0.6392071  0.64475381]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># compute squared errors</span>
<span class="c1"># we obtain a dictionary mapping ope estimator names to np.ndarray storing the calculated squared error for each iteration</span>
<span class="n">squared_error</span> <span class="o">=</span> <span class="n">evaluator</span><span class="o">.</span><span class="n">calculate_squared_error</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;dm:&quot;</span><span class="p">,</span> <span class="n">squared_error</span><span class="p">[</span><span class="s2">&quot;dm&quot;</span><span class="p">][:</span><span class="mi">3</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;dr:&quot;</span><span class="p">,</span> <span class="n">squared_error</span><span class="p">[</span><span class="s2">&quot;dr&quot;</span><span class="p">][:</span><span class="mi">3</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;dr-os:&quot;</span><span class="p">,</span> <span class="n">squared_error</span><span class="p">[</span><span class="s2">&quot;dr-os&quot;</span><span class="p">][:</span><span class="mi">3</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ipw:&quot;</span><span class="p">,</span> <span class="n">squared_error</span><span class="p">[</span><span class="s2">&quot;ipw&quot;</span><span class="p">][:</span><span class="mi">3</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>dm: [0.00016377 0.00024432 0.0001226 ]
dr: [2.16943426e-05 9.77407104e-06 5.45849956e-05]
dr-os: [0.00018564 0.00027592 0.00015508]
ipw: [8.35125652e-05 2.94309131e-05 1.60667839e-04]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># visualize cdf of squared errors for all ope estimators</span>
<span class="n">evaluator</span><span class="o">.</span><span class="n">visualize_cdf_aggregate</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;Figure size 432x288 with 0 Axes&gt;
</pre></div>
</div>
<img alt="../_images/T902666_Evaluating_the_Robustness_of_Off_Policy_Evaluation_30_1.png" src="../_images/T902666_Evaluating_the_Robustness_of_Off_Policy_Evaluation_30_1.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># compute the au-cdf score (area under cdf of squared error over interval [0, thershold]), higher score is better</span>
<span class="c1"># we obtain a dictionary mapping ope estimator names to cvar scores </span>
<span class="n">au_cdf</span> <span class="o">=</span> <span class="n">evaluator</span><span class="o">.</span><span class="n">calculate_au_cdf_score</span><span class="p">(</span><span class="n">threshold</span><span class="o">=</span><span class="mf">0.0004</span><span class="p">)</span>
<span class="n">au_cdf</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;dm&#39;: 4.842819420579869e-05,
 &#39;dr&#39;: 0.00035661732117858394,
 &#39;dr-os&#39;: 0.0001248944509629071,
 &#39;ipw&#39;: 0.0003274020016774632}
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># by activating the `scale` option, </span>
<span class="c1"># we obtain the au_cdf scores where the highest score is scaled to 1</span>
<span class="n">au_cdf_scaled</span> <span class="o">=</span> <span class="n">evaluator</span><span class="o">.</span><span class="n">calculate_au_cdf_score</span><span class="p">(</span><span class="n">threshold</span><span class="o">=</span><span class="mf">0.0004</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">au_cdf_scaled</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;dm&#39;: 0.13579877176394137,
 &#39;dr&#39;: 1.0,
 &#39;dr-os&#39;: 0.35021981139374736,
 &#39;ipw&#39;: 0.9180765549901865}
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># compute the cvar score (expected value of squared error above probability alpha), lower score is better</span>
<span class="c1"># we obtain a dictionary mapping ope estimator names to cvar scores </span>
<span class="n">cvar</span> <span class="o">=</span> <span class="n">evaluator</span><span class="o">.</span><span class="n">calculate_cvar_score</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>
<span class="n">cvar</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;dm&#39;: 0.0011913026755765136,
 &#39;dr&#39;: 0.00019435043271928454,
 &#39;dr-os&#39;: 0.0011808587841598175,
 &#39;ipw&#39;: 0.00029734974429545586}
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># by activating the `scale` option, </span>
<span class="c1"># we obtain the cvar scores where the lowest score is scaled to 1</span>
<span class="n">cvar_scaled</span> <span class="o">=</span> <span class="n">evaluator</span><span class="o">.</span><span class="n">calculate_cvar_score</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">cvar_scaled</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;dm&#39;: 6.12966309829217,
 &#39;dr&#39;: 1.0,
 &#39;dr-os&#39;: 6.075925675274537,
 &#39;ipw&#39;: 1.529966978385591}
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="example-2-synthetic-p-score">
<h2>Example 2 - Synthetic P-Score<a class="headerlink" href="#example-2-synthetic-p-score" title="Permalink to this headline">¶</a></h2>
<p>A quickstart guide of pyIEOE using synthetic logged bandit feedback data and using estimated propensity scores of the behavior policy instead of the ground truth values.</p>
<p>This section demonstrates an example of conducting Interpretable Evaluation for Off-Policy Evaluation (IEOE). We use synthetic logged bandit feedback data generated using <a class="reference external" href="https://github.com/st-tech/zr-obp"><code class="docutils literal notranslate"><span class="pre">obp</span></code></a> and evaluate the performance of Direct Method (DM), Doubly Robust (DR), Doubly Robust with Shrinkage (DRos), and Inverse Probability Weighting (IPW).</p>
<p>Our example contains the following three major steps:</p>
<ol class="simple">
<li><p>Data Preparation</p></li>
<li><p>Setting Hyperparameter Spaces for Off-Policy Evaluation</p></li>
<li><p>Interpretable Evaluation for Off-Policy Evaluation</p></li>
</ol>
<div class="section" id="id1">
<h3>Data Preparation<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<p>In order to conduct IEOE using <code class="docutils literal notranslate"><span class="pre">pyieoe</span></code>, we need to prepare logged bandit feedback data, action distributions of evaluation policies, and ground truth policy values of evaluation policies. Because <code class="docutils literal notranslate"><span class="pre">pyieoe</span></code> is built with the intention of being used with <code class="docutils literal notranslate"><span class="pre">obp</span></code>, these inputs must follow the conventions in <code class="docutils literal notranslate"><span class="pre">obp</span></code>. Specifically, logged bandit feedback data must be of type <code class="docutils literal notranslate"><span class="pre">BanditFeedback</span></code>, action distributions must be of type <code class="docutils literal notranslate"><span class="pre">np.ndarray</span></code>, and ground truth policy values must be of type <code class="docutils literal notranslate"><span class="pre">float</span></code> (or <code class="docutils literal notranslate"><span class="pre">int</span></code>).</p>
<p>In this example, we generate synthetic logged bandit feedback data and perform off-policy learning to obtain two sets of evaluation policies along with their action distributions and ground truth policy values using <code class="docutils literal notranslate"><span class="pre">obp</span></code>. For a detailed explanation of this process, please refer to the <a class="reference external" href="https://github.com/st-tech/zr-obp/blob/master/examples/quickstart/quickstart_synthetic.ipynb">official obp example</a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># generate a synthetic bandit dataset with 10 actions</span>
<span class="c1"># we use `logistic function` as the reward function and `linear_behavior_policy` as the behavior policy.</span>
<span class="c1"># one can define their own reward function and behavior policy such as nonlinear ones. </span>
<span class="n">dataset</span> <span class="o">=</span> <span class="n">SyntheticBanditDataset</span><span class="p">(</span>
    <span class="n">n_actions</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
    <span class="n">dim_context</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
    <span class="n">reward_type</span><span class="o">=</span><span class="s2">&quot;binary&quot;</span><span class="p">,</span> <span class="c1"># &quot;binary&quot; or &quot;continuous&quot;</span>
    <span class="n">reward_function</span><span class="o">=</span><span class="n">logistic_reward_function</span><span class="p">,</span>
    <span class="n">behavior_policy_function</span><span class="o">=</span><span class="n">linear_behavior_policy</span><span class="p">,</span>
    <span class="n">random_state</span><span class="o">=</span><span class="mi">12345</span>
<span class="p">)</span>
<span class="c1"># obtain training and test sets of synthetic logged bandit feedback</span>
<span class="n">n_rounds_train</span><span class="p">,</span> <span class="n">n_rounds_test</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">,</span> <span class="mi">10000</span>
<span class="n">bandit_feedback_train</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">obtain_batch_bandit_feedback</span><span class="p">(</span><span class="n">n_rounds</span><span class="o">=</span><span class="n">n_rounds_train</span><span class="p">)</span>
<span class="n">bandit_feedback_test</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">obtain_batch_bandit_feedback</span><span class="p">(</span><span class="n">n_rounds</span><span class="o">=</span><span class="n">n_rounds_test</span><span class="p">)</span>

<span class="c1"># define IPWLearner with Logistic Regression as its base ML model</span>
<span class="n">evaluation_policy_a</span> <span class="o">=</span> <span class="n">IPWLearner</span><span class="p">(</span>
    <span class="n">n_actions</span><span class="o">=</span><span class="n">dataset</span><span class="o">.</span><span class="n">n_actions</span><span class="p">,</span>
    <span class="n">len_list</span><span class="o">=</span><span class="n">dataset</span><span class="o">.</span><span class="n">len_list</span><span class="p">,</span>
    <span class="n">base_classifier</span><span class="o">=</span><span class="n">LogisticRegression</span><span class="p">(</span><span class="n">C</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">12345</span><span class="p">)</span>
<span class="p">)</span>
<span class="c1"># train IPWLearner on the training set of the synthetic logged bandit feedback</span>
<span class="n">evaluation_policy_a</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
    <span class="n">context</span><span class="o">=</span><span class="n">bandit_feedback_train</span><span class="p">[</span><span class="s2">&quot;context&quot;</span><span class="p">],</span>
    <span class="n">action</span><span class="o">=</span><span class="n">bandit_feedback_train</span><span class="p">[</span><span class="s2">&quot;action&quot;</span><span class="p">],</span>
    <span class="n">reward</span><span class="o">=</span><span class="n">bandit_feedback_train</span><span class="p">[</span><span class="s2">&quot;reward&quot;</span><span class="p">],</span>
    <span class="n">pscore</span><span class="o">=</span><span class="n">bandit_feedback_train</span><span class="p">[</span><span class="s2">&quot;pscore&quot;</span><span class="p">]</span>
<span class="p">)</span>
<span class="c1"># obtains action choice probabilities for the test set of the synthetic logged bandit feedback</span>
<span class="n">action_dist_a</span> <span class="o">=</span> <span class="n">evaluation_policy_a</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span>
    <span class="n">context</span><span class="o">=</span><span class="n">bandit_feedback_test</span><span class="p">[</span><span class="s2">&quot;context&quot;</span><span class="p">],</span>
    <span class="n">tau</span><span class="o">=</span><span class="mf">0.1</span> <span class="c1"># temperature hyperparameter</span>
<span class="p">)</span>

<span class="c1"># define IPWLearner with Random Forest as its base ML model</span>
<span class="n">evaluation_policy_b</span> <span class="o">=</span> <span class="n">IPWLearner</span><span class="p">(</span>
    <span class="n">n_actions</span><span class="o">=</span><span class="n">dataset</span><span class="o">.</span><span class="n">n_actions</span><span class="p">,</span>
    <span class="n">len_list</span><span class="o">=</span><span class="n">dataset</span><span class="o">.</span><span class="n">len_list</span><span class="p">,</span>
    <span class="n">base_classifier</span><span class="o">=</span><span class="n">RandomForest</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">min_samples_leaf</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">12345</span><span class="p">)</span>
<span class="p">)</span>
<span class="c1"># train IPWLearner on the training set of the synthetic logged bandit feedback</span>
<span class="n">evaluation_policy_b</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
    <span class="n">context</span><span class="o">=</span><span class="n">bandit_feedback_train</span><span class="p">[</span><span class="s2">&quot;context&quot;</span><span class="p">],</span>
    <span class="n">action</span><span class="o">=</span><span class="n">bandit_feedback_train</span><span class="p">[</span><span class="s2">&quot;action&quot;</span><span class="p">],</span>
    <span class="n">reward</span><span class="o">=</span><span class="n">bandit_feedback_train</span><span class="p">[</span><span class="s2">&quot;reward&quot;</span><span class="p">],</span>
    <span class="n">pscore</span><span class="o">=</span><span class="n">bandit_feedback_train</span><span class="p">[</span><span class="s2">&quot;pscore&quot;</span><span class="p">]</span>
<span class="p">)</span>
<span class="c1"># obtains action choice probabilities for the test set of the synthetic logged bandit feedback</span>
<span class="n">action_dist_b</span> <span class="o">=</span> <span class="n">evaluation_policy_b</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span>
    <span class="n">context</span><span class="o">=</span><span class="n">bandit_feedback_test</span><span class="p">[</span><span class="s2">&quot;context&quot;</span><span class="p">],</span>
    <span class="n">tau</span><span class="o">=</span><span class="mf">0.1</span> <span class="c1"># temperature hyperparameter</span>
<span class="p">)</span>

<span class="c1"># obtain ground truth policy value for each action choice probabilities</span>
<span class="n">expected_rewards</span> <span class="o">=</span> <span class="n">bandit_feedback_test</span><span class="p">[</span><span class="s2">&quot;expected_reward&quot;</span><span class="p">]</span>
<span class="n">ground_truth_a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">expected_rewards</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">action_dist_a</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">ground_truth_b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">expected_rewards</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">action_dist_b</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="id2">
<h3>Setting Hyperparameter Spaces for Off-Policy Evaluation<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h3>
<p>An integral aspect of IEOE is the different sources of variance. The main sources of variance are evaluation policies, random states, hyperparameters of OPE estimators, and hyperparameters of regression models.</p>
<p>In this step, we define the spaces from which the hyperparameters of OPE estimators / regression models are chosen. (The evaluation policy space is defined in the previous step, and the random state space will be defined in the next step.)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># set hyperparameter space for ope estimators</span>

<span class="c1"># set hyperparameter space for the doubly robust with shrinkage estimator</span>
<span class="c1"># with the following code, lambda_ will be chosen from a logarithm uniform distribution over the interval [0.001, 1000]</span>
<span class="n">lambda_</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;lower&quot;</span><span class="p">:</span> <span class="mf">1e-3</span><span class="p">,</span>
    <span class="s2">&quot;upper&quot;</span><span class="p">:</span> <span class="mf">1e3</span><span class="p">,</span>
    <span class="s2">&quot;log&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="nb">float</span>
<span class="p">}</span>
<span class="n">dros_param</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;lambda_&quot;</span><span class="p">:</span> <span class="n">lambda_</span><span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># set hyperparameter space for regression models</span>

<span class="c1"># set hyperparameter space for logistic regression</span>
<span class="c1"># with the following code, C will be chosen from a logarithm uniform distribution over the interval [0.001, 100]</span>
<span class="n">C</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;lower&quot;</span><span class="p">:</span> <span class="mf">1e-3</span><span class="p">,</span>
    <span class="s2">&quot;upper&quot;</span><span class="p">:</span> <span class="mf">1e2</span><span class="p">,</span>
    <span class="s2">&quot;log&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="nb">float</span>
<span class="p">}</span>
<span class="c1"># create a dictionary mapping hyperparamter names to hyperparamter spaces</span>
<span class="n">logistic_regression_param</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;C&quot;</span><span class="p">:</span> <span class="n">C</span><span class="p">}</span>

<span class="c1"># set hyperparameter space for the random forest classifier</span>
<span class="c1"># with the following code, n_estimators will be chosen from a logarithm uniform distribution over the interval [50, 100]</span>
<span class="c1"># the chosen value will be of type int</span>
<span class="n">n_estimators</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;lower&quot;</span><span class="p">:</span> <span class="mf">5e1</span><span class="p">,</span>
    <span class="s2">&quot;upper&quot;</span><span class="p">:</span> <span class="mf">1e2</span><span class="p">,</span>
    <span class="s2">&quot;log&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="nb">int</span>
<span class="p">}</span>
<span class="c1"># with the following code, max_depth will be chosen from a uniform distribution over the interval [2, 10]</span>
<span class="c1"># the chosen value will be of type int</span>
<span class="n">max_depth</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;lower&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
    <span class="s2">&quot;upper&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
    <span class="s2">&quot;log&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="nb">int</span>
<span class="p">}</span>
<span class="c1"># with the following code, min_samples_split will be chosen from a uniform distribution over the interval [2, 10]</span>
<span class="c1"># the chosen value will be of type int</span>
<span class="n">min_samples_split</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;lower&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
    <span class="s2">&quot;upper&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
    <span class="s2">&quot;log&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="nb">int</span>
<span class="p">}</span>
<span class="c1"># create a dictionary mapping hyperparamter names to hyperparamter spaces</span>
<span class="n">random_forest_param</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;n_estimators&quot;</span><span class="p">:</span> <span class="n">n_estimators</span><span class="p">,</span> 
    <span class="s2">&quot;max_depth&quot;</span><span class="p">:</span> <span class="n">max_depth</span><span class="p">,</span> 
    <span class="s2">&quot;min_samples_split&quot;</span><span class="p">:</span> <span class="n">min_samples_split</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="id3">
<h3>Interpretable Evaluation for Off-Policy Evaluation<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h3>
<p>With the above steps completed, we can finally conduct IEOE by utilizing the <code class="docutils literal notranslate"><span class="pre">InterpretableOPEEvaluator</span></code> class.</p>
<p>Here is a brief description for each parameter that can be passed into <code class="docutils literal notranslate"><span class="pre">InterpretableOPEEvaluator</span></code>:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">random_states</span></code>: a list of integers representing the random_state used when performing OPE; corresponds to the number of iterations</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">bandit_feedback</span></code>: a list of logged bandit feedback data</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">evaluation_policies</span></code>: a list of tuples representing (ground truth policy value, action distribution)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ope_estimators</span></code>: a list of OPE ope_estimators</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ope_estimator_hyperparams</span></code>: a dictionary mapping OPE estimator names to OPE estimator hyperparameter spaces defined in step 2</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">regression_models</span></code>: a list of regression_models</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">regression_model_hyperparams</span></code>: a dictionary mapping regression models to regression model hyperparameter spaces defined in step 2</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># initializing class</span>
<span class="n">evaluator</span> <span class="o">=</span> <span class="n">InterpretableOPEEvaluator</span><span class="p">(</span>
    <span class="n">random_states</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1000</span><span class="p">),</span>
    <span class="n">bandit_feedbacks</span><span class="o">=</span><span class="p">[</span><span class="n">bandit_feedback_test</span><span class="p">],</span>
    <span class="n">evaluation_policies</span><span class="o">=</span><span class="p">[</span>
        <span class="p">(</span><span class="n">ground_truth_a</span><span class="p">,</span> <span class="n">action_dist_a</span><span class="p">),</span> 
        <span class="p">(</span><span class="n">ground_truth_b</span><span class="p">,</span> <span class="n">action_dist_b</span><span class="p">)</span>
    <span class="p">],</span>
    <span class="n">ope_estimators</span><span class="o">=</span><span class="p">[</span>
        <span class="n">DirectMethod</span><span class="p">(),</span>
        <span class="n">DoublyRobust</span><span class="p">(),</span>
        <span class="n">DoublyRobustWithShrinkage</span><span class="p">(),</span>
        <span class="n">InverseProbabilityWeighting</span><span class="p">(),</span> 
    <span class="p">],</span>
    <span class="n">ope_estimator_hyperparams</span><span class="o">=</span><span class="p">{</span>
        <span class="n">DoublyRobustWithShrinkage</span><span class="o">.</span><span class="n">estimator_name</span><span class="p">:</span> <span class="n">dros_param</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="n">regression_models</span><span class="o">=</span><span class="p">[</span>
        <span class="n">LogisticRegression</span><span class="p">,</span>
        <span class="n">RandomForest</span>
    <span class="p">],</span>
    <span class="n">regression_model_hyperparams</span><span class="o">=</span><span class="p">{</span>
        <span class="n">LogisticRegression</span><span class="p">:</span> <span class="n">logistic_regression_param</span><span class="p">,</span>
        <span class="n">RandomForest</span><span class="p">:</span> <span class="n">random_forest_param</span>
    <span class="p">},</span>
    <span class="n">pscore_estimators</span><span class="o">=</span><span class="p">[</span>
        <span class="n">LogisticRegression</span><span class="p">,</span>
        <span class="n">RandomForest</span>
    <span class="p">],</span>
    <span class="n">pscore_estimator_hyperparams</span><span class="o">=</span><span class="p">{</span>
        <span class="n">LogisticRegression</span><span class="p">:</span> <span class="n">logistic_regression_param</span><span class="p">,</span>
        <span class="n">RandomForest</span><span class="p">:</span> <span class="n">random_forest_param</span>
    <span class="p">}</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We can set the hyperparameters of OPE estimators / regression models after initializing <code class="docutils literal notranslate"><span class="pre">InterpretableOPEEvaluator</span></code> as well. Below is an example:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># re-set hyperparameter space for the doubly robust with shrinkage estimator</span>
<span class="c1"># with the following code, lambda_ will now be chosen from a logarithm uniform distribution over the interval [0.001, 100]</span>
<span class="n">evaluator</span><span class="o">.</span><span class="n">set_ope_estimator_hyperparam_space</span><span class="p">(</span>
    <span class="n">DoublyRobustWithShrinkage</span><span class="o">.</span><span class="n">estimator_name</span><span class="p">,</span>
    <span class="n">param_name</span><span class="o">=</span><span class="s2">&quot;lambda_&quot;</span><span class="p">,</span>
    <span class="n">lower</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span>
    <span class="n">upper</span><span class="o">=</span><span class="mf">1e2</span><span class="p">,</span>
    <span class="n">log</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">type_</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># re-set hyperparameter space for logistic regression</span>
<span class="c1"># with the following code, C will now be chosen from a logarithm uniform distribution over the interval [0.001, 100]</span>
<span class="n">evaluator</span><span class="o">.</span><span class="n">set_regression_model_hyperparam_space</span><span class="p">(</span>
    <span class="n">LogisticRegression</span><span class="p">,</span>
    <span class="n">param_name</span><span class="o">=</span><span class="s2">&quot;C&quot;</span><span class="p">,</span>
    <span class="n">lower</span><span class="o">=</span><span class="mf">1e-2</span><span class="p">,</span>
    <span class="n">upper</span><span class="o">=</span><span class="mf">1e2</span><span class="p">,</span>
    <span class="n">log</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">type_</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Once we have initialized <code class="docutils literal notranslate"><span class="pre">InterpretableOPEEvaluator</span></code>, we can call implemented methods to perform IEOE.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># estimate policy values</span>
<span class="c1"># we obtain a dictionary mapping ope estimator names to np.ndarray storing the estimated policy value for each iteration</span>
<span class="n">policy_value</span> <span class="o">=</span> <span class="n">evaluator</span><span class="o">.</span><span class="n">estimate_policy_value</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100%|██████████| 1000/1000 [24:26&lt;00:00,  1.47s/it]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;dm:&quot;</span><span class="p">,</span> <span class="n">policy_value</span><span class="p">[</span><span class="s2">&quot;dm&quot;</span><span class="p">][:</span><span class="mi">3</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;dr:&quot;</span><span class="p">,</span> <span class="n">policy_value</span><span class="p">[</span><span class="s2">&quot;dr&quot;</span><span class="p">][:</span><span class="mi">3</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;dr-os:&quot;</span><span class="p">,</span> <span class="n">policy_value</span><span class="p">[</span><span class="s2">&quot;dr-os&quot;</span><span class="p">][:</span><span class="mi">3</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ipw:&quot;</span><span class="p">,</span> <span class="n">policy_value</span><span class="p">[</span><span class="s2">&quot;ipw&quot;</span><span class="p">][:</span><span class="mi">3</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>dm: [0.61928102 0.61815126 0.62100605]
dr: [0.63491063 0.62905724 0.63769723]
dr-os: [0.61845464 0.6172667  0.61979627]
ipw: [0.63454838 0.59634147 0.63845108]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># compute squared errors</span>
<span class="c1"># we obtain a dictionary mapping ope estimator names to np.ndarray storing the calculated squared error for each iteration</span>
<span class="n">squared_error</span> <span class="o">=</span> <span class="n">evaluator</span><span class="o">.</span><span class="n">calculate_squared_error</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;dm:&quot;</span><span class="p">,</span> <span class="n">squared_error</span><span class="p">[</span><span class="s2">&quot;dm&quot;</span><span class="p">][:</span><span class="mi">3</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;dr:&quot;</span><span class="p">,</span> <span class="n">squared_error</span><span class="p">[</span><span class="s2">&quot;dr&quot;</span><span class="p">][:</span><span class="mi">3</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;dr-os:&quot;</span><span class="p">,</span> <span class="n">squared_error</span><span class="p">[</span><span class="s2">&quot;dr-os&quot;</span><span class="p">][:</span><span class="mi">3</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ipw:&quot;</span><span class="p">,</span> <span class="n">squared_error</span><span class="p">[</span><span class="s2">&quot;ipw&quot;</span><span class="p">][:</span><span class="mi">3</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>dm: [0.00016377 0.00024432 0.0001226 ]
dr: [8.02190891e-06 2.23240194e-05 3.15720425e-05]
dr-os: [0.0001856  0.00027276 0.00015085]
ipw: [6.10115801e-06 1.40179838e-03 4.06119256e-05]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># visualize cdf of squared errors for all ope estimators</span>
<span class="n">evaluator</span><span class="o">.</span><span class="n">visualize_cdf_aggregate</span><span class="p">(</span><span class="n">xmax</span><span class="o">=</span><span class="mf">0.002</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;Figure size 432x288 with 0 Axes&gt;
</pre></div>
</div>
<img alt="../_images/T902666_Evaluating_the_Robustness_of_Off_Policy_Evaluation_52_1.png" src="../_images/T902666_Evaluating_the_Robustness_of_Off_Policy_Evaluation_52_1.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># compute the au-cdf score (area under cdf of squared error over interval [0, thershold]), higher score is better</span>
<span class="c1"># we obtain a dictionary mapping ope estimator names to cvar scores </span>
<span class="n">au_cdf</span> <span class="o">=</span> <span class="n">evaluator</span><span class="o">.</span><span class="n">calculate_au_cdf_score</span><span class="p">(</span><span class="n">threshold</span><span class="o">=</span><span class="mf">0.0004</span><span class="p">)</span>
<span class="n">au_cdf</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;dm&#39;: 4.842819420579869e-05,
 &#39;dr&#39;: 0.0003466009625279595,
 &#39;dr-os&#39;: 0.00012101638056751279,
 &#39;ipw&#39;: 0.00020585995217926292}
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># by activating the `scale` option, </span>
<span class="c1"># we obtain the au_cdf scores where the highest score is scaled to 1</span>
<span class="n">au_cdf_scaled</span> <span class="o">=</span> <span class="n">evaluator</span><span class="o">.</span><span class="n">calculate_au_cdf_score</span><span class="p">(</span><span class="n">threshold</span><span class="o">=</span><span class="mf">0.0004</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">au_cdf_scaled</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;dm&#39;: 0.13972319595590305,
 &#39;dr&#39;: 1.0,
 &#39;dr-os&#39;: 0.34915188834119487,
 &#39;ipw&#39;: 0.5939393551529929}
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># compute the cvar score (expected value of squared error above probability alpha), lower score is better</span>
<span class="c1"># we obtain a dictionary mapping ope estimator names to cvar scores </span>
<span class="n">cvar</span> <span class="o">=</span> <span class="n">evaluator</span><span class="o">.</span><span class="n">calculate_cvar_score</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>
<span class="n">cvar</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;dm&#39;: 0.0011913026755765136,
 &#39;dr&#39;: 0.0002413591310464852,
 &#39;dr-os&#39;: 0.0011775829027122176,
 &#39;ipw&#39;: 0.006564340612263946}
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># by activating the `scale` option, </span>
<span class="c1"># we obtain the cvar scores where the lowest score is scaled to 1</span>
<span class="n">cvar_scaled</span> <span class="o">=</span> <span class="n">evaluator</span><span class="o">.</span><span class="n">calculate_cvar_score</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">cvar_scaled</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;dm&#39;: 4.93580943224009,
 &#39;dr&#39;: 1.0,
 &#39;dr-os&#39;: 4.878965621091078,
 &#39;ipw&#39;: 27.19739909487688}
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="example-3-synthetic-rscv">
<h2>Example 3 - Synthetic RSCV<a class="headerlink" href="#example-3-synthetic-rscv" title="Permalink to this headline">¶</a></h2>
<p>A quickstart guide of pyIEOE using synthetic logged bandit feedback data and using RandomizedSearchCV for regression models and pscore estimators.</p>
<div class="section" id="id4">
<h3>Data Preparation<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h3>
<p>In order to conduct IEOE using <code class="docutils literal notranslate"><span class="pre">pyieoe</span></code>, we need to prepare logged bandit feedback data, action distributions of evaluation policies, and ground truth policy values of evaluation policies. Because <code class="docutils literal notranslate"><span class="pre">pyieoe</span></code> is built with the intention of being used with <code class="docutils literal notranslate"><span class="pre">obp</span></code>, these inputs must follow the conventions in <code class="docutils literal notranslate"><span class="pre">obp</span></code>. Specifically, logged bandit feedback data must be of type <code class="docutils literal notranslate"><span class="pre">BanditFeedback</span></code>, action distributions must be of type <code class="docutils literal notranslate"><span class="pre">np.ndarray</span></code>, and ground truth policy values must be of type <code class="docutils literal notranslate"><span class="pre">float</span></code> (or <code class="docutils literal notranslate"><span class="pre">int</span></code>).</p>
<p>In this example, we generate synthetic logged bandit feedback data and perform off-policy learning to obtain two sets of evaluation policies along with their action distributions and ground truth policy values using <code class="docutils literal notranslate"><span class="pre">obp</span></code>. For a detailed explanation of this process, please refer to the <a class="reference external" href="https://github.com/st-tech/zr-obp/blob/master/examples/quickstart/quickstart_synthetic.ipynb">official obp example</a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># generate a synthetic bandit dataset with 10 actions</span>
<span class="c1"># we use `logistic function` as the reward function and `linear_behavior_policy` as the behavior policy.</span>
<span class="c1"># one can define their own reward function and behavior policy such as nonlinear ones. </span>
<span class="n">dataset</span> <span class="o">=</span> <span class="n">SyntheticBanditDataset</span><span class="p">(</span>
    <span class="n">n_actions</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
    <span class="n">dim_context</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
    <span class="n">reward_type</span><span class="o">=</span><span class="s2">&quot;binary&quot;</span><span class="p">,</span> <span class="c1"># &quot;binary&quot; or &quot;continuous&quot;</span>
    <span class="n">reward_function</span><span class="o">=</span><span class="n">logistic_reward_function</span><span class="p">,</span>
    <span class="n">behavior_policy_function</span><span class="o">=</span><span class="n">linear_behavior_policy</span><span class="p">,</span>
    <span class="n">random_state</span><span class="o">=</span><span class="mi">12345</span>
<span class="p">)</span>
<span class="c1"># obtain training and test sets of synthetic logged bandit feedback</span>
<span class="n">n_rounds_train</span><span class="p">,</span> <span class="n">n_rounds_test</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">,</span> <span class="mi">10000</span>
<span class="n">bandit_feedback_train</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">obtain_batch_bandit_feedback</span><span class="p">(</span><span class="n">n_rounds</span><span class="o">=</span><span class="n">n_rounds_train</span><span class="p">)</span>
<span class="n">bandit_feedback_test</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">obtain_batch_bandit_feedback</span><span class="p">(</span><span class="n">n_rounds</span><span class="o">=</span><span class="n">n_rounds_test</span><span class="p">)</span>

<span class="c1"># define IPWLearner with Logistic Regression as its base ML model</span>
<span class="n">evaluation_policy_a</span> <span class="o">=</span> <span class="n">IPWLearner</span><span class="p">(</span>
    <span class="n">n_actions</span><span class="o">=</span><span class="n">dataset</span><span class="o">.</span><span class="n">n_actions</span><span class="p">,</span>
    <span class="n">len_list</span><span class="o">=</span><span class="n">dataset</span><span class="o">.</span><span class="n">len_list</span><span class="p">,</span>
    <span class="n">base_classifier</span><span class="o">=</span><span class="n">LogisticRegression</span><span class="p">(</span><span class="n">C</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">12345</span><span class="p">)</span>
<span class="p">)</span>
<span class="c1"># train IPWLearner on the training set of the synthetic logged bandit feedback</span>
<span class="n">evaluation_policy_a</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
    <span class="n">context</span><span class="o">=</span><span class="n">bandit_feedback_train</span><span class="p">[</span><span class="s2">&quot;context&quot;</span><span class="p">],</span>
    <span class="n">action</span><span class="o">=</span><span class="n">bandit_feedback_train</span><span class="p">[</span><span class="s2">&quot;action&quot;</span><span class="p">],</span>
    <span class="n">reward</span><span class="o">=</span><span class="n">bandit_feedback_train</span><span class="p">[</span><span class="s2">&quot;reward&quot;</span><span class="p">],</span>
    <span class="n">pscore</span><span class="o">=</span><span class="n">bandit_feedback_train</span><span class="p">[</span><span class="s2">&quot;pscore&quot;</span><span class="p">]</span>
<span class="p">)</span>
<span class="c1"># obtains action choice probabilities for the test set of the synthetic logged bandit feedback</span>
<span class="n">action_dist_a</span> <span class="o">=</span> <span class="n">evaluation_policy_a</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span>
    <span class="n">context</span><span class="o">=</span><span class="n">bandit_feedback_test</span><span class="p">[</span><span class="s2">&quot;context&quot;</span><span class="p">],</span>
    <span class="n">tau</span><span class="o">=</span><span class="mf">0.1</span> <span class="c1"># temperature hyperparameter</span>
<span class="p">)</span>

<span class="c1"># define IPWLearner with Random Forest as its base ML model</span>
<span class="n">evaluation_policy_b</span> <span class="o">=</span> <span class="n">IPWLearner</span><span class="p">(</span>
    <span class="n">n_actions</span><span class="o">=</span><span class="n">dataset</span><span class="o">.</span><span class="n">n_actions</span><span class="p">,</span>
    <span class="n">len_list</span><span class="o">=</span><span class="n">dataset</span><span class="o">.</span><span class="n">len_list</span><span class="p">,</span>
    <span class="n">base_classifier</span><span class="o">=</span><span class="n">RandomForest</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">min_samples_leaf</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">12345</span><span class="p">)</span>
<span class="p">)</span>
<span class="c1"># train IPWLearner on the training set of the synthetic logged bandit feedback</span>
<span class="n">evaluation_policy_b</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
    <span class="n">context</span><span class="o">=</span><span class="n">bandit_feedback_train</span><span class="p">[</span><span class="s2">&quot;context&quot;</span><span class="p">],</span>
    <span class="n">action</span><span class="o">=</span><span class="n">bandit_feedback_train</span><span class="p">[</span><span class="s2">&quot;action&quot;</span><span class="p">],</span>
    <span class="n">reward</span><span class="o">=</span><span class="n">bandit_feedback_train</span><span class="p">[</span><span class="s2">&quot;reward&quot;</span><span class="p">],</span>
    <span class="n">pscore</span><span class="o">=</span><span class="n">bandit_feedback_train</span><span class="p">[</span><span class="s2">&quot;pscore&quot;</span><span class="p">]</span>
<span class="p">)</span>
<span class="c1"># obtains action choice probabilities for the test set of the synthetic logged bandit feedback</span>
<span class="n">action_dist_b</span> <span class="o">=</span> <span class="n">evaluation_policy_b</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span>
    <span class="n">context</span><span class="o">=</span><span class="n">bandit_feedback_test</span><span class="p">[</span><span class="s2">&quot;context&quot;</span><span class="p">],</span>
    <span class="n">tau</span><span class="o">=</span><span class="mf">0.1</span> <span class="c1"># temperature hyperparameter</span>
<span class="p">)</span>

<span class="c1"># obtain ground truth policy value for each action choice probabilities</span>
<span class="n">expected_rewards</span> <span class="o">=</span> <span class="n">bandit_feedback_test</span><span class="p">[</span><span class="s2">&quot;expected_reward&quot;</span><span class="p">]</span>
<span class="n">ground_truth_a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">expected_rewards</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">action_dist_a</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">ground_truth_b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">expected_rewards</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">action_dist_b</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="id5">
<h3>Setting Hyperparameter Spaces for Off-Policy Evaluation<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h3>
<p>An integral aspect of IEOE is the different sources of variance. The main sources of variance are evaluation policies, random states, hyperparameters of OPE estimators, and hyperparameters of regression models.</p>
<p>In this step, we define the spaces from which the hyperparameters of OPE estimators / regression models are chosen. (The evaluation policy space is defined in the previous step, and the random state space will be defined in the next step.)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># set hyperparameter space for ope estimators</span>

<span class="c1"># set hyperparameter space for the doubly robust with shrinkage estimator</span>
<span class="c1"># with the following code, lambda_ will be chosen from a logarithm uniform distribution over the interval [0.001, 1000]</span>
<span class="n">lambda_</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;lower&quot;</span><span class="p">:</span> <span class="mf">1e-3</span><span class="p">,</span>
    <span class="s2">&quot;upper&quot;</span><span class="p">:</span> <span class="mf">1e3</span><span class="p">,</span>
    <span class="s2">&quot;log&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="nb">float</span>
<span class="p">}</span>
<span class="n">dros_param</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;lambda_&quot;</span><span class="p">:</span> <span class="n">lambda_</span><span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># set hyperparameter space for logistic regression using RandomizedSearchCV</span>

<span class="kn">from</span> <span class="nn">sklearn.utils.fixes</span> <span class="kn">import</span> <span class="n">loguniform</span>
<span class="n">logistic</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">()</span>
<span class="n">distributions</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;C&quot;</span><span class="p">:</span> <span class="n">loguniform</span><span class="p">(</span><span class="mf">1e-2</span><span class="p">,</span> <span class="mf">1e2</span><span class="p">)</span>
<span class="p">}</span>
<span class="n">clf_logistic</span> <span class="o">=</span> <span class="n">RandomizedSearchCV</span><span class="p">(</span><span class="n">logistic</span><span class="p">,</span> <span class="n">distributions</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_iter</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># set hyperparameter space for random forest classifier using RandomizedSearchCV</span>

<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">randint</span>
<span class="n">randforest</span> <span class="o">=</span> <span class="n">RandomForest</span><span class="p">()</span>
<span class="n">distributions</span> <span class="o">=</span> <span class="p">{</span>
    <span class="c1"># n_estimators will be chosen from a uniform distribution over the interval [50, 100)</span>
    <span class="s2">&quot;n_estimators&quot;</span><span class="p">:</span> <span class="n">randint</span><span class="p">(</span><span class="mf">5e1</span><span class="p">,</span> <span class="mf">1e2</span><span class="p">),</span> 
    <span class="c1"># max_depth will be chosen from a uniform distribution over the interval [2, 10)</span>
    <span class="s2">&quot;max_depth&quot;</span><span class="p">:</span> <span class="n">randint</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> 
    <span class="c1"># min_samples_split will be chosen from a uniform distribution over the interval [2, 10)</span>
    <span class="s2">&quot;min_samples_split&quot;</span><span class="p">:</span> <span class="n">randint</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<span class="p">}</span>
<span class="n">clf_randforest</span> <span class="o">=</span> <span class="n">RandomizedSearchCV</span><span class="p">(</span><span class="n">randforest</span><span class="p">,</span> <span class="n">distributions</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_iter</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="id6">
<h3>Interpretable Evaluation for Off-Policy Evaluation<a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h3>
<p>With the above steps completed, we can finally conduct IEOE by utilizing the <code class="docutils literal notranslate"><span class="pre">InterpretableOPEEvaluator</span></code> class.</p>
<p>Here is a brief description for each parameter that can be passed into <code class="docutils literal notranslate"><span class="pre">InterpretableOPEEvaluator</span></code>:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">random_states</span></code>: a list of integers representing the random_state used when performing OPE; corresponds to the number of iterations</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">bandit_feedback</span></code>: a list of logged bandit feedback data</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">evaluation_policies</span></code>: a list of tuples representing (ground truth policy value, action distribution)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ope_estimators</span></code>: a list of OPE ope_estimators</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ope_estimator_hyperparams</span></code>: a dictionary mapping OPE estimator names to OPE estimator hyperparameter spaces defined in step 2</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">regression_models</span></code>: a list of regression_models</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">regression_model_hyperparams</span></code>: a dictionary mapping regression models to regression model hyperparameter spaces defined in step 2</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># initializing class</span>
<span class="n">evaluator</span> <span class="o">=</span> <span class="n">InterpretableOPEEvaluator</span><span class="p">(</span>
    <span class="n">random_states</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span>
    <span class="n">bandit_feedbacks</span><span class="o">=</span><span class="p">[</span><span class="n">bandit_feedback_test</span><span class="p">],</span>
    <span class="n">evaluation_policies</span><span class="o">=</span><span class="p">[</span>
        <span class="p">(</span><span class="n">ground_truth_a</span><span class="p">,</span> <span class="n">action_dist_a</span><span class="p">),</span> 
        <span class="p">(</span><span class="n">ground_truth_b</span><span class="p">,</span> <span class="n">action_dist_b</span><span class="p">)</span>
    <span class="p">],</span>
    <span class="n">ope_estimators</span><span class="o">=</span><span class="p">[</span>
        <span class="n">DirectMethod</span><span class="p">(),</span>
        <span class="n">DoublyRobust</span><span class="p">(),</span>
        <span class="n">DoublyRobustWithShrinkage</span><span class="p">(),</span>
        <span class="n">InverseProbabilityWeighting</span><span class="p">(),</span> 
    <span class="p">],</span>
    <span class="n">ope_estimator_hyperparams</span><span class="o">=</span><span class="p">{</span>
        <span class="n">DoublyRobustWithShrinkage</span><span class="o">.</span><span class="n">estimator_name</span><span class="p">:</span> <span class="n">dros_param</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="n">regression_models</span><span class="o">=</span><span class="p">[</span>
        <span class="n">clf_logistic</span><span class="p">,</span>
        <span class="n">clf_randforest</span>
    <span class="p">],</span>
    <span class="n">pscore_estimators</span><span class="o">=</span><span class="p">[</span>
        <span class="n">clf_logistic</span><span class="p">,</span>
        <span class="n">clf_randforest</span>
    <span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Once we have initialized <code class="docutils literal notranslate"><span class="pre">InterpretableOPEEvaluator</span></code>, we can call implemented methods to perform IEOE.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># estimate policy values</span>
<span class="c1"># we obtain a dictionary mapping ope estimator names to np.ndarray storing the estimated policy value for each iteration</span>
<span class="n">policy_value</span> <span class="o">=</span> <span class="n">evaluator</span><span class="o">.</span><span class="n">estimate_policy_value</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100%|██████████| 100/100 [42:58&lt;00:00, 25.78s/it] 
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;dm:&quot;</span><span class="p">,</span> <span class="n">policy_value</span><span class="p">[</span><span class="s2">&quot;dm&quot;</span><span class="p">][:</span><span class="mi">3</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;dr:&quot;</span><span class="p">,</span> <span class="n">policy_value</span><span class="p">[</span><span class="s2">&quot;dr&quot;</span><span class="p">][:</span><span class="mi">3</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;dr-os:&quot;</span><span class="p">,</span> <span class="n">policy_value</span><span class="p">[</span><span class="s2">&quot;dr-os&quot;</span><span class="p">][:</span><span class="mi">3</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ipw:&quot;</span><span class="p">,</span> <span class="n">policy_value</span><span class="p">[</span><span class="s2">&quot;ipw&quot;</span><span class="p">][:</span><span class="mi">3</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>dm: [0.61533497 0.62502863 0.62595308]
dr: [0.63454837 0.6498667  0.64764559]
dr-os: [0.61847981 0.62353027 0.62459582]
ipw: [0.63682535 0.6512438  0.6464395 ]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># compute squared errors</span>
<span class="c1"># we obtain a dictionary mapping ope estimator names to np.ndarray storing the calculated squared error for each iteration</span>
<span class="n">squared_error</span> <span class="o">=</span> <span class="n">evaluator</span><span class="o">.</span><span class="n">calculate_squared_error</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;dm:&quot;</span><span class="p">,</span> <span class="n">squared_error</span><span class="p">[</span><span class="s2">&quot;dm&quot;</span><span class="p">][:</span><span class="mi">3</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;dr:&quot;</span><span class="p">,</span> <span class="n">squared_error</span><span class="p">[</span><span class="s2">&quot;dr&quot;</span><span class="p">][:</span><span class="mi">3</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;dr-os:&quot;</span><span class="p">,</span> <span class="n">squared_error</span><span class="p">[</span><span class="s2">&quot;dr-os&quot;</span><span class="p">][:</span><span class="mi">3</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ipw:&quot;</span><span class="p">,</span> <span class="n">squared_error</span><span class="p">[</span><span class="s2">&quot;ipw&quot;</span><span class="p">][:</span><span class="mi">3</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>dm: [3.57123403e-04 7.67642667e-05 6.85517345e-05]
dr: [9.96635880e-08 2.58455440e-04 1.79906369e-04]
dr-os: [2.48152724e-04 1.05265196e-04 9.28690429e-05]
ipw: [6.72196710e-06 3.04629826e-04 1.49006452e-04]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># visualize cdf of squared errors for all ope estimators</span>
<span class="n">evaluator</span><span class="o">.</span><span class="n">visualize_cdf_aggregate</span><span class="p">(</span><span class="n">xmax</span><span class="o">=</span><span class="mf">0.002</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;Figure size 432x288 with 0 Axes&gt;
</pre></div>
</div>
<img alt="../_images/T902666_Evaluating_the_Robustness_of_Off_Policy_Evaluation_72_1.png" src="../_images/T902666_Evaluating_the_Robustness_of_Off_Policy_Evaluation_72_1.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># compute the au-cdf score (area under cdf of squared error over interval [0, thershold]), higher score is better</span>
<span class="c1"># we obtain a dictionary mapping ope estimator names to cvar scores </span>
<span class="n">au_cdf</span> <span class="o">=</span> <span class="n">evaluator</span><span class="o">.</span><span class="n">calculate_au_cdf_score</span><span class="p">(</span><span class="n">threshold</span><span class="o">=</span><span class="mf">0.0004</span><span class="p">)</span>
<span class="n">au_cdf</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;dm&#39;: 0.00017462629944369262,
 &#39;dr&#39;: 0.0003039477544441512,
 &#39;dr-os&#39;: 0.00022192684331982026,
 &#39;ipw&#39;: 0.00027946158685387886}
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># by activating the `scale` option, </span>
<span class="c1"># we obtain the au_cdf scores where the highest score is scaled to 1</span>
<span class="n">au_cdf_scaled</span> <span class="o">=</span> <span class="n">evaluator</span><span class="o">.</span><span class="n">calculate_au_cdf_score</span><span class="p">(</span><span class="n">threshold</span><span class="o">=</span><span class="mf">0.0004</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">au_cdf_scaled</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;dm&#39;: 0.5745273550812803,
 &#39;dr&#39;: 1.0,
 &#39;dr-os&#39;: 0.7301479944330306,
 &#39;ipw&#39;: 0.9194395509351541}
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># compute the cvar score (expected value of squared error above probability alpha), lower score is better</span>
<span class="c1"># we obtain a dictionary mapping ope estimator names to cvar scores </span>
<span class="n">cvar</span> <span class="o">=</span> <span class="n">evaluator</span><span class="o">.</span><span class="n">calculate_cvar_score</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>
<span class="n">cvar</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;dm&#39;: 0.0005265251431511972,
 &#39;dr&#39;: 0.00035002638397540044,
 &#39;dr-os&#39;: 0.00048265567771403026,
 &#39;ipw&#39;: 0.001182280933254418}
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># by activating the `scale` option, </span>
<span class="c1"># we obtain the cvar scores where the lowest score is scaled to 1</span>
<span class="n">cvar_scaled</span> <span class="o">=</span> <span class="n">evaluator</span><span class="o">.</span><span class="n">calculate_cvar_score</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">cvar_scaled</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;dm&#39;: 1.5042441577438372,
 &#39;dr&#39;: 1.0,
 &#39;dr-os&#39;: 1.3789122757899042,
 &#39;ipw&#39;: 3.3776909038305742}
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="example-4-multiclass-dataset">
<h2>Example 4 - Multiclass dataset<a class="headerlink" href="#example-4-multiclass-dataset" title="Permalink to this headline">¶</a></h2>
<p>A quickstart guide of pyIEOE using multiclass classification data as logged bandit feedback data.</p>
<p>This section demonstrates an example of conducting Interpretable Evaluation for Off-Policy Evaluation (IEOE). We use logged bandit feedback data generated by modifying multiclass classification data using <a class="reference external" href="https://github.com/st-tech/zr-obp"><code class="docutils literal notranslate"><span class="pre">obp</span></code></a> and evaluate the performance of Direct Method (DM), Doubly Robust (DR), Doubly Robust with Shrinkage (DRos), and Inverse Probability Weighting (IPW).</p>
<p>Our example contains the following three major steps:</p>
<ol class="simple">
<li><p>Data Preparation</p></li>
<li><p>Setting Hyperparameter Spaces for Off-Policy Evaluation</p></li>
<li><p>Interpretable Evaluation for Off-Policy Evaluation</p></li>
</ol>
<div class="section" id="id7">
<h3>Data Preparation<a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h3>
<p>In order to conduct IEOE using <code class="docutils literal notranslate"><span class="pre">pyieoe</span></code>, we need to prepare logged bandit feedback data, action distributions of evaluation policies, and ground truth policy values of evaluation policies. Because <code class="docutils literal notranslate"><span class="pre">pyieoe</span></code> is built with the intention of being used with <code class="docutils literal notranslate"><span class="pre">obp</span></code>, these inputs must follow the conventions in <code class="docutils literal notranslate"><span class="pre">obp</span></code>. Specifically, logged bandit feedback data must be of type <code class="docutils literal notranslate"><span class="pre">BanditFeedback</span></code>, action distributions must be of type <code class="docutils literal notranslate"><span class="pre">np.ndarray</span></code>, and ground truth policy values must be of type <code class="docutils literal notranslate"><span class="pre">float</span></code> (or <code class="docutils literal notranslate"><span class="pre">int</span></code>).</p>
<p>In this example, we generate logged bandit feedback data by modifying multiclass classification data and obtain two sets of evaluation policies along with their action distributions and ground truth policy values using <code class="docutils literal notranslate"><span class="pre">obp</span></code>. For a detailed explanation of this process, please refer to the <a class="reference external" href="https://zr-obp.readthedocs.io/en/latest/_autosummary/obp.dataset.multiclass.html#module-obp.dataset.multiclass">official docs</a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># load raw digits data</span>
<span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">load_digits</span><span class="p">(</span><span class="n">return_X_y</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="c1"># convert the raw classification data into the logged bandit dataset</span>
<span class="n">dataset</span> <span class="o">=</span> <span class="n">MultiClassToBanditReduction</span><span class="p">(</span>
    <span class="n">X</span><span class="o">=</span><span class="n">X</span><span class="p">,</span>
    <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span>
    <span class="n">base_classifier_b</span><span class="o">=</span><span class="n">LogisticRegression</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="mi">12345</span><span class="p">),</span>
    <span class="n">alpha_b</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
    <span class="n">dataset_name</span><span class="o">=</span><span class="s2">&quot;digits&quot;</span>
<span class="p">)</span>
<span class="c1"># split the original data into the training and evaluation sets</span>
<span class="n">dataset</span><span class="o">.</span><span class="n">split_train_eval</span><span class="p">(</span><span class="n">eval_size</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">12345</span><span class="p">)</span>
<span class="c1"># obtain logged bandit feedback generated by the behavior policy</span>
<span class="n">bandit_feedback</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">obtain_batch_bandit_feedback</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="mi">12345</span><span class="p">)</span>

<span class="c1"># obtain action choice probabilities by an evaluation policy and its ground-truth policy value</span>
<span class="n">action_dist_a</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">obtain_action_dist_by_eval_policy</span><span class="p">(</span>
    <span class="n">base_classifier_e</span><span class="o">=</span><span class="n">LogisticRegression</span><span class="p">(</span><span class="n">C</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">12345</span><span class="p">),</span>
    <span class="n">alpha_e</span><span class="o">=</span><span class="mf">0.9</span>
<span class="p">)</span>
<span class="n">ground_truth_a</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">calc_ground_truth_policy_value</span><span class="p">(</span><span class="n">action_dist</span><span class="o">=</span><span class="n">action_dist_a</span><span class="p">)</span>
<span class="n">action_dist_b</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">obtain_action_dist_by_eval_policy</span><span class="p">(</span>
    <span class="n">base_classifier_e</span><span class="o">=</span><span class="n">RandomForest</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">min_samples_split</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">12345</span><span class="p">),</span>
    <span class="n">alpha_e</span><span class="o">=</span><span class="mf">0.9</span>
<span class="p">)</span>
<span class="n">ground_truth_b</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">calc_ground_truth_policy_value</span><span class="p">(</span><span class="n">action_dist</span><span class="o">=</span><span class="n">action_dist_b</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="id8">
<h3>Setting Hyperparameter Spaces for Off-Policy Evaluation<a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h3>
<p>An integral aspect of IEOE is the different sources of variance. The main sources of variance are evaluation policies, random states, hyperparameters of OPE estimators, and hyperparameters of regression models.</p>
<p>In this step, we define the spaces from which the hyperparameters of OPE estimators / regression models are chosen. (The evaluation policy space is defined in the previous step, and the random state space will be defined in the next step.)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># set hyperparameter space for ope estimators</span>

<span class="c1"># set hyperparameter space for the doubly robust with shrinkage estimator</span>
<span class="c1"># with the following code, lambda_ will be chosen from a logarithm uniform distribution over the interval [0.001, 1000]</span>
<span class="n">lambda_</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;lower&quot;</span><span class="p">:</span> <span class="mf">1e-3</span><span class="p">,</span>
    <span class="s2">&quot;upper&quot;</span><span class="p">:</span> <span class="mf">1e3</span><span class="p">,</span>
    <span class="s2">&quot;log&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="nb">float</span>
<span class="p">}</span>
<span class="n">dros_param</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;lambda_&quot;</span><span class="p">:</span> <span class="n">lambda_</span><span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># set hyperparameter space for regression models</span>

<span class="c1"># set hyperparameter space for logistic regression</span>
<span class="c1"># with the following code, C will be chosen from a logarithm uniform distribution over the interval [0.001, 100]</span>
<span class="n">C</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;lower&quot;</span><span class="p">:</span> <span class="mf">1e-3</span><span class="p">,</span>
    <span class="s2">&quot;upper&quot;</span><span class="p">:</span> <span class="mf">1e2</span><span class="p">,</span>
    <span class="s2">&quot;log&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="nb">float</span>
<span class="p">}</span>
<span class="c1"># with the following code, max_iter will be fixed at 10000 and of type int</span>
<span class="n">max_iter</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;lower&quot;</span><span class="p">:</span> <span class="mf">1e4</span><span class="p">,</span>
    <span class="s2">&quot;upper&quot;</span><span class="p">:</span> <span class="mf">1e4</span><span class="p">,</span>
    <span class="s2">&quot;log&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="nb">int</span>
<span class="p">}</span>
<span class="c1"># create a dictionary mapping hyperparamter names to hyperparamter spaces</span>
<span class="n">logistic_regression_param</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;C&quot;</span><span class="p">:</span> <span class="n">C</span><span class="p">,</span>
    <span class="s2">&quot;max_iter&quot;</span><span class="p">:</span> <span class="n">max_iter</span>
<span class="p">}</span>

<span class="c1"># set hyperparameter space for random forest classifier</span>
<span class="c1"># with the following code, n_estimators will be chosen from a logarithm uniform distribution over the interval [50, 100]</span>
<span class="c1"># the chosen value will be of type int</span>
<span class="n">n_estimators</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;lower&quot;</span><span class="p">:</span> <span class="mf">5e1</span><span class="p">,</span>
    <span class="s2">&quot;upper&quot;</span><span class="p">:</span> <span class="mf">1e2</span><span class="p">,</span>
    <span class="s2">&quot;log&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="nb">int</span>
<span class="p">}</span>
<span class="c1"># with the following code, max_depth will be chosen from a uniform distribution over the interval [2, 10]</span>
<span class="c1"># the chosen value will be of type int</span>
<span class="n">max_depth</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;lower&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
    <span class="s2">&quot;upper&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
    <span class="s2">&quot;log&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="nb">int</span>
<span class="p">}</span>
<span class="c1"># with the following code, min_samples_split will be chosen from a uniform distribution over the interval [2, 10]</span>
<span class="c1"># the chosen value will be of type int</span>
<span class="n">min_samples_split</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;lower&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
    <span class="s2">&quot;upper&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
    <span class="s2">&quot;log&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="nb">int</span>
<span class="p">}</span>
<span class="c1"># create a dictionary mapping hyperparamter names to hyperparamter spaces</span>
<span class="n">random_forest_param</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;n_estimators&quot;</span><span class="p">:</span> <span class="n">n_estimators</span><span class="p">,</span> 
    <span class="s2">&quot;max_depth&quot;</span><span class="p">:</span> <span class="n">max_depth</span><span class="p">,</span> 
    <span class="s2">&quot;min_samples_split&quot;</span><span class="p">:</span> <span class="n">min_samples_split</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="id9">
<h3>Interpretable Evaluation for Off-Policy Evaluation<a class="headerlink" href="#id9" title="Permalink to this headline">¶</a></h3>
<p>With the above steps completed, we can finally conduct IEOE by utilizing the <code class="docutils literal notranslate"><span class="pre">InterpretableOPEEvaluator</span></code> class.</p>
<p>Here is a brief description for each parameter that can be passed into <code class="docutils literal notranslate"><span class="pre">InterpretableOPEEvaluator</span></code>:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">random_states</span></code>: a list of integers representing the random_state used when performing OPE; corresponds to the number of iterations</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">bandit_feedback</span></code>: a list of logged bandit feedback data</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">evaluation_policies</span></code>: a list of tuples representing (ground truth policy value, action distribution)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ope_estimators</span></code>: a list of OPE ope_estimators</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ope_estimator_hyperparams</span></code>: a dictionary mapping OPE estimator names to OPE estimator hyperparameter spaces defined in step 2</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">regression_models</span></code>: a list of regression regression_models</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">regression_model_hyperparams</span></code>: a dictionary mapping regression models to regression model hyperparameter spaces defined in step 2</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># initializing class</span>
<span class="n">evaluator</span> <span class="o">=</span> <span class="n">InterpretableOPEEvaluator</span><span class="p">(</span>
    <span class="n">random_states</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1000</span><span class="p">),</span>
    <span class="n">bandit_feedbacks</span><span class="o">=</span><span class="p">[</span><span class="n">bandit_feedback</span><span class="p">],</span>
    <span class="n">evaluation_policies</span><span class="o">=</span><span class="p">[</span>
        <span class="p">(</span><span class="n">ground_truth_a</span><span class="p">,</span> <span class="n">action_dist_a</span><span class="p">),</span> 
        <span class="p">(</span><span class="n">ground_truth_b</span><span class="p">,</span> <span class="n">action_dist_b</span><span class="p">)</span>
    <span class="p">],</span>
    <span class="n">ope_estimators</span><span class="o">=</span><span class="p">[</span>
        <span class="n">DirectMethod</span><span class="p">(),</span>
        <span class="n">DoublyRobust</span><span class="p">(),</span>
        <span class="n">DoublyRobustWithShrinkage</span><span class="p">(),</span>
        <span class="n">InverseProbabilityWeighting</span><span class="p">(),</span> 
    <span class="p">],</span>
    <span class="n">ope_estimator_hyperparams</span><span class="o">=</span><span class="p">{</span>
        <span class="n">DoublyRobustWithShrinkage</span><span class="o">.</span><span class="n">estimator_name</span><span class="p">:</span> <span class="n">dros_param</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="n">regression_models</span><span class="o">=</span><span class="p">[</span>
        <span class="n">LogisticRegression</span><span class="p">,</span>
        <span class="n">RandomForest</span>
    <span class="p">],</span>
    <span class="n">regression_model_hyperparams</span><span class="o">=</span><span class="p">{</span>
        <span class="n">LogisticRegression</span><span class="p">:</span> <span class="n">logistic_regression_param</span><span class="p">,</span>
        <span class="n">RandomForest</span><span class="p">:</span> <span class="n">random_forest_param</span>
    <span class="p">}</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We can set the hyperparameters of OPE estimators / regression models after initializing <code class="docutils literal notranslate"><span class="pre">InterpretableOPEEvaluator</span></code> as well. Below is an example:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># re-set hyperparameter space for doubly robust with shrinkage estimator</span>
<span class="c1"># with the following code, lambda_ will now be chosen from a logarithm uniform distribution over the interval [0.001, 100]</span>
<span class="n">evaluator</span><span class="o">.</span><span class="n">set_ope_estimator_hyperparam_space</span><span class="p">(</span>
    <span class="n">DoublyRobustWithShrinkage</span><span class="o">.</span><span class="n">estimator_name</span><span class="p">,</span>
    <span class="n">param_name</span><span class="o">=</span><span class="s2">&quot;lambda_&quot;</span><span class="p">,</span>
    <span class="n">lower</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span>
    <span class="n">upper</span><span class="o">=</span><span class="mf">1e2</span><span class="p">,</span>
    <span class="n">log</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">type_</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># re-set hyperparameter space for logistic regression</span>
<span class="c1"># with the following code, C will now be chosen from a logarithm uniform distribution over the interval [0.001, 100]</span>
<span class="n">evaluator</span><span class="o">.</span><span class="n">set_regression_model_hyperparam_space</span><span class="p">(</span>
    <span class="n">LogisticRegression</span><span class="p">,</span>
    <span class="n">param_name</span><span class="o">=</span><span class="s2">&quot;C&quot;</span><span class="p">,</span>
    <span class="n">lower</span><span class="o">=</span><span class="mf">1e-2</span><span class="p">,</span>
    <span class="n">upper</span><span class="o">=</span><span class="mf">1e2</span><span class="p">,</span>
    <span class="n">log</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">type_</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Once we have initialized <code class="docutils literal notranslate"><span class="pre">InterpretableOPEEvaluator</span></code>, we can call implemented methods to perform IEOE.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># estimate policy values</span>
<span class="c1"># we obtain a dictionary mapping ope estimator names to np.ndarray storing the estimated policy value for each iteration</span>
<span class="n">policy_value</span> <span class="o">=</span> <span class="n">evaluator</span><span class="o">.</span><span class="n">estimate_policy_value</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100%|██████████| 1000/1000 [11:17&lt;00:00,  1.48it/s]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;dm:&quot;</span><span class="p">,</span> <span class="n">policy_value</span><span class="p">[</span><span class="s2">&quot;dm&quot;</span><span class="p">][:</span><span class="mi">3</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;dr:&quot;</span><span class="p">,</span> <span class="n">policy_value</span><span class="p">[</span><span class="s2">&quot;dr&quot;</span><span class="p">][:</span><span class="mi">3</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;dr-os:&quot;</span><span class="p">,</span> <span class="n">policy_value</span><span class="p">[</span><span class="s2">&quot;dr-os&quot;</span><span class="p">][:</span><span class="mi">3</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ipw:&quot;</span><span class="p">,</span> <span class="n">policy_value</span><span class="p">[</span><span class="s2">&quot;ipw&quot;</span><span class="p">][:</span><span class="mi">3</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>dm: [0.81134402 0.78412865 0.78674876]
dr: [0.86480653 0.85936748 0.86395919]
dr-os: [0.81064521 0.77765542 0.7784058 ]
ipw: [0.87521812 0.88807243 0.8636725 ]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># compute squared errors</span>
<span class="c1"># we obtain a dictionary mapping ope estimator names to np.ndarray storing the calculated squared error for each iteration</span>
<span class="n">squared_error</span> <span class="o">=</span> <span class="n">evaluator</span><span class="o">.</span><span class="n">calculate_squared_error</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;dm:&quot;</span><span class="p">,</span> <span class="n">squared_error</span><span class="p">[</span><span class="s2">&quot;dm&quot;</span><span class="p">][:</span><span class="mi">3</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;dr:&quot;</span><span class="p">,</span> <span class="n">squared_error</span><span class="p">[</span><span class="s2">&quot;dr&quot;</span><span class="p">][:</span><span class="mi">3</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;dr-os:&quot;</span><span class="p">,</span> <span class="n">squared_error</span><span class="p">[</span><span class="s2">&quot;dr-os&quot;</span><span class="p">][:</span><span class="mi">3</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ipw:&quot;</span><span class="p">,</span> <span class="n">squared_error</span><span class="p">[</span><span class="s2">&quot;ipw&quot;</span><span class="p">][:</span><span class="mi">3</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>dm: [0.00294847 0.00748626 0.00622444]
dr: [7.01161709e-07 1.27336628e-04 2.83816202e-06]
dr-os: [0.00302485 0.00864833 0.00761048]
ipw: [9.16660156e-05 3.03477502e-04 3.88635152e-06]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># visualize cdf of squared errors for all ope estimators</span>
<span class="n">evaluator</span><span class="o">.</span><span class="n">visualize_cdf_aggregate</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;Figure size 432x288 with 0 Axes&gt;
</pre></div>
</div>
<img alt="../_images/T902666_Evaluating_the_Robustness_of_Off_Policy_Evaluation_94_1.png" src="../_images/T902666_Evaluating_the_Robustness_of_Off_Policy_Evaluation_94_1.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># compute the au-cdf score (area under cdf of squared error over interval [0, thershold]), higher score is better</span>
<span class="c1"># we obtain a dictionary mapping ope estimator names to cvar scores </span>
<span class="n">au_cdf</span> <span class="o">=</span> <span class="n">evaluator</span><span class="o">.</span><span class="n">calculate_au_cdf_score</span><span class="p">(</span><span class="n">threshold</span><span class="o">=</span><span class="mf">0.004</span><span class="p">)</span>
<span class="n">au_cdf</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;dm&#39;: 0.00014444454239821147,
 &#39;dr&#39;: 0.0034740129891242164,
 &#39;dr-os&#39;: 0.001371870093647186,
 &#39;ipw&#39;: 0.0032895493305153413}
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># by activating the `scale` option, </span>
<span class="c1"># we obtain au_cdf scores where the highest score is scaled to 1</span>
<span class="n">au_cdf_scaled</span> <span class="o">=</span> <span class="n">evaluator</span><span class="o">.</span><span class="n">calculate_au_cdf_score</span><span class="p">(</span><span class="n">threshold</span><span class="o">=</span><span class="mf">0.004</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">au_cdf_scaled</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;dm&#39;: 0.04157858443546733,
 &#39;dr&#39;: 1.0,
 &#39;dr-os&#39;: 0.3948949235198538,
 &#39;ipw&#39;: 0.9469018512059802}
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># compute the cvar score (expected value of squared error above probability alpha), lower score is better</span>
<span class="c1"># we obtain a dictionary mapping ope estimator names to cvar scores </span>
<span class="n">cvar</span> <span class="o">=</span> <span class="n">evaluator</span><span class="o">.</span><span class="n">calculate_cvar_score</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>
<span class="n">cvar</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;dm&#39;: 0.00936181325035828,
 &#39;dr&#39;: 0.003630139850166714,
 &#39;dr-os&#39;: 0.009520288490655431,
 &#39;ipw&#39;: 0.006955857378145971}
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># by activating the `scale` option, </span>
<span class="c1"># we obtain cvar scores where the lowest score is scaled to 1</span>
<span class="n">cvar_scaled</span> <span class="o">=</span> <span class="n">evaluator</span><span class="o">.</span><span class="n">calculate_cvar_score</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">cvar_scaled</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;dm&#39;: 2.578912558955088,
 &#39;dr&#39;: 1.0,
 &#39;dr-os&#39;: 2.622567968068286,
 &#39;ipw&#39;: 1.9161403321215087}
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="example-5-multiclass-p-score">
<h2>Example 5 - Multiclass P-Score<a class="headerlink" href="#example-5-multiclass-p-score" title="Permalink to this headline">¶</a></h2>
<p>A quickstart guide of pyIEOE using multiclass classification data and using estimated propensity scores of the behavior policy instead of the ground truth values.</p>
<p>This notebook demonstrates an example of conducting Interpretable Evaluation for Off-Policy Evaluation (IEOE). We use logged bandit feedback data generated by modifying multiclass classification data using <a class="reference external" href="https://github.com/st-tech/zr-obp"><code class="docutils literal notranslate"><span class="pre">obp</span></code></a> and evaluate the performance of Direct Method (DM), Doubly Robust (DR), Doubly Robust with Shrinkage (DRos), and Inverse Probability Weighting (IPW).</p>
<p>Our example contains the following three major steps:</p>
<ol class="simple">
<li><p>Data Preparation</p></li>
<li><p>Setting Hyperparameter Spaces for Off-Policy Evaluation</p></li>
<li><p>Interpretable Evaluation for Off-Policy Evaluation</p></li>
</ol>
<div class="section" id="id10">
<h3>Data Preparation<a class="headerlink" href="#id10" title="Permalink to this headline">¶</a></h3>
<p>In order to conduct IEOE using <code class="docutils literal notranslate"><span class="pre">pyieoe</span></code>, we need to prepare logged bandit feedback data, action distributions of evaluation policies, and ground truth policy values of evaluation policies. Because <code class="docutils literal notranslate"><span class="pre">pyieoe</span></code> is built with the intention of being used with <code class="docutils literal notranslate"><span class="pre">obp</span></code>, these inputs must follow the conventions in <code class="docutils literal notranslate"><span class="pre">obp</span></code>. Specifically, logged bandit feedback data must be of type <code class="docutils literal notranslate"><span class="pre">BanditFeedback</span></code>, action distributions must be of type <code class="docutils literal notranslate"><span class="pre">np.ndarray</span></code>, and ground truth policy values must be of type <code class="docutils literal notranslate"><span class="pre">float</span></code> (or <code class="docutils literal notranslate"><span class="pre">int</span></code>).</p>
<p>In this example, we generate logged bandit feedback data by modifying multiclass classification data and obtain two sets of evaluation policies along with their action distributions and ground truth policy values using <code class="docutils literal notranslate"><span class="pre">obp</span></code>. For a detailed explanation of this process, please refer to the <a class="reference external" href="https://zr-obp.readthedocs.io/en/latest/_autosummary/obp.dataset.multiclass.html#module-obp.dataset.multiclass">official docs</a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># load raw digits data</span>
<span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">load_digits</span><span class="p">(</span><span class="n">return_X_y</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="c1"># convert the raw classification data into the logged bandit dataset</span>
<span class="n">dataset</span> <span class="o">=</span> <span class="n">MultiClassToBanditReduction</span><span class="p">(</span>
    <span class="n">X</span><span class="o">=</span><span class="n">X</span><span class="p">,</span>
    <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span>
    <span class="n">base_classifier_b</span><span class="o">=</span><span class="n">LogisticRegression</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="mi">12345</span><span class="p">),</span>
    <span class="n">alpha_b</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
    <span class="n">dataset_name</span><span class="o">=</span><span class="s2">&quot;digits&quot;</span>
<span class="p">)</span>
<span class="c1"># split the original data into the training and evaluation sets</span>
<span class="n">dataset</span><span class="o">.</span><span class="n">split_train_eval</span><span class="p">(</span><span class="n">eval_size</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">12345</span><span class="p">)</span>
<span class="c1"># obtain logged bandit feedback generated by the behavior policy</span>
<span class="n">bandit_feedback</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">obtain_batch_bandit_feedback</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="mi">12345</span><span class="p">)</span>

<span class="c1"># obtain action choice probabilities by an evaluation policy and its ground-truth policy value</span>
<span class="n">action_dist_a</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">obtain_action_dist_by_eval_policy</span><span class="p">(</span>
    <span class="n">base_classifier_e</span><span class="o">=</span><span class="n">LogisticRegression</span><span class="p">(</span><span class="n">C</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">12345</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">10000</span><span class="p">),</span>
    <span class="n">alpha_e</span><span class="o">=</span><span class="mf">0.9</span>
<span class="p">)</span>
<span class="n">ground_truth_a</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">calc_ground_truth_policy_value</span><span class="p">(</span><span class="n">action_dist</span><span class="o">=</span><span class="n">action_dist_a</span><span class="p">)</span>
<span class="n">action_dist_b</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">obtain_action_dist_by_eval_policy</span><span class="p">(</span>
    <span class="n">base_classifier_e</span><span class="o">=</span><span class="n">RandomForest</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">min_samples_split</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">12345</span><span class="p">),</span>
    <span class="n">alpha_e</span><span class="o">=</span><span class="mf">0.9</span>
<span class="p">)</span>
<span class="n">ground_truth_b</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">calc_ground_truth_policy_value</span><span class="p">(</span><span class="n">action_dist</span><span class="o">=</span><span class="n">action_dist_b</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="id11">
<h3>Setting Hyperparameter Spaces for Off-Policy Evaluation<a class="headerlink" href="#id11" title="Permalink to this headline">¶</a></h3>
<p>An integral aspect of IEOE is the different sources of variance. The main sources of variance are evaluation policies, random states, hyperparameters of OPE estimators, and hyperparameters of regression models.</p>
<p>In this step, we define the spaces from which the hyperparameters of OPE estimators / regression models are chosen. (The evaluation policy space is defined in the previous step, and the random state space will be defined in the next step.)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># set hyperparameter space for ope estimators</span>

<span class="c1"># set hyperparameter space for the doubly robust with shrinkage estimator</span>
<span class="c1"># with the following code, lambda_ will be chosen from a logarithm uniform distribution over the interval [0.001, 1000]</span>
<span class="n">lambda_</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;lower&quot;</span><span class="p">:</span> <span class="mf">1e-3</span><span class="p">,</span>
    <span class="s2">&quot;upper&quot;</span><span class="p">:</span> <span class="mf">1e3</span><span class="p">,</span>
    <span class="s2">&quot;log&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="nb">float</span>
<span class="p">}</span>
<span class="n">dros_param</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;lambda_&quot;</span><span class="p">:</span> <span class="n">lambda_</span><span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># set hyperparameter space for regression models</span>

<span class="c1"># set hyperparameter space for logistic regression</span>
<span class="c1"># with the following code, C will be chosen from a logarithm uniform distribution over the interval [0.001, 100]</span>
<span class="c1"># the chosen value will be of type float</span>
<span class="n">C</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;lower&quot;</span><span class="p">:</span> <span class="mf">1e-3</span><span class="p">,</span>
    <span class="s2">&quot;upper&quot;</span><span class="p">:</span> <span class="mf">1e2</span><span class="p">,</span>
    <span class="s2">&quot;log&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="nb">float</span>
<span class="p">}</span>
<span class="c1"># with the following code, max_iter will be fixed at 10000 and of type int</span>
<span class="n">max_iter</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;lower&quot;</span><span class="p">:</span> <span class="mf">1e4</span><span class="p">,</span>
    <span class="s2">&quot;upper&quot;</span><span class="p">:</span> <span class="mf">1e4</span><span class="p">,</span>
    <span class="s2">&quot;log&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="nb">int</span>
<span class="p">}</span>
<span class="c1"># create a dictionary mapping hyperparamter names to hyperparamter spaces</span>
<span class="n">logistic_regression_param</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;C&quot;</span><span class="p">:</span> <span class="n">C</span><span class="p">,</span>
    <span class="s2">&quot;max_iter&quot;</span><span class="p">:</span> <span class="n">max_iter</span>
<span class="p">}</span>

<span class="c1"># set hyperparameter space for random forest classifier</span>
<span class="c1"># with the following code, n_estimators will be chosen from a logarithm uniform distribution over the interval [50, 100]</span>
<span class="c1"># the chosen value will be of type int</span>
<span class="n">n_estimators</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;lower&quot;</span><span class="p">:</span> <span class="mf">5e1</span><span class="p">,</span>
    <span class="s2">&quot;upper&quot;</span><span class="p">:</span> <span class="mf">1e2</span><span class="p">,</span>
    <span class="s2">&quot;log&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="nb">int</span>
<span class="p">}</span>
<span class="c1"># with the following code, max_depth will be chosen from a uniform distribution over the interval [2, 10]</span>
<span class="c1"># the chosen value will be of type int</span>
<span class="n">max_depth</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;lower&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
    <span class="s2">&quot;upper&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
    <span class="s2">&quot;log&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="nb">int</span>
<span class="p">}</span>
<span class="c1"># with the following code, min_samples_split will be chosen from a uniform distribution over the interval [2, 10]</span>
<span class="c1"># the chosen value will be of type int</span>
<span class="n">min_samples_split</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;lower&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
    <span class="s2">&quot;upper&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
    <span class="s2">&quot;log&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="nb">int</span>
<span class="p">}</span>
<span class="c1"># create a dictionary mapping hyperparamter names to hyperparamter spaces</span>
<span class="n">random_forest_param</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;n_estimators&quot;</span><span class="p">:</span> <span class="n">n_estimators</span><span class="p">,</span> 
    <span class="s2">&quot;max_depth&quot;</span><span class="p">:</span> <span class="n">max_depth</span><span class="p">,</span> 
    <span class="s2">&quot;min_samples_split&quot;</span><span class="p">:</span> <span class="n">min_samples_split</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="id12">
<h3>Interpretable Evaluation for Off-Policy Evaluation<a class="headerlink" href="#id12" title="Permalink to this headline">¶</a></h3>
<p>With the above steps completed, we can finally conduct IEOE by utilizing the <code class="docutils literal notranslate"><span class="pre">InterpretableOPEEvaluator</span></code> class.</p>
<p>Here is a brief description for each parameter that can be passed into <code class="docutils literal notranslate"><span class="pre">InterpretableOPEEvaluator</span></code>:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">random_states</span></code>: a list of integers representing the random_state used when performing OPE; corresponds to the number of iterations</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">bandit_feedback</span></code>: a list of logged bandit feedback data</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">evaluation_policies</span></code>: a list of tuples representing (ground truth policy value, action distribution)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ope_estimators</span></code>: a list of OPE ope_estimators</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ope_estimator_hyperparams</span></code>: a dictionary mapping OPE estimator names to OPE estimator hyperparameter spaces defined in step 2</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">regression_models</span></code>: a list of regression regression_models</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">regression_model_hyperparams</span></code>: a dictionary mapping regression models to regression model hyperparameter spaces defined in step 2</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># initializing class</span>
<span class="n">evaluator</span> <span class="o">=</span> <span class="n">InterpretableOPEEvaluator</span><span class="p">(</span>
    <span class="n">random_states</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1000</span><span class="p">),</span>
    <span class="n">bandit_feedbacks</span><span class="o">=</span><span class="p">[</span><span class="n">bandit_feedback</span><span class="p">],</span>
    <span class="n">evaluation_policies</span><span class="o">=</span><span class="p">[</span>
        <span class="p">(</span><span class="n">ground_truth_a</span><span class="p">,</span> <span class="n">action_dist_a</span><span class="p">),</span> 
        <span class="p">(</span><span class="n">ground_truth_b</span><span class="p">,</span> <span class="n">action_dist_b</span><span class="p">)</span>
    <span class="p">],</span>
    <span class="n">ope_estimators</span><span class="o">=</span><span class="p">[</span>
        <span class="n">DirectMethod</span><span class="p">(),</span>
        <span class="n">DoublyRobust</span><span class="p">(),</span>
        <span class="n">DoublyRobustWithShrinkage</span><span class="p">(),</span>
        <span class="n">InverseProbabilityWeighting</span><span class="p">(),</span> 
    <span class="p">],</span>
    <span class="n">ope_estimator_hyperparams</span><span class="o">=</span><span class="p">{</span>
        <span class="n">DoublyRobustWithShrinkage</span><span class="o">.</span><span class="n">estimator_name</span><span class="p">:</span> <span class="n">dros_param</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="n">regression_models</span><span class="o">=</span><span class="p">[</span>
        <span class="n">LogisticRegression</span><span class="p">,</span>
        <span class="n">RandomForest</span>
    <span class="p">],</span>
    <span class="n">regression_model_hyperparams</span><span class="o">=</span><span class="p">{</span>
        <span class="n">LogisticRegression</span><span class="p">:</span> <span class="n">logistic_regression_param</span><span class="p">,</span>
        <span class="n">RandomForest</span><span class="p">:</span> <span class="n">random_forest_param</span>
    <span class="p">},</span>
    <span class="n">pscore_estimators</span><span class="o">=</span><span class="p">[</span>
        <span class="n">LogisticRegression</span><span class="p">,</span>
        <span class="n">RandomForest</span>
    <span class="p">],</span>
    <span class="n">pscore_estimator_hyperparams</span><span class="o">=</span><span class="p">{</span>
        <span class="n">LogisticRegression</span><span class="p">:</span> <span class="n">logistic_regression_param</span><span class="p">,</span>
        <span class="n">RandomForest</span><span class="p">:</span> <span class="n">random_forest_param</span>
    <span class="p">}</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We can set the hyperparameters of OPE estimators / regression models after initializing <code class="docutils literal notranslate"><span class="pre">InterpretableOPEEvaluator</span></code> as well. Below is an example:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># re-set hyperparameter space for doubly robust with shrinkage estimator</span>
<span class="c1"># with the following code, lambda_ will now be chosen from a logarithm uniform distribution over the interval [0.001, 100]</span>
<span class="n">evaluator</span><span class="o">.</span><span class="n">set_ope_estimator_hyperparam_space</span><span class="p">(</span>
    <span class="n">DoublyRobustWithShrinkage</span><span class="o">.</span><span class="n">estimator_name</span><span class="p">,</span>
    <span class="n">param_name</span><span class="o">=</span><span class="s2">&quot;lambda_&quot;</span><span class="p">,</span>
    <span class="n">lower</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span>
    <span class="n">upper</span><span class="o">=</span><span class="mf">1e2</span><span class="p">,</span>
    <span class="n">log</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">type_</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># re-set hyperparameter space for logistic regression</span>
<span class="c1"># with the following code, C will now be chosen from a logarithm uniform distribution over the interval [0.001, 100]</span>
<span class="n">evaluator</span><span class="o">.</span><span class="n">set_regression_model_hyperparam_space</span><span class="p">(</span>
    <span class="n">LogisticRegression</span><span class="p">,</span>
    <span class="n">param_name</span><span class="o">=</span><span class="s2">&quot;C&quot;</span><span class="p">,</span>
    <span class="n">lower</span><span class="o">=</span><span class="mf">1e-2</span><span class="p">,</span>
    <span class="n">upper</span><span class="o">=</span><span class="mf">1e2</span><span class="p">,</span>
    <span class="n">log</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">type_</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Once we have initialized <code class="docutils literal notranslate"><span class="pre">InterpretableOPEEvaluator</span></code>, we can call implemented methods to perform IEOE.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># estimate policy values</span>
<span class="c1"># we obtain a dictionary mapping ope estimator names to np.ndarray storing the estimated policy value for each iteration</span>
<span class="n">policy_value</span> <span class="o">=</span> <span class="n">evaluator</span><span class="o">.</span><span class="n">estimate_policy_value</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100%|██████████| 1000/1000 [35:36&lt;00:00,  2.14s/it] 
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;dm:&quot;</span><span class="p">,</span> <span class="n">policy_value</span><span class="p">[</span><span class="s2">&quot;dm&quot;</span><span class="p">][:</span><span class="mi">3</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;dr:&quot;</span><span class="p">,</span> <span class="n">policy_value</span><span class="p">[</span><span class="s2">&quot;dr&quot;</span><span class="p">][:</span><span class="mi">3</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;dr-os:&quot;</span><span class="p">,</span> <span class="n">policy_value</span><span class="p">[</span><span class="s2">&quot;dr-os&quot;</span><span class="p">][:</span><span class="mi">3</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ipw:&quot;</span><span class="p">,</span> <span class="n">policy_value</span><span class="p">[</span><span class="s2">&quot;ipw&quot;</span><span class="p">][:</span><span class="mi">3</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>dm: [0.81096739 0.78412865 0.78712081]
dr: [0.8253112  1.00228582 0.78789132]
dr-os: [0.82473807 0.78602363 0.78783993]
ipw: [1.01482753 1.11752925 1.0182291 ]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># compute squared errors</span>
<span class="c1"># we obtain a dictionary mapping ope estimator names to np.ndarray storing the calculated squared error for each iteration</span>
<span class="n">squared_error</span> <span class="o">=</span> <span class="n">evaluator</span><span class="o">.</span><span class="n">calculate_squared_error</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;dm:&quot;</span><span class="p">,</span> <span class="n">squared_error</span><span class="p">[</span><span class="s2">&quot;dm&quot;</span><span class="p">][:</span><span class="mi">3</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;dr:&quot;</span><span class="p">,</span> <span class="n">squared_error</span><span class="p">[</span><span class="s2">&quot;dr&quot;</span><span class="p">][:</span><span class="mi">3</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;dr-os:&quot;</span><span class="p">,</span> <span class="n">squared_error</span><span class="p">[</span><span class="s2">&quot;dr-os&quot;</span><span class="p">][:</span><span class="mi">3</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ipw:&quot;</span><span class="p">,</span> <span class="n">squared_error</span><span class="p">[</span><span class="s2">&quot;ipw&quot;</span><span class="p">][:</span><span class="mi">3</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>dm: [0.00253854 0.00748626 0.00551017]
dr: [0.00129889 0.01732751 0.00539638]
dr-os: [0.00134053 0.00716193 0.00540393]
ipw: [0.02355494 0.06094846 0.02461063]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># visualize cdf of squared errors for all ope estimators</span>
<span class="n">evaluator</span><span class="o">.</span><span class="n">visualize_cdf_aggregate</span><span class="p">(</span><span class="n">xmax</span><span class="o">=</span><span class="mf">0.04</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;Figure size 432x288 with 0 Axes&gt;
</pre></div>
</div>
<img alt="../_images/T902666_Evaluating_the_Robustness_of_Off_Policy_Evaluation_116_1.png" src="../_images/T902666_Evaluating_the_Robustness_of_Off_Policy_Evaluation_116_1.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># compute the au-cdf score (area under cdf of squared error over interval [0, thershold]), higher score is better</span>
<span class="c1"># we obtain a dictionary mapping ope estimator names to cvar scores </span>
<span class="n">au_cdf</span> <span class="o">=</span> <span class="n">evaluator</span><span class="o">.</span><span class="n">calculate_au_cdf_score</span><span class="p">(</span><span class="n">threshold</span><span class="o">=</span><span class="mf">0.004</span><span class="p">)</span>
<span class="n">au_cdf</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;dm&#39;: 0.00021056405032585993,
 &#39;dr&#39;: 0.0008879177361003537,
 &#39;dr-os&#39;: 0.001237122081750088,
 &#39;ipw&#39;: 0.0}
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># by activating the `scale` option, </span>
<span class="c1"># we obtain au_cdf scores where the highest score is scaled to 1</span>
<span class="n">au_cdf_scaled</span> <span class="o">=</span> <span class="n">evaluator</span><span class="o">.</span><span class="n">calculate_au_cdf_score</span><span class="p">(</span><span class="n">threshold</span><span class="o">=</span><span class="mf">0.004</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">au_cdf_scaled</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;dm&#39;: 0.17020474650972736, &#39;dr&#39;: 0.71772846770649, &#39;dr-os&#39;: 1.0, &#39;ipw&#39;: 0.0}
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># compute the cvar score (expected value of squared error above probability alpha), lower score is better</span>
<span class="c1"># we obtain a dictionary mapping ope estimator names to cvar scores </span>
<span class="n">cvar</span> <span class="o">=</span> <span class="n">evaluator</span><span class="o">.</span><span class="n">calculate_cvar_score</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>
<span class="n">cvar</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;dm&#39;: 0.009140229299153585,
 &#39;dr&#39;: 0.16904269955964735,
 &#39;dr-os&#39;: 0.024619638962354397,
 &#39;ipw&#39;: 3.111787619643494}
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># by activating the `scale` option, </span>
<span class="c1"># we obtain cvar scores where the lowest score is scaled to 1</span>
<span class="n">cvar_scaled</span> <span class="o">=</span> <span class="n">evaluator</span><span class="o">.</span><span class="n">calculate_cvar_score</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">cvar_scaled</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;dm&#39;: 1.0,
 &#39;dr&#39;: 18.494360921043988,
 &#39;dr-os&#39;: 2.6935471919325105,
 &#39;ipw&#39;: 340.44962306707725}
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="example-6-multiclass-rscv">
<h2>Example 6 - Multiclass RSCV<a class="headerlink" href="#example-6-multiclass-rscv" title="Permalink to this headline">¶</a></h2>
<p>A quickstart guide of pyIEOE using multiclass classification data and using RandomizedSearchCV for regression models and pscore estimators.</p>
<p>This section demonstrates an example of conducting Interpretable Evaluation for Off-Policy Evaluation (IEOE). We use logged bandit feedback data generated by modifying multiclass classification data using <a class="reference external" href="https://github.com/st-tech/zr-obp"><code class="docutils literal notranslate"><span class="pre">obp</span></code></a> and evaluate the performance of Direct Method (DM), Doubly Robust (DR), Doubly Robust with Shrinkage (DRos), and Inverse Probability Weighting (IPW).</p>
<p>Our example contains the following three major steps:</p>
<ol class="simple">
<li><p>Data Preparation</p></li>
<li><p>Setting Hyperparameter Spaces for Off-Policy Evaluation</p></li>
<li><p>Interpretable Evaluation for Off-Policy Evaluation</p></li>
</ol>
<div class="section" id="id13">
<h3>Data Preparation<a class="headerlink" href="#id13" title="Permalink to this headline">¶</a></h3>
<p>In order to conduct IEOE using <code class="docutils literal notranslate"><span class="pre">pyieoe</span></code>, we need to prepare logged bandit feedback data, action distributions of evaluation policies, and ground truth policy values of evaluation policies. Because <code class="docutils literal notranslate"><span class="pre">pyieoe</span></code> is built with the intention of being used with <code class="docutils literal notranslate"><span class="pre">obp</span></code>, these inputs must follow the conventions in <code class="docutils literal notranslate"><span class="pre">obp</span></code>. Specifically, logged bandit feedback data must be of type <code class="docutils literal notranslate"><span class="pre">BanditFeedback</span></code>, action distributions must be of type <code class="docutils literal notranslate"><span class="pre">np.ndarray</span></code>, and ground truth policy values must be of type <code class="docutils literal notranslate"><span class="pre">float</span></code> (or <code class="docutils literal notranslate"><span class="pre">int</span></code>).</p>
<p>In this example, we generate logged bandit feedback data by modifying multiclass classification data and obtain two sets of evaluation policies along with their action distributions and ground truth policy values using <code class="docutils literal notranslate"><span class="pre">obp</span></code>. For a detailed explanation of this process, please refer to the <a class="reference external" href="https://zr-obp.readthedocs.io/en/latest/_autosummary/obp.dataset.multiclass.html#module-obp.dataset.multiclass">official docs</a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># load raw digits data</span>
<span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">load_digits</span><span class="p">(</span><span class="n">return_X_y</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="c1"># convert the raw classification data into the logged bandit dataset</span>
<span class="n">dataset</span> <span class="o">=</span> <span class="n">MultiClassToBanditReduction</span><span class="p">(</span>
    <span class="n">X</span><span class="o">=</span><span class="n">X</span><span class="p">,</span>
    <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span>
    <span class="n">base_classifier_b</span><span class="o">=</span><span class="n">LogisticRegression</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="mi">12345</span><span class="p">),</span>
    <span class="n">alpha_b</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
    <span class="n">dataset_name</span><span class="o">=</span><span class="s2">&quot;digits&quot;</span>
<span class="p">)</span>
<span class="c1"># split the original data into the training and evaluation sets</span>
<span class="n">dataset</span><span class="o">.</span><span class="n">split_train_eval</span><span class="p">(</span><span class="n">eval_size</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">12345</span><span class="p">)</span>
<span class="c1"># obtain logged bandit feedback generated by the behavior policy</span>
<span class="n">bandit_feedback</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">obtain_batch_bandit_feedback</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="mi">12345</span><span class="p">)</span>

<span class="c1"># obtain action choice probabilities by an evaluation policy and its ground-truth policy value</span>
<span class="n">action_dist_a</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">obtain_action_dist_by_eval_policy</span><span class="p">(</span>
    <span class="n">base_classifier_e</span><span class="o">=</span><span class="n">LogisticRegression</span><span class="p">(</span><span class="n">C</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">12345</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">10000</span><span class="p">),</span>
    <span class="n">alpha_e</span><span class="o">=</span><span class="mf">0.9</span>
<span class="p">)</span>
<span class="n">ground_truth_a</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">calc_ground_truth_policy_value</span><span class="p">(</span><span class="n">action_dist</span><span class="o">=</span><span class="n">action_dist_a</span><span class="p">)</span>
<span class="n">action_dist_b</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">obtain_action_dist_by_eval_policy</span><span class="p">(</span>
    <span class="n">base_classifier_e</span><span class="o">=</span><span class="n">RandomForest</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">min_samples_split</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">12345</span><span class="p">),</span>
    <span class="n">alpha_e</span><span class="o">=</span><span class="mf">0.9</span>
<span class="p">)</span>
<span class="n">ground_truth_b</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">calc_ground_truth_policy_value</span><span class="p">(</span><span class="n">action_dist</span><span class="o">=</span><span class="n">action_dist_b</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="id14">
<h3>Setting Hyperparameter Spaces for Off-Policy Evaluation<a class="headerlink" href="#id14" title="Permalink to this headline">¶</a></h3>
<p>An integral aspect of IEOE is the different sources of variance. The main sources of variance are evaluation policies, random states, hyperparameters of OPE estimators, and hyperparameters of regression models.</p>
<p>In this step, we define the spaces from which the hyperparameters of OPE estimators / regression models are chosen. (The evaluation policy space is defined in the previous step, and the random state space will be defined in the next step.)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># set hyperparameter space for ope estimators</span>

<span class="c1"># set hyperparameter space for the doubly robust with shrinkage estimator</span>
<span class="c1"># with the following code, lambda_ will be chosen from a logarithm uniform distribution over the interval [0.001, 1000]</span>
<span class="n">lambda_</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;lower&quot;</span><span class="p">:</span> <span class="mf">1e-3</span><span class="p">,</span>
    <span class="s2">&quot;upper&quot;</span><span class="p">:</span> <span class="mf">1e3</span><span class="p">,</span>
    <span class="s2">&quot;log&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="nb">float</span>
<span class="p">}</span>
<span class="n">dros_param</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;lambda_&quot;</span><span class="p">:</span> <span class="n">lambda_</span><span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># set hyperparameter space for logistic regression using RandomizedSearchCV</span>

<span class="kn">from</span> <span class="nn">sklearn.utils.fixes</span> <span class="kn">import</span> <span class="n">loguniform</span>
<span class="n">logistic</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">()</span>
<span class="n">distributions</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;C&quot;</span><span class="p">:</span> <span class="n">loguniform</span><span class="p">(</span><span class="mf">1e-2</span><span class="p">,</span> <span class="mf">1e2</span><span class="p">)</span>
<span class="p">}</span>
<span class="n">clf_logistic</span> <span class="o">=</span> <span class="n">RandomizedSearchCV</span><span class="p">(</span><span class="n">logistic</span><span class="p">,</span> <span class="n">distributions</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_iter</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># set hyperparameter space for random forest classifier using RandomizedSearchCV</span>

<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">randint</span>
<span class="n">randforest</span> <span class="o">=</span> <span class="n">RandomForest</span><span class="p">()</span>
<span class="n">distributions</span> <span class="o">=</span> <span class="p">{</span>
    <span class="c1"># n_estimators will be chosen from a uniform distribution over the interval [50, 100)</span>
    <span class="s2">&quot;n_estimators&quot;</span><span class="p">:</span> <span class="n">randint</span><span class="p">(</span><span class="mf">5e1</span><span class="p">,</span> <span class="mf">1e2</span><span class="p">),</span> 
    <span class="c1"># max_depth will be chosen from a uniform distribution over the interval [2, 10)</span>
    <span class="s2">&quot;max_depth&quot;</span><span class="p">:</span> <span class="n">randint</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> 
    <span class="c1"># min_samples_split will be chosen from a uniform distribution over the interval [2, 10)</span>
    <span class="s2">&quot;min_samples_split&quot;</span><span class="p">:</span> <span class="n">randint</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<span class="p">}</span>
<span class="n">clf_randforest</span> <span class="o">=</span> <span class="n">RandomizedSearchCV</span><span class="p">(</span><span class="n">randforest</span><span class="p">,</span> <span class="n">distributions</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_iter</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="id15">
<h3>Interpretable Evaluation for Off-Policy Evaluation<a class="headerlink" href="#id15" title="Permalink to this headline">¶</a></h3>
<p>With the above steps completed, we can finally conduct IEOE by utilizing the <code class="docutils literal notranslate"><span class="pre">InterpretableOPEEvaluator</span></code> class.</p>
<p>Here is a brief description for each parameter that can be passed into <code class="docutils literal notranslate"><span class="pre">InterpretableOPEEvaluator</span></code>:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">random_states</span></code>: a list of integers representing the random_state used when performing OPE; corresponds to the number of iterations</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">bandit_feedback</span></code>: a list of logged bandit feedback data</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">evaluation_policies</span></code>: a list of tuples representing (ground truth policy value, action distribution)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ope_estimators</span></code>: a list of OPE ope_estimators</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ope_estimator_hyperparams</span></code>: a dictionary mapping OPE estimator names to OPE estimator hyperparameter spaces defined in step 2</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">regression_models</span></code>: a list of regression regression_models</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">regression_model_hyperparams</span></code>: a dictionary mapping regression models to regression model hyperparameter spaces defined in step 2</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># initializing class</span>
<span class="n">evaluator</span> <span class="o">=</span> <span class="n">InterpretableOPEEvaluator</span><span class="p">(</span>
    <span class="n">random_states</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span>
    <span class="n">bandit_feedbacks</span><span class="o">=</span><span class="p">[</span><span class="n">bandit_feedback</span><span class="p">],</span>
    <span class="n">evaluation_policies</span><span class="o">=</span><span class="p">[</span>
        <span class="p">(</span><span class="n">ground_truth_a</span><span class="p">,</span> <span class="n">action_dist_a</span><span class="p">),</span> 
        <span class="p">(</span><span class="n">ground_truth_b</span><span class="p">,</span> <span class="n">action_dist_b</span><span class="p">)</span>
    <span class="p">],</span>
    <span class="n">ope_estimators</span><span class="o">=</span><span class="p">[</span>
        <span class="n">DirectMethod</span><span class="p">(),</span>
        <span class="n">DoublyRobust</span><span class="p">(),</span>
        <span class="n">DoublyRobustWithShrinkage</span><span class="p">(),</span>
        <span class="n">InverseProbabilityWeighting</span><span class="p">(),</span> 
    <span class="p">],</span>
    <span class="n">ope_estimator_hyperparams</span><span class="o">=</span><span class="p">{</span>
        <span class="n">DoublyRobustWithShrinkage</span><span class="o">.</span><span class="n">estimator_name</span><span class="p">:</span> <span class="n">dros_param</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="n">regression_models</span><span class="o">=</span><span class="p">[</span>
        <span class="n">clf_logistic</span><span class="p">,</span>
        <span class="n">clf_randforest</span>
    <span class="p">],</span>
    <span class="n">pscore_estimators</span><span class="o">=</span><span class="p">[</span>
        <span class="n">clf_logistic</span><span class="p">,</span>
        <span class="n">clf_randforest</span>
    <span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Once we have initialized <code class="docutils literal notranslate"><span class="pre">InterpretableOPEEvaluator</span></code>, we can call implemented methods to perform IEOE.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># estimate policy values</span>
<span class="c1"># we obtain a dictionary mapping ope estimator names to np.ndarray storing the estimated policy value for each iteration</span>
<span class="n">policy_value</span> <span class="o">=</span> <span class="n">evaluator</span><span class="o">.</span><span class="n">estimate_policy_value</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100%|██████████| 100/100 [16:46&lt;00:00, 10.07s/it]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;dm:&quot;</span><span class="p">,</span> <span class="n">policy_value</span><span class="p">[</span><span class="s2">&quot;dm&quot;</span><span class="p">][:</span><span class="mi">3</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;dr:&quot;</span><span class="p">,</span> <span class="n">policy_value</span><span class="p">[</span><span class="s2">&quot;dr&quot;</span><span class="p">][:</span><span class="mi">3</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;dr-os:&quot;</span><span class="p">,</span> <span class="n">policy_value</span><span class="p">[</span><span class="s2">&quot;dr-os&quot;</span><span class="p">][:</span><span class="mi">3</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ipw:&quot;</span><span class="p">,</span> <span class="n">policy_value</span><span class="p">[</span><span class="s2">&quot;ipw&quot;</span><span class="p">][:</span><span class="mi">3</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>dm: [0.81742383 0.78314456 0.78401187]
dr: [0.82105688 0.99782594 0.84922517]
dr-os: [0.83782131 0.80315577 0.79384228]
ipw: [1.02730624 1.08930531 1.03776308]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># compute squared errors</span>
<span class="c1"># we obtain a dictionary mapping ope estimator names to np.ndarray storing the calculated squared error for each iteration</span>
<span class="n">squared_error</span> <span class="o">=</span> <span class="n">evaluator</span><span class="o">.</span><span class="n">calculate_squared_error</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;dm:&quot;</span><span class="p">,</span> <span class="n">squared_error</span><span class="p">[</span><span class="s2">&quot;dm&quot;</span><span class="p">][:</span><span class="mi">3</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;dr:&quot;</span><span class="p">,</span> <span class="n">squared_error</span><span class="p">[</span><span class="s2">&quot;dr&quot;</span><span class="p">][:</span><span class="mi">3</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;dr-os:&quot;</span><span class="p">,</span> <span class="n">squared_error</span><span class="p">[</span><span class="s2">&quot;dr-os&quot;</span><span class="p">][:</span><span class="mi">3</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ipw:&quot;</span><span class="p">,</span> <span class="n">squared_error</span><span class="p">[</span><span class="s2">&quot;ipw&quot;</span><span class="p">][:</span><span class="mi">3</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>dm: [0.00192963 0.00765752 0.0059814 ]
dr: [0.00162364 0.01617325 0.00014704]
dr-os: [0.00055366 0.00455572 0.00455747]
ipw: [0.02754103 0.04780934 0.0311211 ]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># visualize cdf of squared errors for all ope estimators</span>
<span class="n">evaluator</span><span class="o">.</span><span class="n">visualize_cdf_aggregate</span><span class="p">(</span><span class="n">xmax</span><span class="o">=</span><span class="mf">0.04</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;Figure size 432x288 with 0 Axes&gt;
</pre></div>
</div>
<img alt="../_images/T902666_Evaluating_the_Robustness_of_Off_Policy_Evaluation_137_1.png" src="../_images/T902666_Evaluating_the_Robustness_of_Off_Policy_Evaluation_137_1.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># compute the au-cdf score (area under cdf of squared error over interval [0, thershold]), higher score is better</span>
<span class="c1"># we obtain a dictionary mapping ope estimator names to cvar scores </span>
<span class="n">au_cdf</span> <span class="o">=</span> <span class="n">evaluator</span><span class="o">.</span><span class="n">calculate_au_cdf_score</span><span class="p">(</span><span class="n">threshold</span><span class="o">=</span><span class="mf">0.004</span><span class="p">)</span>
<span class="n">au_cdf</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;dm&#39;: 0.00033589502028330694,
 &#39;dr&#39;: 0.0014055338062930914,
 &#39;dr-os&#39;: 0.0013860259381295891,
 &#39;ipw&#39;: 0.00014759092699132635}
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># by activating the `scale` option, </span>
<span class="c1"># we obtain au_cdf scores where the highest score is scaled to 1</span>
<span class="n">au_cdf_scaled</span> <span class="o">=</span> <span class="n">evaluator</span><span class="o">.</span><span class="n">calculate_au_cdf_score</span><span class="p">(</span><span class="n">threshold</span><span class="o">=</span><span class="mf">0.004</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">au_cdf_scaled</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;dm&#39;: 0.23898039220357525,
 &#39;dr&#39;: 1.0,
 &#39;dr-os&#39;: 0.9861206695447962,
 &#39;ipw&#39;: 0.10500702745854104}
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># compute the cvar score (expected value of squared error above probability alpha), lower score is better</span>
<span class="c1"># we obtain a dictionary mapping ope estimator names to cvar scores </span>
<span class="n">cvar</span> <span class="o">=</span> <span class="n">evaluator</span><span class="o">.</span><span class="n">calculate_cvar_score</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>
<span class="n">cvar</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;dm&#39;: 0.008580224748971405,
 &#39;dr&#39;: 0.019949401328702467,
 &#39;dr-os&#39;: 0.011156923196551578,
 &#39;ipw&#39;: 0.18231332465193878}
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># by activating the `scale` option, </span>
<span class="c1"># we obtain cvar scores where the lowest score is scaled to 1</span>
<span class="n">cvar_scaled</span> <span class="o">=</span> <span class="n">evaluator</span><span class="o">.</span><span class="n">calculate_cvar_score</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">cvar_scaled</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;dm&#39;: 1.0,
 &#39;dr&#39;: 2.3250441465526874,
 &#39;dr-os&#39;: 1.3003066379920953,
 &#39;ipw&#39;: 21.24808265352192}
</pre></div>
</div>
</div>
</div>
</div>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./nbs"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        
            



<div class='prev-next-bottom'>
    
    <div id="prev">
        <a class="left-prev" href="T471827_Adaptive_Estimator_Selection_for_Off_Policy_Evaluation.html" title="previous page">
            <i class="prevnext-label fas fa-angle-left"></i>
            <div class="prevnext-info">
                <p class="prevnext-label">previous</p>
                <p class="prevnext-title">Adaptive Estimator Selection for Off-Policy Evaluation</p>
            </div>
        </a>
    </div>
     <div id="next">
        <a class="right-next" href="T705904_Evaluation_of_Multiple_Off_Policy_Estimators_on_Synthetic_Dataset.html" title="next page">
            <div class="prevnext-info">
                <p class="prevnext-label">next</p>
                <p class="prevnext-title">Evaluation of Multiple Off-Policy Estimators on Synthetic Dataset</p>
            </div>
            <i class="prevnext-label fas fa-angle-right"></i>
        </a>
     </div>

</div>
        
        </div>
    </div>
    <footer class="footer">
    <div class="container">
      <p>
        
          By Sparsh A.<br/>
        
            &copy; Copyright 2021.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>
  
  <script src="../_static/js/index.1c5a1a01449ed65a7b51.js"></script>

  
  </body>
</html>