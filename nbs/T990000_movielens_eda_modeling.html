
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Movielens EDA and Modeling &#8212; Reco Book</title>
    
  <link href="../_static/css/theme.css" rel="stylesheet" />
  <link href="../_static/css/index.c5995385ac14fb8791e8eb36b4908be2.css" rel="stylesheet" />

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/sphinx-book-theme.css?digest=c3fdc42140077d1ad13ad2f1588a4309" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../_static/js/index.1c5a1a01449ed65a7b51.js">

    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/togglebutton.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/sphinx-book-theme.12a9622fbb08dcb3a2a40b2c02b83a57.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["\\(", "\\)"]], "displayMath": [["\\[", "\\]"]], "processRefs": false, "processEnvironments": false}})</script>
    <script async="async" src="https://unpkg.com/thebe@0.5.1/lib/index.js"></script>
    <script >
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Read Cassandra Data Snapshot as DataFrame" href="T990000_read_data_from_cassandra_into_pandas.html" />
    <link rel="prev" title="Movie recommender using Tensorflow in Sagemaker" href="T990000_movie_recommender_tensorflow_sagemaker.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
      
      
      <h1 class="site-logo" id="site-title">Reco Book</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../index.html">
   Tutorials in Jupyter notebook format
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  User Stories
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="US780867_Transformer_based_Recommenders.html">
   Transformer-based Recommenders
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="T034923_BERT4Rec_on_ML1M_in_PyTorch.html">
     BERT4Rec on ML-1M in PyTorch
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="T595874_BERT4Rec_on_ML25M_in_PyTorch_Lightning.html">
     BERT4Rec on ML-25M
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="T088416_BST_Implementation_in_MXNet.html">
     BST Implementation in MXNet
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="T602245_BST_implementation_in_PyTorch.html">
     BST implementation in PyTorch
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="T007665_BST_on_ML1M_in_Keras.html">
     A Transformer-based recommendation system
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="T881207_BST_PTLightning_ML1M.html">
     Rating prediction using the Behavior Sequence Transformer (BST) model on ML-1M dataset in PyTorch Lightning
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="T025247_BST_using_Deepctr_library.html">
     BST using Deepctr library
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="T757997_SASRec_PyTorch.html">
     SASRec implementation with PyTorch Library
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="T225287_SASRec_PaddlePaddle.html">
     SASRec implementation with Paddle Library
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="T701627_SR_SAN_Session_based_Model.html">
     SR-SAN Session-based Recommender
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="T975104_SSEPT_ML1M_Tensorflow1x.html">
     SSE-PT Personalized Transformer Recommender on ML-1M in Tensorflow 1.x
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="T472955_GCSAN_Session_based_Model.html">
     GCSAN Session-based Recommender
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="T970274_Transformers4Rec_Session_based_Recommender_on_Yoochoose.html">
     End-to-end session-based recommendation with Transformers4Rec
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="T382183_Transformers4Rec_XLNet_on_Synthetic_data.html">
     Transformers4Rec XLNet on Synthetic data
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="T793395_Session_based_recommendation_on_REES46_Dataset.html">
     End-to-end Session-based recommendation on REES46 Dataset
    </a>
   </li>
  </ul>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Prototypes
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="T382881_DeepWalk_Karateclub.html">
   DeepWalk from scratch referencing Karateclub library
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T384270_DeepWalk_pure_python.html">
   DeepWalk in pure python
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T677598_Jaccard_Cosine_SVD_DeepWalk_ML100K.html">
   Recommender System with DeepWalk Graph Embeddings
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T815556_Node2vec_Karateclub.html">
   Node2vec from scratch referencing Karateclub library
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T894941_Node2vec_MovieLens_Keras.html">
   Graph representation learning with node2vec
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T611050_Node2vec_PyG.html">
   Node2vec from scratch in PyTorch Geometric
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T186367_Node2vec_library.html">
   Node2vec from scratch referencing node2vec library
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T331379_bayesian_personalized_ranking.html">
   BPR from scratch
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T081831_Data_Poisoning_Attacks_on_Factorization_Based_Collaborative_Filtering.html">
   Data Poisoning Attacks on Factorization-Based Collaborative Filtering
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T102448_Adversarial_Learning_for_Recommendation.html">
   Adversarial Training (Regularization) on a Recommender System
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T865035_Simulating_Data_Poisoning_Attacks_against_Twitter_Recommender.html">
   Load and process dataset
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T711285_Data_Poisoning_Attack_using_LFM_and_ItemAE_on_Synthetic_Dataset.html">
   Injection attack using LFM and ItemAE model trained on Toy dataset
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T355514_Black_box_Attack_on_Sequential_Recs.html">
   Black-box Attack on Sequential Recs
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T873451_Statistics_fundamentals.html">
   Statictics Fundamentals
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T890478_Batch_Learning_from_Bandit_Feedback_%28BLBF%29.html">
   Imports
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T257798_Off_Policy_Learning_in_Two_stage_Recommender_Systems.html">
   Off-Policy Learning in Two-stage Recommender Systems
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T471827_Adaptive_Estimator_Selection_for_Off_Policy_Evaluation.html">
   Adaptive Estimator Selection for Off-Policy Evaluation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T902666_Evaluating_the_Robustness_of_Off_Policy_Evaluation.html">
   Evaluating the Robustness of Off-Policy Evaluation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T705904_Evaluation_of_Multiple_Off_Policy_Estimators_on_Synthetic_Dataset.html">
   Evaluation of Multiple Off-Policy Estimators on Synthetic Dataset
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T874693_Evaluating_Standard_Off_Policy_Estimators_with_Small_Sample_Open_Bandit_Dataset.html">
   Evaluating Standard Off-Policy Estimators with Small Sample Open-Bandit Dataset
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T792262_Optimal_Off_Policy_Evaluation_from_Multiple_Logging_Policies.html">
   Optimal Off-Policy Evaluation from Multiple Logging Policies
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T167249_Offline_Policy_Evaluation_with_VW_Command_Line.html">
   Offline Policy Evaluation with VW Command Line
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T966055_OBP_Library_Workshop_Tutorials.html">
   OBP Library Workshop Tutorials
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T632722_PyTorch_Fundamentals_Part_1.html">
   PyTorch Fundamentals Part 1
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T472467_PyTorch_Fundamentals_Part_2.html">
   PyTorch Fundamentals Part 2
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T206654_PyTorch_Fundamentals_Part_3.html">
   PyTorch Fundamentals Part 3
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T536348_Attention_Mechanisms.html">
   Imports
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T500796_Agricultural_Satellite_Image_Segmentation.html">
   Agricultural Satellite Image Segmentation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T611432_Image_Analysis_with_Tensorflow.html">
   Image Analysis with Tensorflow
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T925716_MongoDB_to_CSV_Conversion.html">
   MongoDB to CSV conversion
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T396469_PDF_to_Word_Cloud_via_Email.html">
   PDF to WordCloud via Email
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T030890_Job_Scraping_and_Clustering.html">
   Job scraping and clustering
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T897054_Scene_Text_Recognition.html">
   Scene Text Recognition
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T034809_Large_scale_Document_Retrieval_with_Elastic_Search.html">
   Large-scale Document Retrieval with ElasticSearch
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T467251_vowpal_wabbit_contextual_recommender.html">
   Simulating a news personalization scenario using Contextual Bandits
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T686684_similar_product_recommender.html">
   Similar Product Recommender system using Deep Learning for an online e-commerce store
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T132203_Retail_Product_Recommendations_using_Word2vec.html">
   Retail Product Recommendations using word2vec
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T501828_Recommender_Implicit_Negative_Feedback.html">
   Retail Product Recommendation with Negative Implicit Feedback
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T315965_Sequence_Aware_Recommenders_Music.html">
   Sequence Aware Recommender Systems
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T051777_image_similarity_recommendations.html">
   Similar Product Recommendations
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990172_recobook_diversity_aware_book_recommender.html">
   Diversity Aware Book Recommender
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T488549_Goodreads_Diversity_Aware_Book_Recommender.html">
   Diversity Aware Book Recommender
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T023535_Kafka_MongoDB_Real_time_Streaming.html">
   Kafka MongoDB Real-time Streaming
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T622304_Session_based_Recommender_Using_Word2vec.html">
   Session-based recommendation using word2vec
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T416854_bandit_based_recommender_using_thompson_sampling_app.html">
   Bandit-based Online Learning using Thompson Sampling
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T198578_Booking_dot_com_Trip_Recommendation.html">
   Booking.com Trip Recommendation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T519734_Vowpal_Wabbit_Contextual_Bandit.html">
   Vowpal Wabbit Contextual Bandit
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T871537_Recommendation_Systems_using_Olist_Dataset.html">
   Recommendation systems using Olist dataset
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T057885_Offline_Replayer_Evaluation.html">
   Offline Replayer Evaluation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T915054_method_for_effective_online_testing.html">
   Methods for effective online testing
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T513987_Recsys_2020_Feature_Engineering_Tutorial.html">
   Recsys’20 Feature Engineering Tutorial
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T227901_amazon_personalize_batch_job.html">
   Amazon Personalize Batch Job
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T022961_Amazon_Personalize_Workshop.html">
   Amazon Personalize Workshop
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T424437_Collaborative_Filtering_on_ML_latest_small.html">
   Collaborative Filtering on ML-latest-small
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T539160_Building_and_Deploying_ASOS_Fashion_Recommender.html">
   Building and deploying ASOS fashion recommender
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T757697_Simple_Similarity_based_Recommender.html">
   Simple Similarity based Recommmendations
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T051594_Analytics_Zoo.html">
   Analytics Zoo
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T313645_A_B_Testing.html">
   A/B Testing
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T475711_PinSage_Graph_based_Recommender.html">
   PinSage Graph-based Recommender
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T516490_Graph_Embeddings.html">
   Learn Embeddings using Graph Networks
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T822164_movielens_milvus_redis_efficient_retrieval.html">
   Recommender with Redis and Milvus
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T845186_Anime_Recommender.html">
   RekoNet Anime Recommender
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T855843_kafka_spark_streaming_colab.html">
   Kafka and Spark Streaming in Colab
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T460437_Building_Models_From_Scratch.html">
   Building Models from scratch
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T855971_Conet_Model_for_Movie_Recommender.html">
   CoNet model
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T996996_content_based_and_collaborative_movielens.html">
   Movie Recommendation with Content-Based and Collaborative Filtering
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T239418_Simple_Movie_Recommenders.html">
   Simple Movie Recommenders
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T138337_Simple_Movie_Recommender.html">
   Simple movie recommender in implicit, explicit, and cold-start settings
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T935440_The_importance_of_Rating_Normalization.html">
   The importance of Rating Normalization
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T612622_cornac_examples.html">
   Cornac Examples
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T561435_Flower_Classification.html">
   Flower classification
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T680910_Trivago_Session_based_Recommender.html">
   Trivago Session-based Recommender
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990000_ads_selection_using_bandits.html">
   Best Ads detection using bandit methods
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990000_book_crossing_surprise_svd_nmf.html">
   Book-Crossing Recommendation System
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990000_book_recommender_kubeflow.html">
   Books recommendations with Kubeflow Pipelines on Scaleway Kapsule
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990000_build_a_kubeflow_pipeline.html">
   Build a Kubeflow Pipeline
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990000_causal_inference.html">
   Causal Inference
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990000_concept_embedding_nlp.html">
   Exploring Word Embeddings
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990000_concept_neural_net.html">
   Neural Network
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990000_concept_nlp_basics.html">
   Natural Language Processing 101
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990000_concept_transformer_lm.html">
   TransformerLM Quick Start and Guide
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990000_content_based_music_recommender_lyricsfreak.html">
   Content-based method for song recommendation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990000_evaluation_metrics_basics.html">
   Recommender System Evaluations
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990000_implicit_synthetic.html">
   Comparing Implicit Models on Synthetic Data
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990000_movie_recommender_tensorflow.html">
   Recommendation Systems with TensorFlow
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990000_movie_recommender_tensorflow_sagemaker.html">
   Movie recommender using Tensorflow in Sagemaker
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Movielens EDA and Modeling
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990000_read_data_from_cassandra_into_pandas.html">
   Read Cassandra Data Snapshot as DataFrame
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990000_rl_in_action.html">
   Reinforcement Learning fundamentals in action
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990000_rnn_cnn_basics.html">
   Processing sequences using RNNs and CNNs
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990000_tf_serving_in_action.html">
   TF Serving in action
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990000_training_indexing_movie_recommender.html">
   Training and indexing movie recommender
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T207114_EduRec_MOOCCube_Course_Recommender.html">
   EduRec MOOCCube Course Recommender
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T273184_Multi_Task_Learning.html">
   Multi-task Learning
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T661108_Book_Recommender_API.html">
   Book Recommender API
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T912764_Simple_Movie_Recommender_App.html">
   Simple Movie Recommender App
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T964554_Career_Village_Questions_Recommendation.html">
   CareerVillage Questions Recommendation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990001_amazon_women_apparel_tfidf_word2vec.html">
   Amazon Product Recommender
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990001_anime_recommender_graph_network.html">
   Anime Recommender with Bi-partite Graph Network
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990001_concept_self_attention.html">
   Self-Attention
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990001_course_recommender_svd_flask.html">
   Course Recommender with SVD based similarity
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990001_data_mining_similarity_measures.html">
   Concept - Data Mining Similarity Measures
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990001_jaccard_recommender.html">
   Jaccard Similarity based Recommender
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990001_live_streamer_recommender.html">
   Live Streamer Recommender with Implicit feedback
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990001_songs_embedding_skipgram_recommender.html">
   Song Embeddings - Skipgram Recommender
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990001_toy_example_car_recommender_knn.html">
   Toy example - Car Recommender using KNN method
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T990001_wikirecs_recommender.html">
   WikiRecs
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../_sources/nbs/T990000_movielens_eda_modeling.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/sparsh-ai/reco-book/main?urlpath=tree/nbs/T990000_movielens_eda_modeling.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="../_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav" aria-label="Page">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#setup">
   Setup
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#loading">
   Loading
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#eda">
   EDA
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#preprocessing">
   Preprocessing
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#baseline-models">
   Baseline Models
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#baseline-simple-average-model">
     Baseline - Simple Average Model
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#baseline-average-by-id-model">
     Baseline - Average by ID Model
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#baseline-damped-baseline-with-user-movie-data">
     Baseline - Damped Baseline with User + Movie Data
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#knn-collaborative-filtering">
   KNN Collaborative Filtering
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#als-sgd">
   ALS &amp; SGD
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#choose-the-best-user-based-model">
     Choose the best user-based model
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#choose-the-best-item-based-model">
     Choose the best item-based model
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#choose-the-best-als-model">
     Choose the best ALS model
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#choose-the-best-sgd-model">
     Choose the best SGD model
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#compare-the-top-methods-of-each-category">
     Compare the top methods of each category
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#fetching-posters">
     Fetching posters
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#non-negative-matrix-factorization-nmf-scikit-learn-package">
   Non-Negative Matrix Factorization (NMF, scikit-learn package)
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#hybrid-using-processed-dataset">
   Hybrid (using processed dataset)
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#lightfm-bpr-warp">
   LightFM - BPR &amp; WARP
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#microsoft-library-fastai-collab">
   Microsoft Library - FastAI-Collab
  </a>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="section" id="movielens-eda-and-modeling">
<h1>Movielens EDA and Modeling<a class="headerlink" href="#movielens-eda-and-modeling" title="Permalink to this headline">¶</a></h1>
<blockquote>
<div><p>EDA and modeling on movielens dataset.</p>
</div></blockquote>
<div class="section" id="setup">
<h2>Setup<a class="headerlink" href="#setup" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span># download dataset
!wget http://files.grouplens.org/datasets/movielens/ml-100k.zip &amp;&amp; unzip ml-100k.zip
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>!wget http://files.grouplens.org/datasets/movielens/ml-latest.zip &amp;&amp; unzip ml-latest.zip
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>

<span class="kn">import</span> <span class="nn">gc</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">join</span>
<span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">exists</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">reduce</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">mean_absolute_error</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">KFold</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">StratifiedKFold</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics.pairwise</span> <span class="kn">import</span> <span class="n">cosine_similarity</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">Markdown</span>

<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">HTML</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;/content/drive/MyDrive&quot;</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">mykeys</span>

<span class="n">api_key</span> <span class="o">=</span> <span class="n">mykeys</span><span class="o">.</span><span class="n">moviedb_key</span>
<span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Accept&#39;</span><span class="p">:</span> <span class="s1">&#39;application/json&#39;</span><span class="p">}</span>
<span class="n">payload</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;api_key&#39;</span><span class="p">:</span> <span class="n">api_key</span><span class="p">}</span> 
<span class="k">try</span><span class="p">:</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="s2">&quot;http://api.themoviedb.org/3/configuration&quot;</span><span class="p">,</span>
        <span class="n">params</span><span class="o">=</span><span class="n">payload</span><span class="p">,</span>
        <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
    <span class="n">base_url</span> <span class="o">=</span> <span class="n">response</span><span class="p">[</span><span class="s1">&#39;images&#39;</span><span class="p">][</span><span class="s1">&#39;base_url&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;w185&#39;</span>
<span class="k">except</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Your API key might be invalid.&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="loading">
<h2>Loading<a class="headerlink" href="#loading" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># loading ratings data</span>
<span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">,</span> <span class="s1">&#39;item_id&#39;</span><span class="p">,</span> <span class="s1">&#39;rating&#39;</span><span class="p">,</span> <span class="s1">&#39;timestamp&#39;</span><span class="p">]</span>
<span class="n">ratings_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;ml-100k/u.data&#39;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="n">names</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;First 5:&#39;</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">ratings_df</span><span class="o">.</span><span class="n">head</span><span class="p">())</span>
<span class="nb">print</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Last 5:&#39;</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">ratings_df</span><span class="o">.</span><span class="n">tail</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>First 5:
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>user_id</th>
      <th>item_id</th>
      <th>rating</th>
      <th>timestamp</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>196</td>
      <td>242</td>
      <td>3</td>
      <td>881250949</td>
    </tr>
    <tr>
      <th>1</th>
      <td>186</td>
      <td>302</td>
      <td>3</td>
      <td>891717742</td>
    </tr>
    <tr>
      <th>2</th>
      <td>22</td>
      <td>377</td>
      <td>1</td>
      <td>878887116</td>
    </tr>
    <tr>
      <th>3</th>
      <td>244</td>
      <td>51</td>
      <td>2</td>
      <td>880606923</td>
    </tr>
    <tr>
      <th>4</th>
      <td>166</td>
      <td>346</td>
      <td>1</td>
      <td>886397596</td>
    </tr>
  </tbody>
</table>
</div></div><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Last 5:
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>user_id</th>
      <th>item_id</th>
      <th>rating</th>
      <th>timestamp</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>99995</th>
      <td>880</td>
      <td>476</td>
      <td>3</td>
      <td>880175444</td>
    </tr>
    <tr>
      <th>99996</th>
      <td>716</td>
      <td>204</td>
      <td>5</td>
      <td>879795543</td>
    </tr>
    <tr>
      <th>99997</th>
      <td>276</td>
      <td>1090</td>
      <td>1</td>
      <td>874795795</td>
    </tr>
    <tr>
      <th>99998</th>
      <td>13</td>
      <td>225</td>
      <td>2</td>
      <td>882399156</td>
    </tr>
    <tr>
      <th>99999</th>
      <td>12</td>
      <td>203</td>
      <td>3</td>
      <td>879959583</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;user_id&quot;</span><span class="p">,</span> <span class="s2">&quot;age&quot;</span> <span class="p">,</span> <span class="s2">&quot;gender&quot;</span><span class="p">,</span><span class="s2">&quot;occupation&quot;</span><span class="p">,</span> <span class="s2">&quot;zip_code&quot;</span><span class="p">]</span>
<span class="n">user_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;ml-100k/u.user&#39;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;|&#39;</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="n">names</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;First 5:&#39;</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">user_df</span><span class="o">.</span><span class="n">head</span><span class="p">())</span>
<span class="nb">print</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Last 5:&#39;</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">user_df</span><span class="o">.</span><span class="n">tail</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>First 5:
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>user_id</th>
      <th>age</th>
      <th>gender</th>
      <th>occupation</th>
      <th>zip_code</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>24</td>
      <td>M</td>
      <td>technician</td>
      <td>85711</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2</td>
      <td>53</td>
      <td>F</td>
      <td>other</td>
      <td>94043</td>
    </tr>
    <tr>
      <th>2</th>
      <td>3</td>
      <td>23</td>
      <td>M</td>
      <td>writer</td>
      <td>32067</td>
    </tr>
    <tr>
      <th>3</th>
      <td>4</td>
      <td>24</td>
      <td>M</td>
      <td>technician</td>
      <td>43537</td>
    </tr>
    <tr>
      <th>4</th>
      <td>5</td>
      <td>33</td>
      <td>F</td>
      <td>other</td>
      <td>15213</td>
    </tr>
  </tbody>
</table>
</div></div><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Last 5:
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>user_id</th>
      <th>age</th>
      <th>gender</th>
      <th>occupation</th>
      <th>zip_code</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>938</th>
      <td>939</td>
      <td>26</td>
      <td>F</td>
      <td>student</td>
      <td>33319</td>
    </tr>
    <tr>
      <th>939</th>
      <td>940</td>
      <td>32</td>
      <td>M</td>
      <td>administrator</td>
      <td>02215</td>
    </tr>
    <tr>
      <th>940</th>
      <td>941</td>
      <td>20</td>
      <td>M</td>
      <td>student</td>
      <td>97229</td>
    </tr>
    <tr>
      <th>941</th>
      <td>942</td>
      <td>48</td>
      <td>F</td>
      <td>librarian</td>
      <td>78209</td>
    </tr>
    <tr>
      <th>942</th>
      <td>943</td>
      <td>22</td>
      <td>M</td>
      <td>student</td>
      <td>77841</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># loading ratings data</span>
<span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;genre&quot;</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">]</span>
<span class="n">genre_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;ml-100k/u.genre&#39;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;|&#39;</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="n">names</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;First 5:&#39;</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">genre_df</span><span class="o">.</span><span class="n">head</span><span class="p">())</span>
<span class="nb">print</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Last 5:&#39;</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">genre_df</span><span class="o">.</span><span class="n">tail</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>First 5:
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>genre</th>
      <th>id</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>unknown</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Action</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Adventure</td>
      <td>2</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Animation</td>
      <td>3</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Children's</td>
      <td>4</td>
    </tr>
  </tbody>
</table>
</div></div><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Last 5:
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>genre</th>
      <th>id</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>14</th>
      <td>Romance</td>
      <td>14</td>
    </tr>
    <tr>
      <th>15</th>
      <td>Sci-Fi</td>
      <td>15</td>
    </tr>
    <tr>
      <th>16</th>
      <td>Thriller</td>
      <td>16</td>
    </tr>
    <tr>
      <th>17</th>
      <td>War</td>
      <td>17</td>
    </tr>
    <tr>
      <th>18</th>
      <td>Western</td>
      <td>18</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># loading ratings data</span>
<span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;item_id&quot;</span><span class="p">,</span> <span class="s2">&quot;movie_title&quot;</span><span class="p">,</span> <span class="s2">&quot;release_date&quot;</span><span class="p">,</span> <span class="s2">&quot;video_release_date&quot;</span><span class="p">,</span> <span class="s2">&quot;IMDb_URL&quot;</span><span class="p">]</span>
<span class="n">items_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;ml-100k/u.item&#39;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;|&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;iso-8859-1&quot;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;First 5:&#39;</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">items_df</span><span class="o">.</span><span class="n">head</span><span class="p">())</span>
<span class="nb">print</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Last 5:&#39;</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">items_df</span><span class="o">.</span><span class="n">tail</span><span class="p">())</span>

<span class="c1"># loading movies info</span>
<span class="c1"># item_info = pd.read_csv(&#39;ml-100k/u.item&#39;, sep=&#39;|&#39;, encoding=&quot;iso-8859-1&quot;, </span>
                        <span class="c1"># header=None)</span>
<span class="c1"># item_info.columns = [&#39;title&#39;]</span>
<span class="c1"># item_info.head()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>First 5:
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>0</th>
      <th>1</th>
      <th>2</th>
      <th>3</th>
      <th>4</th>
      <th>5</th>
      <th>6</th>
      <th>7</th>
      <th>8</th>
      <th>9</th>
      <th>10</th>
      <th>11</th>
      <th>12</th>
      <th>13</th>
      <th>14</th>
      <th>15</th>
      <th>16</th>
      <th>17</th>
      <th>18</th>
      <th>19</th>
      <th>20</th>
      <th>21</th>
      <th>22</th>
      <th>23</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>Toy Story (1995)</td>
      <td>01-Jan-1995</td>
      <td>NaN</td>
      <td>http://us.imdb.com/M/title-exact?Toy%20Story%2...</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2</td>
      <td>GoldenEye (1995)</td>
      <td>01-Jan-1995</td>
      <td>NaN</td>
      <td>http://us.imdb.com/M/title-exact?GoldenEye%20(...</td>
      <td>0</td>
      <td>1</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>3</td>
      <td>Four Rooms (1995)</td>
      <td>01-Jan-1995</td>
      <td>NaN</td>
      <td>http://us.imdb.com/M/title-exact?Four%20Rooms%...</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>4</td>
      <td>Get Shorty (1995)</td>
      <td>01-Jan-1995</td>
      <td>NaN</td>
      <td>http://us.imdb.com/M/title-exact?Get%20Shorty%...</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>5</td>
      <td>Copycat (1995)</td>
      <td>01-Jan-1995</td>
      <td>NaN</td>
      <td>http://us.imdb.com/M/title-exact?Copycat%20(1995)</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
</div></div><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Last 5:
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>0</th>
      <th>1</th>
      <th>2</th>
      <th>3</th>
      <th>4</th>
      <th>5</th>
      <th>6</th>
      <th>7</th>
      <th>8</th>
      <th>9</th>
      <th>10</th>
      <th>11</th>
      <th>12</th>
      <th>13</th>
      <th>14</th>
      <th>15</th>
      <th>16</th>
      <th>17</th>
      <th>18</th>
      <th>19</th>
      <th>20</th>
      <th>21</th>
      <th>22</th>
      <th>23</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1677</th>
      <td>1678</td>
      <td>Mat' i syn (1997)</td>
      <td>06-Feb-1998</td>
      <td>NaN</td>
      <td>http://us.imdb.com/M/title-exact?Mat%27+i+syn+...</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1678</th>
      <td>1679</td>
      <td>B. Monkey (1998)</td>
      <td>06-Feb-1998</td>
      <td>NaN</td>
      <td>http://us.imdb.com/M/title-exact?B%2E+Monkey+(...</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1679</th>
      <td>1680</td>
      <td>Sliding Doors (1998)</td>
      <td>01-Jan-1998</td>
      <td>NaN</td>
      <td>http://us.imdb.com/Title?Sliding+Doors+(1998)</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1680</th>
      <td>1681</td>
      <td>You So Crazy (1994)</td>
      <td>01-Jan-1994</td>
      <td>NaN</td>
      <td>http://us.imdb.com/M/title-exact?You%20So%20Cr...</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1681</th>
      <td>1682</td>
      <td>Scream of Stone (Schrei aus Stein) (1991)</td>
      <td>08-Mar-1996</td>
      <td>NaN</td>
      <td>http://us.imdb.com/M/title-exact?Schrei%20aus%...</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">links_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;ml-latest/links.csv&#39;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;movieId&#39;</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">links_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>imdbId</th>
      <th>tmdbId</th>
    </tr>
    <tr>
      <th>movieId</th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <td>0114709</td>
      <td>862</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0113497</td>
      <td>8844</td>
    </tr>
    <tr>
      <th>3</th>
      <td>0113228</td>
      <td>15602</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0114885</td>
      <td>31357</td>
    </tr>
    <tr>
      <th>5</th>
      <td>0113041</td>
      <td>11862</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Processed Data Loading</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pratings</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">dpath</span><span class="o">+</span><span class="s1">&#39;ratings.csv&#39;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;latin-1&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;First 5:&#39;</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">pratings</span><span class="o">.</span><span class="n">head</span><span class="p">())</span>
<span class="nb">print</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Last 5:&#39;</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">pratings</span><span class="o">.</span><span class="n">tail</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>First 5:
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>UserId</th>
      <th>MovieId</th>
      <th>Rating</th>
      <th>Timestamp</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>196</td>
      <td>242</td>
      <td>3.0</td>
      <td>881250949</td>
    </tr>
    <tr>
      <th>1</th>
      <td>186</td>
      <td>302</td>
      <td>3.0</td>
      <td>891717742</td>
    </tr>
    <tr>
      <th>2</th>
      <td>22</td>
      <td>377</td>
      <td>1.0</td>
      <td>878887116</td>
    </tr>
    <tr>
      <th>3</th>
      <td>244</td>
      <td>51</td>
      <td>2.0</td>
      <td>880606923</td>
    </tr>
    <tr>
      <th>4</th>
      <td>166</td>
      <td>346</td>
      <td>1.0</td>
      <td>886397596</td>
    </tr>
  </tbody>
</table>
</div></div><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Last 5:
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>UserId</th>
      <th>MovieId</th>
      <th>Rating</th>
      <th>Timestamp</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>99995</th>
      <td>880</td>
      <td>476</td>
      <td>3.0</td>
      <td>880175444</td>
    </tr>
    <tr>
      <th>99996</th>
      <td>716</td>
      <td>204</td>
      <td>5.0</td>
      <td>879795543</td>
    </tr>
    <tr>
      <th>99997</th>
      <td>276</td>
      <td>1090</td>
      <td>1.0</td>
      <td>874795795</td>
    </tr>
    <tr>
      <th>99998</th>
      <td>13</td>
      <td>225</td>
      <td>2.0</td>
      <td>882399156</td>
    </tr>
    <tr>
      <th>99999</th>
      <td>12</td>
      <td>203</td>
      <td>3.0</td>
      <td>879959583</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pmovies</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">dpath</span><span class="o">+</span><span class="s1">&#39;items.csv&#39;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;latin-1&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;First 5:&#39;</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">pmovies</span><span class="o">.</span><span class="n">head</span><span class="p">())</span>
<span class="nb">print</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Last 5:&#39;</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">pmovies</span><span class="o">.</span><span class="n">tail</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>First 5:
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>ItemID</th>
      <th>Title</th>
      <th>Release Date</th>
      <th>Video Release Date</th>
      <th>IMDb URL</th>
      <th>unknown</th>
      <th>Action</th>
      <th>Adventure</th>
      <th>Animation</th>
      <th>Children's</th>
      <th>Comedy</th>
      <th>Crime</th>
      <th>Documentary</th>
      <th>Drama</th>
      <th>Fantasy</th>
      <th>Film-Noir</th>
      <th>Horror</th>
      <th>Musical</th>
      <th>Mystery</th>
      <th>Romance</th>
      <th>Sci-Fi</th>
      <th>Thriller</th>
      <th>War</th>
      <th>Western</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>Toy Story (1995)</td>
      <td>01-Jan-1995</td>
      <td>NaN</td>
      <td>http://us.imdb.com/M/title-exact?Toy%20Story%2...</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2</td>
      <td>GoldenEye (1995)</td>
      <td>01-Jan-1995</td>
      <td>NaN</td>
      <td>http://us.imdb.com/M/title-exact?GoldenEye%20(...</td>
      <td>0</td>
      <td>1</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>3</td>
      <td>Four Rooms (1995)</td>
      <td>01-Jan-1995</td>
      <td>NaN</td>
      <td>http://us.imdb.com/M/title-exact?Four%20Rooms%...</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>4</td>
      <td>Get Shorty (1995)</td>
      <td>01-Jan-1995</td>
      <td>NaN</td>
      <td>http://us.imdb.com/M/title-exact?Get%20Shorty%...</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>5</td>
      <td>Copycat (1995)</td>
      <td>01-Jan-1995</td>
      <td>NaN</td>
      <td>http://us.imdb.com/M/title-exact?Copycat%20(1995)</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
</div></div><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Last 5:
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>ItemID</th>
      <th>Title</th>
      <th>Release Date</th>
      <th>Video Release Date</th>
      <th>IMDb URL</th>
      <th>unknown</th>
      <th>Action</th>
      <th>Adventure</th>
      <th>Animation</th>
      <th>Children's</th>
      <th>Comedy</th>
      <th>Crime</th>
      <th>Documentary</th>
      <th>Drama</th>
      <th>Fantasy</th>
      <th>Film-Noir</th>
      <th>Horror</th>
      <th>Musical</th>
      <th>Mystery</th>
      <th>Romance</th>
      <th>Sci-Fi</th>
      <th>Thriller</th>
      <th>War</th>
      <th>Western</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1677</th>
      <td>1678</td>
      <td>Mat' i syn (1997)</td>
      <td>06-Feb-1998</td>
      <td>NaN</td>
      <td>http://us.imdb.com/M/title-exact?Mat%27+i+syn+...</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1678</th>
      <td>1679</td>
      <td>B. Monkey (1998)</td>
      <td>06-Feb-1998</td>
      <td>NaN</td>
      <td>http://us.imdb.com/M/title-exact?B%2E+Monkey+(...</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1679</th>
      <td>1680</td>
      <td>Sliding Doors (1998)</td>
      <td>01-Jan-1998</td>
      <td>NaN</td>
      <td>http://us.imdb.com/Title?Sliding+Doors+(1998)</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1680</th>
      <td>1681</td>
      <td>You So Crazy (1994)</td>
      <td>01-Jan-1994</td>
      <td>NaN</td>
      <td>http://us.imdb.com/M/title-exact?You%20So%20Cr...</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1681</th>
      <td>1682</td>
      <td>Scream of Stone (Schrei aus Stein) (1991)</td>
      <td>08-Mar-1996</td>
      <td>NaN</td>
      <td>http://us.imdb.com/M/title-exact?Schrei%20aus%...</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</div>
<div class="section" id="eda">
<h2>EDA<a class="headerlink" href="#eda" title="Permalink to this headline">¶</a></h2>
<p>How are the ratings distributed?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">norm_counts</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">ratings_df</span><span class="p">[</span><span class="s1">&#39;rating&#39;</span><span class="p">]</span>
    <span class="o">.</span><span class="n">value_counts</span><span class="p">(</span><span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
    <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;rating&#39;</span><span class="p">:</span> <span class="s1">&#39;percent&#39;</span><span class="p">,</span> <span class="s1">&#39;index&#39;</span><span class="p">:</span> <span class="s1">&#39;rating&#39;</span><span class="p">})</span>
<span class="p">)</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;rating&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;percent&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">norm_counts</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Rating Frequencies&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/T990000_movielens_eda_modeling_17_0.png" src="../_images/T990000_movielens_eda_modeling_17_0.png" />
</div>
</div>
<p>How many ratings were submitted per month?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">_process_ratings</span><span class="p">(</span><span class="n">ratings_df</span><span class="p">):</span>
  <span class="n">ratings_df</span> <span class="o">=</span> <span class="n">ratings_df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
  <span class="n">ratings_df</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ratings_df</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">)</span>
  <span class="n">ratings_df</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ratings_df</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span>
  <span class="n">ratings_df</span><span class="p">[</span><span class="s1">&#39;month&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ratings_df</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">month</span>
  <span class="n">ratings_df</span> <span class="o">=</span> <span class="n">ratings_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;timestamp&#39;</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">ratings_df</span>

<span class="n">_ratings_df</span> <span class="o">=</span> <span class="n">_process_ratings</span><span class="p">(</span><span class="n">ratings_df</span><span class="p">)</span>
<span class="n">month_counts</span> <span class="o">=</span> <span class="n">_ratings_df</span><span class="p">[[</span><span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="s1">&#39;month&#39;</span><span class="p">,</span> <span class="s1">&#39;rating&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="s1">&#39;month&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
<span class="n">month_counts</span> <span class="o">=</span> <span class="n">month_counts</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;rating&#39;</span><span class="p">:</span> <span class="s1">&#39;# of Ratings&#39;</span><span class="p">})</span>
<span class="n">month_counts</span> <span class="o">=</span> <span class="n">month_counts</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<span class="n">month_counts</span><span class="p">[</span><span class="s1">&#39;Date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">month_counts</span><span class="p">[[</span><span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="s1">&#39;month&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
    <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">datetime</span><span class="p">(</span><span class="n">year</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">month</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">day</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
<span class="p">)</span>
<span class="n">month_counts</span> <span class="o">=</span> <span class="n">month_counts</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">month_counts</span><span class="p">[</span><span class="s1">&#39;# of Ratings&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="s1">&#39;o-&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;# of Ratings&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;# of Ratings per Month&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">25000</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">which</span><span class="o">=</span><span class="s1">&#39;minor&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/T990000_movielens_eda_modeling_19_0.png" src="../_images/T990000_movielens_eda_modeling_19_0.png" />
</div>
</div>
<p>How consistent are the average ratings over time?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">month_counts</span> <span class="o">=</span> <span class="n">_ratings_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="s1">&#39;month&#39;</span><span class="p">])[</span><span class="s1">&#39;rating&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">agg</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">])</span>
<span class="n">month_counts</span> <span class="o">=</span> <span class="n">month_counts</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;mean&#39;</span><span class="p">:</span> <span class="s1">&#39;Rating&#39;</span><span class="p">})</span>
<span class="n">month_counts</span> <span class="o">=</span> <span class="n">month_counts</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<span class="n">month_counts</span><span class="p">[</span><span class="s1">&#39;Date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">month_counts</span><span class="p">[[</span><span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="s1">&#39;month&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
    <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">datetime</span><span class="p">(</span><span class="n">year</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">month</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">day</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
<span class="p">)</span>
<span class="n">month_counts</span> <span class="o">=</span> <span class="n">month_counts</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">month_counts</span><span class="p">[</span><span class="s1">&#39;Rating&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="s1">&#39;o-&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">month_counts</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
                 <span class="n">month_counts</span><span class="p">[</span><span class="s1">&#39;Rating&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">month_counts</span><span class="p">[</span><span class="s1">&#39;std&#39;</span><span class="p">],</span>
                 <span class="n">month_counts</span><span class="p">[</span><span class="s1">&#39;Rating&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">month_counts</span><span class="p">[</span><span class="s1">&#39;std&#39;</span><span class="p">],</span>
                 <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span>
                <span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Rating&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">which</span><span class="o">=</span><span class="s1">&#39;minor&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Rating Consistency over Time&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/T990000_movielens_eda_modeling_21_0.png" src="../_images/T990000_movielens_eda_modeling_21_0.png" />
</div>
</div>
<p>How quickly do the movie and user bases grow over time?</p>
<p><em>(assume that a user has joined on her first rating, and that she remains a user from then on.)</em></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">_ratings_df</span><span class="p">[</span><span class="s1">&#39;Date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_ratings_df</span><span class="p">[[</span><span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="s1">&#39;month&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
    <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">datetime</span><span class="p">(</span><span class="n">year</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">month</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">day</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
<span class="p">)</span>
<span class="n">n_users</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">n_movies</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">dates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">_ratings_df</span><span class="p">[</span><span class="s1">&#39;Date&#39;</span><span class="p">])</span>
<span class="k">for</span> <span class="n">date</span> <span class="ow">in</span> <span class="n">dates</span><span class="p">:</span>
    <span class="n">n_users</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_ratings_df</span><span class="p">[</span><span class="n">_ratings_df</span><span class="p">[</span><span class="s1">&#39;Date&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">date</span><span class="p">][</span><span class="s1">&#39;user_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">())</span>
    <span class="n">n_movies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_ratings_df</span><span class="p">[</span><span class="n">_ratings_df</span><span class="p">[</span><span class="s1">&#39;Date&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">date</span><span class="p">][</span><span class="s1">&#39;item_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">())</span>
<span class="n">df_users</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;Date&#39;</span><span class="p">:</span> <span class="n">dates</span><span class="p">,</span> <span class="s1">&#39;# of Users&#39;</span><span class="p">:</span> <span class="n">n_users</span><span class="p">})</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span>
<span class="n">df_movies</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;Date&#39;</span><span class="p">:</span> <span class="n">dates</span><span class="p">,</span> <span class="s1">&#39;# of Movies&#39;</span><span class="p">:</span> <span class="n">n_movies</span><span class="p">})</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="n">df_movies</span><span class="p">[</span><span class="s1">&#39;# of Movies&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="s1">&#39;o-&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="n">df_users</span><span class="p">[</span><span class="s1">&#39;# of Users&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="s1">&#39;o-&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Count&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2000</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">which</span><span class="o">=</span><span class="s1">&#39;minor&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/T990000_movielens_eda_modeling_23_0.png" src="../_images/T990000_movielens_eda_modeling_23_0.png" />
</div>
</div>
<p>How sparse is the user/movies matrix we’ll be dealing with?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_rating_matrix</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Function to generate a ratings matrix and mappings for</span>
<span class="sd">    the user and item ids to the row and column indices</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    X : pandas.DataFrame, shape=(n_ratings,&gt;=3)</span>
<span class="sd">        First 3 columns must be in order of user, item, rating.</span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    rating_matrix : 2d numpy array, shape=(n_users, n_items)</span>
<span class="sd">    user_map : pandas Series, shape=(n_users,)</span>
<span class="sd">        Mapping from the original user id to an integer in the range [0,n_users)</span>
<span class="sd">    item_map : pandas Series, shape=(n_items,)</span>
<span class="sd">        Mapping from the original item id to an integer in the range [0,n_items)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">user_col</span><span class="p">,</span> <span class="n">item_col</span><span class="p">,</span> <span class="n">rating_col</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">rating</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">rating_col</span><span class="p">]</span>
    <span class="n">user_map</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span>
        <span class="n">index</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">user_col</span><span class="p">]),</span>
        <span class="n">data</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">user_col</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()),</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;user_map&#39;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">item_map</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span>
        <span class="n">index</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">item_col</span><span class="p">]),</span>
        <span class="n">data</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">item_col</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()),</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;columns_map&#39;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">user_inds</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">user_col</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">user_map</span><span class="p">)</span>
    <span class="n">item_inds</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">item_col</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">item_map</span><span class="p">)</span>
    <span class="n">rating_matrix</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">pd</span><span class="o">.</span><span class="n">pivot_table</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="n">X</span><span class="p">,</span>
            <span class="n">values</span><span class="o">=</span><span class="n">rating_col</span><span class="p">,</span>
            <span class="n">index</span><span class="o">=</span><span class="n">user_inds</span><span class="p">,</span>
            <span class="n">columns</span><span class="o">=</span><span class="n">item_inds</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="o">.</span><span class="n">values</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">rating_matrix</span><span class="p">,</span> <span class="n">user_map</span><span class="p">,</span> <span class="n">item_map</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">rating_matrix</span><span class="p">,</span> <span class="n">user_map</span><span class="p">,</span> <span class="n">item_map</span> <span class="o">=</span> <span class="n">get_rating_matrix</span><span class="p">(</span><span class="n">ratings_df</span><span class="p">)</span>
<span class="k">with</span> <span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">context</span><span class="p">(</span><span class="s1">&#39;seaborn-white&#39;</span><span class="p">):</span>
    <span class="n">rating_matrix_binary</span> <span class="o">=</span> <span class="n">rating_matrix</span> <span class="o">&gt;</span> <span class="mi">0</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">rating_matrix_binary</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Movie&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;User&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/T990000_movielens_eda_modeling_26_0.png" src="../_images/T990000_movielens_eda_modeling_26_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">rating_matrix</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[5., 3., 4., ..., 0., 0., 0.],
       [4., 0., 0., ..., 0., 0., 0.],
       [0., 0., 0., ..., 0., 0., 0.],
       ...,
       [5., 0., 0., ..., 0., 0., 0.],
       [0., 0., 0., ..., 0., 0., 0.],
       [0., 5., 0., ..., 0., 0., 0.]])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Markdown</span><span class="p">(</span>
    <span class="sa">r</span><span class="s2">&quot;The matrix density is $n_{{ratings}}/(n_{{users}} \times n_{{movies}}) = </span><span class="si">{:0.3f}</span><span class="s2">$&quot;</span>
    <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">rating_matrix_binary</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">rating_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<p>The matrix density is $n_{ratings}/(n_{users} \times n_{movies}) = 0.063$</p>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">user_counts</span> <span class="o">=</span> <span class="n">ratings_df</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">user_counts</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">user_counts</span><span class="p">))</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">user_counts</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">user_counts</span><span class="p">,</span> <span class="n">user_counts</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Users&#39;</span><span class="p">)</span>
<span class="n">movie_counts</span> <span class="o">=</span> <span class="n">ratings_df</span><span class="p">[</span><span class="s1">&#39;item_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">movie_counts</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">movie_counts</span><span class="p">))</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">movie_counts</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">movie_counts</span><span class="p">,</span> <span class="n">movie_counts</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Movies&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Number of Ratings&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;ECDF&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/T990000_movielens_eda_modeling_29_0.png" src="../_images/T990000_movielens_eda_modeling_29_0.png" />
</div>
</div>
</div>
<div class="section" id="preprocessing">
<h2>Preprocessing<a class="headerlink" href="#preprocessing" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">display</span><span class="p">(</span><span class="n">ratings_df</span><span class="o">.</span><span class="n">head</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>user_id</th>
      <th>item_id</th>
      <th>rating</th>
      <th>timestamp</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>196</td>
      <td>242</td>
      <td>3</td>
      <td>881250949</td>
    </tr>
    <tr>
      <th>1</th>
      <td>186</td>
      <td>302</td>
      <td>3</td>
      <td>891717742</td>
    </tr>
    <tr>
      <th>2</th>
      <td>22</td>
      <td>377</td>
      <td>1</td>
      <td>878887116</td>
    </tr>
    <tr>
      <th>3</th>
      <td>244</td>
      <td>51</td>
      <td>2</td>
      <td>880606923</td>
    </tr>
    <tr>
      <th>4</th>
      <td>166</td>
      <td>346</td>
      <td>1</td>
      <td>886397596</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</div>
<div class="section" id="baseline-models">
<h2>Baseline Models<a class="headerlink" href="#baseline-models" title="Permalink to this headline">¶</a></h2>
<div class="section" id="baseline-simple-average-model">
<h3>Baseline - Simple Average Model<a class="headerlink" href="#baseline-simple-average-model" title="Permalink to this headline">¶</a></h3>
<p>The first model we’ll test is about the simplest one possible. We’ll just average all the training set ratings and use that average for the prediction for all test set examples.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SimpleAverageModel</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;A very simple model that just uses the average of the ratings in the</span>
<span class="sd">    training set as the prediction for the test set.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    mean : float</span>
<span class="sd">        Average of the training set ratings</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Given a ratings dataframe X, compute the mean rating</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        X : pandas dataframe, shape = (n_ratings, &gt;=3)</span>
<span class="sd">            User, item, rating dataframe. Only the 3rd column is used.</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        self</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mean</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">))</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">mean</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="baseline-average-by-id-model">
<h3>Baseline - Average by ID Model<a class="headerlink" href="#baseline-average-by-id-model" title="Permalink to this headline">¶</a></h3>
<p>We can probably do a little better by using the user or item (movie) average. Here we’ll set up a baseline model class that allows you to pass either a list of userIds or movieIds as X. The prediction for a given ID will just be the average of ratings from that ID, or the overall average if that ID wasn’t seen in the training set.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">AverageByIdModel</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Simple model that predicts based on average ratings for a given Id</span>
<span class="sd">    (movieId or userId) from training data</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    id_column : string</span>
<span class="sd">        Name of id column (i.e. &#39;itemId&#39;, &#39;userId&#39;) to average by in</span>
<span class="sd">        dataframe that will be fitted to</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    averages_by_id : pandas Series, shape = [n_ids]</span>
<span class="sd">        Pandas series of rating averages by id</span>
<span class="sd">    overall_average : float</span>
<span class="sd">        Average rating over all training samples</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">id_column</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">id_column</span> <span class="o">=</span> <span class="n">id_column</span>

    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Fit training data.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        X : pandas dataframe, shape = (n_ratings, &gt;=3)</span>
<span class="sd">            User, item, rating dataframe. Columns beyond 3 are ignored</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        self : object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">rating_column</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="p">[[</span><span class="bp">self</span><span class="o">.</span><span class="n">id_column</span><span class="p">,</span> <span class="n">rating_column</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">X</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;rating&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">averages_by_id</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">X</span>
            <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)[</span><span class="s1">&#39;rating&#39;</span><span class="p">]</span>
            <span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;average_rating&#39;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">overall_average</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="s1">&#39;rating&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return rating predictions</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        X : pandas dataframe, shape = (n_ratings, &gt;=3)</span>
<span class="sd">            Array of n_ratings movieIds or userIds</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        y_pred : numpy array, shape = (n_ratings,)</span>
<span class="sd">            Array of n_samples rating predictions</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">rating_column</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="p">[[</span><span class="bp">self</span><span class="o">.</span><span class="n">id_column</span><span class="p">,</span> <span class="n">rating_column</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">X</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;rating&#39;</span><span class="p">]</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">averages_by_id</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;id&#39;</span><span class="p">)</span>
        <span class="n">X</span><span class="p">[</span><span class="s1">&#39;average_rating&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">overall_average</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">X</span><span class="p">[</span><span class="s1">&#39;average_rating&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="baseline-damped-baseline-with-user-movie-data">
<h3>Baseline - Damped Baseline with User + Movie Data<a class="headerlink" href="#baseline-damped-baseline-with-user-movie-data" title="Permalink to this headline">¶</a></h3>
<p>This baseline model takes into account the average ratings of both the user and the movie, as well as a damping factor that brings the baseline prediction closer to the overall mean. The damping factor has been shown empirically to improve the perfomance.</p>
<p>This model follows equation 2.1 from a <a class="reference external" href="http://files.grouplens.org/papers/FnT%20CF%20Recsys%20Survey.pdf">collaborative filtering paper</a> from <a class="reference external" href="https://grouplens.org/">GroupLens</a>, the same group that published the MovieLens data. This equation defines rhe baseline rating for user <span class="math notranslate nohighlight">\(u\)</span> and item <span class="math notranslate nohighlight">\(i\)</span> as</p>
<div class="math notranslate nohighlight">
\[b_{u,i} = \mu + b_u + b_i\]</div>
<p>where</p>
<div class="math notranslate nohighlight">
\[b_u = \frac{1}{|I_u| + \beta_u}\sum_{i \in I_u} (r_{u,i} - \mu)\]</div>
<p>and</p>
<div class="math notranslate nohighlight">
\[b_i = \frac{1}{|U_i| + \beta_i}\sum_{u \in U_i} (r_{u,i} - b_u - \mu).\]</div>
<p>(See equations 2.4 and 2.5). Here, <span class="math notranslate nohighlight">\(\beta_u\)</span> and <span class="math notranslate nohighlight">\(\beta_i\)</span> are damping factors, for which the paper reported 25 is a good number for this dataset. For now we’ll just leave these values equal (<span class="math notranslate nohighlight">\(\beta=\beta_u=\beta_i\)</span>). Here’s a summary of the meanings of all the variables here:</p>
<table class="colwidths-auto table">
<thead>
<tr class="row-odd"><th class="head"><p>Variable</p></th>
<th class="head"><p>Meaning</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><span class="math notranslate nohighlight">\(b_{u,i}\)</span></p></td>
<td><p>Baseline rating for user <span class="math notranslate nohighlight">\(u\)</span> on item (movie) <span class="math notranslate nohighlight">\(i\)</span></p></td>
</tr>
<tr class="row-odd"><td><p><span class="math notranslate nohighlight">\(\mu\)</span></p></td>
<td><p>The mean of all ratings</p></td>
</tr>
<tr class="row-even"><td><p><span class="math notranslate nohighlight">\(b_u\)</span></p></td>
<td><p>The deviation from <span class="math notranslate nohighlight">\(\mu\)</span> associated with user <span class="math notranslate nohighlight">\(u\)</span></p></td>
</tr>
<tr class="row-odd"><td><p><span class="math notranslate nohighlight">\(b_i\)</span></p></td>
<td><p>The deviation from <span class="math notranslate nohighlight">\(\mu+b_u\)</span> associated with user <span class="math notranslate nohighlight">\(i\)</span></p></td>
</tr>
<tr class="row-even"><td><p><span class="math notranslate nohighlight">\(I_u\)</span></p></td>
<td><p>The set of all items rated by user <span class="math notranslate nohighlight">\(u\)</span></p></td>
</tr>
<tr class="row-odd"><td><p><span class="math notranslate nohighlight">\(\mid I_u \mid\)</span></p></td>
<td><p>The number of items rated by user <span class="math notranslate nohighlight">\(u\)</span></p></td>
</tr>
<tr class="row-even"><td><p><span class="math notranslate nohighlight">\(\beta_u\)</span></p></td>
<td><p>Damping factor for the users (<span class="math notranslate nohighlight">\(=\beta\)</span>)</p></td>
</tr>
<tr class="row-odd"><td><p><span class="math notranslate nohighlight">\(r_{u,i}\)</span></p></td>
<td><p>Observed rating for user <span class="math notranslate nohighlight">\(u\)</span> on item <span class="math notranslate nohighlight">\(i\)</span></p></td>
</tr>
<tr class="row-even"><td><p><span class="math notranslate nohighlight">\(U_i\)</span></p></td>
<td><p>The set of all users who rated item <span class="math notranslate nohighlight">\(i\)</span></p></td>
</tr>
<tr class="row-odd"><td><p><span class="math notranslate nohighlight">\(\mid U_i \mid\)</span></p></td>
<td><p>The number of users who rated item <span class="math notranslate nohighlight">\(i\)</span></p></td>
</tr>
<tr class="row-even"><td><p><span class="math notranslate nohighlight">\(\beta_i\)</span></p></td>
<td><p>Damping factor for the items (<span class="math notranslate nohighlight">\(=\beta\)</span>)</p></td>
</tr>
</tbody>
</table>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">DampedUserMovieBaselineModel</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Baseline model that of the form mu + b_u + b_i,</span>
<span class="sd">    where mu is the overall average, b_u is a damped user</span>
<span class="sd">    average rating residual, and b_i is a damped item (movie)</span>
<span class="sd">    average rating residual. See eqn 2.1 of</span>
<span class="sd">    http://files.grouplens.org/papers/FnT%20CF%20Recsys%20Survey.pdf</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    damping_factor : float, default=0</span>
<span class="sd">        Factor to bring residuals closer to 0. Must be positive.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    mu : float</span>
<span class="sd">        Average rating over all training samples</span>
<span class="sd">    b_u : pandas Series, shape = [n_users]</span>
<span class="sd">        User residuals</span>
<span class="sd">    b_i : pandas Series, shape = [n_movies]</span>
<span class="sd">        Movie residuals</span>
<span class="sd">    damping_factor : float, default=0</span>
<span class="sd">        Factor to bring residuals closer to 0. Must be &gt;= 0.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">damping_factor</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">damping_factor</span> <span class="o">=</span> <span class="n">damping_factor</span>

    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Fit training data.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        X : DataFrame, shape = [n_samples, &gt;=3]</span>
<span class="sd">            User, movie, rating dataFrame. Columns beyond 3 are ignored</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        self : object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">X</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="s1">&#39;item&#39;</span><span class="p">,</span> <span class="s1">&#39;rating&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="s1">&#39;rating&#39;</span><span class="p">])</span>
        <span class="n">user_counts</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
        <span class="n">movie_counts</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="s1">&#39;item&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
        <span class="n">b_u</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">X</span><span class="p">[[</span><span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="s1">&#39;rating&#39;</span><span class="p">]]</span>
            <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;user&#39;</span><span class="p">)[</span><span class="s1">&#39;rating&#39;</span><span class="p">]</span>
            <span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">user_counts</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">mu</span><span class="p">)</span>
            <span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">user_counts</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">damping_factor</span><span class="p">)</span>
            <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;b_u&#39;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">b_u</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;user&#39;</span><span class="p">)</span>
        <span class="n">X</span><span class="p">[</span><span class="s1">&#39;item_residual&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="s1">&#39;rating&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">X</span><span class="p">[</span><span class="s1">&#39;b_u&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">mu</span>
        <span class="n">b_i</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">X</span><span class="p">[[</span><span class="s1">&#39;item&#39;</span><span class="p">,</span> <span class="s1">&#39;item_residual&#39;</span><span class="p">]]</span>
            <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;item&#39;</span><span class="p">)[</span><span class="s1">&#39;item_residual&#39;</span><span class="p">]</span>
            <span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">movie_counts</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">damping_factor</span><span class="p">)</span>
            <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;b_i&#39;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">b_u</span> <span class="o">=</span> <span class="n">b_u</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">b_i</span> <span class="o">=</span> <span class="n">b_i</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return rating predictions</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        X : DataFrame, shape = (n_ratings, 2)</span>
<span class="sd">            User, item dataframe</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        y_pred : numpy array, shape = (n_ratings,)</span>
<span class="sd">            Array of n_samples rating predictions</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">X</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="s1">&#39;item&#39;</span><span class="p">]</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">b_u</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;user&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">b_i</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;item&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mu</span> <span class="o">+</span> <span class="n">X</span><span class="p">[</span><span class="s1">&#39;b_u&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">X</span><span class="p">[</span><span class="s1">&#39;b_i&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">values</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_xval_errs_and_res</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">n_splits</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">rating_col</span><span class="o">=</span><span class="s1">&#39;rating&#39;</span><span class="p">):</span>
    <span class="n">kf</span> <span class="o">=</span> <span class="n">KFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="n">n_splits</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">errs</span><span class="p">,</span> <span class="n">stds</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="n">residuals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">train_inds</span><span class="p">,</span> <span class="n">test_inds</span> <span class="ow">in</span> <span class="n">kf</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
        <span class="n">train_df</span><span class="p">,</span> <span class="n">test_df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_inds</span><span class="p">],</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">test_inds</span><span class="p">]</span>
        <span class="n">pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_df</span><span class="p">)</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_df</span><span class="p">)</span>
        <span class="n">residuals</span><span class="p">[</span><span class="n">test_inds</span><span class="p">]</span> <span class="o">=</span> <span class="n">pred</span> <span class="o">-</span> <span class="n">test_df</span><span class="p">[</span><span class="n">rating_col</span><span class="p">]</span>
        <span class="n">mae</span> <span class="o">=</span> <span class="n">mean_absolute_error</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span class="n">test_df</span><span class="p">[</span><span class="n">rating_col</span><span class="p">])</span>
        <span class="n">errs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mae</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">errs</span><span class="p">,</span> <span class="n">residuals</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">errs_1</span><span class="p">,</span> <span class="n">res_1</span> <span class="o">=</span> <span class="n">get_xval_errs_and_res</span><span class="p">(</span><span class="n">ratings_df</span><span class="p">,</span> <span class="n">SimpleAverageModel</span><span class="p">())</span>
<span class="n">errs_2</span><span class="p">,</span> <span class="n">res_2</span> <span class="o">=</span> <span class="n">get_xval_errs_and_res</span><span class="p">(</span><span class="n">ratings_df</span><span class="p">,</span> <span class="n">AverageByIdModel</span><span class="p">(</span><span class="s1">&#39;item_id&#39;</span><span class="p">))</span>
<span class="n">errs_3</span><span class="p">,</span> <span class="n">res_3</span> <span class="o">=</span> <span class="n">get_xval_errs_and_res</span><span class="p">(</span><span class="n">ratings_df</span><span class="p">,</span> <span class="n">AverageByIdModel</span><span class="p">(</span><span class="s1">&#39;user_id&#39;</span><span class="p">))</span>
<span class="n">errs_4</span><span class="p">,</span> <span class="n">res_4</span> <span class="o">=</span> <span class="n">get_xval_errs_and_res</span><span class="p">(</span><span class="n">ratings_df</span><span class="p">,</span> <span class="n">DampedUserMovieBaselineModel</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
<span class="n">errs_5</span><span class="p">,</span> <span class="n">res_5</span> <span class="o">=</span> <span class="n">get_xval_errs_and_res</span><span class="p">(</span><span class="n">ratings_df</span><span class="p">,</span> <span class="n">DampedUserMovieBaselineModel</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
<span class="n">errs_6</span><span class="p">,</span> <span class="n">res_6</span> <span class="o">=</span> <span class="n">get_xval_errs_and_res</span><span class="p">(</span><span class="n">ratings_df</span><span class="p">,</span> <span class="n">DampedUserMovieBaselineModel</span><span class="p">(</span><span class="mi">25</span><span class="p">))</span>
<span class="n">errs_7</span><span class="p">,</span> <span class="n">res_7</span> <span class="o">=</span> <span class="n">get_xval_errs_and_res</span><span class="p">(</span><span class="n">ratings_df</span><span class="p">,</span> <span class="n">DampedUserMovieBaselineModel</span><span class="p">(</span><span class="mi">50</span><span class="p">))</span>
<span class="n">df_errs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
    <span class="n">OrderedDict</span><span class="p">(</span>
        <span class="p">(</span>
            <span class="p">(</span><span class="s1">&#39;Average&#39;</span><span class="p">,</span> <span class="n">errs_1</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;Item Average&#39;</span><span class="p">,</span> <span class="n">errs_2</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;User Average&#39;</span><span class="p">,</span> <span class="n">errs_3</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;Combined 0&#39;</span><span class="p">,</span> <span class="n">errs_4</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;Combined 10&#39;</span><span class="p">,</span> <span class="n">errs_5</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;Combined 25&#39;</span><span class="p">,</span> <span class="n">errs_6</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;Combined 50&#39;</span><span class="p">,</span> <span class="n">errs_7</span><span class="p">),</span>
        <span class="p">)</span>
    <span class="p">)</span>
<span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">df_errs</span><span class="p">)</span>
<span class="n">df_errs</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span><span class="n">df_errs</span><span class="p">,</span> <span class="n">value_vars</span><span class="o">=</span><span class="n">df_errs</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
    <span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s1">&#39;variable&#39;</span><span class="p">:</span> <span class="s1">&#39;Baseline Model&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="s1">&#39;MAE&#39;</span><span class="p">},</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">df_res</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
    <span class="n">OrderedDict</span><span class="p">(</span>
        <span class="p">(</span>
            <span class="p">(</span><span class="s1">&#39;Average&#39;</span><span class="p">,</span> <span class="n">res_1</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;Item Average&#39;</span><span class="p">,</span> <span class="n">res_2</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;User Average&#39;</span><span class="p">,</span> <span class="n">res_3</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;Combined 0&#39;</span><span class="p">,</span> <span class="n">res_4</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;Combined 10&#39;</span><span class="p">,</span> <span class="n">res_5</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;Combined 25&#39;</span><span class="p">,</span> <span class="n">res_6</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;Combined 50&#39;</span><span class="p">,</span> <span class="n">res_7</span><span class="p">),</span>
        <span class="p">)</span>
    <span class="p">)</span>
<span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">df_res</span><span class="o">.</span><span class="n">tail</span><span class="p">())</span>
<span class="n">df_res</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span><span class="n">df_res</span><span class="p">,</span> <span class="n">value_vars</span><span class="o">=</span><span class="n">df_res</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
    <span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s1">&#39;variable&#39;</span><span class="p">:</span> <span class="s1">&#39;Baseline Model&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="s1">&#39;Residual&#39;</span><span class="p">},</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Average</th>
      <th>Item Average</th>
      <th>User Average</th>
      <th>Combined 0</th>
      <th>Combined 10</th>
      <th>Combined 25</th>
      <th>Combined 50</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0.944496</td>
      <td>0.820464</td>
      <td>0.832909</td>
      <td>0.757803</td>
      <td>0.758147</td>
      <td>0.765638</td>
      <td>0.777938</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0.943006</td>
      <td>0.816231</td>
      <td>0.834758</td>
      <td>0.755370</td>
      <td>0.755676</td>
      <td>0.763692</td>
      <td>0.776640</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0.942342</td>
      <td>0.811768</td>
      <td>0.831787</td>
      <td>0.755215</td>
      <td>0.753132</td>
      <td>0.760062</td>
      <td>0.772539</td>
    </tr>
    <tr>
      <th>3</th>
      <td>0.943253</td>
      <td>0.812634</td>
      <td>0.835116</td>
      <td>0.753721</td>
      <td>0.753945</td>
      <td>0.761041</td>
      <td>0.773358</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0.950450</td>
      <td>0.825487</td>
      <td>0.840364</td>
      <td>0.766959</td>
      <td>0.766122</td>
      <td>0.772491</td>
      <td>0.784196</td>
    </tr>
  </tbody>
</table>
</div></div><div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Average</th>
      <th>Item Average</th>
      <th>User Average</th>
      <th>Combined 0</th>
      <th>Combined 10</th>
      <th>Combined 25</th>
      <th>Combined 50</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>99995</th>
      <td>0.528338</td>
      <td>0.055556</td>
      <td>0.416393</td>
      <td>-0.059372</td>
      <td>-0.018547</td>
      <td>0.032939</td>
      <td>0.098535</td>
    </tr>
    <tr>
      <th>99996</th>
      <td>-1.471550</td>
      <td>-1.192727</td>
      <td>-1.127273</td>
      <td>-0.924999</td>
      <td>-0.935268</td>
      <td>-0.954491</td>
      <td>-0.988486</td>
    </tr>
    <tr>
      <th>99997</th>
      <td>2.528450</td>
      <td>1.600000</td>
      <td>2.455206</td>
      <td>1.609478</td>
      <td>1.824161</td>
      <td>1.999824</td>
      <td>2.147012</td>
    </tr>
    <tr>
      <th>99998</th>
      <td>1.532850</td>
      <td>0.925532</td>
      <td>1.114398</td>
      <td>0.601937</td>
      <td>0.652301</td>
      <td>0.715920</td>
      <td>0.799292</td>
    </tr>
    <tr>
      <th>99999</th>
      <td>0.528338</td>
      <td>0.872340</td>
      <td>1.487805</td>
      <td>1.798718</td>
      <td>1.595426</td>
      <td>1.398599</td>
      <td>1.203773</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax0</span><span class="p">,</span> <span class="n">ax1</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">swarmplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">df_errs</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;Baseline Model&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;MAE&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax0</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">violinplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">df_res</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;Baseline Model&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;Residual&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax1</span><span class="p">)</span>
<span class="n">ax0</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/T990000_movielens_eda_modeling_41_0.png" src="../_images/T990000_movielens_eda_modeling_41_0.png" />
</div>
</div>
<p>The MAE plots above show that the combined model with a damping factor of 0 or 10 performs the best, followed by the item average, then the user average. It makes sense that taking into account deviations from the mean due to both user and item would perform the best: there is simply more data being taken into account for each baseline prediction. The same idea explains why the item average performs better than the user average: there are more items than users in this dataset, so averaging over items takes into account more data per baseline prediction than averaging over users. The residual plots underneath the MAE plot illustrate that taking into account more data pulls the density of the residuals closer to 0.</p>
<p><strong>Selecting the baseline</strong>: Both the Combined 0 and Combined 10 models performed equally, but we’ll choose the Combined 10 model, because a higher damping factor is effectively stronger regularization, which will prevent overfitting better than a damping factor of 0.</p>
</div>
</div>
<div class="section" id="knn-collaborative-filtering">
<h2>KNN Collaborative Filtering<a class="headerlink" href="#knn-collaborative-filtering" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># &lt;!-- collapse=True --&gt;</span>
<span class="k">class</span> <span class="nc">KNNRecommender</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;User-based or Item-based collaborative filtering model that operates on</span>
<span class="sd">    dataframes with at least a user-like, item-like, and a rating-like column</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    mode : str, [&#39;item | &#39;user&#39;], default=&#39;item&#39;</span>
<span class="sd">        Tells model whether to use item-based or user-based collaborative filtering</span>
<span class="sd">    k : int, default=20</span>
<span class="sd">        Number of most similar items or users to average for prediction</span>
<span class="sd">    basline_algo : object, optional</span>
<span class="sd">        Algorithm used to predict baseline scores for each rating. If not provided,</span>
<span class="sd">        the mean of all training ratings is used as the baseline. If provided,</span>
<span class="sd">        the object must have a fit(X) method and a predict(X) method</span>
<span class="sd">    similarity_func : function, default=cosine_similarity</span>
<span class="sd">        Function must take a numpy array M of shape (m,n) and return a numpy array</span>
<span class="sd">        of shape (m,m) where each element i,j represents the similarity between row</span>
<span class="sd">        i and row j of M.</span>
<span class="sd">    loop_predict : boolean, default=True</span>
<span class="sd">        If True, the model will loop over all user-item pairs in test set and compute</span>
<span class="sd">        prediction individually. If False, the model will compute all ratings</span>
<span class="sd">        simultaneously. With sparse matrices, looping is typically faster.</span>
<span class="sd">        </span>
<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    train_mean : float</span>
<span class="sd">        Mean of the training data ratings. Used if baseline_algo is None.</span>
<span class="sd">    rating_matrix : 2d numpy array, shape=(n_users, n_items)</span>
<span class="sd">        Rating matrix minus baselines</span>
<span class="sd">    user_map : pandas Series, shape=(n_users,)</span>
<span class="sd">        Mapping from the original user id to an integer in the range [0,n_users)</span>
<span class="sd">    item_map : pandas Series, shape=(n_items,)</span>
<span class="sd">        Mapping from the original item id to an integer in the range [0,n_items)</span>
<span class="sd">    knn_indices : 2d numpy array, shape=([n_users|n_items], k)</span>
<span class="sd">        Element i,j represents the index of the jth closet [user|item] to i</span>
<span class="sd">    knn_similarities : 2d numpy array, shape=([n_users|n_items], k)</span>
<span class="sd">        Element i,j represents the similarity between the jth closest [user|item] to i</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;item&#39;</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">baseline_algo</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">similarity_func</span><span class="o">=</span><span class="n">cosine_similarity</span><span class="p">,</span> <span class="n">loop_predict</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">mode</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="s1">&#39;item&#39;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;&#39;mode&#39; must be either &#39;user&#39; or &#39;item&#39;, not &#39;</span><span class="si">{}</span><span class="s2">&#39;!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mode</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k</span> <span class="o">=</span> <span class="n">k</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">baseline_algo</span> <span class="o">=</span> <span class="n">baseline_algo</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">similarity_func</span> <span class="o">=</span> <span class="n">similarity_func</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loop_predict</span> <span class="o">=</span> <span class="n">loop_predict</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">train_mean</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rating_matrix</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_map</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">item_map</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">knn_indices</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">knn_similarities</span> <span class="o">=</span> <span class="kc">None</span>
        
    <span class="k">def</span> <span class="nf">_get_rating_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Private function to generate a ratings matrx and mappings for</span>
<span class="sd">        the user and item ids to the row and column indices</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        X : pandas.DataFrame, shape=(n_ratings,&gt;=3)</span>
<span class="sd">            First 3 columns must be in order of user, item, rating.</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        rating_matrix : 2d numpy array, shape=(n_users, n_items)</span>
<span class="sd">        user_map : pandas Series, shape=(n_users,)</span>
<span class="sd">            Mapping from the original user id to an integer in the range [0,n_users)</span>
<span class="sd">        item_map : pandas Series, shape=(n_items,)</span>
<span class="sd">            Mapping from the original item id to an integer in the range [0,n_items)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">user_col</span><span class="p">,</span> <span class="n">item_col</span><span class="p">,</span> <span class="n">rating_col</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">rating</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">rating_col</span><span class="p">]</span>
        <span class="n">user_map</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span>
            <span class="n">index</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">user_col</span><span class="p">]),</span>
            <span class="n">data</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">user_col</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()),</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;user_map&#39;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">item_map</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span>
            <span class="n">index</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">item_col</span><span class="p">]),</span>
            <span class="n">data</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">item_col</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()),</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;columns_map&#39;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">user_inds</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">user_col</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">user_map</span><span class="p">)</span>
        <span class="n">item_inds</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">item_col</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">item_map</span><span class="p">)</span>
        <span class="n">rating_matrix</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">pd</span><span class="o">.</span><span class="n">pivot_table</span><span class="p">(</span>
                <span class="n">data</span><span class="o">=</span><span class="n">X</span><span class="p">,</span>
                <span class="n">values</span><span class="o">=</span><span class="n">rating_col</span><span class="p">,</span>
                <span class="n">index</span><span class="o">=</span><span class="n">user_inds</span><span class="p">,</span>
                <span class="n">columns</span><span class="o">=</span><span class="n">item_inds</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="o">.</span><span class="n">values</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">rating_matrix</span><span class="p">,</span> <span class="n">user_map</span><span class="p">,</span> <span class="n">item_map</span>

    <span class="k">def</span> <span class="nf">_get_knn_indices_and_similarities</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rating_matrix</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Private function to find indices and similarities of k nearest</span>
<span class="sd">        neighbors for each user or item</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        rating_matrix : 2d numpy array, shape=(n_users, n_items)</span>
<span class="sd">            Matrix of ratings minus baselines</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        knn_indices : 2d numpy array, shape=([n_users|n_items], k)</span>
<span class="sd">            Element i,j represents the index of the jth closet [user|item] to i</span>
<span class="sd">        knn_similarities : 2d numpy array, shape=([n_users|n_items], k)</span>
<span class="sd">            Element i,j represents the similarity between the jth closest [user|item] to i</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;item&#39;</span><span class="p">:</span>
            <span class="n">n_users_or_items</span> <span class="o">=</span> <span class="n">rating_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">n_users_or_items</span> <span class="o">=</span> <span class="n">rating_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">k</span> <span class="o">&gt;</span> <span class="n">n_users_or_items</span><span class="p">:</span>
            <span class="n">new_k</span> <span class="o">=</span> <span class="n">n_users_or_items</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;Warning: k = </span><span class="si">{}</span><span class="s2"> &gt; # </span><span class="si">{}</span><span class="s2">s = </span><span class="si">{}</span><span class="s2">! Setting k to </span><span class="si">{}</span><span class="s2">&quot;</span>
                <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">,</span> <span class="n">n_users_or_items</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="p">,</span> <span class="n">new_k</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">k</span> <span class="o">=</span> <span class="n">new_k</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;item&#39;</span><span class="p">:</span>
            <span class="n">similarity_matrix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">similarity_func</span><span class="p">(</span><span class="n">rating_matrix</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">similarity_matrix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">similarity_func</span><span class="p">(</span><span class="n">rating_matrix</span><span class="p">)</span>
        <span class="n">np</span><span class="o">.</span><span class="n">fill_diagonal</span><span class="p">(</span><span class="n">similarity_matrix</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">knn_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">similarity_matrix</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)[:,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">][:,</span> <span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">]</span>
        <span class="c1"># https://github.com/scikit-learn/scikit-learn/blob/a24c8b46/sklearn/neighbors/base.py#L373</span>
        <span class="n">sample_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">knn_indices</span><span class="p">))[:,</span> <span class="kc">None</span><span class="p">]</span>
        <span class="n">knn_similarities</span> <span class="o">=</span> <span class="n">similarity_matrix</span><span class="p">[</span><span class="n">sample_range</span><span class="p">,</span> <span class="n">knn_indices</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">knn_indices</span><span class="p">,</span> <span class="n">knn_similarities</span>
    
    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Fit model to training data X. Sets the knn_indices, knn_similarities, </span>
<span class="sd">        rating_matrix, user_map, and item map variables.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        X : pandas DataFrame, shape=(n_ratings, &gt;=3)</span>
<span class="sd">            First 3 columns must correspond to user, item, and rating in that order</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        self</span>
<span class="sd">            This allows chaining like `KNNRecommender().fit(X_train).predict(X_test)`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;X must be a DataFrame&quot;</span><span class="p">)</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">user_col</span><span class="p">,</span> <span class="n">item_col</span><span class="p">,</span> <span class="n">rating_col</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">baseline_algo</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">train_mean</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">rating_col</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="n">X</span><span class="p">[</span><span class="s1">&#39;rating_baseline&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_mean</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">baseline_algo</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">3</span><span class="p">])</span>
            <span class="n">X</span><span class="p">[</span><span class="s1">&#39;rating_baseline&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">baseline_algo</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">[[</span><span class="n">user_col</span><span class="p">,</span> <span class="n">item_col</span><span class="p">]])</span>
        <span class="n">X</span><span class="p">[</span><span class="s1">&#39;rating_diff&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">rating_col</span><span class="p">]</span> <span class="o">-</span> <span class="n">X</span><span class="p">[</span><span class="s1">&#39;rating_baseline&#39;</span><span class="p">]</span>
        <span class="n">nodiff_rating_matrix</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_rating_matrix</span><span class="p">(</span><span class="n">X</span><span class="p">[[</span><span class="n">user_col</span><span class="p">,</span> <span class="n">item_col</span><span class="p">,</span> <span class="n">rating_col</span><span class="p">]])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">knn_indices</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">knn_similarities</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_knn_indices_and_similarities</span><span class="p">(</span>
            <span class="n">nodiff_rating_matrix</span>
        <span class="p">)</span>
        <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rating_matrix</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_map</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_map</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_rating_matrix</span><span class="p">(</span>
            <span class="n">X</span><span class="p">[[</span><span class="n">user_col</span><span class="p">,</span> <span class="n">item_col</span><span class="p">,</span> <span class="s1">&#39;rating_diff&#39;</span><span class="p">]]</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">_predict_1_ui_pair</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Predict rating (minus baseline) for 1 user-item pair. Must add</span>
<span class="sd">        baseline to get the rating in the original rating scale.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        user : int</span>
<span class="sd">            Must be in range [0, n_users)</span>
<span class="sd">        item : int</span>
<span class="sd">            Must be in range [0, n_items)</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        rating_pred : float</span>
<span class="sd">            Predicted ratings</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;item&#39;</span><span class="p">:</span>
            <span class="n">inds_i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">knn_indices</span><span class="p">[</span><span class="n">item</span><span class="p">,</span> <span class="p">:]</span>
            <span class="n">sims_i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">knn_similarities</span><span class="p">[</span><span class="n">item</span><span class="p">,</span> <span class="p">:]</span>
            <span class="c1"># https://stackoverflow.com/a/35696047/2680824</span>
            <span class="n">numerator</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rating_matrix</span><span class="p">[</span><span class="n">user</span><span class="p">,</span> <span class="n">inds_i</span><span class="p">]</span> <span class="o">*</span> <span class="n">sims_i</span><span class="p">)</span>
            <span class="n">denominator</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">sims_i</span><span class="p">))</span>
            <span class="k">with</span> <span class="n">np</span><span class="o">.</span><span class="n">errstate</span><span class="p">(</span><span class="n">divide</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">invalid</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">):</span>
                <span class="n">rating_pred</span> <span class="o">=</span> <span class="n">numerator</span> <span class="o">/</span> <span class="n">denominator</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">inds_u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">knn_indices</span><span class="p">[</span><span class="n">user</span><span class="p">,</span> <span class="p">:]</span>
            <span class="n">sims_u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">knn_similarities</span><span class="p">[</span><span class="n">user</span><span class="p">,</span> <span class="p">:]</span>
            <span class="c1"># https://stackoverflow.com/a/35696047/2680824</span>
            <span class="n">numerator</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rating_matrix</span><span class="p">[</span><span class="n">inds_u</span><span class="p">,</span> <span class="n">item</span><span class="p">]</span> <span class="o">*</span> <span class="n">sims_u</span><span class="p">)</span>
            <span class="n">denominator</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">sims_u</span><span class="p">))</span>
            <span class="k">with</span> <span class="n">np</span><span class="o">.</span><span class="n">errstate</span><span class="p">(</span><span class="n">divide</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">invalid</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">):</span>
                <span class="n">rating_pred</span> <span class="o">=</span> <span class="n">numerator</span> <span class="o">/</span> <span class="n">denominator</span>
        <span class="k">return</span> <span class="n">rating_pred</span>

    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Predict ratings for each user-item pair in X</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        X : pandas DataFrame, shape=(n_ratings, &gt;=2)</span>
<span class="sd">            First 2 columns of X must correspond to user and item.</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pandas Series, shape=(n_ratings,)</span>
<span class="sd">            Ratings for each user-item pair in X. No restriction on the data type</span>
<span class="sd">            for the user and item ids, other than they must match the training indices.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;X must be a DataFrame&quot;</span><span class="p">)</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">user_col</span><span class="p">,</span> <span class="n">item_col</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">baseline_algo</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">X</span><span class="p">[</span><span class="s1">&#39;rating_baseline&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_mean</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">X</span><span class="p">[</span><span class="s1">&#39;rating_baseline&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">baseline_algo</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="n">X</span><span class="p">[</span><span class="s1">&#39;rating&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">known_user_and_item_mask</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">X</span><span class="p">[</span><span class="n">user_col</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_map</span><span class="o">.</span><span class="n">index</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">X</span><span class="p">[</span><span class="n">item_col</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">item_map</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">X_known</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">known_user_and_item_mask</span><span class="p">]</span>
        <span class="n">user_inds</span> <span class="o">=</span> <span class="n">X_known</span><span class="p">[</span><span class="n">user_col</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_map</span><span class="p">)</span>
        <span class="n">item_inds</span> <span class="o">=</span> <span class="n">X_known</span><span class="p">[</span><span class="n">item_col</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">item_map</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">loop_predict</span><span class="p">:</span>
            <span class="n">rating_pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_predict_1_ui_pair</span><span class="p">(</span><span class="n">u_ind</span><span class="p">,</span> <span class="n">i_ind</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">u_ind</span><span class="p">,</span> <span class="n">i_ind</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">user_inds</span><span class="p">,</span> <span class="n">item_inds</span><span class="p">)</span>
            <span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">stacked_ratings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rating_matrix</span><span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">knn_indices</span><span class="p">[:,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">],</span>
                <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rating_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
            <span class="p">]</span>
            <span class="n">numerator_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
                <span class="n">stacked_ratings</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">knn_similarities</span><span class="p">[:,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">],</span>
                <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
            <span class="p">)</span>
            <span class="n">denominator_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
                <span class="p">(</span><span class="n">stacked_ratings</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">knn_similarities</span><span class="p">[:,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">],</span>
                <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
            <span class="p">)</span>
            <span class="c1"># https://stackoverflow.com/a/35696047/2680824</span>
            <span class="k">with</span> <span class="n">np</span><span class="o">.</span><span class="n">errstate</span><span class="p">(</span><span class="n">divide</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">invalid</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">):</span>
                <span class="n">rating_pred_matrix</span> <span class="o">=</span> <span class="n">numerator_matrix</span> <span class="o">/</span> <span class="n">denominator_matrix</span>
            <span class="n">rating_pred</span> <span class="o">=</span> <span class="n">rating_pred_matrix</span><span class="p">[</span><span class="n">user_inds</span><span class="p">,</span> <span class="n">item_inds</span><span class="p">]</span>
        <span class="n">rating_pred</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">rating_pred</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">X</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">known_user_and_item_mask</span><span class="p">,</span> <span class="s1">&#39;rating&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rating_pred</span>
        <span class="k">return</span> <span class="n">X</span><span class="p">[</span><span class="s1">&#39;rating&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">X</span><span class="p">[</span><span class="s1">&#39;rating_baseline&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>Determine Optimal  k  Values</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">cart_prod</span><span class="p">(</span><span class="n">df_1</span><span class="p">,</span> <span class="n">df_2</span><span class="p">):</span>
    <span class="n">df_1</span><span class="p">[</span><span class="s1">&#39;_dummy_&#39;</span><span class="p">],</span> <span class="n">df_2</span><span class="p">[</span><span class="s1">&#39;_dummy_&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df_1</span><span class="p">,</span> <span class="n">df_2</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;_dummy_&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;_dummy_&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">n_splits</span> <span class="o">=</span> <span class="mi">5</span>

<span class="n">k_list</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">200</span><span class="p">]</span>
<span class="n">mode_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="s1">&#39;item&#39;</span><span class="p">]</span>
<span class="n">i_fold_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_splits</span><span class="p">)</span>
<span class="n">df_1</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;k&#39;</span><span class="p">:</span> <span class="n">k_list</span><span class="p">})</span>
<span class="n">df_2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;mode&#39;</span><span class="p">:</span> <span class="n">mode_list</span><span class="p">})</span>
<span class="n">df_3</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;i_fold&#39;</span><span class="p">:</span> <span class="n">i_fold_list</span><span class="p">})</span>
<span class="n">results_df</span> <span class="o">=</span> <span class="n">reduce</span><span class="p">(</span><span class="n">cart_prod</span><span class="p">,</span> <span class="p">[</span><span class="n">df_1</span><span class="p">,</span> <span class="n">df_2</span><span class="p">,</span> <span class="n">df_3</span><span class="p">])</span>
<span class="n">results_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>k</th>
      <th>mode</th>
      <th>i_fold</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>user</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>user</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1</td>
      <td>user</td>
      <td>2</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1</td>
      <td>user</td>
      <td>3</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1</td>
      <td>user</td>
      <td>4</td>
    </tr>
    <tr>
      <th>5</th>
      <td>1</td>
      <td>item</td>
      <td>0</td>
    </tr>
    <tr>
      <th>6</th>
      <td>1</td>
      <td>item</td>
      <td>1</td>
    </tr>
    <tr>
      <th>7</th>
      <td>1</td>
      <td>item</td>
      <td>2</td>
    </tr>
    <tr>
      <th>8</th>
      <td>1</td>
      <td>item</td>
      <td>3</td>
    </tr>
    <tr>
      <th>9</th>
      <td>1</td>
      <td>item</td>
      <td>4</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kf</span> <span class="o">=</span> <span class="n">KFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="n">n_splits</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">mode</span><span class="p">),</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">results_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="s1">&#39;mode&#39;</span><span class="p">]):</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">row</span><span class="p">),</span> <span class="p">(</span><span class="n">train_inds</span><span class="p">,</span> <span class="n">test_inds</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">group</span><span class="o">.</span><span class="n">iterrows</span><span class="p">(),</span> <span class="n">kf</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">ratings_df</span><span class="p">)):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;k=</span><span class="si">{}</span><span class="s2">, mode=</span><span class="si">{}</span><span class="s2">: i_fold= &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">]),</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">, &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;i_fold&#39;</span><span class="p">]),</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">train_df</span><span class="p">,</span> <span class="n">test_df</span> <span class="o">=</span> <span class="n">ratings_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_inds</span><span class="p">],</span> <span class="n">ratings_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">test_inds</span><span class="p">]</span>
        <span class="n">baseline_algo</span> <span class="o">=</span> <span class="n">DampedUserMovieBaselineModel</span><span class="p">(</span><span class="n">damping_factor</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">t1</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">rec</span> <span class="o">=</span> <span class="n">KNNRecommender</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">],</span> <span class="n">k</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">],</span> <span class="n">baseline_algo</span><span class="o">=</span><span class="n">baseline_algo</span><span class="p">)</span>
        <span class="n">rec</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_df</span><span class="p">)</span>
        <span class="n">preds</span> <span class="o">=</span> <span class="n">rec</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_df</span><span class="p">[[</span><span class="s1">&#39;user_id&#39;</span><span class="p">,</span> <span class="s1">&#39;item_id&#39;</span><span class="p">]])</span>
        <span class="n">mae</span> <span class="o">=</span> <span class="n">mean_absolute_error</span><span class="p">(</span><span class="n">preds</span><span class="p">,</span> <span class="n">test_df</span><span class="p">[</span><span class="s1">&#39;rating&#39;</span><span class="p">])</span>
        <span class="n">results_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="s1">&#39;MAE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mae</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">t1</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{:5.3f}</span><span class="s2">   dt=</span><span class="si">{:.2f}</span><span class="s2"> seconds&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mae</span><span class="p">,</span> <span class="n">dt</span><span class="p">))</span>
        <span class="n">results_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dt</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>k=1, mode=item: i_fold= 0, 0.813   dt=1.12 seconds
k=1, mode=item: i_fold= 1, 0.810   dt=1.07 seconds
k=1, mode=item: i_fold= 2, 0.803   dt=1.04 seconds
k=1, mode=item: i_fold= 3, 0.810   dt=1.08 seconds
k=1, mode=item: i_fold= 4, 0.807   dt=1.08 seconds
k=1, mode=user: i_fold= 0, 0.828   dt=0.92 seconds
k=1, mode=user: i_fold= 1, 0.829   dt=0.94 seconds
k=1, mode=user: i_fold= 2, 0.829   dt=0.93 seconds
k=1, mode=user: i_fold= 3, 0.833   dt=0.94 seconds
k=1, mode=user: i_fold= 4, 0.833   dt=0.94 seconds
k=2, mode=item: i_fold= 0, 0.765   dt=1.06 seconds
k=2, mode=item: i_fold= 1, 0.764   dt=1.08 seconds
k=2, mode=item: i_fold= 2, 0.757   dt=1.06 seconds
k=2, mode=item: i_fold= 3, 0.760   dt=1.09 seconds
k=2, mode=item: i_fold= 4, 0.765   dt=1.07 seconds
k=2, mode=user: i_fold= 0, 0.785   dt=0.93 seconds
k=2, mode=user: i_fold= 1, 0.785   dt=0.93 seconds
k=2, mode=user: i_fold= 2, 0.781   dt=0.98 seconds
k=2, mode=user: i_fold= 3, 0.786   dt=0.94 seconds
k=2, mode=user: i_fold= 4, 0.799   dt=0.96 seconds
k=5, mode=item: i_fold= 0, 0.734   dt=1.11 seconds
k=5, mode=item: i_fold= 1, 0.731   dt=1.08 seconds
k=5, mode=item: i_fold= 2, 0.731   dt=1.04 seconds
k=5, mode=item: i_fold= 3, 0.730   dt=1.07 seconds
k=5, mode=item: i_fold= 4, 0.739   dt=1.06 seconds
k=5, mode=user: i_fold= 0, 0.755   dt=0.93 seconds
k=5, mode=user: i_fold= 1, 0.754   dt=0.99 seconds
k=5, mode=user: i_fold= 2, 0.750   dt=0.96 seconds
k=5, mode=user: i_fold= 3, 0.755   dt=0.93 seconds
k=5, mode=user: i_fold= 4, 0.766   dt=0.94 seconds
k=10, mode=item: i_fold= 0, 0.728   dt=1.07 seconds
k=10, mode=item: i_fold= 1, 0.724   dt=1.08 seconds
k=10, mode=item: i_fold= 2, 0.725   dt=1.05 seconds
k=10, mode=item: i_fold= 3, 0.724   dt=1.06 seconds
k=10, mode=item: i_fold= 4, 0.734   dt=1.07 seconds
k=10, mode=user: i_fold= 0, 0.746   dt=0.94 seconds
k=10, mode=user: i_fold= 1, 0.744   dt=0.94 seconds
k=10, mode=user: i_fold= 2, 0.741   dt=0.94 seconds
k=10, mode=user: i_fold= 3, 0.744   dt=0.95 seconds
k=10, mode=user: i_fold= 4, 0.756   dt=0.94 seconds
k=20, mode=item: i_fold= 0, 0.730   dt=1.07 seconds
k=20, mode=item: i_fold= 1, 0.724   dt=1.09 seconds
k=20, mode=item: i_fold= 2, 0.725   dt=1.06 seconds
k=20, mode=item: i_fold= 3, 0.725   dt=1.08 seconds
k=20, mode=item: i_fold= 4, 0.736   dt=1.08 seconds
k=20, mode=user: i_fold= 0, 0.744   dt=0.93 seconds
k=20, mode=user: i_fold= 1, 0.742   dt=0.99 seconds
k=20, mode=user: i_fold= 2, 0.738   dt=0.93 seconds
k=20, mode=user: i_fold= 3, 0.741   dt=0.97 seconds
k=20, mode=user: i_fold= 4, 0.752   dt=0.99 seconds
k=50, mode=item: i_fold= 0, 0.734   dt=1.10 seconds
k=50, mode=item: i_fold= 1, 0.730   dt=1.09 seconds
k=50, mode=item: i_fold= 2, 0.729   dt=1.08 seconds
k=50, mode=item: i_fold= 3, 0.730   dt=1.11 seconds
k=50, mode=item: i_fold= 4, 0.741   dt=1.10 seconds
k=50, mode=user: i_fold= 0, 0.744   dt=0.95 seconds
k=50, mode=user: i_fold= 1, 0.742   dt=0.98 seconds
k=50, mode=user: i_fold= 2, 0.739   dt=0.96 seconds
k=50, mode=user: i_fold= 3, 0.740   dt=0.97 seconds
k=50, mode=user: i_fold= 4, 0.753   dt=0.99 seconds
k=100, mode=item: i_fold= 0, 0.739   dt=1.12 seconds
k=100, mode=item: i_fold= 1, 0.736   dt=1.16 seconds
k=100, mode=item: i_fold= 2, 0.734   dt=1.16 seconds
k=100, mode=item: i_fold= 3, 0.735   dt=1.15 seconds
k=100, mode=item: i_fold= 4, 0.746   dt=1.13 seconds
k=100, mode=user: i_fold= 0, 0.747   dt=1.01 seconds
k=100, mode=user: i_fold= 1, 0.745   dt=0.98 seconds
k=100, mode=user: i_fold= 2, 0.742   dt=0.99 seconds
k=100, mode=user: i_fold= 3, 0.743   dt=0.99 seconds
k=100, mode=user: i_fold= 4, 0.755   dt=0.99 seconds
k=200, mode=item: i_fold= 0, 0.745   dt=1.18 seconds
k=200, mode=item: i_fold= 1, 0.742   dt=1.19 seconds
k=200, mode=item: i_fold= 2, 0.739   dt=1.17 seconds
k=200, mode=item: i_fold= 3, 0.740   dt=1.17 seconds
k=200, mode=item: i_fold= 4, 0.752   dt=1.19 seconds
k=200, mode=user: i_fold= 0, 0.751   dt=1.01 seconds
k=200, mode=user: i_fold= 1, 0.748   dt=1.04 seconds
k=200, mode=user: i_fold= 2, 0.746   dt=0.99 seconds
k=200, mode=user: i_fold= 3, 0.746   dt=1.03 seconds
k=200, mode=user: i_fold= 4, 0.759   dt=1.00 seconds
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">baseline_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;i_fold&#39;</span><span class="p">:</span> <span class="n">i_fold_list</span><span class="p">})</span>

<span class="k">for</span> <span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">row</span><span class="p">),</span> <span class="p">(</span><span class="n">train_inds</span><span class="p">,</span> <span class="n">test_inds</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">baseline_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">(),</span> <span class="n">kf</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">ratings_df</span><span class="p">)):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;i_fold=</span><span class="si">{}</span><span class="s2">: MAE=&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;i_fold&#39;</span><span class="p">]),</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">train_df</span><span class="p">,</span> <span class="n">test_df</span> <span class="o">=</span> <span class="n">ratings_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_inds</span><span class="p">],</span> <span class="n">ratings_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">test_inds</span><span class="p">]</span>
    <span class="n">baseline_algo</span> <span class="o">=</span> <span class="n">DampedUserMovieBaselineModel</span><span class="p">(</span><span class="n">damping_factor</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">baseline_algo</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_df</span><span class="p">)</span>
    <span class="n">preds</span> <span class="o">=</span> <span class="n">baseline_algo</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_df</span><span class="p">[[</span><span class="s1">&#39;user_id&#39;</span><span class="p">,</span> <span class="s1">&#39;item_id&#39;</span><span class="p">]])</span>
    <span class="n">mae</span> <span class="o">=</span> <span class="n">mean_absolute_error</span><span class="p">(</span><span class="n">preds</span><span class="p">,</span> <span class="n">test_df</span><span class="p">[</span><span class="s1">&#39;rating&#39;</span><span class="p">])</span>
    <span class="n">baseline_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="s1">&#39;MAE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mae</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{:5.3f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mae</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>i_fold=0: MAE=0.758
i_fold=1: MAE=0.756
i_fold=2: MAE=0.753
i_fold=3: MAE=0.754
i_fold=4: MAE=0.766
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">base_avg</span> <span class="o">=</span> <span class="n">baseline_df</span><span class="p">[</span><span class="s1">&#39;MAE&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">base_std</span> <span class="o">=</span> <span class="n">baseline_df</span><span class="p">[</span><span class="s1">&#39;MAE&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
<span class="n">sns</span><span class="o">.</span><span class="n">pointplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">results_df</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;mode&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;MAE&#39;</span><span class="p">)</span>
<span class="n">nk</span> <span class="o">=</span> <span class="n">results_df</span><span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">nk</span><span class="p">],</span> <span class="p">[</span><span class="n">base_avg</span><span class="p">,</span> <span class="n">base_avg</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;baseline&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;C2&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">nk</span><span class="p">],</span> <span class="p">[</span><span class="n">base_avg</span> <span class="o">-</span> <span class="n">base_std</span><span class="p">]</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="p">[</span><span class="n">base_avg</span><span class="o">+</span><span class="n">base_std</span><span class="p">]</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;C2&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/T990000_movielens_eda_modeling_49_0.png" src="../_images/T990000_movielens_eda_modeling_49_0.png" />
</div>
</div>
</div>
<div class="section" id="als-sgd">
<h2>ALS &amp; SGD<a class="headerlink" href="#als-sgd" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">ALSRecommender</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Recommender based on Alternating Least Squares algorithm.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    k : int, default=5</span>
<span class="sd">        Number of latent features</span>
<span class="sd">    lmbda : float, default=0.1</span>
<span class="sd">        Regularization parameter</span>
<span class="sd">    max_epochs : int, default=15</span>
<span class="sd">        Max number of iterations to run</span>
<span class="sd">    baseline_algo : object</span>
<span class="sd">        Object with fit(X) and </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">lmbda</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">max_epochs</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">baseline_algo</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">error_metric</span><span class="o">=</span><span class="s1">&#39;mae&#39;</span><span class="p">,</span>
                 <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="c1"># Force integer in case it comes in as float</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lmbda</span> <span class="o">=</span> <span class="n">lmbda</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_epochs</span> <span class="o">=</span> <span class="n">max_epochs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">baseline_algo</span> <span class="o">=</span> <span class="n">baseline_algo</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">error_metric</span> <span class="o">=</span> <span class="n">error_metric</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">U</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">I</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initialized</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">_calc_train_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">U</span><span class="p">,</span> <span class="n">I</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">R_selector</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">error_metric</span><span class="o">=</span><span class="s1">&#39;mae&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">R_selector</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">R_selector</span> <span class="o">=</span> <span class="p">(</span><span class="n">R</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">R_hat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">U</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">I</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">error_metric</span> <span class="o">==</span> <span class="s1">&#39;mae&#39;</span><span class="p">:</span>
            <span class="n">error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">R_selector</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">R_hat</span> <span class="o">-</span> <span class="n">R</span><span class="p">))</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">R_selector</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> is an unsupported error metric&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">metric</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">error</span>

    <span class="k">def</span> <span class="nf">_fit_init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;X must be a DataFrame&quot;</span><span class="p">)</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">user_col</span><span class="p">,</span> <span class="n">item_col</span><span class="p">,</span> <span class="n">rating_col</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">baseline_algo</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">train_mean</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">rating_col</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">baseline_algo</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_map</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_map</span> <span class="o">=</span> <span class="n">get_rating_matrix</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="n">n_users</span><span class="p">,</span> <span class="n">n_items</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="o">.</span><span class="n">shape</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">U</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">,</span> <span class="n">n_users</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">I</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">,</span> <span class="n">n_items</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">I</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># Avg. rating for each movie</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">E</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">)</span> <span class="c1"># (k x k)-dimensional idendity matrix</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_errors</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initialized</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">n_epochs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Fit model to training data X. If at least one iteration has already been run,</span>
<span class="sd">        then the model will continue from its most recent state.</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        X : pandas DataFrame, shape=(n_ratings, &gt;=3)</span>
<span class="sd">            First 3 columns must correspond to user, item, and rating in that order</span>
<span class="sd">        n_epochs : int, optional</span>
<span class="sd">            Number of iterations to run. If not provided, will run for self.max_epochs</span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        self</span>
<span class="sd">            This allows chaining like `ALSRecommender().fit(X_train).predict(X_test)`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Allow continuation from previous state if n_epochs is given. Otherwise start from scratch.</span>
        <span class="k">if</span> <span class="n">n_epochs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">initialized</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">initialized</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fit_init</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

        <span class="n">epoch_0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span>
        <span class="k">if</span> <span class="n">n_epochs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">n_epochs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_epochs</span> <span class="o">-</span> <span class="n">epoch_0</span>

        <span class="n">n_users</span><span class="p">,</span> <span class="n">n_items</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="o">.</span><span class="n">shape</span>

        <span class="c1"># Run n_epochs iterations</span>
        <span class="k">for</span> <span class="n">i_epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_epochs</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_epochs</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;max_epochs = </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_epochs</span><span class="p">))</span>
                <span class="k">break</span>
            <span class="c1"># Fix I and estimate U</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">Ri</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">):</span>
                <span class="n">nui</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">Ri</span><span class="p">)</span> <span class="c1"># Number of items user i has rated</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">nui</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span> <span class="n">nui</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1"># Be aware of zero counts!</span>
                <span class="c1"># Get array of nonzero indices in row Ii</span>
                <span class="n">Ri_nonzero_selector</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">Ri</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="c1"># Select subset of I associated with movies reviewed by user i</span>
                <span class="n">I_Ri</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">I</span><span class="p">[:,</span> <span class="n">Ri_nonzero_selector</span><span class="p">]</span>
                <span class="c1"># Select subset of row R_i associated with movies reviewed by user i</span>
                <span class="n">Ri_nonzero</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">Ri_nonzero_selector</span><span class="p">]</span>
                <span class="n">Ai</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">I_Ri</span><span class="p">,</span> <span class="n">I_Ri</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">lmbda</span> <span class="o">*</span> <span class="n">nui</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">E</span>
                <span class="n">Vi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">I_Ri</span><span class="p">,</span> <span class="n">Ri_nonzero</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">U</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">Ai</span><span class="p">,</span> <span class="n">Vi</span><span class="p">)</span>
            <span class="c1"># Fix U and estimate I</span>
            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">Rj</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="o">.</span><span class="n">T</span><span class="p">):</span>
                <span class="n">nmj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">Rj</span><span class="p">)</span> <span class="c1"># Number of users that rated item j</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">nmj</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span> <span class="n">nmj</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1"># Be aware of zero counts!</span>
                <span class="c1"># Get array of nonzero indices in row Ij</span>
                <span class="n">Rj_nonzero_selector</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">Rj</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="c1"># Select subset of P associated with users who reviewed movie j</span>
                <span class="n">U_Rj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">U</span><span class="p">[:,</span> <span class="n">Rj_nonzero_selector</span><span class="p">]</span>
                <span class="c1"># Select subset of column R_j associated with users who reviewed movie j</span>
                <span class="n">Rj_nonzero</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">[</span><span class="n">Rj_nonzero_selector</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
                <span class="n">Aj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">U_Rj</span><span class="p">,</span> <span class="n">U_Rj</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">lmbda</span> <span class="o">*</span> <span class="n">nmj</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">E</span>
                <span class="n">Vj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">U_Rj</span><span class="p">,</span> <span class="n">Rj_nonzero</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">I</span><span class="p">[:,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">Aj</span><span class="p">,</span> <span class="n">Vj</span><span class="p">)</span>
            <span class="n">error</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calc_train_error</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">U</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">I</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">train_errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[Epoch </span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">] train error: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_epochs</span><span class="p">,</span> <span class="n">error</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generate predictions for user/item pairs</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        X : pandas dataframe, shape = (n_pairs, 2)</span>
<span class="sd">            User, item dataframe</span>
<span class="sd">            </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        rating_pred : 1d numpy array, shape = (n_pairs,)</span>
<span class="sd">            Array of rating predictions for each user/item pair</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;X must be a DataFrame&quot;</span><span class="p">)</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">user_col</span><span class="p">,</span> <span class="n">item_col</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">baseline_algo</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">X</span><span class="p">[</span><span class="s1">&#39;rating_baseline&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_mean</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">X</span><span class="p">[</span><span class="s1">&#39;rating_baseline&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">baseline_algo</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="n">X</span><span class="p">[</span><span class="s1">&#39;rating&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">known_user_and_item_mask</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">X</span><span class="p">[</span><span class="n">user_col</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_map</span><span class="o">.</span><span class="n">index</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">X</span><span class="p">[</span><span class="n">item_col</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">item_map</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">X_known</span><span class="p">,</span> <span class="n">X_unknown</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">known_user_and_item_mask</span><span class="p">],</span> <span class="n">X</span><span class="p">[</span><span class="o">~</span><span class="n">known_user_and_item_mask</span><span class="p">]</span>
        <span class="n">user_inds</span> <span class="o">=</span> <span class="n">X_known</span><span class="p">[</span><span class="n">user_col</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_map</span><span class="p">)</span>
        <span class="n">item_inds</span> <span class="o">=</span> <span class="n">X_known</span><span class="p">[</span><span class="n">item_col</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">item_map</span><span class="p">)</span>
        <span class="n">rating_pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">U</span><span class="p">[:,</span> <span class="n">u_ind</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">I</span><span class="p">[:,</span> <span class="n">i_ind</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">u_ind</span><span class="p">,</span> <span class="n">i_ind</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">user_inds</span><span class="p">,</span> <span class="n">item_inds</span><span class="p">)</span>
        <span class="p">])</span>
        <span class="n">X</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">known_user_and_item_mask</span><span class="p">,</span> <span class="s1">&#39;rating&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rating_pred</span>
        <span class="n">X</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="o">~</span><span class="n">known_user_and_item_mask</span><span class="p">,</span> <span class="s1">&#39;rating&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">baseline_algo</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_unknown</span><span class="p">)</span>
        <span class="n">min_rating</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">)])</span>
        <span class="n">max_rating</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">)</span>
        <span class="n">X</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">X</span><span class="p">[</span><span class="s1">&#39;rating&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">min_rating</span><span class="p">,</span> <span class="s1">&#39;rating&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">min_rating</span>
        <span class="n">X</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">X</span><span class="p">[</span><span class="s1">&#39;rating&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">max_rating</span><span class="p">,</span> <span class="s1">&#39;rating&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">max_rating</span>
        <span class="k">return</span> <span class="n">X</span><span class="p">[</span><span class="s1">&#39;rating&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>


<span class="k">class</span> <span class="nc">SGDRecommender</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Stochastic Gradient Descent recommender.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    k : int, default=5</span>
<span class="sd">        Number of latent features</span>
<span class="sd">    learning_rate : float, default=0.1</span>
<span class="sd">        Speed at which to descend down gradient</span>
<span class="sd">    max_epochs : int, default=15</span>
<span class="sd">        Max number of iterations to run</span>
<span class="sd">    error_metric : string, default=&#39;mae&#39;</span>
<span class="sd">        Error metric to use</span>
<span class="sd">    user_reg : float, default=0.0</span>
<span class="sd">        Regularization parameter for the latent feature weights in U, &gt;=0</span>
<span class="sd">    item_reg : float, default=0.0</span>
<span class="sd">        Regularization parameter for the latent feature weights in I, &gt;=0</span>
<span class="sd">    user_bias_reg : float, default=0.0</span>
<span class="sd">        Regularization parameter for the b_u terms, &gt;=0</span>
<span class="sd">    item_bias_reg : float, default=0.0</span>
<span class="sd">        Regularization parameter for the b_i terms, &gt;=0</span>
<span class="sd">    damping_factor : float, default=25</span>
<span class="sd">        Damping factor to be used in the baseline algorithm</span>
<span class="sd">    minibatch_size : int, default=1</span>
<span class="sd">        Number of user/item pairs to evaluate at a time during training</span>
<span class="sd">    verbose : boolean, default=True</span>
<span class="sd">        If True, print progress.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">max_epochs</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">error_metric</span><span class="o">=</span><span class="s1">&#39;mae&#39;</span><span class="p">,</span>
                 <span class="n">user_reg</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">item_reg</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">user_bias_reg</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">item_bias_reg</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
                 <span class="n">damping_factor</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">minibatch_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k</span> <span class="o">=</span> <span class="n">k</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">learning_rate</span> <span class="o">=</span> <span class="n">learning_rate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_epochs</span> <span class="o">=</span> <span class="n">max_epochs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">error_metric</span> <span class="o">=</span> <span class="n">error_metric</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_reg</span> <span class="o">=</span> <span class="n">user_reg</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">item_reg</span> <span class="o">=</span> <span class="n">item_reg</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_bias_reg</span> <span class="o">=</span> <span class="n">user_bias_reg</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">item_bias_reg</span> <span class="o">=</span> <span class="n">item_bias_reg</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">damping_factor</span> <span class="o">=</span> <span class="n">damping_factor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">minibatch_size</span> <span class="o">=</span> <span class="n">minibatch_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">U</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">I</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initialized</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">_calc_train_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">U</span><span class="p">,</span> <span class="n">I</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">b_u</span><span class="p">,</span> <span class="n">b_i</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">R_selector</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">R_selector</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">R_selector</span> <span class="o">=</span> <span class="p">(</span><span class="n">R</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">R_hat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">U</span><span class="p">,</span> <span class="n">I</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="o">+</span> <span class="n">mu</span> <span class="o">+</span> <span class="n">b_u</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">+</span> <span class="n">b_i</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_metric</span> <span class="o">==</span> <span class="s1">&#39;mae&#39;</span><span class="p">:</span>
            <span class="n">error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">R_selector</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">R_hat</span> <span class="o">-</span> <span class="n">R</span><span class="p">))</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">R_selector</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> is an unsupported error metric&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">metric</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">error</span>

    <span class="k">def</span> <span class="nf">_fit_init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;X must be a DataFrame&quot;</span><span class="p">)</span>
        <span class="n">user_col</span><span class="p">,</span> <span class="n">item_col</span><span class="p">,</span> <span class="n">rating_col</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">baseline_algo</span> <span class="o">=</span> <span class="n">DampedUserMovieBaselineModel</span><span class="p">(</span><span class="n">damping_factor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">damping_factor</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">baseline_algo</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mu</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">rating_col</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">b_u</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">baseline_algo</span><span class="o">.</span><span class="n">b_u</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">baseline_algo</span><span class="o">.</span><span class="n">b_i</span><span class="o">.</span><span class="n">values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_map</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_map</span> <span class="o">=</span> <span class="n">get_rating_matrix</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="n">n_users</span><span class="p">,</span> <span class="n">n_items</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="o">.</span><span class="n">shape</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">U</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">scale</span><span class="o">=</span><span class="mf">1.0</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">n_users</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">I</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">scale</span><span class="o">=</span><span class="mf">1.0</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">n_items</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_errors</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initialized</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">n_epochs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Fit model to training data X. If at least one iteration has already been run,</span>
<span class="sd">        then the model will continue from its most recent state.</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        X : pandas DataFrame, shape=(n_ratings, &gt;=3)</span>
<span class="sd">            First 3 columns must correspond to user, item, and rating in that order</span>
<span class="sd">        n_epochs : int, optional</span>
<span class="sd">            Number of iterations to run. If not provided, will run for self.max_epochs</span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        self</span>
<span class="sd">            This allows chaining like `SGDRecommender().fit(X_train).predict(X_test)`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="c1"># Allow continuation from previous state if n_epochs is given. Otherwise start from scratch.</span>
        <span class="k">if</span> <span class="n">n_epochs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">initialized</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">initialized</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fit_init</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="n">X</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_map</span><span class="p">)</span>
        <span class="n">X</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">item_map</span><span class="p">)</span>

        <span class="n">epoch_0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span>
        <span class="k">if</span> <span class="n">n_epochs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">n_epochs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_epochs</span> <span class="o">-</span> <span class="n">epoch_0</span>

        <span class="n">n_users</span><span class="p">,</span> <span class="n">n_items</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="o">.</span><span class="n">shape</span>

        <span class="c1"># Repeat until convergence</span>
        <span class="k">for</span> <span class="n">i_epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_epochs</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_epochs</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;max_epochs = </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_epochs</span><span class="p">))</span>
                <span class="k">break</span>
            <span class="c1"># Shuffle X</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">frac</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">minibatch_size</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">X</span><span class="o">.</span><span class="n">itertuples</span><span class="p">():</span>
                    <span class="n">index</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">rating</span> <span class="o">=</span> <span class="n">row</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span>
                    <span class="n">pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict_1_train</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>
                    <span class="n">err</span> <span class="o">=</span> <span class="n">pred</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">[</span><span class="n">user</span><span class="p">,</span> <span class="n">item</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">b_u</span><span class="p">[</span><span class="n">user</span><span class="p">]</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">learning_rate</span> <span class="o">*</span> <span class="p">(</span><span class="n">err</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_bias_reg</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_u</span><span class="p">[</span><span class="n">user</span><span class="p">])</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">b_i</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">learning_rate</span> <span class="o">*</span> <span class="p">(</span><span class="n">err</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_bias_reg</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_i</span><span class="p">[</span><span class="n">item</span><span class="p">])</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">U</span><span class="p">[</span><span class="n">user</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">learning_rate</span> <span class="o">*</span> <span class="p">(</span>
                        <span class="n">err</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">I</span><span class="p">[</span><span class="n">item</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_reg</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">U</span><span class="p">[</span><span class="n">user</span><span class="p">,</span> <span class="p">:]</span>
                    <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">I</span><span class="p">[</span><span class="n">item</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">learning_rate</span> <span class="o">*</span> <span class="p">(</span>
                        <span class="n">err</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">U</span><span class="p">[</span><span class="n">user</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_reg</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">I</span><span class="p">[</span><span class="n">item</span><span class="p">,</span> <span class="p">:]</span>
                    <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Minibatch size greater than 1 not supported yet.&quot;</span><span class="p">)</span>
            <span class="n">error</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calc_train_error</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">U</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">I</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mu</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_u</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_i</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">train_errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[Epoch </span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">] train error: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_epochs</span><span class="p">,</span> <span class="n">error</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">predict_1_train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="n">pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mu</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_u</span><span class="p">[</span><span class="n">user</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_i</span><span class="p">[</span><span class="n">item</span><span class="p">]</span>
        <span class="n">pred</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">U</span><span class="p">[</span><span class="n">user</span><span class="p">,</span> <span class="p">:],</span> <span class="bp">self</span><span class="o">.</span><span class="n">I</span><span class="p">[</span><span class="n">item</span><span class="p">,</span> <span class="p">:])</span>
        <span class="k">return</span> <span class="n">pred</span>

    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generate predictions for user/item pairs</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        X : pandas dataframe, shape = (n_pairs, 2)</span>
<span class="sd">            User, item dataframe</span>
<span class="sd">            </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        rating_pred : 1d numpy array, shape = (n_pairs,)</span>
<span class="sd">            Array of rating predictions for each user/item pair</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;X must be a DataFrame&quot;</span><span class="p">)</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">user_col</span><span class="p">,</span> <span class="n">item_col</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">known_user_and_item_mask</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">X</span><span class="p">[</span><span class="n">user_col</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_map</span><span class="o">.</span><span class="n">index</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">X</span><span class="p">[</span><span class="n">item_col</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">item_map</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">X_known</span><span class="p">,</span> <span class="n">X_unknown</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">known_user_and_item_mask</span><span class="p">],</span> <span class="n">X</span><span class="p">[</span><span class="o">~</span><span class="n">known_user_and_item_mask</span><span class="p">]</span>
        <span class="n">user_inds</span> <span class="o">=</span> <span class="n">X_known</span><span class="p">[</span><span class="n">user_col</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_map</span><span class="p">)</span>
        <span class="n">item_inds</span> <span class="o">=</span> <span class="n">X_known</span><span class="p">[</span><span class="n">item_col</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">item_map</span><span class="p">)</span>
        <span class="n">rating_pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">predict_1_train</span><span class="p">(</span><span class="n">u_ind</span><span class="p">,</span> <span class="n">i_ind</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">u_ind</span><span class="p">,</span> <span class="n">i_ind</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">user_inds</span><span class="p">,</span> <span class="n">item_inds</span><span class="p">)</span>
        <span class="p">])</span>
        <span class="n">X</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">known_user_and_item_mask</span><span class="p">,</span> <span class="s1">&#39;rating&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rating_pred</span>
        <span class="n">X</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="o">~</span><span class="n">known_user_and_item_mask</span><span class="p">,</span> <span class="s1">&#39;rating&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">baseline_algo</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_unknown</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">X</span><span class="p">[</span><span class="s1">&#39;rating&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">n_splits</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">skf</span> <span class="o">=</span> <span class="n">StratifiedKFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="n">n_splits</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">splits</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">(</span><span class="n">train_inds</span><span class="p">,</span> <span class="n">test_inds</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">train_inds</span><span class="p">,</span> <span class="n">test_inds</span> <span class="ow">in</span> <span class="n">skf</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">ratings_df</span><span class="p">,</span> <span class="n">ratings_df</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">])</span>
<span class="p">]</span>

<span class="k">for</span> <span class="n">i_fold</span><span class="p">,</span> <span class="p">(</span><span class="n">train_inds</span><span class="p">,</span> <span class="n">test_inds</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">splits</span><span class="p">):</span>
    <span class="n">train_df</span><span class="p">,</span> <span class="n">test_df</span> <span class="o">=</span> <span class="n">ratings_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_inds</span><span class="p">],</span> <span class="n">ratings_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">test_inds</span><span class="p">]</span>
    <span class="n">train_movie_counts</span> <span class="o">=</span> <span class="n">train_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;user_id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">item_id</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
    <span class="n">test_movie_counts</span> <span class="o">=</span> <span class="n">test_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;user_id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">item_id</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Fold </span><span class="si">{}</span><span class="s2">:&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i_fold</span><span class="p">))</span>
    <span class="n">train_min</span><span class="p">,</span> <span class="n">train_max</span> <span class="o">=</span> <span class="n">train_movie_counts</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">train_movie_counts</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">test_min</span><span class="p">,</span> <span class="n">test_max</span> <span class="o">=</span> <span class="n">test_movie_counts</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">test_movie_counts</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  Train: between </span><span class="si">{}</span><span class="s2"> and </span><span class="si">{}</span><span class="s2"> movies per user&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">train_min</span><span class="p">,</span> <span class="n">train_max</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  Test:  between </span><span class="si">{}</span><span class="s2"> and </span><span class="si">{}</span><span class="s2"> movies per user&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">test_min</span><span class="p">,</span> <span class="n">test_max</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Fold 0:
  Train: between 13 and 492 movies per user
  Test:  between 6 and 245 movies per user
Fold 1:
  Train: between 13 and 491 movies per user
  Test:  between 6 and 246 movies per user
Fold 2:
  Train: between 13 and 491 movies per user
  Test:  between 6 and 246 movies per user
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/usr/local/lib/python3.6/dist-packages/sklearn/model_selection/_split.py:296: FutureWarning: Setting a random_state has no effect since shuffle is False. This will raise an error in 0.24. You should leave random_state to its default (None), or set shuffle=True.
  FutureWarning
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">cart_prod</span><span class="p">(</span><span class="n">df_1</span><span class="p">,</span> <span class="n">df_2</span><span class="p">):</span>
    <span class="n">df_1</span><span class="p">[</span><span class="s1">&#39;_dummy_&#39;</span><span class="p">],</span> <span class="n">df_2</span><span class="p">[</span><span class="s1">&#39;_dummy_&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df_1</span><span class="p">,</span> <span class="n">df_2</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;_dummy_&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;_dummy_&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">prep_results_df</span><span class="p">(</span><span class="n">lists_dict</span><span class="p">):</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;_dummy_&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">]})</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="nb">list</span> <span class="ow">in</span> <span class="n">lists_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">cart_prod</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="n">name</span><span class="p">:</span> <span class="nb">list</span><span class="p">}))</span>
    <span class="k">return</span> <span class="n">df</span>
</pre></div>
</div>
</div>
</div>
<p>Evaluation functions</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">dcg</span><span class="p">(</span><span class="n">top_k_matrix</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Compute discounted cumulative gain (DCG) for each row (user) in matrix.</span>
<span class="sd">    This measures how good the k recommendations for each user are, with</span>
<span class="sd">    decreasing weight placed on items farther down the list. DCG needs to be</span>
<span class="sd">    normalized before comparing between users (see normalized discounted</span>
<span class="sd">    cumulative gain, or NDCG).</span>
<span class="sd">    Links:</span>
<span class="sd">        https://link.springer.com/article/10.1007/s11704-015-4584-1</span>
<span class="sd">        https://gist.github.com/bwhite/3726239</span>
<span class="sd">        https://opensourceconnections.com/blog/2018/02/26/ndcg-scorer-in-quepid</span>
<span class="sd">            #cg-dcg-idcg-and-ndcg</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    top_k_matrix : 2d numpy array, shape = (n_users, k)</span>
<span class="sd">        Each row should have the top k ratings for each user from a rating</span>
<span class="sd">        matrix in descending order.</span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    1d numpy array, shape=(n_users,)</span>
<span class="sd">        Array of DCG values for each user</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
        <span class="n">top_k_matrix</span>
        <span class="o">/</span>
        <span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">top_k_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">2</span><span class="p">))[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:],</span>
        <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
    <span class="p">)</span>

<span class="k">def</span> <span class="nf">ndcg</span><span class="p">(</span><span class="n">pred_k_matrix</span><span class="p">,</span> <span class="n">actual_k_matrix</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Calculate normalized discounted cumulative gain (NDCG) for each user</span>
<span class="sd">    (each row). This is simply the DCG divided by the maximum possible DCG for</span>
<span class="sd">    each user. NDCG ranges from 0 to 1, where 1 means movies were chosen that</span>
<span class="sd">    actually received the highest k ratings.</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    pred_k_matrix : 2d numpy array, shape = (n_users, k)</span>
<span class="sd">        A matrix of the *actual* ratings of the k movies chosen by the</span>
<span class="sd">        recommender system for each user</span>
<span class="sd">    actual_k_matrix : 2d numpy array, shape = (n_users, k)</span>
<span class="sd">        A matrix of the *actual* ratings of the k movies from the test set</span>
<span class="sd">        which the user gave the highest ratings to.</span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    ndcg_array : 1d numpy array, shape = (n_users,)</span>
<span class="sd">        Array of NDCG values for each user</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">max_dcg_array</span> <span class="o">=</span> <span class="n">dcg</span><span class="p">(</span><span class="n">actual_k_matrix</span><span class="p">)</span>
    <span class="n">dcg_array</span> <span class="o">=</span> <span class="n">dcg</span><span class="p">(</span><span class="n">pred_k_matrix</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dcg_array</span> <span class="o">/</span> <span class="n">max_dcg_array</span>

<span class="k">def</span> <span class="nf">ndcg_from_df</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">pred</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Calculate NDCG for each user in the passed dataframe given predicted</span>
<span class="sd">    scores and a number of movies to recommend</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : pandas dataframe, shape = (n_ratings, &gt;=3)</span>
<span class="sd">        User, item, rating dataframe. All columns after first 3 are ignored</span>
<span class="sd">    pred : 1d array-like, shape = (n_ratings,)</span>
<span class="sd">        List/array/series of predicted ratings for each user/item pair in df</span>
<span class="sd">    k : int</span>
<span class="sd">        Number of movies per user to recommend</span>
<span class="sd">        </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    user_map : pandas series, shape = (n_users,)</span>
<span class="sd">        Index = original user ids, value = mapped integer corresponding to</span>
<span class="sd">        position in ndcg_array for that user</span>
<span class="sd">    ndcg_array : 1d numpy array, shape = (n_users)</span>
<span class="sd">        Array of NDCG scores in range (0, 1]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="s1">&#39;item&#39;</span><span class="p">,</span> <span class="s1">&#39;rating&#39;</span><span class="p">]</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;pred&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pred</span>
    <span class="n">pred_matrix</span><span class="p">,</span> <span class="n">user_map</span><span class="p">,</span> <span class="n">item_map</span> <span class="o">=</span> <span class="n">get_rating_matrix</span><span class="p">(</span><span class="n">df</span><span class="p">[[</span><span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="s1">&#39;item&#39;</span><span class="p">,</span> <span class="s1">&#39;pred&#39;</span><span class="p">]])</span>
    <span class="n">n_items</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">item_map</span><span class="p">)</span>
    <span class="n">inds</span> <span class="o">=</span> <span class="n">pred_matrix</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)[:,</span> <span class="p">:</span><span class="n">n_items</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="n">k</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">del</span> <span class="n">pred_matrix</span>
    <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
    <span class="n">actual_matrix</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">get_rating_matrix</span><span class="p">(</span><span class="n">df</span><span class="p">[[</span><span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="s1">&#39;item&#39;</span><span class="p">,</span> <span class="s1">&#39;rating&#39;</span><span class="p">]])</span>
    <span class="n">pred_k_matrix</span> <span class="o">=</span> <span class="n">actual_matrix</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">actual_matrix</span><span class="p">))[:,</span> <span class="kc">None</span><span class="p">],</span> <span class="n">inds</span><span class="p">]</span>
    <span class="n">inds</span> <span class="o">=</span> <span class="n">actual_matrix</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)[:,</span> <span class="p">:</span><span class="n">n_items</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="n">k</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">actual_k_matrix</span> <span class="o">=</span> <span class="n">actual_matrix</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">actual_matrix</span><span class="p">))[:,</span> <span class="kc">None</span><span class="p">],</span> <span class="n">inds</span><span class="p">]</span>
    <span class="n">ndcg_array</span> <span class="o">=</span> <span class="n">ndcg</span><span class="p">(</span><span class="n">pred_k_matrix</span><span class="p">,</span> <span class="n">actual_k_matrix</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">user_map</span><span class="p">,</span> <span class="n">ndcg_array</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="choose-the-best-user-based-model">
<h3>Choose the best user-based model<a class="headerlink" href="#choose-the-best-user-based-model" title="Permalink to this headline">¶</a></h3>
<p><em>Let’s use cross-validation to examine MAE and NDCG&#64;3 on out-of-sample data and choose the “best” user-based model</em></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">lists_dict</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;i_fold&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_splits</span><span class="p">),</span>
    <span class="s1">&#39;k&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">100</span><span class="p">],</span>
<span class="p">}</span>
<span class="n">k_recs</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">baseline_algo</span> <span class="o">=</span> <span class="n">DampedUserMovieBaselineModel</span><span class="p">(</span><span class="n">damping_factor</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">user_results_df</span> <span class="o">=</span> <span class="n">prep_results_df</span><span class="p">(</span><span class="n">lists_dict</span><span class="p">)</span>
<span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;test_err&#39;</span><span class="p">,</span> <span class="s1">&#39;ndcg_mean&#39;</span><span class="p">,</span> <span class="s1">&#39;ndcg_std&#39;</span><span class="p">,</span> <span class="s1">&#39;dt&#39;</span><span class="p">]</span>
<span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
    <span class="n">user_results_df</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
<span class="k">for</span> <span class="n">i_fold</span><span class="p">,</span> <span class="p">(</span><span class="n">train_inds</span><span class="p">,</span> <span class="n">test_inds</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">splits</span><span class="p">):</span>
    <span class="n">train_df</span><span class="p">,</span> <span class="n">test_df</span> <span class="o">=</span> <span class="n">ratings_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_inds</span><span class="p">],</span> <span class="n">ratings_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">test_inds</span><span class="p">]</span>
    <span class="n">user_results_i</span> <span class="o">=</span> <span class="n">user_results_df</span><span class="p">[</span><span class="n">user_results_df</span><span class="p">[</span><span class="s1">&#39;i_fold&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">i_fold</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">user_results_i</span><span class="p">[[</span><span class="s1">&#39;i_fold&#39;</span><span class="p">,</span> <span class="s1">&#39;k&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">t1</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">KNNRecommender</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">],</span> <span class="n">baseline_algo</span><span class="o">=</span><span class="n">baseline_algo</span><span class="p">)</span>
        <span class="n">preds</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_df</span><span class="p">)</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_df</span><span class="p">[[</span><span class="s1">&#39;user_id&#39;</span><span class="p">,</span> <span class="s1">&#39;item_id&#39;</span><span class="p">]])</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">t1</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
        <span class="n">test_err</span> <span class="o">=</span> <span class="n">mean_absolute_error</span><span class="p">(</span><span class="n">test_df</span><span class="p">[</span><span class="s1">&#39;rating&#39;</span><span class="p">],</span> <span class="n">preds</span><span class="p">)</span>
        <span class="n">user_map</span><span class="p">,</span> <span class="n">ndcg_array</span> <span class="o">=</span> <span class="n">ndcg_from_df</span><span class="p">(</span><span class="n">test_df</span><span class="p">,</span> <span class="n">preds</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">k_recs</span><span class="p">)</span>
        <span class="n">ndcg_mean</span><span class="p">,</span> <span class="n">ndcg_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">ndcg_array</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">ndcg_array</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;k=</span><span class="si">{}</span><span class="s2">, i_fold=</span><span class="si">{}</span><span class="s2">: MAE=</span><span class="si">{}</span><span class="s2">, NDCG=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;i_fold&#39;</span><span class="p">],</span> <span class="n">test_err</span><span class="p">,</span> <span class="n">ndcg_mean</span><span class="p">))</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;test_err&#39;</span><span class="p">,</span> <span class="s1">&#39;ndcg_mean&#39;</span><span class="p">,</span> <span class="s1">&#39;ndcg_std&#39;</span><span class="p">,</span> <span class="s1">&#39;dt&#39;</span><span class="p">]</span>
        <span class="n">user_results_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="n">cols</span><span class="p">]</span> <span class="o">=</span> <span class="n">test_err</span><span class="p">,</span> <span class="n">ndcg_mean</span><span class="p">,</span> <span class="n">ndcg_std</span><span class="p">,</span> <span class="n">dt</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>k=1, i_fold=0: MAE=0.815118677174853, NDCG=0.8369655023253458
k=2, i_fold=0: MAE=0.781600231166416, NDCG=0.8482273405775766
k=5, i_fold=0: MAE=0.7571264942010565, NDCG=0.8630678403049701
k=10, i_fold=0: MAE=0.7496153263636528, NDCG=0.8659193360477797
k=20, i_fold=0: MAE=0.7469469536576984, NDCG=0.8717836126245141
k=50, i_fold=0: MAE=0.7470360905582336, NDCG=0.8716972263659186
k=100, i_fold=0: MAE=0.7488371816907775, NDCG=0.8695180372946614
k=1, i_fold=1: MAE=0.820690147621912, NDCG=0.8359381527480367
k=2, i_fold=1: MAE=0.784450538355682, NDCG=0.847674607736636
k=5, i_fold=1: MAE=0.7593870993315751, NDCG=0.8606143875242239
k=10, i_fold=1: MAE=0.7526014139035732, NDCG=0.8622149031659992
k=20, i_fold=1: MAE=0.7500167049661343, NDCG=0.8658096963086768
k=50, i_fold=1: MAE=0.7508972003037176, NDCG=0.8662743964516358
k=100, i_fold=1: MAE=0.7528793793802401, NDCG=0.8645012299391964
k=1, i_fold=2: MAE=0.8199492154157525, NDCG=0.8351597108738448
k=2, i_fold=2: MAE=0.7834779688045745, NDCG=0.8506591379908867
k=5, i_fold=2: MAE=0.7603686168232268, NDCG=0.8596734081733238
k=10, i_fold=2: MAE=0.7499603079518496, NDCG=0.8685605335101336
k=20, i_fold=2: MAE=0.7470651456010144, NDCG=0.8754058641314186
k=50, i_fold=2: MAE=0.7475564925970107, NDCG=0.8765422449708559
k=100, i_fold=2: MAE=0.7496003554351732, NDCG=0.8740726774708101
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax0</span><span class="p">,</span> <span class="n">ax1</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">pointplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">user_results_df</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;test_err&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax0</span><span class="p">)</span>
<span class="n">ax0</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;MAE&#39;</span><span class="p">)</span>
<span class="n">ax0</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">pointplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">user_results_df</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;ndcg_mean&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax1</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;NDCG@</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k_recs</span><span class="p">))</span>
<span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">hspace</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/T990000_movielens_eda_modeling_58_0.png" src="../_images/T990000_movielens_eda_modeling_58_0.png" />
</div>
</div>
<p>NDCG&#64;3 peaks at <span class="math notranslate nohighlight">\(k=50\)</span>, and MAE is pretty similar between <span class="math notranslate nohighlight">\(k=20\)</span> to <span class="math notranslate nohighlight">\(100\)</span>, so <span class="math notranslate nohighlight">\(k=50\)</span> is the winner.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">baseline_algo</span> <span class="o">=</span> <span class="n">DampedUserMovieBaselineModel</span><span class="p">(</span><span class="n">damping_factor</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">best_user_model</span> <span class="o">=</span> <span class="n">KNNRecommender</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">baseline_algo</span><span class="o">=</span><span class="n">baseline_algo</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="choose-the-best-item-based-model">
<h3>Choose the best item-based model<a class="headerlink" href="#choose-the-best-item-based-model" title="Permalink to this headline">¶</a></h3>
<p><em>Let’s use cross-validation to examine MAE and NDCG&#64;3 on out-of-sample data and choose the “best” item-based model.</em></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">lists_dict</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;i_fold&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_splits</span><span class="p">),</span>
    <span class="s1">&#39;k&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">100</span><span class="p">],</span>
<span class="p">}</span>
<span class="n">k_recs</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">baseline_algo</span> <span class="o">=</span> <span class="n">DampedUserMovieBaselineModel</span><span class="p">(</span><span class="n">damping_factor</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">item_results_df</span> <span class="o">=</span> <span class="n">prep_results_df</span><span class="p">(</span><span class="n">lists_dict</span><span class="p">)</span>
<span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;test_err&#39;</span><span class="p">,</span> <span class="s1">&#39;ndcg_mean&#39;</span><span class="p">,</span> <span class="s1">&#39;ndcg_std&#39;</span><span class="p">,</span> <span class="s1">&#39;dt&#39;</span><span class="p">]</span>
<span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
    <span class="n">item_results_df</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
<span class="k">for</span> <span class="n">i_fold</span><span class="p">,</span> <span class="p">(</span><span class="n">train_inds</span><span class="p">,</span> <span class="n">test_inds</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">splits</span><span class="p">):</span>
    <span class="n">train_df</span><span class="p">,</span> <span class="n">test_df</span> <span class="o">=</span> <span class="n">ratings_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_inds</span><span class="p">],</span> <span class="n">ratings_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">test_inds</span><span class="p">]</span>
    <span class="n">item_results_i</span> <span class="o">=</span> <span class="n">item_results_df</span><span class="p">[</span><span class="n">item_results_df</span><span class="p">[</span><span class="s1">&#39;i_fold&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">i_fold</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;i_fold=</span><span class="si">{}</span><span class="s2">: &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i_fold</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">item_results_i</span><span class="p">[[</span><span class="s1">&#39;i_fold&#39;</span><span class="p">,</span> <span class="s1">&#39;k&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">t1</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">KNNRecommender</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;item&#39;</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">],</span> <span class="n">baseline_algo</span><span class="o">=</span><span class="n">baseline_algo</span><span class="p">)</span>
        <span class="n">preds</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_df</span><span class="p">)</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_df</span><span class="p">[[</span><span class="s1">&#39;user_id&#39;</span><span class="p">,</span> <span class="s1">&#39;item_id&#39;</span><span class="p">]])</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">t1</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
        <span class="n">test_err</span> <span class="o">=</span> <span class="n">mean_absolute_error</span><span class="p">(</span><span class="n">test_df</span><span class="p">[</span><span class="s1">&#39;rating&#39;</span><span class="p">],</span> <span class="n">preds</span><span class="p">)</span>
        <span class="n">user_map</span><span class="p">,</span> <span class="n">ndcg_array</span> <span class="o">=</span> <span class="n">ndcg_from_df</span><span class="p">(</span><span class="n">test_df</span><span class="p">,</span> <span class="n">preds</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">k_recs</span><span class="p">)</span>
        <span class="n">ndcg_mean</span><span class="p">,</span> <span class="n">ndcg_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">ndcg_array</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">ndcg_array</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;k=</span><span class="si">{}</span><span class="s2">, &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">]),</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;test_err&#39;</span><span class="p">,</span> <span class="s1">&#39;ndcg_mean&#39;</span><span class="p">,</span> <span class="s1">&#39;ndcg_std&#39;</span><span class="p">,</span> <span class="s1">&#39;dt&#39;</span><span class="p">]</span>
        <span class="n">item_results_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="n">cols</span><span class="p">]</span> <span class="o">=</span> <span class="n">test_err</span><span class="p">,</span> <span class="n">ndcg_mean</span><span class="p">,</span> <span class="n">ndcg_std</span><span class="p">,</span> <span class="n">dt</span>
    <span class="nb">print</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>i_fold=0: k=1, k=2, k=5, k=10, k=20, k=50, k=100, 
i_fold=1: k=1, k=2, k=5, k=10, k=20, k=50, k=100, 
i_fold=2: k=1, k=2, k=5, k=10, k=20, k=50, k=100, 
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax0</span><span class="p">,</span> <span class="n">ax1</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">pointplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">item_results_df</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;test_err&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax0</span><span class="p">)</span>
<span class="n">ax0</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;MAE&#39;</span><span class="p">)</span>
<span class="n">ax0</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">pointplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">item_results_df</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;ndcg_mean&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax1</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;NDCG@</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k_recs</span><span class="p">))</span>
<span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">hspace</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>Here, <span class="math notranslate nohighlight">\(k=10\)</span> and <span class="math notranslate nohighlight">\(k=20\)</span> have similar MAE and NDCG&#64;3, we’ll favor higher <span class="math notranslate nohighlight">\(k\)</span> in nearest neigbor methods because higher <span class="math notranslate nohighlight">\(k\)</span> is less prone to overfitting. <span class="math notranslate nohighlight">\(k=20\)</span> is the winner of the item-based models.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">baseline_algo</span> <span class="o">=</span> <span class="n">DampedUserMovieBaselineModel</span><span class="p">(</span><span class="n">damping_factor</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">best_item_model</span> <span class="o">=</span> <span class="n">KNNRecommender</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;item&#39;</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">baseline_algo</span><span class="o">=</span><span class="n">baseline_algo</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="choose-the-best-als-model">
<h3>Choose the best ALS model<a class="headerlink" href="#choose-the-best-als-model" title="Permalink to this headline">¶</a></h3>
<p>Let’s use cross-validation to examine MAE and NDCG&#64;3 on out-of-sample data and choose the “best” ALS model.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">max_epochs</span> <span class="o">=</span> <span class="mi">15</span>
<span class="n">lists_dict</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;i_fold&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_splits</span><span class="p">),</span>
    <span class="s1">&#39;i_epoch&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">max_epochs</span><span class="p">),</span>
    <span class="s1">&#39;k&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">50</span><span class="p">],</span>
<span class="p">}</span>
<span class="n">k_recs</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">baseline_algo</span> <span class="o">=</span> <span class="n">DampedUserMovieBaselineModel</span><span class="p">(</span><span class="n">damping_factor</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">als_epoch_results_df</span> <span class="o">=</span> <span class="n">prep_results_df</span><span class="p">(</span><span class="n">lists_dict</span><span class="p">)</span>
<span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;test_err&#39;</span><span class="p">,</span> <span class="s1">&#39;ndcg_mean&#39;</span><span class="p">,</span> <span class="s1">&#39;ndcg_std&#39;</span><span class="p">,</span> <span class="s1">&#39;dt&#39;</span><span class="p">]</span>
<span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
    <span class="n">als_epoch_results_df</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
<span class="k">for</span> <span class="n">i_fold</span><span class="p">,</span> <span class="p">(</span><span class="n">train_inds</span><span class="p">,</span> <span class="n">test_inds</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">splits</span><span class="p">):</span>
    <span class="n">train_df</span><span class="p">,</span> <span class="n">test_df</span> <span class="o">=</span> <span class="n">ratings_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_inds</span><span class="p">],</span> <span class="n">ratings_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">test_inds</span><span class="p">]</span>
    <span class="n">als_epoch_results_i</span> <span class="o">=</span> <span class="n">als_epoch_results_df</span><span class="p">[</span><span class="n">als_epoch_results_df</span><span class="p">[</span><span class="s1">&#39;i_fold&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">i_fold</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">als_epoch_results_i</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;k&#39;</span><span class="p">):</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">ALSRecommender</span><span class="p">(</span><span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="n">lmbda</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">max_epochs</span><span class="o">=</span><span class="n">max_epochs</span><span class="p">,</span> <span class="n">baseline_algo</span><span class="o">=</span><span class="n">baseline_algo</span><span class="p">,</span>
                             <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;i_fold=</span><span class="si">{}</span><span class="s1">, k=</span><span class="si">{}</span><span class="s1">: i_epoch=&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i_fold</span><span class="p">,</span> <span class="n">k</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">group</span><span class="p">[[</span><span class="s1">&#39;i_fold&#39;</span><span class="p">,</span> <span class="s1">&#39;i_epoch&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="n">t1</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
            <span class="n">preds</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_df</span><span class="p">,</span> <span class="n">n_epochs</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_df</span><span class="p">[[</span><span class="s1">&#39;user_id&#39;</span><span class="p">,</span> <span class="s1">&#39;item_id&#39;</span><span class="p">]])</span>
            <span class="n">dt</span> <span class="o">=</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">t1</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
            <span class="n">test_err</span> <span class="o">=</span> <span class="n">mean_absolute_error</span><span class="p">(</span><span class="n">test_df</span><span class="p">[</span><span class="s1">&#39;rating&#39;</span><span class="p">],</span> <span class="n">preds</span><span class="p">)</span>
            <span class="n">user_map</span><span class="p">,</span> <span class="n">ndcg_array</span> <span class="o">=</span> <span class="n">ndcg_from_df</span><span class="p">(</span><span class="n">test_df</span><span class="p">,</span> <span class="n">preds</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">k_recs</span><span class="p">)</span>
            <span class="n">ndcg_mean</span><span class="p">,</span> <span class="n">ndcg_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">ndcg_array</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">ndcg_array</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">, &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;i_epoch&#39;</span><span class="p">]),</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;test_err&#39;</span><span class="p">,</span> <span class="s1">&#39;ndcg_mean&#39;</span><span class="p">,</span> <span class="s1">&#39;ndcg_std&#39;</span><span class="p">,</span> <span class="s1">&#39;dt&#39;</span><span class="p">]</span>
            <span class="n">als_epoch_results_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="n">cols</span><span class="p">]</span> <span class="o">=</span> <span class="n">test_err</span><span class="p">,</span> <span class="n">ndcg_mean</span><span class="p">,</span> <span class="n">ndcg_std</span><span class="p">,</span> <span class="n">dt</span>
        <span class="nb">print</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>i_fold=0, k=5: i_epoch=0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 
i_fold=0, k=10: i_epoch=0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 
i_fold=0, k=50: i_epoch=0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 
i_fold=1, k=5: i_epoch=0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 
i_fold=1, k=10: i_epoch=0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 
i_fold=1, k=50: i_epoch=0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 
i_fold=2, k=5: i_epoch=0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 
i_fold=2, k=10: i_epoch=0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 
i_fold=2, k=50: i_epoch=0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax0</span><span class="p">,</span> <span class="n">ax1</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">pointplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">als_epoch_results_df</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;i_epoch&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;test_err&#39;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax0</span><span class="p">)</span>
<span class="n">ax0</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;MAE&#39;</span><span class="p">)</span>
<span class="n">ax0</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="n">ax0</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.02</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;k =&#39;</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">pointplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">als_epoch_results_df</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;i_epoch&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;ndcg_mean&#39;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax1</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;NDCG@</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k_recs</span><span class="p">))</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Epoch&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">legend_</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>
<span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">hspace</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/T990000_movielens_eda_modeling_68_0.png" src="../_images/T990000_movielens_eda_modeling_68_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">max_epochs</span> <span class="o">=</span> <span class="mi">15</span>
<span class="n">lists_dict</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;i_fold&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_splits</span><span class="p">),</span>
    <span class="s1">&#39;k&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">20</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">200</span><span class="p">],</span>
    <span class="s1">&#39;lmbda&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">]</span>
<span class="p">}</span>
<span class="n">k_recs</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">baseline_algo</span> <span class="o">=</span> <span class="n">DampedUserMovieBaselineModel</span><span class="p">(</span><span class="n">damping_factor</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">als_results_df</span> <span class="o">=</span> <span class="n">prep_results_df</span><span class="p">(</span><span class="n">lists_dict</span><span class="p">)</span>
<span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;test_err&#39;</span><span class="p">,</span> <span class="s1">&#39;ndcg_mean&#39;</span><span class="p">,</span> <span class="s1">&#39;ndcg_std&#39;</span><span class="p">,</span> <span class="s1">&#39;dt&#39;</span><span class="p">]</span>
<span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
    <span class="n">als_results_df</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
<span class="k">for</span> <span class="n">i_fold</span><span class="p">,</span> <span class="p">(</span><span class="n">train_inds</span><span class="p">,</span> <span class="n">test_inds</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">splits</span><span class="p">):</span>
    <span class="n">train_df</span><span class="p">,</span> <span class="n">test_df</span> <span class="o">=</span> <span class="n">ratings_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_inds</span><span class="p">],</span> <span class="n">ratings_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">test_inds</span><span class="p">]</span>
    <span class="n">als_results_i</span> <span class="o">=</span> <span class="n">als_results_df</span><span class="p">[</span><span class="n">als_results_df</span><span class="p">[</span><span class="s1">&#39;i_fold&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">i_fold</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">als_results_i</span><span class="p">[[</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="s1">&#39;lmbda&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">ALSRecommender</span><span class="p">(</span><span class="n">k</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">],</span> <span class="n">lmbda</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;lmbda&#39;</span><span class="p">],</span> <span class="n">max_epochs</span><span class="o">=</span><span class="n">max_epochs</span><span class="p">,</span> <span class="n">baseline_algo</span><span class="o">=</span><span class="n">baseline_algo</span><span class="p">,</span>
                               <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;i_fold=</span><span class="si">{}</span><span class="s1">, k=</span><span class="si">{}</span><span class="s1">: lmbda=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i_fold</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;lmbda&#39;</span><span class="p">]))</span>
        <span class="n">t1</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">preds</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_df</span><span class="p">)</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_df</span><span class="p">[[</span><span class="s1">&#39;user_id&#39;</span><span class="p">,</span> <span class="s1">&#39;item_id&#39;</span><span class="p">]])</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">t1</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
        <span class="n">test_err</span> <span class="o">=</span> <span class="n">mean_absolute_error</span><span class="p">(</span><span class="n">test_df</span><span class="p">[</span><span class="s1">&#39;rating&#39;</span><span class="p">],</span> <span class="n">preds</span><span class="p">)</span>
        <span class="n">user_map</span><span class="p">,</span> <span class="n">ndcg_array</span> <span class="o">=</span> <span class="n">ndcg_from_df</span><span class="p">(</span><span class="n">test_df</span><span class="p">,</span> <span class="n">preds</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">k_recs</span><span class="p">)</span>
        <span class="n">ndcg_mean</span><span class="p">,</span> <span class="n">ndcg_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">ndcg_array</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">ndcg_array</span><span class="p">)</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;test_err&#39;</span><span class="p">,</span> <span class="s1">&#39;ndcg_mean&#39;</span><span class="p">,</span> <span class="s1">&#39;ndcg_std&#39;</span><span class="p">,</span> <span class="s1">&#39;dt&#39;</span><span class="p">]</span>
        <span class="n">als_results_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="n">cols</span><span class="p">]</span> <span class="o">=</span> <span class="n">test_err</span><span class="p">,</span> <span class="n">ndcg_mean</span><span class="p">,</span> <span class="n">ndcg_std</span><span class="p">,</span> <span class="n">dt</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>i_fold=0, k=20.0: lmbda=0.05
i_fold=0, k=20.0: lmbda=0.1
i_fold=0, k=20.0: lmbda=0.2
i_fold=0, k=50.0: lmbda=0.05
i_fold=0, k=50.0: lmbda=0.1
i_fold=0, k=50.0: lmbda=0.2
i_fold=0, k=100.0: lmbda=0.05
i_fold=0, k=100.0: lmbda=0.1
i_fold=0, k=100.0: lmbda=0.2
i_fold=0, k=200.0: lmbda=0.05
i_fold=0, k=200.0: lmbda=0.1
i_fold=0, k=200.0: lmbda=0.2
i_fold=1, k=20.0: lmbda=0.05
i_fold=1, k=20.0: lmbda=0.1
i_fold=1, k=20.0: lmbda=0.2
i_fold=1, k=50.0: lmbda=0.05
i_fold=1, k=50.0: lmbda=0.1
i_fold=1, k=50.0: lmbda=0.2
i_fold=1, k=100.0: lmbda=0.05
i_fold=1, k=100.0: lmbda=0.1
i_fold=1, k=100.0: lmbda=0.2
i_fold=1, k=200.0: lmbda=0.05
i_fold=1, k=200.0: lmbda=0.1
i_fold=1, k=200.0: lmbda=0.2
i_fold=2, k=20.0: lmbda=0.05
i_fold=2, k=20.0: lmbda=0.1
i_fold=2, k=20.0: lmbda=0.2
i_fold=2, k=50.0: lmbda=0.05
i_fold=2, k=50.0: lmbda=0.1
i_fold=2, k=50.0: lmbda=0.2
i_fold=2, k=100.0: lmbda=0.05
i_fold=2, k=100.0: lmbda=0.1
i_fold=2, k=100.0: lmbda=0.2
i_fold=2, k=200.0: lmbda=0.05
i_fold=2, k=200.0: lmbda=0.1
i_fold=2, k=200.0: lmbda=0.2
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax0</span><span class="p">,</span> <span class="n">ax1</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">pointplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">als_results_df</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;test_err&#39;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;lmbda&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax0</span><span class="p">)</span>
<span class="n">ax0</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;MAE&#39;</span><span class="p">)</span>
<span class="n">ax0</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="n">ax0</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.02</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span> <span class="n">title</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$\lambda =$&#39;</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">pointplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">als_results_df</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;ndcg_mean&#39;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;lmbda&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax1</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;NDCG@</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k_recs</span><span class="p">))</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">legend_</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>
<span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">hspace</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/T990000_movielens_eda_modeling_70_0.png" src="../_images/T990000_movielens_eda_modeling_70_0.png" />
</div>
</div>
<p>Here, it looks like MAE is pretty flat with respect to the learning rate <span class="math notranslate nohighlight">\(\lambda\)</span>, but NDCG&#64;3 shows some interesting variations. The highest NDCG&#64;3 comes from <span class="math notranslate nohighlight">\(\lambda=0.1\)</span> and <span class="math notranslate nohighlight">\(k&gt;=50\)</span>. With matrix factorization methods like ALS, we want to favor lower <span class="math notranslate nohighlight">\(k\)</span> for better generalizability, so <span class="math notranslate nohighlight">\(\lambda=0.1\)</span> and <span class="math notranslate nohighlight">\(k=50\)</span> is the winner of the ALS category.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">baseline_algo</span> <span class="o">=</span> <span class="n">DampedUserMovieBaselineModel</span><span class="p">(</span><span class="n">damping_factor</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">best_als_model</span> <span class="o">=</span> <span class="n">ALSRecommender</span><span class="p">(</span><span class="n">k</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">lmbda</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">max_epochs</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">baseline_algo</span><span class="o">=</span><span class="n">baseline_algo</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="choose-the-best-sgd-model">
<h3>Choose the best SGD model<a class="headerlink" href="#choose-the-best-sgd-model" title="Permalink to this headline">¶</a></h3>
<p><em>Let’s use cross-validation to examine MAE and NDCG&#64;3 on out-of-sample data and choose the “best” SGD model.</em></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">max_epochs</span> <span class="o">=</span> <span class="mi">15</span>
<span class="n">lists_dict</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;i_fold&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_splits</span><span class="p">),</span>
    <span class="s1">&#39;i_epoch&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">max_epochs</span><span class="p">),</span>
    <span class="s1">&#39;k&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">50</span><span class="p">],</span>
<span class="p">}</span>
<span class="n">k_recs</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">baseline_algo</span> <span class="o">=</span> <span class="n">DampedUserMovieBaselineModel</span><span class="p">(</span><span class="n">damping_factor</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">sgd_epoch_results_df</span> <span class="o">=</span> <span class="n">prep_results_df</span><span class="p">(</span><span class="n">lists_dict</span><span class="p">)</span>
<span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;test_err&#39;</span><span class="p">,</span> <span class="s1">&#39;ndcg_mean&#39;</span><span class="p">,</span> <span class="s1">&#39;ndcg_std&#39;</span><span class="p">,</span> <span class="s1">&#39;dt&#39;</span><span class="p">]</span>
<span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
    <span class="n">sgd_epoch_results_df</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
<span class="k">for</span> <span class="n">i_fold</span><span class="p">,</span> <span class="p">(</span><span class="n">train_inds</span><span class="p">,</span> <span class="n">test_inds</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">splits</span><span class="p">):</span>
    <span class="n">train_df</span><span class="p">,</span> <span class="n">test_df</span> <span class="o">=</span> <span class="n">ratings_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_inds</span><span class="p">],</span> <span class="n">ratings_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">test_inds</span><span class="p">]</span>
    <span class="n">sgd_epoch_results_i</span> <span class="o">=</span> <span class="n">sgd_epoch_results_df</span><span class="p">[</span><span class="n">sgd_epoch_results_df</span><span class="p">[</span><span class="s1">&#39;i_fold&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">i_fold</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">sgd_epoch_results_i</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;k&#39;</span><span class="p">):</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">SGDRecommender</span><span class="p">(</span><span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">max_epochs</span><span class="o">=</span><span class="n">max_epochs</span><span class="p">,</span> <span class="n">damping_factor</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                               <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;i_fold=</span><span class="si">{}</span><span class="s1">, k=</span><span class="si">{}</span><span class="s1">: i_epoch=&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i_fold</span><span class="p">,</span> <span class="n">k</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">group</span><span class="p">[[</span><span class="s1">&#39;i_fold&#39;</span><span class="p">,</span> <span class="s1">&#39;i_epoch&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="n">t1</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
            <span class="n">preds</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_df</span><span class="p">,</span> <span class="n">n_epochs</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_df</span><span class="p">[[</span><span class="s1">&#39;user_id&#39;</span><span class="p">,</span> <span class="s1">&#39;item_id&#39;</span><span class="p">]])</span>
            <span class="n">dt</span> <span class="o">=</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">t1</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
            <span class="n">test_err</span> <span class="o">=</span> <span class="n">mean_absolute_error</span><span class="p">(</span><span class="n">test_df</span><span class="p">[</span><span class="s1">&#39;rating&#39;</span><span class="p">],</span> <span class="n">preds</span><span class="p">)</span>
            <span class="n">user_map</span><span class="p">,</span> <span class="n">ndcg_array</span> <span class="o">=</span> <span class="n">ndcg_from_df</span><span class="p">(</span><span class="n">test_df</span><span class="p">,</span> <span class="n">preds</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">k_recs</span><span class="p">)</span>
            <span class="n">ndcg_mean</span><span class="p">,</span> <span class="n">ndcg_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">ndcg_array</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">ndcg_array</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">, &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;i_epoch&#39;</span><span class="p">]),</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;test_err&#39;</span><span class="p">,</span> <span class="s1">&#39;ndcg_mean&#39;</span><span class="p">,</span> <span class="s1">&#39;ndcg_std&#39;</span><span class="p">,</span> <span class="s1">&#39;dt&#39;</span><span class="p">]</span>
            <span class="n">sgd_epoch_results_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="n">cols</span><span class="p">]</span> <span class="o">=</span> <span class="n">test_err</span><span class="p">,</span> <span class="n">ndcg_mean</span><span class="p">,</span> <span class="n">ndcg_std</span><span class="p">,</span> <span class="n">dt</span>
        <span class="nb">print</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>i_fold=0, k=5: i_epoch=0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 
i_fold=0, k=10: i_epoch=0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 
i_fold=0, k=50: i_epoch=0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 
i_fold=1, k=5: i_epoch=0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 
i_fold=1, k=10: i_epoch=0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 
i_fold=1, k=50: i_epoch=0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 
i_fold=2, k=5: i_epoch=0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 
i_fold=2, k=10: i_epoch=0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 
i_fold=2, k=50: i_epoch=0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax0</span><span class="p">,</span> <span class="n">ax1</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">pointplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">sgd_epoch_results_df</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;i_epoch&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;test_err&#39;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax0</span><span class="p">)</span>
<span class="n">ax0</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;MAE&#39;</span><span class="p">)</span>
<span class="n">ax0</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="n">ax0</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.02</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;k =&#39;</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">pointplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">sgd_epoch_results_df</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;i_epoch&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;ndcg_mean&#39;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax1</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;NDCG@</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k_recs</span><span class="p">))</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Epoch&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">legend_</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>
<span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">hspace</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/T990000_movielens_eda_modeling_75_0.png" src="../_images/T990000_movielens_eda_modeling_75_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">lists_dict</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;i_fold&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_splits</span><span class="p">),</span>
    <span class="s1">&#39;learning_rate&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.001</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">],</span>
    <span class="s1">&#39;reg&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.001</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">],</span>
<span class="p">}</span>
<span class="n">k_recs</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">k</span> <span class="o">=</span> <span class="mi">50</span>
<span class="n">max_epochs</span> <span class="o">=</span> <span class="mi">30</span>
<span class="n">sgd_results_df</span> <span class="o">=</span> <span class="n">prep_results_df</span><span class="p">(</span><span class="n">lists_dict</span><span class="p">)</span>
<span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;test_err&#39;</span><span class="p">,</span> <span class="s1">&#39;ndcg_mean&#39;</span><span class="p">,</span> <span class="s1">&#39;ndcg_std&#39;</span><span class="p">,</span> <span class="s1">&#39;dt&#39;</span><span class="p">]</span>
<span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
    <span class="n">sgd_results_df</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
<span class="k">for</span> <span class="n">i_fold</span><span class="p">,</span> <span class="p">(</span><span class="n">train_inds</span><span class="p">,</span> <span class="n">test_inds</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">splits</span><span class="p">):</span>
    <span class="n">train_df</span><span class="p">,</span> <span class="n">test_df</span> <span class="o">=</span> <span class="n">ratings_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_inds</span><span class="p">],</span> <span class="n">ratings_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">test_inds</span><span class="p">]</span>
    <span class="n">sgd_results_i</span> <span class="o">=</span> <span class="n">sgd_results_df</span><span class="p">[</span><span class="n">sgd_results_df</span><span class="p">[</span><span class="s1">&#39;i_fold&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">i_fold</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">sgd_results_i</span><span class="p">[[</span><span class="s1">&#39;learning_rate&#39;</span><span class="p">,</span> <span class="s1">&#39;reg&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">learning_rate</span><span class="p">,</span> <span class="n">reg</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;learning_rate&#39;</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;reg&#39;</span><span class="p">]</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">SGDRecommender</span><span class="p">(</span><span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="n">learning_rate</span><span class="o">=</span><span class="n">learning_rate</span><span class="p">,</span> <span class="n">max_epochs</span><span class="o">=</span><span class="n">max_epochs</span><span class="p">,</span>
                               <span class="n">damping_factor</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                               <span class="n">user_reg</span><span class="o">=</span><span class="n">reg</span><span class="p">,</span> <span class="n">item_reg</span><span class="o">=</span><span class="n">reg</span><span class="p">,</span> <span class="n">user_bias_reg</span><span class="o">=</span><span class="n">reg</span><span class="p">,</span> <span class="n">item_bias_reg</span><span class="o">=</span><span class="n">reg</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;i_fold=</span><span class="si">{}</span><span class="s1">, learning_rate=</span><span class="si">{}</span><span class="s1">, reg=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i_fold</span><span class="p">,</span> <span class="n">learning_rate</span><span class="p">,</span> <span class="n">reg</span><span class="p">))</span>
        <span class="n">t1</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">preds</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_df</span><span class="p">)</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_df</span><span class="p">[[</span><span class="s1">&#39;user_id&#39;</span><span class="p">,</span> <span class="s1">&#39;item_id&#39;</span><span class="p">]])</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">t1</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
        <span class="n">test_err</span> <span class="o">=</span> <span class="n">mean_absolute_error</span><span class="p">(</span><span class="n">test_df</span><span class="p">[</span><span class="s1">&#39;rating&#39;</span><span class="p">],</span> <span class="n">preds</span><span class="p">)</span>
        <span class="n">user_map</span><span class="p">,</span> <span class="n">ndcg_array</span> <span class="o">=</span> <span class="n">ndcg_from_df</span><span class="p">(</span><span class="n">test_df</span><span class="p">,</span> <span class="n">preds</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">k_recs</span><span class="p">)</span>
        <span class="n">ndcg_mean</span><span class="p">,</span> <span class="n">ndcg_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">ndcg_array</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">ndcg_array</span><span class="p">)</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;test_err&#39;</span><span class="p">,</span> <span class="s1">&#39;ndcg_mean&#39;</span><span class="p">,</span> <span class="s1">&#39;ndcg_std&#39;</span><span class="p">,</span> <span class="s1">&#39;dt&#39;</span><span class="p">]</span>
        <span class="n">sgd_results_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="n">cols</span><span class="p">]</span> <span class="o">=</span> <span class="n">test_err</span><span class="p">,</span> <span class="n">ndcg_mean</span><span class="p">,</span> <span class="n">ndcg_std</span><span class="p">,</span> <span class="n">dt</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>i_fold=0, learning_rate=0.001, reg=0.0
i_fold=0, learning_rate=0.001, reg=0.001
i_fold=0, learning_rate=0.001, reg=0.01
i_fold=0, learning_rate=0.01, reg=0.0
i_fold=0, learning_rate=0.01, reg=0.001
i_fold=0, learning_rate=0.01, reg=0.01
i_fold=1, learning_rate=0.001, reg=0.0
i_fold=1, learning_rate=0.001, reg=0.001
i_fold=1, learning_rate=0.001, reg=0.01
i_fold=1, learning_rate=0.01, reg=0.0
i_fold=1, learning_rate=0.01, reg=0.001
i_fold=1, learning_rate=0.01, reg=0.01
i_fold=2, learning_rate=0.001, reg=0.0
i_fold=2, learning_rate=0.001, reg=0.001
i_fold=2, learning_rate=0.001, reg=0.01
i_fold=2, learning_rate=0.01, reg=0.0
i_fold=2, learning_rate=0.01, reg=0.001
i_fold=2, learning_rate=0.01, reg=0.01
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax0</span><span class="p">,</span> <span class="n">ax1</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">pointplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">sgd_results_df</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;reg&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;test_err&#39;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;learning_rate&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax0</span><span class="p">)</span>
<span class="n">ax0</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;MAE&#39;</span><span class="p">)</span>
<span class="n">ax0</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="n">ax0</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.02</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Learning Rate&#39;</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">pointplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">sgd_results_df</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;reg&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;ndcg_mean&#39;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;learning_rate&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax1</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;NDCG@</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k_recs</span><span class="p">))</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Regularization Parameter&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">legend_</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>
<span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">hspace</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/T990000_movielens_eda_modeling_77_0.png" src="../_images/T990000_movielens_eda_modeling_77_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">reg</span> <span class="o">=</span> <span class="mf">0.01</span>
<span class="n">best_sgd_model</span> <span class="o">=</span> <span class="n">SGDRecommender</span><span class="p">(</span><span class="n">k</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">max_epochs</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">damping_factor</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                                <span class="n">user_reg</span><span class="o">=</span><span class="n">reg</span><span class="p">,</span> <span class="n">item_reg</span><span class="o">=</span><span class="n">reg</span><span class="p">,</span> <span class="n">user_bias_reg</span><span class="o">=</span><span class="n">reg</span><span class="p">,</span> <span class="n">item_bias_reg</span><span class="o">=</span><span class="n">reg</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="compare-the-top-methods-of-each-category">
<h3>Compare the top methods of each category<a class="headerlink" href="#compare-the-top-methods-of-each-category" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">final_models</span> <span class="o">=</span> <span class="p">[</span><span class="n">best_user_model</span><span class="p">,</span> <span class="n">best_item_model</span><span class="p">,</span> <span class="n">best_als_model</span><span class="p">,</span> <span class="n">best_sgd_model</span><span class="p">]</span>
<span class="n">final_model_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="s1">&#39;item&#39;</span><span class="p">,</span> <span class="s1">&#39;als&#39;</span><span class="p">,</span> <span class="s1">&#39;sgd&#39;</span><span class="p">]</span>
<span class="n">final_results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="s1">&#39;i_fold&#39;</span><span class="p">,</span> <span class="s1">&#39;test_err&#39;</span><span class="p">,</span> <span class="s1">&#39;ndcg_mean&#39;</span><span class="p">,</span> <span class="s1">&#39;ndcg_std&#39;</span><span class="p">,</span> <span class="s1">&#39;dt&#39;</span><span class="p">])</span>
<span class="k">for</span> <span class="n">model</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">final_models</span><span class="p">,</span> <span class="n">final_model_names</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">i_fold</span><span class="p">,</span> <span class="p">(</span><span class="n">train_inds</span><span class="p">,</span> <span class="n">test_inds</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">splits</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;i_fold=</span><span class="si">{}</span><span class="s2">, model=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i_fold</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
        <span class="n">train_df</span><span class="p">,</span> <span class="n">test_df</span> <span class="o">=</span> <span class="n">ratings_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_inds</span><span class="p">],</span> <span class="n">ratings_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">test_inds</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;als&#39;</span><span class="p">,</span> <span class="s1">&#39;sgd&#39;</span><span class="p">]:</span>
            <span class="n">model</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">t1</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">preds</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_df</span><span class="p">)</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_df</span><span class="p">[[</span><span class="s1">&#39;user_id&#39;</span><span class="p">,</span> <span class="s1">&#39;item_id&#39;</span><span class="p">]])</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">t1</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
        <span class="n">test_err</span> <span class="o">=</span> <span class="n">mean_absolute_error</span><span class="p">(</span><span class="n">test_df</span><span class="p">[</span><span class="s1">&#39;rating&#39;</span><span class="p">],</span> <span class="n">preds</span><span class="p">)</span>
        <span class="n">user_map</span><span class="p">,</span> <span class="n">ndcg_array</span> <span class="o">=</span> <span class="n">ndcg_from_df</span><span class="p">(</span><span class="n">test_df</span><span class="p">,</span> <span class="n">preds</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">ndcg_mean</span><span class="p">,</span> <span class="n">ndcg_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">ndcg_array</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">ndcg_array</span><span class="p">)</span>
        <span class="n">final_results</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">final_results</span><span class="p">),</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">name</span><span class="p">,</span> <span class="n">i_fold</span><span class="p">,</span> <span class="n">test_err</span><span class="p">,</span> <span class="n">ndcg_mean</span><span class="p">,</span> <span class="n">ndcg_std</span><span class="p">,</span> <span class="n">dt</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>i_fold=0, model=user
i_fold=1, model=user
i_fold=2, model=user
i_fold=0, model=item
i_fold=1, model=item
i_fold=2, model=item
i_fold=0, model=als
i_fold=1, model=als
i_fold=2, model=als
i_fold=0, model=sgd
i_fold=1, model=sgd
i_fold=2, model=sgd
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax0</span><span class="p">,</span> <span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">stripplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">final_results</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;test_err&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax0</span><span class="p">,</span> <span class="n">jitter</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">stripplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">final_results</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;ndcg_mean&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax1</span><span class="p">,</span> <span class="n">jitter</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">stripplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">final_results</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;dt&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax2</span><span class="p">,</span> <span class="n">jitter</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">ax0</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;MAE&#39;</span><span class="p">)</span>
<span class="n">ax0</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;NDCG@3&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;time [$s$]&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">yscale</span><span class="o">=</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">100</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">ax0</span><span class="o">.</span><span class="n">collections</span><span class="p">,</span> <span class="n">sizes</span><span class="o">=</span><span class="p">[</span><span class="mi">50</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">ax1</span><span class="o">.</span><span class="n">collections</span><span class="p">,</span> <span class="n">sizes</span><span class="o">=</span><span class="p">[</span><span class="mi">50</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">ax2</span><span class="o">.</span><span class="n">collections</span><span class="p">,</span> <span class="n">sizes</span><span class="o">=</span><span class="p">[</span><span class="mi">50</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/T990000_movielens_eda_modeling_81_0.png" src="../_images/T990000_movielens_eda_modeling_81_0.png" />
</div>
</div>
</div>
<div class="section" id="fetching-posters">
<h3>Fetching posters<a class="headerlink" href="#fetching-posters" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">n_splits</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">skf</span> <span class="o">=</span> <span class="n">StratifiedKFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="n">n_splits</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">splits</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">(</span><span class="n">train_inds</span><span class="p">,</span> <span class="n">test_inds</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">train_inds</span><span class="p">,</span> <span class="n">test_inds</span> <span class="ow">in</span> <span class="n">skf</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">ratings_df</span><span class="p">,</span> <span class="n">ratings_df</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">])</span>
<span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/usr/local/lib/python3.6/dist-packages/sklearn/model_selection/_split.py:296: FutureWarning: Setting a random_state has no effect since shuffle is False. This will raise an error in 0.24. You should leave random_state to its default (None), or set shuffle=True.
  FutureWarning
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">baseline_algo</span> <span class="o">=</span> <span class="n">DampedUserMovieBaselineModel</span><span class="p">(</span><span class="n">damping_factor</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">reg</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="n">models_dict</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;user&#39;</span><span class="p">:</span> <span class="n">KNNRecommender</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">baseline_algo</span><span class="o">=</span><span class="n">baseline_algo</span><span class="p">),</span>
    <span class="s1">&#39;item&#39;</span><span class="p">:</span> <span class="n">KNNRecommender</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;item&#39;</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">baseline_algo</span><span class="o">=</span><span class="n">baseline_algo</span><span class="p">),</span>
    <span class="s1">&#39;als&#39;</span><span class="p">:</span> <span class="n">ALSRecommender</span><span class="p">(</span><span class="n">k</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">lmbda</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">max_epochs</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">baseline_algo</span><span class="o">=</span><span class="n">baseline_algo</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
    <span class="s1">&#39;sgd&#39;</span><span class="p">:</span> <span class="n">SGDRecommender</span><span class="p">(</span><span class="n">k</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">max_epochs</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">damping_factor</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                          <span class="n">user_reg</span><span class="o">=</span><span class="n">reg</span><span class="p">,</span> <span class="n">item_reg</span><span class="o">=</span><span class="n">reg</span><span class="p">,</span> <span class="n">user_bias_reg</span><span class="o">=</span><span class="n">reg</span><span class="p">,</span> <span class="n">item_bias_reg</span><span class="o">=</span><span class="n">reg</span><span class="p">,</span>
                          <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_poster_url</span><span class="p">(</span><span class="n">movieId</span><span class="p">,</span> <span class="n">base_url</span><span class="p">,</span> <span class="n">links_df</span><span class="p">,</span> <span class="n">api_key</span><span class="p">):</span>
    <span class="n">movieId</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">movieId</span><span class="p">))</span>
    <span class="c1"># Get IMDB movie ID</span>
    <span class="n">tmdbId</span> <span class="o">=</span> <span class="n">links_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">movieId</span><span class="p">,</span> <span class="s1">&#39;tmdbId&#39;</span><span class="p">]</span>
    
    <span class="c1"># Query themoviedb.org API for movie poster path.</span>
    <span class="n">movie_url</span> <span class="o">=</span> <span class="s1">&#39;http://api.themoviedb.org/3/movie/</span><span class="si">{:}</span><span class="s1">/images&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tmdbId</span><span class="p">)</span>
    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Accept&#39;</span><span class="p">:</span> <span class="s1">&#39;application/json&#39;</span><span class="p">}</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;api_key&#39;</span><span class="p">:</span> <span class="n">api_key</span><span class="p">}</span> 
    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">movie_url</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">payload</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
    <span class="n">file_path</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)[</span><span class="s1">&#39;posters&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;file_path&#39;</span><span class="p">]</span>
        
    <span class="k">return</span> <span class="n">base_url</span> <span class="o">+</span> <span class="n">file_path</span>

<span class="k">def</span> <span class="nf">display_posters</span><span class="p">(</span><span class="n">movieIds</span><span class="p">,</span> <span class="n">base_url</span><span class="p">,</span> <span class="n">links_df</span><span class="p">,</span> <span class="n">api_key</span><span class="p">):</span>
    <span class="n">poster_urls</span> <span class="o">=</span> <span class="p">[</span><span class="n">get_poster_url</span><span class="p">(</span><span class="n">movieId</span><span class="p">,</span> <span class="n">base_url</span><span class="p">,</span> <span class="n">links_df</span><span class="p">,</span> <span class="n">api_key</span><span class="p">)</span> <span class="k">for</span> <span class="n">movieId</span> <span class="ow">in</span> <span class="n">movieIds</span><span class="p">]</span>
    <span class="n">TABLE</span> <span class="o">=</span> <span class="s2">&quot;&lt;table style=&#39;width: 100%; align: center;&#39;&gt;&lt;tr&gt;</span><span class="si">{}</span><span class="s2">&lt;/tr&gt;&lt;/table&gt;&quot;</span>
    <span class="n">CELL</span> <span class="o">=</span> <span class="s2">&quot;&lt;td align=&#39;center&#39;&gt;&lt;img style=&#39;float: left; width: 120px&#39; src=</span><span class="si">{}</span><span class="s2">&gt;&lt;/td&gt;&quot;</span>
    <span class="n">table</span> <span class="o">=</span> <span class="n">TABLE</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">CELL</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">url</span><span class="p">)</span> <span class="k">for</span> <span class="n">url</span> <span class="ow">in</span> <span class="n">poster_urls</span><span class="p">]))</span>
    <span class="n">display</span><span class="p">(</span><span class="n">HTML</span><span class="p">(</span><span class="n">table</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">recommend</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">train_df</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">pretrained</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
    <span class="n">train_df</span> <span class="o">=</span> <span class="n">train_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">train_df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="s1">&#39;item&#39;</span><span class="p">,</span> <span class="s1">&#39;rating&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">pretrained</span><span class="p">:</span>
        <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_df</span><span class="p">)</span>
    <span class="n">seen_movies</span> <span class="o">=</span> <span class="n">train_df</span><span class="p">[</span><span class="n">train_df</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">user</span><span class="p">][</span><span class="s1">&#39;item&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
    <span class="n">unseen_movies</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">train_df</span><span class="p">[</span><span class="s1">&#39;item&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">seen_movies</span><span class="p">))</span>
    <span class="n">user_movie_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;user&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">user</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">unseen_movies</span><span class="p">),</span> <span class="s1">&#39;item&#39;</span><span class="p">:</span> <span class="n">unseen_movies</span><span class="p">})</span>
    <span class="n">user_movie_df</span> <span class="o">=</span> <span class="n">user_movie_df</span><span class="p">[[</span><span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="s1">&#39;item&#39;</span><span class="p">]]</span>
    <span class="n">user_movie_df</span><span class="p">[</span><span class="s1">&#39;pred&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">user_movie_df</span><span class="p">)</span>
    <span class="n">user_movie_df</span> <span class="o">=</span> <span class="n">user_movie_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;pred&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">movies</span><span class="p">,</span> <span class="n">preds</span> <span class="o">=</span> <span class="n">user_movie_df</span><span class="p">[[</span><span class="s1">&#39;item&#39;</span><span class="p">,</span> <span class="s1">&#39;pred&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">[:</span><span class="n">k</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">T</span>
    <span class="k">return</span> <span class="n">movies</span><span class="p">,</span> <span class="n">preds</span>
</pre></div>
</div>
</div>
</div>
<p>Movies this user likes</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">user</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">train_inds</span><span class="p">,</span> <span class="n">test_inds</span> <span class="o">=</span> <span class="n">splits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">train_df</span><span class="p">,</span> <span class="n">test_df</span> <span class="o">=</span> <span class="n">ratings_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_inds</span><span class="p">],</span> <span class="n">ratings_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">test_inds</span><span class="p">]</span>
<span class="n">favorite_movies</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">train_df</span><span class="p">[</span><span class="n">train_df</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">user</span><span class="p">]</span>
    <span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;rating&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="o">.</span><span class="n">values</span>
<span class="p">)</span>
<span class="n">display_posters</span><span class="p">(</span><span class="n">favorite_movies</span><span class="p">,</span> <span class="n">base_url</span><span class="p">,</span> <span class="n">links_df</span><span class="p">,</span> <span class="n">api_key</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><table style='width: 100%; align: center;'><tr><td align='center'><img style='float: left; width: 120px' src=http://image.tmdb.org/t/p/w185/nkIhoT6aLYnE5KzGZcxF2UGdo7e.jpg></td><td align='center'><img style='float: left; width: 120px' src=http://image.tmdb.org/t/p/w185/n94J8TmPQyOOir1WZHzO6QzUIE5.jpg></td><td align='center'><img style='float: left; width: 120px' src=http://image.tmdb.org/t/p/w185/e8ie1x22wFEo63LQBbpBDqIH4oY.jpg></td><td align='center'><img style='float: left; width: 120px' src=http://image.tmdb.org/t/p/w185/9i3plLl89DHMz7mahksDaAo7HIS.jpg></td><td align='center'><img style='float: left; width: 120px' src=http://image.tmdb.org/t/p/w185/siDIocmgWcLxc0nInbhnjamPplu.jpg></td></tr></table></div></div>
</div>
<p>Recommended movies</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">models_dict</span><span class="p">[</span><span class="s1">&#39;als&#39;</span><span class="p">]</span>
<span class="n">movies</span><span class="p">,</span> <span class="n">preds</span> <span class="o">=</span> <span class="n">recommend</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">train_df</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">pretrained</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="n">display_posters</span><span class="p">(</span><span class="n">movies</span><span class="p">,</span> <span class="n">base_url</span><span class="p">,</span> <span class="n">links_df</span><span class="p">,</span> <span class="n">api_key</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><table style='width: 100%; align: center;'><tr><td align='center'><img style='float: left; width: 120px' src=http://image.tmdb.org/t/p/w185/q6y0Go1tsGEsmtFryDOJo3dEmqu.jpg></td><td align='center'><img style='float: left; width: 120px' src=http://image.tmdb.org/t/p/w185/p9QsNTeWLxyvixKeXDC0YU5Z7ss.jpg></td><td align='center'><img style='float: left; width: 120px' src=http://image.tmdb.org/t/p/w185/qtwipjmSypSQuSvz5BNirSxZqbg.jpg></td><td align='center'><img style='float: left; width: 120px' src=http://image.tmdb.org/t/p/w185/kvQl6sJyplWRQ0BGp0E8kBUQKO8.jpg></td><td align='center'><img style='float: left; width: 120px' src=http://image.tmdb.org/t/p/w185/qysVy8is0no4YFadX0bUB71GpVc.jpg></td></tr></table></div></div>
</div>
</div>
</div>
<div class="section" id="non-negative-matrix-factorization-nmf-scikit-learn-package">
<h2>Non-Negative Matrix Factorization (NMF, scikit-learn package)<a class="headerlink" href="#non-negative-matrix-factorization-nmf-scikit-learn-package" title="Permalink to this headline">¶</a></h2>
<p>Find two non-negative matrices (W, H) whose product approximates the non-negative matrix R.
NOTE: since the values of matrix R MUST be all positive, we CAN’T do mean-centering normalization here (although this would improve the accuracy).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.decomposition</span> <span class="kn">import</span> <span class="n">NMF</span>

<span class="n">nmf_model</span> <span class="o">=</span> <span class="n">NMF</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>     <span class="c1"># starts with 20 latents factors</span>

<span class="c1"># Matrix factorization               # V ~ W.H  (Find two non-negative matrices (W, H) whose product approximates the non- negative matrix X. )</span>
<span class="n">nmf_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">rating_matrix</span><span class="p">)</span>                     <span class="c1"># R can be array-like or sparse, here it is array-like (dense)</span>
<span class="n">Theta</span> <span class="o">=</span> <span class="n">nmf_model</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">rating_matrix</span><span class="p">)</span>       <span class="c1"># user latent factors (= W, called the features matrix)</span>
<span class="n">M</span> <span class="o">=</span> <span class="n">nmf_model</span><span class="o">.</span><span class="n">components_</span><span class="o">.</span><span class="n">T</span>          <span class="c1"># item latent factors (= H.T) (H is called the coefficient matrix)</span>

<span class="c1"># Making the predictions</span>
<span class="n">R_pred</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Theta</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>              <span class="c1"># See http://stackoverflow.com/questions/24739121/nonnegative-matrix-factorization-in-sklearn</span>
<span class="n">R_pred</span> <span class="o">=</span> <span class="n">R_pred</span><span class="o">.</span><span class="n">T</span>                    <span class="c1"># same dimensions as R</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Item features - M:&#39;</span><span class="p">,</span> <span class="n">M</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;User features - Theta:&#39;</span><span class="p">,</span> <span class="n">Theta</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;R ~ M * Theta.T:&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">R_pred</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">R_pred</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Item features - M: (1682, 20)
User features - Theta: (943, 20)

R ~ M * Theta.T:
[[4.5  2.06 1.41 ... 0.   0.02 0.03]
 [2.34 0.03 0.17 ... 0.02 0.   0.  ]
 [0.19 0.02 0.1  ... 0.01 0.   0.  ]
 ...
 [1.98 0.05 0.3  ... 0.   0.   0.  ]
 [1.39 0.1  0.03 ... 0.01 0.01 0.  ]
 [1.6  2.24 1.38 ... 0.   0.03 0.02]]
(943, 1682)
</pre></div>
</div>
</div>
</div>
<p>Estimating the error (RMSE) before tuning the hyperparameters</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">mean_squared_error</span>

<span class="k">def</span> <span class="nf">get_rmse</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span class="n">actual</span><span class="p">):</span>
    <span class="n">pred</span> <span class="o">=</span> <span class="n">pred</span><span class="p">[</span><span class="n">actual</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>     <span class="c1"># Ignore nonzero terms</span>
    <span class="n">actual</span> <span class="o">=</span> <span class="n">actual</span><span class="p">[</span><span class="n">actual</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="c1"># Ignore nonzero terms</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mean_squared_error</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span class="n">actual</span><span class="p">))</span>

<span class="n">get_rmse</span><span class="p">(</span><span class="n">R_pred</span><span class="p">,</span> <span class="n">rating_matrix</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2.2271459436219065
</pre></div>
</div>
</div>
</div>
<p>When the predictive model is satisfying, save it to a file</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pickle</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;nnmf_sklearn.pickle&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
  <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">nmf_model</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Item recommendation for an active user (given its rating history)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">make_recommendation_activeuser</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">prediction</span><span class="p">,</span> <span class="n">user_idx</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
  <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">  user_idx ...... select an active user</span>
<span class="sd">  k  ............ number of movies to recommend</span>
<span class="sd">  &#39;&#39;&#39;</span>
  <span class="n">rated_items_df_user</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">R</span><span class="p">)</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">user_idx</span><span class="p">,</span> <span class="p">:]</span>                 <span class="c1"># get the list of actual ratings of user_idx (seen movies)</span>
  <span class="n">user_prediction_df_user</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">prediction</span><span class="p">)</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">user_idx</span><span class="p">,:]</span>     <span class="c1"># get the list of predicted ratings of user_idx (unseen movies)</span>
  <span class="n">reco_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">rated_items_df_user</span><span class="p">,</span> <span class="n">user_prediction_df_user</span><span class="p">,</span> <span class="n">item_info</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>   <span class="c1"># merge both lists with the movie&#39;s title</span>
  <span class="n">reco_df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;rating&#39;</span><span class="p">,</span><span class="s1">&#39;prediction&#39;</span><span class="p">,</span><span class="s1">&#39;title&#39;</span><span class="p">]</span>

  <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Preferred movies for user #&#39;</span><span class="p">,</span> <span class="n">user_idx</span><span class="p">)</span>
  <span class="nb">print</span><span class="p">(</span><span class="n">reco_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;rating&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)[:</span><span class="n">k</span><span class="p">])</span>             <span class="c1"># returns the 5 seen movies with the best actual ratings</span>
  <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Recommended movies for user #&#39;</span><span class="p">,</span> <span class="n">user_idx</span><span class="p">)</span>
  <span class="n">reco_df</span> <span class="o">=</span> <span class="n">reco_df</span><span class="p">[</span> <span class="n">reco_df</span><span class="p">[</span><span class="s1">&#39;rating&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">]</span>
  <span class="nb">print</span><span class="p">(</span><span class="n">reco_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;prediction&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)[:</span><span class="n">k</span><span class="p">])</span>      <span class="c1"># returns the 5 unseen movies with the best predicted ratings</span>
  <span class="nb">print</span><span class="p">()</span>
  <span class="nb">print</span><span class="p">()</span>

<span class="n">make_recommendation_activeuser</span><span class="p">(</span><span class="n">rating_matrix</span><span class="p">,</span> <span class="n">R_pred</span><span class="p">,</span> <span class="n">user_idx</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="n">make_recommendation_activeuser</span><span class="p">(</span><span class="n">rating_matrix</span><span class="p">,</span> <span class="n">R_pred</span><span class="p">,</span> <span class="n">user_idx</span><span class="o">=</span><span class="mi">130</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Preferred movies for user # 50
     rating  prediction title
171     5.0    1.432029   NaN
180     5.0    2.277069   NaN
172     5.0    1.017789   NaN
49      5.0    2.753084   NaN
143     5.0    0.695904   NaN
Recommended movies for user # 50
     rating  prediction title
55      0.0    1.527510   NaN
173     0.0    1.494889   NaN
256     0.0    1.303158   NaN
97      0.0    1.295984   NaN
11      0.0    1.275150   NaN


Preferred movies for user # 130
     rating  prediction title
285     5.0    4.312692   NaN
312     5.0    1.897457   NaN
535     5.0    0.144333   NaN
99      5.0    4.945202   NaN
13      5.0    3.207845   NaN
Recommended movies for user # 130
     rating  prediction title
474     0.0    2.188917   NaN
12      0.0    2.137406   NaN
115     0.0    2.114974   NaN
282     0.0    2.080887   NaN
236     0.0    1.831747   NaN
</pre></div>
</div>
</div>
</div>
<p>Item recommendation for a new user (wih rating history)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># creating a new user profile:</span>
<span class="n">my_ratings</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1682</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
<span class="n">my_ratings</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span> 
<span class="n">my_ratings</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span> 
<span class="n">my_ratings</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> 
<span class="n">my_ratings</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">my_ratings</span><span class="p">[</span><span class="mi">27</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">my_ratings</span><span class="p">[</span><span class="mi">34</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">my_ratings</span><span class="p">[</span><span class="mi">49</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">my_ratings</span><span class="p">[</span><span class="mi">55</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">my_ratings</span><span class="p">[</span><span class="mi">61</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">my_ratings</span><span class="p">[</span><span class="mi">68</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">my_ratings</span><span class="p">[</span><span class="mi">70</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">my_ratings</span><span class="p">[</span><span class="mi">81</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">my_ratings</span><span class="p">[</span><span class="mi">87</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">my_ratings</span><span class="p">[</span><span class="mi">94</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">my_ratings</span><span class="p">[</span><span class="mi">120</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">my_ratings</span><span class="p">[</span><span class="mi">171</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">my_ratings</span><span class="p">[</span><span class="mi">173</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">my_ratings</span><span class="p">[</span><span class="mi">175</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">my_ratings</span><span class="p">[</span><span class="mi">182</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">my_ratings</span><span class="p">[</span><span class="mi">194</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">my_ratings</span><span class="p">[</span><span class="mi">203</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">my_ratings</span><span class="p">[</span><span class="mi">209</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">my_ratings</span><span class="p">[</span><span class="mi">221</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">my_ratings</span><span class="p">[</span><span class="mi">234</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">my_ratings</span><span class="p">[</span><span class="mi">312</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">my_ratings</span><span class="p">[</span><span class="mi">317</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">my_ratings</span><span class="p">[</span><span class="mi">322</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">my_ratings</span><span class="p">[</span><span class="mi">342</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">my_ratings</span><span class="p">[</span><span class="mi">378</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">my_ratings</span><span class="p">[</span><span class="mi">379</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">my_ratings</span><span class="p">[</span><span class="mi">392</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">my_ratings</span><span class="p">[</span><span class="mi">404</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">my_ratings</span><span class="p">[</span><span class="mi">422</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">my_ratings</span><span class="p">[</span><span class="mi">542</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">my_ratings</span><span class="p">)):</span>
  <span class="nb">print</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">my_ratings</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">item_info</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;title&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Adding a new user to the R matrix </span>
<span class="n">newR</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">rating_matrix</span><span class="p">,</span> <span class="n">my_ratings</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>

<span class="c1"># Recompute the Matrix factorization</span>
<span class="n">newTheta</span> <span class="o">=</span> <span class="n">estimator</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">newR</span><span class="p">)</span>  
<span class="n">newX</span> <span class="o">=</span> <span class="n">estimator</span><span class="o">.</span><span class="n">components_</span><span class="o">.</span><span class="n">T</span>       

<span class="c1"># Making the predictions</span>
<span class="n">newR_pred</span> <span class="o">=</span> <span class="n">newX</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">newTheta</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

<span class="c1"># clipping values                                                    </span>
<span class="n">newR_pred</span><span class="p">[</span><span class="n">newR_pred</span> <span class="o">&gt;</span> <span class="n">R</span><span class="o">.</span><span class="n">max</span><span class="p">()]</span> <span class="o">=</span> <span class="n">R</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>           <span class="c1"># clips ratings above 5             </span>
<span class="n">newR_pred</span><span class="p">[</span><span class="n">newR_pred</span> <span class="o">&lt;</span> <span class="n">R</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">R</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">+</span><span class="mi">1</span>    <span class="c1"># clips ratings below 1</span>

<span class="c1"># Making the recommendation</span>
<span class="n">make_recommendation_activeuser</span><span class="p">(</span><span class="n">newR</span><span class="p">,</span> <span class="n">newR_pred</span><span class="p">,</span> <span class="n">user_idx</span><span class="o">=</span><span class="n">newR</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Item recommendation for a new user (wihout rating history)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">make_recommendation_newuser</span><span class="p">(</span><span class="n">item_sim</span><span class="p">,</span> <span class="n">item_idx</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
  <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">  item_idx ...... select an item</span>
<span class="sd">  k  ............ number of movies to recommend</span>
<span class="sd">  &#39;&#39;&#39;</span>
  <span class="n">reco_item_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">item_sim</span><span class="p">)</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">item_idx</span><span class="p">,</span> <span class="p">:]</span> 
  <span class="n">reco_item_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">reco_item_df</span><span class="p">,</span> <span class="n">item_info</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>   <span class="c1"># merge list with the movie&#39;s title</span>
  <span class="n">reco_item_df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;similarity&#39;</span><span class="p">,</span><span class="s1">&#39;title&#39;</span><span class="p">]</span>
  <span class="n">reco_item_df</span> <span class="o">=</span> <span class="n">reco_item_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;similarity&#39;</span><span class="p">,</span><span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

  <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Recommended movies for a new user (without rating history), currently looking at movie:&#39;</span><span class="p">,</span> <span class="n">reco_item_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;title&#39;</span><span class="p">])</span>
  <span class="nb">print</span><span class="p">(</span><span class="n">reco_item_df</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>          <span class="c1"># returns the 5 movies the most similar to item_idx</span>
  <span class="nb">print</span><span class="p">()</span>

<span class="kn">from</span> <span class="nn">sklearn.metrics.pairwise</span> <span class="kn">import</span> <span class="n">cosine_similarity</span>
<span class="n">item_sim</span> <span class="o">=</span> <span class="n">cosine_similarity</span><span class="p">(</span><span class="n">M</span><span class="p">)</span>                      <span class="c1"># Use item features matrix to compute movie-to-movie similarity matrices</span>
<span class="n">make_recommendation_newuser</span><span class="p">(</span><span class="n">item_sim</span><span class="p">,</span> <span class="n">item_idx</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="n">make_recommendation_newuser</span><span class="p">(</span><span class="n">item_sim</span><span class="p">,</span> <span class="n">item_idx</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="n">make_recommendation_newuser</span><span class="p">(</span><span class="n">item_sim</span><span class="p">,</span> <span class="n">item_idx</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="hybrid-using-processed-dataset">
<h2>Hybrid (using processed dataset)<a class="headerlink" href="#hybrid-using-processed-dataset" title="Permalink to this headline">¶</a></h2>
<ol class="simple">
<li><p>Run Content based filtering and determine the movies which we want to recommend to the user.</p></li>
<li><p>Filter and sort the recommendations of CF using SVD predicted ratings.</p></li>
</ol>
<p>Setup</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>!git clone https://github.com/vivdalal/movie-recommender-system.git

from math import sqrt
import pandas as pd
import numpy as np
import seaborn as sns
from matplotlib import pyplot as plt
from sklearn.feature_extraction.text import TfidfVectorizer
from sklearn.metrics.pairwise import linear_kernel

# Reading ratings file
hratings = pd.read_csv(&#39;movie-recommender-system/ratings.csv&#39;, sep=&#39;,&#39;, encoding=&#39;latin-1&#39;, usecols=[&#39;userId&#39;,&#39;movieId&#39;,&#39;rating&#39;,&#39;timestamp&#39;])
display(ratings.head())

# Reading movies file
hmovies = pd.read_csv(&#39;movie-recommender-system/movies.csv&#39;, sep=&#39;,&#39;, encoding=&#39;latin-1&#39;, usecols=[&#39;movieId&#39;,&#39;title&#39;,&#39;genres&#39;])
display(movies.head())
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>fatal: destination path &#39;movie-recommender-system&#39; already exists and is not an empty directory.
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>userId</th>
      <th>movieId</th>
      <th>rating</th>
      <th>timestamp</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>1</td>
      <td>4.0</td>
      <td>964982703</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>3</td>
      <td>4.0</td>
      <td>964981247</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1</td>
      <td>6</td>
      <td>4.0</td>
      <td>964982224</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1</td>
      <td>47</td>
      <td>5.0</td>
      <td>964983815</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1</td>
      <td>50</td>
      <td>5.0</td>
      <td>964982931</td>
    </tr>
  </tbody>
</table>
</div></div><div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>movieId</th>
      <th>title</th>
      <th>genres</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>Toy Story (1995)</td>
      <td>Adventure|Animation|Children|Comedy|Fantasy</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2</td>
      <td>Jumanji (1995)</td>
      <td>Adventure|Children|Fantasy</td>
    </tr>
    <tr>
      <th>2</th>
      <td>3</td>
      <td>Grumpier Old Men (1995)</td>
      <td>Comedy|Romance</td>
    </tr>
    <tr>
      <th>3</th>
      <td>4</td>
      <td>Waiting to Exhale (1995)</td>
      <td>Comedy|Drama|Romance</td>
    </tr>
    <tr>
      <th>4</th>
      <td>5</td>
      <td>Father of the Bride Part II (1995)</td>
      <td>Comedy</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Content-based model</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">tfihmovies_genres</span> <span class="o">=</span> <span class="n">TfidfVectorizer</span><span class="p">(</span><span class="n">token_pattern</span> <span class="o">=</span> <span class="s1">&#39;[a-zA-Z0-9\-]+&#39;</span><span class="p">)</span>
<span class="n">hmovies</span><span class="p">[</span><span class="s1">&#39;genres&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hmovies</span><span class="p">[</span><span class="s1">&#39;genres&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">to_replace</span><span class="o">=</span><span class="s2">&quot;(no genres listed)&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
<span class="n">tfihmovies_genres_matrix</span> <span class="o">=</span> <span class="n">tfihmovies_genres</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">hmovies</span><span class="p">[</span><span class="s1">&#39;genres&#39;</span><span class="p">])</span>
<span class="n">cosine_sim_movies</span> <span class="o">=</span> <span class="n">linear_kernel</span><span class="p">(</span><span class="n">tfihmovies_genres_matrix</span><span class="p">,</span> <span class="n">tfihmovies_genres_matrix</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">get_recommendations_based_on_genres</span><span class="p">(</span><span class="n">movie_title</span><span class="p">,</span> <span class="n">cosine_sim_movies</span><span class="o">=</span><span class="n">cosine_sim_movies</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates top 2 movies to recommend based on given movie titles genres. </span>
<span class="sd">    :param movie_title: title of movie to be taken for base of recommendation</span>
<span class="sd">    :param cosine_sim_movies: cosine similarity between movies </span>
<span class="sd">    :return: Titles of movies recommended to user</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Get the index of the movie that matches the title</span>
    <span class="n">idx_movie</span> <span class="o">=</span> <span class="n">hmovies</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">hmovies</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="n">movie_title</span><span class="p">])]</span>
    <span class="n">idx_movie</span> <span class="o">=</span> <span class="n">idx_movie</span><span class="o">.</span><span class="n">index</span>
    
    <span class="c1"># Get the pairwsie similarity scores of all movies with that movie</span>
    <span class="n">sim_scores_movies</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="n">cosine_sim_movies</span><span class="p">[</span><span class="n">idx_movie</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span>
    
    <span class="c1"># Sort the movies based on the similarity scores</span>
    <span class="n">sim_scores_movies</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">sim_scores_movies</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Get the scores of the 10 most similar movies</span>
    <span class="n">sim_scores_movies</span> <span class="o">=</span> <span class="n">sim_scores_movies</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
    
    <span class="c1"># Get the movie indices</span>
    <span class="n">movie_indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">sim_scores_movies</span><span class="p">]</span>
    
    <span class="c1"># Return the top 2 most similar movies</span>
    <span class="k">return</span> <span class="n">hmovies</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">movie_indices</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">get_recommendation_content_model</span><span class="p">(</span><span class="n">userId</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates top movies to be recommended to user based on movie user has watched.  </span>
<span class="sd">    :param userId: userid of user</span>
<span class="sd">    :return: Titles of movies recommended to user</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">recommended_movie_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">movie_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">df_rating_filtered</span> <span class="o">=</span> <span class="n">hratings</span><span class="p">[</span><span class="n">hratings</span><span class="p">[</span><span class="s2">&quot;userId&quot;</span><span class="p">]</span><span class="o">==</span> <span class="n">userId</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df_rating_filtered</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">movie_list</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">hmovies</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">][</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;movieId&quot;</span><span class="p">]</span><span class="o">==</span><span class="n">hmovies</span><span class="p">[</span><span class="s2">&quot;movieId&quot;</span><span class="p">]])</span><span class="o">.</span><span class="n">values</span><span class="p">)</span> 
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">movie</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">movie_list</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">movie_recommended</span> <span class="ow">in</span> <span class="n">get_recommendations_based_on_genres</span><span class="p">(</span><span class="n">movie</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="n">recommended_movie_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">movie_recommended</span><span class="p">)</span>

    <span class="c1"># removing already watched movie from recommended list    </span>
    <span class="k">for</span> <span class="n">movie_title</span> <span class="ow">in</span> <span class="n">recommended_movie_list</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">movie_title</span> <span class="ow">in</span> <span class="n">movie_list</span><span class="p">:</span>
            <span class="n">recommended_movie_list</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">movie_title</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="nb">set</span><span class="p">(</span><span class="n">recommended_movie_list</span><span class="p">)</span>

<span class="nb">list</span><span class="p">(</span><span class="n">get_recommendation_content_model</span><span class="p">(</span><span class="mi">1</span><span class="p">))[:</span><span class="mi">10</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;Scrooged (1988)&#39;,
 &#39;Beat the Devil (1953)&#39;,
 &#39;Wiz, The (1978)&#39;,
 &#39;Mars Attacks! (1996)&#39;,
 &#39;Medallion, The (2003)&#39;,
 &#39;Ratatouille (2007)&#39;,
 &#39;Clueless (1995)&#39;,
 &#39;RoboCop 2 (1990)&#39;,
 &#39;Stargate (1994)&#39;,
 &#39;National Treasure (2004)&#39;]
</pre></div>
</div>
</div>
</div>
<p>SVD Collaborative model</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># !pip install -q surprise</span>

<span class="kn">from</span> <span class="nn">surprise</span> <span class="kn">import</span> <span class="n">Reader</span><span class="p">,</span> <span class="n">Dataset</span><span class="p">,</span> <span class="n">SVD</span>
<span class="kn">from</span> <span class="nn">surprise.model_selection</span> <span class="kn">import</span> <span class="n">cross_validate</span>

<span class="n">reader</span> <span class="o">=</span> <span class="n">Reader</span><span class="p">()</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">Dataset</span><span class="o">.</span><span class="n">load_from_df</span><span class="p">(</span><span class="n">ratings_df</span><span class="p">[[</span><span class="s1">&#39;user_id&#39;</span><span class="p">,</span> <span class="s1">&#39;item_id&#39;</span><span class="p">,</span> <span class="s1">&#39;rating&#39;</span><span class="p">]],</span> <span class="n">reader</span><span class="p">)</span>

<span class="n">svd</span> <span class="o">=</span> <span class="n">SVD</span><span class="p">()</span>
<span class="n">cross_validate</span><span class="p">(</span><span class="n">svd</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">measures</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;RMSE&#39;</span><span class="p">,</span> <span class="s1">&#39;MAE&#39;</span><span class="p">],</span> <span class="n">cv</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">trainset</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">build_full_trainset</span><span class="p">()</span>
<span class="n">svd</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">trainset</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evaluating RMSE, MAE of algorithm SVD on 5 split(s).

                  Fold 1  Fold 2  Fold 3  Fold 4  Fold 5  Mean    Std     
RMSE (testset)    0.9328  0.9330  0.9455  0.9341  0.9322  0.9355  0.0050  
MAE (testset)     0.7339  0.7376  0.7440  0.7374  0.7330  0.7372  0.0039  
Fit time          5.14    5.14    5.24    5.28    5.26    5.21    0.06    
Test time         0.16    0.27    0.16    0.27    0.16    0.20    0.05    
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;surprise.prediction_algorithms.matrix_factorization.SVD at 0x7f6f699601d0&gt;
</pre></div>
</div>
</div>
</div>
<p>Hybrid model</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">hybrid_content_svd_model</span><span class="p">(</span><span class="n">userId</span><span class="p">):</span>
    <span class="n">recommended_movies_by_content_model</span> <span class="o">=</span> <span class="n">get_recommendation_content_model</span><span class="p">(</span><span class="n">userId</span><span class="p">)</span>
    <span class="n">recommended_movies_by_content_model</span> <span class="o">=</span> <span class="n">hmovies</span><span class="p">[</span><span class="n">hmovies</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">movie</span><span class="p">:</span> <span class="n">movie</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">recommended_movies_by_content_model</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">columns</span> <span class="ow">in</span> <span class="n">recommended_movies_by_content_model</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">predict</span> <span class="o">=</span> <span class="n">svd</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">userId</span><span class="p">,</span> <span class="n">columns</span><span class="p">[</span><span class="s2">&quot;movieId&quot;</span><span class="p">])</span>
        <span class="n">recommended_movies_by_content_model</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">key</span><span class="p">,</span> <span class="s2">&quot;svd_rating&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">predict</span><span class="o">.</span><span class="n">est</span>
<span class="c1">#         if(predict.est &lt; 2):</span>
<span class="c1">#             recommended_movies_by_content_model = recommended_movies_by_content_model.drop([key])</span>
    <span class="k">return</span> <span class="n">recommended_movies_by_content_model</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;svd_rating&quot;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">11</span><span class="p">]</span>
        
<span class="n">user_id</span> <span class="o">=</span> <span class="mi">50</span>
<span class="n">hybrid_content_svd_model</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/usr/local/lib/python3.6/dist-packages/pandas/core/indexing.py:1596: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  self.obj[key] = _infer_fill_value(value)
/usr/local/lib/python3.6/dist-packages/pandas/core/indexing.py:1763: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  isetter(loc, value)
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>movieId</th>
      <th>title</th>
      <th>genres</th>
      <th>svd_rating</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>275</th>
      <td>316</td>
      <td>Stargate (1994)</td>
      <td>Action|Adventure|Sci-Fi</td>
      <td>4.316628</td>
    </tr>
    <tr>
      <th>777</th>
      <td>1019</td>
      <td>20,000 Leagues Under the Sea (1954)</td>
      <td>Adventure|Drama|Sci-Fi</td>
      <td>4.171654</td>
    </tr>
    <tr>
      <th>549</th>
      <td>653</td>
      <td>Dragonheart (1996)</td>
      <td>Action|Adventure|Fantasy</td>
      <td>4.146008</td>
    </tr>
    <tr>
      <th>29</th>
      <td>30</td>
      <td>Shanghai Triad (Yao a yao yao dao waipo qiao) ...</td>
      <td>Crime|Drama</td>
      <td>4.143668</td>
    </tr>
    <tr>
      <th>71</th>
      <td>79</td>
      <td>Juror, The (1996)</td>
      <td>Drama|Thriller</td>
      <td>4.143321</td>
    </tr>
    <tr>
      <th>416</th>
      <td>478</td>
      <td>Jimmy Hollywood (1994)</td>
      <td>Comedy|Crime|Drama</td>
      <td>4.117090</td>
    </tr>
    <tr>
      <th>53</th>
      <td>60</td>
      <td>Indian in the Cupboard, The (1995)</td>
      <td>Adventure|Children|Fantasy</td>
      <td>4.101336</td>
    </tr>
    <tr>
      <th>378</th>
      <td>434</td>
      <td>Cliffhanger (1993)</td>
      <td>Action|Adventure|Thriller</td>
      <td>4.097507</td>
    </tr>
    <tr>
      <th>578</th>
      <td>709</td>
      <td>Oliver &amp; Company (1988)</td>
      <td>Adventure|Animation|Children|Comedy|Musical</td>
      <td>4.091108</td>
    </tr>
    <tr>
      <th>10</th>
      <td>11</td>
      <td>American President, The (1995)</td>
      <td>Comedy|Drama|Romance</td>
      <td>4.068649</td>
    </tr>
    <tr>
      <th>6</th>
      <td>7</td>
      <td>Sabrina (1995)</td>
      <td>Comedy|Romance</td>
      <td>4.061874</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</div>
<div class="section" id="lightfm-bpr-warp">
<h2>LightFM - BPR &amp; WARP<a class="headerlink" href="#lightfm-bpr-warp" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># !pip install -q lightfm</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">lightfm.datasets</span> <span class="kn">import</span> <span class="n">fetch_movielens</span>
<span class="kn">from</span> <span class="nn">lightfm</span> <span class="kn">import</span> <span class="n">LightFM</span>
<span class="kn">from</span> <span class="nn">lightfm.evaluation</span> <span class="kn">import</span> <span class="n">precision_at_k</span>
<span class="kn">from</span> <span class="nn">lightfm.evaluation</span> <span class="kn">import</span> <span class="n">auc_score</span>

<span class="n">movielens</span> <span class="o">=</span> <span class="n">fetch_movielens</span><span class="p">()</span>

<span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">movielens</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="n">value</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>train &lt;class &#39;scipy.sparse.coo.coo_matrix&#39;&gt; (943, 1682)
test &lt;class &#39;scipy.sparse.coo.coo_matrix&#39;&gt; (943, 1682)
item_features &lt;class &#39;scipy.sparse.csr.csr_matrix&#39;&gt; (1682, 1682)
item_feature_labels &lt;class &#39;numpy.ndarray&#39;&gt; (1682,)
item_labels &lt;class &#39;numpy.ndarray&#39;&gt; (1682,)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">lfm_train</span> <span class="o">=</span> <span class="n">movielens</span><span class="p">[</span><span class="s1">&#39;train&#39;</span><span class="p">]</span>
<span class="n">lfm_test</span> <span class="o">=</span> <span class="n">movielens</span><span class="p">[</span><span class="s1">&#39;test&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">LightFM</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">loss</span><span class="o">=</span><span class="s1">&#39;bpr&#39;</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">lfm_train</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="n">train_precision</span> <span class="o">=</span> <span class="n">precision_at_k</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">lfm_train</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">test_precision</span> <span class="o">=</span> <span class="n">precision_at_k</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">lfm_test</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">train_interactions</span><span class="o">=</span><span class="n">lfm_train</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

<span class="n">train_auc</span> <span class="o">=</span> <span class="n">auc_score</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">lfm_train</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">test_auc</span> <span class="o">=</span> <span class="n">auc_score</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">lfm_test</span><span class="p">,</span> <span class="n">train_interactions</span><span class="o">=</span><span class="n">lfm_train</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Precision: train </span><span class="si">%.2f</span><span class="s1">, test </span><span class="si">%.2f</span><span class="s1">.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">train_precision</span><span class="p">,</span> <span class="n">test_precision</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;AUC: train </span><span class="si">%.2f</span><span class="s1">, test </span><span class="si">%.2f</span><span class="s1">.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">train_auc</span><span class="p">,</span> <span class="n">test_auc</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Precision: train 0.59, test 0.20.
AUC: train 0.90, test 0.88.
</pre></div>
</div>
</div>
</div>
<p>BPR optimises for ROC. The WARP model, on the other hand, optimises for precision&#64;k—we should expect its performance to be better on precision.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">LightFM</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">loss</span><span class="o">=</span><span class="s1">&#39;warp&#39;</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">fit_partial</span><span class="p">(</span><span class="n">lfm_train</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="n">train_precision</span> <span class="o">=</span> <span class="n">precision_at_k</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">lfm_train</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">test_precision</span> <span class="o">=</span> <span class="n">precision_at_k</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">lfm_test</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">train_interactions</span><span class="o">=</span><span class="n">lfm_train</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

<span class="n">train_auc</span> <span class="o">=</span> <span class="n">auc_score</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">lfm_train</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">test_auc</span> <span class="o">=</span> <span class="n">auc_score</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">lfm_test</span><span class="p">,</span> <span class="n">train_interactions</span><span class="o">=</span><span class="n">lfm_train</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Precision: train </span><span class="si">%.2f</span><span class="s1">, test </span><span class="si">%.2f</span><span class="s1">.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">train_precision</span><span class="p">,</span> <span class="n">test_precision</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;AUC: train </span><span class="si">%.2f</span><span class="s1">, test </span><span class="si">%.2f</span><span class="s1">.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">train_auc</span><span class="p">,</span> <span class="n">test_auc</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Precision: train 0.60, test 0.22.
AUC: train 0.94, test 0.93.
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="microsoft-library-fastai-collab">
<h2>Microsoft Library - FastAI-Collab<a class="headerlink" href="#microsoft-library-fastai-collab" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="n">cd</span> <span class="o">/</span><span class="n">content</span><span class="o">/</span><span class="mi">4</span><span class="n">CED0278</span><span class="o">/</span><span class="mi">4</span><span class="n">CED0278</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/content/4CED0278/4CED0278
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="kn">import</span> <span class="nn">torch</span><span class="o">,</span> <span class="nn">fastai</span>
<span class="kn">from</span> <span class="nn">fastai.collab</span> <span class="kn">import</span> <span class="n">EmbeddingDotBias</span><span class="p">,</span> <span class="n">collab_learner</span><span class="p">,</span> <span class="n">CollabDataBunch</span><span class="p">,</span> <span class="n">load_learner</span>

<span class="kn">from</span> <span class="nn">reco_utils.dataset.python_splitters</span> <span class="kn">import</span> <span class="n">python_stratified_split</span>
<span class="kn">from</span> <span class="nn">reco_utils.recommender.fastai.fastai_utils</span> <span class="kn">import</span> <span class="n">cartesian_product</span><span class="p">,</span> <span class="n">score</span>
<span class="kn">from</span> <span class="nn">reco_utils.evaluation.python_evaluation</span> <span class="kn">import</span> <span class="n">map_at_k</span><span class="p">,</span> <span class="n">ndcg_at_k</span><span class="p">,</span> <span class="n">precision_at_k</span><span class="p">,</span> <span class="n">recall_at_k</span>
<span class="kn">from</span> <span class="nn">reco_utils.evaluation.python_evaluation</span> <span class="kn">import</span> <span class="n">rmse</span><span class="p">,</span> <span class="n">mae</span><span class="p">,</span> <span class="n">rsquared</span><span class="p">,</span> <span class="n">exp_var</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">USER</span><span class="p">,</span> <span class="n">ITEM</span><span class="p">,</span> <span class="n">RATING</span><span class="p">,</span> <span class="n">TIMESTAMP</span><span class="p">,</span> <span class="n">PREDICTION</span><span class="p">,</span> <span class="n">TITLE</span> <span class="o">=</span> <span class="s1">&#39;UserId&#39;</span><span class="p">,</span> <span class="s1">&#39;MovieId&#39;</span><span class="p">,</span> <span class="s1">&#39;Rating&#39;</span><span class="p">,</span> <span class="s1">&#39;Timestamp&#39;</span><span class="p">,</span> <span class="s1">&#39;Prediction&#39;</span><span class="p">,</span> <span class="s1">&#39;Title&#39;</span>

<span class="c1"># top k items to recommend</span>
<span class="n">TOP_K</span> <span class="o">=</span> <span class="mi">10</span>

<span class="c1"># select movieLens data size: 100k, 1m, 10m, or 20m</span>
<span class="n">MOVIELENS_DATA_SIZE</span> <span class="o">=</span> <span class="s1">&#39;100k&#39;</span>

<span class="c1"># model parameters</span>
<span class="n">N_FACTORS</span> <span class="o">=</span> <span class="mi">40</span>
<span class="n">EPOCHS</span> <span class="o">=</span> <span class="mi">5</span>

<span class="n">ratings</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;./data/ml-100k/ratings.csv&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ratings</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>UserId</th>
      <th>MovieId</th>
      <th>Rating</th>
      <th>Timestamp</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>196</td>
      <td>242</td>
      <td>3.0</td>
      <td>881250949</td>
    </tr>
    <tr>
      <th>1</th>
      <td>186</td>
      <td>302</td>
      <td>3.0</td>
      <td>891717742</td>
    </tr>
    <tr>
      <th>2</th>
      <td>22</td>
      <td>377</td>
      <td>1.0</td>
      <td>878887116</td>
    </tr>
    <tr>
      <th>3</th>
      <td>244</td>
      <td>51</td>
      <td>2.0</td>
      <td>880606923</td>
    </tr>
    <tr>
      <th>4</th>
      <td>166</td>
      <td>346</td>
      <td>1.0</td>
      <td>886397596</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># split the dataset</span>
<span class="n">train_valid_df</span><span class="p">,</span> <span class="n">test_df</span> <span class="o">=</span> <span class="n">python_stratified_split</span><span class="p">(</span><span class="n">ratings</span><span class="p">,</span> 
                                                  <span class="n">ratio</span><span class="o">=</span><span class="mf">0.75</span><span class="p">,</span> 
                                                  <span class="n">min_rating</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> 
                                                  <span class="n">filter_by</span><span class="o">=</span><span class="s2">&quot;item&quot;</span><span class="p">,</span> 
                                                  <span class="n">col_user</span><span class="o">=</span><span class="n">USER</span><span class="p">,</span> 
                                                  <span class="n">col_item</span><span class="o">=</span><span class="n">ITEM</span> <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="n">CollabDataBunch</span><span class="o">.</span><span class="n">from_df</span><span class="p">(</span><span class="n">train_valid_df</span><span class="p">,</span> 
                               <span class="n">user_name</span><span class="o">=</span><span class="n">USER</span><span class="p">,</span> 
                               <span class="n">item_name</span><span class="o">=</span><span class="n">ITEM</span><span class="p">,</span> 
                               <span class="n">rating_name</span><span class="o">=</span><span class="n">RATING</span><span class="p">,</span> 
                               <span class="n">valid_pct</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">data</span><span class="o">.</span><span class="n">show_batch</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>UserId</th>
      <th>MovieId</th>
      <th>target</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>13</td>
      <td>588</td>
      <td>4.0</td>
    </tr>
    <tr>
      <td>279</td>
      <td>163</td>
      <td>5.0</td>
    </tr>
    <tr>
      <td>184</td>
      <td>44</td>
      <td>4.0</td>
    </tr>
    <tr>
      <td>250</td>
      <td>28</td>
      <td>4.0</td>
    </tr>
    <tr>
      <td>514</td>
      <td>70</td>
      <td>5.0</td>
    </tr>
  </tbody>
</table></div></div>
</div>
<p>Now we will create a <code class="docutils literal notranslate"><span class="pre">collab_learner</span></code> for the data, which by default uses
the <code class="docutils literal notranslate"><span class="pre">EmbeddingDotBias</span></code> model. We will be using 40 latent factors. This will
create an embedding for the users and the items that will map each of these
to 40 floats as can be seen below. Note that the embedding parameters are not
predefined, but are learned by the model.</p>
<p>Although ratings can only range from 1-5, we are setting the range of possible
ratings to a range from 0 to 5.5 – that will allow the model to predict values
around 1 and 5, which improves accuracy. Lastly, we set a value for weight-decay
for regularization.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">learn</span> <span class="o">=</span> <span class="n">collab_learner</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">n_factors</span><span class="o">=</span><span class="n">N_FACTORS</span><span class="p">,</span> <span class="n">y_range</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mf">5.5</span><span class="p">],</span> <span class="n">wd</span><span class="o">=</span><span class="mf">1e-1</span><span class="p">)</span>
<span class="n">learn</span><span class="o">.</span><span class="n">model</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>EmbeddingDotBias(
  (u_weight): Embedding(944, 40)
  (i_weight): Embedding(1350, 40)
  (u_bias): Embedding(944, 1)
  (i_bias): Embedding(1350, 1)
)
</pre></div>
</div>
</div>
</div>
<p>Now train the model for 5 epochs setting the maximal learning rate. The learner will reduce the learning rate with each epoch using cosine annealing</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">fit_one_cycle</span><span class="p">(</span><span class="n">EPOCHS</span><span class="p">,</span> <span class="n">max_lr</span><span class="o">=</span><span class="mf">5e-3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><table border="1" class="dataframe">
  <thead>
    <tr style="text-align: left;">
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>0.955865</td>
      <td>#na#</td>
      <td>00:10</td>
    </tr>
    <tr>
      <td>1</td>
      <td>0.867613</td>
      <td>#na#</td>
      <td>00:10</td>
    </tr>
    <tr>
      <td>2</td>
      <td>0.784646</td>
      <td>#na#</td>
      <td>00:10</td>
    </tr>
    <tr>
      <td>3</td>
      <td>0.619921</td>
      <td>#na#</td>
      <td>00:10</td>
    </tr>
    <tr>
      <td>4</td>
      <td>0.543300</td>
      <td>#na#</td>
      <td>00:10</td>
    </tr>
  </tbody>
</table></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># save the learner</span>
<span class="n">learn</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="s1">&#39;movielens_model.pkl&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Evaluation</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># load the learner</span>
<span class="n">learner</span> <span class="o">=</span> <span class="n">load_learner</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="s1">&#39;movielens_model.pkl&#39;</span><span class="p">)</span>

<span class="c1"># get all users and items that the model knows</span>
<span class="n">total_users</span><span class="p">,</span> <span class="n">total_items</span> <span class="o">=</span> <span class="n">learner</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">train_ds</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">classes</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
<span class="n">total_items</span> <span class="o">=</span> <span class="n">total_items</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
<span class="n">total_users</span> <span class="o">=</span> <span class="n">total_users</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

<span class="c1"># get all users from the test set and remove any users that were now in the training set</span>
<span class="n">test_users</span> <span class="o">=</span> <span class="n">test_df</span><span class="p">[</span><span class="n">USER</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
<span class="n">test_users</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="n">test_users</span><span class="p">,</span> <span class="n">total_users</span><span class="p">)</span>

<span class="c1"># build the cartesian product of test set users and all items known to the model</span>
<span class="n">users_items</span> <span class="o">=</span> <span class="n">cartesian_product</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">test_users</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">total_items</span><span class="p">))</span>
<span class="n">users_items</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">users_items</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="n">USER</span><span class="p">,</span><span class="n">ITEM</span><span class="p">])</span>

<span class="c1"># remove the user/items combinations that are in the training set</span>
<span class="c1"># we don&#39;t want to propose a movie that the user has already watched</span>
<span class="n">training_removed</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">users_items</span><span class="p">,</span> <span class="n">train_valid_df</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">),</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="n">USER</span><span class="p">,</span> <span class="n">ITEM</span><span class="p">],</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
<span class="n">training_removed</span> <span class="o">=</span> <span class="n">training_removed</span><span class="p">[</span><span class="n">training_removed</span><span class="p">[</span><span class="n">RATING</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()][[</span><span class="n">USER</span><span class="p">,</span> <span class="n">ITEM</span><span class="p">]]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># score the model to find the top K recommendation</span>
<span class="n">top_k_scores</span> <span class="o">=</span> <span class="n">score</span><span class="p">(</span><span class="n">learner</span><span class="p">,</span> 
                     <span class="n">test_df</span><span class="o">=</span><span class="n">training_removed</span><span class="p">,</span>
                     <span class="n">user_col</span><span class="o">=</span><span class="n">USER</span><span class="p">,</span> 
                     <span class="n">item_col</span><span class="o">=</span><span class="n">ITEM</span><span class="p">,</span> 
                     <span class="n">prediction_col</span><span class="o">=</span><span class="n">PREDICTION</span><span class="p">)</span>

<span class="c1"># MAP</span>
<span class="n">eval_map</span> <span class="o">=</span> <span class="n">map_at_k</span><span class="p">(</span><span class="n">test_df</span><span class="p">,</span> <span class="n">top_k_scores</span><span class="p">,</span> <span class="n">col_user</span><span class="o">=</span><span class="n">USER</span><span class="p">,</span> <span class="n">col_item</span><span class="o">=</span><span class="n">ITEM</span><span class="p">,</span> 
                    <span class="n">col_rating</span><span class="o">=</span><span class="n">RATING</span><span class="p">,</span> <span class="n">col_prediction</span><span class="o">=</span><span class="n">PREDICTION</span><span class="p">,</span> 
                    <span class="n">relevancy_method</span><span class="o">=</span><span class="s2">&quot;top_k&quot;</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">TOP_K</span><span class="p">)</span>

<span class="c1"># NDCG</span>
<span class="n">eval_ndcg</span> <span class="o">=</span> <span class="n">ndcg_at_k</span><span class="p">(</span><span class="n">test_df</span><span class="p">,</span> <span class="n">top_k_scores</span><span class="p">,</span> <span class="n">col_user</span><span class="o">=</span><span class="n">USER</span><span class="p">,</span> <span class="n">col_item</span><span class="o">=</span><span class="n">ITEM</span><span class="p">,</span> 
                      <span class="n">col_rating</span><span class="o">=</span><span class="n">RATING</span><span class="p">,</span> <span class="n">col_prediction</span><span class="o">=</span><span class="n">PREDICTION</span><span class="p">,</span> 
                      <span class="n">relevancy_method</span><span class="o">=</span><span class="s2">&quot;top_k&quot;</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">TOP_K</span><span class="p">)</span>

<span class="c1"># Precision</span>
<span class="n">eval_precision</span> <span class="o">=</span> <span class="n">precision_at_k</span><span class="p">(</span><span class="n">test_df</span><span class="p">,</span> <span class="n">top_k_scores</span><span class="p">,</span> <span class="n">col_user</span><span class="o">=</span><span class="n">USER</span><span class="p">,</span> <span class="n">col_item</span><span class="o">=</span><span class="n">ITEM</span><span class="p">,</span> 
                                <span class="n">col_rating</span><span class="o">=</span><span class="n">RATING</span><span class="p">,</span> <span class="n">col_prediction</span><span class="o">=</span><span class="n">PREDICTION</span><span class="p">,</span> 
                                <span class="n">relevancy_method</span><span class="o">=</span><span class="s2">&quot;top_k&quot;</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">TOP_K</span><span class="p">)</span>

<span class="c1"># Recall</span>
<span class="n">eval_recall</span> <span class="o">=</span> <span class="n">recall_at_k</span><span class="p">(</span><span class="n">test_df</span><span class="p">,</span> <span class="n">top_k_scores</span><span class="p">,</span> <span class="n">col_user</span><span class="o">=</span><span class="n">USER</span><span class="p">,</span> <span class="n">col_item</span><span class="o">=</span><span class="n">ITEM</span><span class="p">,</span> 
                          <span class="n">col_rating</span><span class="o">=</span><span class="n">RATING</span><span class="p">,</span> <span class="n">col_prediction</span><span class="o">=</span><span class="n">PREDICTION</span><span class="p">,</span> 
                          <span class="n">relevancy_method</span><span class="o">=</span><span class="s2">&quot;top_k&quot;</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">TOP_K</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Model:</span><span class="se">\t</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">learn</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
      <span class="s2">&quot;Top K:</span><span class="se">\t</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">TOP_K</span><span class="p">,</span>
      <span class="s2">&quot;MAP:</span><span class="se">\t</span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">eval_map</span><span class="p">,</span>
      <span class="s2">&quot;NDCG:</span><span class="se">\t</span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">eval_ndcg</span><span class="p">,</span>
      <span class="s2">&quot;Precision@K:</span><span class="se">\t</span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">eval_precision</span><span class="p">,</span>
      <span class="s2">&quot;Recall@K:</span><span class="se">\t</span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">eval_recall</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># calculate scores for test user-item pairs</span>
<span class="n">scores</span> <span class="o">=</span> <span class="n">score</span><span class="p">(</span><span class="n">learner</span><span class="p">,</span> 
               <span class="n">test_df</span><span class="o">=</span><span class="n">test_df</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> 
               <span class="n">user_col</span><span class="o">=</span><span class="n">USER</span><span class="p">,</span> 
               <span class="n">item_col</span><span class="o">=</span><span class="n">ITEM</span><span class="p">,</span> 
               <span class="n">prediction_col</span><span class="o">=</span><span class="n">PREDICTION</span><span class="p">)</span>

<span class="c1"># calculate some regression metrics</span>
<span class="n">eval_r2</span> <span class="o">=</span> <span class="n">rsquared</span><span class="p">(</span><span class="n">test_df</span><span class="p">,</span> <span class="n">scores</span><span class="p">,</span> <span class="n">col_user</span><span class="o">=</span><span class="n">USER</span><span class="p">,</span> <span class="n">col_item</span><span class="o">=</span><span class="n">ITEM</span><span class="p">,</span> <span class="n">col_rating</span><span class="o">=</span><span class="n">RATING</span><span class="p">,</span> <span class="n">col_prediction</span><span class="o">=</span><span class="n">PREDICTION</span><span class="p">)</span>
<span class="n">eval_rmse</span> <span class="o">=</span> <span class="n">rmse</span><span class="p">(</span><span class="n">test_df</span><span class="p">,</span> <span class="n">scores</span><span class="p">,</span> <span class="n">col_user</span><span class="o">=</span><span class="n">USER</span><span class="p">,</span> <span class="n">col_item</span><span class="o">=</span><span class="n">ITEM</span><span class="p">,</span> <span class="n">col_rating</span><span class="o">=</span><span class="n">RATING</span><span class="p">,</span> <span class="n">col_prediction</span><span class="o">=</span><span class="n">PREDICTION</span><span class="p">)</span>
<span class="n">eval_mae</span> <span class="o">=</span> <span class="n">mae</span><span class="p">(</span><span class="n">test_df</span><span class="p">,</span> <span class="n">scores</span><span class="p">,</span> <span class="n">col_user</span><span class="o">=</span><span class="n">USER</span><span class="p">,</span> <span class="n">col_item</span><span class="o">=</span><span class="n">ITEM</span><span class="p">,</span> <span class="n">col_rating</span><span class="o">=</span><span class="n">RATING</span><span class="p">,</span> <span class="n">col_prediction</span><span class="o">=</span><span class="n">PREDICTION</span><span class="p">)</span>
<span class="n">eval_exp_var</span> <span class="o">=</span> <span class="n">exp_var</span><span class="p">(</span><span class="n">test_df</span><span class="p">,</span> <span class="n">scores</span><span class="p">,</span> <span class="n">col_user</span><span class="o">=</span><span class="n">USER</span><span class="p">,</span> <span class="n">col_item</span><span class="o">=</span><span class="n">ITEM</span><span class="p">,</span> <span class="n">col_rating</span><span class="o">=</span><span class="n">RATING</span><span class="p">,</span> <span class="n">col_prediction</span><span class="o">=</span><span class="n">PREDICTION</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Model:</span><span class="se">\t</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">learn</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
      <span class="s2">&quot;RMSE:</span><span class="se">\t</span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">eval_rmse</span><span class="p">,</span>
      <span class="s2">&quot;MAE:</span><span class="se">\t</span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">eval_mae</span><span class="p">,</span>
      <span class="s2">&quot;Explained variance:</span><span class="se">\t</span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">eval_exp_var</span><span class="p">,</span>
      <span class="s2">&quot;R squared:</span><span class="se">\t</span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">eval_r2</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./nbs"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        
            



<div class='prev-next-bottom'>
    
    <div id="prev">
        <a class="left-prev" href="T990000_movie_recommender_tensorflow_sagemaker.html" title="previous page">
            <i class="prevnext-label fas fa-angle-left"></i>
            <div class="prevnext-info">
                <p class="prevnext-label">previous</p>
                <p class="prevnext-title">Movie recommender using Tensorflow in Sagemaker</p>
            </div>
        </a>
    </div>
     <div id="next">
        <a class="right-next" href="T990000_read_data_from_cassandra_into_pandas.html" title="next page">
            <div class="prevnext-info">
                <p class="prevnext-label">next</p>
                <p class="prevnext-title">Read Cassandra Data Snapshot as DataFrame</p>
            </div>
            <i class="prevnext-label fas fa-angle-right"></i>
        </a>
     </div>

</div>
        
        </div>
    </div>
    <footer class="footer">
    <div class="container">
      <p>
        
          By Sparsh A.<br/>
        
            &copy; Copyright 2021.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>
  
  <script src="../_static/js/index.1c5a1a01449ed65a7b51.js"></script>

  
  </body>
</html>